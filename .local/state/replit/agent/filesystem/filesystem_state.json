{"file_contents":{"replit.md":{"content":"# Audivia - Premium Audiobook Platform\n\n## Overview\nAudivia is a premium audiobook platform featuring two monetization models: individual audiobook purchases (one-time payment) and monthly subscriptions for full catalog access. The platform emphasizes a mobile-optimized, immersive audio experience with sophisticated design using deep purple/indigo color scheme with gold accents to convey luxury. Target audience includes book lovers and commuters preferring audio content.\n\n## Recent Changes (December 2024)\n- **Platform Transformation**: Converted from podcast platform (PodcastHub) to premium audiobook platform (Audivia)\n- **Database Schema**: Added new tables: audiobooks, chapters, subscription_plans, user_subscriptions, audiobook_purchases, favorites, listening_progress\n- **Monetization Models**: Implemented dual purchase system (individual purchases + subscriptions)\n- **Design System**: Updated to premium Audivia theme with:\n  - Primary: Deep purple/indigo (HSL 260Â° 65% 50-60%)\n  - Accent: Gold (HSL 45Â° 90% 55%)\n  - Typography: Cormorant Garamond (serif) for headings, Inter (sans-serif) for body\n- **Frontend Pages**: Created new audiobook-detail, chapter-player, explore, library pages with audiobook model\n- **API Routes**: Added /api/audiobooks, /api/chapters, /api/library/favorites, /api/library/purchases endpoints\n- **Admin Pages**: Created admin-audiobooks and admin-chapters management pages\n- **Email System**: Updated all email templates to Audivia branding (purple #7C3AED)\n- **Invoice Emails**: Added automatic invoice and purchase confirmation emails after PayPal payments\n  - Invoice PDFs generated and attached to emails when billing profile exists\n  - Fallback reference ID (REF-{purchaseId}) for customers without billing profile\n  - Individual error handling per email to prevent one failure from blocking others\n- **Invoice Generation**: Transactional creation of invoices with line items for data integrity\n\n## User Preferences\n- Preferred communication style: Simple, everyday language\n- Stripe integration: Deferred - will need manual configuration with API keys later\n\n## System Architecture\n\n### UI/UX Decisions\n- **Design Philosophy**: Premium, luxury positioning with elegant typography and sophisticated color palette\n- **Color Scheme**: Deep purple/indigo (#7C3AED to #4F46E5) with gold accents (#EAB308)\n- **Typography Hierarchy**: Cormorant Garamond (serif) for headings conveys literary sophistication, Inter (sans-serif) for body ensures readability\n- **Frontend**: React (Vite), Wouter for routing, TanStack Query for state, shadcn/ui with Tailwind CSS\n- **Theme Support**: Dark mode default with light mode support, optimized for audiobook consumption\n\n### Technical Implementations\n- **Frontend**: React (Vite), Wouter routing, TanStack Query, shadcn/ui, Tailwind CSS\n- **Backend**: Express.js (Node.js), RESTful API, Zod validation\n- **Database**: PostgreSQL (Neon) with Drizzle ORM\n- **Authentication**: Session-based with PostgreSQL store, bcryptjs passwords, three-tier roles (ADMIN, CREATOR/PUBLISHER, LISTENER)\n\n### Data Model (Audiobook-focused)\n```\nUsers â†’ UserSubscriptions â†’ SubscriptionPlans\n     â†’ AudiobookPurchases â†’ Audiobooks\n     â†’ Favorites â†’ Audiobooks\n     â†’ ListeningProgress â†’ Audiobooks/Chapters\n\nAudiobooks â†’ Chapters (ordered by chapterNumber)\n          â†’ Publisher (User)\n          â†’ Purchases\n          â†’ Favorites\n\nPlaylists â†’ PlaylistChapters â†’ Chapters\n```\n\n### Access Control Logic\n- **Free audiobooks**: Accessible to all users\n- **Paid audiobooks**: Require one of:\n  - Individual purchase completion\n  - Active subscription\n  - Publisher/Admin access\n\n### Key Features\n- **Audiobook Catalog**: Browse, search, filter by category/price\n- **Chapter Playback**: Full audio player with progress tracking, skip controls\n- **Library Management**: Favorites, purchases, subscription access\n- **Subscription System**: Monthly plans with Stripe integration (to be configured)\n- **Purchase System**: Individual audiobook purchases with Stripe (to be configured)\n- **Progress Tracking**: Resume playback, chapter completion status\n- **Admin Panel**: Audiobook/chapter management, user administration\n\n## External Dependencies\n- **Database**: Neon Database (PostgreSQL serverless)\n- **Fonts**: Google Fonts (Cormorant Garamond, Inter)\n- **Payments**: Stripe (requires manual API key configuration)\n- **UI**: Radix UI, Lucide React, shadcn/ui\n- **Audio**: HTML5 Audio API with custom player controls\n\n## TODO / Future Work\n- [ ] Configure Stripe integration with API keys (STRIPE_SECRET_KEY, STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET)\n- [ ] Implement subscription checkout flow\n- [ ] Implement individual purchase checkout flow\n- [ ] Add audiobook creation/upload interface for publishers\n- [ ] Implement chapter upload with audio file handling\n- [ ] Add subscription management (cancel, upgrade, billing history)\n- [ ] Implement sample chapter preview for non-purchased audiobooks\n- [ ] Add ratings and reviews system\n- [ ] Implement search with full-text search capabilities\n- [ ] Add offline download capability (future enhancement)\n\n## Legacy Compatibility\nThe codebase maintains backward compatibility with the original podcast platform through type aliases in shared/schema.ts:\n- Podcast = Audiobook\n- Episode = Chapter\n- insertPodcastSchema = insertAudiobookSchema\n- insertEpisodeSchema = insertChapterSchema\n\nThis allows gradual migration of existing podcast-focused code while new features use audiobook terminology.\n","path":null,"size_bytes":5535,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { users, podcasts, episodes } from \"@shared/schema\";\nimport bcrypt from \"bcryptjs\";\n\nasync function seed() {\n  console.log(\"ðŸŒ± Seeding database...\");\n\n  // Create demo users\n  const hashedPassword = await bcrypt.hash(\"password123\", 10);\n  \n  const [demoCreator] = await db.insert(users).values({\n    username: \"demo_creator\",\n    email: \"creator@example.com\",\n    passwordHash: hashedPassword,\n    role: \"CREATOR\",\n    bio: \"Creador de contenido apasionado por la tecnologÃ­a y la educaciÃ³n.\",\n    avatarUrl: \"https://api.dicebear.com/7.x/avataaars/svg?seed=creator\",\n  }).returning();\n\n  const [demoListener] = await db.insert(users).values({\n    username: \"demo_listener\",\n    email: \"listener@example.com\",\n    passwordHash: hashedPassword,\n    role: \"LISTENER\",\n    bio: \"Amante de los podcasts y siempre aprendiendo algo nuevo.\",\n    avatarUrl: \"https://api.dicebear.com/7.x/avataaars/svg?seed=listener\",\n  }).returning();\n\n  console.log(\"âœ… Created demo users (creator & listener)\");\n\n  // Create sample podcasts\n  const samplePodcasts = [\n    {\n      title: \"TecnologÃ­a y Futuro\",\n      description: \"Exploramos las Ãºltimas tendencias en tecnologÃ­a, inteligencia artificial y cÃ³mo estÃ¡n transformando nuestro mundo.\",\n      coverArtUrl: \"https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=500&h=500&fit=crop\",\n      ownerId: demoCreator.id,\n    },\n    {\n      title: \"Historias Inspiradoras\",\n      description: \"Conversaciones con personas que han superado grandes desafÃ­os y nos comparten sus lecciones de vida.\",\n      coverArtUrl: \"https://images.unsplash.com/photo-1478737270239-2f02b77fc618?w=500&h=500&fit=crop\",\n      ownerId: demoCreator.id,\n    },\n    {\n      title: \"Ciencia Cotidiana\",\n      description: \"Explicamos fenÃ³menos cientÃ­ficos de forma simple y entretenida. Aprende algo nuevo cada episodio.\",\n      coverArtUrl: \"https://images.unsplash.com/photo-1532094349884-543bc11b234d?w=500&h=500&fit=crop\",\n      ownerId: demoCreator.id,\n    },\n    {\n      title: \"Emprendimiento Digital\",\n      description: \"Consejos prÃ¡cticos y estrategias para lanzar y hacer crecer tu negocio online en 2024.\",\n      coverArtUrl: \"https://images.unsplash.com/photo-1559136555-9303baea8ebd?w=500&h=500&fit=crop\",\n      ownerId: demoCreator.id,\n    },\n  ];\n\n  const createdPodcasts = await db.insert(podcasts).values(samplePodcasts).returning();\n  console.log(`âœ… Created ${createdPodcasts.length} podcasts`);\n\n  // Create episodes for each podcast\n  const sampleEpisodes = [\n    // TecnologÃ­a y Futuro\n    {\n      title: \"El Futuro de la IA en 2024\",\n      notes: \"Analizamos los avances mÃ¡s importantes en inteligencia artificial y lo que podemos esperar en los prÃ³ximos meses. Discutimos GPT-4, modelos de cÃ³digo abierto y aplicaciones prÃ¡cticas.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3\",\n      duration: 1847,\n      podcastId: createdPodcasts[0].id,\n    },\n    {\n      title: \"Blockchain y Web3: Â¿Realidad o Moda?\",\n      notes: \"Exploramos el estado actual de blockchain, NFTs y Web3. Â¿Son tecnologÃ­as revolucionarias o solo hype? Analizamos casos de uso reales y perspectivas futuras.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3\",\n      duration: 2156,\n      podcastId: createdPodcasts[0].id,\n    },\n    \n    // Historias Inspiradoras\n    {\n      title: \"De la Adversidad al Ã‰xito: MarÃ­a GonzÃ¡lez\",\n      notes: \"MarÃ­a nos cuenta cÃ³mo superÃ³ la pobreza extrema para convertirse en una empresaria exitosa. Una historia de perseverancia, educaciÃ³n y determinaciÃ³n.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3\",\n      duration: 2543,\n      podcastId: createdPodcasts[1].id,\n    },\n    {\n      title: \"Venciendo el Miedo: Carlos y su Historia\",\n      notes: \"Carlos comparte su experiencia superando el miedo escÃ©nico para convertirse en un orador pÃºblico reconocido. TÃ©cnicas y consejos para vencer tus miedos.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3\",\n      duration: 1923,\n      podcastId: createdPodcasts[1].id,\n    },\n    \n    // Ciencia Cotidiana\n    {\n      title: \"Â¿Por QuÃ© el Cielo es Azul?\",\n      notes: \"Explicamos de forma simple la dispersiÃ³n de Rayleigh y otros fenÃ³menos Ã³pticos que observamos todos los dÃ­as sin darnos cuenta.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3\",\n      duration: 1234,\n      podcastId: createdPodcasts[2].id,\n    },\n    {\n      title: \"La FÃ­sica del CafÃ©\",\n      notes: \"Descubre la ciencia detrÃ¡s de tu taza de cafÃ© matutina: temperatura, presiÃ³n, extracciÃ³n y quÃ­mica molecular. Todo lo que necesitas saber.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3\",\n      duration: 1567,\n      podcastId: createdPodcasts[2].id,\n    },\n    \n    // Emprendimiento Digital\n    {\n      title: \"Validando tu Idea de Negocio\",\n      notes: \"Antes de invertir tiempo y dinero, aprende a validar tu idea de negocio. TÃ©cnicas de MVP, encuestas y pruebas de mercado efectivas.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3\",\n      duration: 2034,\n      podcastId: createdPodcasts[3].id,\n    },\n    {\n      title: \"Marketing Digital para Principiantes\",\n      notes: \"Una guÃ­a completa de marketing digital: SEO, redes sociales, email marketing y estrategias de contenido que realmente funcionan en 2024.\",\n      audioUrl: \"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3\",\n      duration: 2456,\n      podcastId: createdPodcasts[3].id,\n    },\n  ];\n\n  const createdEpisodes = await db.insert(episodes).values(sampleEpisodes).returning();\n  console.log(`âœ… Created ${createdEpisodes.length} episodes`);\n\n  console.log(\"ðŸŽ‰ Seeding completed successfully!\");\n}\n\nseed()\n  .catch((error) => {\n    console.error(\"âŒ Seeding failed:\", error);\n    process.exit(1);\n  })\n  .finally(() => {\n    process.exit(0);\n  });\n","path":null,"size_bytes":6016,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { useAuth } from \"@/components/auth-provider\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { LogIn, Loader2, Headphones } from \"lucide-react\";\nimport logoImage from \"@assets/AUDIVIA_1766261612511.png\";\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const { login, isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n\n  const [redirectPath] = useState(() => {\n    const params = new URLSearchParams(window.location.search);\n    return params.get(\"from\") === \"mobile\" ? \"/mobile\" : \"/\";\n  });\n  const isMobileOrigin = redirectPath === \"/mobile\";\n\n  // Redirect if already authenticated\n  useEffect(() => {\n    if (isAuthenticated) {\n      setLocation(redirectPath);\n    }\n  }, [isAuthenticated, setLocation, redirectPath]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      await login(email, password);\n      toast({\n        title: \"Â¡Bienvenido de vuelta!\",\n        description: \"Has iniciado sesiÃ³n exitosamente\",\n      });\n      setLocation(redirectPath);\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error al iniciar sesiÃ³n\",\n        description: error.message || \"Email o contraseÃ±a incorrectos\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex flex-col lg:flex-row\">\n      {/* Login form - full width on mobile, optimized for no scroll */}\n      <div className=\"flex-1 flex items-center justify-center p-4 lg:p-12\">\n        <div className=\"w-full max-w-md space-y-4\">\n          {/* Logo - compact for mobile */}\n          <div className=\"flex items-center justify-center gap-3\">\n            <img \n              src={logoImage} \n              alt=\"Audivia Logo\" \n              className=\"w-12 h-12 lg:w-16 lg:h-16\"\n              data-testid=\"img-logo\"\n            />\n            <div>\n              <h1 className=\"font-serif text-xl lg:text-2xl font-bold\">Audivia</h1>\n              <p className=\"text-xs lg:text-sm text-muted-foreground\">Audiolibros premium</p>\n            </div>\n          </div>\n\n          {/* Login Card - compact */}\n          <Card className=\"w-full border-0 shadow-none\">\n            <CardHeader className=\"pb-2 pt-4\">\n              <CardTitle className=\"text-xl text-center\">Iniciar SesiÃ³n</CardTitle>\n            </CardHeader>\n          <form onSubmit={handleSubmit}>\n            <CardContent className=\"space-y-3 pb-3\">\n              <div className=\"space-y-1\">\n                <Label htmlFor=\"email\" className=\"text-sm\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"tu@email.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  data-testid=\"input-email\"\n                />\n              </div>\n              <div className=\"space-y-1\">\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"password\" className=\"text-sm\">ContraseÃ±a</Label>\n                  <Link \n                    href=\"/forgot-password\" \n                    className=\"text-xs text-primary hover:underline\"\n                    data-testid=\"link-forgot-password\"\n                  >\n                    Â¿Olvidaste tu contraseÃ±a?\n                  </Link>\n                </div>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  required\n                  data-testid=\"input-password\"\n                />\n              </div>\n            </CardContent>\n            <CardFooter className=\"flex flex-col gap-3 pt-0\">\n              <Button \n                type=\"submit\" \n                className=\"w-full\" \n                disabled={isLoading}\n                data-testid=\"button-submit\"\n              >\n                {isLoading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Iniciando sesiÃ³n...\n                  </>\n                ) : (\n                  \"Iniciar SesiÃ³n\"\n                )}\n              </Button>\n              <p className=\"text-sm text-muted-foreground text-center\">\n                Â¿No tienes cuenta?{\" \"}\n                <Link href={isMobileOrigin ? \"/register?from=mobile\" : \"/register\"} className=\"text-primary hover:underline font-medium\" data-testid=\"link-register\">\n                  RegÃ­strate aquÃ­\n                </Link>\n              </p>\n            </CardFooter>\n          </form>\n        </Card>\n        </div>\n      </div>\n\n      {/* Right side - Gradient background (hidden on mobile) */}\n      <div className=\"hidden lg:flex flex-1 relative overflow-hidden bg-gradient-to-br from-primary/20 via-primary/10 to-background items-center justify-center\">\n        <div className=\"text-center p-8\">\n          <Headphones className=\"w-24 h-24 mx-auto text-primary/40 mb-4\" />\n          <p className=\"text-xl text-muted-foreground\">Miles de audiolibros te esperan</p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5782,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport connectPg from \"connect-pg-simple\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { pool as pgPool } from \"./db\";\nimport { initializeAdmin } from \"./init-admin\";\nimport { storage } from \"./storage\";\n\nconst app = express();\n\n// Validate required environment variables\nif (!process.env.SESSION_SECRET) {\n  throw new Error(\"SESSION_SECRET environment variable is required. Please set it in your .env file.\");\n}\n\n// Trust proxy for secure cookies behind reverse proxies/load balancers\napp.set(\"trust proxy\", 1);\n\n// Configure session store\nconst PgSession = connectPg(session);\napp.use(\n  session({\n    store: new PgSession({\n      pool: pgPool,\n      tableName: \"session\",\n      createTableIfMissing: true,\n    }),\n    secret: process.env.SESSION_SECRET,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days\n      httpOnly: true,\n      secure: process.env.NODE_ENV === \"production\",\n      sameSite: \"lax\",\n    },\n  })\n);\n\n// Extend Express session type\ndeclare module \"express-session\" {\n  interface SessionData {\n    userId: string;\n    pendingDiscount?: {\n      discountCodeId: string;\n      discountCode: string;\n      discountAmountCents: number;\n      originalTotalCents: number;\n      finalTotalCents: number;\n    };\n  }\n}\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"â€¦\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  // Initialize admin user on startup\n  await initializeAdmin();\n\n  // Job de limpieza: eliminar compras pendientes despuÃ©s de 24 horas\n  const cleanupPendingPurchases = async () => {\n    try {\n      const result = await storage.deleteOldPendingPurchases(24);\n      if (result.deletedPurchases > 0 || result.deletedCartItems > 0) {\n        log(`Limpieza automÃ¡tica: ${result.deletedPurchases} compras pendientes y ${result.deletedCartItems} items de carrito eliminados`);\n      }\n    } catch (error) {\n      log(`Error en limpieza automÃ¡tica: ${error}`);\n    }\n  };\n\n  // Ejecutar limpieza cada hora\n  setInterval(cleanupPendingPurchases, 60 * 60 * 1000);\n  // Ejecutar limpieza al inicio despuÃ©s de 10 segundos\n  setTimeout(cleanupPendingPurchases, 10000);\n  \n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":4245,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"server/storage.ts":{"content":"import { \n  users, \n  audiobooks, \n  chapters,\n  favorites,\n  audiobookPurchases,\n  userSubscriptions,\n  subscriptionPlans,\n  listeningProgress,\n  emailConfig,\n  passwordResetTokens,\n  driveConfig,\n  mediaAssets,\n  playlists,\n  playlistChapters,\n  stripeConfig,\n  paypalConfig,\n  billingProfiles,\n  invoices,\n  invoiceLineItems,\n  rssFeedTokens,\n  cartItems,\n  discountCodes,\n  discountCodeUsage,\n  type User, \n  type InsertUser,\n  type Audiobook,\n  type InsertAudiobook,\n  type Chapter,\n  type InsertChapter,\n  type AudiobookWithChapters,\n  type ChapterWithAudiobook,\n  type Favorite,\n  type AudiobookPurchase,\n  type UserSubscription,\n  type SubscriptionPlan,\n  type ListeningProgress,\n  type EmailConfig,\n  type InsertEmailConfig,\n  type PasswordResetToken,\n  type InsertPasswordResetToken,\n  type DriveConfig,\n  type InsertDriveConfig,\n  type MediaAsset,\n  type InsertMediaAsset,\n  type Playlist,\n  type InsertPlaylist,\n  type PlaylistChapter,\n  type StripeConfig,\n  type PaypalConfig,\n  type BillingProfile,\n  type InsertBillingProfile,\n  type Invoice,\n  type InsertInvoice,\n  type InvoiceLineItem,\n  type InsertInvoiceLineItem,\n  type RssFeedToken,\n  type CartItem,\n  type CartItemWithAudiobook,\n  type DiscountCode,\n  type InsertDiscountCode,\n  type DiscountCodeUsage,\n  type InsertDiscountCodeUsage,\n  externalServices,\n  type ExternalService,\n  type InsertExternalService,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, and, or, ilike, sql, inArray, gte, lte, lt, isNotNull } from \"drizzle-orm\";\n\n// Bulk operation response types\nexport interface BulkOperationResult {\n  successIds: string[];\n  failed: { id: string; reason: string }[];\n}\n\nexport interface IStorage {\n  // User operations\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: Omit<InsertUser, 'password'> & { passwordHash: string }): Promise<User>;\n  updateUserStripeCustomerId(userId: string, stripeCustomerId: string): Promise<User>;\n  \n  // Audiobook operations\n  getAllAudiobooks(): Promise<Audiobook[]>;\n  getPublicAudiobooks(): Promise<Audiobook[]>;\n  getAudiobook(id: string): Promise<Audiobook | undefined>;\n  getAudiobookWithChapters(id: string): Promise<AudiobookWithChapters | undefined>;\n  getAudiobooksByPublisher(userId: string): Promise<(Audiobook & { chapterCount: number })[]>;\n  createAudiobook(audiobook: Omit<Audiobook, \"id\" | \"createdAt\">): Promise<Audiobook>;\n  updateAudiobook(id: string, data: Partial<Pick<Audiobook, \"title\" | \"author\" | \"narrator\" | \"description\" | \"coverArtUrl\" | \"coverArtAssetId\" | \"category\" | \"language\" | \"priceCents\" | \"currency\" | \"isFree\" | \"visibility\" | \"totalDuration\">>): Promise<Audiobook>;\n  updateAudiobookStripeIds(id: string, stripeProductId: string, stripePriceId: string): Promise<Audiobook>;\n  \n  // Chapter operations\n  getChapter(id: string): Promise<Chapter | undefined>;\n  getChapterWithAudiobook(id: string): Promise<ChapterWithAudiobook | undefined>;\n  getChaptersByAudiobook(audiobookId: string): Promise<Chapter[]>;\n  createChapter(chapter: InsertChapter): Promise<Chapter>;\n  updateChapter(id: string, data: Partial<Pick<Chapter, \"title\" | \"chapterNumber\" | \"description\" | \"coverArtUrl\" | \"coverArtAssetId\" | \"visibility\" | \"audioUrl\" | \"audioAssetId\" | \"duration\" | \"isSample\">>): Promise<Chapter>;\n  \n  // Favorites operations\n  addToFavorites(userId: string, audiobookId: string): Promise<Favorite>;\n  removeFromFavorites(userId: string, audiobookId: string): Promise<void>;\n  getUserFavorites(userId: string): Promise<Audiobook[]>;\n  isFavorite(userId: string, audiobookId: string): Promise<boolean>;\n  \n  // Purchase operations\n  createPurchase(userId: string, audiobookId: string, pricePaidCents: number, currency: string): Promise<AudiobookPurchase>;\n  getPurchase(id: string): Promise<AudiobookPurchase | undefined>;\n  getPurchaseByUserAndAudiobook(userId: string, audiobookId: string): Promise<AudiobookPurchase | undefined>;\n  getUserPurchases(userId: string): Promise<AudiobookPurchase[]>;\n  updatePurchaseStatus(id: string, status: \"PENDING\" | \"COMPLETED\" | \"REFUNDED\" | \"FAILED\", stripePaymentIntentId?: string): Promise<AudiobookPurchase>;\n  hasPurchasedAudiobook(userId: string, audiobookId: string): Promise<boolean>;\n  \n  // Subscription plan operations\n  getAllSubscriptionPlans(): Promise<SubscriptionPlan[]>;\n  getActiveSubscriptionPlans(): Promise<SubscriptionPlan[]>;\n  getSubscriptionPlan(id: string): Promise<SubscriptionPlan | undefined>;\n  createSubscriptionPlan(plan: Omit<SubscriptionPlan, \"id\" | \"createdAt\">): Promise<SubscriptionPlan>;\n  updateSubscriptionPlan(id: string, data: Partial<Pick<SubscriptionPlan, \"name\" | \"description\" | \"priceCents\" | \"currency\" | \"intervalMonths\" | \"isActive\">>): Promise<SubscriptionPlan>;\n  deleteSubscriptionPlan(id: string): Promise<void>;\n  \n  // User subscription operations\n  getUserSubscription(userId: string): Promise<UserSubscription | undefined>;\n  createUserSubscription(userId: string, planId: string, stripeSubscriptionId: string, periodStart: Date, periodEnd: Date): Promise<UserSubscription>;\n  updateUserSubscriptionStatus(id: string, status: \"ACTIVE\" | \"PAST_DUE\" | \"CANCELED\" | \"EXPIRED\"): Promise<UserSubscription>;\n  cancelUserSubscription(id: string): Promise<UserSubscription>;\n  hasActiveSubscription(userId: string): Promise<boolean>;\n  \n  // Access control\n  hasAccessToAudiobook(userId: string | undefined, audiobookId: string): Promise<{ hasAccess: boolean; isPurchased: boolean; isSubscriber: boolean; isFree: boolean }>;\n  hasAccessToChapter(userId: string | undefined, chapterId: string): Promise<boolean>;\n  \n  // Listening progress operations\n  getListeningProgress(userId: string, audiobookId: string): Promise<ListeningProgress | undefined>;\n  updateListeningProgress(userId: string, audiobookId: string, chapterId: string, positionSeconds: number, completed?: boolean): Promise<ListeningProgress>;\n  getUserListeningHistory(userId: string): Promise<(ListeningProgress & { audiobook: Audiobook })[]>;\n  \n  // Admin operations - User management\n  getAllUsers(): Promise<User[]>;\n  updateUserRequiresApproval(userId: string, requiresApproval: boolean): Promise<User>;\n  updateUserIsActive(userId: string, isActive: boolean): Promise<User>;\n  updateUserRole(userId: string, role: \"LISTENER\" | \"CREATOR\" | \"ADMIN\"): Promise<User>;\n  \n  // Admin operations - Content moderation\n  getAllAudiobooksWithPublisher(): Promise<(Audiobook & { publisher: User })[]>;\n  getAllChaptersWithAudiobook(): Promise<(Chapter & { audiobook: Audiobook })[]>;\n  listAudiobooksFiltered(status?: string, publisherId?: string, search?: string): Promise<(Audiobook & { publisher: User })[]>;\n  listChaptersFiltered(status?: string, audiobookId?: string, publisherId?: string, search?: string): Promise<(Chapter & { audiobook: Audiobook & { publisher: User } })[]>;\n  updateAudiobookStatus(audiobookId: string, status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\", adminId: string): Promise<Audiobook>;\n  updateChapterStatus(chapterId: string, status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\", adminId: string): Promise<Chapter>;\n  publishAudiobook(audiobookId: string): Promise<Audiobook>;\n  unpublishAudiobook(audiobookId: string): Promise<Audiobook>;\n  deleteAudiobook(audiobookId: string): Promise<void>;\n  deleteChapter(chapterId: string): Promise<void>;\n  \n  // Email configuration operations\n  getActiveEmailConfig(): Promise<EmailConfig | undefined>;\n  getAllEmailConfigs(): Promise<EmailConfig[]>;\n  createEmailConfig(config: Omit<EmailConfig, \"id\" | \"createdAt\" | \"updatedAt\">): Promise<EmailConfig>;\n  updateEmailConfig(id: string, config: Partial<Omit<EmailConfig, \"id\" | \"createdAt\" | \"updatedAt\">>): Promise<EmailConfig>;\n  deleteEmailConfig(id: string): Promise<void>;\n  setActiveEmailConfig(id: string): Promise<EmailConfig>;\n  \n  // Password reset token operations\n  createPasswordResetToken(token: InsertPasswordResetToken): Promise<PasswordResetToken>;\n  getPasswordResetToken(token: string): Promise<PasswordResetToken | undefined>;\n  markPasswordResetTokenUsed(token: string): Promise<void>;\n  deleteExpiredPasswordResetTokens(): Promise<void>;\n  \n  // Email verification operations\n  getUserByVerificationToken(token: string): Promise<User | undefined>;\n  verifyUserEmail(userId: string): Promise<void>;\n  updateUserVerificationToken(userId: string, token: string, expiresAt: Date): Promise<void>;\n  \n  // User profile operations\n  updateUserProfile(userId: string, data: { username?: string; email?: string; bio?: string; avatarUrl?: string; website?: string }): Promise<User>;\n  updateUserPassword(userId: string, passwordHash: string): Promise<void>;\n  \n  // Media asset operations\n  createMediaAsset(asset: Omit<MediaAsset, \"id\" | \"createdAt\">): Promise<MediaAsset>;\n  getMediaAsset(id: string): Promise<MediaAsset | undefined>;\n  getMediaAssetByStorageKey(storageKey: string): Promise<MediaAsset | undefined>;\n  getMediaAssetsByAudiobook(audiobookId: string): Promise<MediaAsset[]>;\n  getMediaAssetsByChapter(chapterId: string): Promise<MediaAsset[]>;\n  deleteMediaAsset(id: string): Promise<void>;\n  \n  // Google Drive configuration operations\n  getActiveDriveConfig(): Promise<DriveConfig | undefined>;\n  getAllDriveConfigs(): Promise<DriveConfig[]>;\n  createDriveConfig(config: Omit<DriveConfig, \"id\" | \"createdAt\" | \"updatedAt\">): Promise<DriveConfig>;\n  updateDriveConfig(id: string, config: Partial<Omit<DriveConfig, \"id\" | \"createdAt\" | \"updatedAt\">>): Promise<DriveConfig>;\n  deleteDriveConfig(id: string): Promise<void>;\n  setActiveDriveConfig(id: string): Promise<DriveConfig>;\n  \n  // Stripe configuration operations\n  getStripeConfig(): Promise<StripeConfig | undefined>;\n  updateStripeConfig(data: Partial<Pick<StripeConfig, \"publishableKey\" | \"webhookSecret\" | \"isActive\">>): Promise<StripeConfig>;\n  \n  // PayPal configuration operations\n  getPayPalConfig(): Promise<PaypalConfig | undefined>;\n  savePayPalConfig(config: { clientId: string; webhookId?: string; environment: string; isActive: boolean }): Promise<PaypalConfig>;\n  \n  // PayPal-specific operations\n  getUserPurchaseForAudiobook(userId: string, audiobookId: string): Promise<AudiobookPurchase | undefined>;\n  getPurchaseByPayPalOrderId(paypalOrderId: string): Promise<AudiobookPurchase | undefined>;\n  markPurchaseCompletedByPayPalOrderId(paypalOrderId: string, captureId: string, payerEmail?: string): Promise<AudiobookPurchase | undefined>;\n  getUserActiveSubscription(userId: string): Promise<UserSubscription | undefined>;\n  getUserSubscriptionByPayPalId(userId: string, paypalSubscriptionId: string): Promise<UserSubscription | undefined>;\n  updateSubscriptionStatusByPayPalId(paypalSubscriptionId: string, status: \"ACTIVE\" | \"PAST_DUE\" | \"CANCELED\" | \"EXPIRED\"): Promise<void>;\n  updateSubscriptionPlanPayPalIds(id: string, paypalPlanId: string, paypalProductId: string): Promise<SubscriptionPlan>;\n  \n  // Billing profile operations\n  getBillingProfile(userId: string): Promise<BillingProfile | undefined>;\n  createBillingProfile(profile: InsertBillingProfile): Promise<BillingProfile>;\n  updateBillingProfile(userId: string, data: Partial<InsertBillingProfile>): Promise<BillingProfile>;\n  \n  // Invoice operations\n  createInvoice(invoice: Omit<InsertInvoice, 'invoiceNumber'>, lineItems?: Array<{description: string; quantity: number; unitPriceCents: number; totalCents: number}>): Promise<Invoice>;\n  createInvoiceLineItem(item: InsertInvoiceLineItem): Promise<InvoiceLineItem>;\n  getInvoice(id: string): Promise<Invoice | undefined>;\n  getInvoiceByNumber(invoiceNumber: string): Promise<Invoice | undefined>;\n  getUserInvoices(userId: string): Promise<Invoice[]>;\n  getInvoiceLineItems(invoiceId: string): Promise<InvoiceLineItem[]>;\n  updateInvoicePdfPath(id: string, pdfPath: string): Promise<Invoice>;\n  getNextInvoiceNumber(): Promise<string>;\n  \n  // Bulk operations\n  bulkUpdateUsersRole(ids: string[], role: \"LISTENER\" | \"CREATOR\" | \"ADMIN\"): Promise<BulkOperationResult>;\n  bulkUpdateUsersActive(ids: string[], isActive: boolean): Promise<BulkOperationResult>;\n  bulkDeleteUsers(ids: string[]): Promise<BulkOperationResult>;\n  bulkUpdateAudiobooksStatus(ids: string[], status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\", adminId: string): Promise<BulkOperationResult>;\n  bulkDeleteAudiobooks(ids: string[]): Promise<BulkOperationResult>;\n  bulkUpdateChaptersStatus(ids: string[], status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\", adminId: string): Promise<BulkOperationResult>;\n  bulkDeleteChapters(ids: string[]): Promise<BulkOperationResult>;\n  \n  // Playlist operations\n  createPlaylist(playlist: Omit<Playlist, \"id\" | \"createdAt\" | \"updatedAt\"> & { userId: string }): Promise<Playlist>;\n  getPlaylist(id: string): Promise<Playlist | undefined>;\n  getUserPlaylists(userId: string): Promise<Playlist[]>;\n  getPublicPlaylists(): Promise<Playlist[]>;\n  updatePlaylist(id: string, data: Partial<Pick<Playlist, \"name\" | \"description\" | \"isPublic\">>): Promise<Playlist>;\n  deletePlaylist(id: string): Promise<void>;\n  addChapterToPlaylist(playlistId: string, chapterId: string): Promise<PlaylistChapter>;\n  removeChapterFromPlaylist(playlistId: string, chapterId: string): Promise<void>;\n  getPlaylistChapters(playlistId: string): Promise<Chapter[]>;\n  isChapterInPlaylist(playlistId: string, chapterId: string): Promise<boolean>;\n  reorderPlaylistChapters(playlistId: string, chapterIds: string[]): Promise<void>;\n  \n  // Sales analytics operations\n  getSalesSummary(from: Date, to: Date): Promise<{\n    totalRevenueCents: number;\n    purchaseCount: number;\n    subscriptionCount: number;\n    purchaseRevenueCents: number;\n    subscriptionRevenueCents: number;\n    averageOrderValueCents: number;\n  }>;\n  getRevenueTrend(from: Date, to: Date, interval: 'day' | 'week' | 'month'): Promise<Array<{\n    date: string;\n    purchaseRevenueCents: number;\n    subscriptionRevenueCents: number;\n    totalRevenueCents: number;\n  }>>;\n  getTopAudiobooks(from: Date, to: Date, limit: number): Promise<Array<{\n    audiobook: Audiobook;\n    salesCount: number;\n    revenueCents: number;\n  }>>;\n  getRecentTransactions(limit: number): Promise<Array<{\n    id: string;\n    type: 'purchase' | 'subscription';\n    amount: number;\n    currency: string;\n    userName: string;\n    userEmail: string;\n    itemName: string;\n    date: Date;\n    status: string;\n  }>>;\n  \n  // RSS Feed token operations\n  getRssFeedToken(userId: string): Promise<RssFeedToken | undefined>;\n  getRssFeedTokenByToken(token: string): Promise<RssFeedToken | undefined>;\n  createRssFeedToken(userId: string, token: string): Promise<RssFeedToken>;\n  regenerateRssFeedToken(userId: string, newToken: string): Promise<RssFeedToken>;\n  updateRssFeedTokenAccess(token: string): Promise<void>;\n  \n  // Shopping cart operations\n  getCartItems(userId: string): Promise<CartItemWithAudiobook[]>;\n  addToCart(userId: string, audiobookId: string): Promise<CartItem>;\n  removeFromCart(userId: string, audiobookId: string): Promise<void>;\n  clearCart(userId: string): Promise<void>;\n  isInCart(userId: string, audiobookId: string): Promise<boolean>;\n  getCartTotal(userId: string): Promise<{ totalCents: number; itemCount: number; currency: string }>;\n  \n  // Admin customer management operations\n  getCustomersWithStats(filters?: { search?: string; role?: string; hasProfile?: boolean }): Promise<Array<{\n    user: User;\n    billingProfile: BillingProfile | null;\n    totalPurchases: number;\n    totalSpentCents: number;\n    lastPurchaseAt: Date | null;\n  }>>;\n  getCustomerDetail(userId: string): Promise<{\n    user: User;\n    billingProfile: BillingProfile | null;\n    purchases: Array<AudiobookPurchase & { audiobook: Audiobook }>;\n    invoices: Invoice[];\n    subscription: UserSubscription | null;\n    stats: { totalPurchases: number; totalSpentCents: number; lastPurchaseAt: Date | null };\n  } | undefined>;\n  getAllInvoicesAdmin(filters?: { search?: string; status?: string; from?: Date; to?: Date }): Promise<Array<Invoice & { user: User }>>;\n  \n  // Discount code operations\n  createDiscountCode(data: InsertDiscountCode): Promise<DiscountCode>;\n  getDiscountCode(id: string): Promise<DiscountCode | undefined>;\n  getDiscountCodeByCode(code: string): Promise<DiscountCode | undefined>;\n  getAllDiscountCodes(): Promise<DiscountCode[]>;\n  updateDiscountCode(id: string, data: Partial<InsertDiscountCode>): Promise<DiscountCode>;\n  deleteDiscountCode(id: string): Promise<void>;\n  incrementDiscountCodeUsage(id: string): Promise<void>;\n  validateDiscountCode(code: string, userId: string, totalCents: number, forSubscription: boolean): Promise<{ valid: boolean; discountCode?: DiscountCode; error?: string }>;\n  recordDiscountCodeUsage(discountCodeId: string, userId: string, purchaseId: string | null, discountAmountCents: number): Promise<DiscountCodeUsage>;\n  getUserDiscountCodeUsageCount(discountCodeId: string, userId: string): Promise<number>;\n  \n  // External services operations\n  getExternalServices(): Promise<ExternalService[]>;\n  getExternalService(id: string): Promise<ExternalService | undefined>;\n  createExternalService(service: InsertExternalService): Promise<ExternalService>;\n  updateExternalService(id: string, data: Partial<InsertExternalService>): Promise<ExternalService>;\n  deleteExternalService(id: string): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user || undefined;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user || undefined;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user || undefined;\n  }\n\n  async createUser(insertUser: Omit<InsertUser, 'password'> & { passwordHash: string }): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(insertUser)\n      .returning();\n    return user;\n  }\n\n  async updateUserStripeCustomerId(userId: string, stripeCustomerId: string): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ stripeCustomerId })\n      .where(eq(users.id, userId))\n      .returning();\n    return user;\n  }\n\n  // Audiobook operations\n  async getAllAudiobooks(): Promise<Audiobook[]> {\n    return await db.select().from(audiobooks).orderBy(desc(audiobooks.createdAt));\n  }\n\n  async getPublicAudiobooks(): Promise<Audiobook[]> {\n    return await db\n      .select()\n      .from(audiobooks)\n      .where(and(\n        eq(audiobooks.visibility, \"PUBLIC\"),\n        eq(audiobooks.status, \"APPROVED\"),\n        isNotNull(audiobooks.publishedAt)\n      ))\n      .orderBy(desc(audiobooks.createdAt));\n  }\n\n  async getAudiobook(id: string): Promise<Audiobook | undefined> {\n    const [audiobook] = await db.select().from(audiobooks).where(eq(audiobooks.id, id));\n    return audiobook || undefined;\n  }\n\n  async getAudiobookWithChapters(id: string): Promise<AudiobookWithChapters | undefined> {\n    const [audiobook] = await db.select().from(audiobooks).where(eq(audiobooks.id, id));\n    if (!audiobook) return undefined;\n\n    const audiobookChapters = await db\n      .select()\n      .from(chapters)\n      .where(eq(chapters.audiobookId, id))\n      .orderBy(chapters.chapterNumber);\n    \n    return {\n      ...audiobook,\n      chapters: audiobookChapters,\n    };\n  }\n\n  async getAudiobooksByPublisher(userId: string): Promise<(Audiobook & { chapterCount: number })[]> {\n    const result = await db\n      .select({\n        audiobook: audiobooks,\n        chapterCount: sql<number>`cast(count(${chapters.id}) as int)`,\n      })\n      .from(audiobooks)\n      .leftJoin(chapters, eq(audiobooks.id, chapters.audiobookId))\n      .where(eq(audiobooks.publisherId, userId))\n      .groupBy(audiobooks.id)\n      .orderBy(desc(audiobooks.createdAt));\n    \n    return result.map(r => ({ ...r.audiobook, chapterCount: r.chapterCount }));\n  }\n\n  async createAudiobook(insertAudiobook: Omit<Audiobook, \"id\" | \"createdAt\">): Promise<Audiobook> {\n    const publisher = await this.getUser(insertAudiobook.publisherId);\n    const status = (publisher?.requiresApproval === false) ? \"APPROVED\" : \"PENDING_APPROVAL\";\n    \n    const audiobookData: any = {\n      ...insertAudiobook,\n      status,\n    };\n    \n    if (status === \"APPROVED\") {\n      audiobookData.approvedAt = new Date();\n      audiobookData.approvedBy = insertAudiobook.publisherId;\n    }\n    \n    const [audiobook] = await db\n      .insert(audiobooks)\n      .values(audiobookData)\n      .returning();\n    return audiobook;\n  }\n\n  async updateAudiobook(id: string, data: Partial<Pick<Audiobook, \"title\" | \"author\" | \"narrator\" | \"description\" | \"coverArtUrl\" | \"coverArtAssetId\" | \"category\" | \"language\" | \"priceCents\" | \"currency\" | \"isFree\" | \"visibility\" | \"totalDuration\">>): Promise<Audiobook> {\n    const [updated] = await db\n      .update(audiobooks)\n      .set(data)\n      .where(eq(audiobooks.id, id))\n      .returning();\n    \n    if (!updated) {\n      throw new Error(\"Audiobook not found\");\n    }\n    \n    return updated;\n  }\n\n  async updateAudiobookStripeIds(id: string, stripeProductId: string, stripePriceId: string): Promise<Audiobook> {\n    const [updated] = await db\n      .update(audiobooks)\n      .set({ stripeProductId, stripePriceId })\n      .where(eq(audiobooks.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Chapter operations\n  async getChapter(id: string): Promise<Chapter | undefined> {\n    const [chapter] = await db.select().from(chapters).where(eq(chapters.id, id));\n    return chapter || undefined;\n  }\n\n  async getChapterWithAudiobook(id: string): Promise<ChapterWithAudiobook | undefined> {\n    const result = await db\n      .select({\n        chapter: chapters,\n        audiobook: audiobooks,\n      })\n      .from(chapters)\n      .innerJoin(audiobooks, eq(chapters.audiobookId, audiobooks.id))\n      .where(eq(chapters.id, id));\n    \n    if (result.length === 0) return undefined;\n    \n    return {\n      ...result[0].chapter,\n      audiobook: result[0].audiobook,\n    };\n  }\n\n  async getChaptersByAudiobook(audiobookId: string): Promise<Chapter[]> {\n    return await db\n      .select()\n      .from(chapters)\n      .where(eq(chapters.audiobookId, audiobookId))\n      .orderBy(chapters.chapterNumber);\n  }\n\n  async createChapter(insertChapter: InsertChapter): Promise<Chapter> {\n    const audiobook = await this.getAudiobook(insertChapter.audiobookId);\n    if (!audiobook) {\n      throw new Error(\"Audiobook not found\");\n    }\n    \n    const publisher = await this.getUser(audiobook.publisherId);\n    const status = (publisher?.requiresApproval === false) ? \"APPROVED\" : \"PENDING_APPROVAL\";\n    \n    const chapterData: any = {\n      ...insertChapter,\n      status,\n    };\n    \n    if (status === \"APPROVED\") {\n      chapterData.approvedAt = new Date();\n      chapterData.approvedBy = audiobook.publisherId;\n    }\n    \n    const [chapter] = await db\n      .insert(chapters)\n      .values(chapterData)\n      .returning();\n    return chapter;\n  }\n\n  async updateChapter(id: string, data: Partial<Pick<Chapter, \"title\" | \"chapterNumber\" | \"description\" | \"coverArtUrl\" | \"coverArtAssetId\" | \"visibility\" | \"audioUrl\" | \"audioAssetId\" | \"duration\" | \"isSample\">>): Promise<Chapter> {\n    const [updated] = await db\n      .update(chapters)\n      .set(data)\n      .where(eq(chapters.id, id))\n      .returning();\n    \n    if (!updated) {\n      throw new Error(\"Chapter not found\");\n    }\n    \n    return updated;\n  }\n\n  // Favorites operations\n  async addToFavorites(userId: string, audiobookId: string): Promise<Favorite> {\n    const existing = await this.isFavorite(userId, audiobookId);\n    if (existing) {\n      const [fav] = await db\n        .select()\n        .from(favorites)\n        .where(and(\n          eq(favorites.userId, userId),\n          eq(favorites.audiobookId, audiobookId)\n        ))\n        .limit(1);\n      return fav;\n    }\n    \n    const [favorite] = await db\n      .insert(favorites)\n      .values({ userId, audiobookId })\n      .returning();\n    return favorite;\n  }\n\n  async removeFromFavorites(userId: string, audiobookId: string): Promise<void> {\n    await db\n      .delete(favorites)\n      .where(and(\n        eq(favorites.userId, userId),\n        eq(favorites.audiobookId, audiobookId)\n      ));\n  }\n\n  async getUserFavorites(userId: string): Promise<Audiobook[]> {\n    const result = await db\n      .select({ audiobook: audiobooks })\n      .from(favorites)\n      .innerJoin(audiobooks, eq(favorites.audiobookId, audiobooks.id))\n      .where(eq(favorites.userId, userId))\n      .orderBy(desc(favorites.createdAt));\n    \n    return result.map(r => r.audiobook);\n  }\n\n  async isFavorite(userId: string, audiobookId: string): Promise<boolean> {\n    const [fav] = await db\n      .select()\n      .from(favorites)\n      .where(and(\n        eq(favorites.userId, userId),\n        eq(favorites.audiobookId, audiobookId)\n      ))\n      .limit(1);\n    \n    return !!fav;\n  }\n\n  // Purchase operations\n  async createPurchase(userId: string, audiobookId: string, pricePaidCents: number, currency: string): Promise<AudiobookPurchase> {\n    const [purchase] = await db\n      .insert(audiobookPurchases)\n      .values({\n        userId,\n        audiobookId,\n        pricePaidCents,\n        currency,\n        status: \"PENDING\",\n      })\n      .returning();\n    return purchase;\n  }\n\n  async getPurchase(id: string): Promise<AudiobookPurchase | undefined> {\n    const [purchase] = await db.select().from(audiobookPurchases).where(eq(audiobookPurchases.id, id));\n    return purchase || undefined;\n  }\n\n  async getPurchaseByUserAndAudiobook(userId: string, audiobookId: string): Promise<AudiobookPurchase | undefined> {\n    const [purchase] = await db\n      .select()\n      .from(audiobookPurchases)\n      .where(and(\n        eq(audiobookPurchases.userId, userId),\n        eq(audiobookPurchases.audiobookId, audiobookId),\n        eq(audiobookPurchases.status, \"COMPLETED\")\n      ));\n    return purchase || undefined;\n  }\n\n  async getUserPurchases(userId: string): Promise<AudiobookPurchase[]> {\n    return await db\n      .select()\n      .from(audiobookPurchases)\n      .where(and(\n        eq(audiobookPurchases.userId, userId),\n        eq(audiobookPurchases.status, \"COMPLETED\")\n      ))\n      .orderBy(desc(audiobookPurchases.purchasedAt));\n  }\n\n  async updatePurchaseStatus(id: string, status: \"PENDING\" | \"COMPLETED\" | \"REFUNDED\" | \"FAILED\", stripePaymentIntentId?: string): Promise<AudiobookPurchase> {\n    const updateData: any = { status };\n    if (status === \"COMPLETED\") {\n      updateData.purchasedAt = new Date();\n    }\n    if (stripePaymentIntentId) {\n      updateData.stripePaymentIntentId = stripePaymentIntentId;\n    }\n    \n    const [purchase] = await db\n      .update(audiobookPurchases)\n      .set(updateData)\n      .where(eq(audiobookPurchases.id, id))\n      .returning();\n    return purchase;\n  }\n\n  async hasPurchasedAudiobook(userId: string, audiobookId: string): Promise<boolean> {\n    const purchase = await this.getPurchaseByUserAndAudiobook(userId, audiobookId);\n    return !!purchase;\n  }\n\n  // Subscription plan operations\n  async getAllSubscriptionPlans(): Promise<SubscriptionPlan[]> {\n    return await db.select().from(subscriptionPlans).orderBy(subscriptionPlans.priceCents);\n  }\n\n  async getActiveSubscriptionPlans(): Promise<SubscriptionPlan[]> {\n    return await db\n      .select()\n      .from(subscriptionPlans)\n      .where(eq(subscriptionPlans.isActive, true))\n      .orderBy(subscriptionPlans.priceCents);\n  }\n\n  async getSubscriptionPlan(id: string): Promise<SubscriptionPlan | undefined> {\n    const [plan] = await db.select().from(subscriptionPlans).where(eq(subscriptionPlans.id, id));\n    return plan || undefined;\n  }\n\n  async createSubscriptionPlan(plan: Omit<SubscriptionPlan, \"id\" | \"createdAt\">): Promise<SubscriptionPlan> {\n    const [newPlan] = await db\n      .insert(subscriptionPlans)\n      .values(plan)\n      .returning();\n    return newPlan;\n  }\n\n  async updateSubscriptionPlan(id: string, data: Partial<Pick<SubscriptionPlan, \"name\" | \"description\" | \"priceCents\" | \"currency\" | \"intervalMonths\" | \"isActive\">>): Promise<SubscriptionPlan> {\n    const [updated] = await db\n      .update(subscriptionPlans)\n      .set(data)\n      .where(eq(subscriptionPlans.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteSubscriptionPlan(id: string): Promise<void> {\n    await db.delete(subscriptionPlans).where(eq(subscriptionPlans.id, id));\n  }\n\n  // User subscription operations\n  async getUserSubscription(userId: string): Promise<UserSubscription | undefined> {\n    const [subscription] = await db\n      .select()\n      .from(userSubscriptions)\n      .where(and(\n        eq(userSubscriptions.userId, userId),\n        eq(userSubscriptions.status, \"ACTIVE\")\n      ))\n      .orderBy(desc(userSubscriptions.createdAt))\n      .limit(1);\n    return subscription || undefined;\n  }\n\n  async createUserSubscription(userId: string, planId: string, stripeSubscriptionId: string, periodStart: Date, periodEnd: Date): Promise<UserSubscription> {\n    const [subscription] = await db\n      .insert(userSubscriptions)\n      .values({\n        userId,\n        planId,\n        stripeSubscriptionId,\n        status: \"ACTIVE\",\n        currentPeriodStart: periodStart,\n        currentPeriodEnd: periodEnd,\n      })\n      .returning();\n    return subscription;\n  }\n\n  async updateUserSubscriptionStatus(id: string, status: \"ACTIVE\" | \"PAST_DUE\" | \"CANCELED\" | \"EXPIRED\"): Promise<UserSubscription> {\n    const [subscription] = await db\n      .update(userSubscriptions)\n      .set({ status })\n      .where(eq(userSubscriptions.id, id))\n      .returning();\n    return subscription;\n  }\n\n  async cancelUserSubscription(id: string): Promise<UserSubscription> {\n    const [subscription] = await db\n      .update(userSubscriptions)\n      .set({ status: \"CANCELED\", canceledAt: new Date() })\n      .where(eq(userSubscriptions.id, id))\n      .returning();\n    return subscription;\n  }\n\n  async hasActiveSubscription(userId: string): Promise<boolean> {\n    const subscription = await this.getUserSubscription(userId);\n    if (!subscription) return false;\n    return subscription.status === \"ACTIVE\" && subscription.currentPeriodEnd > new Date();\n  }\n\n  // Access control\n  async hasAccessToAudiobook(userId: string | undefined, audiobookId: string): Promise<{ hasAccess: boolean; isPurchased: boolean; isSubscriber: boolean; isFree: boolean }> {\n    const audiobook = await this.getAudiobook(audiobookId);\n    if (!audiobook) return { hasAccess: false, isPurchased: false, isSubscriber: false, isFree: false };\n\n    const isFree = audiobook.isFree || audiobook.priceCents === 0;\n    \n    // Free audiobooks are accessible to everyone\n    if (isFree) {\n      return { hasAccess: true, isPurchased: false, isSubscriber: false, isFree: true };\n    }\n\n    // Not logged in - no access to paid content\n    if (!userId) {\n      return { hasAccess: false, isPurchased: false, isSubscriber: false, isFree: false };\n    }\n\n    // Publisher always has access\n    if (audiobook.publisherId === userId) {\n      return { hasAccess: true, isPurchased: false, isSubscriber: false, isFree: false };\n    }\n\n    // Check if admin\n    const user = await this.getUser(userId);\n    if (user?.role === \"ADMIN\") {\n      return { hasAccess: true, isPurchased: false, isSubscriber: false, isFree: false };\n    }\n\n    // Check if purchased\n    const isPurchased = await this.hasPurchasedAudiobook(userId, audiobookId);\n    if (isPurchased) {\n      return { hasAccess: true, isPurchased: true, isSubscriber: false, isFree: false };\n    }\n\n    // Check if subscriber\n    const isSubscriber = await this.hasActiveSubscription(userId);\n    if (isSubscriber) {\n      return { hasAccess: true, isPurchased: false, isSubscriber: true, isFree: false };\n    }\n\n    return { hasAccess: false, isPurchased: false, isSubscriber: false, isFree: false };\n  }\n\n  async hasAccessToChapter(userId: string | undefined, chapterId: string): Promise<boolean> {\n    const chapter = await this.getChapterWithAudiobook(chapterId);\n    if (!chapter) return false;\n\n    // Sample chapters are always accessible\n    if (chapter.isSample) return true;\n\n    const access = await this.hasAccessToAudiobook(userId, chapter.audiobookId);\n    return access.hasAccess;\n  }\n\n  // Listening progress operations\n  async getListeningProgress(userId: string, audiobookId: string): Promise<ListeningProgress | undefined> {\n    const [progress] = await db\n      .select()\n      .from(listeningProgress)\n      .where(and(\n        eq(listeningProgress.userId, userId),\n        eq(listeningProgress.audiobookId, audiobookId)\n      ));\n    return progress || undefined;\n  }\n\n  async updateListeningProgress(userId: string, audiobookId: string, chapterId: string, positionSeconds: number, completed?: boolean): Promise<ListeningProgress> {\n    const existing = await this.getListeningProgress(userId, audiobookId);\n    \n    if (existing) {\n      const [updated] = await db\n        .update(listeningProgress)\n        .set({\n          chapterId,\n          positionSeconds,\n          completed: completed ?? existing.completed,\n          updatedAt: new Date(),\n        })\n        .where(eq(listeningProgress.id, existing.id))\n        .returning();\n      return updated;\n    }\n    \n    const [created] = await db\n      .insert(listeningProgress)\n      .values({\n        userId,\n        audiobookId,\n        chapterId,\n        positionSeconds,\n        completed: completed ?? false,\n      })\n      .returning();\n    return created;\n  }\n\n  async getUserListeningHistory(userId: string): Promise<(ListeningProgress & { audiobook: Audiobook })[]> {\n    const result = await db\n      .select({\n        progress: listeningProgress,\n        audiobook: audiobooks,\n      })\n      .from(listeningProgress)\n      .innerJoin(audiobooks, eq(listeningProgress.audiobookId, audiobooks.id))\n      .where(eq(listeningProgress.userId, userId))\n      .orderBy(desc(listeningProgress.updatedAt));\n    \n    return result.map(r => ({ ...r.progress, audiobook: r.audiobook }));\n  }\n\n  // Admin operations - User management\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async updateUserRequiresApproval(userId: string, requiresApproval: boolean): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ requiresApproval })\n      .where(eq(users.id, userId))\n      .returning();\n    return user;\n  }\n\n  async updateUserIsActive(userId: string, isActive: boolean): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ isActive })\n      .where(eq(users.id, userId))\n      .returning();\n    return user;\n  }\n\n  async updateUserRole(userId: string, role: \"LISTENER\" | \"CREATOR\" | \"ADMIN\"): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({ role })\n      .where(eq(users.id, userId))\n      .returning();\n    return user;\n  }\n\n  // Admin operations - Content moderation\n  async getAllAudiobooksWithPublisher(): Promise<(Audiobook & { publisher: User })[]> {\n    const result = await db\n      .select({\n        audiobook: audiobooks,\n        publisher: users,\n      })\n      .from(audiobooks)\n      .innerJoin(users, eq(audiobooks.publisherId, users.id))\n      .orderBy(desc(audiobooks.createdAt));\n    \n    return result.map(r => ({ ...r.audiobook, publisher: r.publisher }));\n  }\n\n  async getAllChaptersWithAudiobook(): Promise<(Chapter & { audiobook: Audiobook })[]> {\n    const result = await db\n      .select({\n        chapter: chapters,\n        audiobook: audiobooks,\n      })\n      .from(chapters)\n      .innerJoin(audiobooks, eq(chapters.audiobookId, audiobooks.id))\n      .orderBy(chapters.chapterNumber);\n    \n    return result.map(r => ({ ...r.chapter, audiobook: r.audiobook }));\n  }\n\n  async listAudiobooksFiltered(\n    status?: string,\n    publisherId?: string,\n    search?: string\n  ): Promise<(Audiobook & { publisher: User })[]> {\n    const conditions = [];\n    \n    if (status) {\n      conditions.push(eq(audiobooks.status, status as any));\n    }\n    if (publisherId) {\n      conditions.push(eq(audiobooks.publisherId, publisherId));\n    }\n    if (search) {\n      conditions.push(\n        or(\n          ilike(audiobooks.title, `%${search}%`),\n          ilike(audiobooks.description, `%${search}%`),\n          ilike(audiobooks.author, `%${search}%`)\n        )\n      );\n    }\n\n    const result = await db\n      .select({\n        audiobook: audiobooks,\n        publisher: users,\n      })\n      .from(audiobooks)\n      .innerJoin(users, eq(audiobooks.publisherId, users.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(audiobooks.createdAt));\n    \n    return result.map(r => ({ ...r.audiobook, publisher: r.publisher }));\n  }\n\n  async listChaptersFiltered(\n    status?: string,\n    audiobookId?: string,\n    publisherId?: string,\n    search?: string\n  ): Promise<(Chapter & { audiobook: Audiobook & { publisher: User } })[]> {\n    const conditions = [];\n    \n    if (status) {\n      conditions.push(eq(chapters.status, status as any));\n    }\n    if (audiobookId) {\n      conditions.push(eq(chapters.audiobookId, audiobookId));\n    }\n    if (publisherId) {\n      conditions.push(eq(audiobooks.publisherId, publisherId));\n    }\n    if (search) {\n      conditions.push(\n        or(\n          ilike(chapters.title, `%${search}%`),\n          ilike(chapters.description, `%${search}%`),\n          ilike(audiobooks.title, `%${search}%`)\n        )\n      );\n    }\n\n    const result = await db\n      .select({\n        chapter: chapters,\n        audiobook: audiobooks,\n        publisher: users,\n      })\n      .from(chapters)\n      .innerJoin(audiobooks, eq(chapters.audiobookId, audiobooks.id))\n      .innerJoin(users, eq(audiobooks.publisherId, users.id))\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(chapters.chapterNumber);\n    \n    return result.map(r => ({ \n      ...r.chapter, \n      audiobook: { ...r.audiobook, publisher: r.publisher } \n    }));\n  }\n\n  async updateAudiobookStatus(\n    audiobookId: string, \n    status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\", \n    adminId: string\n  ): Promise<Audiobook> {\n    const updateData: any = { status };\n    \n    if (status === \"APPROVED\") {\n      updateData.approvedAt = new Date();\n      updateData.approvedBy = adminId;\n    }\n    \n    const [audiobook] = await db\n      .update(audiobooks)\n      .set(updateData)\n      .where(eq(audiobooks.id, audiobookId))\n      .returning();\n    return audiobook;\n  }\n\n  async updateChapterStatus(\n    chapterId: string, \n    status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\", \n    adminId: string\n  ): Promise<Chapter> {\n    const updateData: any = { status };\n    \n    if (status === \"APPROVED\") {\n      updateData.approvedAt = new Date();\n      updateData.approvedBy = adminId;\n    }\n    \n    const [chapter] = await db\n      .update(chapters)\n      .set(updateData)\n      .where(eq(chapters.id, chapterId))\n      .returning();\n    return chapter;\n  }\n\n  async publishAudiobook(audiobookId: string): Promise<Audiobook> {\n    const [audiobook] = await db\n      .update(audiobooks)\n      .set({ publishedAt: new Date() })\n      .where(eq(audiobooks.id, audiobookId))\n      .returning();\n    return audiobook;\n  }\n\n  async unpublishAudiobook(audiobookId: string): Promise<Audiobook> {\n    const [audiobook] = await db\n      .update(audiobooks)\n      .set({ publishedAt: null })\n      .where(eq(audiobooks.id, audiobookId))\n      .returning();\n    return audiobook;\n  }\n\n  async deleteAudiobook(audiobookId: string): Promise<void> {\n    await db.transaction(async (tx) => {\n      await tx.delete(favorites).where(eq(favorites.audiobookId, audiobookId));\n      await tx.delete(audiobookPurchases).where(eq(audiobookPurchases.audiobookId, audiobookId));\n      await tx.delete(listeningProgress).where(eq(listeningProgress.audiobookId, audiobookId));\n      await tx.delete(mediaAssets).where(eq(mediaAssets.audiobookId, audiobookId));\n      await tx.delete(chapters).where(eq(chapters.audiobookId, audiobookId));\n      await tx.delete(audiobooks).where(eq(audiobooks.id, audiobookId));\n    });\n  }\n\n  async deleteChapter(chapterId: string): Promise<void> {\n    await db.delete(chapters).where(eq(chapters.id, chapterId));\n  }\n\n  // Email configuration operations\n  async getActiveEmailConfig(): Promise<EmailConfig | undefined> {\n    const [config] = await db\n      .select()\n      .from(emailConfig)\n      .where(eq(emailConfig.isActive, true));\n    return config || undefined;\n  }\n\n  async getAllEmailConfigs(): Promise<EmailConfig[]> {\n    return await db.select().from(emailConfig).orderBy(desc(emailConfig.createdAt));\n  }\n\n  async createEmailConfig(config: Omit<EmailConfig, \"id\" | \"createdAt\" | \"updatedAt\">): Promise<EmailConfig> {\n    if (config.isActive === true) {\n      await db.update(emailConfig).set({ isActive: false });\n    }\n\n    const [newConfig] = await db\n      .insert(emailConfig)\n      .values(config)\n      .returning();\n    return newConfig;\n  }\n\n  async updateEmailConfig(id: string, config: Partial<Omit<EmailConfig, \"id\" | \"createdAt\" | \"updatedAt\">>): Promise<EmailConfig> {\n    if (config.isActive === true) {\n      await db.update(emailConfig).set({ isActive: false });\n    }\n\n    const [updated] = await db\n      .update(emailConfig)\n      .set({ ...config, updatedAt: new Date() })\n      .where(eq(emailConfig.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteEmailConfig(id: string): Promise<void> {\n    await db.delete(emailConfig).where(eq(emailConfig.id, id));\n  }\n\n  async setActiveEmailConfig(id: string): Promise<EmailConfig> {\n    await db.update(emailConfig).set({ isActive: false });\n    const [config] = await db\n      .update(emailConfig)\n      .set({ isActive: true, updatedAt: new Date() })\n      .where(eq(emailConfig.id, id))\n      .returning();\n    return config;\n  }\n\n  // Password reset token operations\n  async createPasswordResetToken(token: InsertPasswordResetToken): Promise<PasswordResetToken> {\n    const [resetToken] = await db\n      .insert(passwordResetTokens)\n      .values(token)\n      .returning();\n    return resetToken;\n  }\n\n  async getPasswordResetToken(token: string): Promise<PasswordResetToken | undefined> {\n    const [resetToken] = await db\n      .select()\n      .from(passwordResetTokens)\n      .where(eq(passwordResetTokens.token, token));\n    return resetToken || undefined;\n  }\n\n  async markPasswordResetTokenUsed(token: string): Promise<void> {\n    await db\n      .update(passwordResetTokens)\n      .set({ usedAt: new Date() })\n      .where(eq(passwordResetTokens.token, token));\n  }\n\n  async deleteExpiredPasswordResetTokens(): Promise<void> {\n    await db\n      .delete(passwordResetTokens)\n      .where(lte(passwordResetTokens.expiresAt, new Date()));\n  }\n\n  // Email verification operations\n  async getUserByVerificationToken(token: string): Promise<User | undefined> {\n    const [user] = await db\n      .select()\n      .from(users)\n      .where(eq(users.emailVerificationToken, token));\n    return user || undefined;\n  }\n\n  async verifyUserEmail(userId: string): Promise<void> {\n    await db\n      .update(users)\n      .set({\n        emailVerified: true,\n        emailVerificationToken: null,\n        emailVerificationTokenExpiresAt: null,\n      })\n      .where(eq(users.id, userId));\n  }\n\n  async updateUserVerificationToken(userId: string, token: string, expiresAt: Date): Promise<void> {\n    await db\n      .update(users)\n      .set({\n        emailVerificationToken: token,\n        emailVerificationTokenExpiresAt: expiresAt,\n      })\n      .where(eq(users.id, userId));\n  }\n\n  // User profile operations\n  async updateUserProfile(userId: string, data: { username?: string; email?: string; bio?: string; avatarUrl?: string; website?: string }): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set(data)\n      .where(eq(users.id, userId))\n      .returning();\n    return user;\n  }\n\n  async updateUserPassword(userId: string, passwordHash: string): Promise<void> {\n    await db\n      .update(users)\n      .set({ passwordHash })\n      .where(eq(users.id, userId));\n  }\n\n  // Media asset operations\n  async createMediaAsset(asset: Omit<MediaAsset, \"id\" | \"createdAt\">): Promise<MediaAsset> {\n    const [mediaAsset] = await db\n      .insert(mediaAssets)\n      .values(asset)\n      .returning();\n    return mediaAsset;\n  }\n\n  async getMediaAsset(id: string): Promise<MediaAsset | undefined> {\n    const [asset] = await db.select().from(mediaAssets).where(eq(mediaAssets.id, id));\n    return asset || undefined;\n  }\n\n  async getMediaAssetByStorageKey(storageKey: string): Promise<MediaAsset | undefined> {\n    const [asset] = await db\n      .select()\n      .from(mediaAssets)\n      .where(eq(mediaAssets.storageKey, storageKey));\n    return asset || undefined;\n  }\n\n  async getMediaAssetsByAudiobook(audiobookId: string): Promise<MediaAsset[]> {\n    return await db\n      .select()\n      .from(mediaAssets)\n      .where(eq(mediaAssets.audiobookId, audiobookId));\n  }\n\n  async getMediaAssetsByChapter(chapterId: string): Promise<MediaAsset[]> {\n    return await db\n      .select()\n      .from(mediaAssets)\n      .where(eq(mediaAssets.chapterId, chapterId));\n  }\n\n  async deleteMediaAsset(id: string): Promise<void> {\n    await db.delete(mediaAssets).where(eq(mediaAssets.id, id));\n  }\n\n  // Google Drive configuration operations\n  async getActiveDriveConfig(): Promise<DriveConfig | undefined> {\n    const [config] = await db\n      .select()\n      .from(driveConfig)\n      .where(eq(driveConfig.isActive, true));\n    return config || undefined;\n  }\n\n  async getAllDriveConfigs(): Promise<DriveConfig[]> {\n    return await db.select().from(driveConfig).orderBy(desc(driveConfig.createdAt));\n  }\n\n  async createDriveConfig(config: Omit<DriveConfig, \"id\" | \"createdAt\" | \"updatedAt\">): Promise<DriveConfig> {\n    if (config.isActive === true) {\n      await db.update(driveConfig).set({ isActive: false });\n    }\n\n    const [newConfig] = await db\n      .insert(driveConfig)\n      .values(config)\n      .returning();\n    return newConfig;\n  }\n\n  async updateDriveConfig(id: string, config: Partial<Omit<DriveConfig, \"id\" | \"createdAt\" | \"updatedAt\">>): Promise<DriveConfig> {\n    if (config.isActive === true) {\n      await db.update(driveConfig).set({ isActive: false });\n    }\n\n    const [updated] = await db\n      .update(driveConfig)\n      .set({ ...config, updatedAt: new Date() })\n      .where(eq(driveConfig.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteDriveConfig(id: string): Promise<void> {\n    await db.delete(driveConfig).where(eq(driveConfig.id, id));\n  }\n\n  async setActiveDriveConfig(id: string): Promise<DriveConfig> {\n    await db.update(driveConfig).set({ isActive: false });\n    const [config] = await db\n      .update(driveConfig)\n      .set({ isActive: true, updatedAt: new Date() })\n      .where(eq(driveConfig.id, id))\n      .returning();\n    return config;\n  }\n\n  // Stripe configuration operations\n  async getStripeConfig(): Promise<StripeConfig | undefined> {\n    const [config] = await db.select().from(stripeConfig).limit(1);\n    return config || undefined;\n  }\n\n  async updateStripeConfig(data: Partial<Pick<StripeConfig, \"publishableKey\" | \"webhookSecret\" | \"isActive\">>): Promise<StripeConfig> {\n    const existing = await this.getStripeConfig();\n    \n    if (existing) {\n      const [updated] = await db\n        .update(stripeConfig)\n        .set({ ...data, updatedAt: new Date() })\n        .where(eq(stripeConfig.id, existing.id))\n        .returning();\n      return updated;\n    }\n    \n    const [created] = await db\n      .insert(stripeConfig)\n      .values({ ...data })\n      .returning();\n    return created;\n  }\n\n  // PayPal configuration operations\n  async getPayPalConfig(): Promise<PaypalConfig | undefined> {\n    const [config] = await db\n      .select()\n      .from(paypalConfig)\n      .where(eq(paypalConfig.isActive, true))\n      .limit(1);\n    return config || undefined;\n  }\n\n  async savePayPalConfig(config: { clientId: string; webhookId?: string; environment: string; isActive: boolean }): Promise<PaypalConfig> {\n    const existing = await this.getPayPalConfig();\n    \n    if (existing) {\n      const [updated] = await db\n        .update(paypalConfig)\n        .set({\n          clientId: config.clientId,\n          webhookId: config.webhookId || null,\n          environment: config.environment,\n          isActive: config.isActive,\n          updatedAt: new Date(),\n        })\n        .where(eq(paypalConfig.id, existing.id))\n        .returning();\n      return updated;\n    }\n    \n    const [created] = await db\n      .insert(paypalConfig)\n      .values({\n        clientId: config.clientId,\n        webhookId: config.webhookId || null,\n        environment: config.environment,\n        isActive: config.isActive,\n      })\n      .returning();\n    return created;\n  }\n\n  // PayPal-specific operations\n  async getUserPurchaseForAudiobook(userId: string, audiobookId: string): Promise<AudiobookPurchase | undefined> {\n    const [purchase] = await db\n      .select()\n      .from(audiobookPurchases)\n      .where(and(\n        eq(audiobookPurchases.userId, userId),\n        eq(audiobookPurchases.audiobookId, audiobookId)\n      ))\n      .orderBy(desc(audiobookPurchases.createdAt))\n      .limit(1);\n    return purchase || undefined;\n  }\n\n  async getPurchaseByPayPalOrderId(paypalOrderId: string): Promise<AudiobookPurchase | undefined> {\n    const [purchase] = await db\n      .select()\n      .from(audiobookPurchases)\n      .where(eq(audiobookPurchases.paypalOrderId, paypalOrderId))\n      .limit(1);\n    return purchase || undefined;\n  }\n\n  async markPurchaseCompletedByPayPalOrderId(paypalOrderId: string, captureId: string, payerEmail?: string): Promise<AudiobookPurchase | undefined> {\n    const [purchase] = await db\n      .update(audiobookPurchases)\n      .set({\n        status: \"COMPLETED\",\n        paypalCaptureId: captureId,\n        paypalPayerEmail: payerEmail || null,\n        purchasedAt: new Date(),\n      })\n      .where(eq(audiobookPurchases.paypalOrderId, paypalOrderId))\n      .returning();\n    return purchase || undefined;\n  }\n\n  async getUserActiveSubscription(userId: string): Promise<UserSubscription | undefined> {\n    const [subscription] = await db\n      .select()\n      .from(userSubscriptions)\n      .where(and(\n        eq(userSubscriptions.userId, userId),\n        eq(userSubscriptions.status, \"ACTIVE\")\n      ))\n      .limit(1);\n    return subscription || undefined;\n  }\n\n  async getUserSubscriptionByPayPalId(userId: string, paypalSubscriptionId: string): Promise<UserSubscription | undefined> {\n    const [subscription] = await db\n      .select()\n      .from(userSubscriptions)\n      .where(and(\n        eq(userSubscriptions.userId, userId),\n        eq(userSubscriptions.paypalSubscriptionId, paypalSubscriptionId)\n      ))\n      .limit(1);\n    return subscription || undefined;\n  }\n\n  async updateSubscriptionStatusByPayPalId(paypalSubscriptionId: string, status: \"ACTIVE\" | \"PAST_DUE\" | \"CANCELED\" | \"EXPIRED\"): Promise<void> {\n    const updateData: any = { status };\n    if (status === \"CANCELED\") {\n      updateData.canceledAt = new Date();\n    }\n    await db\n      .update(userSubscriptions)\n      .set(updateData)\n      .where(eq(userSubscriptions.paypalSubscriptionId, paypalSubscriptionId));\n  }\n\n  async updateSubscriptionPlanPayPalIds(id: string, paypalPlanId: string, paypalProductId: string): Promise<SubscriptionPlan> {\n    const [updated] = await db\n      .update(subscriptionPlans)\n      .set({ paypalPlanId, paypalProductId })\n      .where(eq(subscriptionPlans.id, id))\n      .returning();\n    if (!updated) {\n      throw new Error(\"Subscription plan not found\");\n    }\n    return updated;\n  }\n\n  // Billing profile operations\n  async getBillingProfile(userId: string): Promise<BillingProfile | undefined> {\n    const [profile] = await db\n      .select()\n      .from(billingProfiles)\n      .where(eq(billingProfiles.userId, userId))\n      .limit(1);\n    return profile || undefined;\n  }\n\n  async createBillingProfile(profile: InsertBillingProfile): Promise<BillingProfile> {\n    const [created] = await db\n      .insert(billingProfiles)\n      .values(profile)\n      .returning();\n    return created;\n  }\n\n  async updateBillingProfile(userId: string, data: Partial<InsertBillingProfile>): Promise<BillingProfile> {\n    const [updated] = await db\n      .update(billingProfiles)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(billingProfiles.userId, userId))\n      .returning();\n    if (!updated) {\n      throw new Error(\"Billing profile not found\");\n    }\n    return updated;\n  }\n\n  // Invoice operations\n  async createInvoice(\n    invoice: Omit<InsertInvoice, 'invoiceNumber'>, \n    lineItems?: Array<{description: string; quantity: number; unitPriceCents: number; totalCents: number}>\n  ): Promise<Invoice> {\n    // Generate invoice number automatically\n    const invoiceNumber = await this.getNextInvoiceNumber();\n    \n    // Use transaction to ensure invoice and line items are created atomically\n    return await db.transaction(async (tx) => {\n      const [created] = await tx\n        .insert(invoices)\n        .values({ ...invoice, invoiceNumber })\n        .returning();\n      \n      // Create line items if provided\n      if (lineItems && lineItems.length > 0) {\n        for (const item of lineItems) {\n          await tx.insert(invoiceLineItems).values({\n            invoiceId: created.id,\n            description: item.description,\n            quantity: item.quantity,\n            unitPriceCents: item.unitPriceCents,\n            totalCents: item.totalCents,\n          });\n        }\n      }\n      \n      return created;\n    });\n  }\n\n  async createInvoiceLineItem(item: InsertInvoiceLineItem): Promise<InvoiceLineItem> {\n    const [created] = await db\n      .insert(invoiceLineItems)\n      .values(item)\n      .returning();\n    return created;\n  }\n\n  async getInvoice(id: string): Promise<Invoice | undefined> {\n    const [invoice] = await db\n      .select()\n      .from(invoices)\n      .where(eq(invoices.id, id))\n      .limit(1);\n    return invoice || undefined;\n  }\n\n  async getInvoiceByNumber(invoiceNumber: string): Promise<Invoice | undefined> {\n    const [invoice] = await db\n      .select()\n      .from(invoices)\n      .where(eq(invoices.invoiceNumber, invoiceNumber))\n      .limit(1);\n    return invoice || undefined;\n  }\n\n  async getUserInvoices(userId: string): Promise<Invoice[]> {\n    return await db\n      .select()\n      .from(invoices)\n      .where(eq(invoices.userId, userId))\n      .orderBy(desc(invoices.issueDate));\n  }\n\n  async getInvoiceLineItems(invoiceId: string): Promise<InvoiceLineItem[]> {\n    return await db\n      .select()\n      .from(invoiceLineItems)\n      .where(eq(invoiceLineItems.invoiceId, invoiceId));\n  }\n\n  async updateInvoicePdfPath(id: string, pdfPath: string): Promise<Invoice> {\n    const [updated] = await db\n      .update(invoices)\n      .set({ pdfPath, pdfStatus: \"READY\" })\n      .where(eq(invoices.id, id))\n      .returning();\n    if (!updated) {\n      throw new Error(\"Invoice not found\");\n    }\n    return updated;\n  }\n\n  async getNextInvoiceNumber(): Promise<string> {\n    const year = new Date().getFullYear();\n    const [result] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(invoices)\n      .where(sql`EXTRACT(YEAR FROM ${invoices.issueDate}) = ${year}`);\n    const count = (result?.count || 0) + 1;\n    return `AUD-${year}-${String(count).padStart(5, '0')}`;\n  }\n\n  // Bulk operations\n  async bulkUpdateUsersRole(ids: string[], role: \"LISTENER\" | \"CREATOR\" | \"ADMIN\"): Promise<BulkOperationResult> {\n    const uniqueIds = Array.from(new Set(ids));\n    const successIds: string[] = [];\n    const failed: { id: string; reason: string }[] = [];\n\n    await db.transaction(async (tx) => {\n      const existingUsers = await tx\n        .select({ id: users.id })\n        .from(users)\n        .where(inArray(users.id, uniqueIds));\n      \n      const existingIds = existingUsers.map(u => u.id);\n      \n      for (const id of uniqueIds) {\n        if (!existingIds.includes(id)) {\n          failed.push({ id, reason: \"User not found\" });\n        }\n      }\n\n      if (existingIds.length > 0) {\n        const updated = await tx\n          .update(users)\n          .set({ role })\n          .where(inArray(users.id, existingIds))\n          .returning({ id: users.id });\n        \n        successIds.push(...updated.map(u => u.id));\n      }\n    });\n\n    return { successIds, failed };\n  }\n\n  async bulkUpdateUsersActive(ids: string[], isActive: boolean): Promise<BulkOperationResult> {\n    const uniqueIds = Array.from(new Set(ids));\n    const successIds: string[] = [];\n    const failed: { id: string; reason: string }[] = [];\n\n    await db.transaction(async (tx) => {\n      const existingUsers = await tx\n        .select({ id: users.id })\n        .from(users)\n        .where(inArray(users.id, uniqueIds));\n      \n      const existingIds = existingUsers.map(u => u.id);\n      \n      for (const id of uniqueIds) {\n        if (!existingIds.includes(id)) {\n          failed.push({ id, reason: \"User not found\" });\n        }\n      }\n\n      if (existingIds.length > 0) {\n        const updated = await tx\n          .update(users)\n          .set({ isActive })\n          .where(inArray(users.id, existingIds))\n          .returning({ id: users.id });\n        \n        successIds.push(...updated.map(u => u.id));\n      }\n    });\n\n    return { successIds, failed };\n  }\n\n  async bulkDeleteUsers(ids: string[]): Promise<BulkOperationResult> {\n    const uniqueIds = Array.from(new Set(ids));\n    const successIds: string[] = [];\n    const failed: { id: string; reason: string }[] = [];\n\n    await db.transaction(async (tx) => {\n      const existingUsers = await tx\n        .select({ id: users.id })\n        .from(users)\n        .where(inArray(users.id, uniqueIds));\n      \n      const existingIds = existingUsers.map(u => u.id);\n      \n      for (const id of uniqueIds) {\n        if (!existingIds.includes(id)) {\n          failed.push({ id, reason: \"User not found\" });\n        }\n      }\n\n      if (existingIds.length > 0) {\n        const deleted = await tx\n          .delete(users)\n          .where(inArray(users.id, existingIds))\n          .returning({ id: users.id });\n        \n        successIds.push(...deleted.map(u => u.id));\n      }\n    });\n\n    return { successIds, failed };\n  }\n\n  async bulkUpdateAudiobooksStatus(\n    ids: string[],\n    status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\",\n    adminId: string\n  ): Promise<BulkOperationResult> {\n    const uniqueIds = Array.from(new Set(ids));\n    const successIds: string[] = [];\n    const failed: { id: string; reason: string }[] = [];\n\n    await db.transaction(async (tx) => {\n      const existingAudiobooks = await tx\n        .select({ id: audiobooks.id })\n        .from(audiobooks)\n        .where(inArray(audiobooks.id, uniqueIds));\n      \n      const existingIds = existingAudiobooks.map(a => a.id);\n      \n      for (const id of uniqueIds) {\n        if (!existingIds.includes(id)) {\n          failed.push({ id, reason: \"Audiobook not found\" });\n        }\n      }\n\n      if (existingIds.length > 0) {\n        const updated = await tx\n          .update(audiobooks)\n          .set({ \n            status,\n            approvedBy: adminId,\n            approvedAt: new Date(),\n          })\n          .where(inArray(audiobooks.id, existingIds))\n          .returning({ id: audiobooks.id });\n        \n        successIds.push(...updated.map(a => a.id));\n      }\n    });\n\n    return { successIds, failed };\n  }\n\n  async bulkDeleteAudiobooks(ids: string[]): Promise<BulkOperationResult> {\n    const uniqueIds = Array.from(new Set(ids));\n    const successIds: string[] = [];\n    const failed: { id: string; reason: string }[] = [];\n\n    await db.transaction(async (tx) => {\n      const existingAudiobooks = await tx\n        .select({ id: audiobooks.id })\n        .from(audiobooks)\n        .where(inArray(audiobooks.id, uniqueIds));\n      \n      const existingIds = existingAudiobooks.map(a => a.id);\n      \n      for (const id of uniqueIds) {\n        if (!existingIds.includes(id)) {\n          failed.push({ id, reason: \"Audiobook not found\" });\n        }\n      }\n\n      if (existingIds.length > 0) {\n        await tx.delete(favorites).where(inArray(favorites.audiobookId, existingIds));\n        await tx.delete(audiobookPurchases).where(inArray(audiobookPurchases.audiobookId, existingIds));\n        await tx.delete(listeningProgress).where(inArray(listeningProgress.audiobookId, existingIds));\n        await tx.delete(mediaAssets).where(inArray(mediaAssets.audiobookId, existingIds));\n        await tx.delete(chapters).where(inArray(chapters.audiobookId, existingIds));\n        \n        const deleted = await tx\n          .delete(audiobooks)\n          .where(inArray(audiobooks.id, existingIds))\n          .returning({ id: audiobooks.id });\n        \n        successIds.push(...deleted.map(a => a.id));\n      }\n    });\n\n    return { successIds, failed };\n  }\n\n  async bulkUpdateChaptersStatus(\n    ids: string[],\n    status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\",\n    adminId: string\n  ): Promise<BulkOperationResult> {\n    const uniqueIds = Array.from(new Set(ids));\n    const successIds: string[] = [];\n    const failed: { id: string; reason: string }[] = [];\n\n    await db.transaction(async (tx) => {\n      const existingChapters = await tx\n        .select({ id: chapters.id })\n        .from(chapters)\n        .where(inArray(chapters.id, uniqueIds));\n      \n      const existingIds = existingChapters.map(c => c.id);\n      \n      for (const id of uniqueIds) {\n        if (!existingIds.includes(id)) {\n          failed.push({ id, reason: \"Chapter not found\" });\n        }\n      }\n\n      if (existingIds.length > 0) {\n        const updated = await tx\n          .update(chapters)\n          .set({ \n            status,\n            approvedBy: adminId,\n            approvedAt: new Date(),\n          })\n          .where(inArray(chapters.id, existingIds))\n          .returning({ id: chapters.id });\n        \n        successIds.push(...updated.map(c => c.id));\n      }\n    });\n\n    return { successIds, failed };\n  }\n\n  async bulkDeleteChapters(ids: string[]): Promise<BulkOperationResult> {\n    const uniqueIds = Array.from(new Set(ids));\n    const successIds: string[] = [];\n    const failed: { id: string; reason: string }[] = [];\n\n    await db.transaction(async (tx) => {\n      const existingChapters = await tx\n        .select({ id: chapters.id })\n        .from(chapters)\n        .where(inArray(chapters.id, uniqueIds));\n      \n      const existingIds = existingChapters.map(c => c.id);\n      \n      for (const id of uniqueIds) {\n        if (!existingIds.includes(id)) {\n          failed.push({ id, reason: \"Chapter not found\" });\n        }\n      }\n\n      if (existingIds.length > 0) {\n        const deleted = await tx\n          .delete(chapters)\n          .where(inArray(chapters.id, existingIds))\n          .returning({ id: chapters.id });\n        \n        successIds.push(...deleted.map(c => c.id));\n      }\n    });\n\n    return { successIds, failed };\n  }\n\n  // Playlist operations\n  async createPlaylist(playlist: Omit<Playlist, \"id\" | \"createdAt\" | \"updatedAt\"> & { userId: string }): Promise<Playlist> {\n    const [newPlaylist] = await db\n      .insert(playlists)\n      .values(playlist)\n      .returning();\n    return newPlaylist;\n  }\n\n  async getPlaylist(id: string): Promise<Playlist | undefined> {\n    const [playlist] = await db\n      .select()\n      .from(playlists)\n      .where(eq(playlists.id, id));\n    return playlist || undefined;\n  }\n\n  async getUserPlaylists(userId: string): Promise<Playlist[]> {\n    return await db\n      .select()\n      .from(playlists)\n      .where(eq(playlists.userId, userId))\n      .orderBy(desc(playlists.updatedAt));\n  }\n\n  async getPublicPlaylists(): Promise<Playlist[]> {\n    return await db\n      .select()\n      .from(playlists)\n      .where(eq(playlists.isPublic, true))\n      .orderBy(desc(playlists.updatedAt));\n  }\n\n  async updatePlaylist(id: string, data: Partial<Pick<Playlist, \"name\" | \"description\" | \"isPublic\">>): Promise<Playlist> {\n    const [updated] = await db\n      .update(playlists)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(playlists.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deletePlaylist(id: string): Promise<void> {\n    await db.delete(playlists).where(eq(playlists.id, id));\n  }\n\n  async addChapterToPlaylist(playlistId: string, chapterId: string): Promise<PlaylistChapter> {\n    const existingChapters = await db\n      .select()\n      .from(playlistChapters)\n      .where(eq(playlistChapters.playlistId, playlistId));\n    \n    const maxPosition = existingChapters.length > 0 \n      ? Math.max(...existingChapters.map(c => c.position)) \n      : -1;\n\n    const [added] = await db\n      .insert(playlistChapters)\n      .values({\n        playlistId,\n        chapterId,\n        position: maxPosition + 1,\n      })\n      .returning();\n\n    await db\n      .update(playlists)\n      .set({ updatedAt: new Date() })\n      .where(eq(playlists.id, playlistId));\n\n    return added;\n  }\n\n  async removeChapterFromPlaylist(playlistId: string, chapterId: string): Promise<void> {\n    await db\n      .delete(playlistChapters)\n      .where(\n        and(\n          eq(playlistChapters.playlistId, playlistId),\n          eq(playlistChapters.chapterId, chapterId)\n        )\n      );\n\n    await db\n      .update(playlists)\n      .set({ updatedAt: new Date() })\n      .where(eq(playlists.id, playlistId));\n  }\n\n  async getPlaylistChapters(playlistId: string): Promise<Chapter[]> {\n    const result = await db\n      .select({\n        chapter: chapters,\n        position: playlistChapters.position,\n      })\n      .from(playlistChapters)\n      .innerJoin(chapters, eq(playlistChapters.chapterId, chapters.id))\n      .where(eq(playlistChapters.playlistId, playlistId))\n      .orderBy(playlistChapters.position);\n\n    return result.map(r => r.chapter);\n  }\n\n  async isChapterInPlaylist(playlistId: string, chapterId: string): Promise<boolean> {\n    const [result] = await db\n      .select()\n      .from(playlistChapters)\n      .where(\n        and(\n          eq(playlistChapters.playlistId, playlistId),\n          eq(playlistChapters.chapterId, chapterId)\n        )\n      );\n    return !!result;\n  }\n\n  async reorderPlaylistChapters(playlistId: string, chapterIds: string[]): Promise<void> {\n    for (let i = 0; i < chapterIds.length; i++) {\n      await db\n        .update(playlistChapters)\n        .set({ position: i })\n        .where(\n          and(\n            eq(playlistChapters.playlistId, playlistId),\n            eq(playlistChapters.chapterId, chapterIds[i])\n          )\n        );\n    }\n\n    await db\n      .update(playlists)\n      .set({ updatedAt: new Date() })\n      .where(eq(playlists.id, playlistId));\n  }\n\n  // Sales analytics operations - uses invoices as the source of truth for revenue\n  async getSalesSummary(from: Date, to: Date): Promise<{\n    totalRevenueCents: number;\n    purchaseCount: number;\n    subscriptionCount: number;\n    purchaseRevenueCents: number;\n    subscriptionRevenueCents: number;\n    averageOrderValueCents: number;\n  }> {\n    const purchaseInvoices = await db\n      .select({\n        count: sql<number>`count(*)::int`,\n        revenue: sql<number>`coalesce(sum(${invoices.totalCents}), 0)::int`,\n      })\n      .from(invoices)\n      .where(\n        and(\n          eq(invoices.type, \"PURCHASE\"),\n          or(eq(invoices.status, \"ISSUED\"), eq(invoices.status, \"PAID\")),\n          gte(invoices.issueDate, from),\n          lte(invoices.issueDate, to)\n        )\n      );\n\n    const subscriptionInvoices = await db\n      .select({\n        count: sql<number>`count(*)::int`,\n        revenue: sql<number>`coalesce(sum(${invoices.totalCents}), 0)::int`,\n      })\n      .from(invoices)\n      .where(\n        and(\n          eq(invoices.type, \"SUBSCRIPTION\"),\n          or(eq(invoices.status, \"ISSUED\"), eq(invoices.status, \"PAID\")),\n          gte(invoices.issueDate, from),\n          lte(invoices.issueDate, to)\n        )\n      );\n\n    const purchaseCount = purchaseInvoices[0]?.count || 0;\n    const purchaseRevenueCents = purchaseInvoices[0]?.revenue || 0;\n    const subscriptionCount = subscriptionInvoices[0]?.count || 0;\n    const subscriptionRevenueCents = subscriptionInvoices[0]?.revenue || 0;\n    const totalRevenueCents = purchaseRevenueCents + subscriptionRevenueCents;\n    const totalTransactions = purchaseCount + subscriptionCount;\n    const averageOrderValueCents = totalTransactions > 0 ? Math.round(totalRevenueCents / totalTransactions) : 0;\n\n    return {\n      totalRevenueCents,\n      purchaseCount,\n      subscriptionCount,\n      purchaseRevenueCents,\n      subscriptionRevenueCents,\n      averageOrderValueCents,\n    };\n  }\n\n  async getRevenueTrend(from: Date, to: Date, interval: 'day' | 'week' | 'month'): Promise<Array<{\n    date: string;\n    purchaseRevenueCents: number;\n    subscriptionRevenueCents: number;\n    totalRevenueCents: number;\n  }>> {\n    const truncInterval = interval === 'day' ? 'day' : interval === 'week' ? 'week' : 'month';\n    \n    const purchaseTrend = await db\n      .select({\n        date: sql<string>`date_trunc(${truncInterval}, ${invoices.issueDate})::date::text`,\n        revenue: sql<number>`coalesce(sum(${invoices.totalCents}), 0)::int`,\n      })\n      .from(invoices)\n      .where(\n        and(\n          eq(invoices.type, \"PURCHASE\"),\n          or(eq(invoices.status, \"ISSUED\"), eq(invoices.status, \"PAID\")),\n          gte(invoices.issueDate, from),\n          lte(invoices.issueDate, to)\n        )\n      )\n      .groupBy(sql`date_trunc(${truncInterval}, ${invoices.issueDate})`)\n      .orderBy(sql`date_trunc(${truncInterval}, ${invoices.issueDate})`);\n\n    const subscriptionTrend = await db\n      .select({\n        date: sql<string>`date_trunc(${truncInterval}, ${invoices.issueDate})::date::text`,\n        revenue: sql<number>`coalesce(sum(${invoices.totalCents}), 0)::int`,\n      })\n      .from(invoices)\n      .where(\n        and(\n          eq(invoices.type, \"SUBSCRIPTION\"),\n          or(eq(invoices.status, \"ISSUED\"), eq(invoices.status, \"PAID\")),\n          gte(invoices.issueDate, from),\n          lte(invoices.issueDate, to)\n        )\n      )\n      .groupBy(sql`date_trunc(${truncInterval}, ${invoices.issueDate})`)\n      .orderBy(sql`date_trunc(${truncInterval}, ${invoices.issueDate})`);\n\n    const dateMap = new Map<string, { purchaseRevenueCents: number; subscriptionRevenueCents: number }>();\n    \n    for (const p of purchaseTrend) {\n      dateMap.set(p.date, { purchaseRevenueCents: p.revenue, subscriptionRevenueCents: 0 });\n    }\n    \n    for (const s of subscriptionTrend) {\n      const existing = dateMap.get(s.date) || { purchaseRevenueCents: 0, subscriptionRevenueCents: 0 };\n      existing.subscriptionRevenueCents = s.revenue;\n      dateMap.set(s.date, existing);\n    }\n\n    return Array.from(dateMap.entries())\n      .sort((a, b) => a[0].localeCompare(b[0]))\n      .map(([date, data]) => ({\n        date,\n        purchaseRevenueCents: data.purchaseRevenueCents,\n        subscriptionRevenueCents: data.subscriptionRevenueCents,\n        totalRevenueCents: data.purchaseRevenueCents + data.subscriptionRevenueCents,\n      }));\n  }\n\n  async getTopAudiobooks(from: Date, to: Date, limit: number): Promise<Array<{\n    audiobook: Audiobook;\n    salesCount: number;\n    revenueCents: number;\n  }>> {\n    const result = await db\n      .select({\n        audiobook: audiobooks,\n        salesCount: sql<number>`count(${audiobookPurchases.id})::int`,\n        revenueCents: sql<number>`coalesce(sum(${audiobookPurchases.pricePaidCents}), 0)::int`,\n      })\n      .from(audiobookPurchases)\n      .innerJoin(audiobooks, eq(audiobookPurchases.audiobookId, audiobooks.id))\n      .where(\n        and(\n          eq(audiobookPurchases.status, \"COMPLETED\"),\n          gte(audiobookPurchases.purchasedAt, from),\n          lte(audiobookPurchases.purchasedAt, to)\n        )\n      )\n      .groupBy(audiobooks.id)\n      .orderBy(sql`sum(${audiobookPurchases.pricePaidCents}) desc`)\n      .limit(limit);\n\n    return result;\n  }\n\n  async getRecentTransactions(limit: number): Promise<Array<{\n    id: string;\n    type: 'purchase' | 'subscription';\n    amount: number;\n    currency: string;\n    userName: string;\n    userEmail: string;\n    itemName: string;\n    date: Date;\n    status: string;\n  }>> {\n    const allInvoices = await db\n      .select({\n        id: invoices.id,\n        type: invoices.type,\n        amount: invoices.totalCents,\n        currency: invoices.currency,\n        userName: users.username,\n        userEmail: users.email,\n        date: invoices.issueDate,\n        status: invoices.status,\n        purchaseId: invoices.purchaseId,\n        subscriptionId: invoices.subscriptionId,\n      })\n      .from(invoices)\n      .innerJoin(users, eq(invoices.userId, users.id))\n      .where(or(eq(invoices.status, \"ISSUED\"), eq(invoices.status, \"PAID\")))\n      .orderBy(desc(invoices.issueDate))\n      .limit(limit * 2);\n\n    const purchaseIds = allInvoices.filter(i => i.purchaseId).map(i => i.purchaseId!);\n    const subscriptionIds = allInvoices.filter(i => i.subscriptionId).map(i => i.subscriptionId!);\n\n    const purchaseNames: Record<string, string> = {};\n    const subscriptionNames: Record<string, string> = {};\n\n    if (purchaseIds.length > 0) {\n      const purchases = await db\n        .select({\n          purchaseId: audiobookPurchases.id,\n          title: audiobooks.title,\n        })\n        .from(audiobookPurchases)\n        .innerJoin(audiobooks, eq(audiobookPurchases.audiobookId, audiobooks.id))\n        .where(inArray(audiobookPurchases.id, purchaseIds));\n      \n      for (const p of purchases) {\n        purchaseNames[p.purchaseId] = p.title;\n      }\n    }\n\n    if (subscriptionIds.length > 0) {\n      const subs = await db\n        .select({\n          subId: userSubscriptions.id,\n          planName: subscriptionPlans.name,\n        })\n        .from(userSubscriptions)\n        .innerJoin(subscriptionPlans, eq(userSubscriptions.planId, subscriptionPlans.id))\n        .where(inArray(userSubscriptions.id, subscriptionIds));\n      \n      for (const s of subs) {\n        subscriptionNames[s.subId] = s.planName;\n      }\n    }\n\n    return allInvoices\n      .map(inv => ({\n        id: inv.id,\n        type: inv.type === \"PURCHASE\" ? \"purchase\" as const : \"subscription\" as const,\n        amount: inv.amount,\n        currency: inv.currency,\n        userName: inv.userName,\n        userEmail: inv.userEmail,\n        itemName: inv.purchaseId \n          ? purchaseNames[inv.purchaseId] || \"Audiolibro\" \n          : subscriptionNames[inv.subscriptionId!] || \"Suscripcion\",\n        date: inv.date,\n        status: inv.status,\n      }))\n      .slice(0, limit);\n  }\n\n  // RSS Feed token operations\n  async getRssFeedToken(userId: string): Promise<RssFeedToken | undefined> {\n    const [token] = await db.select().from(rssFeedTokens).where(eq(rssFeedTokens.userId, userId));\n    return token || undefined;\n  }\n\n  async getRssFeedTokenByToken(token: string): Promise<RssFeedToken | undefined> {\n    const [feedToken] = await db.select().from(rssFeedTokens).where(eq(rssFeedTokens.token, token));\n    return feedToken || undefined;\n  }\n\n  async createRssFeedToken(userId: string, token: string): Promise<RssFeedToken> {\n    const [feedToken] = await db\n      .insert(rssFeedTokens)\n      .values({ userId, token, isActive: true })\n      .returning();\n    return feedToken;\n  }\n\n  async regenerateRssFeedToken(userId: string, newToken: string): Promise<RssFeedToken> {\n    const [feedToken] = await db\n      .update(rssFeedTokens)\n      .set({ token: newToken })\n      .where(eq(rssFeedTokens.userId, userId))\n      .returning();\n    return feedToken;\n  }\n\n  async updateRssFeedTokenAccess(token: string): Promise<void> {\n    await db\n      .update(rssFeedTokens)\n      .set({ lastAccessedAt: new Date() })\n      .where(eq(rssFeedTokens.token, token));\n  }\n\n  // Shopping cart operations\n  async getCartItems(userId: string): Promise<CartItemWithAudiobook[]> {\n    const items = await db\n      .select({\n        cartItem: cartItems,\n        audiobook: audiobooks,\n      })\n      .from(cartItems)\n      .innerJoin(audiobooks, eq(cartItems.audiobookId, audiobooks.id))\n      .where(eq(cartItems.userId, userId))\n      .orderBy(desc(cartItems.createdAt));\n\n    return items.map(item => ({\n      ...item.cartItem,\n      audiobook: item.audiobook,\n    }));\n  }\n\n  async addToCart(userId: string, audiobookId: string): Promise<CartItem> {\n    const [item] = await db\n      .insert(cartItems)\n      .values({ userId, audiobookId })\n      .onConflictDoNothing()\n      .returning();\n    \n    if (!item) {\n      const [existing] = await db\n        .select()\n        .from(cartItems)\n        .where(and(eq(cartItems.userId, userId), eq(cartItems.audiobookId, audiobookId)));\n      return existing;\n    }\n    return item;\n  }\n\n  async removeFromCart(userId: string, audiobookId: string): Promise<void> {\n    await db\n      .delete(cartItems)\n      .where(and(eq(cartItems.userId, userId), eq(cartItems.audiobookId, audiobookId)));\n  }\n\n  async clearCart(userId: string): Promise<void> {\n    await db.delete(cartItems).where(eq(cartItems.userId, userId));\n  }\n\n  async isInCart(userId: string, audiobookId: string): Promise<boolean> {\n    const [item] = await db\n      .select()\n      .from(cartItems)\n      .where(and(eq(cartItems.userId, userId), eq(cartItems.audiobookId, audiobookId)));\n    return !!item;\n  }\n\n  async getCartTotal(userId: string): Promise<{ totalCents: number; itemCount: number; currency: string }> {\n    const items = await this.getCartItems(userId);\n    const totalCents = items.reduce((sum, item) => sum + item.audiobook.priceCents, 0);\n    return {\n      totalCents,\n      itemCount: items.length,\n      currency: items.length > 0 ? items[0].audiobook.currency : \"EUR\",\n    };\n  }\n\n  // Admin customer management operations\n  async getCustomersWithStats(filters?: { search?: string; role?: string; hasProfile?: boolean }): Promise<Array<{\n    user: User;\n    billingProfile: BillingProfile | null;\n    totalPurchases: number;\n    totalSpentCents: number;\n    lastPurchaseAt: Date | null;\n  }>> {\n    let conditions: any[] = [];\n    \n    if (filters?.search) {\n      const searchTerm = `%${filters.search}%`;\n      conditions.push(\n        or(\n          ilike(users.username, searchTerm),\n          ilike(users.email, searchTerm)\n        )\n      );\n    }\n    \n    if (filters?.role) {\n      conditions.push(eq(users.role, filters.role as any));\n    }\n\n    let query = db.select().from(users);\n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as typeof query;\n    }\n    const allUsers = await query.orderBy(desc(users.createdAt));\n\n    const results = await Promise.all(allUsers.map(async (user) => {\n      const [profile] = await db.select().from(billingProfiles).where(eq(billingProfiles.userId, user.id));\n      \n      const purchaseStats = await db\n        .select({\n          count: sql<number>`count(*)::int`,\n          total: sql<number>`coalesce(sum(${audiobookPurchases.pricePaidCents}), 0)::int`,\n          lastPurchase: sql<Date | null>`max(${audiobookPurchases.purchasedAt})`,\n        })\n        .from(audiobookPurchases)\n        .where(and(\n          eq(audiobookPurchases.userId, user.id),\n          eq(audiobookPurchases.status, \"COMPLETED\")\n        ));\n\n      return {\n        user,\n        billingProfile: profile || null,\n        totalPurchases: purchaseStats[0]?.count || 0,\n        totalSpentCents: purchaseStats[0]?.total || 0,\n        lastPurchaseAt: purchaseStats[0]?.lastPurchase || null,\n      };\n    }));\n\n    if (filters?.hasProfile !== undefined) {\n      return results.filter(r => filters.hasProfile ? r.billingProfile !== null : r.billingProfile === null);\n    }\n\n    return results;\n  }\n\n  async getCustomerDetail(userId: string): Promise<{\n    user: User;\n    billingProfile: BillingProfile | null;\n    purchases: Array<AudiobookPurchase & { audiobook: Audiobook }>;\n    invoices: Invoice[];\n    subscription: UserSubscription | null;\n    stats: { totalPurchases: number; totalSpentCents: number; lastPurchaseAt: Date | null };\n  } | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, userId));\n    if (!user) return undefined;\n\n    const [profile] = await db.select().from(billingProfiles).where(eq(billingProfiles.userId, userId));\n    \n    const purchasesData = await db\n      .select({\n        purchase: audiobookPurchases,\n        audiobook: audiobooks,\n      })\n      .from(audiobookPurchases)\n      .innerJoin(audiobooks, eq(audiobookPurchases.audiobookId, audiobooks.id))\n      .where(eq(audiobookPurchases.userId, userId))\n      .orderBy(desc(audiobookPurchases.createdAt));\n\n    const userInvoices = await db\n      .select()\n      .from(invoices)\n      .where(eq(invoices.userId, userId))\n      .orderBy(desc(invoices.issueDate));\n\n    const [subscription] = await db\n      .select()\n      .from(userSubscriptions)\n      .where(eq(userSubscriptions.userId, userId))\n      .orderBy(desc(userSubscriptions.createdAt))\n      .limit(1);\n\n    const completedPurchases = purchasesData.filter(p => p.purchase.status === \"COMPLETED\");\n    const totalSpentCents = completedPurchases.reduce((sum, p) => sum + p.purchase.pricePaidCents, 0);\n    const lastPurchase = completedPurchases.length > 0 ? completedPurchases[0].purchase.purchasedAt : null;\n\n    return {\n      user,\n      billingProfile: profile || null,\n      purchases: purchasesData.map(p => ({ ...p.purchase, audiobook: p.audiobook })),\n      invoices: userInvoices,\n      subscription: subscription || null,\n      stats: {\n        totalPurchases: completedPurchases.length,\n        totalSpentCents,\n        lastPurchaseAt: lastPurchase,\n      },\n    };\n  }\n\n  async getAllInvoicesAdmin(filters?: { search?: string; status?: string; from?: Date; to?: Date }): Promise<Array<Invoice & { user: User }>> {\n    let conditions: any[] = [];\n\n    if (filters?.status) {\n      conditions.push(eq(invoices.status, filters.status as any));\n    }\n\n    if (filters?.from) {\n      conditions.push(gte(invoices.issueDate, filters.from));\n    }\n\n    if (filters?.to) {\n      conditions.push(lte(invoices.issueDate, filters.to));\n    }\n\n    let invoicesQuery = db\n      .select({\n        invoice: invoices,\n        user: users,\n      })\n      .from(invoices)\n      .innerJoin(users, eq(invoices.userId, users.id));\n    \n    if (conditions.length > 0) {\n      invoicesQuery = invoicesQuery.where(and(...conditions)) as typeof invoicesQuery;\n    }\n    \n    const invoicesData = await invoicesQuery.orderBy(desc(invoices.issueDate));\n\n    let results = invoicesData.map(d => ({ ...d.invoice, user: d.user }));\n\n    if (filters?.search) {\n      const searchLower = filters.search.toLowerCase();\n      results = results.filter(r => \n        r.invoiceNumber.toLowerCase().includes(searchLower) ||\n        r.user.username.toLowerCase().includes(searchLower) ||\n        r.user.email.toLowerCase().includes(searchLower)\n      );\n    }\n\n    return results;\n  }\n\n  // Delete pending purchases older than specified hours\n  async deleteOldPendingPurchases(hoursOld: number = 24): Promise<{ deletedPurchases: number; deletedCartItems: number }> {\n    const cutoffDate = new Date(Date.now() - hoursOld * 60 * 60 * 1000);\n    \n    // Find old pending purchases\n    const oldPendingPurchases = await db\n      .select()\n      .from(audiobookPurchases)\n      .where(\n        and(\n          eq(audiobookPurchases.status, 'PENDING'),\n          lt(audiobookPurchases.createdAt, cutoffDate)\n        )\n      );\n    \n    let deletedPurchases = 0;\n    let deletedCartItems = 0;\n    \n    for (const purchase of oldPendingPurchases) {\n      // Delete associated cart item if exists\n      const deletedCart = await db\n        .delete(cartItems)\n        .where(\n          and(\n            eq(cartItems.userId, purchase.userId),\n            eq(cartItems.audiobookId, purchase.audiobookId)\n          )\n        )\n        .returning();\n      \n      deletedCartItems += deletedCart.length;\n      \n      // Delete the pending purchase\n      await db.delete(audiobookPurchases).where(eq(audiobookPurchases.id, purchase.id));\n      deletedPurchases++;\n    }\n    \n    return { deletedPurchases, deletedCartItems };\n  }\n\n  // Delete a single pending purchase by ID\n  async deletePendingPurchase(purchaseId: string): Promise<boolean> {\n    const [purchase] = await db\n      .select()\n      .from(audiobookPurchases)\n      .where(eq(audiobookPurchases.id, purchaseId));\n    \n    if (!purchase || purchase.status !== 'PENDING') {\n      return false;\n    }\n    \n    // Delete associated cart item if exists\n    await db\n      .delete(cartItems)\n      .where(\n        and(\n          eq(cartItems.userId, purchase.userId),\n          eq(cartItems.audiobookId, purchase.audiobookId)\n        )\n      );\n    \n    // Delete the pending purchase\n    await db.delete(audiobookPurchases).where(eq(audiobookPurchases.id, purchaseId));\n    \n    return true;\n  }\n\n  // Get purchases with filters for admin\n  async getPurchasesAdmin(filters?: {\n    status?: string;\n    userId?: string;\n    search?: string;\n  }): Promise<Array<AudiobookPurchase & { user: User; audiobook: Audiobook }>> {\n    const conditions: any[] = [];\n    \n    if (filters?.status) {\n      conditions.push(eq(audiobookPurchases.status, filters.status as any));\n    }\n    \n    if (filters?.userId) {\n      conditions.push(eq(audiobookPurchases.userId, filters.userId));\n    }\n\n    let query = db\n      .select({\n        purchase: audiobookPurchases,\n        user: users,\n        audiobook: audiobooks,\n      })\n      .from(audiobookPurchases)\n      .innerJoin(users, eq(audiobookPurchases.userId, users.id))\n      .innerJoin(audiobooks, eq(audiobookPurchases.audiobookId, audiobooks.id));\n    \n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as typeof query;\n    }\n    \n    const data = await query.orderBy(desc(audiobookPurchases.createdAt));\n\n    let results = data.map(d => ({\n      ...d.purchase,\n      user: d.user,\n      audiobook: d.audiobook,\n    }));\n\n    if (filters?.search) {\n      const searchLower = filters.search.toLowerCase();\n      results = results.filter(r =>\n        r.user.username.toLowerCase().includes(searchLower) ||\n        r.user.email.toLowerCase().includes(searchLower) ||\n        r.audiobook.title.toLowerCase().includes(searchLower)\n      );\n    }\n\n    return results;\n  }\n\n  // Discount code operations\n  async createDiscountCode(data: InsertDiscountCode): Promise<DiscountCode> {\n    const [code] = await db.insert(discountCodes).values(data).returning();\n    return code;\n  }\n\n  async getDiscountCode(id: string): Promise<DiscountCode | undefined> {\n    const [code] = await db.select().from(discountCodes).where(eq(discountCodes.id, id));\n    return code || undefined;\n  }\n\n  async getDiscountCodeByCode(code: string): Promise<DiscountCode | undefined> {\n    const [discountCode] = await db.select().from(discountCodes).where(eq(discountCodes.code, code.toUpperCase()));\n    return discountCode || undefined;\n  }\n\n  async getAllDiscountCodes(): Promise<DiscountCode[]> {\n    return db.select().from(discountCodes).orderBy(desc(discountCodes.createdAt));\n  }\n\n  async updateDiscountCode(id: string, data: Partial<InsertDiscountCode>): Promise<DiscountCode> {\n    const [updated] = await db\n      .update(discountCodes)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(discountCodes.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteDiscountCode(id: string): Promise<void> {\n    await db.delete(discountCodeUsage).where(eq(discountCodeUsage.discountCodeId, id));\n    await db.delete(discountCodes).where(eq(discountCodes.id, id));\n  }\n\n  async incrementDiscountCodeUsage(id: string): Promise<void> {\n    await db\n      .update(discountCodes)\n      .set({ usedCount: sql`${discountCodes.usedCount} + 1` })\n      .where(eq(discountCodes.id, id));\n  }\n\n  async getUserDiscountCodeUsageCount(discountCodeId: string, userId: string): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(discountCodeUsage)\n      .where(and(\n        eq(discountCodeUsage.discountCodeId, discountCodeId),\n        eq(discountCodeUsage.userId, userId)\n      ));\n    return Number(result[0]?.count || 0);\n  }\n\n  async validateDiscountCode(\n    code: string,\n    userId: string,\n    totalCents: number,\n    forSubscription: boolean\n  ): Promise<{ valid: boolean; discountCode?: DiscountCode; error?: string }> {\n    const discountCode = await this.getDiscountCodeByCode(code);\n    \n    if (!discountCode) {\n      return { valid: false, error: \"Codigo de descuento no encontrado\" };\n    }\n    \n    if (!discountCode.isActive) {\n      return { valid: false, error: \"Este codigo de descuento no esta activo\" };\n    }\n    \n    const now = new Date();\n    if (discountCode.validFrom && now < discountCode.validFrom) {\n      return { valid: false, error: \"Este codigo de descuento aun no es valido\" };\n    }\n    \n    if (discountCode.validUntil && now > discountCode.validUntil) {\n      return { valid: false, error: \"Este codigo de descuento ha expirado\" };\n    }\n    \n    if (discountCode.maxUsesTotal && discountCode.usedCount >= discountCode.maxUsesTotal) {\n      return { valid: false, error: \"Este codigo de descuento ha alcanzado su limite de usos\" };\n    }\n    \n    if (forSubscription && !discountCode.appliesToSubscriptions) {\n      return { valid: false, error: \"Este codigo no aplica a suscripciones\" };\n    }\n    \n    if (!forSubscription && !discountCode.appliesToPurchases) {\n      return { valid: false, error: \"Este codigo no aplica a compras individuales\" };\n    }\n    \n    if (discountCode.minPurchaseCents && totalCents < discountCode.minPurchaseCents) {\n      return { \n        valid: false, \n        error: `El monto minimo de compra es ${(discountCode.minPurchaseCents / 100).toFixed(2)} EUR` \n      };\n    }\n    \n    if (discountCode.maxUsesPerUser) {\n      const userUsageCount = await this.getUserDiscountCodeUsageCount(discountCode.id, userId);\n      if (userUsageCount >= discountCode.maxUsesPerUser) {\n        return { valid: false, error: \"Ya has usado este codigo el numero maximo de veces\" };\n      }\n    }\n    \n    return { valid: true, discountCode };\n  }\n\n  async recordDiscountCodeUsage(\n    discountCodeId: string,\n    userId: string,\n    purchaseId: string | null,\n    discountAmountCents: number\n  ): Promise<DiscountCodeUsage> {\n    const [usage] = await db\n      .insert(discountCodeUsage)\n      .values({\n        discountCodeId,\n        userId,\n        purchaseId,\n        discountAmountCents,\n      })\n      .returning();\n    \n    await this.incrementDiscountCodeUsage(discountCodeId);\n    \n    return usage;\n  }\n\n  // External services operations\n  async getExternalServices(): Promise<ExternalService[]> {\n    return await db\n      .select()\n      .from(externalServices)\n      .where(eq(externalServices.isActive, true))\n      .orderBy(externalServices.sortOrder);\n  }\n\n  async getExternalService(id: string): Promise<ExternalService | undefined> {\n    const [service] = await db\n      .select()\n      .from(externalServices)\n      .where(eq(externalServices.id, id));\n    return service || undefined;\n  }\n\n  async createExternalService(service: InsertExternalService): Promise<ExternalService> {\n    const [created] = await db\n      .insert(externalServices)\n      .values(service)\n      .returning();\n    return created;\n  }\n\n  async updateExternalService(id: string, data: Partial<InsertExternalService>): Promise<ExternalService> {\n    const [updated] = await db\n      .update(externalServices)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(externalServices.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteExternalService(id: string): Promise<void> {\n    await db.delete(externalServices).where(eq(externalServices.id, id));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":92596,"size_tokens":null},"client/src/components/auth-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState, ReactNode } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { User } from \"@shared/schema\";\n\ninterface AuthContextType {\n  user: User | null;\n  isLoading: boolean;\n  isAuthenticated: boolean;\n  login: (email: string, password: string) => Promise<void>;\n  register: (username: string, email: string, password: string, role: \"LISTENER\" | \"CREATOR\") => Promise<void>;\n  logout: () => Promise<void>;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const queryClient = useQueryClient();\n  \n  // Fetch current user\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/me\"],\n    retry: false,\n    // If not authenticated, the query will fail but that's expected\n    meta: { skipErrorToast: true },\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async ({ email, password }: { email: string; password: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/auth/login\", { email, password }, { raw: true });\n      return res.json();\n    },\n    onSuccess: async () => {\n      // Refetch from server to get fresh session data\n      await queryClient.invalidateQueries({ queryKey: [\"/api/auth/me\"] });\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async ({ username, email, password, role }: { username: string; email: string; password: string; role: \"LISTENER\" | \"CREATOR\" }) => {\n      const res = await apiRequest(\"POST\", \"/api/auth/register\", { username, email, password, role }, { raw: true });\n      return res.json();\n    },\n    onSuccess: async () => {\n      // Refetch from server to get fresh session data\n      await queryClient.invalidateQueries({ queryKey: [\"/api/auth/me\"] });\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/auth/logout\", {}, { raw: true });\n      return res.json();\n    },\n    onSuccess: () => {\n      // Only clear auth-related queries, not the entire cache\n      queryClient.removeQueries({ queryKey: [\"/api/auth/me\"] });\n      // Optionally clear other user-specific data\n      queryClient.removeQueries({ predicate: (query) => {\n        // Clear any queries that might be user-specific\n        const key = query.queryKey[0];\n        return typeof key === 'string' && (\n          key.includes('/api/subscriptions') || \n          key.includes('/api/user')\n        );\n      }});\n    },\n  });\n\n  const login = async (email: string, password: string) => {\n    await loginMutation.mutateAsync({ email, password });\n  };\n\n  const register = async (username: string, email: string, password: string, role: \"LISTENER\" | \"CREATOR\") => {\n    await registerMutation.mutateAsync({ username, email, password, role });\n  };\n\n  const logout = async () => {\n    await logoutMutation.mutateAsync();\n  };\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user: user || null,\n        isLoading,\n        isAuthenticated: !!user,\n        login,\n        register,\n        logout,\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":3476,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nexport class ApiError extends Error {\n  status: number;\n  details?: any;\n  [key: string]: any;\n\n  constructor(status: number, message: string, errorData?: any) {\n    super(message);\n    this.name = \"ApiError\";\n    this.status = status;\n    \n    // Preserve all fields from server response verbatim\n    if (errorData) {\n      Object.assign(this, errorData);\n    }\n    \n    // Ensure HTTP status is not overwritten by server payload\n    this.status = status;\n  }\n}\n\n// Simple check that doesn't consume the body - leaves it for apiRequest to handle\nfunction checkResponseOk(res: Response) {\n  if (!res.ok) {\n    return false;\n  }\n  return true;\n}\n\n// Parse error response and create ApiError\nasync function parseErrorResponse(res: Response): Promise<ApiError> {\n  const text = (await res.text()) || res.statusText;\n  \n  try {\n    const errorData = JSON.parse(text);\n    const message = errorData.message || errorData.error || text;\n    return new ApiError(res.status, message, errorData);\n  } catch {\n    // Plain text error\n    return new ApiError(res.status, `${res.status}: ${text}`);\n  }\n}\n\ninterface ApiRequestOptions {\n  raw?: boolean;\n}\n\n// Overload for raw Response mode\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown,\n  options?: { raw: true }\n): Promise<Response>;\n\n// Overload for parsed JSON mode (default)\nexport async function apiRequest<T = any>(\n  method: string,\n  url: string,\n  data?: unknown,\n  options?: { raw?: false }\n): Promise<T>;\n\n// Implementation\nexport async function apiRequest<T = any>(\n  method: string,\n  url: string,\n  data?: unknown,\n  options?: ApiRequestOptions\n): Promise<T | Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  // Check if response is OK\n  if (!checkResponseOk(res)) {\n    // For raw mode, throw after cloning to preserve body\n    if (options?.raw) {\n      const apiError = await parseErrorResponse(res.clone());\n      throw apiError;\n    }\n    // For JSON mode, consume body to create error\n    const apiError = await parseErrorResponse(res);\n    throw apiError;\n  }\n  \n  // Raw mode: return Response as-is (body intact)\n  if (options?.raw) {\n    return res;\n  }\n  \n  // JSON mode: parse and return\n  // Handle 204 No Content\n  if (res.status === 204) {\n    return undefined as T;\n  }\n  \n  // Parse JSON response\n  try {\n    return await res.json() as T;\n  } catch {\n    // Empty body or invalid JSON\n    return undefined as T;\n  }\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    if (!checkResponseOk(res)) {\n      const apiError = await parseErrorResponse(res);\n      throw apiError;\n    }\n    \n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":3518,"size_tokens":null},"client/src/pages/explore.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Search, Heart, Clock, BookOpen, Filter } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Link } from \"wouter\";\nimport type { Audiobook } from \"@shared/schema\";\n\nfunction formatDuration(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  if (hours > 0) {\n    return `${hours}h ${minutes}m`;\n  }\n  return `${minutes}m`;\n}\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\nconst categories = [\n  \"Todos\",\n  \"Fiction\",\n  \"Non-Fiction\",\n  \"Mystery\",\n  \"Romance\",\n  \"Sci-Fi\",\n  \"Biography\",\n  \"Self-Help\",\n  \"Business\",\n  \"History\",\n];\n\nexport default function Explore() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState(\"Todos\");\n  const [priceFilter, setPriceFilter] = useState(\"all\");\n  const { toast } = useToast();\n\n  const { data: audiobooks = [], isLoading } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/audiobooks\"],\n  });\n\n  const { data: userFavorites = [] } = useQuery<Array<{ id: string }>>({\n    queryKey: [\"/api/library/favorites\"],\n  });\n\n  const favoriteIds = new Set(userFavorites.map(f => f.id));\n\n  const filteredAudiobooks = audiobooks.filter((audiobook) => {\n    const query = searchQuery.toLowerCase();\n    const matchesSearch =\n      audiobook.title.toLowerCase().includes(query) ||\n      audiobook.author.toLowerCase().includes(query) ||\n      audiobook.description.toLowerCase().includes(query) ||\n      audiobook.category.toLowerCase().includes(query);\n    \n    const matchesCategory = selectedCategory === \"Todos\" || audiobook.category === selectedCategory;\n    \n    const matchesPrice = \n      priceFilter === \"all\" ||\n      (priceFilter === \"free\" && audiobook.isFree) ||\n      (priceFilter === \"paid\" && !audiobook.isFree);\n\n    return matchesSearch && matchesCategory && matchesPrice;\n  });\n\n  const handleToggleFavorite = async (audiobookId: string) => {\n    const isFav = favoriteIds.has(audiobookId);\n    try {\n      if (isFav) {\n        await apiRequest(\"DELETE\", `/api/audiobooks/${audiobookId}/favorite`);\n        toast({\n          title: \"Eliminado de favoritos\",\n          description: \"El audiolibro se ha eliminado de tus favoritos\",\n        });\n      } else {\n        await apiRequest(\"POST\", `/api/audiobooks/${audiobookId}/favorite`);\n        toast({\n          title: \"Agregado a favoritos\",\n          description: \"El audiolibro se ha agregado a tus favoritos\",\n        });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/library/favorites\"] });\n    } catch (error: any) {\n      if (error.message?.includes(\"401\")) {\n        toast({\n          variant: \"destructive\",\n          title: \"No autenticado\",\n          description: \"Debes iniciar sesion para gestionar favoritos\",\n        });\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Error\",\n          description: \"No se pudo actualizar favoritos\",\n        });\n      }\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"max-w-7xl mx-auto px-6 py-12\">\n          <h1 className=\"font-serif text-4xl font-bold mb-3\" data-testid=\"text-page-title\">\n            Explorar Audiolibros\n          </h1>\n          <p className=\"text-lg text-muted-foreground max-w-2xl\">\n            Descubre tu proxima historia favorita entre miles de audiolibros narrados profesionalmente\n          </p>\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto px-6 py-8\">\n        <div className=\"flex flex-col md:flex-row gap-4 mb-8\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Buscar por titulo, autor...\"\n              className=\"pl-10\"\n              data-testid=\"input-search\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n            />\n          </div>\n          <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n            <SelectTrigger className=\"w-full md:w-48\" data-testid=\"select-category\">\n              <Filter className=\"w-4 h-4 mr-2\" />\n              <SelectValue placeholder=\"Categoria\" />\n            </SelectTrigger>\n            <SelectContent>\n              {categories.map((cat) => (\n                <SelectItem key={cat} value={cat}>\n                  {cat}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={priceFilter} onValueChange={setPriceFilter}>\n            <SelectTrigger className=\"w-full md:w-40\" data-testid=\"select-price\">\n              <SelectValue placeholder=\"Precio\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">Todos</SelectItem>\n              <SelectItem value=\"free\">Gratis</SelectItem>\n              <SelectItem value=\"paid\">De pago</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        {isLoading ? (\n          <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n            {Array.from({ length: 12 }).map((_, i) => (\n              <Card key={i} className=\"overflow-hidden\">\n                <Skeleton className=\"aspect-square\" />\n                <CardContent className=\"p-4 space-y-2\">\n                  <Skeleton className=\"h-5 w-3/4\" />\n                  <Skeleton className=\"h-4 w-1/2\" />\n                  <div className=\"flex justify-between pt-2\">\n                    <Skeleton className=\"h-3 w-16\" />\n                    <Skeleton className=\"h-4 w-12\" />\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : filteredAudiobooks.length === 0 ? (\n          <div className=\"text-center py-16 border border-dashed rounded-lg\">\n            <BookOpen className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n            <p className=\"text-muted-foreground\">\n              {searchQuery || selectedCategory !== \"Todos\" || priceFilter !== \"all\"\n                ? \"No se encontraron audiolibros con esos filtros\"\n                : \"No hay audiolibros disponibles aun\"}\n            </p>\n          </div>\n        ) : (\n          <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n            {filteredAudiobooks.map((audiobook) => (\n              <Card\n                key={audiobook.id}\n                className=\"group overflow-hidden hover-elevate cursor-pointer transition-transform duration-200 hover:scale-[1.02]\"\n                data-testid={`card-audiobook-${audiobook.id}`}\n              >\n                <div className=\"aspect-square relative overflow-hidden\">\n                  <Link href={`/audiobook/${audiobook.id}`} className=\"block w-full h-full\">\n                    {audiobook.coverArtUrl ? (\n                      <img\n                        src={audiobook.coverArtUrl}\n                        alt={audiobook.title}\n                        className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\n                      />\n                    ) : (\n                      <div className=\"w-full h-full bg-gradient-to-br from-primary/30 to-primary/60 flex items-center justify-center\">\n                        <BookOpen className=\"w-12 h-12 text-primary-foreground/60\" />\n                      </div>\n                    )}\n                  </Link>\n                  <div className=\"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none\">\n                    <div className=\"absolute bottom-4 left-4 right-4 pointer-events-auto\">\n                      <Button \n                        size=\"sm\" \n                        variant={favoriteIds.has(audiobook.id) ? \"default\" : \"secondary\"}\n                        className=\"w-full gap-2\"\n                        data-testid={`button-toggle-favorite-${audiobook.id}`}\n                        onClick={() => handleToggleFavorite(audiobook.id)}\n                      >\n                        <Heart className={`w-4 h-4 ${favoriteIds.has(audiobook.id) ? \"fill-current\" : \"\"}`} />\n                        {favoriteIds.has(audiobook.id) ? \"En favoritos\" : \"Agregar a favoritos\"}\n                      </Button>\n                    </div>\n                  </div>\n                  {audiobook.isFree && (\n                    <Badge className=\"absolute top-2 right-2 bg-accent text-accent-foreground\">\n                      Gratis\n                    </Badge>\n                  )}\n                </div>\n                <Link href={`/audiobook/${audiobook.id}`}>\n                  <CardContent className=\"p-4\">\n                    <h3 className=\"font-serif font-semibold text-lg line-clamp-1\">{audiobook.title}</h3>\n                    <p className=\"text-sm text-muted-foreground line-clamp-1\">{audiobook.author}</p>\n                    <div className=\"flex items-center justify-between mt-3\">\n                      <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                        <Clock className=\"w-3 h-3\" />\n                        <span>{formatDuration(audiobook.totalDuration)}</span>\n                      </div>\n                      {!audiobook.isFree && audiobook.priceCents > 0 && (\n                        <span className=\"font-semibold text-primary\">\n                          {formatPrice(audiobook.priceCents, audiobook.currency)}\n                        </span>\n                      )}\n                    </div>\n                  </CardContent>\n                </Link>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10525,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/pages/podcast-detail.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { EpisodeCard } from \"@/components/episode-card\";\nimport { AudioPlayer } from \"@/components/audio-player\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ShareMenu } from \"@/components/ShareMenu\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ArrowLeft, User, Rss, Heart, HeartOff, Plus, Pencil, Users, Search, X } from \"lucide-react\";\nimport { useState, useMemo, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { PodcastWithEpisodesAndUrls, Episode } from \"@shared/schema\";\nimport { useAuth } from \"@/components/auth-provider\";\n\nexport default function PodcastDetail() {\n  const [, params] = useRoute(\"/podcast/:id\");\n  const podcastId = params?.id;\n  const [currentEpisode, setCurrentEpisode] = useState<Episode | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [sortBy, setSortBy] = useState<\"date-desc\" | \"date-asc\" | \"alpha-asc\" | \"alpha-desc\" | \"listened\">(\"date-desc\");\n  const [listenedEpisodes, setListenedEpisodes] = useState<Set<string>>(new Set());\n  const { toast } = useToast();\n  const { user } = useAuth();\n\n  // Get listened episodes from localStorage\n  const getListenedEpisodes = (): Set<string> => {\n    try {\n      const data = localStorage.getItem(\"listened-episodes\");\n      return data ? new Set(JSON.parse(data)) : new Set();\n    } catch {\n      return new Set();\n    }\n  };\n\n  // Load listened episodes on mount and listen for updates\n  useEffect(() => {\n    setListenedEpisodes(getListenedEpisodes());\n\n    const handleEpisodeListened = () => {\n      setListenedEpisodes(getListenedEpisodes());\n    };\n\n    window.addEventListener(\"episode-listened\", handleEpisodeListened);\n    return () => window.removeEventListener(\"episode-listened\", handleEpisodeListened);\n  }, []);\n\n  const { data: podcast, isLoading } = useQuery<PodcastWithEpisodesAndUrls & { isSubscribed?: boolean }>({\n    queryKey: [\"/api/podcasts\", podcastId],\n    enabled: !!podcastId,\n  });\n\n  // Filter and sort episodes\n  const filteredAndSortedEpisodes = useMemo(() => {\n    if (!podcast?.episodes) return [];\n\n    // First, filter by search query\n    let filtered = podcast.episodes.filter((episode) => {\n      if (!searchQuery.trim()) return true;\n      const query = searchQuery.toLowerCase();\n      return (\n        episode.title.toLowerCase().includes(query) ||\n        (episode.notes && episode.notes.toLowerCase().includes(query))\n      );\n    });\n\n    // Then, sort by selected criterion\n    return [...filtered].sort((a, b) => {\n      switch (sortBy) {\n        case \"date-desc\":\n          return new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime();\n        case \"date-asc\":\n          return new Date(a.publishedAt).getTime() - new Date(b.publishedAt).getTime();\n        case \"alpha-asc\":\n          return a.title.localeCompare(b.title);\n        case \"alpha-desc\":\n          return b.title.localeCompare(a.title);\n        case \"listened\":\n          const aListened = listenedEpisodes.has(a.id);\n          const bListened = listenedEpisodes.has(b.id);\n          if (aListened === bListened) {\n            // Same status, sort by date\n            return new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime();\n          }\n          // Not listened first\n          return aListened ? 1 : -1;\n        default:\n          return 0;\n      }\n    });\n  }, [podcast?.episodes, searchQuery, sortBy, listenedEpisodes]);\n\n  const handleSubscribe = async () => {\n    if (!podcastId) return;\n    \n    try {\n      if (podcast?.isSubscribed) {\n        await apiRequest(\"DELETE\", `/api/podcasts/${podcastId}/subscribe`);\n        toast({\n          title: \"Desuscrito\",\n          description: \"Te has desuscrito del podcast\",\n        });\n      } else {\n        await apiRequest(\"POST\", `/api/podcasts/${podcastId}/subscribe`);\n        toast({\n          title: \"Suscrito\",\n          description: \"Te has suscrito al podcast\",\n        });\n      }\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/library\"] });\n    } catch (error: any) {\n      if (error.message?.includes(\"401\")) {\n        toast({\n          variant: \"destructive\",\n          title: \"No autenticado\",\n          description: \"Debes iniciar sesiÃ³n para suscribirte\",\n        });\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Error\",\n          description: \"No se pudo actualizar la suscripciÃ³n\",\n        });\n      }\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen pb-32\">\n        <div className=\"max-w-5xl mx-auto px-6 py-8\">\n          <Skeleton className=\"h-8 w-24 mb-6\" />\n          <div className=\"flex gap-6 mb-8\">\n            <Skeleton className=\"w-48 h-48 rounded-xl\" />\n            <div className=\"flex-1 space-y-4\">\n              <Skeleton className=\"h-10 w-3/4\" />\n              <Skeleton className=\"h-20 w-full\" />\n            </div>\n          </div>\n          <div className=\"space-y-4\">\n            {Array.from({ length: 3 }).map((_, i) => (\n              <Skeleton key={i} className=\"h-32 rounded-lg\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!podcast) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <h2 className=\"text-2xl font-bold mb-2\">Podcast no encontrado</h2>\n          <Link href=\"/\">\n            <Button variant=\"default\">Volver al inicio</Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      {/* Hero Section */}\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"max-w-5xl mx-auto px-6 py-8\">\n          {/* Back Button */}\n          <Link href=\"/\">\n            <Button variant=\"ghost\" className=\"mb-6\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n              Volver\n            </Button>\n          </Link>\n\n          {/* Podcast Header */}\n          <div className=\"flex flex-col md:flex-row gap-6 mb-6\">\n            {podcast.coverArtUrl ? (\n              <img\n                src={podcast.coverArtUrl}\n                alt={podcast.title}\n                className=\"w-full md:w-48 h-48 rounded-xl object-cover flex-shrink-0\"\n                data-testid=\"img-podcast-cover\"\n              />\n            ) : (\n              <div className=\"w-full md:w-48 h-48 rounded-xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center flex-shrink-0\">\n                <User className=\"h-20 w-20 text-primary/40\" />\n              </div>\n            )}\n\n            <div className=\"flex-1\">\n              <div className=\"flex items-start justify-between gap-4 mb-3\">\n                <h1 className=\"text-4xl font-bold font-[Outfit]\" data-testid=\"text-podcast-title\">\n                  {podcast.title}\n                </h1>\n                <div className=\"flex items-center gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"icon\"\n                    asChild\n                    data-testid=\"button-rss-feed\"\n                    title=\"Feed RSS\"\n                  >\n                    <a \n                      href={`/api/podcasts/${podcastId}/rss`} \n                      target=\"_blank\" \n                      rel=\"noopener noreferrer\"\n                    >\n                      <Rss className=\"h-4 w-4\" />\n                    </a>\n                  </Button>\n                  <ShareMenu \n                    episodeTitle={podcast.title}\n                    episodeUrl={`${window.location.origin}/podcast/${podcastId}`}\n                    embedCode=\"\"\n                    isPodcast={true}\n                    rssUrl={`${window.location.origin}/api/podcasts/${podcastId}/rss`}\n                  />\n                </div>\n              </div>\n              <p className=\"text-muted-foreground leading-relaxed mb-4\">\n                {podcast.description}\n              </p>\n              <div className=\"flex items-center gap-4 text-sm text-muted-foreground mb-4\">\n                <span data-testid=\"text-episode-count\">\n                  {podcast.episodes?.length || 0} episodios\n                </span>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant={podcast.isSubscribed ? \"secondary\" : \"default\"}\n                  onClick={handleSubscribe}\n                  data-testid=\"button-subscribe\"\n                  className=\"gap-2\"\n                >\n                  {podcast.isSubscribed ? (\n                    <>\n                      <HeartOff className=\"h-4 w-4\" />\n                      Desuscribirse\n                    </>\n                  ) : (\n                    <>\n                      <Heart className=\"h-4 w-4\" />\n                      Suscribirse\n                    </>\n                  )}\n                </Button>\n                {user && (user.id === podcast.ownerId || user.role === \"ADMIN\") && (\n                  <Link href={`/edit-podcast/${podcastId}`}>\n                    <Button variant=\"outline\" data-testid=\"button-edit-podcast\" className=\"gap-2\">\n                      <Pencil className=\"h-4 w-4\" />\n                      Editar\n                    </Button>\n                  </Link>\n                )}\n                {user && user.id === podcast.ownerId && (podcast.visibility === \"UNLISTED\" || podcast.visibility === \"PRIVATE\") && (\n                  <Link href={`/manage-invitations/podcast/${podcastId}`}>\n                    <Button variant=\"outline\" data-testid=\"button-manage-invitations\" className=\"gap-2\">\n                      <Users className=\"h-4 w-4\" />\n                      Gestionar Invitaciones\n                    </Button>\n                  </Link>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"max-w-5xl mx-auto px-6 py-8\">\n        {/* Episodes List */}\n        <div>\n          <div className=\"flex items-center justify-between mb-6\">\n            <h2 className=\"text-2xl font-bold font-[Outfit]\">Episodios</h2>\n            {user && (user.role === \"ADMIN\" || user.id === podcast.ownerId) && (\n              <Link href={`/podcast/${podcastId}/add-episode`}>\n                <Button data-testid=\"button-add-episode\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  AÃ±adir Episodio\n                </Button>\n              </Link>\n            )}\n          </div>\n\n          {/* Search and Filters */}\n          {podcast.episodes && podcast.episodes.length > 0 && (\n            <div className=\"flex flex-col md:flex-row gap-3 mb-6\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n                <Input\n                  placeholder=\"Buscar episodios...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9 pr-9\"\n                  data-testid=\"input-search-episodes\"\n                />\n                {searchQuery && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7\"\n                    onClick={() => setSearchQuery(\"\")}\n                    aria-label=\"Limpiar bÃºsqueda\"\n                    data-testid=\"button-clear-search-inline\"\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                )}\n              </div>\n              <Select value={sortBy} onValueChange={(value: any) => setSortBy(value)}>\n                <SelectTrigger className=\"w-full md:w-[220px]\" data-testid=\"select-sort-episodes\">\n                  <SelectValue placeholder=\"Ordenar por...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"date-desc\">MÃ¡s recientes primero</SelectItem>\n                  <SelectItem value=\"date-asc\">MÃ¡s antiguos primero</SelectItem>\n                  <SelectItem value=\"alpha-asc\">A-Z</SelectItem>\n                  <SelectItem value=\"alpha-desc\">Z-A</SelectItem>\n                  <SelectItem value=\"listened\">No escuchados primero</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          )}\n          {podcast.episodes && podcast.episodes.length > 0 ? (\n            filteredAndSortedEpisodes.length > 0 ? (\n              <div className=\"space-y-4\">\n                {filteredAndSortedEpisodes.map((episode) => (\n                  <EpisodeCard\n                    key={episode.id}\n                    episode={episode}\n                    podcastTitle={podcast.title}\n                    podcastCover={podcast.coverArtUrl || undefined}\n                    onPlay={() => setCurrentEpisode(episode)}\n                  />\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-center py-12 border border-dashed rounded-lg\">\n                <p className=\"text-muted-foreground\">\n                  No se encontraron episodios que coincidan con tu bÃºsqueda.\n                </p>\n                {searchQuery && (\n                  <Button\n                    variant=\"outline\"\n                    className=\"mt-4\"\n                    onClick={() => setSearchQuery(\"\")}\n                    data-testid=\"button-clear-search\"\n                  >\n                    Limpiar bÃºsqueda\n                  </Button>\n                )}\n              </div>\n            )\n          ) : (\n            <div className=\"text-center py-12 border border-dashed rounded-lg\">\n              <p className=\"text-muted-foreground\">\n                Este podcast aÃºn no tiene episodios.\n              </p>\n              {user && (user.role === \"ADMIN\" || user.id === podcast.ownerId) && (\n                <Link href={`/podcast/${podcastId}/add-episode`}>\n                  <Button className=\"mt-4\" data-testid=\"button-add-first-episode\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    AÃ±adir Primer Episodio\n                  </Button>\n                </Link>\n              )}\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Fixed Audio Player */}\n      {currentEpisode && (\n        <AudioPlayer\n          episode={currentEpisode}\n          podcastTitle={podcast.title}\n          podcastCover={podcast.coverArtUrl || undefined}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14954,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":483,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, pgEnum, timestamp, integer, boolean } from \"drizzle-orm/pg-core\";\nimport { relations } from \"drizzle-orm\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// User role enum: LISTENER, PUBLISHER, or ADMIN\nexport const userRoleEnum = pgEnum(\"user_role\", [\"LISTENER\", \"CREATOR\", \"ADMIN\"]);\n\n// Content status enum for moderation workflow\nexport const contentStatusEnum = pgEnum(\"content_status\", [\"DRAFT\", \"PENDING_APPROVAL\", \"APPROVED\", \"REJECTED\"]);\n\n// Media asset type enum\nexport const mediaAssetTypeEnum = pgEnum(\"media_asset_type\", [\"COVER_ART\", \"CHAPTER_AUDIO\", \"SAMPLE_AUDIO\"]);\n\n// Storage provider enum\nexport const storageProviderEnum = pgEnum(\"storage_provider\", [\"LOCAL\", \"GOOGLE_DRIVE\"]);\n\n// Visibility enum for audiobooks and chapters\nexport const visibilityEnum = pgEnum(\"visibility\", [\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]);\n\n// Subscription status enum\nexport const subscriptionStatusEnum = pgEnum(\"subscription_status\", [\"ACTIVE\", \"PAST_DUE\", \"CANCELED\", \"EXPIRED\"]);\n\n// Purchase status enum\nexport const purchaseStatusEnum = pgEnum(\"purchase_status\", [\"PENDING\", \"COMPLETED\", \"REFUNDED\", \"FAILED\"]);\n\n// Users table\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  email: text(\"email\").notNull().unique(),\n  passwordHash: text(\"password_hash\").notNull(),\n  role: userRoleEnum(\"role\").notNull().default(\"LISTENER\"),\n  bio: text(\"bio\"),\n  avatarUrl: text(\"avatar_url\"),\n  website: text(\"website\"),\n  requiresApproval: boolean(\"requires_approval\").notNull().default(false),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  emailVerified: boolean(\"email_verified\").notNull().default(false),\n  emailVerificationToken: text(\"email_verification_token\"),\n  emailVerificationTokenExpiresAt: timestamp(\"email_verification_token_expires_at\"),\n  stripeCustomerId: text(\"stripe_customer_id\"),\n  paypalPayerId: text(\"paypal_payer_id\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Subscription Plans table - admin-defined subscription tiers\nexport const subscriptionPlans = pgTable(\"subscription_plans\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  priceCents: integer(\"price_cents\").notNull(),\n  currency: text(\"currency\").notNull().default(\"EUR\"),\n  intervalMonths: integer(\"interval_months\").notNull().default(1),\n  trialDays: integer(\"trial_days\").notNull().default(0),\n  stripePriceId: text(\"stripe_price_id\"),\n  stripeProductId: text(\"stripe_product_id\"),\n  paypalPlanId: text(\"paypal_plan_id\"),\n  paypalProductId: text(\"paypal_product_id\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// User Subscriptions table - tracks user subscription status\nexport const userSubscriptions = pgTable(\"user_subscriptions\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  planId: varchar(\"plan_id\", { length: 36 }).notNull().references(() => subscriptionPlans.id),\n  status: subscriptionStatusEnum(\"status\").notNull().default(\"ACTIVE\"),\n  stripeSubscriptionId: text(\"stripe_subscription_id\"),\n  paypalSubscriptionId: text(\"paypal_subscription_id\"),\n  currentPeriodStart: timestamp(\"current_period_start\").notNull(),\n  currentPeriodEnd: timestamp(\"current_period_end\").notNull(),\n  canceledAt: timestamp(\"canceled_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Audiobooks table (formerly podcasts)\nexport const audiobooks = pgTable(\"audiobooks\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  author: text(\"author\").notNull(),\n  narrator: text(\"narrator\"),\n  description: text(\"description\").notNull(),\n  coverArtUrl: text(\"cover_art_url\"),\n  coverArtAssetId: varchar(\"cover_art_asset_id\", { length: 36 }),\n  category: text(\"category\").notNull().default(\"Fiction\"),\n  language: text(\"language\").notNull().default(\"es\"),\n  priceCents: integer(\"price_cents\").notNull().default(0),\n  currency: text(\"currency\").notNull().default(\"EUR\"),\n  isFree: boolean(\"is_free\").notNull().default(false),\n  sampleChapterId: varchar(\"sample_chapter_id\", { length: 36 }),\n  totalDuration: integer(\"total_duration\").notNull().default(0),\n  status: contentStatusEnum(\"status\").notNull().default(\"APPROVED\"),\n  visibility: visibilityEnum(\"visibility\").notNull().default(\"PUBLIC\"),\n  stripeProductId: text(\"stripe_product_id\"),\n  stripePriceId: text(\"stripe_price_id\"),\n  amazonEbookUrl: text(\"amazon_ebook_url\"),\n  amazonPrintUrl: text(\"amazon_print_url\"),\n  publisherId: varchar(\"publisher_id\", { length: 36 }).notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  publishedAt: timestamp(\"published_at\"),\n  approvedAt: timestamp(\"approved_at\"),\n  approvedBy: varchar(\"approved_by\", { length: 36 }).references(() => users.id),\n});\n\n// Chapters table (formerly episodes)\nexport const chapters = pgTable(\"chapters\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  chapterNumber: integer(\"chapter_number\").notNull().default(1),\n  description: text(\"description\"),\n  coverArtUrl: text(\"cover_art_url\"),\n  coverArtAssetId: varchar(\"cover_art_asset_id\", { length: 36 }),\n  audioUrl: text(\"audio_url\"),\n  audioAssetId: varchar(\"audio_asset_id\", { length: 36 }),\n  audioFileSize: integer(\"audio_file_size\"),\n  duration: integer(\"duration\").notNull().default(0),\n  isSample: boolean(\"is_sample\").notNull().default(false),\n  status: contentStatusEnum(\"status\").notNull().default(\"APPROVED\"),\n  visibility: visibilityEnum(\"visibility\").notNull().default(\"PUBLIC\"),\n  audiobookId: varchar(\"audiobook_id\", { length: 36 }).notNull().references(() => audiobooks.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  approvedAt: timestamp(\"approved_at\"),\n  approvedBy: varchar(\"approved_by\", { length: 36 }).references(() => users.id),\n});\n\n// Audiobook Purchases table - individual audiobook purchases\nexport const audiobookPurchases = pgTable(\"audiobook_purchases\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  audiobookId: varchar(\"audiobook_id\", { length: 36 }).notNull().references(() => audiobooks.id),\n  pricePaidCents: integer(\"price_paid_cents\").notNull(),\n  currency: text(\"currency\").notNull().default(\"EUR\"),\n  status: purchaseStatusEnum(\"status\").notNull().default(\"PENDING\"),\n  stripePaymentIntentId: text(\"stripe_payment_intent_id\"),\n  stripeSessionId: text(\"stripe_session_id\"),\n  paypalOrderId: text(\"paypal_order_id\"),\n  paypalCaptureId: text(\"paypal_capture_id\"),\n  paypalPayerEmail: text(\"paypal_payer_email\"),\n  purchasedAt: timestamp(\"purchased_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Favorites table - users can favorite audiobooks\nexport const favorites = pgTable(\"favorites\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  audiobookId: varchar(\"audiobook_id\", { length: 36 }).notNull().references(() => audiobooks.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userAudiobookUnique: {\n    columns: [table.userId, table.audiobookId],\n    name: \"favorites_user_audiobook_unique\"\n  }\n}));\n\n// Listening Progress table - tracks user progress in audiobooks\nexport const listeningProgress = pgTable(\"listening_progress\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  audiobookId: varchar(\"audiobook_id\", { length: 36 }).notNull().references(() => audiobooks.id),\n  chapterId: varchar(\"chapter_id\", { length: 36 }).notNull().references(() => chapters.id),\n  positionSeconds: integer(\"position_seconds\").notNull().default(0),\n  completed: boolean(\"completed\").notNull().default(false),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Password reset tokens table\nexport const passwordResetTokens = pgTable(\"password_reset_tokens\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  token: text(\"token\").notNull().unique(),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  usedAt: timestamp(\"used_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Playlists table - user-created playlists\nexport const playlists = pgTable(\"playlists\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  isPublic: boolean(\"is_public\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Playlist Chapters table - many-to-many relationship between playlists and chapters\nexport const playlistChapters = pgTable(\"playlist_chapters\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  playlistId: varchar(\"playlist_id\", { length: 36 }).notNull().references(() => playlists.id, { onDelete: \"cascade\" }),\n  chapterId: varchar(\"chapter_id\", { length: 36 }).notNull().references(() => chapters.id, { onDelete: \"cascade\" }),\n  position: integer(\"position\").notNull().default(0),\n  addedAt: timestamp(\"added_at\").notNull().defaultNow(),\n}, (table) => ({\n  playlistChapterUnique: {\n    columns: [table.playlistId, table.chapterId],\n    name: \"playlist_chapters_playlist_chapter_unique\"\n  }\n}));\n\n// Email configuration table - admin configures SMTP settings\nexport const emailConfig = pgTable(\"email_config\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  smtpHost: text(\"smtp_host\").notNull(),\n  smtpPort: integer(\"smtp_port\").notNull().default(587),\n  smtpSecure: boolean(\"smtp_secure\").notNull().default(false),\n  smtpUser: text(\"smtp_user\").notNull(),\n  smtpPassword: text(\"smtp_password\").notNull(),\n  fromEmail: text(\"from_email\").notNull(),\n  fromName: text(\"from_name\").notNull().default(\"Audivia\"),\n  isActive: boolean(\"is_active\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Google Drive configuration table - admin configures Google Drive integration\nexport const driveConfig = pgTable(\"drive_config\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  serviceAccountEmail: text(\"service_account_email\").notNull(),\n  serviceAccountKey: text(\"service_account_key\").notNull(),\n  folderIdImages: text(\"folder_id_images\").notNull(),\n  folderIdAudio: text(\"folder_id_audio\").notNull(),\n  isActive: boolean(\"is_active\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Media assets table - stores all uploaded files\nexport const mediaAssets = pgTable(\"media_assets\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  ownerId: varchar(\"owner_id\", { length: 36 }).notNull().references(() => users.id),\n  audiobookId: varchar(\"audiobook_id\", { length: 36 }).references(() => audiobooks.id),\n  chapterId: varchar(\"chapter_id\", { length: 36 }).references(() => chapters.id),\n  type: mediaAssetTypeEnum(\"type\").notNull(),\n  storageProvider: storageProviderEnum(\"storage_provider\").notNull().default(\"LOCAL\"),\n  storageKey: text(\"storage_key\").notNull(),\n  publicUrl: text(\"public_url\"),\n  mimeType: text(\"mime_type\").notNull(),\n  sizeBytes: integer(\"size_bytes\").notNull(),\n  checksum: text(\"checksum\"),\n  visibility: text(\"visibility\").notNull().default(\"public\"),\n  status: contentStatusEnum(\"status\").notNull().default(\"APPROVED\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Sessions table for express-session with connect-pg-simple\nexport const sessions = pgTable(\"session\", {\n  sid: varchar(\"sid\").primaryKey(),\n  sess: text(\"sess\").notNull(),\n  expire: timestamp(\"expire\").notNull(),\n});\n\n// Stripe configuration table\nexport const stripeConfig = pgTable(\"stripe_config\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  publishableKey: text(\"publishable_key\"),\n  webhookSecret: text(\"webhook_secret\"),\n  isActive: boolean(\"is_active\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// PayPal configuration table\nexport const paypalConfig = pgTable(\"paypal_config\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  clientId: text(\"client_id\").notNull(),\n  webhookId: text(\"webhook_id\"),\n  environment: text(\"environment\").notNull().default(\"sandbox\"),\n  isActive: boolean(\"is_active\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Invoice type enum\nexport const invoiceTypeEnum = pgEnum(\"invoice_type\", [\"PURCHASE\", \"SUBSCRIPTION\"]);\n\n// Invoice status enum\nexport const invoiceStatusEnum = pgEnum(\"invoice_status\", [\"DRAFT\", \"ISSUED\", \"PAID\", \"CANCELLED\"]);\n\n// Billing profiles table - stores user billing information\nexport const billingProfiles = pgTable(\"billing_profiles\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id).unique(),\n  legalName: text(\"legal_name\").notNull(),\n  companyName: text(\"company_name\"),\n  taxId: text(\"tax_id\"),\n  addressLine1: text(\"address_line_1\").notNull(),\n  addressLine2: text(\"address_line_2\"),\n  city: text(\"city\").notNull(),\n  state: text(\"state\"),\n  postalCode: text(\"postal_code\").notNull(),\n  country: text(\"country\").notNull(),\n  phone: text(\"phone\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Invoices table - stores all issued invoices\nexport const invoices = pgTable(\"invoices\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  invoiceNumber: text(\"invoice_number\").notNull().unique(),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  purchaseId: varchar(\"purchase_id\", { length: 36 }).references(() => audiobookPurchases.id),\n  subscriptionId: varchar(\"subscription_id\", { length: 36 }).references(() => userSubscriptions.id),\n  type: invoiceTypeEnum(\"type\").notNull(),\n  status: invoiceStatusEnum(\"status\").notNull().default(\"ISSUED\"),\n  issueDate: timestamp(\"issue_date\").notNull().defaultNow(),\n  dueDate: timestamp(\"due_date\").notNull().defaultNow(),\n  subtotalCents: integer(\"subtotal_cents\").notNull(),\n  taxCents: integer(\"tax_cents\").notNull().default(0),\n  taxRate: integer(\"tax_rate\").notNull().default(0),\n  totalCents: integer(\"total_cents\").notNull(),\n  currency: text(\"currency\").notNull().default(\"EUR\"),\n  billingSnapshot: text(\"billing_snapshot\"),\n  sellerInfo: text(\"seller_info\"),\n  paymentMethod: text(\"payment_method\").notNull().default(\"paypal\"),\n  pdfPath: text(\"pdf_path\"),\n  pdfStatus: text(\"pdf_status\").notNull().default(\"PENDING\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Invoice line items table\nexport const invoiceLineItems = pgTable(\"invoice_line_items\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  invoiceId: varchar(\"invoice_id\", { length: 36 }).notNull().references(() => invoices.id),\n  description: text(\"description\").notNull(),\n  quantity: integer(\"quantity\").notNull().default(1),\n  unitPriceCents: integer(\"unit_price_cents\").notNull(),\n  taxRate: integer(\"tax_rate\").notNull().default(0),\n  totalCents: integer(\"total_cents\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Discount codes table\nexport const discountCodeTypeEnum = pgEnum(\"discount_code_type\", [\"PERCENTAGE\", \"FIXED_AMOUNT\"]);\n\nexport const discountCodes = pgTable(\"discount_codes\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  code: text(\"code\").notNull().unique(),\n  description: text(\"description\"),\n  type: discountCodeTypeEnum(\"type\").notNull(),\n  value: integer(\"value\").notNull(),\n  minPurchaseCents: integer(\"min_purchase_cents\").default(0),\n  maxUsesTotal: integer(\"max_uses_total\"),\n  maxUsesPerUser: integer(\"max_uses_per_user\").default(1),\n  usedCount: integer(\"used_count\").notNull().default(0),\n  validFrom: timestamp(\"valid_from\"),\n  validUntil: timestamp(\"valid_until\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  appliesToSubscriptions: boolean(\"applies_to_subscriptions\").notNull().default(false),\n  appliesToPurchases: boolean(\"applies_to_purchases\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Track discount code usage per user\nexport const discountCodeUsage = pgTable(\"discount_code_usage\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  discountCodeId: varchar(\"discount_code_id\", { length: 36 }).notNull().references(() => discountCodes.id),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  purchaseId: varchar(\"purchase_id\", { length: 36 }).references(() => audiobookPurchases.id),\n  discountAmountCents: integer(\"discount_amount_cents\").notNull(),\n  usedAt: timestamp(\"used_at\").notNull().defaultNow(),\n});\n\n// External services table - quick links to external services for admin\nexport const externalServices = pgTable(\"external_services\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  url: text(\"url\").notNull(),\n  iconName: text(\"icon_name\").default(\"ExternalLink\"),\n  sortOrder: integer(\"sort_order\").notNull().default(0),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const insertExternalServiceSchema = createInsertSchema(externalServices).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertExternalService = z.infer<typeof insertExternalServiceSchema>;\nexport type ExternalService = typeof externalServices.$inferSelect;\n\n// RSS Feed tokens table - allows users to subscribe to their library via podcast apps\nexport const rssFeedTokens = pgTable(\"rss_feed_tokens\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id).unique(),\n  token: text(\"token\").notNull().unique(),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  lastAccessedAt: timestamp(\"last_accessed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Shopping cart items table - stores items in user's shopping cart\nexport const cartItems = pgTable(\"cart_items\", {\n  id: varchar(\"id\", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\", { length: 36 }).notNull().references(() => users.id),\n  audiobookId: varchar(\"audiobook_id\", { length: 36 }).notNull().references(() => audiobooks.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userAudiobookUnique: {\n    columns: [table.userId, table.audiobookId],\n    name: \"cart_items_user_audiobook_unique\"\n  }\n}));\n\n// Relations\nexport const usersRelations = relations(users, ({ many }) => ({\n  audiobooks: many(audiobooks),\n  purchases: many(audiobookPurchases),\n  subscriptions: many(userSubscriptions),\n  favorites: many(favorites),\n  listeningProgress: many(listeningProgress),\n}));\n\nexport const audiobooksRelations = relations(audiobooks, ({ one, many }) => ({\n  publisher: one(users, {\n    fields: [audiobooks.publisherId],\n    references: [users.id],\n  }),\n  chapters: many(chapters),\n  purchases: many(audiobookPurchases),\n  favorites: many(favorites),\n}));\n\nexport const chaptersRelations = relations(chapters, ({ one }) => ({\n  audiobook: one(audiobooks, {\n    fields: [chapters.audiobookId],\n    references: [audiobooks.id],\n  }),\n}));\n\nexport const favoritesRelations = relations(favorites, ({ one }) => ({\n  user: one(users, {\n    fields: [favorites.userId],\n    references: [users.id],\n  }),\n  audiobook: one(audiobooks, {\n    fields: [favorites.audiobookId],\n    references: [audiobooks.id],\n  }),\n}));\n\nexport const audiobookPurchasesRelations = relations(audiobookPurchases, ({ one }) => ({\n  user: one(users, {\n    fields: [audiobookPurchases.userId],\n    references: [users.id],\n  }),\n  audiobook: one(audiobooks, {\n    fields: [audiobookPurchases.audiobookId],\n    references: [audiobooks.id],\n  }),\n}));\n\nexport const userSubscriptionsRelations = relations(userSubscriptions, ({ one }) => ({\n  user: one(users, {\n    fields: [userSubscriptions.userId],\n    references: [users.id],\n  }),\n  plan: one(subscriptionPlans, {\n    fields: [userSubscriptions.planId],\n    references: [subscriptionPlans.id],\n  }),\n}));\n\nexport const listeningProgressRelations = relations(listeningProgress, ({ one }) => ({\n  user: one(users, {\n    fields: [listeningProgress.userId],\n    references: [users.id],\n  }),\n  audiobook: one(audiobooks, {\n    fields: [listeningProgress.audiobookId],\n    references: [audiobooks.id],\n  }),\n  chapter: one(chapters, {\n    fields: [listeningProgress.chapterId],\n    references: [chapters.id],\n  }),\n}));\n\nexport const mediaAssetsRelations = relations(mediaAssets, ({ one }) => ({\n  owner: one(users, {\n    fields: [mediaAssets.ownerId],\n    references: [users.id],\n  }),\n  audiobook: one(audiobooks, {\n    fields: [mediaAssets.audiobookId],\n    references: [audiobooks.id],\n  }),\n  chapter: one(chapters, {\n    fields: [mediaAssets.chapterId],\n    references: [chapters.id],\n  }),\n}));\n\nexport const playlistsRelations = relations(playlists, ({ one, many }) => ({\n  user: one(users, {\n    fields: [playlists.userId],\n    references: [users.id],\n  }),\n  playlistChapters: many(playlistChapters),\n}));\n\nexport const playlistChaptersRelations = relations(playlistChapters, ({ one }) => ({\n  playlist: one(playlists, {\n    fields: [playlistChapters.playlistId],\n    references: [playlists.id],\n  }),\n  chapter: one(chapters, {\n    fields: [playlistChapters.chapterId],\n    references: [chapters.id],\n  }),\n}));\n\n// Zod schemas for inserts\nexport const insertUserSchema = createInsertSchema(users)\n  .omit({ id: true, createdAt: true, passwordHash: true })\n  .extend({\n    password: z.string().min(8, \"Password must be at least 8 characters\"),\n    bio: z.string().optional(),\n    avatarUrl: z.union([z.string().url(), z.literal(\"\"), z.null()]).optional(),\n    website: z.union([z.string().url(), z.literal(\"\"), z.null()]).optional(),\n  });\n\nexport const insertAudiobookSchema = createInsertSchema(audiobooks)\n  .omit({ id: true, createdAt: true, coverArtUrl: true, publisherId: true, status: true, approvedAt: true, approvedBy: true, stripeProductId: true, stripePriceId: true, totalDuration: true, publishedAt: true, sampleChapterId: true, coverArtAssetId: true })\n  .extend({\n    coverArtUrl: z.union([z.string().url(), z.string().startsWith(\"/\"), z.literal(\"\"), z.null()]).optional(),\n    narrator: z.string().optional().nullable(),\n    category: z.string().min(1).default(\"Fiction\"),\n    language: z.string().min(2).default(\"es\"),\n    priceCents: z.number().int().min(0).default(0),\n    currency: z.string().default(\"EUR\"),\n    isFree: z.boolean().default(false),\n    visibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]).default(\"PUBLIC\"),\n    totalDuration: z.number().int().min(0).default(0),\n  });\n\nexport const insertChapterSchema = createInsertSchema(chapters)\n  .omit({ id: true, audioFileSize: true, coverArtUrl: true, coverArtAssetId: true, audioUrl: true, audioAssetId: true, status: true, approvedAt: true, approvedBy: true, createdAt: true })\n  .extend({\n    title: z.string().min(1, \"Title is required\"),\n    chapterNumber: z.number().int().min(1).default(1),\n    description: z.string().optional().nullable(),\n    duration: z.number().int().min(0).default(0),\n    coverArtUrl: z.union([z.string().url(), z.string().startsWith(\"/\"), z.literal(\"\"), z.null()]).optional(),\n    coverArtAssetId: z.string().uuid().optional().nullable(),\n    audioUrl: z.union([z.string().url(), z.string().startsWith(\"/\"), z.literal(\"\"), z.null()]).optional(),\n    audioAssetId: z.string().uuid().optional().nullable(),\n    audioFileSize: z.number().int().positive().optional(),\n    isSample: z.boolean().default(false),\n    visibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]).default(\"PUBLIC\"),\n  });\n\nexport const insertPasswordResetTokenSchema = createInsertSchema(passwordResetTokens)\n  .omit({ id: true, createdAt: true, usedAt: true });\n\nexport const insertEmailConfigSchema = createInsertSchema(emailConfig)\n  .omit({ id: true, createdAt: true, updatedAt: true })\n  .extend({\n    smtpHost: z.string().min(1, \"SMTP host is required\"),\n    smtpPort: z.number().int().min(1).max(65535).default(587),\n    smtpUser: z.string().min(1, \"SMTP user is required\"),\n    smtpPassword: z.string().min(1, \"SMTP password is required\"),\n    fromEmail: z.string().email(\"Invalid email address\"),\n    fromName: z.string().min(1).default(\"Audivia\"),\n  });\n\nexport const insertDriveConfigSchema = createInsertSchema(driveConfig)\n  .omit({ id: true, createdAt: true, updatedAt: true })\n  .extend({\n    serviceAccountEmail: z.string().email(\"Invalid email address\"),\n    serviceAccountKey: z.string().min(1, \"Service account key is required\"),\n    folderIdImages: z.string().min(1, \"Images folder ID is required\"),\n    folderIdAudio: z.string().min(1, \"Audio folder ID is required\"),\n  });\n\nexport const insertMediaAssetSchema = createInsertSchema(mediaAssets)\n  .omit({ id: true, createdAt: true, publicUrl: true });\n\nexport const insertPlaylistSchema = createInsertSchema(playlists)\n  .omit({ id: true, createdAt: true, updatedAt: true, userId: true })\n  .extend({\n    name: z.string().min(1, \"Playlist name is required\").max(200, \"Playlist name is too long\"),\n    description: z.string().max(1000, \"Description is too long\").optional(),\n    isPublic: z.boolean().default(false),\n  });\n\nexport const insertPlaylistChapterSchema = createInsertSchema(playlistChapters)\n  .omit({ id: true, addedAt: true })\n  .extend({\n    playlistId: z.string().uuid(\"Invalid playlist ID\"),\n    chapterId: z.string().uuid(\"Invalid chapter ID\"),\n    position: z.number().int().min(0).default(0),\n  });\n\nexport const insertSubscriptionPlanSchema = createInsertSchema(subscriptionPlans)\n  .omit({ id: true, createdAt: true, stripeProductId: true, stripePriceId: true })\n  .extend({\n    name: z.string().min(1, \"Plan name is required\"),\n    description: z.string().optional().nullable(),\n    priceCents: z.number().int().min(0),\n    currency: z.string().default(\"EUR\"),\n    intervalMonths: z.number().int().min(1).default(1),\n    isActive: z.boolean().default(true),\n  });\n\nexport const insertAudiobookPurchaseSchema = createInsertSchema(audiobookPurchases)\n  .omit({ id: true, createdAt: true, purchasedAt: true });\n\n// Auth schemas\nexport const loginSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\nexport const registerSchema = insertUserSchema;\n\n// TypeScript types\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type Audiobook = typeof audiobooks.$inferSelect;\nexport type InsertAudiobook = z.infer<typeof insertAudiobookSchema>;\nexport type Chapter = typeof chapters.$inferSelect;\nexport type InsertChapter = z.infer<typeof insertChapterSchema>;\nexport type PasswordResetToken = typeof passwordResetTokens.$inferSelect;\nexport type InsertPasswordResetToken = z.infer<typeof insertPasswordResetTokenSchema>;\nexport type EmailConfig = typeof emailConfig.$inferSelect;\nexport type InsertEmailConfig = z.infer<typeof insertEmailConfigSchema>;\nexport type DriveConfig = typeof driveConfig.$inferSelect;\nexport type InsertDriveConfig = z.infer<typeof insertDriveConfigSchema>;\nexport type MediaAsset = typeof mediaAssets.$inferSelect;\nexport type InsertMediaAsset = z.infer<typeof insertMediaAssetSchema>;\nexport type Playlist = typeof playlists.$inferSelect;\nexport type InsertPlaylist = z.infer<typeof insertPlaylistSchema>;\nexport type PlaylistChapter = typeof playlistChapters.$inferSelect;\nexport type InsertPlaylistChapter = z.infer<typeof insertPlaylistChapterSchema>;\nexport type SubscriptionPlan = typeof subscriptionPlans.$inferSelect;\nexport type InsertSubscriptionPlan = z.infer<typeof insertSubscriptionPlanSchema>;\nexport type UserSubscription = typeof userSubscriptions.$inferSelect;\nexport type AudiobookPurchase = typeof audiobookPurchases.$inferSelect;\nexport type InsertAudiobookPurchase = z.infer<typeof insertAudiobookPurchaseSchema>;\nexport type Favorite = typeof favorites.$inferSelect;\nexport type ListeningProgress = typeof listeningProgress.$inferSelect;\nexport type StripeConfig = typeof stripeConfig.$inferSelect;\nexport type PaypalConfig = typeof paypalConfig.$inferSelect;\n\n// Billing profile types\nexport const insertBillingProfileSchema = createInsertSchema(billingProfiles).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertBillingProfile = z.infer<typeof insertBillingProfileSchema>;\nexport type BillingProfile = typeof billingProfiles.$inferSelect;\n\n// Invoice types\nexport const insertInvoiceSchema = createInsertSchema(invoices).omit({ id: true, createdAt: true });\nexport type InsertInvoice = z.infer<typeof insertInvoiceSchema>;\nexport type Invoice = typeof invoices.$inferSelect;\n\n// Invoice line item types\nexport const insertInvoiceLineItemSchema = createInsertSchema(invoiceLineItems).omit({ id: true, createdAt: true });\nexport type InsertInvoiceLineItem = z.infer<typeof insertInvoiceLineItemSchema>;\nexport type InvoiceLineItem = typeof invoiceLineItems.$inferSelect;\n\n// Discount code types\nexport const insertDiscountCodeSchema = createInsertSchema(discountCodes).omit({ id: true, createdAt: true, updatedAt: true, usedCount: true });\nexport type InsertDiscountCode = z.infer<typeof insertDiscountCodeSchema>;\nexport type DiscountCode = typeof discountCodes.$inferSelect;\n\n// Discount code usage types\nexport const insertDiscountCodeUsageSchema = createInsertSchema(discountCodeUsage).omit({ id: true, usedAt: true });\nexport type InsertDiscountCodeUsage = z.infer<typeof insertDiscountCodeUsageSchema>;\nexport type DiscountCodeUsage = typeof discountCodeUsage.$inferSelect;\n\n// RSS Feed token types\nexport const insertRssFeedTokenSchema = createInsertSchema(rssFeedTokens).omit({ id: true, createdAt: true, lastAccessedAt: true });\nexport type InsertRssFeedToken = z.infer<typeof insertRssFeedTokenSchema>;\nexport type RssFeedToken = typeof rssFeedTokens.$inferSelect;\n\n// Cart item types\nexport const insertCartItemSchema = createInsertSchema(cartItems).omit({ id: true, createdAt: true });\nexport type InsertCartItem = z.infer<typeof insertCartItemSchema>;\nexport type CartItem = typeof cartItems.$inferSelect;\nexport type CartItemWithAudiobook = CartItem & { audiobook: Audiobook };\n\n// Extended types for API responses\nexport type AudiobookWithChapters = Audiobook & { chapters: Chapter[] };\nexport type AudiobookWithPublisher = Audiobook & { publisher: User };\nexport type ChapterWithAudiobook = Chapter & { audiobook: Audiobook };\nexport type AudiobookWithAccess = Audiobook & { \n  hasAccess: boolean; \n  isPurchased: boolean;\n  isSubscriber: boolean;\n  isFavorite: boolean;\n};\n\nexport type AudiobookWithChaptersAndAccess = Audiobook & {\n  chapters: Chapter[];\n  hasAccess: boolean;\n  isPurchased: boolean;\n  isSubscriber: boolean;\n  isFavorite: boolean;\n};\n\n// Legacy type aliases for backward compatibility during migration\nexport type Podcast = Audiobook;\nexport type Episode = Chapter;\nexport type InsertPodcast = InsertAudiobook;\nexport type InsertEpisode = InsertChapter;\nexport type PodcastWithEpisodes = AudiobookWithChapters;\nexport type EpisodeWithPodcast = ChapterWithAudiobook;\nexport type PodcastWithSubscription = Audiobook & { isSubscribed?: boolean };\nexport type EpisodeWithUrls = Chapter;\nexport type EpisodeWithPodcastAndUrls = ChapterWithAudiobook;\nexport type PodcastWithEpisodesAndUrls = AudiobookWithChapters;\nexport type ContentInvitation = { id: string; email: string; contentType: string; contentId: string; status: string };\n\n// Legacy schema aliases\nexport const insertPodcastSchema = insertAudiobookSchema;\nexport const insertEpisodeSchema = insertChapterSchema;\n\n// YouTube import schema\nexport const youtubeImportSchema = z.object({\n  playlistUrl: z.string().url(\"Invalid YouTube playlist URL\"),\n  title: z.string().min(1).optional(),\n  description: z.string().optional(),\n  category: z.string().default(\"General\"),\n});\n\n// Local import schema\nexport const localImportSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  description: z.string().optional(),\n  category: z.string().default(\"General\"),\n  files: z.array(z.object({\n    filename: z.string(),\n    path: z.string(),\n  })).optional(),\n});\n","path":null,"size_bytes":34075,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/audio-player.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\nimport { \n  Play, \n  Pause, \n  Volume2, \n  VolumeX, \n  SkipBack, \n  SkipForward, \n  Clock, \n  Gauge,\n  RotateCcw,\n  RotateCw,\n  Moon,\n  Settings,\n  ChevronUp,\n  X\n} from \"lucide-react\";\nimport type { Episode } from \"@shared/schema\";\n\ninterface AudioPlayerProps {\n  episode: Episode;\n  podcastTitle?: string;\n  podcastCover?: string;\n}\n\nfunction formatTime(seconds: number): string {\n  if (!seconds || isNaN(seconds)) return \"0:00\";\n  const hours = Math.floor(seconds / 3600);\n  const mins = Math.floor((seconds % 3600) / 60);\n  const secs = Math.floor(seconds % 60);\n  if (hours > 0) {\n    return `${hours}:${mins.toString().padStart(2, \"0\")}:${secs.toString().padStart(2, \"0\")}`;\n  }\n  return `${mins}:${secs.toString().padStart(2, \"0\")}`;\n}\n\nfunction formatTimeRemaining(seconds: number): string {\n  if (!seconds || isNaN(seconds)) return \"-0:00\";\n  return `-${formatTime(seconds)}`;\n}\n\nconst PLAYBACK_SPEEDS = [0.5, 0.75, 0.8, 1, 1.1, 1.25, 1.5, 1.75, 2, 2.5, 3];\nconst SKIP_AMOUNTS = [10, 15, 30];\nconst SLEEP_TIMER_OPTIONS = [\n  { label: \"5 minutos\", value: 5 * 60 },\n  { label: \"10 minutos\", value: 10 * 60 },\n  { label: \"15 minutos\", value: 15 * 60 },\n  { label: \"30 minutos\", value: 30 * 60 },\n  { label: \"45 minutos\", value: 45 * 60 },\n  { label: \"1 hora\", value: 60 * 60 },\n  { label: \"Final del capÃ­tulo\", value: -1 },\n];\n\nexport function AudioPlayer({ episode, podcastTitle, podcastCover }: AudioPlayerProps) {\n  const audioRef = useRef<HTMLAudioElement>(null);\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [currentTime, setCurrentTime] = useState(0);\n  const [duration, setDuration] = useState(0);\n  const [volume, setVolume] = useState(1);\n  const [isMuted, setIsMuted] = useState(false);\n  const [playbackRate, setPlaybackRate] = useState(1);\n  const [skipAmount, setSkipAmount] = useState(15);\n  const [jumpDialogOpen, setJumpDialogOpen] = useState(false);\n  const [jumpMinutes, setJumpMinutes] = useState(\"\");\n  const [jumpSeconds, setJumpSeconds] = useState(\"\");\n  const [showTimeRemaining, setShowTimeRemaining] = useState(false);\n  const [sleepTimer, setSleepTimer] = useState<number | null>(null);\n  const [sleepTimerRemaining, setSleepTimerRemaining] = useState<number | null>(null);\n  const [mobileControlsOpen, setMobileControlsOpen] = useState(false);\n  const listenedThresholdReached = useRef(false);\n  const sleepTimerInterval = useRef<NodeJS.Timeout | null>(null);\n\n  // Mark episode as listened when 80% is reached\n  useEffect(() => {\n    if (duration > 0 && currentTime / duration >= 0.8 && !listenedThresholdReached.current) {\n      listenedThresholdReached.current = true;\n      try {\n        const data = localStorage.getItem(\"listened-episodes\");\n        const listened: string[] = data ? JSON.parse(data) : [];\n        if (!listened.includes(episode.id)) {\n          listened.push(episode.id);\n          localStorage.setItem(\"listened-episodes\", JSON.stringify(listened));\n          window.dispatchEvent(new CustomEvent(\"episode-listened\", { detail: { episodeId: episode.id } }));\n        }\n      } catch (error) {\n        console.error(\"Error saving listened episode:\", error);\n      }\n    }\n  }, [currentTime, duration, episode.id]);\n\n  // Reset threshold when episode changes\n  useEffect(() => {\n    listenedThresholdReached.current = false;\n  }, [episode.id]);\n\n  // Audio event listeners\n  useEffect(() => {\n    const audio = audioRef.current;\n    if (!audio) return;\n\n    const updateTime = () => setCurrentTime(audio.currentTime);\n    const updateDuration = () => setDuration(audio.duration);\n    const handleEnded = () => {\n      setIsPlaying(false);\n      if (sleepTimer === -1) {\n        cancelSleepTimer();\n      }\n    };\n\n    audio.addEventListener(\"timeupdate\", updateTime);\n    audio.addEventListener(\"loadedmetadata\", updateDuration);\n    audio.addEventListener(\"ended\", handleEnded);\n\n    return () => {\n      audio.removeEventListener(\"timeupdate\", updateTime);\n      audio.removeEventListener(\"loadedmetadata\", updateDuration);\n      audio.removeEventListener(\"ended\", handleEnded);\n    };\n  }, [sleepTimer]);\n\n  // Sleep timer logic\n  useEffect(() => {\n    if (sleepTimerRemaining !== null && sleepTimerRemaining > 0 && isPlaying) {\n      sleepTimerInterval.current = setInterval(() => {\n        setSleepTimerRemaining(prev => {\n          if (prev === null || prev <= 1) {\n            if (audioRef.current) {\n              audioRef.current.pause();\n              setIsPlaying(false);\n            }\n            cancelSleepTimer();\n            return null;\n          }\n          return prev - 1;\n        });\n      }, 1000);\n    }\n\n    return () => {\n      if (sleepTimerInterval.current) {\n        clearInterval(sleepTimerInterval.current);\n      }\n    };\n  }, [sleepTimerRemaining, isPlaying]);\n\n  const cancelSleepTimer = useCallback(() => {\n    setSleepTimer(null);\n    setSleepTimerRemaining(null);\n    if (sleepTimerInterval.current) {\n      clearInterval(sleepTimerInterval.current);\n    }\n  }, []);\n\n  const startSleepTimer = useCallback((seconds: number) => {\n    if (seconds === -1) {\n      setSleepTimer(-1);\n      setSleepTimerRemaining(null);\n    } else {\n      setSleepTimer(seconds);\n      setSleepTimerRemaining(seconds);\n    }\n  }, []);\n\n  const togglePlay = () => {\n    if (audioRef.current) {\n      if (isPlaying) {\n        audioRef.current.pause();\n      } else {\n        audioRef.current.play();\n      }\n      setIsPlaying(!isPlaying);\n    }\n  };\n\n  const handleSeek = (value: number[]) => {\n    if (audioRef.current) {\n      audioRef.current.currentTime = value[0];\n      setCurrentTime(value[0]);\n    }\n  };\n\n  const handleVolumeChange = (value: number[]) => {\n    const newVolume = value[0];\n    setVolume(newVolume);\n    if (audioRef.current) {\n      audioRef.current.volume = newVolume;\n    }\n    if (newVolume > 0 && isMuted) {\n      setIsMuted(false);\n    }\n  };\n\n  const toggleMute = () => {\n    if (audioRef.current) {\n      audioRef.current.muted = !isMuted;\n      setIsMuted(!isMuted);\n    }\n  };\n\n  const skipForward = () => {\n    if (audioRef.current) {\n      const newTime = Math.min(audioRef.current.currentTime + skipAmount, duration);\n      audioRef.current.currentTime = newTime;\n      setCurrentTime(newTime);\n    }\n  };\n\n  const skipBackward = () => {\n    if (audioRef.current) {\n      const newTime = Math.max(audioRef.current.currentTime - skipAmount, 0);\n      audioRef.current.currentTime = newTime;\n      setCurrentTime(newTime);\n    }\n  };\n\n  const changePlaybackRate = (rate: number) => {\n    setPlaybackRate(rate);\n    if (audioRef.current) {\n      audioRef.current.playbackRate = rate;\n    }\n  };\n\n  const handleJumpToTime = () => {\n    const mins = parseInt(jumpMinutes) || 0;\n    const secs = parseInt(jumpSeconds) || 0;\n    const totalSeconds = (mins * 60) + secs;\n    \n    if (audioRef.current && totalSeconds >= 0 && totalSeconds <= duration) {\n      audioRef.current.currentTime = totalSeconds;\n      setCurrentTime(totalSeconds);\n      setJumpDialogOpen(false);\n      setJumpMinutes(\"\");\n      setJumpSeconds(\"\");\n    }\n  };\n\n  const progress = duration > 0 ? (currentTime / duration) * 100 : 0;\n  const timeRemaining = duration - currentTime;\n\n  return (\n    <div className=\"fixed bottom-0 left-0 right-0 bg-card border-t border-card-border z-50\">\n      <div className=\"max-w-7xl mx-auto px-4 py-3\">\n        <audio ref={audioRef} src={episode.audioUrl || undefined} data-testid=\"audio-player\" />\n\n        {/* Progress Bar */}\n        <div className=\"mb-3\">\n          <Slider\n            value={[currentTime]}\n            max={duration || 100}\n            step={0.1}\n            onValueChange={handleSeek}\n            className=\"cursor-pointer\"\n            data-testid=\"slider-progress\"\n          />\n          <div className=\"flex justify-between text-xs text-muted-foreground mt-1\">\n            <span data-testid=\"text-current-time\">{formatTime(currentTime)}</span>\n            <button \n              onClick={() => setShowTimeRemaining(!showTimeRemaining)}\n              className=\"hover:text-foreground transition-colors\"\n              data-testid=\"button-toggle-time-display\"\n            >\n              {showTimeRemaining \n                ? formatTimeRemaining(timeRemaining)\n                : formatTime(duration)\n              }\n            </button>\n          </div>\n        </div>\n\n        {/* Controls */}\n        <div className=\"flex items-center gap-4\">\n          {/* Cover & Info */}\n          <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n            {podcastCover && (\n              <img\n                src={podcastCover}\n                alt={podcastTitle || \"Audiobook\"}\n                className=\"w-12 h-12 rounded-lg object-cover flex-shrink-0\"\n              />\n            )}\n            <div className=\"min-w-0 flex-1\">\n              <p className=\"font-semibold text-sm line-clamp-1\" data-testid=\"text-player-episode-title\">\n                {episode.title}\n              </p>\n              {podcastTitle && (\n                <p className=\"text-xs text-muted-foreground line-clamp-1\">\n                  {podcastTitle}\n                </p>\n              )}\n              {sleepTimer !== null && (\n                <p className=\"text-xs text-primary flex items-center gap-1\">\n                  <Moon className=\"h-3 w-3\" />\n                  {sleepTimer === -1 \n                    ? \"Hasta final del capÃ­tulo\" \n                    : sleepTimerRemaining \n                      ? `Apagar en ${formatTime(sleepTimerRemaining)}`\n                      : null\n                  }\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Playback Controls */}\n          <div className=\"flex items-center gap-1 flex-shrink-0\">\n            {/* Skip Backward */}\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={skipBackward}\n              className=\"relative\"\n              data-testid=\"button-skip-backward\"\n              title={`Retroceder ${skipAmount}s`}\n            >\n              <RotateCcw className=\"h-5 w-5\" />\n              <span className=\"absolute text-[9px] font-bold\">{skipAmount}</span>\n            </Button>\n\n            {/* Play/Pause */}\n            <Button\n              variant=\"default\"\n              size=\"icon\"\n              onClick={togglePlay}\n              className=\"h-12 w-12 rounded-full\"\n              data-testid=\"button-play-pause\"\n            >\n              {isPlaying ? (\n                <Pause className=\"h-5 w-5 fill-current\" />\n              ) : (\n                <Play className=\"h-5 w-5 fill-current ml-0.5\" />\n              )}\n            </Button>\n\n            {/* Skip Forward */}\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={skipForward}\n              className=\"relative\"\n              data-testid=\"button-skip-forward\"\n              title={`Avanzar ${skipAmount}s`}\n            >\n              <RotateCw className=\"h-5 w-5\" />\n              <span className=\"absolute text-[9px] font-bold\">{skipAmount}</span>\n            </Button>\n          </div>\n\n          {/* Advanced Controls - Desktop */}\n          <div className=\"hidden md:flex items-center gap-2 flex-shrink-0\">\n            {/* Playback Speed */}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"sm\" className=\"h-8 px-2 gap-1 min-w-[60px]\" data-testid=\"button-playback-speed\">\n                  <Gauge className=\"h-3 w-3\" />\n                  <span className=\"text-xs font-medium\">{playbackRate}x</span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\" className=\"max-h-64 overflow-y-auto\">\n                {PLAYBACK_SPEEDS.map(speed => (\n                  <DropdownMenuItem \n                    key={speed}\n                    onClick={() => changePlaybackRate(speed)} \n                    className={playbackRate === speed ? \"bg-accent\" : \"\"}\n                    data-testid={`menu-speed-${speed}`}\n                  >\n                    {speed === 1 ? \"Normal (1x)\" : `${speed}x`}\n                  </DropdownMenuItem>\n                ))}\n              </DropdownMenuContent>\n            </DropdownMenu>\n\n            {/* Skip Amount Selector */}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"sm\" className=\"h-8 px-2 gap-1\" data-testid=\"button-skip-amount\">\n                  <SkipForward className=\"h-3 w-3\" />\n                  <span className=\"text-xs\">{skipAmount}s</span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {SKIP_AMOUNTS.map(amount => (\n                  <DropdownMenuItem \n                    key={amount}\n                    onClick={() => setSkipAmount(amount)}\n                    className={skipAmount === amount ? \"bg-accent\" : \"\"}\n                    data-testid={`menu-skip-${amount}`}\n                  >\n                    {amount} segundos\n                  </DropdownMenuItem>\n                ))}\n              </DropdownMenuContent>\n            </DropdownMenu>\n\n            {/* Sleep Timer */}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  size=\"icon\" \n                  className={`h-8 w-8 ${sleepTimer !== null ? \"text-primary\" : \"\"}`}\n                  data-testid=\"button-sleep-timer\"\n                  title=\"Temporizador de sueÃ±o\"\n                >\n                  <Moon className=\"h-4 w-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {sleepTimer !== null && (\n                  <>\n                    <DropdownMenuItem onClick={cancelSleepTimer} className=\"text-destructive\" data-testid=\"menu-cancel-sleep\">\n                      <X className=\"h-4 w-4 mr-2\" />\n                      Cancelar temporizador\n                    </DropdownMenuItem>\n                    <DropdownMenuSeparator />\n                  </>\n                )}\n                {SLEEP_TIMER_OPTIONS.map(option => (\n                  <DropdownMenuItem \n                    key={option.value}\n                    onClick={() => startSleepTimer(option.value)}\n                    data-testid={`menu-sleep-${option.value}`}\n                  >\n                    {option.label}\n                  </DropdownMenuItem>\n                ))}\n              </DropdownMenuContent>\n            </DropdownMenu>\n\n            {/* Jump to Time */}\n            <Dialog open={jumpDialogOpen} onOpenChange={setJumpDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" data-testid=\"button-jump-to-time\" title=\"Ir a minuto especÃ­fico\">\n                  <Clock className=\"h-4 w-4\" />\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"sm:max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>Ir a Tiempo EspecÃ­fico</DialogTitle>\n                  <DialogDescription>\n                    Introduce el tiempo al que deseas saltar\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"flex gap-4 py-4\">\n                  <div className=\"flex-1\">\n                    <Label htmlFor=\"jump-minutes\" className=\"text-sm mb-2 block\">\n                      Minutos\n                    </Label>\n                    <Input\n                      id=\"jump-minutes\"\n                      type=\"number\"\n                      min=\"0\"\n                      max={Math.floor(duration / 60)}\n                      value={jumpMinutes}\n                      onChange={(e) => setJumpMinutes(e.target.value)}\n                      placeholder=\"0\"\n                      data-testid=\"input-jump-minutes\"\n                    />\n                  </div>\n                  <div className=\"flex-1\">\n                    <Label htmlFor=\"jump-seconds\" className=\"text-sm mb-2 block\">\n                      Segundos\n                    </Label>\n                    <Input\n                      id=\"jump-seconds\"\n                      type=\"number\"\n                      min=\"0\"\n                      max=\"59\"\n                      value={jumpSeconds}\n                      onChange={(e) => setJumpSeconds(e.target.value)}\n                      placeholder=\"0\"\n                      data-testid=\"input-jump-seconds\"\n                    />\n                  </div>\n                </div>\n                <div className=\"flex justify-end gap-2\">\n                  <Button variant=\"outline\" onClick={() => setJumpDialogOpen(false)} data-testid=\"button-cancel-jump\">\n                    Cancelar\n                  </Button>\n                  <Button onClick={handleJumpToTime} data-testid=\"button-confirm-jump\">\n                    Ir\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </div>\n\n          {/* Volume Controls - Desktop */}\n          <div className=\"hidden md:flex items-center gap-2 w-32 flex-shrink-0\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={toggleMute}\n              className=\"h-8 w-8\"\n              data-testid=\"button-mute\"\n            >\n              {isMuted || volume === 0 ? (\n                <VolumeX className=\"h-4 w-4\" />\n              ) : (\n                <Volume2 className=\"h-4 w-4\" />\n              )}\n            </Button>\n            <Slider\n              value={[isMuted ? 0 : volume]}\n              max={1}\n              step={0.01}\n              onValueChange={handleVolumeChange}\n              className=\"flex-1\"\n              data-testid=\"slider-volume\"\n            />\n          </div>\n\n          {/* Mobile Controls Button */}\n          <Sheet open={mobileControlsOpen} onOpenChange={setMobileControlsOpen}>\n            <SheetTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"md:hidden h-8 w-8\"\n                data-testid=\"button-mobile-controls\"\n              >\n                <Settings className=\"h-4 w-4\" />\n              </Button>\n            </SheetTrigger>\n            <SheetContent side=\"bottom\" className=\"h-auto max-h-[70vh]\">\n              <SheetHeader>\n                <SheetTitle>Opciones de ReproducciÃ³n</SheetTitle>\n              </SheetHeader>\n              <div className=\"space-y-6 py-4\">\n                {/* Playback Speed - Mobile */}\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Velocidad de reproducciÃ³n</Label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {PLAYBACK_SPEEDS.map(speed => (\n                      <Button\n                        key={speed}\n                        variant={playbackRate === speed ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => changePlaybackRate(speed)}\n                        data-testid={`mobile-speed-${speed}`}\n                      >\n                        {speed}x\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Skip Amount - Mobile */}\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Salto de tiempo</Label>\n                  <div className=\"flex gap-2\">\n                    {SKIP_AMOUNTS.map(amount => (\n                      <Button\n                        key={amount}\n                        variant={skipAmount === amount ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => setSkipAmount(amount)}\n                        data-testid={`mobile-skip-${amount}`}\n                      >\n                        {amount}s\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Sleep Timer - Mobile */}\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Temporizador de sueÃ±o</Label>\n                  {sleepTimer !== null && (\n                    <Button\n                      variant=\"destructive\"\n                      size=\"sm\"\n                      onClick={cancelSleepTimer}\n                      className=\"mb-2 w-full\"\n                      data-testid=\"mobile-cancel-sleep\"\n                    >\n                      <X className=\"h-4 w-4 mr-2\" />\n                      Cancelar ({sleepTimer === -1 ? \"Final del capÃ­tulo\" : formatTime(sleepTimerRemaining || 0)})\n                    </Button>\n                  )}\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    {SLEEP_TIMER_OPTIONS.map(option => (\n                      <Button\n                        key={option.value}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => {\n                          startSleepTimer(option.value);\n                          setMobileControlsOpen(false);\n                        }}\n                        data-testid={`mobile-sleep-${option.value}`}\n                      >\n                        {option.label}\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Volume - Mobile */}\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Volumen</Label>\n                  <div className=\"flex items-center gap-3\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={toggleMute}\n                      data-testid=\"mobile-mute\"\n                    >\n                      {isMuted || volume === 0 ? (\n                        <VolumeX className=\"h-5 w-5\" />\n                      ) : (\n                        <Volume2 className=\"h-5 w-5\" />\n                      )}\n                    </Button>\n                    <Slider\n                      value={[isMuted ? 0 : volume]}\n                      max={1}\n                      step={0.01}\n                      onValueChange={handleVolumeChange}\n                      className=\"flex-1\"\n                      data-testid=\"mobile-slider-volume\"\n                    />\n                    <span className=\"text-sm w-12 text-right\">{Math.round(volume * 100)}%</span>\n                  </div>\n                </div>\n\n                {/* Jump to Time - Mobile */}\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Ir a tiempo especÃ­fico</Label>\n                  <div className=\"flex gap-2 items-end\">\n                    <div className=\"flex-1\">\n                      <Label htmlFor=\"mobile-jump-minutes\" className=\"text-xs mb-1 block text-muted-foreground\">\n                        Minutos\n                      </Label>\n                      <Input\n                        id=\"mobile-jump-minutes\"\n                        type=\"number\"\n                        min=\"0\"\n                        value={jumpMinutes}\n                        onChange={(e) => setJumpMinutes(e.target.value)}\n                        placeholder=\"0\"\n                        data-testid=\"mobile-input-jump-minutes\"\n                      />\n                    </div>\n                    <div className=\"flex-1\">\n                      <Label htmlFor=\"mobile-jump-seconds\" className=\"text-xs mb-1 block text-muted-foreground\">\n                        Segundos\n                      </Label>\n                      <Input\n                        id=\"mobile-jump-seconds\"\n                        type=\"number\"\n                        min=\"0\"\n                        max=\"59\"\n                        value={jumpSeconds}\n                        onChange={(e) => setJumpSeconds(e.target.value)}\n                        placeholder=\"0\"\n                        data-testid=\"mobile-input-jump-seconds\"\n                      />\n                    </div>\n                    <Button \n                      onClick={() => {\n                        handleJumpToTime();\n                        setMobileControlsOpen(false);\n                      }}\n                      data-testid=\"mobile-button-jump\"\n                    >\n                      Ir\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            </SheetContent>\n          </Sheet>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":25234,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* AUDIVIA LIGHT MODE - Premium Deep Purple/Indigo with Gold Accents */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 270 20% 98%;\n  --foreground: 260 25% 11%;\n  --border: 260 10% 85%;\n  --card: 270 15% 96%;\n  --card-foreground: 260 25% 11%;\n  --card-border: 260 10% 90%;\n  --sidebar: 260 30% 12%;\n  --sidebar-foreground: 45 90% 96%;\n  --sidebar-border: 260 25% 18%;\n  --sidebar-primary: 45 90% 55%;\n  --sidebar-primary-foreground: 260 30% 10%;\n  --sidebar-accent: 260 25% 20%;\n  --sidebar-accent-foreground: 45 90% 96%;\n  --sidebar-ring: 45 90% 55%;\n  --popover: 270 15% 94%;\n  --popover-foreground: 260 25% 11%;\n  --popover-border: 260 10% 85%;\n  --primary: 260 65% 50%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 260 10% 88%;\n  --secondary-foreground: 260 25% 15%;\n  --muted: 260 10% 90%;\n  --muted-foreground: 260 10% 40%;\n  --accent: 45 90% 55%;\n  --accent-foreground: 260 30% 10%;\n  --destructive: 0 84% 60%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 260 10% 75%;\n  --ring: 260 65% 50%;\n  --chart-1: 260 65% 50%;\n  --chart-2: 45 90% 55%;\n  --chart-3: 280 60% 55%;\n  --chart-4: 35 80% 50%;\n  --chart-5: 200 70% 50%;\n  --font-sans: Inter, -apple-system, BlinkMacSystemFont, sans-serif;\n  --font-serif: \"Cormorant Garamond\", Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 4px 0px hsl(260 30% 20% / 0.05);\n  --shadow-xs: 0px 2px 4px 0px hsl(260 30% 20% / 0.08);\n  --shadow-sm: 0px 2px 4px 0px hsl(260 30% 20% / 0.08), 0px 1px 2px -1px hsl(260 30% 20% / 0.06);\n  --shadow: 0px 2px 4px 0px hsl(260 30% 20% / 0.10), 0px 1px 2px -1px hsl(260 30% 20% / 0.08);\n  --shadow-md: 0px 4px 8px 0px hsl(260 30% 20% / 0.10), 0px 2px 4px -1px hsl(260 30% 20% / 0.06);\n  --shadow-lg: 0px 8px 16px 0px hsl(260 30% 20% / 0.12), 0px 4px 6px -1px hsl(260 30% 20% / 0.08);\n  --shadow-xl: 0px 16px 32px 0px hsl(260 30% 20% / 0.15), 0px 8px 10px -1px hsl(260 30% 20% / 0.10);\n  --shadow-2xl: 0px 24px 48px 0px hsl(260 30% 20% / 0.18);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* AUDIVIA DARK MODE - Premium Deep Purple/Indigo with Gold Accents */\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 260 30% 8%;\n  --foreground: 45 20% 95%;\n  --border: 260 20% 18%;\n  --card: 260 25% 11%;\n  --card-foreground: 45 20% 95%;\n  --card-border: 260 20% 16%;\n  --sidebar: 260 30% 6%;\n  --sidebar-foreground: 45 90% 96%;\n  --sidebar-border: 260 25% 14%;\n  --sidebar-primary: 45 90% 55%;\n  --sidebar-primary-foreground: 260 30% 10%;\n  --sidebar-accent: 260 25% 16%;\n  --sidebar-accent-foreground: 45 90% 96%;\n  --sidebar-ring: 45 90% 55%;\n  --popover: 260 25% 12%;\n  --popover-foreground: 45 20% 95%;\n  --popover-border: 260 20% 18%;\n  --primary: 260 65% 60%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 260 20% 18%;\n  --secondary-foreground: 45 20% 95%;\n  --muted: 260 20% 16%;\n  --muted-foreground: 260 10% 60%;\n  --accent: 45 90% 55%;\n  --accent-foreground: 260 30% 10%;\n  --destructive: 0 62% 45%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 260 20% 25%;\n  --ring: 260 65% 60%;\n  --chart-1: 260 65% 60%;\n  --chart-2: 45 90% 55%;\n  --chart-3: 280 60% 60%;\n  --chart-4: 35 80% 55%;\n  --chart-5: 200 70% 55%;\n  --shadow-2xs: 0px 2px 4px 0px hsl(260 50% 5% / 0.3);\n  --shadow-xs: 0px 2px 4px 0px hsl(260 50% 5% / 0.4);\n  --shadow-sm: 0px 2px 4px 0px hsl(260 50% 5% / 0.4), 0px 1px 2px -1px hsl(260 50% 5% / 0.3);\n  --shadow: 0px 2px 4px 0px hsl(260 50% 5% / 0.5), 0px 1px 2px -1px hsl(260 50% 5% / 0.4);\n  --shadow-md: 0px 4px 8px 0px hsl(260 50% 5% / 0.5), 0px 2px 4px -1px hsl(260 50% 5% / 0.3);\n  --shadow-lg: 0px 8px 16px 0px hsl(260 50% 5% / 0.6), 0px 4px 6px -1px hsl(260 50% 5% / 0.4);\n  --shadow-xl: 0px 16px 32px 0px hsl(260 50% 5% / 0.7), 0px 8px 10px -1px hsl(260 50% 5% / 0.5);\n  --shadow-2xl: 0px 24px 48px 0px hsl(260 50% 5% / 0.8);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n\n  /* Hide scrollbar for horizontal scroll sections (AntennaPod style) */\n  .scrollbar-hide {\n    -ms-overflow-style: none;\n    scrollbar-width: none;\n  }\n  .scrollbar-hide::-webkit-scrollbar {\n    display: none;\n  }\n}\n","path":null,"size_bytes":11133,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nexport default function Settings() {\n  const { theme, setTheme } = useTheme();\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      <div className=\"max-w-3xl mx-auto px-6 py-8\">\n        <h1 className=\"font-serif text-4xl font-bold mb-6\" data-testid=\"text-page-title\">\n          ConfiguraciÃ³n\n        </h1>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Apariencia</CardTitle>\n            <CardDescription>\n              Personaliza cÃ³mo se ve Audivia\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"space-y-0.5\">\n                <Label htmlFor=\"dark-mode\">Modo Oscuro</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Activa el tema oscuro para reducir el cansancio visual\n                </p>\n              </div>\n              <Switch\n                id=\"dark-mode\"\n                checked={theme === \"dark\"}\n                onCheckedChange={(checked) => setTheme(checked ? \"dark\" : \"light\")}\n                data-testid=\"switch-dark-mode\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1509,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation, Link } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { AuthProvider } from \"@/components/auth-provider\";\nimport { ProtectedRoute } from \"@/components/protected-route\";\nimport { UserMenu } from \"@/components/user-menu\";\nimport { Footer } from \"@/components/footer\";\nimport logoImage from \"@assets/audivia_horizonta_1766267902382.png\";\nimport Home from \"@/pages/home\";\nimport AudiobookDetail from \"@/pages/audiobook-detail\";\nimport ChapterPlayer from \"@/pages/chapter-player\";\nimport Explore from \"@/pages/explore\";\nimport Library from \"@/pages/library\";\nimport Settings from \"@/pages/settings\";\nimport Login from \"@/pages/login\";\nimport Register from \"@/pages/register\";\nimport ForgotPassword from \"@/pages/forgot-password\";\nimport ResetPassword from \"@/pages/reset-password\";\nimport VerifyEmail from \"@/pages/verify-email\";\nimport EmergencyReset from \"@/pages/emergency-reset\";\nimport AdminDashboard from \"@/pages/admin-dashboard\";\nimport AdminUsers from \"@/pages/admin-users\";\nimport AdminAudiobooks from \"@/pages/admin-audiobooks\";\nimport AdminChapters from \"@/pages/admin-chapters\";\nimport AdminEmailConfig from \"@/pages/admin-email-config\";\nimport AdminPayPalConfig from \"@/pages/admin-paypal-config\";\nimport AdminSalesDashboard from \"@/pages/admin-sales-dashboard\";\nimport AdminSubscriptions from \"@/pages/admin-subscriptions\";\nimport AdminImport from \"@/pages/admin-import\";\nimport AdminCustomers from \"@/pages/admin-customers\";\nimport AdminDiscountCodes from \"@/pages/admin-discount-codes\";\nimport AdminExternalServices from \"@/pages/admin-external-services\";\nimport Profile from \"@/pages/profile\";\nimport UserGuide from \"@/pages/user-guide\";\nimport MyPlaylists from \"@/pages/my-playlists\";\nimport PlaylistDetail from \"@/pages/playlist-detail\";\nimport Subscriptions from \"@/pages/subscriptions\";\nimport Cart from \"@/pages/cart\";\nimport Checkout from \"@/pages/checkout\";\nimport Mobile from \"@/pages/mobile\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  const [location] = useLocation();\n  const isAuthPage = location === \"/login\" || location === \"/register\" || location === \"/forgot-password\" || location.startsWith(\"/reset-password\") || location.startsWith(\"/verify-email\") || location === \"/emergency-reset\";\n  const isMobilePage = location === \"/mobile\";\n\n  if (isMobilePage) {\n    return <Mobile />;\n  }\n\n  if (isAuthPage) {\n    return (\n      <div className=\"min-h-screen w-full flex flex-col bg-background\">\n        <div className=\"absolute top-4 right-4 z-10\">\n          <ThemeToggle />\n        </div>\n        <div className=\"flex-1\">\n          <Switch>\n            <Route path=\"/login\" component={Login} />\n            <Route path=\"/register\" component={Register} />\n            <Route path=\"/forgot-password\" component={ForgotPassword} />\n            <Route path=\"/reset-password\" component={ResetPassword} />\n            <Route path=\"/verify-email\" component={VerifyEmail} />\n            <Route path=\"/emergency-reset\" component={EmergencyReset} />\n          </Switch>\n        </div>\n        <Footer />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col h-screen w-full\">\n      <header className=\"flex items-center justify-between px-4 py-3 border-b border-primary/20 z-50 shrink-0\" style={{ backgroundColor: \"#7C3AED\" }}>\n        <div className=\"flex items-center gap-4\">\n          <SidebarTrigger className=\"text-white hover:text-white/80\" data-testid=\"button-sidebar-toggle\" />\n          <Link href=\"/\">\n            <img \n              src={logoImage} \n              alt=\"Audivia Logo\" \n              className=\"h-10 w-auto cursor-pointer brightness-0 invert\"\n              data-testid=\"img-header-logo\"\n            />\n          </Link>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <ThemeToggle className=\"text-white hover:text-white/80 [&_svg]:text-white\" />\n          <UserMenu className=\"text-white\" />\n        </div>\n      </header>\n      <div className=\"flex flex-1 overflow-hidden relative\">\n        <AppSidebar />\n        <main className=\"flex-1 overflow-auto flex flex-col\">\n          <div className=\"flex-1\">\n            <Switch>\n              <Route path=\"/\" component={Home} />\n              <Route path=\"/audiobook/:id\" component={AudiobookDetail} />\n              <Route path=\"/chapter/:id\" component={ChapterPlayer} />\n              <Route path=\"/explore\" component={Explore} />\n              <Route path=\"/library\" component={Library} />\n              <Route path=\"/subscriptions\" component={Subscriptions} />\n              <Route path=\"/cart\">\n                <ProtectedRoute>\n                  <Cart />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/checkout\">\n                <ProtectedRoute>\n                  <Checkout />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/my-playlists\">\n                <ProtectedRoute>\n                  <MyPlaylists />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/playlists/:id\" component={PlaylistDetail} />\n              <Route path=\"/settings\" component={Settings} />\n              <Route path=\"/user-guide\" component={UserGuide} />\n              <Route path=\"/profile\">\n                <ProtectedRoute>\n                  <Profile />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminDashboard />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/sales\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminSalesDashboard />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/users\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminUsers />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/audiobooks\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminAudiobooks />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/chapters\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminChapters />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/email-config\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminEmailConfig />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/paypal-config\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminPayPalConfig />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/subscriptions\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminSubscriptions />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/import\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminImport />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/customers\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminCustomers />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/discount-codes\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminDiscountCodes />\n                </ProtectedRoute>\n              </Route>\n              <Route path=\"/admin/external-services\">\n                <ProtectedRoute requireRole=\"ADMIN\">\n                  <AdminExternalServices />\n                </ProtectedRoute>\n              </Route>\n              <Route component={NotFound} />\n            </Switch>\n          </div>\n          <Footer />\n        </main>\n      </div>\n    </div>\n  );\n}\n\nfunction App() {\n  const [location] = useLocation();\n  const isMobilePage = location === \"/mobile\";\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"dark\">\n        <TooltipProvider>\n          <AuthProvider>\n            {isMobilePage ? (\n              <Mobile />\n            ) : (\n              <SidebarProvider style={style as React.CSSProperties}>\n                <Router />\n              </SidebarProvider>\n            )}\n            <Toaster />\n          </AuthProvider>\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":9037,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { MoreVertical } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed top-0 bottom-0 z-10 hidden w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <MoreVertical className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21863,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/pages/register.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { useAuth } from \"@/components/auth-provider\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2 } from \"lucide-react\";\nimport logoImage from \"@assets/AUDIVIA_1766261612511.png\";\n\nexport default function Register() {\n  const [, setLocation] = useLocation();\n  const { register, isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [username, setUsername] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n\n  const [redirectPath] = useState(() => {\n    const params = new URLSearchParams(window.location.search);\n    return params.get(\"from\") === \"mobile\" ? \"/mobile\" : \"/\";\n  });\n  const isMobileOrigin = redirectPath === \"/mobile\";\n\n  useEffect(() => {\n    if (isAuthenticated) {\n      setLocation(redirectPath);\n    }\n  }, [isAuthenticated, setLocation, redirectPath]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      await register(username, email, password, \"LISTENER\");\n      toast({\n        title: \"Â¡Cuenta creada!\",\n        description: \"Tu cuenta ha sido creada exitosamente\",\n      });\n      setLocation(redirectPath);\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error al registrarse\",\n        description: error.message || \"No se pudo crear la cuenta\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex flex-col lg:flex-row\">\n      {/* Register form - optimized for mobile, no scroll */}\n      <div className=\"flex-1 flex items-center justify-center p-4 lg:p-12\">\n        <div className=\"w-full max-w-md space-y-4\">\n          {/* Logo - compact for mobile */}\n          <div className=\"flex items-center justify-center gap-3\">\n            <img \n              src={logoImage} \n              alt=\"Audivia Logo\" \n              className=\"w-12 h-12 lg:w-16 lg:h-16\"\n              data-testid=\"img-logo\"\n            />\n            <div>\n              <h1 className=\"font-serif text-xl lg:text-2xl font-bold\">Audivia</h1>\n              <p className=\"text-xs lg:text-sm text-muted-foreground\">Audiolibros premium</p>\n            </div>\n          </div>\n\n          {/* Register Card - compact */}\n          <Card className=\"w-full border-0 shadow-none\">\n            <CardHeader className=\"pb-2 pt-4\">\n              <CardTitle className=\"text-xl text-center\">Crear Cuenta</CardTitle>\n            </CardHeader>\n          <form onSubmit={handleSubmit}>\n            <CardContent className=\"space-y-3 pb-3\">\n              <div className=\"space-y-1\">\n                <Label htmlFor=\"username\" className=\"text-sm\">Nombre de usuario</Label>\n                <Input\n                  id=\"username\"\n                  type=\"text\"\n                  placeholder=\"tu_usuario\"\n                  value={username}\n                  onChange={(e) => setUsername(e.target.value)}\n                  required\n                  data-testid=\"input-username\"\n                />\n              </div>\n              <div className=\"space-y-1\">\n                <Label htmlFor=\"email\" className=\"text-sm\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"tu@email.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  data-testid=\"input-email\"\n                />\n              </div>\n              <div className=\"space-y-1\">\n                <Label htmlFor=\"password\" className=\"text-sm\">ContraseÃ±a</Label>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  placeholder=\"MÃ­nimo 8 caracteres\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  required\n                  minLength={8}\n                  data-testid=\"input-password\"\n                />\n              </div>\n            </CardContent>\n            <CardFooter className=\"flex flex-col gap-3 pt-0\">\n              <Button \n                type=\"submit\" \n                className=\"w-full\" \n                disabled={isLoading}\n                data-testid=\"button-submit\"\n              >\n                {isLoading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Creando cuenta...\n                  </>\n                ) : (\n                  \"Crear Cuenta\"\n                )}\n              </Button>\n              <p className=\"text-sm text-muted-foreground text-center\">\n                Â¿Ya tienes cuenta?{\" \"}\n                <Link href={isMobileOrigin ? \"/login?from=mobile\" : \"/login\"} className=\"text-primary hover:underline font-medium\" data-testid=\"link-login\">\n                  Inicia sesiÃ³n aquÃ­\n                </Link>\n              </p>\n            </CardFooter>\n          </form>\n        </Card>\n        </div>\n      </div>\n\n      {/* Right side - Gradient background (hidden on mobile) */}\n      <div className=\"hidden lg:flex flex-1 relative overflow-hidden bg-gradient-to-br from-primary/20 via-primary/10 to-background items-center justify-center\">\n        <div className=\"text-center p-8\">\n          <img src={logoImage} alt=\"Audivia\" className=\"w-24 h-24 mx-auto mb-4 opacity-40\" />\n          <p className=\"text-xl text-muted-foreground\">Miles de audiolibros te esperan</p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5887,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/podcast-card.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Play, User } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport type { Podcast } from \"@shared/schema\";\n\ninterface PodcastCardProps {\n  podcast: Podcast;\n}\n\nexport function PodcastCard({ podcast }: PodcastCardProps) {\n  return (\n    <Link href={`/podcast/${podcast.id}`}>\n      <Card\n        className=\"overflow-hidden hover-elevate active-elevate-2 cursor-pointer group transition-all\"\n        data-testid={`card-podcast-${podcast.id}`}\n      >\n        <div className=\"relative aspect-square\">\n          {podcast.coverArtUrl ? (\n            <img\n              src={podcast.coverArtUrl}\n              alt={podcast.title}\n              className=\"w-full h-full object-cover\"\n            />\n          ) : (\n            <div className=\"w-full h-full bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center\">\n              <User className=\"h-16 w-16 text-primary/40\" />\n            </div>\n          )}\n          <div className=\"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100\">\n            <div className=\"bg-primary rounded-full p-4\">\n              <Play className=\"h-6 w-6 text-primary-foreground fill-current\" />\n            </div>\n          </div>\n        </div>\n        <div className=\"p-4\">\n          <h3 className=\"font-[Outfit] font-bold text-lg line-clamp-1\" data-testid={`text-podcast-title-${podcast.id}`}>\n            {podcast.title}\n          </h3>\n          <p className=\"text-sm text-muted-foreground line-clamp-2 mt-1\">\n            {podcast.description}\n          </p>\n        </div>\n      </Card>\n    </Link>\n  );\n}\n","path":null,"size_bytes":1704,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"design_guidelines.md":{"content":"# Design Guidelines: Audivia - Premium Audiobook Platform\n\n## Design Approach\n**Reference-Based**: Drawing from Audible (audiobook discovery), Spotify (audio player excellence), Apple Books (premium reading/listening), and Netflix (content-forward catalog). This platform combines e-commerce, subscription service, and immersive media playback in a luxury-positioned experience.\n\n## Core Design Principles\n- **Premium Positioning**: Sophisticated layouts with generous whitespace, elevated visual hierarchy\n- **Content Showcase**: Book covers as primary visual anchors, hero imagery establishing tone\n- **Listening Sanctuary**: Distraction-free player experience with focus on immersion\n- **Mobile-First Audio**: Optimized for commute listening with one-handed navigation\n\n---\n\n## Typography\n**Primary Font**: Cormorant Garamond (Google Fonts) - elegant serif for headings, literary sophistication\n**Body Font**: Inter (Google Fonts) - crisp sans-serif for readability, UI elements\n\n**Hierarchy**:\n- Page Titles: text-5xl md:text-6xl font-bold (Cormorant Garamond)\n- Book Titles: text-2xl md:text-3xl font-semibold (Cormorant Garamond)\n- Author Names: text-lg font-medium tracking-wide uppercase (Inter)\n- Chapter/Metadata: text-sm font-normal (Inter)\n- Body Content: text-base leading-relaxed (Inter)\n\n---\n\n## Layout System\n**Spacing Primitives**: Tailwind units **4, 6, 8, 12, 16, 24, 32**\n- Compact (p-4, gap-4): Card internals, tight groupings\n- Standard (p-6, p-8): Component padding, vertical rhythm\n- Generous (p-12, p-16, p-24): Section dividers, hero spacing\n- Luxurious (p-32): Major section breaks, landing page drama\n\n**Containers**:\n- Max width: max-w-7xl for main content areas\n- Reading-optimized: max-w-3xl for description text\n- Full-bleed sections: w-full for hero, featured collections\n\n---\n\n## Component Library\n\n### 1. Immersive Audio Player (Priority Component)\n**Full-Screen Mode**: Takes over viewport during active playback\n- Top third: Book cover (large, centered, subtle shadow)\n- Middle: Progress bar with chapter markers, time stamps\n- Bottom: Controls (previous chapter, 15s back, play/pause, 15s forward, next chapter)\n- Expanded info: Title, author, current chapter name\n- Minimize button returns to mini-player\n\n**Mini Player** (Sticky Bottom): h-20 fixed bar\n- Left: Thumbnail cover (w-16 h-16), title/author truncated\n- Center: Play/pause, progress indicator\n- Right: Expand button, playback speed, add to library\n\n**Controls**: Large touch targets (w-16 h-16 minimum), clear visual feedback\n\n### 2. Hero Section (Landing/Browse Pages)\n**Layout**: Full-width, h-[75vh] on desktop, h-[60vh] mobile\n- Background: High-quality image of person reading/listening in sophisticated setting (library, commute, nature)\n- Overlay: Gradient from transparent to solid at bottom for text legibility\n- Content: Centered headline (max-w-3xl), subheadline, dual CTA buttons\n- Buttons: Blurred background (backdrop-blur-md), large (px-8 py-4), \"Start Free Trial\" + \"Browse Catalog\"\n\n### 3. Book Cover Grid\n**Layouts**:\n- Featured Row: Horizontal scroll (scrollbar-hide), large covers (w-48 h-72)\n- Catalog Grid: grid-cols-2 md:grid-cols-4 lg:grid-cols-6, responsive sizing\n- Cover aspect: 2:3 portrait, rounded-lg with subtle shadow\n- Hover: Transform scale-105 transition, elevated shadow\n\n### 4. Book Detail Card\n**Expanded View**: max-w-5xl layout\n- Left column (md:w-2/5): Large cover image, \"Play Sample\" button, purchase/subscribe CTAs\n- Right column: Title, author, narrator, duration, genre tags, description (text-base leading-relaxed), chapter list preview\n- Sticky purchase bar on mobile: Fixed bottom with price/subscribe options\n\n### 5. Navigation\n**Desktop**: Top bar with logo left, search center (max-w-xl), Browse/Library/Account right\n**Mobile**: Bottom tab bar (fixed) - Home, Browse, Library, Player, Profile\n- Icons with labels, active state with indicator line/fill\n\n### 6. Collection Carousels\n**Sections**: \"Continue Listening\", \"Bestsellers\", \"New Releases\", \"Recommended for You\"\n- Horizontal scroll cards (snap-scroll behavior)\n- Card: Cover + title + author, progress indicator for continue listening\n- \"See All\" link at section end\n\n### 7. Subscription Tiers (Pricing Page)\n**Layout**: Three-column grid on desktop (grid-cols-1 md:grid-cols-3)\n- Cards: Elevated with border, featured tier has enhanced shadow\n- Content: Tier name, price (text-4xl), feature list with checkmarks, CTA button\n- Annual toggle switch above cards showing savings\n\n### 8. Search & Filters\n**Search Bar**: Prominent, rounded-full with icon, autocomplete dropdown with cover thumbnails\n**Filters**: Sidebar (md:w-64) or modal on mobile - Genre, Duration, Narrator, Price range\n- Tag-based selections with remove icons\n\n---\n\n## Icons\n**Library**: Heroicons (outline standard, solid for active states)\n- Play/Pause: Play circle, pause circle\n- Navigation: Home, book open, library (bookshelf), user circle\n- Player: Backward 15s, forward 15s, speed meter, bookmark\n- Commerce: Shopping bag, star (ratings)\n\n---\n\n## Images\n\n**Hero Image**: Required full-width hero on landing page\n- Subject: Sophisticated listener in premium environment (leather chair with books, minimalist headphones, warm lighting)\n- Treatment: Professional photography, shallow depth of field\n- Dimensions: 1920x1080 minimum, optimized for web\n- Placement: Top of landing page, text overlay at center-bottom\n\n**Book Covers**: Primary visual element throughout\n- Source: Publisher-provided artwork\n- Fallback: Gradient with title typography if unavailable\n- Always maintain 2:3 aspect ratio\n\n**Category Headers**: Full-width images (h-64) for genre pages\n- Examples: Library interior for Classics, city transit for Business, fantasy landscapes\n- Subtle overlay ensuring text readability\n\n---\n\n## Data Visualization\n**Library Stats**: Personal listening dashboard\n- Total hours listened: Large metric display (text-6xl)\n- Books completed: Progress rings\n- Listening streak: Calendar heatmap\n- Top genres: Horizontal bar chart\n\n---\n\n## Forms\n**Purchase Flow**: Single-page checkout (max-w-2xl)\n- Payment method cards with icons\n- Order summary sidebar (sticky on desktop)\n- Large confirm button (w-full, py-4)\n\n**Review Submission**: Star rating (large, interactive stars), textarea for review text, audio snippet upload option\n\n---\n\n## Animations\n**Minimal, Purposeful**:\n- Book cover scale on hover (scale-105)\n- Player controls pulse on interaction\n- Search autocomplete fade-in\n- NO page transitions, NO parallax scrolling\n\n---\n\n## Accessibility\n- Player: Full keyboard control (space play/pause, arrow keys seek, numbers for chapter selection)\n- Focus indicators: Prominent ring on all interactive elements\n- Skip navigation links for screen readers\n- Captions available for promotional video content\n\n---\n\n## Responsive Strategy\n- Mobile (base): Single column, bottom navigation, swipe gestures for player\n- Tablet (md:768px): Two-column grids, sidebar filters, expanded mini-player\n- Desktop (lg:1024px): Multi-column layouts, hover states active, persistent sidebars\n\nThis framework creates a premium audiobook experience balancing content discovery, seamless purchasing, and immersive playback.","path":null,"size_bytes":7191,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/pages/library.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Library as LibraryIcon, Heart, HeartOff, Clock, BookOpen, Play, ShoppingBag, Crown, Receipt, Download, FileText, Rss, Copy, RefreshCw, Check, Smartphone } from \"lucide-react\";\nimport { SiAndroid, SiApple } from \"react-icons/si\";\nimport { QRCodeSVG } from \"qrcode.react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Link } from \"wouter\";\nimport type { Audiobook, SubscriptionPlan, UserSubscription, Invoice, RssFeedToken } from \"@shared/schema\";\nimport { BillingProfileForm } from \"@/components/billing-profile-form\";\nimport { Input } from \"@/components/ui/input\";\n\nconst ANTENNAPOD_ANDROID_URL = \"https://play.google.com/store/apps/details?id=de.danoeh.antennapod\";\nconst APPLE_PODCASTS_URL = \"https://apps.apple.com/app/apple-podcasts/id525463029\";\n\nfunction formatDuration(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  if (hours > 0) {\n    return `${hours}h ${minutes}m`;\n  }\n  return `${minutes}m`;\n}\n\nfunction AudiobookCard({ audiobook, onRemoveFavorite }: { audiobook: Audiobook; onRemoveFavorite?: (id: string) => void }) {\n  return (\n    <Card\n      className=\"group overflow-hidden hover-elevate cursor-pointer transition-transform duration-200 hover:scale-[1.02]\"\n      data-testid={`card-audiobook-${audiobook.id}`}\n    >\n      <Link href={`/audiobook/${audiobook.id}`}>\n        <div className=\"aspect-square relative overflow-hidden\">\n          {audiobook.coverArtUrl ? (\n            <img\n              src={audiobook.coverArtUrl}\n              alt={audiobook.title}\n              className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\n            />\n          ) : (\n            <div className=\"w-full h-full bg-gradient-to-br from-primary/30 to-primary/60 flex items-center justify-center\">\n              <BookOpen className=\"w-12 h-12 text-primary-foreground/60\" />\n            </div>\n          )}\n          <div className=\"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300\">\n            <div className=\"absolute bottom-4 left-4 right-4 flex gap-2\">\n              <Button size=\"sm\" className=\"flex-1 gap-1\">\n                <Play className=\"w-4 h-4\" />\n                Escuchar\n              </Button>\n              {onRemoveFavorite && (\n                <Button\n                  size=\"icon\"\n                  variant=\"secondary\"\n                  onClick={(e) => {\n                    e.preventDefault();\n                    onRemoveFavorite(audiobook.id);\n                  }}\n                >\n                  <HeartOff className=\"w-4 h-4\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </div>\n        <CardContent className=\"p-4\">\n          <h3 className=\"font-serif font-semibold text-lg line-clamp-1\">{audiobook.title}</h3>\n          <p className=\"text-sm text-muted-foreground line-clamp-1\">{audiobook.author}</p>\n          <div className=\"flex items-center gap-1 mt-2 text-xs text-muted-foreground\">\n            <Clock className=\"w-3 h-3\" />\n            <span>{formatDuration(audiobook.totalDuration)}</span>\n          </div>\n        </CardContent>\n      </Link>\n    </Card>\n  );\n}\n\nfunction EmptyState({ icon: Icon, title, description, actionLabel, actionHref }: {\n  icon: typeof LibraryIcon;\n  title: string;\n  description: string;\n  actionLabel?: string;\n  actionHref?: string;\n}) {\n  return (\n    <div className=\"text-center py-16 border border-dashed rounded-lg\">\n      <Icon className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n      <p className=\"text-muted-foreground mb-2 font-medium\">{title}</p>\n      <p className=\"text-sm text-muted-foreground mb-4\">{description}</p>\n      {actionLabel && actionHref && (\n        <Link href={actionHref}>\n          <Button data-testid=\"button-explore\">{actionLabel}</Button>\n        </Link>\n      )}\n    </div>\n  );\n}\n\nfunction LoadingSkeleton() {\n  return (\n    <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n      {Array.from({ length: 6 }).map((_, i) => (\n        <Card key={i} className=\"overflow-hidden\">\n          <Skeleton className=\"aspect-square\" />\n          <CardContent className=\"p-4 space-y-2\">\n            <Skeleton className=\"h-5 w-3/4\" />\n            <Skeleton className=\"h-4 w-1/2\" />\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}\n\nexport default function Library() {\n  const { toast } = useToast();\n  const [copiedFeed, setCopiedFeed] = useState(false);\n\n  const { data: favorites = [], isLoading: loadingFavorites } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/library/favorites\"],\n  });\n\n  const { data: purchases = [], isLoading: loadingPurchases } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/library/purchases\"],\n  });\n\n  const { data: subscriptionData } = useQuery<{\n    subscription: UserSubscription | null;\n    plan: SubscriptionPlan | null;\n  }>({\n    queryKey: [\"/api/user/subscription\"],\n  });\n\n  const { data: invoices = [], isLoading: loadingInvoices } = useQuery<Invoice[]>({\n    queryKey: [\"/api/user/invoices\"],\n  });\n\n  const { data: rssTokenData, isLoading: loadingRssToken } = useQuery<{ token: RssFeedToken | null }>({\n    queryKey: [\"/api/user/rss-token\"],\n  });\n\n  const generateRssTokenMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", \"/api/user/rss-token\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/rss-token\"] });\n      toast({\n        title: \"Token generado\",\n        description: \"Tu nuevo enlace RSS ha sido creado\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo generar el token RSS\",\n      });\n    },\n  });\n\n  const getFeedUrl = () => {\n    if (!rssTokenData?.token?.token) return \"\";\n    return `${window.location.origin}/feed/${rssTokenData.token.token}`;\n  };\n\n  const copyFeedUrl = async () => {\n    const url = getFeedUrl();\n    if (url) {\n      await navigator.clipboard.writeText(url);\n      setCopiedFeed(true);\n      setTimeout(() => setCopiedFeed(false), 2000);\n      toast({\n        title: \"Copiado\",\n        description: \"El enlace RSS ha sido copiado al portapapeles\",\n      });\n    }\n  };\n\n  const handleDownloadInvoice = async (invoiceId: string) => {\n    try {\n      window.open(`/api/invoices/${invoiceId}/download`, '_blank');\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo descargar la factura\",\n      });\n    }\n  };\n\n  const handleRemoveFavorite = async (audiobookId: string) => {\n    try {\n      await apiRequest(\"DELETE\", `/api/audiobooks/${audiobookId}/favorite`);\n      toast({\n        title: \"Eliminado de favoritos\",\n        description: \"El audiolibro se ha eliminado de tus favoritos\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/library/favorites\"] });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo eliminar de favoritos\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"max-w-7xl mx-auto px-6 py-12\">\n          <h1 className=\"font-serif text-4xl font-bold mb-3\" data-testid=\"text-page-title\">\n            Mi Biblioteca\n          </h1>\n          <p className=\"text-lg text-muted-foreground max-w-2xl\">\n            Tus audiolibros favoritos y comprados en un solo lugar\n          </p>\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto px-6 py-8\">\n        <Tabs defaultValue=\"favorites\" className=\"w-full\">\n          <TabsList className=\"mb-8\">\n            <TabsTrigger value=\"favorites\" className=\"gap-2\" data-testid=\"tab-favorites\">\n              <Heart className=\"w-4 h-4\" />\n              Favoritos\n              {favorites.length > 0 && (\n                <Badge variant=\"secondary\" className=\"ml-1\">\n                  {favorites.length}\n                </Badge>\n              )}\n            </TabsTrigger>\n            <TabsTrigger value=\"purchases\" className=\"gap-2\" data-testid=\"tab-purchases\">\n              <ShoppingBag className=\"w-4 h-4\" />\n              Comprados\n              {purchases.length > 0 && (\n                <Badge variant=\"secondary\" className=\"ml-1\">\n                  {purchases.length}\n                </Badge>\n              )}\n            </TabsTrigger>\n            <TabsTrigger value=\"subscription\" className=\"gap-2\" data-testid=\"tab-subscription\">\n              <Crown className=\"w-4 h-4\" />\n              Suscripcion\n            </TabsTrigger>\n            <TabsTrigger value=\"billing\" className=\"gap-2\" data-testid=\"tab-billing\">\n              <Receipt className=\"w-4 h-4\" />\n              Facturacion\n              {invoices.length > 0 && (\n                <Badge variant=\"secondary\" className=\"ml-1\">\n                  {invoices.length}\n                </Badge>\n              )}\n            </TabsTrigger>\n            <TabsTrigger value=\"podcast\" className=\"gap-2\" data-testid=\"tab-podcast\">\n              <Rss className=\"w-4 h-4\" />\n              Podcast\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"favorites\">\n            {loadingFavorites ? (\n              <LoadingSkeleton />\n            ) : favorites.length === 0 ? (\n              <EmptyState\n                icon={Heart}\n                title=\"No tienes favoritos\"\n                description=\"Los audiolibros que marques como favoritos apareceran aqui\"\n                actionLabel=\"Explorar audiolibros\"\n                actionHref=\"/explore\"\n              />\n            ) : (\n              <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n                {favorites.map((audiobook) => (\n                  <AudiobookCard\n                    key={audiobook.id}\n                    audiobook={audiobook}\n                    onRemoveFavorite={handleRemoveFavorite}\n                  />\n                ))}\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"purchases\">\n            {loadingPurchases ? (\n              <LoadingSkeleton />\n            ) : purchases.length === 0 ? (\n              <EmptyState\n                icon={ShoppingBag}\n                title=\"No has comprado audiolibros\"\n                description=\"Los audiolibros que compres apareceran aqui para siempre\"\n                actionLabel=\"Ver catalogo\"\n                actionHref=\"/explore\"\n              />\n            ) : (\n              <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n                {purchases.map((audiobook) => (\n                  <AudiobookCard key={audiobook.id} audiobook={audiobook} />\n                ))}\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"subscription\">\n            {subscriptionData?.subscription?.status === \"ACTIVE\" ? (\n              <Card className=\"p-8\">\n                <div className=\"flex flex-col md:flex-row items-center gap-6\">\n                  <div className=\"flex-shrink-0\">\n                    <div className=\"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center\">\n                      <Crown className=\"w-10 h-10 text-primary\" />\n                    </div>\n                  </div>\n                  <div className=\"flex-1 text-center md:text-left\">\n                    <Badge variant=\"secondary\" className=\"mb-2\">Activa</Badge>\n                    <h2 className=\"font-serif text-2xl font-bold mb-1\">\n                      {subscriptionData.plan?.name || \"Suscripcion Premium\"}\n                    </h2>\n                    <p className=\"text-muted-foreground\">\n                      Tienes acceso completo a todo el catalogo de audiolibros\n                    </p>\n                  </div>\n                  <div className=\"flex flex-col gap-2\">\n                    <Link href=\"/explore\">\n                      <Button className=\"gap-2 w-full\">\n                        <LibraryIcon className=\"w-4 h-4\" />\n                        Explorar catalogo\n                      </Button>\n                    </Link>\n                  </div>\n                </div>\n              </Card>\n            ) : (\n              <Card className=\"p-8 text-center\">\n                <Crown className=\"w-16 h-16 mx-auto text-accent mb-4\" />\n                <h2 className=\"font-serif text-2xl font-bold mb-2\">Suscripcion Premium</h2>\n                <p className=\"text-muted-foreground mb-6 max-w-md mx-auto\">\n                  Accede a todo el catalogo de audiolibros con una suscripcion mensual. Cancela cuando quieras.\n                </p>\n                <Link href=\"/subscriptions\">\n                  <Button size=\"lg\" className=\"gap-2\" data-testid=\"button-view-plans\">\n                    <Crown className=\"w-5 h-5\" />\n                    Ver planes de suscripcion\n                  </Button>\n                </Link>\n              </Card>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"billing\">\n            <div className=\"space-y-8\">\n              <Card className=\"p-6\">\n                <h2 className=\"font-serif text-xl font-bold mb-4 flex items-center gap-2\">\n                  <FileText className=\"w-5 h-5\" />\n                  Datos de facturacion\n                </h2>\n                <p className=\"text-muted-foreground mb-6\">\n                  Completa tu informacion de facturacion para recibir facturas con tus datos fiscales.\n                </p>\n                <BillingProfileForm />\n              </Card>\n\n              <Card className=\"p-6\">\n                <h2 className=\"font-serif text-xl font-bold mb-4 flex items-center gap-2\">\n                  <Receipt className=\"w-5 h-5\" />\n                  Historial de facturas\n                </h2>\n                {loadingInvoices ? (\n                  <div className=\"space-y-3\">\n                    {Array.from({ length: 3 }).map((_, i) => (\n                      <div key={i} className=\"flex items-center justify-between p-4 border rounded-lg\">\n                        <div className=\"space-y-2\">\n                          <Skeleton className=\"h-4 w-32\" />\n                          <Skeleton className=\"h-3 w-24\" />\n                        </div>\n                        <Skeleton className=\"h-9 w-24\" />\n                      </div>\n                    ))}\n                  </div>\n                ) : invoices.length === 0 ? (\n                  <div className=\"text-center py-8 border border-dashed rounded-lg\">\n                    <Receipt className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                    <p className=\"text-muted-foreground mb-2 font-medium\">No tienes facturas</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Las facturas de tus compras y suscripciones apareceran aqui\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {invoices.map((invoice) => (\n                      <div\n                        key={invoice.id}\n                        className=\"flex items-center justify-between p-4 border rounded-lg hover-elevate\"\n                        data-testid={`row-invoice-${invoice.id}`}\n                      >\n                        <div className=\"flex items-center gap-4\">\n                          <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                            <FileText className=\"w-5 h-5 text-primary\" />\n                          </div>\n                          <div>\n                            <p className=\"font-medium\">{invoice.invoiceNumber}</p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {new Date(invoice.issueDate).toLocaleDateString('es-ES')}\n                              {' - '}\n                              <Badge variant=\"secondary\" className=\"text-xs\">\n                                {invoice.type === 'PURCHASE' ? 'Compra' : 'Suscripcion'}\n                              </Badge>\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-4\">\n                          <p className=\"font-semibold\">\n                            {(invoice.totalCents / 100).toFixed(2)} {invoice.currency}\n                          </p>\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            className=\"gap-2\"\n                            onClick={() => handleDownloadInvoice(invoice.id)}\n                            data-testid={`button-download-invoice-${invoice.id}`}\n                          >\n                            <Download className=\"w-4 h-4\" />\n                            Descargar\n                          </Button>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </Card>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"podcast\">\n            <Card className=\"p-6\">\n              <div className=\"flex items-start gap-4 mb-6\">\n                <div className=\"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                  <Smartphone className=\"w-6 h-6 text-primary\" />\n                </div>\n                <div>\n                  <h2 className=\"font-serif text-xl font-bold mb-2\">Escucha en tu app favorita</h2>\n                  <p className=\"text-muted-foreground\">\n                    Usa aplicaciones como AntennaPod, Pocket Casts o cualquier lector de podcasts para escuchar tus audiolibros en tu movil, incluso sin conexion.\n                  </p>\n                </div>\n              </div>\n\n              {loadingRssToken ? (\n                <div className=\"space-y-3\">\n                  <Skeleton className=\"h-10 w-full\" />\n                  <Skeleton className=\"h-9 w-32\" />\n                </div>\n              ) : rssTokenData?.token ? (\n                <div className=\"space-y-4\">\n                  <div>\n                    <label className=\"text-sm font-medium mb-2 block\">Tu enlace RSS privado</label>\n                    <div className=\"flex gap-2\">\n                      <Input\n                        value={getFeedUrl()}\n                        readOnly\n                        className=\"font-mono text-sm\"\n                        data-testid=\"input-rss-url\"\n                      />\n                      <Button\n                        variant=\"outline\"\n                        size=\"icon\"\n                        onClick={copyFeedUrl}\n                        data-testid=\"button-copy-rss\"\n                      >\n                        {copiedFeed ? <Check className=\"w-4 h-4\" /> : <Copy className=\"w-4 h-4\" />}\n                      </Button>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-2\">\n                      Copia este enlace y pegalo en tu app de podcasts para sincronizar tu biblioteca.\n                    </p>\n                  </div>\n\n                  <div className=\"flex flex-wrap gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => generateRssTokenMutation.mutate()}\n                      disabled={generateRssTokenMutation.isPending}\n                      className=\"gap-2\"\n                      data-testid=\"button-regenerate-rss\"\n                    >\n                      <RefreshCw className={`w-4 h-4 ${generateRssTokenMutation.isPending ? 'animate-spin' : ''}`} />\n                      Regenerar enlace\n                    </Button>\n                  </div>\n\n                  <div className=\"border-t pt-4 mt-4\">\n                    <h3 className=\"font-medium mb-4\">Descarga una app de podcasts</h3>\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6\">\n                      <div className=\"border rounded-lg p-4 text-center\">\n                        <div className=\"flex items-center justify-center gap-2 mb-3\">\n                          <SiAndroid className=\"w-5 h-5 text-[#3DDC84]\" />\n                          <span className=\"font-medium\">Android</span>\n                        </div>\n                        <div className=\"bg-white p-3 rounded-lg inline-block mb-3\">\n                          <QRCodeSVG\n                            value={ANTENNAPOD_ANDROID_URL}\n                            size={120}\n                            level=\"M\"\n                          />\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">AntennaPod</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Gratis y de codigo abierto</p>\n                      </div>\n                      <div className=\"border rounded-lg p-4 text-center\">\n                        <div className=\"flex items-center justify-center gap-2 mb-3\">\n                          <SiApple className=\"w-5 h-5\" />\n                          <span className=\"font-medium\">iPhone / iPad</span>\n                        </div>\n                        <div className=\"bg-white p-3 rounded-lg inline-block mb-3\">\n                          <QRCodeSVG\n                            value={APPLE_PODCASTS_URL}\n                            size={120}\n                            level=\"M\"\n                          />\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">Apple Podcasts</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Incluida en tu dispositivo</p>\n                      </div>\n                    </div>\n\n                    <h3 className=\"font-medium mb-3\">Como configurarlo</h3>\n                    <ol className=\"list-decimal list-inside space-y-2 text-sm text-muted-foreground\">\n                      <li>Escanea el codigo QR con la camara de tu movil para descargar la app</li>\n                      <li>Abre la app y busca \"Agregar podcast por URL\" o \"Agregar feed\"</li>\n                      <li>Copia y pega el enlace RSS de arriba</li>\n                      <li>Tus audiolibros apareceran como episodios listos para escuchar</li>\n                    </ol>\n                  </div>\n\n                  <div className=\"bg-muted/50 rounded-lg p-4 mt-4\">\n                    <div className=\"flex items-start gap-3\">\n                      <Rss className=\"w-5 h-5 text-muted-foreground flex-shrink-0 mt-0.5\" />\n                      <div className=\"text-sm\">\n                        <p className=\"font-medium mb-1\">Que incluye tu feed</p>\n                        <p className=\"text-muted-foreground\">\n                          Todos los audiolibros que hayas comprado, los gratuitos, y si tienes suscripcion activa, el catalogo completo.\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 border border-dashed rounded-lg\">\n                  <Rss className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                  <p className=\"text-muted-foreground mb-2 font-medium\">No tienes un enlace RSS</p>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    Genera un enlace para sincronizar tu biblioteca con apps de podcasts\n                  </p>\n                  <Button\n                    onClick={() => generateRssTokenMutation.mutate()}\n                    disabled={generateRssTokenMutation.isPending}\n                    className=\"gap-2\"\n                    data-testid=\"button-generate-rss\"\n                  >\n                    {generateRssTokenMutation.isPending ? (\n                      <RefreshCw className=\"w-4 h-4 animate-spin\" />\n                    ) : (\n                      <Rss className=\"w-4 h-4\" />\n                    )}\n                    Generar enlace RSS\n                  </Button>\n                </div>\n              )}\n            </Card>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":24837,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"server/routes.ts":{"content":"import express, { type Express, type Request, type Response, type NextFunction } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { insertPodcastSchema, insertEpisodeSchema, registerSchema, loginSchema, youtubeImportSchema, localImportSchema, insertPlaylistSchema, insertAudiobookSchema, insertChapterSchema, insertSubscriptionPlanSchema } from \"@shared/schema\";\nimport { \n  updateUserRoleSchema, \n  updateUserApprovalSchema, \n  updateUserActiveSchema,\n  updatePodcastStatusSchema,\n  updateEpisodeStatusSchema,\n  adminPodcastsQuerySchema,\n  adminEpisodesQuerySchema,\n  createEmailConfigSchema,\n  updateEmailConfigSchema,\n  bulkDeleteUsersSchema,\n  bulkUpdateUsersRoleSchema,\n  bulkUpdateUsersActiveSchema,\n  bulkDeletePodcastsSchema,\n  bulkUpdatePodcastsStatusSchema,\n  bulkDeleteEpisodesSchema,\n  bulkUpdateEpisodesStatusSchema,\n} from \"@shared/admin-schemas\";\nimport { generateRSSFeed } from \"./rss-generator\";\nimport { getSiteUrl, getEpisodeCanonicalUrl, getEpisodeEmbedUrl, getEpisodeShareUrl, getEmbedIframeCode } from \"./url-helpers\";\nimport { resolveEpisodeArtwork, resolveEpisodeAudioUrl, resolvePodcastCoverArtUrl } from \"./serializers/episode\";\nimport { getEpisodeForResponse } from \"./storage-service\";\nimport { z } from \"zod\";\nimport bcrypt from \"bcryptjs\";\nimport crypto from \"crypto\";\nimport multer from \"multer\";\nimport { mediaOrchestrator } from \"./media-orchestrator\";\nimport { StorageService } from \"./storage-service\";\nimport { getEmailService } from \"./email\";\nimport { \n  getPlaylistMetadata, \n  getPlaylistVideos, \n  downloadAudioFromVideo, \n  downloadThumbnail,\n  uploadAudioToStorage,\n  uploadImageToStorage,\n  cleanupTempFiles\n} from \"./youtube-import\";\nimport path from \"path\";\nimport os from \"os\";\nimport fs from \"fs\";\nimport { parseFile, parseBuffer } from \"music-metadata\";\nimport { updateMP3MetadataBuffer } from \"./id3-utils\";\nimport * as paypalService from \"./paypal-service\";\nimport { invoiceService } from \"./invoice-service\";\nimport { insertBillingProfileSchema, type Invoice } from \"@shared/schema\";\n\n// Helper functions for RSS feed generation\nfunction escapeXml(str: string): string {\n  return str\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n}\n\nfunction formatDurationForRss(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  const secs = seconds % 60;\n  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n}\n\n// Middleware to require authentication\nexport async function requireAuth(req: Request, res: Response, next: NextFunction) {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Unauthorized - Please login\" });\n  }\n  \n  try {\n    // Check if user is active\n    const user = await storage.getUser(req.session.userId);\n    if (!user || !user.isActive) {\n      // User is deactivated, destroy session and clear cookie\n      req.session.destroy(() => {});\n      res.clearCookie(\"connect.sid\");\n      return res.status(403).json({ error: \"Forbidden - Account deactivated\" });\n    }\n    next();\n  } catch (error) {\n    console.error(\"Error checking user status:\", error);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n\n// Middleware to require admin role\nexport async function requireAdmin(req: Request, res: Response, next: NextFunction) {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Unauthorized - Please login\" });\n  }\n  \n  try {\n    const user = await storage.getUser(req.session.userId);\n    if (!user || user.role !== \"ADMIN\") {\n      return res.status(403).json({ error: \"Forbidden - Admin access required\" });\n    }\n    next();\n  } catch (error) {\n    console.error(\"Error checking admin role:\", error);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n\n// Multer configuration for regular file uploads (images, single audio)\nconst upload = multer({\n  storage: multer.memoryStorage(),\n  limits: {\n    fileSize: 500 * 1024 * 1024, // 500MB max (for audio files)\n  },\n  fileFilter: (req, file, cb) => {\n    // Allow images and audio files\n    const allowedImageMimes = ['image/jpeg', 'image/png', 'image/webp'];\n    const allowedAudioMimes = ['audio/mpeg', 'audio/mp3', 'audio/mp4', 'audio/x-m4a', 'audio/wav', 'audio/x-wav'];\n    const allAllowedMimes = [...allowedImageMimes, ...allowedAudioMimes];\n\n    if (allAllowedMimes.includes(file.mimetype)) {\n      cb(null, true);\n    } else {\n      cb(new Error(`Invalid file type. Allowed: ${allAllowedMimes.join(', ')}`));\n    }\n  },\n});\n\n// Multer configuration for bulk local import (disk-based to avoid RAM exhaustion)\nconst uploadLocalImport = multer({\n  storage: multer.diskStorage({\n    destination: (req, file, cb) => {\n      // Use /tmp directory for temporary storage\n      cb(null, os.tmpdir());\n    },\n    filename: (req, file, cb) => {\n      // Generate unique filename to avoid collisions\n      const uniqueSuffix = `${Date.now()}-${Math.round(Math.random() * 1E9)}`;\n      cb(null, `${file.fieldname}-${uniqueSuffix}-${file.originalname}`);\n    },\n  }),\n  limits: {\n    fileSize: 500 * 1024 * 1024, // 500MB per file\n    files: 51, // Max 50 audio files + 1 cover art\n  },\n  fileFilter: (req, file, cb) => {\n    if (file.fieldname === 'audioFiles') {\n      // Only allow MP3 for audio files\n      const allowedAudioMimes = ['audio/mpeg', 'audio/mp3'];\n      if (allowedAudioMimes.includes(file.mimetype) || file.originalname.toLowerCase().endsWith('.mp3')) {\n        cb(null, true);\n      } else {\n        cb(new Error('Only MP3 audio files are allowed'));\n      }\n    } else if (file.fieldname === 'coverArt') {\n      // Allow images for cover art\n      const allowedImageMimes = ['image/jpeg', 'image/png', 'image/webp'];\n      if (allowedImageMimes.includes(file.mimetype)) {\n        cb(null, true);\n      } else {\n        cb(new Error('Only JPEG, PNG, or WebP images are allowed for cover art'));\n      }\n    } else {\n      cb(new Error('Unexpected field'));\n    }\n  },\n});\n\n// Multer configuration for single audio file replacement (disk-based)\nconst uploadSingleAudio = multer({\n  storage: multer.diskStorage({\n    destination: (req, file, cb) => {\n      cb(null, os.tmpdir());\n    },\n    filename: (req, file, cb) => {\n      const uniqueSuffix = `${Date.now()}-${Math.round(Math.random() * 1E9)}`;\n      cb(null, `audioFile-${uniqueSuffix}-${file.originalname}`);\n    },\n  }),\n  limits: {\n    fileSize: 500 * 1024 * 1024, // 500MB max\n  },\n  fileFilter: (req, file, cb) => {\n    const allowedAudioMimes = ['audio/mpeg', 'audio/mp3'];\n    if (allowedAudioMimes.includes(file.mimetype) || file.originalname.toLowerCase().endsWith('.mp3')) {\n      cb(null, true);\n    } else {\n      cb(new Error('Solo se permiten archivos MP3'));\n    }\n  },\n});\n\n// Multer configuration for ZIP import\nconst uploadZip = multer({\n  storage: multer.diskStorage({\n    destination: (req, file, cb) => {\n      cb(null, os.tmpdir());\n    },\n    filename: (req, file, cb) => {\n      const uniqueSuffix = `${Date.now()}-${Math.round(Math.random() * 1E9)}`;\n      cb(null, `import-${uniqueSuffix}.zip`);\n    },\n  }),\n  limits: {\n    fileSize: 1024 * 1024 * 1024, // 1GB max for ZIP\n  },\n  fileFilter: (req, file, cb) => {\n    if (file.mimetype === 'application/zip' || file.mimetype === 'application/x-zip-compressed' || file.originalname.toLowerCase().endsWith('.zip')) {\n      cb(null, true);\n    } else {\n      cb(new Error('Solo se permiten archivos ZIP'));\n    }\n  },\n});\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Multer error handling middleware - must be registered after upload routes\n  const handleMulterError = (error: any, req: Request, res: Response, next: NextFunction) => {\n    if (error instanceof multer.MulterError) {\n      if (error.code === 'LIMIT_FILE_SIZE') {\n        return res.status(413).json({ error: 'File too large. Images must be â‰¤2MB, audio files â‰¤500MB.' });\n      }\n      if (error.code === 'LIMIT_UNEXPECTED_FILE') {\n        return res.status(400).json({ error: 'Unexpected field name in upload.' });\n      }\n      return res.status(400).json({ error: `Upload error: ${error.message}` });\n    }\n    \n    // Handle custom file filter errors\n    if (error.message && error.message.startsWith('Invalid file type')) {\n      return res.status(400).json({ error: error.message });\n    }\n    \n    // Pass to next error handler\n    next(error);\n  };\n\n  // ==================== AUTH ROUTES ====================\n  \n  // Register new user\n  app.post(\"/api/auth/register\", async (req, res) => {\n    try {\n      const validatedData = registerSchema.parse(req.body);\n      \n      // Check if user already exists\n      const existingUser = await storage.getUserByEmail(validatedData.email);\n      if (existingUser) {\n        return res.status(400).json({ error: \"User already exists with this email\" });\n      }\n\n      const existingUsername = await storage.getUserByUsername(validatedData.username);\n      if (existingUsername) {\n        return res.status(400).json({ error: \"Username already taken\" });\n      }\n\n      // Hash password\n      const passwordHash = await bcrypt.hash(validatedData.password, 10);\n      \n      // Generate email verification token (valid for 24 hours)\n      const verificationToken = await bcrypt.hash(`${validatedData.email}-${Date.now()}`, 10);\n      const verificationExpiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\n      \n      // Create user\n      const user = await storage.createUser({\n        ...validatedData,\n        passwordHash,\n        emailVerificationToken: verificationToken,\n        emailVerificationTokenExpiresAt: verificationExpiresAt,\n      });\n\n      // Set session\n      req.session.userId = user.id;\n      \n      // Send verification email\n      try {\n        const emailService = await getEmailService(storage);\n        const verificationUrl = `${getSiteUrl(req)}/verify-email?token=${encodeURIComponent(verificationToken)}`;\n        await emailService.sendEmailVerification(user.email, user.username, verificationUrl);\n        console.log(`Verification email sent to ${user.email}`);\n        console.log(`Verification URL: ${verificationUrl}`);\n      } catch (emailError) {\n        // Log error but don't fail registration\n        console.error(`Failed to send verification email to ${user.email}:`, emailError);\n      }\n      \n      // Don't send password hash to client\n      const { passwordHash: _, ...userWithoutPassword } = user;\n      res.status(201).json(userWithoutPassword);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error registering user:\", error);\n      res.status(500).json({ error: \"Failed to register user\" });\n    }\n  });\n\n  // Login\n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      const { email, password } = loginSchema.parse(req.body);\n      \n      // Find user\n      const user = await storage.getUserByEmail(email);\n      if (!user) {\n        return res.status(401).json({ error: \"Invalid email or password\" });\n      }\n\n      // Verify password\n      const isValidPassword = await bcrypt.compare(password, user.passwordHash);\n      if (!isValidPassword) {\n        return res.status(401).json({ error: \"Invalid email or password\" });\n      }\n\n      // Set session\n      req.session.userId = user.id;\n      \n      // Don't send password hash to client\n      const { passwordHash: _, ...userWithoutPassword } = user;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error logging in:\", error);\n      res.status(500).json({ error: \"Failed to login\" });\n    }\n  });\n\n  // Logout\n  app.post(\"/api/auth/logout\", (req, res) => {\n    req.session.destroy((err) => {\n      if (err) {\n        console.error(\"Error destroying session:\", err);\n        return res.status(500).json({ error: \"Failed to logout\" });\n      }\n      res.clearCookie(\"connect.sid\");\n      res.json({ message: \"Logged out successfully\" });\n    });\n  });\n\n  // Get current user\n  app.get(\"/api/auth/me\", async (req, res) => {\n    if (!req.session.userId) {\n      return res.status(401).json({ error: \"Not authenticated\" });\n    }\n\n    try {\n      const user = await storage.getUser(req.session.userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      const { passwordHash: _, ...userWithoutPassword } = user;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      console.error(\"Error fetching current user:\", error);\n      res.status(500).json({ error: \"Failed to fetch user\" });\n    }\n  });\n\n  // ==================== PROFILE ROUTES ====================\n  \n  // Get user profile\n  app.get(\"/api/profile\", requireAuth, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.session.userId!);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      const { passwordHash: _, ...userWithoutPassword } = user;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      console.error(\"Error fetching profile:\", error);\n      res.status(500).json({ error: \"Failed to fetch profile\" });\n    }\n  });\n\n  // Get user invoices\n  app.get(\"/api/my-invoices\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const invoicesData = await storage.getUserInvoices(userId);\n      res.json(invoicesData);\n    } catch (error) {\n      console.error(\"Error fetching user invoices:\", error);\n      res.status(500).json({ error: \"Failed to fetch invoices\" });\n    }\n  });\n\n  // Update user profile\n  app.patch(\"/api/profile\", requireAuth, async (req, res) => {\n    try {\n      const updateSchema = z.object({\n        username: z.string().min(3).max(50).optional(),\n        email: z.string().email().optional(),\n        bio: z.string().max(500).optional(),\n        avatarUrl: z.string().url().optional().or(z.literal(\"\")),\n        website: z.string().url().optional().or(z.literal(\"\")),\n      });\n\n      const validatedData = updateSchema.parse(req.body);\n\n      // Check if username or email already exists (if being updated)\n      if (validatedData.username) {\n        const existingUser = await storage.getUserByUsername(validatedData.username);\n        if (existingUser && existingUser.id !== req.session.userId) {\n          return res.status(400).json({ error: \"Username already taken\" });\n        }\n      }\n\n      if (validatedData.email) {\n        const existingUser = await storage.getUserByEmail(validatedData.email);\n        if (existingUser && existingUser.id !== req.session.userId) {\n          return res.status(400).json({ error: \"Email already in use\" });\n        }\n      }\n\n      const updatedUser = await storage.updateUserProfile(req.session.userId!, validatedData);\n      const { passwordHash: _, ...userWithoutPassword } = updatedUser;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error updating profile:\", error);\n      res.status(500).json({ error: \"Failed to update profile\" });\n    }\n  });\n\n  // Change password\n  app.patch(\"/api/profile/password\", requireAuth, async (req, res) => {\n    try {\n      const passwordSchema = z.object({\n        currentPassword: z.string().min(1, \"Current password is required\"),\n        newPassword: z.string().min(8, \"New password must be at least 8 characters\"),\n      });\n\n      const validatedData = passwordSchema.parse(req.body);\n\n      // Verify current password\n      const user = await storage.getUser(req.session.userId!);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      const isValidPassword = await bcrypt.compare(validatedData.currentPassword, user.passwordHash);\n      if (!isValidPassword) {\n        return res.status(401).json({ error: \"Current password is incorrect\" });\n      }\n\n      // Hash new password and update\n      const newPasswordHash = await bcrypt.hash(validatedData.newPassword, 10);\n      await storage.updateUserPassword(req.session.userId!, newPasswordHash);\n\n      res.json({ message: \"Password updated successfully\" });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error changing password:\", error);\n      res.status(500).json({ error: \"Failed to change password\" });\n    }\n  });\n\n  // Request password reset\n  app.post(\"/api/auth/forgot-password\", async (req, res) => {\n    try {\n      const schema = z.object({\n        email: z.string().email(\"Invalid email address\"),\n      });\n\n      const { email } = schema.parse(req.body);\n\n      const user = await storage.getUserByEmail(email);\n      // Always return success even if user doesn't exist (security best practice)\n      if (!user) {\n        return res.json({ message: \"If an account exists with that email, a password reset link has been sent.\" });\n      }\n\n      // Generate reset token\n      const resetToken = crypto.randomBytes(32).toString(\"hex\");\n      const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hour from now\n\n      // Save token to database\n      await storage.createPasswordResetToken({\n        token: resetToken,\n        userId: user.id,\n        expiresAt,\n      });\n\n      // Send password reset email\n      const resetUrl = `${getSiteUrl(req)}/reset-password?token=${resetToken}`;\n      \n      try {\n        const emailService = await getEmailService(storage);\n        await emailService.sendPasswordResetEmail(user.email, user.username, resetUrl);\n        console.log(`Password reset email sent to ${email}`);\n      } catch (emailError) {\n        // Log error but don't fail the request (for security, don't reveal if email failed)\n        console.error(`Failed to send password reset email to ${email}:`, emailError);\n        // Still log the reset URL for development/debugging\n        console.log(`Reset URL (email failed): ${resetUrl}`);\n      }\n\n      res.json({ message: \"If an account exists with that email, a password reset link has been sent.\" });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error requesting password reset:\", error);\n      res.status(500).json({ error: \"Failed to process password reset request\" });\n    }\n  });\n\n  // Reset password with token\n  app.post(\"/api/auth/reset-password\", async (req, res) => {\n    try {\n      const schema = z.object({\n        token: z.string().min(1, \"Token is required\"),\n        newPassword: z.string().min(8, \"Password must be at least 8 characters\"),\n      });\n\n      const { token, newPassword } = schema.parse(req.body);\n\n      // Get token from database\n      const resetToken = await storage.getPasswordResetToken(token);\n      if (!resetToken) {\n        return res.status(400).json({ error: \"Invalid or expired reset token\" });\n      }\n\n      // Check if token is expired\n      if (resetToken.expiresAt < new Date()) {\n        return res.status(400).json({ error: \"Reset token has expired\" });\n      }\n\n      // Check if token has already been used\n      if (resetToken.usedAt) {\n        return res.status(400).json({ error: \"Reset token has already been used\" });\n      }\n\n      // Hash new password and update user\n      const passwordHash = await bcrypt.hash(newPassword, 10);\n      await storage.updateUserPassword(resetToken.userId, passwordHash);\n\n      // Mark token as used\n      await storage.markPasswordResetTokenUsed(token);\n\n      res.json({ message: \"Password reset successfully\" });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error resetting password:\", error);\n      res.status(500).json({ error: \"Failed to reset password\" });\n    }\n  });\n\n  // Verify email with token\n  app.post(\"/api/auth/verify-email\", async (req, res) => {\n    try {\n      const schema = z.object({\n        token: z.string().min(1, \"Token is required\"),\n      });\n\n      const { token } = schema.parse(req.body);\n\n      // Find user by verification token\n      const user = await storage.getUserByVerificationToken(token);\n      if (!user) {\n        return res.status(400).json({ error: \"Invalid or expired verification token\" });\n      }\n\n      // Check if token is expired\n      if (user.emailVerificationTokenExpiresAt && user.emailVerificationTokenExpiresAt < new Date()) {\n        return res.status(400).json({ error: \"Verification token has expired\" });\n      }\n\n      // Check if email is already verified\n      if (user.emailVerified) {\n        return res.json({ message: \"Email already verified\" });\n      }\n\n      // Mark email as verified and clear token\n      await storage.verifyUserEmail(user.id);\n\n      res.json({ message: \"Email verified successfully\" });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error verifying email:\", error);\n      res.status(500).json({ error: \"Failed to verify email\" });\n    }\n  });\n\n  // Resend verification email\n  app.post(\"/api/auth/resend-verification\", requireAuth, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.session.userId!);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      // Check if already verified\n      if (user.emailVerified) {\n        return res.status(400).json({ error: \"Email is already verified\" });\n      }\n\n      // Generate new verification token (valid for 24 hours)\n      const verificationToken = await bcrypt.hash(`${user.email}-${Date.now()}`, 10);\n      const verificationExpiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\n\n      // Update user with new token\n      await storage.updateUserVerificationToken(user.id, verificationToken, verificationExpiresAt);\n\n      // Send verification email\n      try {\n        const emailService = await getEmailService(storage);\n        const verificationUrl = `${getSiteUrl(req)}/verify-email?token=${encodeURIComponent(verificationToken)}`;\n        await emailService.sendEmailVerification(user.email, user.username, verificationUrl);\n        console.log(`Verification email resent to ${user.email}`);\n        console.log(`Verification URL: ${verificationUrl}`);\n      } catch (emailError) {\n        console.error(`Failed to resend verification email to ${user.email}:`, emailError);\n        return res.status(500).json({ error: \"Failed to send verification email\" });\n      }\n\n      res.json({ message: \"Verification email sent\" });\n    } catch (error) {\n      console.error(\"Error resending verification email:\", error);\n      res.status(500).json({ error: \"Failed to resend verification email\" });\n    }\n  });\n\n  // ==================== UPLOAD ROUTES ====================\n  \n  // Upload cover art image (protected - requires authentication)\n  app.post(\"/api/uploads/cover\", requireAuth, upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file provided\" });\n      }\n\n      // Validate file type is image\n      const allowedImageMimes = ['image/jpeg', 'image/png', 'image/webp'];\n      if (!allowedImageMimes.includes(req.file.mimetype)) {\n        return res.status(400).json({ error: \"Invalid file type. Only JPEG, PNG, and WebP images are allowed.\" });\n      }\n\n      // Validate file size (2MB for images)\n      const maxImageSize = 2 * 1024 * 1024; // 2MB\n      if (req.file.size > maxImageSize) {\n        return res.status(400).json({ error: \"File too large. Maximum size for images is 2MB.\" });\n      }\n\n      // Optional: podcastId from query/body for linking\n      const podcastId = req.body.podcastId || req.query.podcastId as string | undefined;\n\n      // Save file using media orchestrator\n      const asset = await mediaOrchestrator.saveCoverArt(req.file, req.session.userId!, podcastId);\n\n      res.status(201).json({\n        id: asset.id,\n        assetId: asset.id, // Add assetId for frontend compatibility\n        publicUrl: asset.publicUrl,\n        storageProvider: asset.storageProvider,\n        mimeType: asset.mimeType,\n        sizeBytes: asset.sizeBytes,\n      });\n    } catch (error) {\n      console.error(\"Error uploading cover art:\", error);\n      res.status(500).json({ error: \"Failed to upload cover art\" });\n    }\n  });\n\n  // Upload episode audio (protected - requires authentication)\n  app.post(\"/api/uploads/audio\", requireAuth, upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file provided\" });\n      }\n\n      // Validate file type is audio\n      const allowedAudioMimes = ['audio/mpeg', 'audio/mp3', 'audio/mp4', 'audio/x-m4a', 'audio/wav', 'audio/x-wav'];\n      if (!allowedAudioMimes.includes(req.file.mimetype)) {\n        return res.status(400).json({ error: \"Invalid file type. Only MP3, M4A, and WAV audio files are allowed.\" });\n      }\n\n      // Validate file size (500MB for audio)\n      const maxAudioSize = 500 * 1024 * 1024; // 500MB\n      if (req.file.size > maxAudioSize) {\n        return res.status(400).json({ error: \"File too large. Maximum size for audio is 500MB.\" });\n      }\n\n      // Optional: episodeId and podcastId from query/body for linking\n      const episodeId = req.body.episodeId || req.query.episodeId as string | undefined;\n      const podcastId = req.body.podcastId || req.query.podcastId as string | undefined;\n\n      // Save file using media orchestrator\n      const asset = await mediaOrchestrator.saveEpisodeAudio(req.file, req.session.userId!, episodeId, podcastId);\n\n      // Extract duration from audio file\n      let duration = 0;\n      try {\n        const metadata = await parseBuffer(req.file.buffer, req.file.mimetype);\n        duration = Math.round(metadata.format.duration || 0);\n      } catch (metadataError) {\n        console.warn(`Could not extract duration from ${req.file.originalname}:`, metadataError);\n      }\n\n      res.status(201).json({\n        id: asset.id,\n        assetId: asset.id, // Add assetId for frontend compatibility\n        publicUrl: asset.publicUrl,\n        storageProvider: asset.storageProvider,\n        mimeType: asset.mimeType,\n        sizeBytes: asset.sizeBytes,\n        duration, // Add duration for frontend\n      });\n    } catch (error) {\n      console.error(\"Error uploading audio:\", error);\n      res.status(500).json({ error: \"Failed to upload audio\" });\n    }\n  });\n\n  // Serve static files from uploads directory\n  app.use(\"/media\", express.static(path.join(process.cwd(), \"uploads\")));\n\n  // Serve media files (supports both local storage and Google Drive) - fallback for database-tracked files\n  app.get(\"/media/:type/:filename\", async (req, res) => {\n    try {\n      const { type, filename } = req.params;\n      \n      // Validate type\n      if (type !== 'images' && type !== 'audio') {\n        return res.status(400).json({ error: \"Invalid media type\" });\n      }\n\n      // Construct storage key\n      const storageKey = `${type}/${filename}`;\n\n      // Look up asset in database\n      const asset = await storage.getMediaAssetByStorageKey(storageKey);\n      \n      if (!asset) {\n        return res.status(404).json({ error: \"File not found in database\" });\n      }\n\n      // Set content type from database\n      res.setHeader('Content-Type', asset.mimeType);\n      \n      // Use media orchestrator to stream the file (supports both LOCAL and GOOGLE_DRIVE)\n      try {\n        const { stream } = await mediaOrchestrator.streamMedia(asset.id);\n        \n        // Handle stream errors to prevent server crash\n        stream.on('error', (streamError) => {\n          console.error(`Stream error for asset ${asset.id}:`, streamError);\n          if (!res.headersSent) {\n            res.status(404).json({ error: \"File not found on storage\" });\n          }\n        });\n        \n        stream.pipe(res);\n      } catch (streamError: any) {\n        console.error(`Error streaming asset ${asset.id}:`, streamError);\n        if (!res.headersSent) {\n          return res.status(404).json({ error: \"File not found on storage\" });\n        }\n      }\n    } catch (error) {\n      console.error(\"Error serving media:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Failed to serve media\" });\n      }\n    }\n  });\n\n  // ==================== AUDIOBOOK ROUTES ====================\n  \n  // Get all audiobooks (public catalog)\n  app.get(\"/api/audiobooks\", async (req, res) => {\n    try {\n      const audiobooks = await storage.getPublicAudiobooks();\n      res.json(audiobooks);\n    } catch (error) {\n      console.error(\"Error fetching audiobooks:\", error);\n      res.status(500).json({ error: \"Failed to fetch audiobooks\" });\n    }\n  });\n\n  // Get single audiobook with chapters\n  app.get(\"/api/audiobooks/:id\", async (req, res) => {\n    try {\n      const audiobook = await storage.getAudiobookWithChapters(req.params.id);\n      if (!audiobook) {\n        return res.status(404).json({ error: \"Audiobook not found\" });\n      }\n      \n      // Check visibility (only show public or if user has special access)\n      if (audiobook.visibility !== \"PUBLIC\") {\n        const userId = req.session.userId;\n        if (!userId) {\n          return res.status(404).json({ error: \"Audiobook not found\" });\n        }\n        const user = await storage.getUser(userId);\n        const isAdmin = user?.role === \"ADMIN\";\n        const isPublisher = audiobook.publisherId === userId;\n        if (!isAdmin && !isPublisher) {\n          return res.status(404).json({ error: \"Audiobook not found\" });\n        }\n      }\n      \n      // Check access for monetization (for response enrichment)\n      const accessInfo = await storage.hasAccessToAudiobook(req.session.userId, audiobook.id);\n      \n      // Filter chapters based on access - only show sample chapters if no access\n      const visibleChapters = audiobook.chapters.filter(chapter => {\n        if (accessInfo.hasAccess || accessInfo.isFree) return true;\n        return chapter.isSample;\n      });\n      \n      // Hide audio URLs for non-accessible chapters\n      const sanitizedChapters = visibleChapters.map(chapter => {\n        if (accessInfo.hasAccess || accessInfo.isFree || chapter.isSample) {\n          return chapter;\n        }\n        return { ...chapter, audioUrl: null };\n      });\n      \n      res.json({\n        ...audiobook,\n        chapters: sanitizedChapters,\n        hasAccess: accessInfo.hasAccess,\n        isPurchased: accessInfo.isPurchased,\n        isSubscriber: accessInfo.isSubscriber,\n        isFree: accessInfo.isFree,\n      });\n    } catch (error) {\n      console.error(\"Error fetching audiobook:\", error);\n      res.status(500).json({ error: \"Failed to fetch audiobook\" });\n    }\n  });\n\n  // Get single chapter with audiobook\n  app.get(\"/api/chapters/:id\", async (req, res) => {\n    try {\n      const chapter = await storage.getChapterWithAudiobook(req.params.id);\n      if (!chapter) {\n        return res.status(404).json({ error: \"Chapter not found\" });\n      }\n      \n      // Check if user has access to this chapter\n      const hasAccess = await storage.hasAccessToChapter(req.session.userId, req.params.id);\n      \n      // Only allow access if: has access, chapter is free sample, or audiobook is free\n      const accessInfo = await storage.hasAccessToAudiobook(req.session.userId, chapter.audiobookId);\n      \n      if (!hasAccess && !chapter.isSample && !accessInfo.isFree) {\n        return res.status(403).json({ error: \"Purchase required to access this chapter\" });\n      }\n      \n      res.json(chapter);\n    } catch (error) {\n      console.error(\"Error fetching chapter:\", error);\n      res.status(500).json({ error: \"Failed to fetch chapter\" });\n    }\n  });\n\n  // Add audiobook to favorites\n  app.post(\"/api/audiobooks/:id/favorite\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const audiobookId = req.params.id;\n      \n      const audiobook = await storage.getAudiobook(audiobookId);\n      if (!audiobook) {\n        return res.status(404).json({ error: \"Audiobook not found\" });\n      }\n      \n      const favorite = await storage.addToFavorites(userId, audiobookId);\n      res.status(201).json(favorite);\n    } catch (error: any) {\n      if (error.message?.includes(\"already in favorites\")) {\n        return res.status(400).json({ error: \"Already in favorites\" });\n      }\n      console.error(\"Error adding to favorites:\", error);\n      res.status(500).json({ error: \"Failed to add to favorites\" });\n    }\n  });\n\n  // Remove audiobook from favorites\n  app.delete(\"/api/audiobooks/:id/favorite\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      await storage.removeFromFavorites(userId, req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing from favorites:\", error);\n      res.status(500).json({ error: \"Failed to remove from favorites\" });\n    }\n  });\n\n  // Get user's favorite audiobooks\n  app.get(\"/api/library/favorites\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const favorites = await storage.getUserFavorites(userId);\n      res.json(favorites);\n    } catch (error) {\n      console.error(\"Error fetching favorites:\", error);\n      res.status(500).json({ error: \"Failed to fetch favorites\" });\n    }\n  });\n\n  // Get user's purchased audiobooks\n  app.get(\"/api/library/purchases\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const purchases = await storage.getUserPurchases(userId);\n      \n      // Get the audiobook details for each purchase\n      const audiobooks = await Promise.all(\n        purchases.map(async (purchase) => {\n          const audiobook = await storage.getAudiobook(purchase.audiobookId);\n          return audiobook;\n        })\n      );\n      \n      res.json(audiobooks.filter(Boolean));\n    } catch (error) {\n      console.error(\"Error fetching purchases:\", error);\n      res.status(500).json({ error: \"Failed to fetch purchases\" });\n    }\n  });\n\n  // ===== SHOPPING CART ENDPOINTS =====\n\n  // Get cart items\n  app.get(\"/api/cart\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const items = await storage.getCartItems(userId);\n      const total = await storage.getCartTotal(userId);\n      res.json({ items, ...total });\n    } catch (error) {\n      console.error(\"Error fetching cart:\", error);\n      res.status(500).json({ error: \"Failed to fetch cart\" });\n    }\n  });\n\n  // Add item to cart\n  app.post(\"/api/cart/:audiobookId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const { audiobookId } = req.params;\n\n      // Check if audiobook exists\n      const audiobook = await storage.getAudiobook(audiobookId);\n      if (!audiobook) {\n        return res.status(404).json({ error: \"Audiobook not found\" });\n      }\n\n      // Check if already purchased\n      const hasPurchased = await storage.hasPurchasedAudiobook(userId, audiobookId);\n      if (hasPurchased) {\n        return res.status(400).json({ error: \"Already purchased\" });\n      }\n\n      // Check if free\n      if (audiobook.isFree || audiobook.priceCents === 0) {\n        return res.status(400).json({ error: \"Free audiobooks don't need to be in cart\" });\n      }\n\n      const item = await storage.addToCart(userId, audiobookId);\n      res.status(201).json(item);\n    } catch (error) {\n      console.error(\"Error adding to cart:\", error);\n      res.status(500).json({ error: \"Failed to add to cart\" });\n    }\n  });\n\n  // Remove item from cart\n  app.delete(\"/api/cart/:audiobookId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      await storage.removeFromCart(userId, req.params.audiobookId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing from cart:\", error);\n      res.status(500).json({ error: \"Failed to remove from cart\" });\n    }\n  });\n\n  // Clear cart\n  app.delete(\"/api/cart\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      await storage.clearCart(userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error clearing cart:\", error);\n      res.status(500).json({ error: \"Failed to clear cart\" });\n    }\n  });\n\n  // Check if item is in cart\n  app.get(\"/api/cart/check/:audiobookId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const isInCart = await storage.isInCart(userId, req.params.audiobookId);\n      res.json({ isInCart });\n    } catch (error) {\n      console.error(\"Error checking cart:\", error);\n      res.status(500).json({ error: \"Failed to check cart\" });\n    }\n  });\n\n  // Get cart item count (for mobile badge)\n  app.get(\"/api/cart/count\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const items = await storage.getCartItems(userId);\n      res.json({ itemCount: items.length });\n    } catch (error) {\n      console.error(\"Error fetching cart count:\", error);\n      res.status(500).json({ error: \"Failed to fetch cart count\" });\n    }\n  });\n\n  // ===== MOBILE ENDPOINTS =====\n\n  // Get featured audiobook for mobile home screen\n  app.get(\"/api/mobile/featured\", async (req, res) => {\n    try {\n      const audiobooks = await storage.getPublicAudiobooks();\n      const approvedAudiobooks = audiobooks.filter(a => a.status === \"APPROVED\");\n      \n      // Get featured (first with isFeatured flag or first available)\n      const featured = approvedAudiobooks.find(a => a.isFeatured) || approvedAudiobooks[0] || null;\n      \n      res.json({\n        featured,\n        totalCount: approvedAudiobooks.length,\n      });\n    } catch (error) {\n      console.error(\"Error fetching mobile featured:\", error);\n      res.status(500).json({ error: \"Failed to fetch featured audiobook\" });\n    }\n  });\n\n  // Admin: Get all audiobooks\n  app.get(\"/api/admin/audiobooks\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const audiobooks = await storage.getAllAudiobooksWithPublisher();\n      res.json(audiobooks);\n    } catch (error) {\n      console.error(\"Error fetching admin audiobooks:\", error);\n      res.status(500).json({ error: \"Failed to fetch audiobooks\" });\n    }\n  });\n\n  // Admin: Create audiobook\n  app.post(\"/api/admin/audiobooks\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const validated = insertAudiobookSchema.parse(req.body);\n      const audiobook = await storage.createAudiobook({\n        ...validated,\n        publisherId: req.session.userId!,\n        status: \"APPROVED\",\n      });\n      res.status(201).json(audiobook);\n    } catch (error) {\n      console.error(\"Error creating audiobook:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Validation failed\", details: error.errors });\n      } else {\n        res.status(500).json({ error: \"Failed to create audiobook\" });\n      }\n    }\n  });\n\n  // Admin: Delete audiobook\n  app.delete(\"/api/admin/audiobooks/:id\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      await storage.deleteAudiobook(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting audiobook:\", error);\n      res.status(500).json({ error: \"Failed to delete audiobook\" });\n    }\n  });\n\n  // Admin: Update audiobook\n  app.patch(\"/api/admin/audiobooks/:id\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const audiobook = await storage.getAudiobook(req.params.id);\n      if (!audiobook) {\n        return res.status(404).json({ error: \"Audiobook not found\" });\n      }\n      const updated = await storage.updateAudiobook(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating audiobook:\", error);\n      res.status(500).json({ error: \"Failed to update audiobook\" });\n    }\n  });\n\n  // Admin: Publish audiobook\n  app.post(\"/api/admin/audiobooks/:id/publish\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const audiobook = await storage.getAudiobook(req.params.id);\n      if (!audiobook) {\n        return res.status(404).json({ error: \"Audiobook not found\" });\n      }\n      const updated = await storage.publishAudiobook(req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error publishing audiobook:\", error);\n      res.status(500).json({ error: \"Failed to publish audiobook\" });\n    }\n  });\n\n  // Admin: Unpublish audiobook\n  app.post(\"/api/admin/audiobooks/:id/unpublish\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const audiobook = await storage.getAudiobook(req.params.id);\n      if (!audiobook) {\n        return res.status(404).json({ error: \"Audiobook not found\" });\n      }\n      const updated = await storage.unpublishAudiobook(req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error unpublishing audiobook:\", error);\n      res.status(500).json({ error: \"Failed to unpublish audiobook\" });\n    }\n  });\n\n  // Admin: Get all chapters\n  app.get(\"/api/admin/chapters\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const chapters = await storage.getAllChaptersWithAudiobook();\n      res.json(chapters);\n    } catch (error) {\n      console.error(\"Error fetching admin chapters:\", error);\n      res.status(500).json({ error: \"Failed to fetch chapters\" });\n    }\n  });\n\n  // Admin: Create chapter\n  app.post(\"/api/admin/chapters\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const validated = insertChapterSchema.parse(req.body);\n      const chapter = await storage.createChapter({\n        ...validated,\n        status: \"APPROVED\",\n      });\n      res.status(201).json(chapter);\n    } catch (error) {\n      console.error(\"Error creating chapter:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Validation failed\", details: error.errors });\n      } else {\n        res.status(500).json({ error: \"Failed to create chapter\" });\n      }\n    }\n  });\n\n  // Admin: Delete chapter\n  app.delete(\"/api/admin/chapters/:id\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      await storage.deleteChapter(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting chapter:\", error);\n      res.status(500).json({ error: \"Failed to delete chapter\" });\n    }\n  });\n\n  // Admin: Update chapter\n  app.patch(\"/api/admin/chapters/:id\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const chapter = await storage.getChapter(req.params.id);\n      if (!chapter) {\n        return res.status(404).json({ error: \"Chapter not found\" });\n      }\n      const updated = await storage.updateChapter(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating chapter:\", error);\n      res.status(500).json({ error: \"Failed to update chapter\" });\n    }\n  });\n\n  // ==================== SUBSCRIPTION PLAN ROUTES ====================\n\n  // Admin: Get all subscription plans\n  app.get(\"/api/admin/subscription-plans\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const plans = await storage.getAllSubscriptionPlans();\n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error fetching subscription plans:\", error);\n      res.status(500).json({ error: \"Failed to fetch subscription plans\" });\n    }\n  });\n\n  // Admin: Create subscription plan\n  app.post(\"/api/admin/subscription-plans\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const validated = insertSubscriptionPlanSchema.parse(req.body);\n      const plan = await storage.createSubscriptionPlan(validated);\n      res.status(201).json(plan);\n    } catch (error) {\n      console.error(\"Error creating subscription plan:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Validation failed\", details: error.errors });\n      } else {\n        res.status(500).json({ error: \"Failed to create subscription plan\" });\n      }\n    }\n  });\n\n  // Admin: Delete subscription plan\n  app.delete(\"/api/admin/subscription-plans/:id\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      await storage.deleteSubscriptionPlan(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting subscription plan:\", error);\n      res.status(500).json({ error: \"Failed to delete subscription plan\" });\n    }\n  });\n\n  // Admin: Update subscription plan\n  app.patch(\"/api/admin/subscription-plans/:id\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const plan = await storage.getSubscriptionPlan(req.params.id);\n      if (!plan) {\n        return res.status(404).json({ error: \"Plan not found\" });\n      }\n      const updated = await storage.updateSubscriptionPlan(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating subscription plan:\", error);\n      res.status(500).json({ error: \"Failed to update subscription plan\" });\n    }\n  });\n\n  // Public: Get active subscription plans (for users to view)\n  app.get(\"/api/subscription-plans\", async (req, res) => {\n    try {\n      const plans = await storage.getActiveSubscriptionPlans();\n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error fetching subscription plans:\", error);\n      res.status(500).json({ error: \"Failed to fetch subscription plans\" });\n    }\n  });\n\n  // ==================== PODCAST ROUTES ====================\n  \n  // Get all podcasts\n  app.get(\"/api/podcasts\", async (req, res) => {\n    try {\n      const allPodcasts = await storage.getAllPodcasts();\n      \n      // Check access for each podcast (visibility + invitations)\n      const accessChecks = await Promise.all(\n        allPodcasts.map(async (p) => ({\n          podcast: p,\n          hasVisibilityAccess: await storage.checkUserHasAccessToPodcast(req.session.userId, p.id),\n        }))\n      );\n      \n      // Filter by visibility access first\n      const visibilityFilteredPodcasts = accessChecks\n        .filter(({ hasVisibilityAccess }) => hasVisibilityAccess)\n        .map(({ podcast }) => podcast);\n      \n      // Then filter by moderation status\n      let isAdmin = false;\n      let currentUserId: string | undefined;\n      if (req.session.userId) {\n        const user = await storage.getUser(req.session.userId);\n        isAdmin = user?.role === \"ADMIN\";\n        currentUserId = req.session.userId;\n      }\n      \n      const podcasts = visibilityFilteredPodcasts.filter(p => {\n        // Admins see everything\n        if (isAdmin) return true;\n        // Owners see their own podcasts regardless of moderation status\n        if (currentUserId && p.ownerId === currentUserId) return true;\n        // Everyone else only sees approved podcasts (moderation)\n        return p.status === \"APPROVED\";\n      });\n      \n      // Enrich podcasts with cover art URLs from assets\n      const enrichedPodcasts = await Promise.all(\n        podcasts.map(async (podcast) => {\n          // Resolve cover art URL from asset if needed\n          let coverArtAsset = null;\n          if (podcast.coverArtAssetId && !podcast.coverArtUrl) {\n            coverArtAsset = await storage.getMediaAsset(podcast.coverArtAssetId);\n          }\n          const coverArtUrl = resolvePodcastCoverArtUrl(podcast, coverArtAsset);\n          \n          return {\n            ...podcast,\n            coverArtUrl,\n          };\n        })\n      );\n      \n      // If user is authenticated, add subscription status\n      if (req.session.userId) {\n        const podcastsWithSubscription = await Promise.all(\n          enrichedPodcasts.map(async (podcast) => ({\n            ...podcast,\n            isSubscribed: await storage.isSubscribed(req.session.userId!, podcast.id),\n          }))\n        );\n        return res.json(podcastsWithSubscription);\n      }\n      \n      res.json(enrichedPodcasts);\n    } catch (error) {\n      console.error(\"Error fetching podcasts:\", error);\n      res.status(500).json({ error: \"Failed to fetch podcasts\" });\n    }\n  });\n\n  // Get user's own podcasts\n  app.get(\"/api/my-podcasts\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const userPodcasts = await storage.getPodcastsByOwner(userId);\n      \n      // Enrich podcasts with cover art URLs from assets\n      const enrichedPodcasts = await Promise.all(\n        userPodcasts.map(async (podcast) => {\n          // Resolve cover art URL from asset if needed\n          let coverArtAsset = null;\n          if (podcast.coverArtAssetId && !podcast.coverArtUrl) {\n            coverArtAsset = await storage.getMediaAsset(podcast.coverArtAssetId);\n          }\n          const coverArtUrl = resolvePodcastCoverArtUrl(podcast, coverArtAsset);\n          \n          return {\n            ...podcast,\n            coverArtUrl,\n          };\n        })\n      );\n      \n      res.json(enrichedPodcasts);\n    } catch (error) {\n      console.error(\"Error fetching user podcasts:\", error);\n      res.status(500).json({ error: \"Failed to fetch user podcasts\" });\n    }\n  });\n\n  // Get single podcast with episodes (including share/embed URLs)\n  app.get(\"/api/podcasts/:id\", async (req, res) => {\n    try {\n      const podcast = await storage.getPodcastWithEpisodes(req.params.id);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      // Check access using visibility + invitations + moderation status\n      const hasAccess = await storage.checkUserHasAccessToPodcast(req.session.userId, req.params.id);\n      \n      if (!hasAccess) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      // Also check moderation status (approved content, or owner/admin can see draft/pending)\n      let hasModerationAccess = podcast.status === \"APPROVED\";\n      if (req.session.userId) {\n        const user = await storage.getUser(req.session.userId);\n        const isAdmin = user?.role === \"ADMIN\";\n        const isOwner = podcast.ownerId === req.session.userId;\n        hasModerationAccess = hasModerationAccess || isAdmin || isOwner;\n      }\n      \n      if (!hasModerationAccess) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      // Filter episodes: check both visibility and moderation status for each episode\n      const accessibleEpisodes = [];\n      for (const episode of podcast.episodes) {\n        const hasEpisodeAccess = await storage.checkUserHasAccessToEpisode(req.session.userId, episode.id);\n        \n        // Also check episode moderation status\n        let hasEpisodeModerationAccess = episode.status === \"APPROVED\";\n        if (req.session.userId) {\n          const user = await storage.getUser(req.session.userId);\n          const isAdmin = user?.role === \"ADMIN\";\n          const isOwner = podcast.ownerId === req.session.userId;\n          hasEpisodeModerationAccess = hasEpisodeModerationAccess || isAdmin || isOwner;\n        }\n        \n        if (hasEpisodeAccess && hasEpisodeModerationAccess) {\n          accessibleEpisodes.push(episode);\n        }\n      }\n      \n      const filteredEpisodes = accessibleEpisodes;\n      \n      // Resolve podcast cover art URL from asset if needed\n      let podcastCoverArtAsset = null;\n      if (podcast.coverArtAssetId && !podcast.coverArtUrl) {\n        podcastCoverArtAsset = await storage.getMediaAsset(podcast.coverArtAssetId);\n      }\n      const podcastCoverArtUrl = resolvePodcastCoverArtUrl(podcast, podcastCoverArtAsset);\n      \n      // Enrich episodes with share/embed URLs and audio URLs\n      const siteUrl = getSiteUrl(req);\n      const episodesWithUrls = await Promise.all(\n        filteredEpisodes.map(async (episode) => {\n          // Resolve audio URL from asset if needed\n          let audioAsset = null;\n          if (episode.audioAssetId && !episode.audioUrl) {\n            audioAsset = await storage.getMediaAsset(episode.audioAssetId);\n          }\n          const audioUrl = resolveEpisodeAudioUrl(episode, audioAsset);\n          \n          return {\n            ...episode,\n            audioUrl,\n            canonicalUrl: getEpisodeCanonicalUrl(siteUrl, podcast.id, episode.id),\n            embedUrl: getEpisodeEmbedUrl(siteUrl, episode.id),\n            shareUrl: getEpisodeShareUrl(siteUrl, podcast.id, episode.id),\n            embedCode: getEmbedIframeCode(getEpisodeEmbedUrl(siteUrl, episode.id), episode.title),\n          };\n        })\n      );\n      \n      res.json({\n        ...podcast,\n        coverArtUrl: podcastCoverArtUrl,\n        episodes: episodesWithUrls,\n      });\n    } catch (error) {\n      console.error(\"Error fetching podcast:\", error);\n      res.status(500).json({ error: \"Failed to fetch podcast\" });\n    }\n  });\n\n  // Get RSS feed for podcast\n  app.get(\"/api/podcasts/:id/rss\", async (req, res) => {\n    try {\n      const podcast = await storage.getPodcastForRSS(req.params.id);\n      if (!podcast) {\n        return res.status(404).send(\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><error>Podcast not found</error>\");\n      }\n      \n      // RSS feeds are public - only include approved podcast if not approved\n      if (podcast.status !== \"APPROVED\") {\n        return res.status(404).send(\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><error>Podcast not found</error>\");\n      }\n      \n      // Filter to only include approved episodes in RSS feed\n      const approvedEpisodes = podcast.episodes.filter(e => e.status === \"APPROVED\");\n      \n      // Enrich episodes with effective cover art (fallback to podcast cover)\n      const enrichedEpisodes = approvedEpisodes.map(episode => {\n        const { coverArtUrl, coverArtAssetId } = resolveEpisodeArtwork(episode, podcast);\n        return {\n          ...episode,\n          effectiveCoverArtUrl: coverArtUrl,\n          effectiveCoverArtAssetId: coverArtAssetId,\n        };\n      });\n      \n      const podcastWithEnrichedEpisodes = {\n        ...podcast,\n        episodes: enrichedEpisodes,\n      };\n\n      // Generate site URL from request\n      const siteUrl = getSiteUrl(req);\n      const feedUrl = `${siteUrl}/api/podcasts/${podcast.id}/rss`;\n      \n      // Generate RSS XML\n      const rssXml = generateRSSFeed(podcastWithEnrichedEpisodes, feedUrl, siteUrl);\n      \n      // Set headers with ETag based on latest approved episode\n      const latestEpisodeTimestamp = approvedEpisodes.length > 0\n        ? new Date(approvedEpisodes[0].publishedAt).getTime()\n        : podcast.createdAt.getTime();\n      \n      res.set({\n        \"Content-Type\": \"application/rss+xml; charset=utf-8\",\n        \"Cache-Control\": \"public, max-age=3600\", // Cache for 1 hour\n        \"ETag\": `\"${podcast.id}-${latestEpisodeTimestamp}\"`,\n      });\n      \n      res.send(rssXml);\n    } catch (error) {\n      console.error(\"Error generating RSS feed:\", error);\n      res.status(500).send(\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><error>Failed to generate RSS feed</error>\");\n    }\n  });\n\n  // Import podcast from RSS feed (protected - requires authentication)\n  app.post(\"/api/podcasts/import-rss\", requireAuth, async (req, res) => {\n    try {\n      const schema = z.object({\n        rssUrl: z.string().url(\"Invalid RSS URL\"),\n      });\n\n      const { rssUrl } = schema.parse(req.body);\n      const userId = req.session.userId!;\n\n      // Define iTunes interfaces for type-safe RSS parsing\n      interface ItunesFeed {\n        itunesImage?: { href: string };\n        itunesCategory?: string | { $: { text: string } };\n      }\n      \n      interface ItunesItem {\n        itunesDuration?: string | number;\n        itunesImage?: { href: string };\n      }\n      \n      // Import rss-parser dynamically with typed generics\n      const Parser = (await import(\"rss-parser\")).default;\n      const parser = new Parser<ItunesFeed, ItunesItem>({\n        customFields: {\n          feed: [['itunes:image', 'itunesImage'], ['itunes:category', 'itunesCategory']],\n          item: [['itunes:duration', 'itunesDuration'], ['itunes:image', 'itunesImage']],\n        },\n      });\n\n      // Fetch and parse the RSS feed\n      const feed = await parser.parseURL(rssUrl);\n\n      if (!feed || !feed.title) {\n        return res.status(400).json({ \n          error: \"Feed RSS invÃ¡lido - falta el tÃ­tulo\",\n          message: \"Feed RSS invÃ¡lido - falta el tÃ­tulo\"\n        });\n      }\n\n      // Check if podcast with same title already exists for this user\n      const existingPodcasts = await storage.getPodcastsByOwner(userId);\n      const duplicate = existingPodcasts.find(p => \n        p.title.toLowerCase().trim() === (feed.title || \"\").toLowerCase().trim()\n      );\n      \n      if (duplicate) {\n        return res.status(409).json({ \n          error: \"Ya tienes un podcast con este nombre\",\n          message: \"Ya tienes un podcast con este nombre\",\n          existingPodcastId: duplicate.id \n        });\n      }\n\n      // Extract cover art with proper iTunes handling\n      let coverArtUrl: string | null = null;\n      if (feed.image?.url) {\n        coverArtUrl = feed.image.url;\n      } else if (feed.itunesImage?.href) {\n        coverArtUrl = feed.itunesImage.href;\n      } else if (feed.itunes?.image) {\n        coverArtUrl = feed.itunes.image;\n      }\n\n      // Extract category\n      let category = \"General\";\n      if (feed.itunesCategory) {\n        const cat = feed.itunesCategory;\n        category = typeof cat === 'string' ? cat : (cat.$ && cat.$.text) || \"General\";\n      } else if (feed.itunes?.categories && feed.itunes.categories.length > 0) {\n        category = feed.itunes.categories[0];\n      }\n\n      // Validate podcast data with schema\n      const podcastValidation = insertPodcastSchema.safeParse({\n        title: feed.title.trim(),\n        description: (feed.description || feed.title).trim(),\n        coverArtUrl: coverArtUrl || \"\",\n        category,\n        language: feed.language || \"es\",\n      });\n\n      if (!podcastValidation.success) {\n        return res.status(400).json({ \n          error: \"Datos invÃ¡lidos en el feed RSS\",\n          message: \"Datos invÃ¡lidos en el feed RSS\",\n          details: podcastValidation.error.errors \n        });\n      }\n\n      // Create the podcast\n      const podcastData = {\n        ...podcastValidation.data,\n        coverArtUrl: podcastValidation.data.coverArtUrl || null,\n        coverArtAssetId: null,\n        ownerId: userId,\n        status: \"PENDING_APPROVAL\" as const,\n        approvedAt: null,\n        approvedBy: null,\n      };\n\n      const podcast = await storage.createPodcast(podcastData);\n\n      // Import episodes from feed\n      let importedCount = 0;\n      let skippedCount = 0;\n      const errors: string[] = [];\n\n      if (feed.items && feed.items.length > 0) {\n        // Limit to first 50 episodes to avoid overwhelming the system\n        const itemsToImport = feed.items.slice(0, 50);\n\n        for (const item of itemsToImport) {\n          try {\n            // Extract audio URL from enclosure\n            const audioUrl = item.enclosure?.url || item.link;\n            \n            if (!audioUrl || !item.title) {\n              skippedCount++;\n              continue;\n            }\n\n            // Parse duration with improved handling\n            let durationSeconds: number | undefined = undefined;\n            const itunesDuration = item.itunesDuration;\n            \n            if (itunesDuration) {\n              const duration = itunesDuration;\n              if (typeof duration === 'string') {\n                if (duration.includes(':')) {\n                  // Format: HH:MM:SS or MM:SS\n                  const parts = duration.split(':').map(Number);\n                  if (parts.length === 3) {\n                    durationSeconds = parts[0] * 3600 + parts[1] * 60 + parts[2];\n                  } else if (parts.length === 2) {\n                    durationSeconds = parts[0] * 60 + parts[1];\n                  }\n                } else {\n                  // Format: seconds as string\n                  durationSeconds = parseInt(duration) || undefined;\n                }\n              } else if (typeof duration === 'number') {\n                durationSeconds = duration;\n              }\n            }\n\n            // Extract episode cover art\n            let episodeCoverArt: string | null = null;\n            if (item.itunesImage?.href) {\n              episodeCoverArt = item.itunesImage.href;\n            } else if (item.enclosure?.type?.startsWith('image/')) {\n              episodeCoverArt = item.enclosure.url;\n            }\n\n            // Validate episode data\n            const episodeValidation = insertEpisodeSchema.safeParse({\n              podcastId: podcast.id,\n              title: item.title.trim(),\n              notes: (item.contentSnippet || item.content || item.title).trim(),\n              audioUrl,\n              coverArtUrl: episodeCoverArt || \"\",\n              duration: durationSeconds,\n            });\n\n            if (!episodeValidation.success) {\n              errors.push(`Episode \"${item.title}\": ${episodeValidation.error.errors[0].message}`);\n              skippedCount++;\n              continue;\n            }\n\n            await storage.createEpisode(episodeValidation.data);\n            importedCount++;\n          } catch (episodeError: any) {\n            console.error(`Error importing episode \"${item.title}\":`, episodeError);\n            errors.push(`Episode \"${item.title}\": ${episodeError.message}`);\n            skippedCount++;\n          }\n        }\n      }\n\n      res.status(201).json({\n        podcast,\n        imported: importedCount,\n        skipped: skippedCount,\n        totalInFeed: feed.items?.length || 0,\n        errors: errors.length > 0 ? errors.slice(0, 5) : undefined,\n        message: `Podcast imported successfully with ${importedCount} episode${importedCount !== 1 ? 's' : ''}`,\n      });\n    } catch (error: any) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      \n      // Handle RSS parsing errors with more detail\n      if (error.message?.includes('404')) {\n        return res.status(404).json({ error: \"RSS feed not found at the provided URL\" });\n      }\n      if (error.message?.includes('ENOTFOUND') || error.message?.includes('ECONNREFUSED')) {\n        return res.status(400).json({ error: \"Cannot reach the RSS feed URL - please check the address\" });\n      }\n      if (error.message?.includes('Invalid XML')) {\n        return res.status(400).json({ error: \"The URL does not contain valid RSS feed data\" });\n      }\n      \n      console.error(\"Error importing RSS feed:\", error);\n      res.status(500).json({ \n        error: \"Failed to import RSS feed\", \n        detail: error.message \n      });\n    }\n  });\n\n  // Preview YouTube playlist before importing (protected - ADMIN only)\n  app.get(\"/api/import-youtube/preview\", requireAuth, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.session.userId!);\n      if (!user || user.role !== \"ADMIN\") {\n        return res.status(403).json({ error: \"Solo administradores pueden importar desde YouTube\" });\n      }\n\n      const { playlistUrl, maxVideos } = req.query;\n      \n      if (!playlistUrl || typeof playlistUrl !== 'string') {\n        return res.status(400).json({ error: \"playlistUrl es requerida\" });\n      }\n\n      const maxVids = maxVideos ? parseInt(maxVideos as string) : 10;\n      \n      // Get playlist metadata\n      const playlistMetadata = await getPlaylistMetadata(playlistUrl);\n      \n      // Get playlist videos\n      const videos = await getPlaylistVideos(playlistMetadata.playlistId, maxVids);\n\n      res.json({\n        playlist: {\n          title: playlistMetadata.title,\n          description: playlistMetadata.description,\n          channelTitle: playlistMetadata.channelTitle,\n          thumbnailUrl: playlistMetadata.thumbnailUrl,\n        },\n        videos: videos.map(v => ({\n          videoId: v.videoId,\n          title: v.title,\n          description: v.description,\n          thumbnailUrl: v.thumbnailUrl,\n          duration: v.duration,\n          publishedAt: v.publishedAt,\n        })),\n        totalVideos: videos.length,\n      });\n    } catch (error: any) {\n      console.error(\"Error fetching YouTube playlist:\", error);\n      \n      if (error.message?.includes('YOUTUBE_API_KEY')) {\n        return res.status(500).json({ \n          error: \"YouTube API no configurada\",\n          message: \"El administrador debe configurar la API de YouTube para usar esta funciÃ³n\"\n        });\n      }\n\n      if (error.message?.includes('Playlist no encontrada')) {\n        return res.status(404).json({ \n          error: \"Playlist no encontrada\",\n          message: \"Verifica que la URL sea correcta y que la playlist sea pÃºblica\"\n        });\n      }\n\n      res.status(500).json({ \n        error: \"Error al obtener informaciÃ³n de la playlist\", \n        detail: error.message \n      });\n    }\n  });\n\n  // Import podcast from YouTube playlist (protected - ADMIN only)\n  app.post(\"/api/import-youtube\", requireAuth, async (req, res) => {\n    const user = await storage.getUser(req.session.userId!);\n    if (!user || user.role !== \"ADMIN\") {\n      return res.status(403).json({ error: \"Solo administradores pueden importar desde YouTube\" });\n    }\n    try {\n      const validatedData = youtubeImportSchema.parse(req.body);\n      const userId = req.session.userId!;\n\n      // Get playlist metadata\n      const playlistMetadata = await getPlaylistMetadata(validatedData.playlistUrl);\n\n      // Check if podcast with same title already exists for this user\n      const existingPodcasts = await storage.getPodcastsByOwner(userId);\n      const podcastTitle = validatedData.podcastTitle || playlistMetadata.title;\n      const duplicate = existingPodcasts.find(p => \n        p.title.toLowerCase().trim() === podcastTitle.toLowerCase().trim()\n      );\n      \n      if (duplicate) {\n        return res.status(409).json({ \n          error: \"Ya tienes un podcast con este nombre\",\n          message: \"Ya tienes un podcast con este nombre\",\n          existingPodcastId: duplicate.id \n        });\n      }\n\n      // Get playlist videos\n      let videos = await getPlaylistVideos(playlistMetadata.playlistId, validatedData.maxVideos);\n\n      // Filter by selected video IDs if provided\n      if (validatedData.selectedVideoIds && validatedData.selectedVideoIds.length > 0) {\n        videos = videos.filter(v => validatedData.selectedVideoIds!.includes(v.videoId));\n      }\n\n      if (videos.length === 0) {\n        return res.status(400).json({\n          error: \"No hay videos seleccionados para importar\",\n          message: \"Debes seleccionar al menos un video para importar\"\n        });\n      }\n\n      // Create temporary directory for downloads\n      const tempDir = path.join(os.tmpdir(), `youtube-import-${Date.now()}`);\n      const tempFiles: string[] = [];\n\n      try {\n        // Download and upload podcast cover art if available\n        let coverArtAssetId: string | null = null;\n        if (playlistMetadata.thumbnailUrl) {\n          try {\n            const thumbnailFilename = `playlist-${playlistMetadata.playlistId}.jpg`;\n            const thumbnailPath = await downloadThumbnail(\n              playlistMetadata.thumbnailUrl, \n              tempDir, \n              thumbnailFilename\n            );\n            tempFiles.push(thumbnailPath);\n            \n            coverArtAssetId = await uploadImageToStorage(thumbnailPath, thumbnailFilename, userId);\n          } catch (thumbError) {\n            console.error(\"Error downloading playlist thumbnail:\", thumbError);\n            // Continue without cover art\n          }\n        }\n\n        // Create the podcast\n        const podcast = await storage.createPodcast({\n          title: podcastTitle,\n          description: validatedData.podcastDescription || playlistMetadata.description || `Podcast importado desde YouTube: ${playlistMetadata.channelTitle}`,\n          coverArtUrl: null,\n          coverArtAssetId,\n          category: \"YouTube Import\",\n          language: \"es\",\n          ownerId: userId,\n          status: \"PENDING_APPROVAL\" as const,\n          visibility: validatedData.visibility as any,\n          approvedAt: null,\n          approvedBy: null,\n        });\n\n        // Import episodes\n        let importedCount = 0;\n        let skippedCount = 0;\n        const errors: string[] = [];\n\n        for (const video of videos) {\n          try {\n            // Add delay between downloads to avoid rate limiting (except first video)\n            if (importedCount > 0) {\n              await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay\n            }\n\n            // Download audio from video\n            const { audioPath, filename } = await downloadAudioFromVideo(video.videoId, tempDir);\n            tempFiles.push(audioPath);\n\n            // Upload audio to storage\n            const audioAssetId = await uploadAudioToStorage(\n              audioPath,\n              filename,\n              userId,\n              undefined, // episodeId - will be filled after creation\n              podcast.id\n            );\n\n            // Download episode cover art if different from podcast\n            let episodeCoverArtAssetId: string | null = null;\n            if (video.thumbnailUrl && video.thumbnailUrl !== playlistMetadata.thumbnailUrl) {\n              try {\n                const episodeThumbFilename = `video-${video.videoId}.jpg`;\n                const episodeThumbPath = await downloadThumbnail(\n                  video.thumbnailUrl,\n                  tempDir,\n                  episodeThumbFilename\n                );\n                tempFiles.push(episodeThumbPath);\n                \n                episodeCoverArtAssetId = await uploadImageToStorage(\n                  episodeThumbPath,\n                  episodeThumbFilename,\n                  userId,\n                  podcast.id\n                );\n              } catch (thumbError) {\n                console.error(`Error downloading thumbnail for video ${video.videoId}:`, thumbError);\n                // Continue without episode-specific cover art\n              }\n            }\n\n            // Create episode\n            await storage.createEpisode({\n              podcastId: podcast.id,\n              title: video.title,\n              notes: video.description || video.title,\n              audioUrl: undefined,\n              audioAssetId,\n              coverArtUrl: undefined,\n              coverArtAssetId: episodeCoverArtAssetId,\n              duration: video.duration,\n              status: \"PENDING_APPROVAL\" as const,\n              visibility: validatedData.visibility as any,\n              publishedAt: video.publishedAt?.toISOString(),\n              approvedAt: null,\n              approvedBy: null,\n            });\n\n            importedCount++;\n          } catch (episodeError: any) {\n            console.error(`Error importing video \"${video.title}\":`, episodeError);\n            errors.push(`Video \"${video.title}\": ${episodeError.message}`);\n            skippedCount++;\n          }\n        }\n\n        // Cleanup temp files\n        await cleanupTempFiles(tempFiles);\n\n        res.status(201).json({\n          podcast,\n          imported: importedCount,\n          skipped: skippedCount,\n          totalRequested: validatedData.maxVideos,\n          totalAvailable: videos.length,\n          errors: errors.length > 0 ? errors.slice(0, 5) : undefined,\n          message: `Podcast creado exitosamente con ${importedCount} episodio${importedCount !== 1 ? 's' : ''}`,\n        });\n      } catch (importError) {\n        // Cleanup temp files on error\n        await cleanupTempFiles(tempFiles);\n        throw importError;\n      }\n    } catch (error: any) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Datos invÃ¡lidos\", details: error.errors });\n      }\n\n      console.error(\"Error importing from YouTube:\", error);\n      \n      // Handle specific YouTube errors\n      if (error.message?.includes('YOUTUBE_API_KEY')) {\n        return res.status(500).json({ \n          error: \"YouTube API no configurada\",\n          message: \"El administrador debe configurar la API de YouTube para usar esta funciÃ³n\"\n        });\n      }\n\n      if (error.message?.includes('Playlist no encontrada')) {\n        return res.status(404).json({ \n          error: \"Playlist no encontrada\",\n          message: \"Verifica que la URL sea correcta y que la playlist sea pÃºblica\"\n        });\n      }\n\n      res.status(500).json({ \n        error: \"Error al importar desde YouTube\", \n        detail: error.message \n      });\n    }\n  });\n\n  // ==================== ZIP IMPORT ROUTES ====================\n  \n  // Import audiobook from ZIP file (protected - ADMIN only)\n  app.post(\"/api/admin/import/zip\", requireAuth, requireAdmin, uploadZip.single('zipFile'), async (req, res) => {\n    const tempFiles: string[] = [];\n    let extractDir: string | null = null;\n    \n    try {\n      const userId = req.session.userId!;\n      const zipFile = req.file;\n      \n      if (!zipFile) {\n        return res.status(400).json({ error: \"Debes subir un archivo ZIP\" });\n      }\n      \n      tempFiles.push(zipFile.path);\n      \n      // Create extraction directory\n      const unzipper = await import('unzipper');\n      const path = await import('path');\n      const fsPromises = await import('fs/promises');\n      const fs = await import('fs');\n      \n      extractDir = path.join(os.tmpdir(), `import-${Date.now()}`);\n      await fsPromises.mkdir(extractDir, { recursive: true });\n      \n      // Extract ZIP file\n      await new Promise<void>((resolve, reject) => {\n        fs.createReadStream(zipFile.path)\n          .pipe(unzipper.Extract({ path: extractDir! }))\n          .on('close', resolve)\n          .on('error', reject);\n      });\n      \n      // Look for metadata.json\n      const metadataPath = path.join(extractDir, 'metadata.json');\n      let metadata: any = null;\n      let autoDetectedFromMP3 = false;\n      \n      try {\n        const metadataContent = await fsPromises.readFile(metadataPath, 'utf-8');\n        metadata = JSON.parse(metadataContent);\n      } catch (err) {\n        // No metadata.json found, try to auto-detect from MP3 files\n        console.log(\"No metadata.json found, attempting to read metadata from MP3 files...\");\n        \n        const files = await fsPromises.readdir(extractDir);\n        const mp3Files = files.filter(f => f.toLowerCase().endsWith('.mp3')).sort();\n        \n        if (mp3Files.length === 0) {\n          return res.status(400).json({ \n            error: \"No se encontraron archivos MP3\",\n            message: \"El archivo ZIP debe contener archivos MP3 o un archivo metadata.json\"\n          });\n        }\n        \n        // Read metadata from the first MP3 file to get album/artist info\n        const mm = await import('music-metadata');\n        const firstMp3Path = path.join(extractDir, mp3Files[0]);\n        const firstMp3Metadata = await mm.parseFile(firstMp3Path);\n        \n        const albumTitle = firstMp3Metadata.common.album || \"Audiolibro sin titulo\";\n        const author = firstMp3Metadata.common.artist || \"Autor desconocido\";\n        const narrator = firstMp3Metadata.common.composer || null;\n        const genre = firstMp3Metadata.common.genre?.[0] || \"Audiobook\";\n        \n        // Build chapters array from all MP3 files\n        const chaptersFromMP3: any[] = [];\n        \n        for (const mp3File of mp3Files) {\n          const mp3Path = path.join(extractDir, mp3File);\n          try {\n            const mp3Meta = await mm.parseFile(mp3Path);\n            const trackNo = mp3Meta.common.track?.no || chaptersFromMP3.length + 1;\n            \n            chaptersFromMP3.push({\n              title: mp3Meta.common.title || mp3File.replace('.mp3', '').replace('.MP3', ''),\n              chapterNumber: trackNo,\n              description: null,\n              audioFile: mp3File,\n              duration: Math.round(mp3Meta.format.duration || 0),\n              isSample: false,\n            });\n          } catch (mp3Err) {\n            console.warn(`Could not read metadata from ${mp3File}:`, mp3Err);\n            chaptersFromMP3.push({\n              title: mp3File.replace('.mp3', '').replace('.MP3', ''),\n              chapterNumber: chaptersFromMP3.length + 1,\n              audioFile: mp3File,\n              duration: 0,\n              isSample: false,\n            });\n          }\n        }\n        \n        // Sort chapters by track number\n        chaptersFromMP3.sort((a, b) => a.chapterNumber - b.chapterNumber);\n        \n        // Reassign chapter numbers after sorting\n        chaptersFromMP3.forEach((ch, idx) => {\n          ch.chapterNumber = idx + 1;\n        });\n        \n        metadata = {\n          title: albumTitle,\n          author: author,\n          narrator: narrator,\n          description: \"\",\n          category: genre === \"Audiobook\" ? \"Fiction\" : genre,\n          language: \"es\",\n          isFree: true,\n          priceCents: 0,\n          currency: \"EUR\",\n          chapters: chaptersFromMP3,\n        };\n        \n        autoDetectedFromMP3 = true;\n        console.log(`Auto-detected audiobook: \"${albumTitle}\" by ${author} with ${chaptersFromMP3.length} chapters`);\n      }\n      \n      // Validate metadata structure with Zod\n      const zipMetadataSchema = z.object({\n        title: z.string().min(1, \"Titulo es requerido\"),\n        author: z.string().min(1, \"Autor es requerido\"),\n        narrator: z.string().optional().nullable(),\n        description: z.string().optional().nullable(),\n        category: z.string().default(\"Fiction\"),\n        language: z.string().default(\"es\"),\n        isFree: z.boolean().default(true),\n        priceCents: z.number().int().min(0).default(0),\n        currency: z.string().default(\"EUR\"),\n        chapters: z.array(z.object({\n          title: z.string().optional(),\n          chapterNumber: z.number().int().min(1).optional(),\n          description: z.string().optional().nullable(),\n          audioFile: z.string().optional(),\n          duration: z.number().int().min(0).default(0),\n          isSample: z.boolean().default(false),\n        })).default([]),\n      });\n      \n      let validatedMetadata;\n      try {\n        validatedMetadata = zipMetadataSchema.parse(metadata);\n      } catch (validationError) {\n        if (validationError instanceof z.ZodError) {\n          return res.status(400).json({ \n            error: \"Metadatos invalidos\",\n            message: validationError.errors.map(e => `${e.path.join('.')}: ${e.message}`).join(', ')\n          });\n        }\n        throw validationError;\n      }\n      \n      // Helper function to safely resolve paths (prevent path traversal)\n      const safePath = (basePath: string, filename: string): string | null => {\n        // Remove any path components and only use the filename\n        const safeName = path.basename(filename);\n        if (safeName !== filename || filename.includes('..') || filename.includes('/') || filename.includes('\\\\')) {\n          console.warn(`Rejected unsafe path: ${filename}`);\n          return null;\n        }\n        return path.join(basePath, safeName);\n      };\n      \n      // Get storage service for uploads (local storage organized by audiobook title)\n      const storageService = StorageService.createLocal(validatedMetadata.title);\n      \n      // Upload cover art if exists\n      let coverArtUrl: string | null = null;\n      const coverFiles = ['cover.jpg', 'cover.png', 'cover.jpeg', 'portada.jpg', 'portada.png'];\n      \n      for (const coverName of coverFiles) {\n        const coverPath = safePath(extractDir, coverName);\n        if (!coverPath) continue;\n        try {\n          await fsPromises.access(coverPath);\n          // Cover exists, upload it\n          const coverBuffer = await fsPromises.readFile(coverPath);\n          const mimeType = coverName.endsWith('.png') ? 'image/png' : 'image/jpeg';\n          \n          const multerFile: Express.Multer.File = {\n            buffer: coverBuffer,\n            originalname: coverName,\n            mimetype: mimeType,\n            size: coverBuffer.length,\n            fieldname: 'cover',\n            encoding: '7bit',\n            destination: '',\n            filename: '',\n            path: '',\n            stream: null as any,\n          };\n          \n          const uploadResult = await storageService.saveCoverArt(multerFile, userId);\n          coverArtUrl = uploadResult.publicUrl;\n          break;\n        } catch {\n          // Cover file doesn't exist, try next\n        }\n      }\n      \n      // Create the audiobook\n      const audiobook = await storage.createAudiobook({\n        title: validatedMetadata.title,\n        author: validatedMetadata.author,\n        narrator: validatedMetadata.narrator || \"\",\n        description: validatedMetadata.description ?? \"\",\n        coverArtUrl: coverArtUrl,\n        category: validatedMetadata.category,\n        language: validatedMetadata.language,\n        priceCents: validatedMetadata.priceCents,\n        currency: validatedMetadata.currency,\n        isFree: validatedMetadata.isFree,\n        publisherId: userId,\n      });\n      \n      // Process chapters from metadata\n      const chapters = validatedMetadata.chapters;\n      const createdChapters: any[] = [];\n      let totalDuration = 0;\n      \n      for (let i = 0; i < chapters.length; i++) {\n        const chapterMeta = chapters[i];\n        const chapterNumber = chapterMeta.chapterNumber || (i + 1);\n        \n        let audioUrl: string | null = null;\n        let duration = chapterMeta.duration || 0;\n        \n        // Try to find the audio file\n        if (chapterMeta.audioFile) {\n          const audioPath = safePath(extractDir, chapterMeta.audioFile);\n          if (!audioPath) {\n            console.warn(`Rejected unsafe audio path: ${chapterMeta.audioFile}`);\n          } else try {\n            await fsPromises.access(audioPath);\n            // Audio file exists, read it\n            let audioBuffer = await fsPromises.readFile(audioPath);\n            const ext = path.extname(chapterMeta.audioFile).toLowerCase();\n            const mimeType = ext === '.mp3' ? 'audio/mpeg' : ext === '.m4a' ? 'audio/mp4' : 'audio/mpeg';\n            \n            // Update ID3 metadata for MP3 files\n            if (ext === '.mp3') {\n              try {\n                // Read cover art buffer if available\n                let coverBuffer: Buffer | undefined;\n                for (const coverName of coverFiles) {\n                  const coverPath = safePath(extractDir!, coverName);\n                  if (!coverPath) continue;\n                  try {\n                    coverBuffer = await fsPromises.readFile(coverPath);\n                    break;\n                  } catch {\n                    // Cover not found, try next\n                  }\n                }\n                \n                audioBuffer = await updateMP3MetadataBuffer(audioBuffer, {\n                  title: chapterMeta.title || `Capitulo ${chapterNumber}`,\n                  author: validatedMetadata.author,\n                  album: validatedMetadata.title,\n                  trackNumber: chapterNumber,\n                  totalTracks: chapters.length,\n                  year: new Date().getFullYear(),\n                  genre: 'Audiobook',\n                  narrator: validatedMetadata.narrator || undefined,\n                }, coverBuffer);\n                console.log(`Updated ID3 metadata for chapter ${chapterNumber}: ${chapterMeta.title || 'Untitled'}`);\n              } catch (id3Error) {\n                console.warn(`Could not update ID3 metadata for ${chapterMeta.audioFile}:`, id3Error);\n              }\n            }\n            \n            const multerFile: Express.Multer.File = {\n              buffer: audioBuffer,\n              originalname: chapterMeta.audioFile,\n              mimetype: mimeType,\n              size: audioBuffer.length,\n              fieldname: 'audio',\n              encoding: '7bit',\n              destination: '',\n              filename: '',\n              path: '',\n              stream: null as any,\n            };\n            \n            const uploadResult = await storageService.saveEpisodeAudio(multerFile, userId);\n            audioUrl = uploadResult.publicUrl;\n            \n            // Try to get duration from file\n            if (duration === 0) {\n              try {\n                const mm = await import('music-metadata');\n                const audioMetadata = await mm.parseBuffer(audioBuffer);\n                duration = Math.round(audioMetadata.format.duration || 0);\n              } catch {\n                // Couldn't get duration\n              }\n            }\n          } catch {\n            console.warn(`Audio file not found: ${chapterMeta.audioFile}`);\n          }\n        }\n        \n        totalDuration += duration;\n        \n        const chapter = await storage.createChapter({\n          title: chapterMeta.title || `Capitulo ${chapterNumber}`,\n          chapterNumber,\n          description: chapterMeta.description || null,\n          audioUrl,\n          duration,\n          isSample: chapterMeta.isSample || false,\n          audiobookId: audiobook.id,\n        });\n        \n        createdChapters.push(chapter);\n      }\n      \n      // Update audiobook with total duration\n      if (totalDuration > 0) {\n        await storage.updateAudiobook(audiobook.id, { totalDuration });\n      }\n      \n      // Cleanup\n      try {\n        await fsPromises.rm(extractDir, { recursive: true, force: true });\n        await fsPromises.unlink(zipFile.path);\n      } catch {\n        // Ignore cleanup errors\n      }\n      \n      res.status(201).json({\n        success: true,\n        audiobook: { ...audiobook, totalDuration },\n        chaptersCreated: createdChapters.length,\n        message: `Audiolibro \"${audiobook.title}\" importado con ${createdChapters.length} capitulos`\n      });\n      \n    } catch (error: any) {\n      console.error(\"Error importing from ZIP:\", error);\n      \n      // Cleanup on error\n      try {\n        const fsPromises = await import('fs/promises');\n        for (const file of tempFiles) {\n          await fsPromises.unlink(file).catch(() => {});\n        }\n        if (extractDir) {\n          await fsPromises.rm(extractDir, { recursive: true, force: true }).catch(() => {});\n        }\n      } catch {\n        // Ignore cleanup errors\n      }\n      \n      res.status(500).json({ \n        error: \"Error al importar ZIP\", \n        detail: error.message \n      });\n    }\n  });\n\n  // Import podcast from local folder - multiple MP3 files (protected - ADMIN only)\n  app.post(\"/api/import-local\", requireAuth, uploadLocalImport.fields([\n    { name: 'audioFiles', maxCount: 50 },\n    { name: 'coverArt', maxCount: 1 }\n  ]), async (req, res) => {\n    const tempFiles: string[] = [];\n    try {\n      const user = await storage.getUser(req.session.userId!);\n      if (!user || user.role !== \"ADMIN\") {\n        return res.status(403).json({ error: \"Solo administradores pueden importar carpetas locales\" });\n      }\n\n      const userId = req.session.userId!;\n      const files = req.files as { audioFiles?: Express.Multer.File[], coverArt?: Express.Multer.File[] };\n      \n      if (!files.audioFiles || files.audioFiles.length === 0) {\n        return res.status(400).json({ error: \"Debes subir al menos un archivo de audio\" });\n      }\n\n      // Collect all temp file paths for cleanup\n      files.audioFiles.forEach(file => tempFiles.push(file.path));\n      if (files.coverArt?.[0]) {\n        tempFiles.push(files.coverArt[0].path);\n      }\n\n      // Validate metadata\n      const validatedData = localImportSchema.parse(req.body);\n\n      // Check if podcast with same title already exists for this user\n      const existingPodcasts = await storage.getPodcastsByOwner(userId);\n      const duplicate = existingPodcasts.find(p => \n        p.title.toLowerCase().trim() === validatedData.podcastTitle.toLowerCase().trim()\n      );\n      \n      if (duplicate) {\n        return res.status(409).json({ \n          error: \"Ya tienes un podcast con este nombre\",\n          message: \"Ya tienes un podcast con este nombre\",\n          existingPodcastId: duplicate.id \n        });\n      }\n\n      // Upload cover art if provided\n      let coverArtAssetId: string | null = null;\n      if (files.coverArt && files.coverArt[0]) {\n        // Read file from disk into buffer (disk storage doesn't have .buffer)\n        const coverBuffer = fs.readFileSync(files.coverArt[0].path);\n        const coverWithBuffer = {\n          ...files.coverArt[0],\n          buffer: coverBuffer\n        };\n        const coverArt = await mediaOrchestrator.saveCoverArt(coverWithBuffer, userId);\n        coverArtAssetId = coverArt.id;\n      }\n\n      // Create the podcast\n      const podcast = await storage.createPodcast({\n        title: validatedData.podcastTitle,\n        description: validatedData.podcastDescription,\n        coverArtUrl: null,\n        coverArtAssetId,\n        category: validatedData.category,\n        language: validatedData.language,\n        ownerId: userId,\n        status: \"PENDING_APPROVAL\" as const,\n        visibility: validatedData.visibility as any,\n        approvedAt: null,\n        approvedBy: null,\n      });\n\n      // Import episodes from audio files\n      let importedCount = 0;\n      let skippedCount = 0;\n      const errors: string[] = [];\n\n      for (const audioFile of files.audioFiles) {\n        try {\n          // Extract metadata from audio file to get duration\n          let duration = 0;\n          try {\n            const metadata = await parseFile(audioFile.path);\n            duration = Math.round(metadata.format.duration || 0);\n          } catch (metadataError) {\n            console.warn(`Could not extract duration from ${audioFile.originalname}:`, metadataError);\n          }\n\n          // Read file from disk into buffer (disk storage doesn't have .buffer)\n          const fileBuffer = fs.readFileSync(audioFile.path);\n          \n          // Create file object with buffer for storage service\n          const fileWithBuffer = {\n            ...audioFile,\n            buffer: fileBuffer\n          };\n          \n          // Upload audio file\n          const audioAsset = await mediaOrchestrator.saveEpisodeAudio(\n            fileWithBuffer,\n            userId,\n            undefined, // episodeId - will be filled after creation\n            podcast.id\n          );\n\n          // Extract episode title from filename (remove extension)\n          const episodeTitle = audioFile.originalname.replace(/\\.[^/.]+$/, \"\");\n\n          // Create episode\n          await storage.createEpisode({\n            podcastId: podcast.id,\n            title: episodeTitle,\n            notes: `Episodio importado desde archivo local: ${audioFile.originalname}`,\n            audioUrl: undefined,\n            audioAssetId: audioAsset.id,\n            coverArtUrl: undefined,\n            coverArtAssetId: null,\n            duration: duration,\n            status: \"PENDING_APPROVAL\" as const,\n            visibility: validatedData.visibility as any,\n            publishedAt: new Date(),\n            approvedAt: null,\n            approvedBy: null,\n          });\n\n          importedCount++;\n        } catch (episodeError: any) {\n          console.error(`Error importing audio file \"${audioFile.originalname}\":`, episodeError);\n          errors.push(`Archivo \"${audioFile.originalname}\": ${episodeError.message}`);\n          skippedCount++;\n        }\n      }\n\n      res.status(201).json({\n        podcast,\n        imported: importedCount,\n        skipped: skippedCount,\n        totalFiles: files.audioFiles.length,\n        errors: errors.length > 0 ? errors.slice(0, 5) : undefined,\n        message: `Podcast creado exitosamente con ${importedCount} episodio${importedCount !== 1 ? 's' : ''}`,\n      });\n    } catch (error: any) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Datos invÃ¡lidos\", details: error.errors });\n      }\n\n      console.error(\"Error importing from local folder:\", error);\n      res.status(500).json({ \n        error: \"Error al importar archivos locales\", \n        detail: error.message \n      });\n    } finally {\n      // Clean up temporary files from disk\n      for (const filePath of tempFiles) {\n        try {\n          if (fs.existsSync(filePath)) {\n            fs.unlinkSync(filePath);\n          }\n        } catch (cleanupError) {\n          console.error(`Failed to cleanup temp file ${filePath}:`, cleanupError);\n        }\n      }\n    }\n  });\n\n  // Create podcast (protected - requires authentication)\n  app.post(\"/api/podcasts\", requireAuth, async (req, res) => {\n    try {\n      // Parse request body (ownerId is omitted from schema)\n      const validatedData = insertPodcastSchema.parse(req.body);\n      \n      // Create podcast with authenticated user as owner\n      const podcastData = {\n        title: validatedData.title,\n        description: validatedData.description,\n        coverArtUrl: validatedData.coverArtUrl || null,\n        coverArtAssetId: null,\n        category: validatedData.category,\n        language: validatedData.language,\n        visibility: validatedData.visibility || \"PUBLIC\",\n        ownerId: req.session.userId!,\n        status: \"PENDING_APPROVAL\" as const, // Will be determined by createPodcast based on user settings\n        approvedAt: null,\n        approvedBy: null,\n      };\n      \n      const podcast = await storage.createPodcast(podcastData);\n      res.status(201).json(podcast);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating podcast:\", error);\n      res.status(500).json({ error: \"Failed to create podcast\" });\n    }\n  });\n\n  // Update podcast (protected - requires authentication and ownership)\n  app.patch(\"/api/podcasts/:id\", requireAuth, async (req, res) => {\n    try {\n      const podcastId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Verify the podcast exists and belongs to the authenticated user (or user is admin)\n      const podcast = await storage.getPodcast(podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const user = await storage.getUser(userId);\n      const isOwner = podcast.ownerId === userId;\n      const isAdmin = user?.role === \"ADMIN\";\n      \n      if (!isOwner && !isAdmin) {\n        return res.status(403).json({ error: \"Forbidden - You can only edit your own podcasts\" });\n      }\n      \n      // Validate and update allowed fields\n      const updateSchema = z.object({\n        title: z.string().min(1).optional(),\n        description: z.string().optional(),\n        coverArtUrl: z.string().nullable().optional(),\n        coverArtAssetId: z.string().nullable().optional(),\n        category: z.string().optional(),\n        language: z.string().optional(),\n        visibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]).optional(),\n      });\n      \n      const validatedData = updateSchema.parse(req.body);\n      const updated = await storage.updatePodcast(podcastId, validatedData);\n      res.json(updated);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error updating podcast:\", error);\n      res.status(500).json({ error: \"Failed to update podcast\" });\n    }\n  });\n\n  // Subscribe to podcast (protected - requires authentication)\n  app.post(\"/api/podcasts/:id/subscribe\", requireAuth, async (req, res) => {\n    try {\n      const podcastId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Check if podcast exists\n      const podcast = await storage.getPodcast(podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const subscription = await storage.subscribeToPodcast(userId, podcastId);\n      res.status(201).json(subscription);\n    } catch (error) {\n      console.error(\"Error subscribing to podcast:\", error);\n      res.status(500).json({ error: \"Failed to subscribe to podcast\" });\n    }\n  });\n\n  // Unsubscribe from podcast (protected - requires authentication)\n  app.delete(\"/api/podcasts/:id/subscribe\", requireAuth, async (req, res) => {\n    try {\n      const podcastId = req.params.id;\n      const userId = req.session.userId!;\n      \n      await storage.unsubscribeFromPodcast(userId, podcastId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error unsubscribing from podcast:\", error);\n      res.status(500).json({ error: \"Failed to unsubscribe from podcast\" });\n    }\n  });\n\n  // Get user's library (subscribed podcasts)\n  app.get(\"/api/library\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const podcasts = await storage.getUserSubscriptions(userId);\n      res.json(podcasts);\n    } catch (error) {\n      console.error(\"Error fetching library:\", error);\n      res.status(500).json({ error: \"Failed to fetch library\" });\n    }\n  });\n\n  // ==================== PLAYLIST ROUTES ====================\n\n  // Create playlist\n  app.post(\"/api/playlists\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const validatedData = insertPlaylistSchema.parse(req.body);\n      \n      const playlist = await storage.createPlaylist({ ...validatedData, userId });\n      res.status(201).json(playlist);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating playlist:\", error);\n      res.status(500).json({ error: \"Failed to create playlist\" });\n    }\n  });\n\n  // Get user's playlists\n  app.get(\"/api/playlists\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const playlists = await storage.getUserPlaylists(userId);\n      res.json(playlists);\n    } catch (error) {\n      console.error(\"Error fetching playlists:\", error);\n      res.status(500).json({ error: \"Failed to fetch playlists\" });\n    }\n  });\n\n  // Get public playlists\n  app.get(\"/api/playlists/public\", async (req, res) => {\n    try {\n      const playlists = await storage.getPublicPlaylists();\n      res.json(playlists);\n    } catch (error) {\n      console.error(\"Error fetching public playlists:\", error);\n      res.status(500).json({ error: \"Failed to fetch public playlists\" });\n    }\n  });\n\n  // Get single playlist with episodes\n  app.get(\"/api/playlists/:id\", async (req, res) => {\n    try {\n      const playlistId = req.params.id;\n      const playlist = await storage.getPlaylist(playlistId);\n      \n      if (!playlist) {\n        return res.status(404).json({ error: \"Playlist not found\" });\n      }\n\n      // Check access: public playlists are accessible to everyone, private ones only to owner\n      if (!playlist.isPublic && playlist.userId !== req.session.userId) {\n        return res.status(404).json({ error: \"Playlist not found\" });\n      }\n\n      const episodes = await storage.getPlaylistEpisodes(playlistId);\n      \n      res.json({ ...playlist, episodes });\n    } catch (error) {\n      console.error(\"Error fetching playlist:\", error);\n      res.status(500).json({ error: \"Failed to fetch playlist\" });\n    }\n  });\n\n  // Update playlist\n  app.patch(\"/api/playlists/:id\", requireAuth, async (req, res) => {\n    try {\n      const playlistId = req.params.id;\n      const userId = req.session.userId!;\n      \n      const playlist = await storage.getPlaylist(playlistId);\n      if (!playlist) {\n        return res.status(404).json({ error: \"Playlist not found\" });\n      }\n\n      if (playlist.userId !== userId) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n\n      const updateSchema = z.object({\n        name: z.string().min(1).optional(),\n        description: z.string().optional(),\n        isPublic: z.boolean().optional(),\n      });\n\n      const validatedData = updateSchema.parse(req.body);\n      const updated = await storage.updatePlaylist(playlistId, validatedData);\n      res.json(updated);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error updating playlist:\", error);\n      res.status(500).json({ error: \"Failed to update playlist\" });\n    }\n  });\n\n  // Delete playlist\n  app.delete(\"/api/playlists/:id\", requireAuth, async (req, res) => {\n    try {\n      const playlistId = req.params.id;\n      const userId = req.session.userId!;\n      \n      const playlist = await storage.getPlaylist(playlistId);\n      if (!playlist) {\n        return res.status(404).json({ error: \"Playlist not found\" });\n      }\n\n      if (playlist.userId !== userId) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n\n      await storage.deletePlaylist(playlistId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting playlist:\", error);\n      res.status(500).json({ error: \"Failed to delete playlist\" });\n    }\n  });\n\n  // Add episode to playlist\n  app.post(\"/api/playlists/:id/episodes\", requireAuth, async (req, res) => {\n    try {\n      const playlistId = req.params.id;\n      const userId = req.session.userId!;\n      const { episodeId } = req.body;\n\n      if (!episodeId) {\n        return res.status(400).json({ error: \"Episode ID is required\" });\n      }\n\n      const playlist = await storage.getPlaylist(playlistId);\n      if (!playlist) {\n        return res.status(404).json({ error: \"Playlist not found\" });\n      }\n\n      if (playlist.userId !== userId) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n\n      // Check if episode exists\n      const episode = await storage.getEpisode(episodeId);\n      if (!episode) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n\n      // Check if already in playlist\n      const exists = await storage.isEpisodeInPlaylist(playlistId, episodeId);\n      if (exists) {\n        return res.status(409).json({ error: \"Episode already in playlist\" });\n      }\n\n      const playlistEpisode = await storage.addEpisodeToPlaylist(playlistId, episodeId);\n      res.status(201).json(playlistEpisode);\n    } catch (error) {\n      console.error(\"Error adding episode to playlist:\", error);\n      res.status(500).json({ error: \"Failed to add episode to playlist\" });\n    }\n  });\n\n  // Remove episode from playlist\n  app.delete(\"/api/playlists/:id/episodes/:episodeId\", requireAuth, async (req, res) => {\n    try {\n      const playlistId = req.params.id;\n      const episodeId = req.params.episodeId;\n      const userId = req.session.userId!;\n\n      const playlist = await storage.getPlaylist(playlistId);\n      if (!playlist) {\n        return res.status(404).json({ error: \"Playlist not found\" });\n      }\n\n      if (playlist.userId !== userId) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n\n      await storage.removeEpisodeFromPlaylist(playlistId, episodeId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error removing episode from playlist:\", error);\n      res.status(500).json({ error: \"Failed to remove episode from playlist\" });\n    }\n  });\n\n  // Reorder playlist episodes\n  app.put(\"/api/playlists/:id/reorder\", requireAuth, async (req, res) => {\n    try {\n      const playlistId = req.params.id;\n      const userId = req.session.userId!;\n      const { episodeIds } = req.body;\n\n      if (!Array.isArray(episodeIds)) {\n        return res.status(400).json({ error: \"Episode IDs must be an array\" });\n      }\n\n      const playlist = await storage.getPlaylist(playlistId);\n      if (!playlist) {\n        return res.status(404).json({ error: \"Playlist not found\" });\n      }\n\n      if (playlist.userId !== userId) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n\n      await storage.reorderPlaylistEpisodes(playlistId, episodeIds);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error reordering playlist:\", error);\n      res.status(500).json({ error: \"Failed to reorder playlist\" });\n    }\n  });\n\n  // Get single episode\n  app.get(\"/api/episodes/:id\", async (req, res) => {\n    try {\n      // Get user info if authenticated\n      let userRole: string | undefined;\n      if (req.session.userId) {\n        const user = await storage.getUser(req.session.userId);\n        userRole = user?.role;\n      }\n      \n      // Fetch enriched episode with access control\n      const result = await getEpisodeForResponse(\n        req.params.id,\n        req.session.userId,\n        userRole\n      );\n      \n      if (!result) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n      \n      if (!result.hasAccess) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n      \n      // Generate URLs for sharing and embedding\n      const siteUrl = getSiteUrl(req);\n      const canonicalUrl = getEpisodeCanonicalUrl(siteUrl, result.episode.podcastId, result.episode.id);\n      const embedUrl = getEpisodeEmbedUrl(siteUrl, result.episode.id);\n      const shareUrl = getEpisodeShareUrl(siteUrl, result.episode.podcastId, result.episode.id);\n      const embedCode = getEmbedIframeCode(embedUrl, result.episode.title);\n      \n      res.json({\n        ...result.episode,\n        canonicalUrl,\n        embedUrl,\n        shareUrl,\n        embedCode,\n      });\n    } catch (error) {\n      console.error(\"Error fetching episode:\", error);\n      res.status(500).json({ error: \"Failed to fetch episode\" });\n    }\n  });\n\n  // Create episode (protected - requires authentication)\n  app.post(\"/api/episodes\", requireAuth, async (req, res) => {\n    try {\n      const validatedData = insertEpisodeSchema.parse(req.body);\n      \n      // Verify the podcast exists and belongs to the authenticated user\n      const podcast = await storage.getPodcast(validatedData.podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      if (podcast.ownerId !== req.session.userId) {\n        return res.status(403).json({ error: \"Forbidden - You can only add episodes to your own podcasts\" });\n      }\n      \n      // Ensure audioFileSize is provided or can be fetched\n      let audioFileSize = validatedData.audioFileSize;\n      \n      if (!audioFileSize) {\n        // Attempt to fetch Content-Length if not provided\n        try {\n          const headResponse = await fetch(validatedData.audioUrl, { method: \"HEAD\" });\n          const contentLength = headResponse.headers.get(\"content-length\");\n          \n          if (contentLength && !isNaN(parseInt(contentLength))) {\n            audioFileSize = parseInt(contentLength);\n            console.log(`Auto-fetched audioFileSize: ${audioFileSize} bytes for ${validatedData.audioUrl}`);\n          } else {\n            return res.status(400).json({ \n              error: \"Unable to determine audio file size. Please provide audioFileSize or ensure the audio URL returns a Content-Length header.\" \n            });\n          }\n        } catch (error) {\n          console.error(`Failed to fetch audioFileSize for ${validatedData.audioUrl}:`, error);\n          return res.status(400).json({ \n            error: \"Unable to fetch audio file size. Please provide audioFileSize or ensure the audio URL is accessible.\" \n          });\n        }\n      }\n      \n      const episode = await storage.createEpisode({\n        ...validatedData,\n        audioFileSize,\n        publishedAt: validatedData.publishedAt ? new Date(validatedData.publishedAt) : undefined,\n      });\n      res.status(201).json(episode);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating episode:\", error);\n      res.status(500).json({ error: \"Failed to create episode\" });\n    }\n  });\n\n  // Update episode (protected - requires authentication and ownership)\n  app.patch(\"/api/episodes/:id\", requireAuth, async (req, res) => {\n    try {\n      const episodeId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Verify the episode exists and belongs to the authenticated user (or user is admin)\n      const episode = await storage.getEpisode(episodeId);\n      if (!episode) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n      \n      // Get podcast to check ownership\n      const podcast = await storage.getPodcast(episode.podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const user = await storage.getUser(userId);\n      const isOwner = podcast.ownerId === userId;\n      const isAdmin = user?.role === \"ADMIN\";\n      \n      if (!isOwner && !isAdmin) {\n        return res.status(403).json({ error: \"Forbidden - You can only edit episodes from your own podcasts\" });\n      }\n      \n      // Validate and update allowed fields (metadata only, not audio files)\n      const updateSchema = z.object({\n        title: z.string().min(1).optional(),\n        notes: z.string().optional(),\n        coverArtUrl: z.string().nullable().optional(),\n        coverArtAssetId: z.string().nullable().optional(),\n        visibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]).optional(),\n      });\n      \n      const validatedData = updateSchema.parse(req.body);\n      const updated = await storage.updateEpisode(episodeId, validatedData);\n      res.json(updated);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error updating episode:\", error);\n      res.status(500).json({ error: \"Failed to update episode\" });\n    }\n  });\n\n  // Upload new audio file for existing episode\n  app.post(\"/api/episodes/:id/audio\", requireAuth, uploadSingleAudio.single(\"audioFile\"), async (req, res) => {\n    const tempFiles: string[] = [];\n    try {\n      const userId = req.session.userId!;\n      const episodeId = req.params.id;\n      \n      // Verify the episode exists\n      const episode = await storage.getEpisode(episodeId);\n      if (!episode) {\n        return res.status(404).json({ error: \"Episodio no encontrado\" });\n      }\n      \n      // Get podcast to check ownership\n      const podcast = await storage.getPodcast(episode.podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast no encontrado\" });\n      }\n      \n      // Verify user is owner or admin\n      const user = await storage.getUser(userId);\n      const isOwner = podcast.ownerId === userId;\n      const isAdmin = user?.role === \"ADMIN\";\n      \n      if (!isOwner && !isAdmin) {\n        return res.status(403).json({ error: \"No tienes permiso para modificar este episodio\" });\n      }\n      \n      // Verify audio file was uploaded\n      const audioFile = req.file;\n      if (!audioFile) {\n        return res.status(400).json({ error: \"Debes subir un archivo de audio\" });\n      }\n      \n      // Add temp file for cleanup\n      tempFiles.push(audioFile.path);\n      \n      // Extract duration from MP3 metadata\n      let duration = 0;\n      try {\n        const metadata = await parseFile(audioFile.path);\n        duration = Math.round(metadata.format.duration || 0);\n      } catch (metadataError) {\n        console.warn(`Could not extract duration from ${audioFile.originalname}:`, metadataError);\n      }\n      \n      // Read file from disk into buffer\n      const fileBuffer = fs.readFileSync(audioFile.path);\n      const fileWithBuffer = {\n        ...audioFile,\n        buffer: fileBuffer\n      };\n      \n      // Upload new audio file\n      const audioAsset = await mediaOrchestrator.saveEpisodeAudio(\n        fileWithBuffer,\n        userId,\n        episodeId,\n        podcast.id\n      );\n      \n      // Delete old audio asset if it exists\n      if (episode.audioAssetId) {\n        try {\n          await mediaOrchestrator.deleteMediaAsset(episode.audioAssetId);\n        } catch (deleteError) {\n          console.warn(`Could not delete old audio asset ${episode.audioAssetId}:`, deleteError);\n        }\n      }\n      \n      // Update episode with new audio file\n      const updated = await storage.updateEpisode(episodeId, {\n        audioAssetId: audioAsset.id,\n        audioUrl: undefined, // Clear old URL, will be resolved from asset\n        duration,\n      });\n      \n      res.json(updated);\n    } catch (error: any) {\n      console.error(\"Error uploading new audio file:\", error);\n      res.status(500).json({ \n        error: \"Error al subir el archivo de audio\", \n        detail: error.message \n      });\n    } finally {\n      // Clean up temporary files\n      for (const filePath of tempFiles) {\n        try {\n          if (fs.existsSync(filePath)) {\n            fs.unlinkSync(filePath);\n          }\n        } catch (cleanupError) {\n          console.error(`Failed to cleanup temp file ${filePath}:`, cleanupError);\n        }\n      }\n    }\n  });\n\n  // Embed route - Returns responsive iframe-optimized HTML5 audio player\n  app.get(\"/embed/episode/:id\", async (req, res) => {\n    try {\n      // Use centralized helper for enriched episode with cover art fallback\n      let viewerId: string | undefined;\n      let userRole: string | undefined;\n      \n      if (req.session?.userId) {\n        const user = await storage.getUser(req.session.userId);\n        viewerId = req.session.userId;\n        userRole = user?.role;\n      }\n      \n      const result = await getEpisodeForResponse(req.params.id, viewerId, userRole);\n      \n      if (!result) {\n        res.status(404);\n        res.setHeader('Content-Type', 'text/html; charset=utf-8');\n        return res.send(`\n          <!DOCTYPE html>\n          <html lang=\"es\">\n            <head>\n              <meta charset=\"UTF-8\">\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n              <title>Episodio no encontrado</title>\n              <style>\n                body {\n                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  min-height: 200px;\n                  margin: 0;\n                  background: #f5f5f5;\n                  color: #333;\n                }\n              </style>\n            </head>\n            <body>\n              <p>Episodio no encontrado</p>\n            </body>\n          </html>\n        `);\n      }\n      \n      const { episode, podcast, hasAccess } = result;\n      \n      // IMPORTANT: Embed routes are public iframe surfaces with stricter approval requirements.\n      // Authenticated users (admin/owners/delegated roles): trust hasAccess from getEpisodeForResponse.\n      // Public users (unauthenticated): require BOTH episode AND podcast to be approved to prevent\n      // leaking embargoed branding/audio via iframe embedding.\n      let embedHasAccess = hasAccess;\n      if (!viewerId) {\n        // Public users require both podcast and episode to be approved\n        embedHasAccess = embedHasAccess && podcast?.status === \"APPROVED\";\n      }\n      \n      if (!embedHasAccess) {\n        res.status(404);\n        res.setHeader('Content-Type', 'text/html; charset=utf-8');\n        return res.send(`\n          <!DOCTYPE html>\n          <html lang=\"es\">\n            <head>\n              <meta charset=\"UTF-8\">\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n              <title>Episodio no encontrado</title>\n              <style>\n                body {\n                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  min-height: 200px;\n                  margin: 0;\n                  background: #f5f5f5;\n                  color: #333;\n                }\n              </style>\n            </head>\n            <body>\n              <p>Episodio no encontrado</p>\n            </body>\n          </html>\n        `);\n      }\n      \n      // Generate URLs\n      const siteUrl = getSiteUrl(req);\n      const canonicalUrl = getEpisodeCanonicalUrl(siteUrl, episode.podcastId, episode.id);\n      \n      // Escape HTML entities for safe rendering (requires non-null string input)\n      const escapeHtml = (str: string) => str\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;')\n        .replace(/\"/g, '&quot;')\n        .replace(/'/g, '&#039;');\n      \n      // Provide safe defaults before escaping\n      const safeEpisodeTitle = episode.title || 'Episodio sin tÃ­tulo';\n      const safePodcastTitle = podcast?.title || 'Podcast';\n      const safeDescription = episode.notes ? episode.notes.substring(0, 200) : safeEpisodeTitle;\n      // Use enriched episode's effective cover art (with automatic podcast fallback)\n      const safeCoverArtUrl = episode.effectiveCoverArtUrl || '';\n      const safeAudioUrl = episode.audioUrl || '';\n\n      const html = `<!DOCTYPE html>\n<html lang=\"es\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>${escapeHtml(safeEpisodeTitle)} - ${escapeHtml(safePodcastTitle)}</title>\n    \n    <!-- Open Graph meta tags -->\n    <meta property=\"og:type\" content=\"music.song\">\n    <meta property=\"og:title\" content=\"${escapeHtml(safeEpisodeTitle)}\">\n    <meta property=\"og:description\" content=\"${escapeHtml(safeDescription)}\">\n    <meta property=\"og:url\" content=\"${escapeHtml(canonicalUrl)}\">\n    ${safeCoverArtUrl ? `<meta property=\"og:image\" content=\"${escapeHtml(safeCoverArtUrl)}\">` : ''}\n    <meta property=\"og:audio\" content=\"${escapeHtml(safeAudioUrl)}\">\n    \n    <!-- Twitter Card meta tags -->\n    <meta name=\"twitter:card\" content=\"player\">\n    <meta name=\"twitter:title\" content=\"${escapeHtml(safeEpisodeTitle)}\">\n    <meta name=\"twitter:description\" content=\"${escapeHtml(safeDescription)}\">\n    ${safeCoverArtUrl ? `<meta name=\"twitter:image\" content=\"${escapeHtml(safeCoverArtUrl)}\">` : ''}\n    \n    <style>\n      * {\n        margin: 0;\n        padding: 0;\n        box-sizing: border-box;\n      }\n      \n      body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n        background: #ffffff;\n        overflow: hidden;\n      }\n      \n      .player-container {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 16px;\n        max-width: 420px;\n        height: 200px;\n        margin: 0 auto;\n        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);\n        border-radius: 8px;\n      }\n      \n      .cover-art {\n        width: 120px;\n        height: 120px;\n        border-radius: 8px;\n        object-fit: cover;\n        flex-shrink: 0;\n        background: rgba(0, 0, 0, 0.1);\n      }\n      \n      .player-content {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        min-width: 0;\n        color: white;\n      }\n      \n      .episode-title {\n        font-size: 16px;\n        font-weight: 700;\n        line-height: 1.3;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        display: -webkit-box;\n        -webkit-line-clamp: 2;\n        -webkit-box-orient: vertical;\n      }\n      \n      .podcast-title {\n        font-size: 13px;\n        opacity: 0.9;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n      \n      audio {\n        width: 100%;\n        height: 40px;\n        outline: none;\n      }\n      \n      .cta-link {\n        display: inline-block;\n        padding: 6px 12px;\n        background: rgba(255, 255, 255, 0.2);\n        backdrop-filter: blur(10px);\n        border-radius: 6px;\n        color: white;\n        text-decoration: none;\n        font-size: 12px;\n        font-weight: 600;\n        transition: background 0.2s;\n        text-align: center;\n      }\n      \n      .cta-link:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n      \n      @media (max-width: 380px) {\n        .cover-art {\n          width: 80px;\n          height: 80px;\n        }\n        .episode-title {\n          font-size: 14px;\n        }\n        .podcast-title {\n          font-size: 12px;\n        }\n      }\n    </style>\n  </head>\n  <body>\n    <div class=\"player-container\">\n      ${safeCoverArtUrl && safeCoverArtUrl.trim() ? `<img src=\"${escapeHtml(safeCoverArtUrl)}\" alt=\"${escapeHtml(safePodcastTitle)}\" class=\"cover-art\">` : ''}\n      <div class=\"player-content\">\n        <h2 class=\"episode-title\">${escapeHtml(safeEpisodeTitle)}</h2>\n        ${podcast ? `<p class=\"podcast-title\">${escapeHtml(safePodcastTitle)}</p>` : ''}\n        <audio controls preload=\"metadata\">\n          <source src=\"${escapeHtml(safeAudioUrl)}\" type=\"audio/mpeg\">\n          Tu navegador no soporta el elemento de audio.\n        </audio>\n        <a href=\"${escapeHtml(canonicalUrl)}\" target=\"_blank\" class=\"cta-link\" rel=\"noopener noreferrer\">\n          Ver episodio completo â†’\n        </a>\n      </div>\n    </div>\n  </body>\n</html>`;\n\n      // Set appropriate headers for iframe embedding (allow all origins for multitenant use)\n      res.setHeader('Content-Type', 'text/html; charset=utf-8');\n      // Use CSP frame-ancestors instead of deprecated X-Frame-Options\n      res.setHeader('Content-Security-Policy', \"frame-ancestors *;\");\n      res.send(html);\n    } catch (error) {\n      console.error(\"Error in embed route:\", error);\n      res.status(500).send(\"Error loading episode\");\n    }\n  });\n\n  // ==================== CONTENT INVITATION ROUTES ====================\n  \n  // Create invitation for a podcast\n  app.post(\"/api/podcasts/:id/invitations\", requireAuth, async (req, res) => {\n    try {\n      const podcastId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Verify podcast exists and user is the owner\n      const podcast = await storage.getPodcast(podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const user = await storage.getUser(userId);\n      const isAdmin = user?.role === \"ADMIN\";\n      const isOwner = podcast.ownerId === userId;\n      \n      if (!isOwner && !isAdmin) {\n        return res.status(403).json({ error: \"Forbidden - Only the podcast owner can invite users\" });\n      }\n      \n      // Validate request body\n      const invitationSchema = z.object({\n        email: z.string().email(\"Invalid email address\"),\n        expiresAt: z.string().datetime().optional(),\n      });\n      \n      const validatedData = invitationSchema.parse(req.body);\n      \n      // Create invitation\n      const invitation = await storage.createContentInvitation({\n        email: validatedData.email,\n        podcastId,\n        episodeId: null,\n        invitedBy: userId,\n        expiresAt: validatedData.expiresAt ? new Date(validatedData.expiresAt) : null,\n      });\n      \n      // TODO: Send invitation email using email service\n      // const emailService = getEmailService();\n      // await emailService.sendInvitationEmail(...)\n      \n      res.status(201).json(invitation);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating podcast invitation:\", error);\n      res.status(500).json({ error: \"Failed to create invitation\" });\n    }\n  });\n  \n  // Get invitations for a podcast\n  app.get(\"/api/podcasts/:id/invitations\", requireAuth, async (req, res) => {\n    try {\n      const podcastId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Verify podcast exists and user is the owner\n      const podcast = await storage.getPodcast(podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const user = await storage.getUser(userId);\n      const isAdmin = user?.role === \"ADMIN\";\n      const isOwner = podcast.ownerId === userId;\n      \n      if (!isOwner && !isAdmin) {\n        return res.status(403).json({ error: \"Forbidden - Only the podcast owner can view invitations\" });\n      }\n      \n      const invitations = await storage.getContentInvitationsByPodcast(podcastId);\n      res.json(invitations);\n    } catch (error) {\n      console.error(\"Error fetching podcast invitations:\", error);\n      res.status(500).json({ error: \"Failed to fetch invitations\" });\n    }\n  });\n  \n  // Create invitation for an episode\n  app.post(\"/api/episodes/:id/invitations\", requireAuth, async (req, res) => {\n    try {\n      const episodeId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Verify episode exists and user is the owner\n      const episode = await storage.getEpisode(episodeId);\n      if (!episode) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n      \n      const podcast = await storage.getPodcast(episode.podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const user = await storage.getUser(userId);\n      const isAdmin = user?.role === \"ADMIN\";\n      const isOwner = podcast.ownerId === userId;\n      \n      if (!isOwner && !isAdmin) {\n        return res.status(403).json({ error: \"Forbidden - Only the podcast owner can invite users to episodes\" });\n      }\n      \n      // Validate request body\n      const invitationSchema = z.object({\n        email: z.string().email(\"Invalid email address\"),\n        expiresAt: z.string().datetime().optional(),\n      });\n      \n      const validatedData = invitationSchema.parse(req.body);\n      \n      // Create invitation\n      const invitation = await storage.createContentInvitation({\n        email: validatedData.email,\n        podcastId: null,\n        episodeId,\n        invitedBy: userId,\n        expiresAt: validatedData.expiresAt ? new Date(validatedData.expiresAt) : null,\n      });\n      \n      // TODO: Send invitation email using email service\n      \n      res.status(201).json(invitation);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating episode invitation:\", error);\n      res.status(500).json({ error: \"Failed to create invitation\" });\n    }\n  });\n  \n  // Get invitations for an episode\n  app.get(\"/api/episodes/:id/invitations\", requireAuth, async (req, res) => {\n    try {\n      const episodeId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Verify episode exists and user is the owner\n      const episode = await storage.getEpisode(episodeId);\n      if (!episode) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n      \n      const podcast = await storage.getPodcast(episode.podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const user = await storage.getUser(userId);\n      const isAdmin = user?.role === \"ADMIN\";\n      const isOwner = podcast.ownerId === userId;\n      \n      if (!isOwner && !isAdmin) {\n        return res.status(403).json({ error: \"Forbidden - Only the podcast owner can view episode invitations\" });\n      }\n      \n      const invitations = await storage.getContentInvitationsByEpisode(episodeId);\n      res.json(invitations);\n    } catch (error) {\n      console.error(\"Error fetching episode invitations:\", error);\n      res.status(500).json({ error: \"Failed to fetch invitations\" });\n    }\n  });\n  \n  // Create an invitation (generic endpoint that accepts podcastId or episodeId)\n  app.post(\"/api/invitations\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      \n      // Validate request body - exactly one of podcastId or episodeId must be present\n      const invitationSchema = z.object({\n        email: z.string().email(\"Invalid email address\"),\n        podcastId: z.string().optional(),\n        episodeId: z.string().optional(),\n        expiresAt: z.string().datetime().optional(),\n      }).refine(\n        data => (data.podcastId && !data.episodeId) || (!data.podcastId && data.episodeId),\n        { message: \"Exactly one of podcastId or episodeId must be provided\" }\n      );\n      \n      const validatedData = invitationSchema.parse(req.body);\n      \n      // Verify permissions based on content type\n      if (validatedData.podcastId) {\n        // Verify podcast exists and user is the owner\n        const podcast = await storage.getPodcast(validatedData.podcastId);\n        if (!podcast) {\n          return res.status(404).json({ error: \"Podcast not found\" });\n        }\n        \n        const user = await storage.getUser(userId);\n        const isAdmin = user?.role === \"ADMIN\";\n        const isOwner = podcast.ownerId === userId;\n        \n        if (!isOwner && !isAdmin) {\n          return res.status(403).json({ error: \"Forbidden - Only the podcast owner can invite users\" });\n        }\n        \n        // Create podcast invitation\n        const invitation = await storage.createContentInvitation({\n          email: validatedData.email,\n          podcastId: validatedData.podcastId,\n          episodeId: null,\n          invitedBy: userId,\n          expiresAt: validatedData.expiresAt ? new Date(validatedData.expiresAt) : null,\n        });\n        \n        return res.status(201).json(invitation);\n      } else if (validatedData.episodeId) {\n        // Verify episode exists and user is the owner\n        const episode = await storage.getEpisode(validatedData.episodeId);\n        if (!episode) {\n          return res.status(404).json({ error: \"Episode not found\" });\n        }\n        \n        const podcast = await storage.getPodcast(episode.podcastId);\n        if (!podcast) {\n          return res.status(404).json({ error: \"Podcast not found\" });\n        }\n        \n        const user = await storage.getUser(userId);\n        const isAdmin = user?.role === \"ADMIN\";\n        const isOwner = podcast.ownerId === userId;\n        \n        if (!isOwner && !isAdmin) {\n          return res.status(403).json({ error: \"Forbidden - Only the podcast owner can invite users to episodes\" });\n        }\n        \n        // Create episode invitation\n        const invitation = await storage.createContentInvitation({\n          email: validatedData.email,\n          podcastId: null,\n          episodeId: validatedData.episodeId,\n          invitedBy: userId,\n          expiresAt: validatedData.expiresAt ? new Date(validatedData.expiresAt) : null,\n        });\n        \n        return res.status(201).json(invitation);\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating invitation:\", error);\n      res.status(500).json({ error: \"Failed to create invitation\" });\n    }\n  });\n  \n  // Delete an invitation\n  app.delete(\"/api/invitations/:id\", requireAuth, async (req, res) => {\n    try {\n      const invitationId = req.params.id;\n      const userId = req.session.userId!;\n      \n      // Verify invitation exists\n      const invitation = await storage.getContentInvitation(invitationId);\n      if (!invitation) {\n        return res.status(404).json({ error: \"Invitation not found\" });\n      }\n      \n      // Verify user is the one who created the invitation or is admin\n      const user = await storage.getUser(userId);\n      const isAdmin = user?.role === \"ADMIN\";\n      const isInviter = invitation.invitedBy === userId;\n      \n      if (!isInviter && !isAdmin) {\n        return res.status(403).json({ error: \"Forbidden - You can only delete invitations you created\" });\n      }\n      \n      await storage.deleteContentInvitation(invitationId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting invitation:\", error);\n      res.status(500).json({ error: \"Failed to delete invitation\" });\n    }\n  });\n\n  // ==================== ADMIN ROUTES ====================\n  \n  // User Management\n  app.get(\"/api/admin/users\", requireAdmin, async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      // Exclude password hashes from response\n      const usersWithoutPasswords = users.map(({ passwordHash: _, ...user }) => user);\n      res.json(usersWithoutPasswords);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n  \n  app.patch(\"/api/admin/users/:id/role\", requireAdmin, async (req, res) => {\n    try {\n      const userId = req.params.id;\n      const validatedData = updateUserRoleSchema.parse(req.body);\n      \n      // Check if user exists\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      // Prevent demoting the last admin\n      if (user.role === \"ADMIN\" && validatedData.role !== \"ADMIN\") {\n        const allUsers = await storage.getAllUsers();\n        const adminCount = allUsers.filter(u => u.role === \"ADMIN\").length;\n        if (adminCount <= 1) {\n          return res.status(400).json({ error: \"Cannot demote the last admin\" });\n        }\n      }\n      \n      const updatedUser = await storage.updateUserRole(userId, validatedData.role);\n      const { passwordHash: _, ...userWithoutPassword } = updatedUser;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error updating user role:\", error);\n      res.status(500).json({ error: \"Failed to update user role\" });\n    }\n  });\n  \n  app.patch(\"/api/admin/users/:id/requires-approval\", requireAdmin, async (req, res) => {\n    try {\n      const userId = req.params.id;\n      const validatedData = updateUserApprovalSchema.parse(req.body);\n      \n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      const updatedUser = await storage.updateUserRequiresApproval(userId, validatedData.requiresApproval);\n      const { passwordHash: _, ...userWithoutPassword } = updatedUser;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error updating user approval status:\", error);\n      res.status(500).json({ error: \"Failed to update user approval status\" });\n    }\n  });\n  \n  app.patch(\"/api/admin/users/:id/active\", requireAdmin, async (req, res) => {\n    try {\n      const userId = req.params.id;\n      const validatedData = updateUserActiveSchema.parse(req.body);\n      \n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      // Prevent self-deactivation\n      if (userId === req.session.userId && !validatedData.isActive) {\n        return res.status(400).json({ error: \"Cannot deactivate your own account\" });\n      }\n      \n      const updatedUser = await storage.updateUserIsActive(userId, validatedData.isActive);\n      const { passwordHash: _, ...userWithoutPassword } = updatedUser;\n      res.json(userWithoutPassword);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error updating user active status:\", error);\n      res.status(500).json({ error: \"Failed to update user active status\" });\n    }\n  });\n  \n  // Podcast Moderation\n  app.get(\"/api/admin/podcasts\", requireAdmin, async (req, res) => {\n    try {\n      const query = adminPodcastsQuerySchema.parse(req.query);\n      const podcasts = await storage.listPodcastsFiltered(\n        query.status,\n        query.ownerId,\n        query.search\n      );\n      res.json(podcasts);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid query parameters\", details: error.errors });\n      }\n      console.error(\"Error fetching podcasts for admin:\", error);\n      res.status(500).json({ error: \"Failed to fetch podcasts\" });\n    }\n  });\n  \n  app.patch(\"/api/admin/podcasts/:id/status\", requireAdmin, async (req, res) => {\n    try {\n      const podcastId = req.params.id;\n      const validatedData = updatePodcastStatusSchema.parse(req.body);\n      \n      const podcast = await storage.getPodcast(podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      const updatedPodcast = await storage.updatePodcastStatus(\n        podcastId,\n        validatedData.status,\n        req.session.userId!\n      );\n      res.json(updatedPodcast);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error updating podcast status:\", error);\n      res.status(500).json({ error: \"Failed to update podcast status\" });\n    }\n  });\n  \n  app.delete(\"/api/admin/podcasts/:id\", requireAdmin, async (req, res) => {\n    try {\n      const podcastId = req.params.id;\n      \n      const podcast = await storage.getPodcast(podcastId);\n      if (!podcast) {\n        return res.status(404).json({ error: \"Podcast not found\" });\n      }\n      \n      await storage.deletePodcast(podcastId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting podcast:\", error);\n      res.status(500).json({ error: \"Failed to delete podcast\" });\n    }\n  });\n  \n  // Episode Moderation\n  app.get(\"/api/admin/episodes\", requireAdmin, async (req, res) => {\n    try {\n      const query = adminEpisodesQuerySchema.parse(req.query);\n      const episodes = await storage.listEpisodesFiltered(\n        query.status,\n        query.podcastId,\n        query.ownerId,\n        query.search\n      );\n      res.json(episodes);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid query parameters\", details: error.errors });\n      }\n      console.error(\"Error fetching episodes for admin:\", error);\n      res.status(500).json({ error: \"Failed to fetch episodes\" });\n    }\n  });\n  \n  app.patch(\"/api/admin/episodes/:id/status\", requireAdmin, async (req, res) => {\n    try {\n      const episodeId = req.params.id;\n      const validatedData = updateEpisodeStatusSchema.parse(req.body);\n      \n      const episode = await storage.getEpisode(episodeId);\n      if (!episode) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n      \n      const updatedEpisode = await storage.updateEpisodeStatus(\n        episodeId,\n        validatedData.status,\n        req.session.userId!\n      );\n      res.json(updatedEpisode);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error updating episode status:\", error);\n      res.status(500).json({ error: \"Failed to update episode status\" });\n    }\n  });\n  \n  app.delete(\"/api/admin/episodes/:id\", requireAdmin, async (req, res) => {\n    try {\n      const episodeId = req.params.id;\n      \n      const episode = await storage.getEpisode(episodeId);\n      if (!episode) {\n        return res.status(404).json({ error: \"Episode not found\" });\n      }\n      \n      await storage.deleteEpisode(episodeId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting episode:\", error);\n      res.status(500).json({ error: \"Failed to delete episode\" });\n    }\n  });\n\n  // Bulk operations - Users\n  app.post(\"/api/admin/users/bulk-update-role\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = bulkUpdateUsersRoleSchema.parse(req.body);\n      const result = await storage.bulkUpdateUsersRole(validatedData.ids, validatedData.role);\n      res.json({\n        message: `Updated ${result.successIds.length} user(s)`,\n        ...result,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error bulk updating user roles:\", error);\n      res.status(500).json({ error: \"Failed to bulk update user roles\" });\n    }\n  });\n\n  app.post(\"/api/admin/users/bulk-update-active\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = bulkUpdateUsersActiveSchema.parse(req.body);\n      const result = await storage.bulkUpdateUsersActive(validatedData.ids, validatedData.isActive);\n      res.json({\n        message: `Updated ${result.successIds.length} user(s)`,\n        ...result,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error bulk updating user active status:\", error);\n      res.status(500).json({ error: \"Failed to bulk update user active status\" });\n    }\n  });\n\n  app.post(\"/api/admin/users/bulk-delete\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = bulkDeleteUsersSchema.parse(req.body);\n      const result = await storage.bulkDeleteUsers(validatedData.ids);\n      res.json({\n        message: `Deleted ${result.successIds.length} user(s)`,\n        ...result,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error bulk deleting users:\", error);\n      res.status(500).json({ error: \"Failed to bulk delete users\" });\n    }\n  });\n\n  // Bulk operations - Podcasts\n  app.post(\"/api/admin/podcasts/bulk-update-status\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = bulkUpdatePodcastsStatusSchema.parse(req.body);\n      const result = await storage.bulkUpdatePodcastsStatus(\n        validatedData.ids,\n        validatedData.status,\n        req.session.userId!\n      );\n      res.json({\n        message: `Updated ${result.successIds.length} podcast(s)`,\n        ...result,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error bulk updating podcast status:\", error);\n      res.status(500).json({ error: \"Failed to bulk update podcast status\" });\n    }\n  });\n\n  app.post(\"/api/admin/podcasts/bulk-delete\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = bulkDeletePodcastsSchema.parse(req.body);\n      const result = await storage.bulkDeletePodcasts(validatedData.ids);\n      res.json({\n        message: `Deleted ${result.successIds.length} podcast(s)`,\n        ...result,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error bulk deleting podcasts:\", error);\n      res.status(500).json({ error: \"Failed to bulk delete podcasts\" });\n    }\n  });\n\n  // Bulk operations - Episodes\n  app.post(\"/api/admin/episodes/bulk-update-status\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = bulkUpdateEpisodesStatusSchema.parse(req.body);\n      const result = await storage.bulkUpdateEpisodesStatus(\n        validatedData.ids,\n        validatedData.status,\n        req.session.userId!\n      );\n      res.json({\n        message: `Updated ${result.successIds.length} episode(s)`,\n        ...result,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error bulk updating episode status:\", error);\n      res.status(500).json({ error: \"Failed to bulk update episode status\" });\n    }\n  });\n\n  app.post(\"/api/admin/episodes/bulk-delete\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = bulkDeleteEpisodesSchema.parse(req.body);\n      const result = await storage.bulkDeleteEpisodes(validatedData.ids);\n      res.json({\n        message: `Deleted ${result.successIds.length} episode(s)`,\n        ...result,\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error bulk deleting episodes:\", error);\n      res.status(500).json({ error: \"Failed to bulk delete episodes\" });\n    }\n  });\n\n  // Email configuration endpoints\n  app.get(\"/api/admin/email-config\", requireAdmin, async (req, res) => {\n    try {\n      const configs = await storage.getAllEmailConfigs();\n      // Mask password in response for security\n      const maskedConfigs = configs.map(config => ({\n        ...config,\n        smtpPassword: \"********\",\n      }));\n      res.json(maskedConfigs);\n    } catch (error) {\n      console.error(\"Error fetching email configs:\", error);\n      res.status(500).json({ error: \"Failed to fetch email configurations\" });\n    }\n  });\n\n  app.get(\"/api/admin/email-config/active\", requireAdmin, async (req, res) => {\n    try {\n      const config = await storage.getActiveEmailConfig();\n      if (!config) {\n        return res.status(404).json({ error: \"No active email configuration found\" });\n      }\n      // Mask password in response for security\n      res.json({\n        ...config,\n        smtpPassword: \"********\",\n      });\n    } catch (error) {\n      console.error(\"Error fetching active email config:\", error);\n      res.status(500).json({ error: \"Failed to fetch active email configuration\" });\n    }\n  });\n\n  app.post(\"/api/admin/email-config\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = createEmailConfigSchema.parse(req.body);\n      const newConfig = await storage.createEmailConfig(validatedData);\n      \n      // Mask password in response for security\n      res.status(201).json({\n        ...newConfig,\n        smtpPassword: \"********\",\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error creating email config:\", error);\n      res.status(500).json({ error: \"Failed to create email configuration\" });\n    }\n  });\n\n  app.patch(\"/api/admin/email-config/:id\", requireAdmin, async (req, res) => {\n    try {\n      const configId = req.params.id;\n      const validatedData = updateEmailConfigSchema.parse(req.body);\n      \n      const existingConfig = await storage.getAllEmailConfigs();\n      if (!existingConfig.find(c => c.id === configId)) {\n        return res.status(404).json({ error: \"Email configuration not found\" });\n      }\n      \n      const updatedConfig = await storage.updateEmailConfig(configId, validatedData);\n      \n      // Mask password in response for security\n      res.json({\n        ...updatedConfig,\n        smtpPassword: \"********\",\n      });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error updating email config:\", error);\n      res.status(500).json({ error: \"Failed to update email configuration\" });\n    }\n  });\n\n  app.patch(\"/api/admin/email-config/:id/activate\", requireAdmin, async (req, res) => {\n    try {\n      const configId = req.params.id;\n      const activeConfig = await storage.setActiveEmailConfig(configId);\n      \n      // Mask password in response for security\n      res.json({\n        ...activeConfig,\n        smtpPassword: \"********\",\n      });\n    } catch (error) {\n      console.error(\"Error activating email config:\", error);\n      res.status(500).json({ error: \"Failed to activate email configuration\" });\n    }\n  });\n\n  app.delete(\"/api/admin/email-config/:id\", requireAdmin, async (req, res) => {\n    try {\n      const configId = req.params.id;\n      \n      const existingConfig = await storage.getAllEmailConfigs();\n      if (!existingConfig.find(c => c.id === configId)) {\n        return res.status(404).json({ error: \"Email configuration not found\" });\n      }\n      \n      await storage.deleteEmailConfig(configId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting email config:\", error);\n      res.status(500).json({ error: \"Failed to delete email configuration\" });\n    }\n  });\n\n  // Test email configuration - sends a test email with branded template\n  app.post(\"/api/admin/email-config/test\", requireAdmin, async (req, res) => {\n    try {\n      const config = await storage.getActiveEmailConfig();\n      \n      if (!config) {\n        return res.status(404).json({ error: \"No hay configuraciÃ³n de email activa. Guarda la configuraciÃ³n primero.\" });\n      }\n\n      if (!config.isActive) {\n        return res.status(400).json({ error: \"La configuraciÃ³n de email no estÃ¡ activa.\" });\n      }\n\n      // Create nodemailer transporter with stored config\n      const nodemailer = await import(\"nodemailer\");\n      const { getEmailTemplate } = await import(\"./email-templates\");\n      \n      const transporter = nodemailer.default.createTransport({\n        host: config.smtpHost,\n        port: config.smtpPort,\n        secure: config.smtpSecure,\n        auth: {\n          user: config.smtpUser,\n          pass: config.smtpPassword,\n        },\n        connectionTimeout: 10000,\n        greetingTimeout: 5000,\n        socketTimeout: 10000,\n      });\n\n      // Load logo for email\n      const logoPath = path.join(process.cwd(), \"attached_assets\", \"audivia-logo.png\");\n      const attachments: any[] = [];\n      let logoBase64: string | undefined;\n      \n      if (fs.existsSync(logoPath)) {\n        attachments.push({\n          filename: \"audivia-logo.png\",\n          path: logoPath,\n          cid: \"audivia-logo\",\n        });\n        logoBase64 = fs.readFileSync(logoPath).toString(\"base64\");\n      }\n\n      // Generate branded test email\n      const testContent = `\n        <div style=\"text-align: center; margin-bottom: 24px;\">\n          <span style=\"font-size: 48px;\">&#9989;</span>\n        </div>\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n          Â¡ConfiguraciÃ³n Exitosa!\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0; text-align: center;\">\n          Este es un email de prueba desde <strong style=\"color: #A78BFA;\">Audivia</strong>.\n        </p>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0; text-align: center;\">\n          Si recibes este mensaje, la configuraciÃ³n SMTP estÃ¡ funcionando correctamente.\n        </p>\n        \n        <div style=\"background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(91, 33, 182, 0.1) 100%); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 12px; padding: 24px; margin: 24px 0;\">\n          <h3 style=\"color: white; margin: 0 0 15px 0; font-size: 16px;\">ConfiguraciÃ³n utilizada:</h3>\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr>\n              <td style=\"padding: 8px 0; color: #9ca3af; font-size: 14px;\">Servidor:</td>\n              <td style=\"padding: 8px 0; text-align: right; color: #d1d5db;\">${config.smtpHost}:${config.smtpPort}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 8px 0; color: #9ca3af; font-size: 14px;\">SSL/TLS:</td>\n              <td style=\"padding: 8px 0; text-align: right; color: #d1d5db;\">${config.smtpSecure ? 'Activado' : 'Desactivado'}</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 8px 0; color: #9ca3af; font-size: 14px;\">Remitente:</td>\n              <td style=\"padding: 8px 0; text-align: right; color: #d1d5db;\">${config.fromName}</td>\n            </tr>\n          </table>\n        </div>\n      `;\n\n      const html = getEmailTemplate(testContent, false, logoBase64);\n\n      // Send test email to the configured sender email\n      await transporter.sendMail({\n        from: `\"${config.fromName}\" <${config.fromEmail}>`,\n        to: config.smtpUser,\n        subject: \"Email de prueba - Audivia\",\n        html,\n        attachments,\n      });\n\n      console.log(`[EMAIL] Test email sent successfully to ${config.smtpUser}`);\n      res.json({ success: true, message: \"Email de prueba enviado correctamente\" });\n    } catch (error: any) {\n      console.error(\"Error sending test email:\", error);\n      \n      // Provide more helpful error messages\n      let errorMessage = \"Error al enviar email de prueba\";\n      let details = error.message || \"Verifica la configuraciÃ³n SMTP\";\n      \n      if (error.code === \"ESOCKET\" || error.code === \"ECONNREFUSED\") {\n        details = \"No se pudo conectar al servidor SMTP. Verifica que el servidor y puerto sean correctos, o que el firewall permita la conexiÃ³n.\";\n      } else if (error.code === \"EAUTH\") {\n        details = \"Error de autenticaciÃ³n. Verifica el usuario y contraseÃ±a SMTP.\";\n      } else if (error.code === \"ETIMEDOUT\") {\n        details = \"Tiempo de conexiÃ³n agotado. El servidor SMTP no responde.\";\n      }\n      \n      res.status(500).json({ error: errorMessage, details });\n    }\n  });\n\n  // Get email template previews\n  app.get(\"/api/admin/email-templates\", requireAdmin, async (req, res) => {\n    try {\n      const { getAllTemplates } = await import(\"./email-templates\");\n      const logoPath = path.join(process.cwd(), \"attached_assets\", \"audivia-logo.png\");\n      let logoBase64: string | undefined;\n      \n      if (fs.existsSync(logoPath)) {\n        logoBase64 = fs.readFileSync(logoPath).toString(\"base64\");\n      }\n      \n      const templates = getAllTemplates(logoBase64);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching email templates:\", error);\n      res.status(500).json({ error: \"Failed to fetch email templates\" });\n    }\n  });\n\n  // Get single email template preview\n  app.get(\"/api/admin/email-templates/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { getTemplatePreview } = await import(\"./email-templates\");\n      const logoPath = path.join(process.cwd(), \"attached_assets\", \"audivia-logo.png\");\n      let logoBase64: string | undefined;\n      \n      if (fs.existsSync(logoPath)) {\n        logoBase64 = fs.readFileSync(logoPath).toString(\"base64\");\n      }\n      \n      const template = getTemplatePreview(req.params.id, logoBase64);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error fetching email template:\", error);\n      res.status(500).json({ error: \"Failed to fetch email template\" });\n    }\n  });\n\n  // Render email template HTML (for iframe preview)\n  app.get(\"/api/admin/email-templates/:id/html\", requireAdmin, async (req, res) => {\n    try {\n      const { getTemplatePreview } = await import(\"./email-templates\");\n      const logoPath = path.join(process.cwd(), \"attached_assets\", \"audivia-logo.png\");\n      let logoBase64: string | undefined;\n      \n      if (fs.existsSync(logoPath)) {\n        logoBase64 = fs.readFileSync(logoPath).toString(\"base64\");\n      }\n      \n      const template = getTemplatePreview(req.params.id, logoBase64);\n      if (!template) {\n        return res.status(404).send(\"Template not found\");\n      }\n      res.setHeader(\"Content-Type\", \"text/html\");\n      res.send(template.html);\n    } catch (error) {\n      console.error(\"Error rendering email template:\", error);\n      res.status(500).send(\"Failed to render email template\");\n    }\n  });\n\n  // PATCH email config without ID (update or create the active one)\n  app.patch(\"/api/admin/email-config\", requireAdmin, async (req, res) => {\n    try {\n      const validatedData = updateEmailConfigSchema.parse(req.body);\n      \n      // Check if there's an existing config\n      const configs = await storage.getAllEmailConfigs();\n      \n      if (configs.length > 0) {\n        // Update the first config\n        const updatedConfig = await storage.updateEmailConfig(configs[0].id, {\n          ...validatedData,\n          isActive: true,\n        });\n        \n        res.json({\n          ...updatedConfig,\n          smtpPassword: \"********\",\n        });\n      } else {\n        // Create new config\n        const newConfig = await storage.createEmailConfig({\n          ...validatedData,\n          smtpPassword: validatedData.smtpPassword || \"\",\n          isActive: true,\n        });\n        \n        res.status(201).json({\n          ...newConfig,\n          smtpPassword: \"********\",\n        });\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request data\", details: error.errors });\n      }\n      console.error(\"Error updating email config:\", error);\n      res.status(500).json({ error: \"Failed to update email configuration\" });\n    }\n  });\n\n  // External services endpoints\n  app.get(\"/api/admin/external-services\", requireAdmin, async (req, res) => {\n    try {\n      const services = await storage.getExternalServices();\n      res.json(services);\n    } catch (error) {\n      console.error(\"Error fetching external services:\", error);\n      res.status(500).json({ error: \"Error al obtener servicios externos\" });\n    }\n  });\n\n  app.post(\"/api/admin/external-services\", requireAdmin, async (req, res) => {\n    try {\n      const { name, description, url, iconName, sortOrder, isActive } = req.body;\n      \n      if (!name || !url) {\n        return res.status(400).json({ error: \"Nombre y URL son requeridos\" });\n      }\n\n      const service = await storage.createExternalService({\n        name,\n        description: description || null,\n        url,\n        iconName: iconName || \"ExternalLink\",\n        sortOrder: sortOrder || 0,\n        isActive: isActive !== false,\n      });\n      \n      res.status(201).json(service);\n    } catch (error) {\n      console.error(\"Error creating external service:\", error);\n      res.status(500).json({ error: \"Error al crear servicio externo\" });\n    }\n  });\n\n  app.patch(\"/api/admin/external-services/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { name, description, url, iconName, sortOrder, isActive } = req.body;\n      \n      const existing = await storage.getExternalService(id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Servicio no encontrado\" });\n      }\n\n      const updated = await storage.updateExternalService(id, {\n        ...(name !== undefined && { name }),\n        ...(description !== undefined && { description }),\n        ...(url !== undefined && { url }),\n        ...(iconName !== undefined && { iconName }),\n        ...(sortOrder !== undefined && { sortOrder }),\n        ...(isActive !== undefined && { isActive }),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating external service:\", error);\n      res.status(500).json({ error: \"Error al actualizar servicio externo\" });\n    }\n  });\n\n  app.delete(\"/api/admin/external-services/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const existing = await storage.getExternalService(id);\n      if (!existing) {\n        return res.status(404).json({ error: \"Servicio no encontrado\" });\n      }\n\n      await storage.deleteExternalService(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting external service:\", error);\n      res.status(500).json({ error: \"Error al eliminar servicio externo\" });\n    }\n  });\n\n  // Emergency endpoint to reset admin password (use only once in production)\n  app.post(\"/api/emergency/reset-admin-password\", async (req, res) => {\n    try {\n      // Security: Only allow if ADMIN_PASSWORD is set in environment\n      if (!process.env.ADMIN_PASSWORD) {\n        return res.status(403).json({ error: \"Emergency reset not configured\" });\n      }\n\n      // Get admin email from environment or default\n      const adminEmail = process.env.ADMIN_EMAIL || \"admin@podcasthub.local\";\n      \n      // Find admin user\n      const user = await storage.getUserByEmail(adminEmail);\n      if (!user) {\n        return res.status(404).json({ error: \"Admin user not found\" });\n      }\n\n      if (user.role !== \"ADMIN\") {\n        return res.status(403).json({ error: \"User is not an admin\" });\n      }\n\n      // Hash the new password from environment\n      const newPasswordHash = await bcrypt.hash(process.env.ADMIN_PASSWORD, 10);\n      \n      // Update password\n      await storage.updateUserPassword(user.id, newPasswordHash);\n      \n      res.json({ \n        message: \"Admin password reset successfully\",\n        email: adminEmail,\n        note: \"You can now login with the password from ADMIN_PASSWORD environment variable\"\n      });\n    } catch (error) {\n      console.error(\"Error resetting admin password:\", error);\n      res.status(500).json({ error: \"Failed to reset admin password\" });\n    }\n  });\n\n  // ==================== PayPal Routes ====================\n\n  // Get PayPal client configuration (public)\n  app.get(\"/api/paypal/config\", async (req, res) => {\n    try {\n      const config = await paypalService.getPayPalClientId();\n      if (!config) {\n        return res.status(404).json({ error: \"PayPal no estÃ¡ configurado\" });\n      }\n      res.json(config);\n    } catch (error: any) {\n      console.error(\"Error getting PayPal config:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo configuraciÃ³n de PayPal\" });\n    }\n  });\n\n  // Check if PayPal is configured\n  app.get(\"/api/paypal/status\", async (req, res) => {\n    try {\n      const isConfigured = await paypalService.isPayPalConfigured();\n      res.json({ isConfigured });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Get PayPal client ID for frontend\n  app.get(\"/api/paypal/client-id\", async (req, res) => {\n    try {\n      const config = await paypalService.getPayPalClientId();\n      if (!config) {\n        return res.status(404).json({ error: \"PayPal no estÃ¡ configurado\" });\n      }\n      res.json(config);\n    } catch (error: any) {\n      console.error(\"Error getting PayPal client ID:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo cliente de PayPal\" });\n    }\n  });\n\n  // ===== CART PAYPAL ENDPOINTS =====\n\n  // Create order for cart checkout\n  app.post(\"/api/paypal/create-cart-order\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const { discountCode: discountCodeInput } = req.body || {};\n      const cartItems = await storage.getCartItems(userId);\n      \n      if (cartItems.length === 0) {\n        return res.status(400).json({ error: \"El carrito estÃ¡ vacÃ­o\" });\n      }\n\n      const cartTotal = await storage.getCartTotal(userId);\n      let finalTotalCents = cartTotal.totalCents;\n      let discountAmountCents = 0;\n      let validatedDiscountCode = null;\n      \n      // Validate and apply discount if provided - using server-side validation\n      if (discountCodeInput) {\n        const validation = await storage.validateDiscountCode(\n          discountCodeInput,\n          userId,\n          cartTotal.totalCents,\n          false // forSubscription = false for cart purchases\n        );\n        \n        if (validation.valid && validation.discountCode) {\n          validatedDiscountCode = validation.discountCode;\n          \n          // Calculate discount server-side\n          if (validatedDiscountCode.type === \"PERCENTAGE\") {\n            discountAmountCents = Math.round((cartTotal.totalCents * validatedDiscountCode.value) / 100);\n          } else {\n            discountAmountCents = Math.min(validatedDiscountCode.value, cartTotal.totalCents);\n          }\n          finalTotalCents = Math.max(0, cartTotal.totalCents - discountAmountCents);\n          \n          // Store validated discount in session for capture validation\n          req.session.pendingDiscount = {\n            discountCodeId: validatedDiscountCode.id,\n            discountCode: validatedDiscountCode.code,\n            discountAmountCents,\n            originalTotalCents: cartTotal.totalCents,\n            finalTotalCents,\n          };\n        }\n      } else {\n        // Clear any pending discount if no code provided\n        req.session.pendingDiscount = undefined;\n      }\n      \n      // Get PayPal config\n      const paypalConfig = await storage.getPayPalConfig();\n      if (!paypalConfig?.clientId || !paypalConfig?.clientSecret) {\n        return res.status(500).json({ error: \"PayPal no estÃ¡ configurado\" });\n      }\n\n      // Get PayPal access token\n      const tokenResponse = await fetch(\n        `${paypalConfig.sandbox ? \"https://api-m.sandbox.paypal.com\" : \"https://api-m.paypal.com\"}/v1/oauth2/token`,\n        {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n            Authorization: `Basic ${Buffer.from(`${paypalConfig.clientId}:${paypalConfig.clientSecret}`).toString(\"base64\")}`,\n          },\n          body: \"grant_type=client_credentials\",\n        }\n      );\n      \n      const tokenData = await tokenResponse.json();\n      const accessToken = tokenData.access_token;\n\n      // Create PayPal order with discount breakdown if applicable\n      const breakdown: any = {\n        item_total: {\n          currency_code: cartTotal.currency,\n          value: (cartTotal.totalCents / 100).toFixed(2),\n        },\n      };\n      \n      if (discountAmountCents > 0) {\n        breakdown.discount = {\n          currency_code: cartTotal.currency,\n          value: (discountAmountCents / 100).toFixed(2),\n        };\n      }\n\n      // Create PayPal order\n      const orderResponse = await fetch(\n        `${paypalConfig.sandbox ? \"https://api-m.sandbox.paypal.com\" : \"https://api-m.paypal.com\"}/v2/checkout/orders`,\n        {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: `Bearer ${accessToken}`,\n          },\n          body: JSON.stringify({\n            intent: \"CAPTURE\",\n            purchase_units: [\n              {\n                amount: {\n                  currency_code: cartTotal.currency,\n                  value: (finalTotalCents / 100).toFixed(2),\n                  breakdown,\n                },\n                items: cartItems.map(item => ({\n                  name: item.audiobook.title.substring(0, 127),\n                  quantity: \"1\",\n                  unit_amount: {\n                    currency_code: item.audiobook.currency,\n                    value: (item.audiobook.priceCents / 100).toFixed(2),\n                  },\n                  category: \"DIGITAL_GOODS\",\n                })),\n                description: `Compra de ${cartItems.length} audiolibro(s) en Audivia${validatedDiscountCode ? ` (Descuento: ${validatedDiscountCode.code})` : \"\"}`,\n              },\n            ],\n            application_context: {\n              brand_name: \"Audivia\",\n              landing_page: \"NO_PREFERENCE\",\n              user_action: \"PAY_NOW\",\n            },\n          }),\n        }\n      );\n\n      const orderData = await orderResponse.json();\n      \n      if (!orderResponse.ok) {\n        console.error(\"PayPal order creation error:\", orderData);\n        return res.status(500).json({ error: \"Error creando orden de PayPal\" });\n      }\n\n      res.json({ \n        orderId: orderData.id, \n        discountApplied: validatedDiscountCode ? {\n          code: validatedDiscountCode.code,\n          discountAmountCents,\n          finalTotalCents,\n        } : null \n      });\n    } catch (error: any) {\n      console.error(\"Error creating cart PayPal order:\", error);\n      res.status(500).json({ error: error.message || \"Error creando orden de PayPal\" });\n    }\n  });\n\n  // Capture cart order\n  app.post(\"/api/paypal/capture-cart-order\", requireAuth, async (req, res) => {\n    try {\n      const { orderId } = req.body;\n      const userId = req.session.userId!;\n      \n      if (!orderId) {\n        return res.status(400).json({ error: \"orderId es requerido\" });\n      }\n\n      const cartItems = await storage.getCartItems(userId);\n      if (cartItems.length === 0) {\n        return res.status(400).json({ error: \"El carrito estÃ¡ vacÃ­o\" });\n      }\n\n      // Get PayPal config\n      const paypalConfig = await storage.getPayPalConfig();\n      if (!paypalConfig?.clientId || !paypalConfig?.clientSecret) {\n        return res.status(500).json({ error: \"PayPal no estÃ¡ configurado\" });\n      }\n\n      // Get PayPal access token\n      const tokenResponse = await fetch(\n        `${paypalConfig.sandbox ? \"https://api-m.sandbox.paypal.com\" : \"https://api-m.paypal.com\"}/v1/oauth2/token`,\n        {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n            Authorization: `Basic ${Buffer.from(`${paypalConfig.clientId}:${paypalConfig.clientSecret}`).toString(\"base64\")}`,\n          },\n          body: \"grant_type=client_credentials\",\n        }\n      );\n      \n      const tokenData = await tokenResponse.json();\n      const accessToken = tokenData.access_token;\n\n      // Capture order\n      const captureResponse = await fetch(\n        `${paypalConfig.sandbox ? \"https://api-m.sandbox.paypal.com\" : \"https://api-m.paypal.com\"}/v2/checkout/orders/${orderId}/capture`,\n        {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: `Bearer ${accessToken}`,\n          },\n        }\n      );\n\n      const captureData = await captureResponse.json();\n\n      if (!captureResponse.ok || captureData.status !== \"COMPLETED\") {\n        console.error(\"PayPal capture error:\", captureData);\n        // Invalidate session discount on any capture failure to prevent reuse\n        req.session.pendingDiscount = undefined;\n        return res.status(500).json({ error: \"Error capturando pago de PayPal\" });\n      }\n\n      // Get pending discount from session\n      const pendingDiscount = req.session.pendingDiscount;\n      \n      // Verify captured amount matches expected total - sum ALL captures from ALL purchase units\n      const purchaseUnits = captureData.purchase_units || [];\n      const cartCurrency = cartItems[0]?.audiobook?.currency || \"EUR\";\n      let totalCapturedCents = 0;\n      for (const unit of purchaseUnits) {\n        const captures = unit?.payments?.captures || [];\n        for (const capture of captures) {\n          // Verify currency matches expected\n          if (capture.amount?.currency_code && capture.amount.currency_code !== cartCurrency) {\n            console.error(\"Currency mismatch:\", { expected: cartCurrency, received: capture.amount.currency_code });\n            req.session.pendingDiscount = undefined;\n            return res.status(400).json({ \n              error: \"Moneda de pago incorrecta. Por favor, intenta de nuevo.\" \n            });\n          }\n          totalCapturedCents += Math.round(parseFloat(capture.amount?.value || \"0\") * 100);\n        }\n      }\n      \n      const expectedCents = pendingDiscount?.finalTotalCents || \n        cartItems.reduce((sum, item) => sum + item.audiobook.priceCents, 0);\n      \n      // Allow small rounding differences (max 1 cent per item)\n      const tolerance = cartItems.length;\n      if (Math.abs(totalCapturedCents - expectedCents) > tolerance) {\n        console.error(\"Amount mismatch:\", { totalCapturedCents, expectedCents, tolerance, purchaseUnitsCount: purchaseUnits.length });\n        // Invalidate session discount immediately to prevent reuse\n        req.session.pendingDiscount = undefined;\n        return res.status(400).json({ \n          error: \"El monto capturado no coincide con el esperado. Por favor, intenta de nuevo.\" \n        });\n      }\n      \n      // Clear pending discount immediately after successful reconciliation\n      const appliedDiscount = pendingDiscount;\n      req.session.pendingDiscount = undefined;\n      \n      // Create purchases for all cart items\n      const user = await storage.getUser(userId);\n      const billingProfile = await storage.getBillingProfile(userId);\n      \n      // Calculate per-item discount distribution if discount applied\n      const totalItemsCents = cartItems.reduce((sum, item) => sum + item.audiobook.priceCents, 0);\n      let remainingDiscount = appliedDiscount?.discountAmountCents || 0;\n      \n      const createdPurchaseIds: string[] = [];\n      const createdInvoices: Array<{ invoice: Invoice; pdfPath: string | null; audiobookTitle: string }> = [];\n      const purchasedAudiobooks: Array<{ title: string; invoiceNumber: string | null }> = [];\n      \n      for (let i = 0; i < cartItems.length; i++) {\n        const item = cartItems[i];\n        \n        // Distribute discount proportionally to each item\n        let itemDiscount = 0;\n        if (remainingDiscount > 0 && totalItemsCents > 0) {\n          const proportion = item.audiobook.priceCents / totalItemsCents;\n          itemDiscount = Math.round((appliedDiscount?.discountAmountCents || 0) * proportion);\n          // Last item gets remaining to avoid rounding issues\n          if (i === cartItems.length - 1) {\n            itemDiscount = remainingDiscount;\n          }\n          remainingDiscount -= itemDiscount;\n        }\n        \n        const finalItemPrice = Math.max(0, item.audiobook.priceCents - itemDiscount);\n        \n        // Create purchase record\n        const purchase = await storage.createPurchase({\n          userId,\n          audiobookId: item.audiobookId,\n          paypalOrderId: orderId,\n          amountCents: finalItemPrice,\n          currency: item.audiobook.currency,\n          status: \"COMPLETED\",\n        });\n        \n        createdPurchaseIds.push(purchase.id);\n\n        // Create invoice and generate PDF if billing profile exists\n        let invoiceNumber: string | null = null;\n        if (billingProfile) {\n          const lineItems = [{\n            description: item.audiobook.title,\n            quantity: 1,\n            unitPriceCents: item.audiobook.priceCents,\n            totalCents: item.audiobook.priceCents,\n          }];\n          \n          // Add discount line item if applicable\n          if (itemDiscount > 0 && appliedDiscount) {\n            lineItems.push({\n              description: `Descuento (${appliedDiscount.discountCode})`,\n              quantity: 1,\n              unitPriceCents: -itemDiscount,\n              totalCents: -itemDiscount,\n            });\n          }\n          \n          const invoice = await storage.createInvoice({\n            userId,\n            purchaseId: purchase.id,\n            billingProfileId: billingProfile.id,\n            type: \"PURCHASE\",\n            status: \"PAID\",\n            totalCents: finalItemPrice,\n            currency: item.audiobook.currency,\n            paymentMethod: \"PAYPAL\",\n            paymentReference: orderId,\n          }, lineItems);\n          \n          invoiceNumber = invoice.invoiceNumber;\n          \n          // Generate PDF for this invoice\n          try {\n            const pdfPath = await invoiceService.generatePDF(invoice.id);\n            await storage.updateInvoicePdfPath(invoice.id, pdfPath);\n            \n            // Fetch fresh invoice with updated pdfPath\n            const freshInvoice = await storage.getInvoice(invoice.id);\n            if (freshInvoice) {\n              createdInvoices.push({ invoice: freshInvoice, pdfPath, audiobookTitle: item.audiobook.title });\n            }\n          } catch (pdfError) {\n            console.error(\"Error generating invoice PDF:\", pdfError);\n            // Still store invoice for email but without PDF path\n            createdInvoices.push({ invoice, pdfPath: null, audiobookTitle: item.audiobook.title });\n          }\n        }\n        \n        // Track audiobook for purchase confirmation (always, even without billing profile)\n        // Use invoice number if available, otherwise use purchase ID as reference\n        purchasedAudiobooks.push({ \n          title: item.audiobook.title, \n          invoiceNumber: invoiceNumber || `REF-${purchase.id.substring(0, 8).toUpperCase()}`\n        });\n      }\n      \n      // Record discount code usage if applied\n      if (appliedDiscount?.discountCodeId && createdPurchaseIds.length > 0) {\n        try {\n          await storage.recordDiscountCodeUsage(\n            appliedDiscount.discountCodeId,\n            userId,\n            createdPurchaseIds[0], // Reference first purchase\n            appliedDiscount.discountAmountCents\n          );\n          await storage.incrementDiscountCodeUsage(appliedDiscount.discountCodeId);\n        } catch (err) {\n          console.error(\"Error recording discount usage:\", err);\n          // Don't fail the purchase if discount recording fails\n        }\n      }\n\n      // Clear cart\n      await storage.clearCart(userId);\n      \n      // Send email notifications\n      if (user?.email) {\n        let confirmationsSent = 0;\n        let invoicesSent = 0;\n        \n        try {\n          const emailService = await getEmailService(storage);\n          \n          // Send purchase confirmations for ALL audiobooks (even without invoices)\n          for (const { title, invoiceNumber } of purchasedAudiobooks) {\n            try {\n              await emailService.sendPurchaseConfirmation(\n                user.email,\n                user.displayName || user.username,\n                title,\n                invoiceNumber || ''\n              );\n              confirmationsSent++;\n            } catch (err) {\n              console.error(`Error sending confirmation for \"${title}\":`, err);\n            }\n          }\n          \n          // Send invoice emails only when invoices were created (billing profile exists)\n          for (const { invoice, pdfPath } of createdInvoices) {\n            try {\n              await emailService.sendInvoiceEmail(\n                user.email,\n                user.displayName || user.username,\n                invoice,\n                pdfPath\n              );\n              invoicesSent++;\n            } catch (err) {\n              console.error(`Error sending invoice ${invoice.invoiceNumber}:`, err);\n            }\n          }\n          \n          console.log(`[EMAIL] Sent ${confirmationsSent}/${purchasedAudiobooks.length} confirmations and ${invoicesSent}/${createdInvoices.length} invoices to ${user.email}`);\n        } catch (emailError) {\n          console.error(\"Error initializing email service:\", emailError);\n        }\n      }\n\n      res.json({ success: true, orderStatus: captureData.status });\n    } catch (error: any) {\n      console.error(\"Error capturing cart PayPal order:\", error);\n      res.status(500).json({ error: error.message || \"Error capturando pago\" });\n    }\n  });\n\n  // Create order for audiobook purchase\n  app.post(\"/api/paypal/orders\", requireAuth, async (req, res) => {\n    try {\n      const { audiobookId } = req.body;\n      \n      if (!audiobookId) {\n        return res.status(400).json({ error: \"audiobookId es requerido\" });\n      }\n\n      const audiobook = await storage.getAudiobook(audiobookId);\n      if (!audiobook) {\n        return res.status(404).json({ error: \"Audiolibro no encontrado\" });\n      }\n\n      if (audiobook.isFree || audiobook.priceCents === 0) {\n        return res.status(400).json({ error: \"Este audiolibro es gratuito\" });\n      }\n\n      // Check if already purchased\n      const existingPurchase = await storage.getUserPurchaseForAudiobook(req.session.userId!, audiobookId);\n      if (existingPurchase && existingPurchase.status === \"COMPLETED\") {\n        return res.status(400).json({ error: \"Ya has comprado este audiolibro\" });\n      }\n\n      const result = await paypalService.createOrder(\n        audiobookId,\n        req.session.userId!,\n        audiobook.priceCents,\n        audiobook.currency\n      );\n\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error creating PayPal order:\", error);\n      res.status(500).json({ error: error.message || \"Error creando orden de PayPal\" });\n    }\n  });\n\n  // Capture payment for order\n  app.post(\"/api/paypal/orders/:orderId/capture\", requireAuth, async (req, res) => {\n    try {\n      const { orderId } = req.params;\n      const userId = req.session.userId as string;\n      \n      const purchase = await storage.getPurchaseByPayPalOrderId(orderId);\n      if (!purchase) {\n        return res.status(404).json({ error: \"Orden no encontrada\" });\n      }\n      if (purchase.userId !== userId) {\n        return res.status(403).json({ error: \"No tienes permiso para capturar esta orden\" });\n      }\n      if (purchase.status === \"COMPLETED\") {\n        return res.json({ success: true, purchase, message: \"Orden ya capturada\" });\n      }\n      \n      const result = await paypalService.captureOrder(orderId);\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error capturing PayPal order:\", error);\n      res.status(500).json({ error: error.message || \"Error capturando pago\" });\n    }\n  });\n\n  // Get order status\n  app.get(\"/api/paypal/orders/:orderId\", requireAuth, async (req, res) => {\n    try {\n      const { orderId } = req.params;\n      const order = await paypalService.getOrderStatus(orderId);\n      res.json(order);\n    } catch (error: any) {\n      console.error(\"Error getting PayPal order:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo orden\" });\n    }\n  });\n\n  // Create subscription\n  app.post(\"/api/paypal/subscriptions\", requireAuth, async (req, res) => {\n    try {\n      const { planId } = req.body;\n      \n      if (!planId) {\n        return res.status(400).json({ error: \"planId es requerido\" });\n      }\n\n      // Check if user already has active subscription\n      const existingSubscription = await storage.getUserActiveSubscription(req.session.userId!);\n      if (existingSubscription) {\n        return res.status(400).json({ error: \"Ya tienes una suscripciÃ³n activa\" });\n      }\n\n      const result = await paypalService.createSubscription(planId, req.session.userId!);\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error creating PayPal subscription:\", error);\n      res.status(500).json({ error: error.message || \"Error creando suscripciÃ³n\" });\n    }\n  });\n\n  // Activate subscription after PayPal approval\n  app.post(\"/api/paypal/subscriptions/:subscriptionId/activate\", requireAuth, async (req, res) => {\n    try {\n      const { subscriptionId } = req.params;\n      const { planId } = req.body;\n\n      if (!planId) {\n        return res.status(400).json({ error: \"planId es requerido\" });\n      }\n\n      const result = await paypalService.activateSubscription(\n        subscriptionId,\n        planId,\n        req.session.userId!\n      );\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error activating PayPal subscription:\", error);\n      res.status(500).json({ error: error.message || \"Error activando suscripciÃ³n\" });\n    }\n  });\n\n  // Cancel subscription\n  app.post(\"/api/paypal/subscriptions/:subscriptionId/cancel\", requireAuth, async (req, res) => {\n    try {\n      const { subscriptionId } = req.params;\n      const { reason } = req.body;\n      \n      // Verify user owns this subscription\n      const userSubscription = await storage.getUserSubscriptionByPayPalId(req.session.userId!, subscriptionId);\n      if (!userSubscription) {\n        return res.status(404).json({ error: \"SuscripciÃ³n no encontrada\" });\n      }\n\n      const result = await paypalService.cancelSubscription(subscriptionId, reason);\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error canceling PayPal subscription:\", error);\n      res.status(500).json({ error: error.message || \"Error cancelando suscripciÃ³n\" });\n    }\n  });\n\n  // Get subscription status\n  app.get(\"/api/paypal/subscriptions/:subscriptionId\", requireAuth, async (req, res) => {\n    try {\n      const { subscriptionId } = req.params;\n      const subscription = await paypalService.getSubscriptionStatus(subscriptionId);\n      res.json(subscription);\n    } catch (error: any) {\n      console.error(\"Error getting PayPal subscription:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo suscripciÃ³n\" });\n    }\n  });\n\n  // Get user's current subscription\n  app.get(\"/api/user/subscription\", requireAuth, async (req, res) => {\n    try {\n      const subscription = await storage.getUserActiveSubscription(req.session.userId!);\n      res.json({ subscription });\n    } catch (error: any) {\n      console.error(\"Error getting user subscription:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo suscripciÃ³n\" });\n    }\n  });\n\n  // Get user's purchases\n  app.get(\"/api/user/purchases\", requireAuth, async (req, res) => {\n    try {\n      const purchases = await storage.getUserPurchases(req.session.userId!);\n      res.json(purchases);\n    } catch (error: any) {\n      console.error(\"Error getting user purchases:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo compras\" });\n    }\n  });\n\n  // Billing profile routes\n  app.get(\"/api/user/billing-profile\", requireAuth, async (req, res) => {\n    try {\n      const profile = await storage.getBillingProfile(req.session.userId!);\n      res.json({ profile });\n    } catch (error: any) {\n      console.error(\"Error getting billing profile:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo perfil de facturacion\" });\n    }\n  });\n\n  app.post(\"/api/user/billing-profile\", requireAuth, async (req, res) => {\n    try {\n      const data = insertBillingProfileSchema.parse({ ...req.body, userId: req.session.userId });\n      \n      const existingProfile = await storage.getBillingProfile(req.session.userId!);\n      let profile;\n      \n      if (existingProfile) {\n        profile = await storage.updateBillingProfile(req.session.userId!, data);\n      } else {\n        profile = await storage.createBillingProfile(data);\n      }\n      \n      res.json({ profile });\n    } catch (error: any) {\n      console.error(\"Error saving billing profile:\", error);\n      res.status(500).json({ error: error.message || \"Error guardando perfil de facturacion\" });\n    }\n  });\n\n  // Invoice routes\n  app.get(\"/api/user/invoices\", requireAuth, async (req, res) => {\n    try {\n      const invoicesList = await storage.getUserInvoices(req.session.userId!);\n      res.json(invoicesList);\n    } catch (error: any) {\n      console.error(\"Error getting invoices:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo facturas\" });\n    }\n  });\n\n  app.get(\"/api/invoices/:invoiceId\", requireAuth, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.invoiceId);\n      if (!invoice) {\n        return res.status(404).json({ error: \"Factura no encontrada\" });\n      }\n      if (invoice.userId !== req.session.userId) {\n        return res.status(403).json({ error: \"No tienes permiso para ver esta factura\" });\n      }\n      const lineItems = await storage.getInvoiceLineItems(invoice.id);\n      res.json({ invoice, lineItems });\n    } catch (error: any) {\n      console.error(\"Error getting invoice:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo factura\" });\n    }\n  });\n\n  app.get(\"/api/invoices/:invoiceId/download\", requireAuth, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.invoiceId);\n      if (!invoice) {\n        return res.status(404).json({ error: \"Factura no encontrada\" });\n      }\n      if (invoice.userId !== req.session.userId) {\n        return res.status(403).json({ error: \"No tienes permiso para descargar esta factura\" });\n      }\n      \n      if (!invoice.pdfPath || !fs.existsSync(invoice.pdfPath)) {\n        const pdfPath = await invoiceService.generatePDF(invoice.id);\n        await storage.updateInvoicePdfPath(invoice.id, pdfPath);\n        invoice.pdfPath = pdfPath;\n      }\n      \n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${invoice.invoiceNumber}.pdf\"`);\n      res.sendFile(invoice.pdfPath!);\n    } catch (error: any) {\n      console.error(\"Error downloading invoice:\", error);\n      res.status(500).json({ error: error.message || \"Error descargando factura\" });\n    }\n  });\n\n  // RSS Feed token routes\n  app.get(\"/api/user/rss-token\", requireAuth, async (req, res) => {\n    try {\n      const token = await storage.getRssFeedToken(req.session.userId!);\n      res.json({ token: token || null });\n    } catch (error: any) {\n      console.error(\"Error getting RSS token:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo token RSS\" });\n    }\n  });\n\n  app.post(\"/api/user/rss-token\", requireAuth, async (req, res) => {\n    try {\n      const existingToken = await storage.getRssFeedToken(req.session.userId!);\n      const newToken = crypto.randomUUID();\n      \n      let token;\n      if (existingToken) {\n        token = await storage.regenerateRssFeedToken(req.session.userId!, newToken);\n      } else {\n        token = await storage.createRssFeedToken(req.session.userId!, newToken);\n      }\n      \n      res.json({ token });\n    } catch (error: any) {\n      console.error(\"Error creating/regenerating RSS token:\", error);\n      res.status(500).json({ error: error.message || \"Error generando token RSS\" });\n    }\n  });\n\n  // Public RSS Feed endpoint for podcast apps (AntennaPod, etc.)\n  app.get(\"/feed/:token\", async (req, res) => {\n    try {\n      const { token } = req.params;\n      \n      const feedToken = await storage.getRssFeedTokenByToken(token);\n      if (!feedToken || !feedToken.isActive) {\n        return res.status(404).send(\"Feed not found\");\n      }\n      \n      // Update last accessed timestamp\n      await storage.updateRssFeedTokenAccess(token);\n      \n      const user = await storage.getUser(feedToken.userId);\n      if (!user) {\n        return res.status(404).send(\"Feed not found\");\n      }\n      \n      // Get user's accessible audiobooks (purchases + active subscription)\n      const purchases = await storage.getUserPurchases(feedToken.userId);\n      const subscription = await storage.getUserActiveSubscription(feedToken.userId);\n      \n      // Get purchased audiobook IDs\n      const purchasedIds = new Set(purchases.map(p => p.audiobookId));\n      \n      // Get all audiobooks the user has access to\n      let accessibleAudiobooks: any[] = [];\n      \n      if (subscription) {\n        // Subscriber has access to all audiobooks\n        const allAudiobooks = await storage.getPublicAudiobooks();\n        accessibleAudiobooks = allAudiobooks;\n      } else {\n        // Only purchased audiobooks + free audiobooks\n        const allAudiobooks = await storage.getPublicAudiobooks();\n        accessibleAudiobooks = allAudiobooks.filter(ab => \n          purchasedIds.has(ab.id) || ab.isFree\n        );\n      }\n      \n      // Build RSS feed\n      const baseUrl = `${req.protocol}://${req.get('host')}`;\n      \n      let items = \"\";\n      for (const audiobook of accessibleAudiobooks) {\n        const chapters = await storage.getChaptersByAudiobook(audiobook.id);\n        \n        for (const chapter of chapters) {\n          if (!chapter.audioUrl) continue;\n          \n          const pubDate = new Date(chapter.createdAt).toUTCString();\n          const duration = formatDurationForRss(chapter.duration);\n          const audioUrl = chapter.audioUrl.startsWith('http') \n            ? chapter.audioUrl \n            : `${baseUrl}${chapter.audioUrl}`;\n          const coverUrl = audiobook.coverArtUrl?.startsWith('http')\n            ? audiobook.coverArtUrl\n            : audiobook.coverArtUrl ? `${baseUrl}${audiobook.coverArtUrl}` : '';\n          \n          items += `\n    <item>\n      <title>${escapeXml(`${audiobook.title} - Cap. ${chapter.chapterNumber}: ${chapter.title}`)}</title>\n      <description><![CDATA[${chapter.description || audiobook.description || ''}]]></description>\n      <enclosure url=\"${escapeXml(audioUrl)}\" type=\"audio/mpeg\" length=\"${chapter.audioFileSize || 0}\"/>\n      <guid isPermaLink=\"false\">${chapter.id}</guid>\n      <pubDate>${pubDate}</pubDate>\n      <itunes:author>${escapeXml(audiobook.author)}</itunes:author>\n      <itunes:duration>${duration}</itunes:duration>\n      <itunes:episode>${chapter.chapterNumber}</itunes:episode>\n      <itunes:title>${escapeXml(chapter.title)}</itunes:title>\n      ${coverUrl ? `<itunes:image href=\"${escapeXml(coverUrl)}\"/>` : ''}\n    </item>`;\n        }\n      }\n      \n      const feedXml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<rss version=\"2.0\" \n  xmlns:itunes=\"http://www.itunes.com/dtds/podcast-1.0.dtd\"\n  xmlns:content=\"http://purl.org/rss/1.0/modules/content/\">\n  <channel>\n    <title>Audivia - Biblioteca de ${escapeXml(user.username)}</title>\n    <link>${baseUrl}</link>\n    <description>Tu biblioteca personal de audiolibros en Audivia</description>\n    <language>es</language>\n    <itunes:author>Audivia</itunes:author>\n    <itunes:summary>Audiolibros adquiridos y suscripciones activas</itunes:summary>\n    <itunes:category text=\"Arts\">\n      <itunes:category text=\"Books\"/>\n    </itunes:category>\n    ${items}\n  </channel>\n</rss>`;\n      \n      res.set('Content-Type', 'application/rss+xml; charset=utf-8');\n      res.send(feedXml);\n    } catch (error: any) {\n      console.error(\"Error generating RSS feed:\", error);\n      res.status(500).send(\"Error generating feed\");\n    }\n  });\n\n  // PayPal webhook handler\n  app.post(\"/api/paypal/webhook\", express.raw({ type: 'application/json' }), async (req, res) => {\n    try {\n      const headers = {\n        \"paypal-auth-algo\": req.headers[\"paypal-auth-algo\"] as string,\n        \"paypal-cert-url\": req.headers[\"paypal-cert-url\"] as string,\n        \"paypal-transmission-id\": req.headers[\"paypal-transmission-id\"] as string,\n        \"paypal-transmission-sig\": req.headers[\"paypal-transmission-sig\"] as string,\n        \"paypal-transmission-time\": req.headers[\"paypal-transmission-time\"] as string,\n      };\n\n      const body = req.body.toString();\n      const isValid = await paypalService.verifyWebhookSignature(headers, body);\n\n      if (!isValid) {\n        console.error(\"Invalid PayPal webhook signature\");\n        return res.status(401).json({ error: \"Invalid signature\" });\n      }\n\n      const event = JSON.parse(body);\n      console.log(\"PayPal webhook event:\", event.event_type);\n\n      switch (event.event_type) {\n        case \"PAYMENT.CAPTURE.COMPLETED\":\n          // Handle completed payment - mark purchase as completed without re-capturing\n          const orderId = event.resource?.supplementary_data?.related_ids?.order_id;\n          if (orderId) {\n            const captureId = event.resource?.id;\n            const payerEmail = event.resource?.payer?.email_address;\n            await storage.markPurchaseCompletedByPayPalOrderId(orderId, captureId, payerEmail);\n            console.log(\"Purchase marked as completed via webhook:\", orderId);\n          }\n          break;\n\n        case \"PAYMENT.CAPTURE.REFUNDED\":\n          // Handle refund\n          const refundedOrderId = event.resource?.supplementary_data?.related_ids?.order_id;\n          if (refundedOrderId) {\n            const purchase = await storage.getPurchaseByPayPalOrderId(refundedOrderId);\n            if (purchase) {\n              await storage.updatePurchaseStatus(purchase.id, \"REFUNDED\");\n            }\n          }\n          break;\n\n        case \"BILLING.SUBSCRIPTION.ACTIVATED\":\n          // Subscription activated - already handled in activate endpoint\n          break;\n\n        case \"BILLING.SUBSCRIPTION.CANCELLED\":\n        case \"BILLING.SUBSCRIPTION.SUSPENDED\":\n          const subscriptionId = event.resource?.id;\n          if (subscriptionId) {\n            await storage.updateSubscriptionStatusByPayPalId(subscriptionId, \"CANCELED\");\n          }\n          break;\n\n        case \"BILLING.SUBSCRIPTION.EXPIRED\":\n          const expiredSubscriptionId = event.resource?.id;\n          if (expiredSubscriptionId) {\n            await storage.updateSubscriptionStatusByPayPalId(expiredSubscriptionId, \"EXPIRED\");\n          }\n          break;\n\n        default:\n          console.log(\"Unhandled PayPal event:\", event.event_type);\n      }\n\n      res.json({ received: true });\n    } catch (error: any) {\n      console.error(\"Error processing PayPal webhook:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Admin: Create PayPal product for subscriptions\n  app.post(\"/api/admin/paypal/products\", requireAdmin, async (req, res) => {\n    try {\n      const { name, description } = req.body;\n      const product = await paypalService.createPayPalProduct(name, description);\n      res.json(product);\n    } catch (error: any) {\n      console.error(\"Error creating PayPal product:\", error);\n      res.status(500).json({ error: error.message || \"Error creando producto\" });\n    }\n  });\n\n  // Admin: Create PayPal plan for subscriptions\n  app.post(\"/api/admin/paypal/plans\", requireAdmin, async (req, res) => {\n    try {\n      const { productId, name, description, priceCents, currency, intervalMonths, trialDays } = req.body;\n      const plan = await paypalService.createPayPalPlan(\n        productId,\n        name,\n        description,\n        priceCents,\n        currency,\n        intervalMonths,\n        trialDays || 0\n      );\n      res.json(plan);\n    } catch (error: any) {\n      console.error(\"Error creating PayPal plan:\", error);\n      res.status(500).json({ error: error.message || \"Error creando plan\" });\n    }\n  });\n\n  // Admin: Update subscription plan with PayPal IDs\n  app.patch(\"/api/admin/subscription-plans/:id/paypal\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { paypalPlanId, paypalProductId } = req.body;\n      \n      const plan = await storage.updateSubscriptionPlanPayPalIds(id, paypalPlanId, paypalProductId);\n      res.json(plan);\n    } catch (error: any) {\n      console.error(\"Error updating subscription plan:\", error);\n      res.status(500).json({ error: error.message || \"Error actualizando plan\" });\n    }\n  });\n\n  // Admin: Save PayPal configuration\n  app.post(\"/api/admin/paypal/config\", requireAdmin, async (req, res) => {\n    try {\n      const { clientId, webhookId, environment } = req.body;\n      \n      if (!clientId) {\n        return res.status(400).json({ error: \"clientId es requerido\" });\n      }\n\n      const config = await storage.savePayPalConfig({\n        clientId,\n        webhookId,\n        environment: environment || \"sandbox\",\n        isActive: true,\n      });\n      \n      res.json(config);\n    } catch (error: any) {\n      console.error(\"Error saving PayPal config:\", error);\n      res.status(500).json({ error: error.message || \"Error guardando configuraciÃ³n\" });\n    }\n  });\n\n  // Admin: Get PayPal configuration\n  app.get(\"/api/admin/paypal/config\", requireAdmin, async (req, res) => {\n    try {\n      const config = await storage.getPayPalConfig();\n      res.json(config || null);\n    } catch (error: any) {\n      console.error(\"Error getting PayPal config:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo configuraciÃ³n\" });\n    }\n  });\n\n  // ==================== SALES ANALYTICS ENDPOINTS ====================\n\n  // Admin: Get sales summary\n  app.get(\"/api/admin/sales/summary\", requireAdmin, async (req, res) => {\n    try {\n      const { from, to } = req.query;\n      const fromDate = from ? new Date(from as string) : new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n      const toDate = to ? new Date(to as string) : new Date();\n      \n      const summary = await storage.getSalesSummary(fromDate, toDate);\n      res.json(summary);\n    } catch (error: any) {\n      console.error(\"Error getting sales summary:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo resumen de ventas\" });\n    }\n  });\n\n  // Admin: Get revenue trend\n  app.get(\"/api/admin/sales/revenue-trend\", requireAdmin, async (req, res) => {\n    try {\n      const { from, to, interval = 'day' } = req.query;\n      const fromDate = from ? new Date(from as string) : new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n      const toDate = to ? new Date(to as string) : new Date();\n      const validInterval = ['day', 'week', 'month'].includes(interval as string) ? interval as 'day' | 'week' | 'month' : 'day';\n      \n      const trend = await storage.getRevenueTrend(fromDate, toDate, validInterval);\n      res.json(trend);\n    } catch (error: any) {\n      console.error(\"Error getting revenue trend:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo tendencia de ingresos\" });\n    }\n  });\n\n  // Admin: Get top selling audiobooks\n  app.get(\"/api/admin/sales/top-audiobooks\", requireAdmin, async (req, res) => {\n    try {\n      const { from, to, limit = '10' } = req.query;\n      const fromDate = from ? new Date(from as string) : new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n      const toDate = to ? new Date(to as string) : new Date();\n      const limitNum = Math.min(parseInt(limit as string) || 10, 50);\n      \n      const topAudiobooks = await storage.getTopAudiobooks(fromDate, toDate, limitNum);\n      res.json(topAudiobooks);\n    } catch (error: any) {\n      console.error(\"Error getting top audiobooks:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo audiolibros mas vendidos\" });\n    }\n  });\n\n  // Admin: Get recent transactions\n  app.get(\"/api/admin/sales/recent-transactions\", requireAdmin, async (req, res) => {\n    try {\n      const { limit = '25' } = req.query;\n      const limitNum = Math.min(parseInt(limit as string) || 25, 100);\n      \n      const transactions = await storage.getRecentTransactions(limitNum);\n      res.json(transactions);\n    } catch (error: any) {\n      console.error(\"Error getting recent transactions:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo transacciones recientes\" });\n    }\n  });\n\n  // Admin: Get all customers with stats\n  app.get(\"/api/admin/customers\", requireAdmin, async (req, res) => {\n    try {\n      const { search, role, hasProfile } = req.query;\n      const filters: { search?: string; role?: string; hasProfile?: boolean } = {};\n      \n      if (search) filters.search = search as string;\n      if (role) filters.role = role as string;\n      if (hasProfile !== undefined) filters.hasProfile = hasProfile === 'true';\n      \n      const customers = await storage.getCustomersWithStats(filters);\n      res.json(customers);\n    } catch (error: any) {\n      console.error(\"Error getting customers:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo clientes\" });\n    }\n  });\n\n  // Admin: Get customer detail\n  app.get(\"/api/admin/customers/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const customer = await storage.getCustomerDetail(id);\n      \n      if (!customer) {\n        return res.status(404).json({ error: \"Cliente no encontrado\" });\n      }\n      \n      res.json(customer);\n    } catch (error: any) {\n      console.error(\"Error getting customer detail:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo detalle del cliente\" });\n    }\n  });\n\n  // Admin: Get all invoices\n  app.get(\"/api/admin/invoices\", requireAdmin, async (req, res) => {\n    try {\n      const { search, status, from, to } = req.query;\n      const filters: { search?: string; status?: string; from?: Date; to?: Date } = {};\n      \n      if (search) filters.search = search as string;\n      if (status) filters.status = status as string;\n      if (from) filters.from = new Date(from as string);\n      if (to) filters.to = new Date(to as string);\n      \n      const allInvoices = await storage.getAllInvoicesAdmin(filters);\n      res.json(allInvoices);\n    } catch (error: any) {\n      console.error(\"Error getting invoices:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo facturas\" });\n    }\n  });\n\n  // Admin: Download invoice PDF\n  app.get(\"/api/admin/invoices/:id/download\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const invoice = await storage.getInvoice(id);\n      \n      if (!invoice) {\n        return res.status(404).json({ error: \"Factura no encontrada\" });\n      }\n      \n      if (!invoice.pdfPath) {\n        return res.status(404).json({ error: \"PDF no disponible\" });\n      }\n      \n      const fs = await import(\"fs\");\n      const path = await import(\"path\");\n      const pdfFullPath = path.resolve(invoice.pdfPath);\n      \n      if (!fs.existsSync(pdfFullPath)) {\n        return res.status(404).json({ error: \"Archivo PDF no encontrado\" });\n      }\n      \n      res.setHeader(\"Content-Type\", \"application/pdf\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${invoice.invoiceNumber}.pdf\"`);\n      \n      const fileStream = fs.createReadStream(pdfFullPath);\n      fileStream.pipe(res);\n    } catch (error: any) {\n      console.error(\"Error downloading invoice:\", error);\n      res.status(500).json({ error: error.message || \"Error descargando factura\" });\n    }\n  });\n\n  // Admin: Get all purchases with filters\n  app.get(\"/api/admin/purchases\", requireAdmin, async (req, res) => {\n    try {\n      const { search, status, userId } = req.query;\n      const filters: { search?: string; status?: string; userId?: string } = {};\n      \n      if (search) filters.search = search as string;\n      if (status) filters.status = status as string;\n      if (userId) filters.userId = userId as string;\n      \n      const purchases = await storage.getPurchasesAdmin(filters);\n      res.json(purchases);\n    } catch (error: any) {\n      console.error(\"Error getting purchases:\", error);\n      res.status(500).json({ error: error.message || \"Error obteniendo compras\" });\n    }\n  });\n\n  // Admin: Delete pending purchase\n  app.delete(\"/api/admin/purchases/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deletePendingPurchase(id);\n      \n      if (!deleted) {\n        return res.status(400).json({ error: \"Solo se pueden eliminar compras en estado pendiente\" });\n      }\n      \n      res.json({ success: true, message: \"Compra pendiente eliminada\" });\n    } catch (error: any) {\n      console.error(\"Error deleting purchase:\", error);\n      res.status(500).json({ error: error.message || \"Error eliminando compra\" });\n    }\n  });\n\n  // Admin: Manual cleanup of old pending purchases\n  app.post(\"/api/admin/cleanup-pending\", requireAdmin, async (req, res) => {\n    try {\n      const result = await storage.deleteOldPendingPurchases(24);\n      res.json({ \n        success: true, \n        message: `Limpieza completada: ${result.deletedPurchases} compras pendientes y ${result.deletedCartItems} items de carrito eliminados` \n      });\n    } catch (error: any) {\n      console.error(\"Error in cleanup:\", error);\n      res.status(500).json({ error: error.message || \"Error en limpieza\" });\n    }\n  });\n\n  // ============ DISCOUNT CODE ROUTES ============\n  \n  // Admin: Get all discount codes\n  app.get(\"/api/admin/discount-codes\", requireAdmin, async (req, res) => {\n    try {\n      const codes = await storage.getAllDiscountCodes();\n      res.json(codes);\n    } catch (error: any) {\n      console.error(\"Error fetching discount codes:\", error);\n      res.status(500).json({ error: error.message || \"Error fetching discount codes\" });\n    }\n  });\n\n  // Admin: Create discount code\n  app.post(\"/api/admin/discount-codes\", requireAdmin, async (req, res) => {\n    try {\n      const { code, description, type, value, minPurchaseCents, maxUsesTotal, maxUsesPerUser, validFrom, validUntil, isActive, appliesToSubscriptions, appliesToPurchases } = req.body;\n      \n      if (!code || !type || value === undefined) {\n        return res.status(400).json({ error: \"Codigo, tipo y valor son requeridos\" });\n      }\n      \n      const discountCode = await storage.createDiscountCode({\n        code: code.toUpperCase().trim(),\n        description,\n        type,\n        value,\n        minPurchaseCents: minPurchaseCents || 0,\n        maxUsesTotal,\n        maxUsesPerUser: maxUsesPerUser || 1,\n        validFrom: validFrom ? new Date(validFrom) : null,\n        validUntil: validUntil ? new Date(validUntil) : null,\n        isActive: isActive !== false,\n        appliesToSubscriptions: appliesToSubscriptions || false,\n        appliesToPurchases: appliesToPurchases !== false,\n      });\n      \n      res.json(discountCode);\n    } catch (error: any) {\n      console.error(\"Error creating discount code:\", error);\n      if (error.message?.includes(\"unique\")) {\n        return res.status(400).json({ error: \"Ya existe un codigo con ese nombre\" });\n      }\n      res.status(500).json({ error: error.message || \"Error creating discount code\" });\n    }\n  });\n\n  // Admin: Update discount code\n  app.patch(\"/api/admin/discount-codes/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updates = req.body;\n      \n      if (updates.code) {\n        updates.code = updates.code.toUpperCase().trim();\n      }\n      if (updates.validFrom) {\n        updates.validFrom = new Date(updates.validFrom);\n      }\n      if (updates.validUntil) {\n        updates.validUntil = new Date(updates.validUntil);\n      }\n      \n      const updated = await storage.updateDiscountCode(id, updates);\n      res.json(updated);\n    } catch (error: any) {\n      console.error(\"Error updating discount code:\", error);\n      res.status(500).json({ error: error.message || \"Error updating discount code\" });\n    }\n  });\n\n  // Admin: Delete discount code\n  app.delete(\"/api/admin/discount-codes/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteDiscountCode(id);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting discount code:\", error);\n      res.status(500).json({ error: error.message || \"Error deleting discount code\" });\n    }\n  });\n\n  // User: Validate discount code\n  app.post(\"/api/discount-codes/validate\", requireAuth, async (req, res) => {\n    try {\n      const { code, totalCents, forSubscription } = req.body;\n      const userId = req.session.userId!;\n      \n      if (!code) {\n        return res.status(400).json({ valid: false, error: \"Codigo requerido\" });\n      }\n      \n      const result = await storage.validateDiscountCode(\n        code, \n        userId, \n        totalCents || 0, \n        forSubscription || false\n      );\n      \n      if (!result.valid) {\n        return res.json({ valid: false, error: result.error });\n      }\n      \n      // Calculate discount amount\n      const discountCode = result.discountCode!;\n      let discountAmountCents = 0;\n      \n      if (discountCode.type === \"PERCENTAGE\") {\n        discountAmountCents = Math.round((totalCents * discountCode.value) / 100);\n      } else {\n        discountAmountCents = Math.min(discountCode.value, totalCents);\n      }\n      \n      res.json({\n        valid: true,\n        discountCode: {\n          id: discountCode.id,\n          code: discountCode.code,\n          type: discountCode.type,\n          value: discountCode.value,\n          description: discountCode.description,\n        },\n        discountAmountCents,\n        finalAmountCents: Math.max(0, totalCents - discountAmountCents),\n      });\n    } catch (error: any) {\n      console.error(\"Error validating discount code:\", error);\n      res.status(500).json({ valid: false, error: \"Error validando codigo\" });\n    }\n  });\n\n  // Admin: Download customers report in Excel\n  app.get(\"/api/admin/reports/customers\", requireAdmin, async (req, res) => {\n    try {\n      const ExcelJSModule = await import(\"exceljs\");\n      const ExcelJS = ExcelJSModule.default || ExcelJSModule;\n      const customers = await storage.getCustomersWithStats();\n      \n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Clientes\");\n      \n      worksheet.columns = [\n        { header: \"ID\", key: \"id\", width: 36 },\n        { header: \"Usuario\", key: \"username\", width: 20 },\n        { header: \"Email\", key: \"email\", width: 30 },\n        { header: \"Rol\", key: \"role\", width: 12 },\n        { header: \"Nombre Legal\", key: \"legalName\", width: 25 },\n        { header: \"Empresa\", key: \"companyName\", width: 25 },\n        { header: \"NIF/CIF\", key: \"taxId\", width: 15 },\n        { header: \"Telefono\", key: \"phone\", width: 15 },\n        { header: \"Direccion\", key: \"address\", width: 40 },\n        { header: \"Ciudad\", key: \"city\", width: 20 },\n        { header: \"CP\", key: \"postalCode\", width: 10 },\n        { header: \"Pais\", key: \"country\", width: 15 },\n        { header: \"Total Compras\", key: \"totalPurchases\", width: 15 },\n        { header: \"Total Gastado\", key: \"totalSpent\", width: 15 },\n        { header: \"Ultima Compra\", key: \"lastPurchase\", width: 20 },\n        { header: \"Fecha Registro\", key: \"createdAt\", width: 20 },\n      ];\n      \n      worksheet.getRow(1).font = { bold: true };\n      worksheet.getRow(1).fill = { type: \"pattern\", pattern: \"solid\", fgColor: { argb: \"FF7C3AED\" } };\n      worksheet.getRow(1).font = { bold: true, color: { argb: \"FFFFFFFF\" } };\n      \n      customers.forEach((c) => {\n        worksheet.addRow({\n          id: c.user.id,\n          username: c.user.username,\n          email: c.user.email,\n          role: c.user.role,\n          legalName: c.billingProfile?.legalName || \"\",\n          companyName: c.billingProfile?.companyName || \"\",\n          taxId: c.billingProfile?.taxId || \"\",\n          phone: c.billingProfile?.phone || \"\",\n          address: c.billingProfile?.addressLine1 || \"\",\n          city: c.billingProfile?.city || \"\",\n          postalCode: c.billingProfile?.postalCode || \"\",\n          country: c.billingProfile?.country || \"\",\n          totalPurchases: c.totalPurchases,\n          totalSpent: c.totalSpentCents / 100,\n          lastPurchase: c.lastPurchaseAt ? new Date(c.lastPurchaseAt).toLocaleDateString(\"es-ES\") : \"\",\n          createdAt: c.user.createdAt ? new Date(c.user.createdAt).toLocaleDateString(\"es-ES\") : \"\",\n        });\n      });\n      \n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=clientes_${new Date().toISOString().split(\"T\")[0]}.xlsx`);\n      \n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"Error generating customers report:\", error);\n      res.status(500).json({ error: error.message || \"Error generando informe\" });\n    }\n  });\n\n  // Admin: Download purchases report in Excel\n  app.get(\"/api/admin/reports/purchases\", requireAdmin, async (req, res) => {\n    try {\n      const ExcelJSModule = await import(\"exceljs\");\n      const ExcelJS = ExcelJSModule.default || ExcelJSModule;\n      const { status, userId } = req.query;\n      const filters: { status?: string; userId?: string } = {};\n      if (status) filters.status = status as string;\n      if (userId) filters.userId = userId as string;\n      \n      const purchases = await storage.getPurchasesAdmin(filters);\n      \n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Compras\");\n      \n      worksheet.columns = [\n        { header: \"ID\", key: \"id\", width: 36 },\n        { header: \"Cliente\", key: \"username\", width: 20 },\n        { header: \"Email\", key: \"email\", width: 30 },\n        { header: \"Audiolibro\", key: \"audiobook\", width: 35 },\n        { header: \"Autor\", key: \"author\", width: 25 },\n        { header: \"Precio\", key: \"price\", width: 12 },\n        { header: \"Moneda\", key: \"currency\", width: 10 },\n        { header: \"Estado\", key: \"status\", width: 15 },\n        { header: \"PayPal Order ID\", key: \"paypalOrderId\", width: 25 },\n        { header: \"Fecha Creacion\", key: \"createdAt\", width: 20 },\n        { header: \"Fecha Compra\", key: \"purchasedAt\", width: 20 },\n      ];\n      \n      worksheet.getRow(1).font = { bold: true };\n      worksheet.getRow(1).fill = { type: \"pattern\", pattern: \"solid\", fgColor: { argb: \"FF7C3AED\" } };\n      worksheet.getRow(1).font = { bold: true, color: { argb: \"FFFFFFFF\" } };\n      \n      purchases.forEach((p) => {\n        worksheet.addRow({\n          id: p.id,\n          username: p.user.username,\n          email: p.user.email,\n          audiobook: p.audiobook.title,\n          author: p.audiobook.author,\n          price: p.pricePaidCents / 100,\n          currency: p.currency,\n          status: p.status,\n          paypalOrderId: p.paypalOrderId || \"\",\n          createdAt: p.createdAt ? new Date(p.createdAt).toLocaleDateString(\"es-ES\") : \"\",\n          purchasedAt: p.purchasedAt ? new Date(p.purchasedAt).toLocaleDateString(\"es-ES\") : \"\",\n        });\n      });\n      \n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=compras_${new Date().toISOString().split(\"T\")[0]}.xlsx`);\n      \n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"Error generating purchases report:\", error);\n      res.status(500).json({ error: error.message || \"Error generando informe\" });\n    }\n  });\n\n  // Admin: Download invoices report in Excel\n  app.get(\"/api/admin/reports/invoices\", requireAdmin, async (req, res) => {\n    try {\n      const ExcelJSModule = await import(\"exceljs\");\n      const ExcelJS = ExcelJSModule.default || ExcelJSModule;\n      const { status } = req.query;\n      const filters: { status?: string } = {};\n      if (status) filters.status = status as string;\n      \n      const invoicesData = await storage.getAllInvoicesAdmin(filters);\n      \n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Facturas\");\n      \n      worksheet.columns = [\n        { header: \"Numero Factura\", key: \"invoiceNumber\", width: 20 },\n        { header: \"Cliente\", key: \"username\", width: 20 },\n        { header: \"Email\", key: \"email\", width: 30 },\n        { header: \"Subtotal\", key: \"subtotal\", width: 12 },\n        { header: \"IVA\", key: \"tax\", width: 12 },\n        { header: \"Total\", key: \"total\", width: 12 },\n        { header: \"Moneda\", key: \"currency\", width: 10 },\n        { header: \"Estado\", key: \"status\", width: 15 },\n        { header: \"Metodo Pago\", key: \"paymentMethod\", width: 15 },\n        { header: \"Fecha Emision\", key: \"issueDate\", width: 20 },\n        { header: \"PDF\", key: \"hasPdf\", width: 10 },\n      ];\n      \n      worksheet.getRow(1).font = { bold: true };\n      worksheet.getRow(1).fill = { type: \"pattern\", pattern: \"solid\", fgColor: { argb: \"FF7C3AED\" } };\n      worksheet.getRow(1).font = { bold: true, color: { argb: \"FFFFFFFF\" } };\n      \n      invoicesData.forEach((inv) => {\n        worksheet.addRow({\n          invoiceNumber: inv.invoiceNumber,\n          username: inv.user.username,\n          email: inv.user.email,\n          subtotal: inv.subtotalCents / 100,\n          tax: inv.taxCents / 100,\n          total: inv.totalCents / 100,\n          currency: inv.currency,\n          status: inv.status,\n          paymentMethod: inv.paymentMethod,\n          issueDate: inv.issueDate ? new Date(inv.issueDate).toLocaleDateString(\"es-ES\") : \"\",\n          hasPdf: inv.pdfPath ? \"Si\" : \"No\",\n        });\n      });\n      \n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=facturas_${new Date().toISOString().split(\"T\")[0]}.xlsx`);\n      \n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      console.error(\"Error generating invoices report:\", error);\n      res.status(500).json({ error: error.message || \"Error generando informe\" });\n    }\n  });\n\n  // Register Multer error handler (must be after all routes)\n  app.use(handleMulterError);\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":221714,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/pages/create-podcast.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { insertPodcastSchema, insertEpisodeSchema } from \"@shared/schema\";\nimport { Loader2, Upload as UploadIcon, Lock, Users, Globe } from \"lucide-react\";\nimport { FileUpload } from \"@/components/file-upload\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nconst podcastFormSchema = insertPodcastSchema.extend({\n  episodeTitle: z.string().min(1, \"El tÃ­tulo del episodio es requerido\"),\n  episodeNotes: z.string().optional(),\n  episodeAudioAssetId: z.string().min(1, \"Debes subir un archivo de audio\"),\n  episodeAudioUrl: z.string().min(1),\n  episodeDuration: z.number().min(1, \"La duraciÃ³n debe ser mayor a 0\"),\n  episodeAudioFileSize: z.number().min(1, \"El tamaÃ±o del archivo es requerido\"),\n  episodeCoverAssetId: z.string().optional(),\n  episodeCoverUrl: z.string().optional(),\n  episodeVisibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]).default(\"PUBLIC\"),\n});\n\ntype PodcastFormValues = z.infer<typeof podcastFormSchema>;\n\nexport default function CreatePodcast() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const form = useForm<PodcastFormValues>({\n    resolver: zodResolver(podcastFormSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      coverArtUrl: undefined,\n      coverArtAssetId: undefined,\n      visibility: \"PUBLIC\",\n      episodeTitle: \"\",\n      episodeNotes: \"\",\n      episodeAudioUrl: \"\",\n      episodeAudioAssetId: \"\",\n      episodeDuration: 0,\n      episodeAudioFileSize: 0,\n      episodeCoverUrl: undefined,\n      episodeCoverAssetId: undefined,\n      episodeVisibility: \"PUBLIC\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: PodcastFormValues) => {\n      // First create the podcast (ownerId is set automatically by the backend)\n      const podcast = await apiRequest<{ id: string }>(\"POST\", \"/api/podcasts\", {\n        title: data.title,\n        description: data.description,\n        coverArtUrl: data.coverArtUrl || \"\",\n        coverArtAssetId: data.coverArtAssetId || undefined,\n        visibility: data.visibility,\n      });\n\n      // Then create the first episode\n      await apiRequest(\"POST\", \"/api/episodes\", {\n        title: data.episodeTitle,\n        notes: data.episodeNotes,\n        audioUrl: data.episodeAudioUrl,\n        audioAssetId: data.episodeAudioAssetId,\n        audioFileSize: data.episodeAudioFileSize,\n        duration: data.episodeDuration,\n        coverArtUrl: data.episodeCoverUrl || undefined,\n        coverArtAssetId: data.episodeCoverAssetId || undefined,\n        podcastId: podcast.id,\n        visibility: data.episodeVisibility,\n      });\n\n      return podcast;\n    },\n    onSuccess: (podcast) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      toast({\n        title: \"Podcast creado\",\n        description: \"Tu podcast y primer episodio han sido creados exitosamente.\",\n      });\n      setLocation(`/podcast/${podcast.id}`);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error?.message || \"No se pudo crear el podcast. Por favor intenta de nuevo.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: PodcastFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      <div className=\"max-w-3xl mx-auto px-6 py-8\">\n        <h1 className=\"text-4xl font-bold font-[Outfit] mb-2\" data-testid=\"text-page-title\">\n          Crear Nuevo Podcast\n        </h1>\n        <p className=\"text-muted-foreground mb-8\">\n          Completa la informaciÃ³n de tu podcast y sube tu primer episodio.\n        </p>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            {/* Podcast Information */}\n            <Card>\n              <CardHeader>\n                <CardTitle>InformaciÃ³n del Podcast</CardTitle>\n                <CardDescription>\n                  Detalles bÃ¡sicos sobre tu podcast\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>TÃ­tulo del Podcast</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Mi IncreÃ­ble Podcast\"\n                          data-testid=\"input-podcast-title\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>DescripciÃ³n</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Describe de quÃ© trata tu podcast...\"\n                          className=\"min-h-32 resize-none\"\n                          data-testid=\"input-podcast-description\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"visibility\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Privacidad</FormLabel>\n                      <Select\n                        onValueChange={field.onChange}\n                        defaultValue={field.value}\n                        value={field.value}\n                        data-testid=\"select-podcast-visibility\"\n                      >\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Selecciona la privacidad\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"PUBLIC\" data-testid=\"option-visibility-public\">\n                            <div className=\"flex items-center gap-2\">\n                              <Globe className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">PÃºblico</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Visible para todos\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"UNLISTED\" data-testid=\"option-visibility-unlisted\">\n                            <div className=\"flex items-center gap-2\">\n                              <Users className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">Solo invitados</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Solo usuarios invitados\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"PRIVATE\" data-testid=\"option-visibility-private\">\n                            <div className=\"flex items-center gap-2\">\n                              <Lock className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">Privado</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Solo tÃº\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormItem>\n                  <FormLabel>Portada del Podcast (opcional)</FormLabel>\n                  <FormControl>\n                    <FileUpload\n                      mode=\"cover\"\n                      data-testid=\"upload-podcast-cover\"\n                      currentUrl={form.watch(\"coverArtUrl\") || undefined}\n                      onUploadComplete={(data) => {\n                        form.setValue(\"coverArtUrl\", data.publicUrl, { shouldValidate: true });\n                        form.setValue(\"coverArtAssetId\", data.assetId, { shouldValidate: true });\n                      }}\n                      onRemove={() => {\n                        form.setValue(\"coverArtUrl\", undefined);\n                        form.setValue(\"coverArtAssetId\", undefined);\n                      }}\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              </CardContent>\n            </Card>\n\n            {/* First Episode */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Primer Episodio</CardTitle>\n                <CardDescription>\n                  Sube tu primer episodio para comenzar\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"episodeTitle\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>TÃ­tulo del Episodio</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Episodio 1: IntroducciÃ³n\"\n                          data-testid=\"input-episode-title\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"episodeNotes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Notas del Episodio (opcional)</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"En este episodio hablamos sobre...\"\n                          className=\"min-h-32 resize-none\"\n                          data-testid=\"input-episode-notes\"\n                          {...field}\n                          value={field.value || \"\"}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"episodeVisibility\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Privacidad del Episodio</FormLabel>\n                      <Select\n                        onValueChange={field.onChange}\n                        defaultValue={field.value}\n                        value={field.value}\n                        data-testid=\"select-episode-visibility\"\n                      >\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Selecciona la privacidad\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"PUBLIC\" data-testid=\"option-episode-visibility-public\">\n                            <div className=\"flex items-center gap-2\">\n                              <Globe className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">PÃºblico</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Visible para todos\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"UNLISTED\" data-testid=\"option-episode-visibility-unlisted\">\n                            <div className=\"flex items-center gap-2\">\n                              <Users className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">Solo invitados</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Solo usuarios invitados\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"PRIVATE\" data-testid=\"option-episode-visibility-private\">\n                            <div className=\"flex items-center gap-2\">\n                              <Lock className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">Privado</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Solo tÃº\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormItem>\n                  <FormLabel>Portada del Episodio (opcional)</FormLabel>\n                  <FormControl>\n                    <FileUpload\n                      mode=\"cover\"\n                      data-testid=\"upload-episode-cover\"\n                      currentUrl={form.watch(\"episodeCoverUrl\") || undefined}\n                      onUploadComplete={(data) => {\n                        form.setValue(\"episodeCoverUrl\", data.publicUrl, { shouldValidate: true });\n                        form.setValue(\"episodeCoverAssetId\", data.assetId, { shouldValidate: true });\n                      }}\n                      onRemove={() => {\n                        form.setValue(\"episodeCoverUrl\", undefined);\n                        form.setValue(\"episodeCoverAssetId\", undefined);\n                      }}\n                    />\n                  </FormControl>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Si no subes una portada, se usarÃ¡ la del podcast\n                  </p>\n                  <FormMessage />\n                </FormItem>\n\n                <FormField\n                  control={form.control}\n                  name=\"episodeAudioAssetId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Archivo de Audio *</FormLabel>\n                      <FormControl>\n                        <FileUpload\n                          mode=\"audio\"\n                          data-testid=\"upload-episode-audio\"\n                          currentUrl={form.watch(\"episodeAudioUrl\") || undefined}\n                          onUploadComplete={(data) => {\n                            if (!data.sizeBytes || data.sizeBytes <= 0) {\n                              toast({\n                                variant: \"destructive\",\n                                title: \"Error en el archivo\",\n                                description: \"No se pudo determinar el tamaÃ±o del archivo de audio. Por favor, intenta de nuevo.\",\n                              });\n                              return;\n                            }\n                            if (!data.duration || data.duration <= 0) {\n                              toast({\n                                variant: \"destructive\",\n                                title: \"Error en el archivo\",\n                                description: \"No se pudo determinar la duraciÃ³n del archivo de audio. Por favor, intenta de nuevo.\",\n                              });\n                              return;\n                            }\n                            form.setValue(\"episodeAudioUrl\", data.publicUrl, { shouldValidate: true });\n                            form.setValue(\"episodeAudioAssetId\", data.assetId, { shouldValidate: true });\n                            form.setValue(\"episodeAudioFileSize\", data.sizeBytes, { shouldValidate: true });\n                            form.setValue(\"episodeDuration\", data.duration, { shouldValidate: true });\n                          }}\n                          onRemove={() => {\n                            form.setValue(\"episodeAudioUrl\", \"\");\n                            form.setValue(\"episodeAudioAssetId\", \"\");\n                            form.setValue(\"episodeDuration\", 0);\n                            form.setValue(\"episodeAudioFileSize\", 0);\n                          }}\n                        />\n                      </FormControl>\n                      {form.watch(\"episodeDuration\") > 0 && (\n                        <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"text-episode-duration\">\n                          DuraciÃ³n: {Math.floor(form.watch(\"episodeDuration\") / 60)} min {form.watch(\"episodeDuration\") % 60} seg\n                        </p>\n                      )}\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </CardContent>\n            </Card>\n\n            <Button\n              type=\"submit\"\n              size=\"lg\"\n              className=\"w-full\"\n              disabled={createMutation.isPending}\n              data-testid=\"button-submit\"\n            >\n              {createMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Creando...\n                </>\n              ) : (\n                <>\n                  <UploadIcon className=\"mr-2 h-4 w-4\" />\n                  Crear Podcast\n                </>\n              )}\n            </Button>\n          </form>\n        </Form>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19268,"size_tokens":null},"client/src/components/episode-card.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Play, Clock, Calendar } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ShareMenu } from \"@/components/ShareMenu\";\nimport { Link } from \"wouter\";\nimport type { EpisodeWithUrls } from \"@shared/schema\";\n\ninterface EpisodeCardProps {\n  episode: EpisodeWithUrls;\n  podcastTitle?: string;\n  podcastCover?: string;\n  onPlay?: () => void;\n}\n\nfunction formatDuration(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  const secs = seconds % 60;\n\n  if (hours > 0) {\n    return `${hours}:${minutes.toString().padStart(2, \"0\")}:${secs.toString().padStart(2, \"0\")}`;\n  }\n  return `${minutes}:${secs.toString().padStart(2, \"0\")}`;\n}\n\nfunction formatDate(date: Date): string {\n  return new Intl.DateTimeFormat(\"es-ES\", {\n    year: \"numeric\",\n    month: \"short\",\n    day: \"numeric\",\n  }).format(new Date(date));\n}\n\nexport function EpisodeCard({ episode, podcastTitle, podcastCover, onPlay }: EpisodeCardProps) {\n  return (\n    <Card \n      className=\"hover-elevate overflow-hidden\" \n      data-testid={`card-episode-${episode.id}`}\n      id={`episode-${episode.id}`}\n    >\n      <div className=\"flex gap-4 p-4\">\n        {/* Cover Art */}\n        {podcastCover && (\n          <div className=\"flex-shrink-0\">\n            <img\n              src={podcastCover}\n              alt={podcastTitle || \"Podcast\"}\n              className=\"w-24 h-24 rounded-lg object-cover\"\n            />\n          </div>\n        )}\n\n        {/* Episode Info */}\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-start justify-between gap-2\">\n            <div className=\"flex-1 min-w-0\">\n              <Link href={`/episode/${episode.id}`}>\n                <h3 className=\"font-semibold text-lg line-clamp-1 font-[Outfit] hover:text-primary transition-colors cursor-pointer\" data-testid={`text-episode-title-${episode.id}`}>\n                  {episode.title}\n                </h3>\n              </Link>\n              {podcastTitle && (\n                <p className=\"text-sm text-muted-foreground mt-0.5\">\n                  {podcastTitle}\n                </p>\n              )}\n            </div>\n            <div className=\"flex-shrink-0\">\n              <ShareMenu\n                episodeTitle={episode.title}\n                episodeUrl={episode.shareUrl}\n                embedCode={episode.embedCode}\n              />\n            </div>\n          </div>\n\n          <p className=\"text-sm text-muted-foreground line-clamp-2 mt-2\">\n            {episode.notes}\n          </p>\n\n          <div className=\"flex items-center gap-4 mt-3 flex-wrap\">\n            <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n              <Calendar className=\"h-3.5 w-3.5\" />\n              <span>{formatDate(episode.publishedAt)}</span>\n            </div>\n            <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n              <Clock className=\"h-3.5 w-3.5\" />\n              <span>{formatDuration(episode.duration)}</span>\n            </div>\n          </div>\n        </div>\n\n        {/* Play Button */}\n        <div className=\"flex-shrink-0 flex items-center\">\n          <Button\n            variant=\"default\"\n            size=\"icon\"\n            className=\"h-12 w-12 rounded-full\"\n            onClick={onPlay}\n            data-testid={`button-play-episode-${episode.id}`}\n          >\n            <Play className=\"h-5 w-5 fill-current\" />\n          </Button>\n        </div>\n      </div>\n    </Card>\n  );\n}\n","path":null,"size_bytes":3626,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/user-menu.tsx":{"content":"import { useAuth } from \"./auth-provider\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\nimport { LogIn, LogOut, Settings, User, BookOpen } from \"lucide-react\";\nimport { Link } from \"wouter\";\n\nexport function UserMenu() {\n  const { user, logout, isAuthenticated } = useAuth();\n\n  // Show login button if not authenticated\n  if (!isAuthenticated || !user) {\n    return (\n      <Button \n        variant=\"ghost\" \n        size=\"default\"\n        asChild\n        data-testid=\"button-login-header\"\n      >\n        <Link href=\"/login\">\n          <LogIn className=\"mr-2 h-4 w-4\" />\n          Iniciar SesiÃ³n\n        </Link>\n      </Button>\n    );\n  }\n\n  // Get user initials for avatar fallback\n  const initials = user.username\n    ? user.username.substring(0, 2).toUpperCase()\n    : user.email.substring(0, 2).toUpperCase();\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"rounded-full\"\n          data-testid=\"button-user-menu\"\n        >\n          <Avatar className=\"h-8 w-8\">\n            <AvatarImage src={user.avatarUrl || undefined} alt={user.username} />\n            <AvatarFallback>{initials}</AvatarFallback>\n          </Avatar>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-56\">\n        <DropdownMenuLabel>\n          <div className=\"flex flex-col space-y-1\">\n            <p className=\"text-sm font-medium leading-none\" data-testid=\"text-username\">\n              {user.username}\n            </p>\n            <p className=\"text-xs leading-none text-muted-foreground\" data-testid=\"text-email\">\n              {user.email}\n            </p>\n            <p className=\"text-xs leading-none text-muted-foreground capitalize\" data-testid=\"text-role\">\n              {user.role.toLowerCase()}\n            </p>\n          </div>\n        </DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem asChild>\n          <Link href=\"/profile\" className=\"cursor-pointer\" data-testid=\"link-profile\">\n            <User className=\"mr-2 h-4 w-4\" />\n            <span>Mi Perfil</span>\n          </Link>\n        </DropdownMenuItem>\n        <DropdownMenuItem asChild>\n          <Link href=\"/settings\" className=\"cursor-pointer\" data-testid=\"link-settings\">\n            <Settings className=\"mr-2 h-4 w-4\" />\n            <span>ConfiguraciÃ³n</span>\n          </Link>\n        </DropdownMenuItem>\n        <DropdownMenuItem asChild>\n          <Link href=\"/user-guide\" className=\"cursor-pointer\" data-testid=\"link-user-guide\">\n            <BookOpen className=\"mr-2 h-4 w-4\" />\n            <span>Manual de Uso</span>\n          </Link>\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem\n          className=\"cursor-pointer text-destructive focus:text-destructive\"\n          onClick={() => logout()}\n          data-testid=\"button-logout\"\n        >\n          <LogOut className=\"mr-2 h-4 w-4\" />\n          <span>Cerrar SesiÃ³n</span>\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","path":null,"size_bytes":3352,"size_tokens":null},"client/src/components/app-sidebar.tsx":{"content":"import { Home, Compass, Library, Shield, Users, BookOpen, Play, Mail, ListMusic, CreditCard, FileArchive, Wallet, TrendingUp, ShoppingCart, Tag, ExternalLink } from \"lucide-react\";\nimport { Link, useLocation } from \"wouter\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n} from \"@/components/ui/sidebar\";\nimport { useAuth } from \"@/components/auth-provider\";\n\nconst menuItems = [\n  {\n    title: \"Inicio\",\n    url: \"/\",\n    icon: Home,\n    testId: \"link-home\",\n  },\n  {\n    title: \"Explorar\",\n    url: \"/explore\",\n    icon: Compass,\n    testId: \"link-explore\",\n  },\n  {\n    title: \"Mi Biblioteca\",\n    url: \"/library\",\n    icon: Library,\n    testId: \"link-library\",\n  },\n  {\n    title: \"Mis Listas\",\n    url: \"/my-playlists\",\n    icon: ListMusic,\n    testId: \"link-my-playlists\",\n  },\n  {\n    title: \"Carrito\",\n    url: \"/cart\",\n    icon: ShoppingCart,\n    testId: \"link-cart\",\n  },\n];\n\n// Principal: Dashboard y mÃ©tricas\nconst adminMainItems = [\n  {\n    title: \"Dashboard\",\n    url: \"/admin\",\n    icon: Shield,\n    testId: \"link-admin-dashboard\",\n  },\n  {\n    title: \"Ventas\",\n    url: \"/admin/sales\",\n    icon: TrendingUp,\n    testId: \"link-admin-sales\",\n  },\n];\n\n// GestiÃ³n comercial: clientes, compras, facturas, suscripciones\nconst adminComercialItems = [\n  {\n    title: \"Gestion Comercial\",\n    url: \"/admin/customers\",\n    icon: Users,\n    testId: \"link-admin-customers\",\n  },\n  {\n    title: \"Suscripciones\",\n    url: \"/admin/subscriptions\",\n    icon: CreditCard,\n    testId: \"link-admin-subscriptions\",\n  },\n  {\n    title: \"Descuentos\",\n    url: \"/admin/discount-codes\",\n    icon: Tag,\n    testId: \"link-admin-discount-codes\",\n  },\n];\n\n// Contenido: audiolibros, capÃ­tulos, importar\nconst adminContentItems = [\n  {\n    title: \"Audiolibros\",\n    url: \"/admin/audiobooks\",\n    icon: BookOpen,\n    testId: \"link-admin-audiobooks\",\n  },\n  {\n    title: \"Capitulos\",\n    url: \"/admin/chapters\",\n    icon: Play,\n    testId: \"link-admin-chapters\",\n  },\n  {\n    title: \"Importar ZIP\",\n    url: \"/admin/import\",\n    icon: FileArchive,\n    testId: \"link-admin-import\",\n  },\n];\n\n// Sistema: usuarios, configuraciÃ³n\nconst adminSystemItems = [\n  {\n    title: \"Usuarios\",\n    url: \"/admin/users\",\n    icon: Users,\n    testId: \"link-admin-users\",\n  },\n  {\n    title: \"Email\",\n    url: \"/admin/email-config\",\n    icon: Mail,\n    testId: \"link-admin-email-config\",\n  },\n  {\n    title: \"PayPal\",\n    url: \"/admin/paypal-config\",\n    icon: Wallet,\n    testId: \"link-admin-paypal-config\",\n  },\n  {\n    title: \"Servicios Externos\",\n    url: \"/admin/external-services\",\n    icon: ExternalLink,\n    testId: \"link-admin-external-services\",\n  },\n];\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n  const { user } = useAuth();\n\n  const isAdmin = user && user.role === \"ADMIN\";\n\n  return (\n    <Sidebar className=\"pt-[57px]\">\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Descubrir</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {menuItems.map((item) => (\n                <SidebarMenuItem key={item.url}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url}\n                    data-testid={item.testId}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"w-4 h-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        {isAdmin && (\n          <>\n            <SidebarGroup>\n              <SidebarGroupLabel>Panel Principal</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {adminMainItems.map((item) => (\n                    <SidebarMenuItem key={item.url}>\n                      <SidebarMenuButton\n                        asChild\n                        isActive={location === item.url || location.startsWith(item.url + \"/\")}\n                        data-testid={item.testId}\n                      >\n                        <Link href={item.url}>\n                          <item.icon className=\"w-4 h-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Comercial</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {adminComercialItems.map((item) => (\n                    <SidebarMenuItem key={item.url}>\n                      <SidebarMenuButton\n                        asChild\n                        isActive={location === item.url || location.startsWith(item.url + \"/\")}\n                        data-testid={item.testId}\n                      >\n                        <Link href={item.url}>\n                          <item.icon className=\"w-4 h-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Contenido</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {adminContentItems.map((item) => (\n                    <SidebarMenuItem key={item.url}>\n                      <SidebarMenuButton\n                        asChild\n                        isActive={location === item.url || location.startsWith(item.url + \"/\")}\n                        data-testid={item.testId}\n                      >\n                        <Link href={item.url}>\n                          <item.icon className=\"w-4 h-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Sistema</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {adminSystemItems.map((item) => (\n                    <SidebarMenuItem key={item.url}>\n                      <SidebarMenuButton\n                        asChild\n                        isActive={location === item.url || location.startsWith(item.url + \"/\")}\n                        data-testid={item.testId}\n                      >\n                        <Link href={item.url}>\n                          <item.icon className=\"w-4 h-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n          </>\n        )}\n      </SidebarContent>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":7421,"size_tokens":null},"client/src/components/protected-route.tsx":{"content":"import { ReactNode, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"./auth-provider\";\nimport { Loader2 } from \"lucide-react\";\n\ninterface ProtectedRouteProps {\n  children: ReactNode;\n  requireRole?: \"LISTENER\" | \"CREATOR\" | \"ADMIN\";\n}\n\nexport function ProtectedRoute({ children, requireRole }: ProtectedRouteProps) {\n  const { user, isLoading, isAuthenticated } = useAuth();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      setLocation(\"/login\");\n    }\n  }, [isLoading, isAuthenticated, setLocation]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  // Check role hierarchy: ADMIN can access everything, CREATOR can access CREATOR and LISTENER routes\n  if (requireRole) {\n    const hasAccess = \n      user?.role === requireRole || \n      (user?.role === \"ADMIN\") || // Admins can access all routes\n      (user?.role === \"CREATOR\" && requireRole === \"LISTENER\"); // Creators can access listener routes\n    \n    if (!hasAccess) {\n      return (\n        <div className=\"min-h-screen flex items-center justify-center p-6\">\n          <div className=\"text-center space-y-4\">\n            <h2 className=\"text-2xl font-bold\">Acceso Restringido</h2>\n            <p className=\"text-muted-foreground\">\n              Esta pÃ¡gina requiere una cuenta de tipo {\n                requireRole === \"CREATOR\" ? \"Creador\" : \n                requireRole === \"ADMIN\" ? \"Administrador\" : \n                \"Oyente\"\n              }.\n            </p>\n          </div>\n        </div>\n      );\n    }\n  }\n\n  return <>{children}</>;\n}\n","path":null,"size_bytes":1801,"size_tokens":null},"client/src/pages/home.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"wouter\";\nimport { Play, Clock, Heart, ChevronRight, Headphones, BookOpen, Star } from \"lucide-react\";\nimport type { Audiobook } from \"@shared/schema\";\n\nfunction formatDuration(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  if (hours > 0) {\n    return `${hours}h ${minutes}m`;\n  }\n  return `${minutes}m`;\n}\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\nfunction AudiobookCard({ audiobook }: { audiobook: Audiobook }) {\n  return (\n    <Link href={`/audiobook/${audiobook.id}`}>\n      <Card \n        className=\"group overflow-hidden hover-elevate cursor-pointer transition-transform duration-200 hover:scale-[1.02]\"\n        data-testid={`card-audiobook-${audiobook.id}`}\n      >\n        <div className=\"aspect-square relative overflow-hidden\">\n          {audiobook.coverArtUrl ? (\n            <img\n              src={audiobook.coverArtUrl}\n              alt={audiobook.title}\n              className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\n            />\n          ) : (\n            <div className=\"w-full h-full bg-gradient-to-br from-primary/30 to-primary/60 flex items-center justify-center\">\n              <BookOpen className=\"w-12 h-12 text-primary-foreground/60\" />\n            </div>\n          )}\n          <div className=\"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300\">\n            <div className=\"absolute bottom-4 left-4 right-4\">\n              <Button size=\"sm\" className=\"w-full gap-2\">\n                <Play className=\"w-4 h-4\" />\n                Escuchar muestra\n              </Button>\n            </div>\n          </div>\n          {audiobook.isFree && (\n            <Badge className=\"absolute top-2 right-2 bg-accent text-accent-foreground\">\n              Gratis\n            </Badge>\n          )}\n        </div>\n        <CardContent className=\"p-4\">\n          <h3 className=\"font-serif font-semibold text-lg line-clamp-1\">{audiobook.title}</h3>\n          <p className=\"text-sm text-muted-foreground line-clamp-1\">{audiobook.author}</p>\n          <div className=\"flex items-center justify-between mt-3\">\n            <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n              <Clock className=\"w-3 h-3\" />\n              <span>{formatDuration(audiobook.totalDuration)}</span>\n            </div>\n            {!audiobook.isFree && audiobook.priceCents > 0 && (\n              <span className=\"font-semibold text-primary\">\n                {formatPrice(audiobook.priceCents, audiobook.currency)}\n              </span>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </Link>\n  );\n}\n\nfunction AudiobookGridSkeleton() {\n  return (\n    <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n      {Array.from({ length: 6 }).map((_, i) => (\n        <Card key={i} className=\"overflow-hidden\">\n          <Skeleton className=\"aspect-square\" />\n          <CardContent className=\"p-4 space-y-2\">\n            <Skeleton className=\"h-5 w-3/4\" />\n            <Skeleton className=\"h-4 w-1/2\" />\n            <div className=\"flex justify-between pt-2\">\n              <Skeleton className=\"h-3 w-16\" />\n              <Skeleton className=\"h-4 w-12\" />\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}\n\nfunction HeroSection() {\n  return (\n    <section className=\"relative overflow-hidden bg-gradient-to-br from-primary/20 via-background to-accent/10 py-16 md:py-24\">\n      <div className=\"absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-primary/10 via-transparent to-transparent\" />\n      <div className=\"container mx-auto px-4 relative z-10\">\n        <div className=\"max-w-3xl mx-auto text-center\">\n          <Badge variant=\"outline\" className=\"mb-4 border-accent text-accent\">\n            <Star className=\"w-3 h-3 mr-1 fill-accent\" />\n            Tu biblioteca premium\n          </Badge>\n          <h1 className=\"font-serif text-4xl md:text-6xl font-bold mb-6 leading-tight\" data-testid=\"text-hero-title\">\n            Descubre el placer de <span className=\"text-primary\">escuchar</span>\n          </h1>\n          <p className=\"text-lg md:text-xl text-muted-foreground mb-8 max-w-2xl mx-auto\">\n            Miles de audiolibros narrados por profesionales. Compra tus favoritos o suscribete para acceso ilimitado.\n          </p>\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n            <Link href=\"/explore\">\n              <Button size=\"lg\" className=\"gap-2 px-8\">\n                <Headphones className=\"w-5 h-5\" />\n                Explorar catalogo\n              </Button>\n            </Link>\n            <Link href=\"/register\">\n              <Button size=\"lg\" variant=\"outline\" className=\"gap-2 px-8\">\n                Prueba gratuita\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n\nfunction SectionHeader({ title, viewAllHref }: { title: string; viewAllHref?: string }) {\n  return (\n    <div className=\"flex items-center justify-between mb-6\">\n      <h2 className=\"font-serif text-2xl md:text-3xl font-bold\">{title}</h2>\n      {viewAllHref && (\n        <Link href={viewAllHref}>\n          <Button variant=\"ghost\" size=\"sm\" className=\"gap-1\">\n            Ver todo\n            <ChevronRight className=\"w-4 h-4\" />\n          </Button>\n        </Link>\n      )}\n    </div>\n  );\n}\n\nexport default function Home() {\n  const { data: audiobooks, isLoading } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/audiobooks\"],\n  });\n\n  const featuredAudiobooks = audiobooks?.slice(0, 6) || [];\n  const freeAudiobooks = audiobooks?.filter(a => a.isFree) || [];\n\n  return (\n    <div className=\"min-h-screen\">\n      <HeroSection />\n\n      <div className=\"container mx-auto px-4 py-12 space-y-16\">\n        <section>\n          <SectionHeader title=\"Destacados\" viewAllHref=\"/explore\" />\n          {isLoading ? (\n            <AudiobookGridSkeleton />\n          ) : featuredAudiobooks.length > 0 ? (\n            <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n              {featuredAudiobooks.map((audiobook) => (\n                <AudiobookCard key={audiobook.id} audiobook={audiobook} />\n              ))}\n            </div>\n          ) : (\n            <Card className=\"p-12 text-center\">\n              <BookOpen className=\"w-16 h-16 mx-auto text-muted-foreground/50 mb-4\" />\n              <h3 className=\"text-xl font-semibold mb-2\">Aun no hay audiolibros</h3>\n              <p className=\"text-muted-foreground\">\n                Los audiolibros apareceran aqui cuando se agreguen al catalogo.\n              </p>\n            </Card>\n          )}\n        </section>\n\n        {freeAudiobooks.length > 0 && (\n          <section>\n            <SectionHeader title=\"Gratis esta semana\" viewAllHref=\"/explore?filter=free\" />\n            <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n              {freeAudiobooks.slice(0, 6).map((audiobook) => (\n                <AudiobookCard key={audiobook.id} audiobook={audiobook} />\n              ))}\n            </div>\n          </section>\n        )}\n\n        <section className=\"py-12 bg-card rounded-2xl px-8\">\n          <div className=\"max-w-4xl mx-auto text-center\">\n            <h2 className=\"font-serif text-3xl md:text-4xl font-bold mb-4\">\n              Suscripcion premium\n            </h2>\n            <p className=\"text-lg text-muted-foreground mb-8\">\n              Acceso ilimitado a todo el catalogo por una tarifa mensual. Cancela cuando quieras.\n            </p>\n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n              <Link href=\"/register\">\n                <Button size=\"lg\" className=\"gap-2\">\n                  <Heart className=\"w-5 h-5\" />\n                  Comenzar prueba gratuita\n                </Button>\n              </Link>\n            </div>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8500,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/theme-toggle.tsx":{"content":"export function ThemeToggle() {\n  return null;\n}\n","path":null,"size_bytes":49,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect } from \"react\";\n\ntype Theme = \"dark\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState | undefined>(\n  undefined\n);\n\nexport function ThemeProvider({ children }: ThemeProviderProps) {\n  useEffect(() => {\n    const root = document.documentElement;\n    root.classList.remove(\"light\");\n    root.classList.add(\"dark\");\n  }, []);\n\n  return (\n    <ThemeProviderContext.Provider value={{ theme: \"dark\" }}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  return context;\n};\n","path":null,"size_bytes":832,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"server/rss-generator.ts":{"content":"import type { Podcast, Episode, User } from \"@shared/schema\";\n\nexport interface EpisodeForRSS extends Episode {\n  effectiveCoverArtUrl: string | null;\n  effectiveCoverArtAssetId: string | null;\n}\n\nexport interface PodcastForRSS extends Podcast {\n  owner: User;\n  episodes: EpisodeForRSS[];\n}\n\n/**\n * Escapes XML special characters\n */\nfunction escapeXml(unsafe: string | null | undefined): string {\n  if (!unsafe) return \"\";\n  return unsafe\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&apos;\");\n}\n\n/**\n * Formats a date to RFC 822 format (required for RSS)\n */\nfunction formatRFC822Date(date: Date): string {\n  const days = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n  const months = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\n  \n  // Use UTC methods to ensure correct timezone\n  const day = days[date.getUTCDay()];\n  const dayNum = String(date.getUTCDate()).padStart(2, \"0\");\n  const month = months[date.getUTCMonth()];\n  const year = date.getUTCFullYear();\n  const hours = String(date.getUTCHours()).padStart(2, \"0\");\n  const minutes = String(date.getUTCMinutes()).padStart(2, \"0\");\n  const seconds = String(date.getUTCSeconds()).padStart(2, \"0\");\n  \n  return `${day}, ${dayNum} ${month} ${year} ${hours}:${minutes}:${seconds} +0000`;\n}\n\n/**\n * Formats duration in seconds to HH:MM:SS format\n */\nfunction formatDuration(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  const secs = seconds % 60;\n  \n  return `${String(hours).padStart(2, \"0\")}:${String(minutes).padStart(2, \"0\")}:${String(secs).padStart(2, \"0\")}`;\n}\n\n/**\n * Generates RSS 2.0 feed XML with iTunes extensions\n */\nexport function generateRSSFeed(podcast: PodcastForRSS, feedUrl: string, siteUrl: string): string {\n  const { owner, episodes } = podcast;\n  \n  const podcastLink = `${siteUrl}/podcast/${podcast.id}`;\n  const lastBuildDate = episodes.length > 0 \n    ? formatRFC822Date(new Date(episodes[0].publishedAt))\n    : formatRFC822Date(new Date());\n  \n  let xml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<rss version=\"2.0\" \n     xmlns:itunes=\"http://www.itunes.com/dtds/podcast-1.0.dtd\"\n     xmlns:atom=\"http://www.w3.org/2005/Atom\"\n     xmlns:content=\"http://purl.org/rss/1.0/modules/content/\">\n  <channel>\n    <title>${escapeXml(podcast.title)}</title>\n    <link>${escapeXml(podcastLink)}</link>\n    <description>${escapeXml(podcast.description)}</description>\n    <language>${escapeXml(podcast.language)}</language>\n    <lastBuildDate>${lastBuildDate}</lastBuildDate>\n    <atom:link href=\"${escapeXml(feedUrl)}\" rel=\"self\" type=\"application/rss+xml\" />\n    <managingEditor>${escapeXml(owner.email)} (${escapeXml(owner.username)})</managingEditor>\n    <webMaster>${escapeXml(owner.email)} (${escapeXml(owner.username)})</webMaster>\n    \n    <!-- iTunes Tags -->\n    <itunes:author>${escapeXml(owner.username)}</itunes:author>\n    <itunes:summary>${escapeXml(podcast.description)}</itunes:summary>\n    <itunes:owner>\n      <itunes:name>${escapeXml(owner.username)}</itunes:name>\n      <itunes:email>${escapeXml(owner.email)}</itunes:email>\n    </itunes:owner>`;\n  \n  if (podcast.coverArtUrl) {\n    xml += `\n    <itunes:image href=\"${escapeXml(podcast.coverArtUrl)}\" />\n    <image>\n      <url>${escapeXml(podcast.coverArtUrl)}</url>\n      <title>${escapeXml(podcast.title)}</title>\n      <link>${escapeXml(podcastLink)}</link>\n    </image>`;\n  }\n  \n  xml += `\n    <itunes:category text=\"${escapeXml(podcast.category)}\" />\n    <itunes:explicit>no</itunes:explicit>\n    \n`;\n  \n  // Add episodes\n  for (const episode of episodes) {\n    const episodeLink = `${siteUrl}/podcast/${podcast.id}#episode-${episode.id}`;\n    const pubDate = formatRFC822Date(new Date(episode.publishedAt));\n    const duration = formatDuration(episode.duration);\n    \n    xml += `    <item>\n      <title>${escapeXml(episode.title)}</title>\n      <link>${escapeXml(episodeLink)}</link>\n      <description>${escapeXml(episode.notes)}</description>\n      <pubDate>${pubDate}</pubDate>\n      <guid isPermaLink=\"true\">${escapeXml(episodeLink)}</guid>\n      <enclosure url=\"${escapeXml(episode.audioUrl)}\" type=\"audio/mpeg\" length=\"${episode.audioFileSize}\" />`;\n    \n    // Add episode cover art if available (with fallback to podcast cover)\n    if (episode.effectiveCoverArtUrl) {\n      xml += `\n      <itunes:image href=\"${escapeXml(episode.effectiveCoverArtUrl)}\" />`;\n    }\n    \n    xml += `\n      \n      <!-- iTunes Episode Tags -->\n      <itunes:title>${escapeXml(episode.title)}</itunes:title>\n      <itunes:summary>${escapeXml(episode.notes)}</itunes:summary>\n      <itunes:duration>${duration}</itunes:duration>\n      <itunes:explicit>no</itunes:explicit>\n    </item>\n`;\n  }\n  \n  xml += `  </channel>\n</rss>`;\n  \n  return xml;\n}\n","path":null,"size_bytes":4890,"size_tokens":null},"server/backfill-audio-sizes.ts":{"content":"/**\n * Backfill script to populate audioFileSize for existing episodes\n * Fetches Content-Length from audio URLs via HEAD requests\n */\n\nimport { db } from \"./db\";\nimport { episodes } from \"@shared/schema\";\nimport { isNull, eq } from \"drizzle-orm\";\n\nasync function fetchAudioFileSize(audioUrl: string): Promise<number | null> {\n  try {\n    const response = await fetch(audioUrl, { method: \"HEAD\" });\n    const contentLength = response.headers.get(\"content-length\");\n    \n    if (contentLength && !isNaN(parseInt(contentLength))) {\n      return parseInt(contentLength);\n    }\n    \n    console.warn(`No Content-Length header for ${audioUrl}`);\n    return null;\n  } catch (error) {\n    console.error(`Failed to fetch size for ${audioUrl}:`, error);\n    return null;\n  }\n}\n\nexport async function backfillAudioFileSizes() {\n  console.log(\"Starting audioFileSize backfill...\");\n  \n  // Get all episodes without audioFileSize\n  const episodesWithoutSize = await db\n    .select()\n    .from(episodes)\n    .where(isNull(episodes.audioFileSize));\n  \n  console.log(`Found ${episodesWithoutSize.length} episodes without audioFileSize`);\n  \n  let successCount = 0;\n  let failureCount = 0;\n  \n  for (const episode of episodesWithoutSize) {\n    console.log(`Fetching size for episode ${episode.id}: ${episode.title}`);\n    \n    const fileSize = await fetchAudioFileSize(episode.audioUrl);\n    \n    if (fileSize !== null) {\n      await db\n        .update(episodes)\n        .set({ audioFileSize: fileSize })\n        .where(eq(episodes.id, episode.id));\n      \n      console.log(`âœ“ Updated episode ${episode.id} with size ${fileSize} bytes`);\n      successCount++;\n    } else {\n      console.error(`âœ— Failed to get size for episode ${episode.id}`);\n      failureCount++;\n    }\n    \n    // Small delay to avoid overwhelming servers\n    await new Promise(resolve => setTimeout(resolve, 500));\n  }\n  \n  console.log(`\\nBackfill complete:`);\n  console.log(`  Success: ${successCount}`);\n  console.log(`  Failures: ${failureCount}`);\n  console.log(`  Total: ${episodesWithoutSize.length}`);\n  \n  return { successCount, failureCount, total: episodesWithoutSize.length };\n}\n\n// Run backfill if executed directly\nif (import.meta.url === `file://${process.argv[1]}`) {\n  backfillAudioFileSizes()\n    .then(() => process.exit(0))\n    .catch((error) => {\n      console.error(\"Backfill failed:\", error);\n      process.exit(1);\n    });\n}\n","path":null,"size_bytes":2408,"size_tokens":null},"server/url-helpers.ts":{"content":"/**\n * URL generation helpers for episodes and podcasts\n * Ensures consistent URL generation across the application\n */\n\nimport type { Request } from \"express\";\n\n/**\n * Get the base site URL from request headers\n * @param req Express request object\n * @returns Base site URL (e.g., \"https://example.com\")\n */\nexport function getSiteUrl(req: Request): string {\n  const protocol = req.secure || req.get(\"x-forwarded-proto\") === \"https\" ? \"https\" : \"http\";\n  const host = req.get(\"host\") || \"localhost:5000\";\n  return `${protocol}://${host}`;\n}\n\n/**\n * Generate canonical URL for an episode\n * @param siteUrl Base site URL\n * @param podcastId Podcast ID (not used but kept for backwards compatibility)\n * @param episodeId Episode ID\n * @returns Canonical episode URL pointing to dedicated episode page (e.g., \"/episode/xyz\")\n */\nexport function getEpisodeCanonicalUrl(siteUrl: string, podcastId: string, episodeId: string): string {\n  return `${siteUrl}/episode/${episodeId}`;\n}\n\n/**\n * Generate embed URL for an episode\n * @param siteUrl Base site URL\n * @param episodeId Episode ID\n * @returns Embed URL (e.g., \"/embed/episode/xyz\")\n */\nexport function getEpisodeEmbedUrl(siteUrl: string, episodeId: string): string {\n  return `${siteUrl}/embed/episode/${episodeId}`;\n}\n\n/**\n * Generate share URL for an episode (same as canonical for now)\n * @param siteUrl Base site URL\n * @param podcastId Podcast ID\n * @param episodeId Episode ID\n * @returns Share URL\n */\nexport function getEpisodeShareUrl(siteUrl: string, podcastId: string, episodeId: string): string {\n  return getEpisodeCanonicalUrl(siteUrl, podcastId, episodeId);\n}\n\n/**\n * Escape HTML entities for safe rendering in HTML attributes\n * @param str String to escape\n * @returns Escaped string\n */\nfunction escapeHtmlAttribute(str: string): string {\n  return str\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\n/**\n * Generate embed iframe code snippet\n * @param embedUrl Full embed URL (should already be safe)\n * @param episodeTitle Episode title for iframe title attribute\n * @returns HTML iframe snippet with escaped attributes\n */\nexport function getEmbedIframeCode(embedUrl: string, episodeTitle: string): string {\n  const safeTitle = escapeHtmlAttribute(episodeTitle);\n  const safeUrl = escapeHtmlAttribute(embedUrl);\n  return `<iframe src=\"${safeUrl}\" width=\"100%\" height=\"200\" frameborder=\"0\" allow=\"autoplay; clipboard-write\" loading=\"lazy\" title=\"${safeTitle}\"></iframe>`;\n}\n\n/**\n * Generate podcast page URL\n * @param siteUrl Base site URL\n * @param podcastId Podcast ID\n * @returns Podcast page URL (e.g., \"/podcast/xyz\")\n */\nexport function getPodcastUrl(siteUrl: string, podcastId: string): string {\n  return `${siteUrl}/podcast/${podcastId}`;\n}\n\n/**\n * Generate RSS feed URL for a podcast\n * @param siteUrl Base site URL\n * @param podcastId Podcast ID\n * @returns RSS feed URL (e.g., \"/api/podcasts/xyz/rss\")\n */\nexport function getPodcastRSSUrl(siteUrl: string, podcastId: string): string {\n  return `${siteUrl}/api/podcasts/${podcastId}/rss`;\n}\n","path":null,"size_bytes":3115,"size_tokens":null},"client/src/components/ShareMenu.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Share2,\n  Link,\n  Code,\n  Mail,\n  MessageCircle,\n  Rss,\n} from \"lucide-react\";\nimport { SiX, SiFacebook, SiLinkedin } from \"react-icons/si\";\n\ninterface ShareMenuProps {\n  episodeTitle: string;\n  episodeUrl: string;\n  embedCode: string;\n  isPodcast?: boolean;\n  rssUrl?: string;\n}\n\nexport function ShareMenu({ episodeTitle, episodeUrl, embedCode, isPodcast, rssUrl }: ShareMenuProps) {\n  const { toast } = useToast();\n  const [open, setOpen] = useState(false);\n\n  // Validate that we have the necessary data (check for non-empty strings)\n  const hasValidUrl = episodeUrl && episodeUrl.trim().length > 0;\n  const hasValidEmbedCode = embedCode && embedCode.trim().length > 0;\n  const hasValidRssUrl = rssUrl && rssUrl.trim().length > 0;\n\n  const copyToClipboard = async (text: string, successMessage: string) => {\n    // Validate that we have actual content to copy\n    if (!text || text.trim().length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"No hay contenido disponible para copiar\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    try {\n      await navigator.clipboard.writeText(text);\n      toast({\n        title: \"Copiado\",\n        description: successMessage,\n      });\n      setOpen(false);\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo copiar al portapapeles\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleCopyLink = (event: Event) => {\n    if (!hasValidUrl) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No hay enlace disponible para copiar\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    copyToClipboard(episodeUrl, \"Enlace copiado al portapapeles\");\n  };\n\n  const handleCopyEmbedCode = (event: Event) => {\n    if (!hasValidEmbedCode) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No hay cÃ³digo de inserciÃ³n disponible\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    copyToClipboard(embedCode, \"CÃ³digo de inserciÃ³n copiado\");\n  };\n\n  const handleCopyRssUrl = (event: Event) => {\n    if (!hasValidRssUrl) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No hay URL de RSS disponible\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    copyToClipboard(rssUrl!, \"URL de RSS copiada\");\n  };\n\n  const shareToX = (event: Event) => {\n    if (!hasValidUrl) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No se puede compartir sin una URL vÃ¡lida\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    const text = encodeURIComponent(`Escucha: ${episodeTitle}`);\n    const url = encodeURIComponent(episodeUrl);\n    // Double-check URL is not empty before opening\n    if (!url) {\n      event.preventDefault();\n      return;\n    }\n    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'noopener,noreferrer');\n    setOpen(false);\n  };\n\n  const shareToFacebook = (event: Event) => {\n    if (!hasValidUrl) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No se puede compartir sin una URL vÃ¡lida\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    const url = encodeURIComponent(episodeUrl);\n    // Double-check URL is not empty before opening\n    if (!url) {\n      event.preventDefault();\n      return;\n    }\n    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'noopener,noreferrer');\n    setOpen(false);\n  };\n\n  const shareToLinkedIn = (event: Event) => {\n    if (!hasValidUrl) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No se puede compartir sin una URL vÃ¡lida\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    const url = encodeURIComponent(episodeUrl);\n    // Double-check URL is not empty before opening\n    if (!url) {\n      event.preventDefault();\n      return;\n    }\n    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'noopener,noreferrer');\n    setOpen(false);\n  };\n\n  const shareToWhatsApp = (event: Event) => {\n    if (!hasValidUrl) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No se puede compartir sin una URL vÃ¡lida\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    const text = encodeURIComponent(`Escucha: ${episodeTitle} ${episodeUrl}`);\n    // Double-check text is not empty before opening\n    if (!text) {\n      event.preventDefault();\n      return;\n    }\n    window.open(`https://wa.me/?text=${text}`, '_blank', 'noopener,noreferrer');\n    setOpen(false);\n  };\n\n  const shareViaEmail = (event: Event) => {\n    if (!hasValidUrl) {\n      event.preventDefault();\n      toast({\n        title: \"Error\",\n        description: \"No se puede compartir sin una URL vÃ¡lida\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    const subject = encodeURIComponent(`Te recomiendo este episodio: ${episodeTitle}`);\n    const body = encodeURIComponent(`Hola,\\n\\nTe recomiendo escuchar este episodio:\\n\\n${episodeTitle}\\n\\n${episodeUrl}\\n\\nÂ¡Espero que lo disfrutes!`);\n    // Double-check body is not empty before setting location\n    if (!body) {\n      event.preventDefault();\n      return;\n    }\n    window.location.href = `mailto:?subject=${subject}&body=${body}`;\n    setOpen(false);\n  };\n\n  return (\n    <DropdownMenu open={open} onOpenChange={setOpen}>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\" size=\"sm\" data-testid=\"button-share\">\n          <Share2 className=\"h-4 w-4 mr-2\" />\n          Compartir\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-56\">\n        <DropdownMenuLabel>{isPodcast ? 'Compartir podcast' : 'Compartir episodio'}</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        \n        <DropdownMenuItem \n          onSelect={handleCopyLink} \n          data-testid=\"menu-item-copy-link\"\n          disabled={!hasValidUrl}\n        >\n          <Link className=\"h-4 w-4 mr-2\" />\n          Copiar enlace\n        </DropdownMenuItem>\n        \n        {isPodcast && hasValidRssUrl && (\n          <DropdownMenuItem \n            onSelect={handleCopyRssUrl} \n            data-testid=\"menu-item-copy-rss\"\n            disabled={!hasValidRssUrl}\n          >\n            <Rss className=\"h-4 w-4 mr-2\" />\n            Copiar URL de RSS\n          </DropdownMenuItem>\n        )}\n        \n        {!isPodcast && (\n          <DropdownMenuItem \n            onSelect={handleCopyEmbedCode} \n            data-testid=\"menu-item-copy-embed\"\n            disabled={!hasValidEmbedCode}\n          >\n            <Code className=\"h-4 w-4 mr-2\" />\n            Copiar cÃ³digo de inserciÃ³n\n          </DropdownMenuItem>\n        )}\n        \n        <DropdownMenuSeparator />\n        <DropdownMenuLabel>Compartir en redes</DropdownMenuLabel>\n        \n        <DropdownMenuItem \n          onSelect={shareToX} \n          data-testid=\"menu-item-share-x\"\n          disabled={!hasValidUrl}\n        >\n          <SiX className=\"h-4 w-4 mr-2\" />\n          X (Twitter)\n        </DropdownMenuItem>\n        \n        <DropdownMenuItem \n          onSelect={shareToFacebook} \n          data-testid=\"menu-item-share-facebook\"\n          disabled={!hasValidUrl}\n        >\n          <SiFacebook className=\"h-4 w-4 mr-2\" />\n          Facebook\n        </DropdownMenuItem>\n        \n        <DropdownMenuItem \n          onSelect={shareToLinkedIn} \n          data-testid=\"menu-item-share-linkedin\"\n          disabled={!hasValidUrl}\n        >\n          <SiLinkedin className=\"h-4 w-4 mr-2\" />\n          LinkedIn\n        </DropdownMenuItem>\n        \n        <DropdownMenuItem \n          onSelect={shareToWhatsApp} \n          data-testid=\"menu-item-share-whatsapp\"\n          disabled={!hasValidUrl}\n        >\n          <MessageCircle className=\"h-4 w-4 mr-2\" />\n          WhatsApp\n        </DropdownMenuItem>\n        \n        <DropdownMenuItem \n          onSelect={shareViaEmail} \n          data-testid=\"menu-item-share-email\"\n          disabled={!hasValidUrl}\n        >\n          <Mail className=\"h-4 w-4 mr-2\" />\n          Email\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","path":null,"size_bytes":8649,"size_tokens":null},"client/src/pages/episode-detail.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Card } from \"@/components/ui/card\";\nimport { ShareMenu } from \"@/components/ShareMenu\";\nimport { ArrowLeft, Play, Clock, Calendar, User, Heart, HeartOff, Pencil, Users } from \"lucide-react\";\nimport { AudioPlayer } from \"@/components/audio-player\";\nimport { AddToPlaylistButton } from \"@/components/add-to-playlist-button\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { EpisodeWithPodcastAndUrls } from \"@shared/schema\";\nimport { useAuth } from \"@/components/auth-provider\";\n\nexport default function EpisodeDetail() {\n  const [, params] = useRoute(\"/episode/:id\");\n  const episodeId = params?.id;\n  const [isPlaying, setIsPlaying] = useState(false);\n  const { toast } = useToast();\n  const { user } = useAuth();\n\n  const { data: episode, isLoading } = useQuery<EpisodeWithPodcastAndUrls & { isSubscribed?: boolean }>({\n    queryKey: [\"/api/episodes\", episodeId],\n    enabled: !!episodeId,\n  });\n\n  const handleSubscribe = async () => {\n    if (!episode?.podcast?.id) return;\n    \n    try {\n      if (episode?.isSubscribed) {\n        await apiRequest(\"DELETE\", `/api/podcasts/${episode.podcast.id}/subscribe`);\n        toast({\n          title: \"Desuscrito\",\n          description: \"Te has desuscrito del podcast\",\n        });\n      } else {\n        await apiRequest(\"POST\", `/api/podcasts/${episode.podcast.id}/subscribe`);\n        toast({\n          title: \"Suscrito\",\n          description: \"Te has suscrito al podcast\",\n        });\n      }\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/library\"] });\n    } catch (error: any) {\n      if (error.message?.includes(\"401\")) {\n        toast({\n          variant: \"destructive\",\n          title: \"No autenticado\",\n          description: \"Debes iniciar sesiÃ³n para suscribirte\",\n        });\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Error\",\n          description: \"No se pudo actualizar la suscripciÃ³n\",\n        });\n      }\n    }\n  };\n\n  // Update document title and meta tags when episode data loads\n  useEffect(() => {\n    if (episode) {\n      document.title = `${episode.title} - ${episode.podcast?.title || 'Podcast'}`;\n      \n      // Update meta tags for social sharing\n      const updateMetaTag = (property: string, content: string) => {\n        let meta = document.querySelector(`meta[property=\"${property}\"]`);\n        if (!meta) {\n          meta = document.createElement('meta');\n          meta.setAttribute('property', property);\n          document.head.appendChild(meta);\n        }\n        meta.setAttribute('content', content);\n      };\n\n      const updateMetaName = (name: string, content: string) => {\n        let meta = document.querySelector(`meta[name=\"${name}\"]`);\n        if (!meta) {\n          meta = document.createElement('meta');\n          meta.setAttribute('name', name);\n          document.head.appendChild(meta);\n        }\n        meta.setAttribute('content', content);\n      };\n\n      // Open Graph tags\n      updateMetaTag('og:title', episode.title);\n      updateMetaTag('og:description', episode.notes || episode.title);\n      updateMetaTag('og:type', 'music.song');\n      if (episode.podcast?.coverArtUrl) {\n        updateMetaTag('og:image', episode.podcast.coverArtUrl);\n      }\n      if (episode.audioUrl) {\n        updateMetaTag('og:audio', episode.audioUrl);\n      }\n      \n      // Twitter Card tags\n      updateMetaName('twitter:card', 'player');\n      updateMetaName('twitter:title', episode.title);\n      updateMetaName('twitter:description', episode.notes || episode.title);\n      if (episode.podcast?.coverArtUrl) {\n        updateMetaName('twitter:image', episode.podcast.coverArtUrl);\n      }\n\n      // Description meta tag\n      updateMetaName('description', episode.notes || episode.title);\n    }\n  }, [episode]);\n\n  const formatDuration = (seconds: number) => {\n    const hours = Math.floor(seconds / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n    const secs = seconds % 60;\n    \n    if (hours > 0) {\n      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n    }\n    return `${minutes}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  const formatDate = (date: Date | string) => {\n    return new Intl.DateTimeFormat(\"es-ES\", {\n      year: \"numeric\",\n      month: \"long\",\n      day: \"numeric\",\n    }).format(new Date(date));\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen pb-32\">\n        <div className=\"max-w-4xl mx-auto px-6 py-8\">\n          <Skeleton className=\"h-8 w-24 mb-6\" />\n          <div className=\"flex gap-6 mb-8\">\n            <Skeleton className=\"w-64 h-64 rounded-xl\" />\n            <div className=\"flex-1 space-y-4\">\n              <Skeleton className=\"h-10 w-3/4\" />\n              <Skeleton className=\"h-20 w-full\" />\n              <Skeleton className=\"h-12 w-32\" />\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!episode) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <h2 className=\"text-2xl font-bold mb-2\">Episodio no encontrado</h2>\n          <Link href=\"/\">\n            <Button variant=\"default\">Volver al inicio</Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      {/* Hero Section */}\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"max-w-4xl mx-auto px-6 py-8\">\n          {/* Back Button */}\n          {episode.podcast && (\n            <Link href={`/podcast/${episode.podcast.id}`}>\n              <Button variant=\"ghost\" className=\"mb-6\" data-testid=\"button-back\">\n                <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                Volver al podcast\n              </Button>\n            </Link>\n          )}\n\n          {/* Episode Header */}\n          <div className=\"flex flex-col md:flex-row gap-8 mb-6\">\n            {/* Cover Art */}\n            {episode.podcast?.coverArtUrl ? (\n              <img\n                src={episode.podcast.coverArtUrl}\n                alt={episode.podcast.title}\n                className=\"w-full md:w-64 h-64 rounded-xl object-cover flex-shrink-0 shadow-lg\"\n                data-testid=\"img-episode-cover\"\n              />\n            ) : (\n              <div className=\"w-full md:w-64 h-64 rounded-xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center flex-shrink-0\">\n                <User className=\"h-24 w-24 text-primary/40\" />\n              </div>\n            )}\n\n            {/* Episode Info */}\n            <div className=\"flex-1\">\n              <div className=\"flex items-start justify-between gap-4 mb-4\">\n                <div>\n                  {episode.podcast && (\n                    <Link href={`/podcast/${episode.podcast.id}`}>\n                      <p className=\"text-sm text-primary hover:underline mb-2\" data-testid=\"link-podcast\">\n                        {episode.podcast.title}\n                      </p>\n                    </Link>\n                  )}\n                  <h1 className=\"text-3xl md:text-4xl font-bold font-[Outfit]\" data-testid=\"text-episode-title\">\n                    {episode.title}\n                  </h1>\n                </div>\n                <ShareMenu \n                  episodeTitle={episode.title}\n                  episodeUrl={episode.canonicalUrl || ''}\n                  embedCode={episode.embedCode || ''}\n                />\n              </div>\n\n              {/* Metadata */}\n              <div className=\"flex flex-wrap items-center gap-4 text-sm text-muted-foreground mb-6\">\n                <div className=\"flex items-center gap-1\" data-testid=\"text-duration\">\n                  <Clock className=\"h-4 w-4\" />\n                  <span>{formatDuration(episode.duration)}</span>\n                </div>\n                <div className=\"flex items-center gap-1\" data-testid=\"text-published-date\">\n                  <Calendar className=\"h-4 w-4\" />\n                  <span>{formatDate(episode.publishedAt)}</span>\n                </div>\n              </div>\n\n              {/* Play and Subscribe Buttons */}\n              <div className=\"flex gap-3 flex-wrap\">\n                <Button \n                  size=\"lg\" \n                  onClick={() => setIsPlaying(true)}\n                  className=\"gap-2\"\n                  data-testid=\"button-play-episode\"\n                >\n                  <Play className=\"h-5 w-5\" />\n                  Reproducir episodio\n                </Button>\n                <Button\n                  size=\"lg\"\n                  variant={episode.isSubscribed ? \"secondary\" : \"outline\"}\n                  onClick={handleSubscribe}\n                  data-testid=\"button-subscribe\"\n                  className=\"gap-2\"\n                >\n                  {episode.isSubscribed ? (\n                    <>\n                      <HeartOff className=\"h-5 w-5\" />\n                      Desuscribirse\n                    </>\n                  ) : (\n                    <>\n                      <Heart className=\"h-5 w-5\" />\n                      Suscribirse\n                    </>\n                  )}\n                </Button>\n                {user && episodeId && (\n                  <AddToPlaylistButton episodeId={episodeId} variant=\"outline\" size=\"lg\" />\n                )}\n                {user && episode.podcast && (user.id === episode.podcast.ownerId || user.role === \"ADMIN\") && (\n                  <Link href={`/edit-episode/${episodeId}`}>\n                    <Button size=\"lg\" variant=\"outline\" data-testid=\"button-edit-episode\" className=\"gap-2\">\n                      <Pencil className=\"h-5 w-5\" />\n                      Editar\n                    </Button>\n                  </Link>\n                )}\n                {user && episode.podcast && user.id === episode.podcast.ownerId && (episode.visibility === \"UNLISTED\" || episode.visibility === \"PRIVATE\") && (\n                  <Link href={`/manage-invitations/episode/${episodeId}`}>\n                    <Button size=\"lg\" variant=\"outline\" data-testid=\"button-manage-invitations\" className=\"gap-2\">\n                      <Users className=\"h-5 w-5\" />\n                      Gestionar Invitaciones\n                    </Button>\n                  </Link>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"max-w-4xl mx-auto px-6 py-8\">\n        {/* Episode Description */}\n        {episode.notes && (\n          <Card className=\"p-6\">\n            <h2 className=\"text-xl font-bold font-[Outfit] mb-4\">DescripciÃ³n</h2>\n            <div \n              className=\"prose prose-sm dark:prose-invert max-w-none\"\n              data-testid=\"text-episode-notes\"\n            >\n              <p className=\"whitespace-pre-wrap leading-relaxed\">\n                {episode.notes}\n              </p>\n            </div>\n          </Card>\n        )}\n      </div>\n\n      {/* Fixed Audio Player */}\n      {isPlaying && (\n        <AudioPlayer\n          episode={episode}\n          podcastTitle={episode.podcast?.title}\n          podcastCover={episode.podcast?.coverArtUrl || undefined}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":11640,"size_tokens":null},"server/init-admin.ts":{"content":"import { db } from \"./db\";\nimport { users } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport bcrypt from \"bcryptjs\";\nimport crypto from \"crypto\";\n\nfunction generateSecurePassword(length: number = 16): string {\n  const charset = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*\";\n  let password = \"\";\n  const randomValues = crypto.randomBytes(length);\n  \n  for (let i = 0; i < length; i++) {\n    password += charset[randomValues[i] % charset.length];\n  }\n  return password;\n}\n\nexport async function initializeAdmin() {\n  try {\n    // Check if admin user already exists\n    const existingAdmin = await db.select()\n      .from(users)\n      .where(eq(users.role, \"ADMIN\"))\n      .limit(1);\n\n    if (existingAdmin.length > 0) {\n      console.log(\"[init] Admin user already exists\");\n      return;\n    }\n\n    // Get admin credentials from environment or generate secure random password\n    const adminUsername = process.env.ADMIN_USERNAME || \"admin\";\n    const adminEmail = process.env.ADMIN_EMAIL || \"admin@podcasthub.local\";\n    const adminPassword = process.env.ADMIN_PASSWORD || generateSecurePassword();\n    \n    const passwordHash = await bcrypt.hash(adminPassword, 10);\n\n    await db.insert(users).values({\n      username: adminUsername,\n      email: adminEmail,\n      passwordHash,\n      role: \"ADMIN\",\n      bio: \"Administrator\",\n      emailVerified: true,\n    }).returning();\n\n    console.log(\"[init] Admin user created successfully\");\n    console.log(\"[init] Username:\", adminUsername);\n    console.log(\"[init] Email:\", adminEmail);\n    \n    // Only log password if it was auto-generated (not from env)\n    if (!process.env.ADMIN_PASSWORD) {\n      console.log(\"[init] Generated password:\", adminPassword);\n      console.log(\"[init] IMPORTANT: Save this password securely - it won't be shown again!\");\n    } else {\n      console.log(\"[init] Password was set from ADMIN_PASSWORD environment variable\");\n    }\n  } catch (error) {\n    console.error(\"[init] Error creating admin user:\", error);\n  }\n}\n","path":null,"size_bytes":2039,"size_tokens":null},"shared/admin-schemas.ts":{"content":"import { z } from \"zod\";\n\n// User management schemas\nexport const updateUserRoleSchema = z.object({\n  role: z.enum([\"LISTENER\", \"CREATOR\", \"ADMIN\"]),\n});\n\nexport const updateUserApprovalSchema = z.object({\n  requiresApproval: z.boolean(),\n});\n\nexport const updateUserActiveSchema = z.object({\n  isActive: z.boolean(),\n});\n\n// Content moderation schemas\nexport const updateAudiobookStatusSchema = z.object({\n  status: z.enum([\"DRAFT\", \"PENDING_APPROVAL\", \"APPROVED\", \"REJECTED\"]),\n});\n\nexport const updateChapterStatusSchema = z.object({\n  status: z.enum([\"DRAFT\", \"PENDING_APPROVAL\", \"APPROVED\", \"REJECTED\"]),\n});\n\n// Query parameter schemas for filtering\nexport const adminAudiobooksQuerySchema = z.object({\n  status: z.enum([\"DRAFT\", \"PENDING_APPROVAL\", \"APPROVED\", \"REJECTED\"]).optional(),\n  publisherId: z.string().uuid().optional(),\n  search: z.string().optional(),\n});\n\nexport const adminChaptersQuerySchema = z.object({\n  status: z.enum([\"DRAFT\", \"PENDING_APPROVAL\", \"APPROVED\", \"REJECTED\"]).optional(),\n  audiobookId: z.string().uuid().optional(),\n  publisherId: z.string().uuid().optional(),\n  search: z.string().optional(),\n});\n\n// Email configuration schemas\nexport const createEmailConfigSchema = z.object({\n  smtpHost: z.string().min(1, \"SMTP host is required\"),\n  smtpPort: z.number().int().min(1).max(65535),\n  smtpSecure: z.boolean().default(false),\n  smtpUser: z.string().min(1, \"SMTP user is required\"),\n  smtpPassword: z.string().min(1, \"SMTP password is required\"),\n  fromEmail: z.string().email(\"Invalid email address\"),\n  fromName: z.string().min(1).default(\"Audivia\"),\n  isActive: z.boolean().default(false),\n});\n\nexport const updateEmailConfigSchema = z.object({\n  smtpHost: z.string().min(1).optional(),\n  smtpPort: z.number().int().min(1).max(65535).optional(),\n  smtpSecure: z.boolean().optional(),\n  smtpUser: z.string().min(1).optional(),\n  smtpPassword: z.string().min(1).optional(),\n  fromEmail: z.string().email().optional(),\n  fromName: z.string().min(1).optional(),\n  isActive: z.boolean().optional(),\n});\n\n// Google Drive configuration schemas\nconst validateServiceAccountKey = (value: string) => {\n  try {\n    const parsed = JSON.parse(value);\n    if (!parsed.type || parsed.type !== 'service_account') {\n      return false;\n    }\n    if (!parsed.project_id || !parsed.private_key || !parsed.client_email) {\n      return false;\n    }\n    return true;\n  } catch {\n    return false;\n  }\n};\n\nexport const createDriveConfigSchema = z.object({\n  serviceAccountEmail: z.string().email(\"Invalid service account email\"),\n  serviceAccountKey: z.string()\n    .min(1, \"Service account key is required\")\n    .refine(validateServiceAccountKey, \"Invalid service account key JSON\"),\n  folderIdImages: z.string().min(1, \"Images folder ID is required\"),\n  folderIdAudio: z.string().min(1, \"Audio folder ID is required\"),\n  isActive: z.boolean().default(false),\n});\n\nexport const updateDriveConfigSchema = z.object({\n  serviceAccountEmail: z.string().email().optional(),\n  serviceAccountKey: z.string()\n    .min(1)\n    .refine(validateServiceAccountKey, \"Invalid service account key JSON\")\n    .optional(),\n  folderIdImages: z.string().min(1).optional(),\n  folderIdAudio: z.string().min(1).optional(),\n  isActive: z.boolean().optional(),\n});\n\nexport const testDriveConfigSchema = z.object({\n  serviceAccountEmail: z.string().email(\"Invalid service account email\"),\n  serviceAccountKey: z.string()\n    .min(1, \"Service account key is required\")\n    .refine(validateServiceAccountKey, \"Invalid service account key JSON\"),\n  folderIdImages: z.string().min(1, \"Images folder ID is required\"),\n  folderIdAudio: z.string().min(1, \"Audio folder ID is required\"),\n});\n\n// Subscription plan schemas\nexport const createSubscriptionPlanSchema = z.object({\n  name: z.string().min(1, \"Plan name is required\"),\n  description: z.string().optional(),\n  priceCents: z.number().int().min(0),\n  currency: z.string().default(\"EUR\"),\n  intervalMonths: z.number().int().min(1).default(1),\n  isActive: z.boolean().default(true),\n});\n\nexport const updateSubscriptionPlanSchema = z.object({\n  name: z.string().min(1).optional(),\n  description: z.string().optional(),\n  priceCents: z.number().int().min(0).optional(),\n  currency: z.string().optional(),\n  intervalMonths: z.number().int().min(1).optional(),\n  isActive: z.boolean().optional(),\n});\n\n// TypeScript types\nexport type UpdateUserRole = z.infer<typeof updateUserRoleSchema>;\nexport type UpdateUserApproval = z.infer<typeof updateUserApprovalSchema>;\nexport type UpdateUserActive = z.infer<typeof updateUserActiveSchema>;\nexport type UpdateAudiobookStatus = z.infer<typeof updateAudiobookStatusSchema>;\nexport type UpdateChapterStatus = z.infer<typeof updateChapterStatusSchema>;\nexport type AdminAudiobooksQuery = z.infer<typeof adminAudiobooksQuerySchema>;\nexport type AdminChaptersQuery = z.infer<typeof adminChaptersQuerySchema>;\nexport type CreateEmailConfig = z.infer<typeof createEmailConfigSchema>;\nexport type UpdateEmailConfig = z.infer<typeof updateEmailConfigSchema>;\nexport type CreateDriveConfig = z.infer<typeof createDriveConfigSchema>;\nexport type UpdateDriveConfig = z.infer<typeof updateDriveConfigSchema>;\nexport type TestDriveConfig = z.infer<typeof testDriveConfigSchema>;\nexport type CreateSubscriptionPlan = z.infer<typeof createSubscriptionPlanSchema>;\nexport type UpdateSubscriptionPlan = z.infer<typeof updateSubscriptionPlanSchema>;\n\n// Bulk operations schemas\nexport const bulkIdsSchema = z.object({\n  ids: z.array(z.string().uuid()).min(1, \"At least one ID is required\").max(50, \"Maximum 50 items per operation\"),\n});\n\nexport const bulkDeleteUsersSchema = bulkIdsSchema;\n\nexport const bulkUpdateUsersRoleSchema = z.object({\n  ids: z.array(z.string().uuid()).min(1).max(50),\n  role: z.enum([\"LISTENER\", \"CREATOR\", \"ADMIN\"]),\n});\n\nexport const bulkUpdateUsersActiveSchema = z.object({\n  ids: z.array(z.string().uuid()).min(1).max(50),\n  isActive: z.boolean(),\n});\n\nexport const bulkDeleteAudiobooksSchema = bulkIdsSchema;\n\nexport const bulkUpdateAudiobooksStatusSchema = z.object({\n  ids: z.array(z.string().uuid()).min(1).max(50),\n  status: z.enum([\"DRAFT\", \"PENDING_APPROVAL\", \"APPROVED\", \"REJECTED\"]),\n});\n\nexport const bulkDeleteChaptersSchema = bulkIdsSchema;\n\nexport const bulkUpdateChaptersStatusSchema = z.object({\n  ids: z.array(z.string().uuid()).min(1).max(50),\n  status: z.enum([\"DRAFT\", \"PENDING_APPROVAL\", \"APPROVED\", \"REJECTED\"]),\n});\n\n// Legacy aliases for backward compatibility\nexport const updatePodcastStatusSchema = updateAudiobookStatusSchema;\nexport const updateEpisodeStatusSchema = updateChapterStatusSchema;\nexport const adminPodcastsQuerySchema = adminAudiobooksQuerySchema;\nexport const adminEpisodesQuerySchema = adminChaptersQuerySchema;\nexport const bulkDeletePodcastsSchema = bulkDeleteAudiobooksSchema;\nexport const bulkUpdatePodcastsStatusSchema = bulkUpdateAudiobooksStatusSchema;\nexport const bulkDeleteEpisodesSchema = bulkDeleteChaptersSchema;\nexport const bulkUpdateEpisodesStatusSchema = bulkUpdateChaptersStatusSchema;\n\n// Bulk operation types\nexport type BulkIds = z.infer<typeof bulkIdsSchema>;\nexport type BulkDeleteUsers = z.infer<typeof bulkDeleteUsersSchema>;\nexport type BulkUpdateUsersRole = z.infer<typeof bulkUpdateUsersRoleSchema>;\nexport type BulkUpdateUsersActive = z.infer<typeof bulkUpdateUsersActiveSchema>;\nexport type BulkDeleteAudiobooks = z.infer<typeof bulkDeleteAudiobooksSchema>;\nexport type BulkUpdateAudiobooksStatus = z.infer<typeof bulkUpdateAudiobooksStatusSchema>;\nexport type BulkDeleteChapters = z.infer<typeof bulkDeleteChaptersSchema>;\nexport type BulkUpdateChaptersStatus = z.infer<typeof bulkUpdateChaptersStatusSchema>;\n\n// Legacy type aliases\nexport type BulkDeletePodcasts = BulkDeleteAudiobooks;\nexport type BulkUpdatePodcastsStatus = BulkUpdateAudiobooksStatus;\nexport type BulkDeleteEpisodes = BulkDeleteChapters;\nexport type BulkUpdateEpisodesStatus = BulkUpdateChaptersStatus;\n","path":null,"size_bytes":7940,"size_tokens":null},"client/src/pages/admin-episodes.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, CheckCircle, XCircle, Trash2, Search, Radio } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Episode, Podcast, User } from \"@shared/schema\";\n\ntype StatusFilter = \"all\" | \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\";\n\ninterface EpisodeWithPodcast extends Episode {\n  podcast: Podcast & {\n    owner: User;\n  };\n}\n\nexport default function AdminEpisodes() {\n  const { toast } = useToast();\n  const [statusFilter, setStatusFilter] = useState<StatusFilter>(\"all\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedEpisode, setSelectedEpisode] = useState<EpisodeWithPodcast | null>(null);\n  const [actionType, setActionType] = useState<\"approve\" | \"reject\" | \"delete\" | null>(null);\n  \n  // Bulk operations state\n  const [selectedIds, setSelectedIds] = useState<string[]>([]);\n  const [bulkAction, setBulkAction] = useState<\"delete\" | \"approve\" | \"reject\" | null>(null);\n\n  const { data: allEpisodes, isLoading } = useQuery<EpisodeWithPodcast[]>({\n    queryKey: [\"/api/admin/episodes\"],\n  });\n\n  // Reset selection when dataset changes (to avoid stale selections)\n  useEffect(() => {\n    if (allEpisodes) {\n      setSelectedIds(prev => prev.filter(id => allEpisodes.some(e => e.id === id)));\n    }\n  }, [allEpisodes]);\n\n  // Reset selection when filters change\n  useEffect(() => {\n    setSelectedIds([]);\n  }, [statusFilter, searchQuery]);\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ episodeId, status }: { episodeId: string; status: string }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/episodes/${episodeId}/status`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/episodes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\"] });\n      toast({\n        title: \"Estado actualizado\",\n        description: \"El estado del episodio ha sido actualizado correctamente.\",\n      });\n      setSelectedEpisode(null);\n      setActionType(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el estado del episodio.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteEpisodeMutation = useMutation({\n    mutationFn: async (episodeId: string) => {\n      return await apiRequest(\"DELETE\", `/api/admin/episodes/${episodeId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/episodes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\"] });\n      toast({\n        title: \"Episodio eliminado\",\n        description: \"El episodio ha sido eliminado correctamente.\",\n      });\n      setSelectedEpisode(null);\n      setActionType(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo eliminar el episodio.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Bulk operations mutations\n  const bulkDeleteMutation = useMutation({\n    mutationFn: async (ids: string[]) => {\n      return await apiRequest(\"POST\", \"/api/admin/episodes/bulk-delete\", { ids });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/episodes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\"] });\n      \n      toast({\n        title: \"OperaciÃ³n completada\",\n        description: data.message || `Se eliminaron ${data.successIds?.length || 0} episodio(s)`,\n      });\n      \n      if (data.failed && data.failed.length > 0) {\n        const failedEpisodes = allEpisodes?.filter(e => data.failed.some((f: any) => f.id === e.id)) || [];\n        const failedTitles = failedEpisodes.map(e => e.title).join(\", \");\n        toast({\n          title: \"Algunos elementos fallaron\",\n          description: `Los siguientes episodios no pudieron ser eliminados: ${failedTitles}`,\n          variant: \"destructive\",\n        });\n      }\n      \n      setSelectedIds(prev => prev.filter(id => !data.successIds?.includes(id)));\n      setBulkAction(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudieron eliminar los episodios.\",\n        variant: \"destructive\",\n      });\n      setBulkAction(null);\n    },\n  });\n\n  const bulkUpdateStatusMutation = useMutation({\n    mutationFn: async ({ ids, status }: { ids: string[]; status: string }) => {\n      return await apiRequest(\"POST\", \"/api/admin/episodes/bulk-update-status\", { ids, status });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/episodes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\"] });\n      \n      toast({\n        title: \"OperaciÃ³n completada\",\n        description: data.message || `Se actualizaron ${data.successIds?.length || 0} episodio(s)`,\n      });\n      \n      if (data.failed && data.failed.length > 0) {\n        const failedEpisodes = allEpisodes?.filter(e => data.failed.some((f: any) => f.id === e.id)) || [];\n        const failedTitles = failedEpisodes.map(e => e.title).join(\", \");\n        toast({\n          title: \"Algunos elementos fallaron\",\n          description: `Los siguientes episodios no pudieron ser actualizados: ${failedTitles}`,\n          variant: \"destructive\",\n        });\n      }\n      \n      setSelectedIds(prev => prev.filter(id => !data.successIds?.includes(id)));\n      setBulkAction(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudieron actualizar los episodios.\",\n        variant: \"destructive\",\n      });\n      setBulkAction(null);\n    },\n  });\n\n  const handleApprove = (episode: EpisodeWithPodcast) => {\n    setSelectedEpisode(episode);\n    setActionType(\"approve\");\n  };\n\n  const handleReject = (episode: EpisodeWithPodcast) => {\n    setSelectedEpisode(episode);\n    setActionType(\"reject\");\n  };\n\n  const handleDelete = (episode: EpisodeWithPodcast) => {\n    setSelectedEpisode(episode);\n    setActionType(\"delete\");\n  };\n\n  const confirmAction = () => {\n    if (!selectedEpisode) return;\n\n    if (actionType === \"approve\") {\n      updateStatusMutation.mutate({ episodeId: selectedEpisode.id, status: \"APPROVED\" });\n    } else if (actionType === \"reject\") {\n      updateStatusMutation.mutate({ episodeId: selectedEpisode.id, status: \"REJECTED\" });\n    } else if (actionType === \"delete\") {\n      deleteEpisodeMutation.mutate(selectedEpisode.id);\n    }\n  };\n\n  // Bulk operation handlers\n  const handleToggleSelection = (id: string) => {\n    setSelectedIds(prev => \n      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]\n    );\n  };\n\n  const handleToggleAll = () => {\n    const filteredEpisodes = allEpisodes?.filter((episode) => {\n      const matchesStatus = statusFilter === \"all\" || episode.status === statusFilter;\n      const matchesSearch = searchQuery === \"\" ||\n        episode.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        episode.notes?.toLowerCase().includes(searchQuery.toLowerCase());\n      return matchesStatus && matchesSearch;\n    }) || [];\n\n    if (selectedIds.length === filteredEpisodes.length) {\n      setSelectedIds([]);\n    } else {\n      setSelectedIds(filteredEpisodes.map(e => e.id));\n    }\n  };\n\n  const handleBulkDelete = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"delete\");\n  };\n\n  const handleBulkApprove = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"approve\");\n  };\n\n  const handleBulkReject = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"reject\");\n  };\n\n  const confirmBulkAction = () => {\n    if (selectedIds.length === 0) return;\n\n    if (bulkAction === \"delete\") {\n      bulkDeleteMutation.mutate(selectedIds);\n    } else if (bulkAction === \"approve\") {\n      bulkUpdateStatusMutation.mutate({ ids: selectedIds, status: \"APPROVED\" });\n    } else if (bulkAction === \"reject\") {\n      bulkUpdateStatusMutation.mutate({ ids: selectedIds, status: \"REJECTED\" });\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"APPROVED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-green-500/10 text-green-600 border-green-500/20\" data-testid={`badge-status-approved`}>\n            <CheckCircle className=\"w-3 h-3 mr-1\" />\n            Aprobado\n          </Badge>\n        );\n      case \"PENDING_APPROVAL\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-yellow-500/10 text-yellow-600 border-yellow-500/20\" data-testid={`badge-status-pending`}>\n            Pendiente\n          </Badge>\n        );\n      case \"REJECTED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-red-500/10 text-red-600 border-red-500/20\" data-testid={`badge-status-rejected`}>\n            <XCircle className=\"w-3 h-3 mr-1\" />\n            Rechazado\n          </Badge>\n        );\n      case \"DRAFT\":\n        return <Badge variant=\"outline\" data-testid={`badge-status-draft`}>Borrador</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const formatDuration = (seconds: number) => {\n    const hours = Math.floor(seconds / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n    const secs = seconds % 60;\n    \n    if (hours > 0) {\n      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n    }\n    return `${minutes}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  // Filter episodes\n  const filteredEpisodes = allEpisodes?.filter((episode) => {\n    const matchesStatus = statusFilter === \"all\" || episode.status === statusFilter;\n    const matchesSearch = searchQuery === \"\" ||\n      episode.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      episode.notes?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      episode.podcast?.title.toLowerCase().includes(searchQuery.toLowerCase());\n    return matchesStatus && matchesSearch;\n  }) || [];\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 md:px-6 py-8 flex justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 md:px-6 py-8 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold font-[Outfit]\">ModeraciÃ³n de Episodios</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Revisa y gestiona los episodios de la plataforma\n        </p>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filtros</CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex flex-wrap gap-4\">\n          <div className=\"flex-1 min-w-[200px]\">\n            <label className=\"text-sm font-medium mb-2 block\">Buscar</label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Buscar por tÃ­tulo, descripciÃ³n o podcast...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-episodes\"\n              />\n            </div>\n          </div>\n          <div className=\"w-[200px]\">\n            <label className=\"text-sm font-medium mb-2 block\">Estado</label>\n            <Select value={statusFilter} onValueChange={(value: any) => setStatusFilter(value)}>\n              <SelectTrigger data-testid=\"select-status-filter\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Todos</SelectItem>\n                <SelectItem value=\"PENDING_APPROVAL\">Pendientes</SelectItem>\n                <SelectItem value=\"APPROVED\">Aprobados</SelectItem>\n                <SelectItem value=\"REJECTED\">Rechazados</SelectItem>\n                <SelectItem value=\"DRAFT\">Borradores</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Results */}\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            Episodios ({filteredEpisodes.length})\n          </CardTitle>\n          <CardDescription>\n            {statusFilter === \"all\" ? \"Todos los episodios\" : `Episodios con estado: ${statusFilter}`}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {selectedIds.length > 0 && (\n            <div className=\"mb-4 flex items-center gap-2 flex-wrap\">\n              <span className=\"text-sm text-muted-foreground\">\n                {selectedIds.length} episodio(s) seleccionado(s)\n              </span>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={handleBulkApprove}\n                disabled={bulkUpdateStatusMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-approve\"\n              >\n                {bulkUpdateStatusMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <CheckCircle className=\"w-3 h-3 mr-1\" />\n                )}\n                Aprobar Seleccionados\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={handleBulkReject}\n                disabled={bulkUpdateStatusMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-reject\"\n              >\n                {bulkUpdateStatusMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <XCircle className=\"w-3 h-3 mr-1\" />\n                )}\n                Rechazar Seleccionados\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"destructive\"\n                onClick={handleBulkDelete}\n                disabled={bulkUpdateStatusMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-delete\"\n              >\n                {bulkDeleteMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <Trash2 className=\"w-3 h-3 mr-1\" />\n                )}\n                Eliminar Seleccionados\n              </Button>\n            </div>\n          )}\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead className=\"w-[50px]\">\n                  <Checkbox\n                    checked={filteredEpisodes && filteredEpisodes.length > 0 && selectedIds.length === filteredEpisodes.length}\n                    onCheckedChange={handleToggleAll}\n                    data-testid=\"checkbox-select-all\"\n                  />\n                </TableHead>\n                <TableHead>Episodio</TableHead>\n                <TableHead>Podcast</TableHead>\n                <TableHead>DuraciÃ³n</TableHead>\n                <TableHead>Estado</TableHead>\n                <TableHead>Fecha</TableHead>\n                <TableHead className=\"text-right\">Acciones</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {filteredEpisodes.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={7} className=\"text-center text-muted-foreground\">\n                    No se encontraron episodios\n                  </TableCell>\n                </TableRow>\n              ) : (\n                filteredEpisodes.map((episode) => (\n                  <TableRow key={episode.id} data-testid={`row-episode-${episode.id}`}>\n                    <TableCell>\n                      <Checkbox\n                        checked={selectedIds.includes(episode.id)}\n                        onCheckedChange={() => handleToggleSelection(episode.id)}\n                        data-testid={`checkbox-episode-${episode.id}`}\n                      />\n                    </TableCell>\n                    <TableCell className=\"font-medium max-w-xs\" data-testid={`text-title-${episode.id}`}>\n                      <div className=\"truncate\">{episode.title}</div>\n                      {episode.notes && (\n                        <div className=\"text-xs text-muted-foreground truncate mt-1\">\n                          {episode.notes.substring(0, 80)}...\n                        </div>\n                      )}\n                    </TableCell>\n                    <TableCell data-testid={`text-podcast-${episode.id}`}>\n                      <div className=\"flex items-center gap-2\">\n                        <Radio className=\"w-3 h-3 text-primary\" />\n                        <span className=\"truncate max-w-[200px]\">\n                          {episode.podcast?.title || \"Desconocido\"}\n                        </span>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      {episode.duration ? formatDuration(episode.duration) : \"-\"}\n                    </TableCell>\n                    <TableCell>{getStatusBadge(episode.status)}</TableCell>\n                    <TableCell>\n                      {format(new Date(episode.publishedAt || Date.now()), \"dd/MM/yyyy\")}\n                    </TableCell>\n                    <TableCell className=\"text-right space-x-2\">\n                      {episode.status !== \"APPROVED\" && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleApprove(episode)}\n                          className=\"text-green-600 hover:text-green-700\"\n                          data-testid={`button-approve-${episode.id}`}\n                        >\n                          <CheckCircle className=\"w-3 h-3 mr-1\" />\n                          Aprobar\n                        </Button>\n                      )}\n                      {episode.status !== \"REJECTED\" && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleReject(episode)}\n                          className=\"text-red-600 hover:text-red-700\"\n                          data-testid={`button-reject-${episode.id}`}\n                        >\n                          <XCircle className=\"w-3 h-3 mr-1\" />\n                          Rechazar\n                        </Button>\n                      )}\n                      <Button\n                        size=\"sm\"\n                        variant=\"destructive\"\n                        onClick={() => handleDelete(episode)}\n                        data-testid={`button-delete-${episode.id}`}\n                      >\n                        <Trash2 className=\"w-3 h-3 mr-1\" />\n                        Eliminar\n                      </Button>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      {/* Confirmation Dialog */}\n      <AlertDialog \n        open={!!selectedEpisode && !!actionType} \n        onOpenChange={(open) => {\n          if (!updateStatusMutation.isPending && !deleteEpisodeMutation.isPending) {\n            if (!open) {\n              setSelectedEpisode(null);\n              setActionType(null);\n            }\n          }\n        }}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {actionType === \"approve\" && \"Aprobar Episodio\"}\n              {actionType === \"reject\" && \"Rechazar Episodio\"}\n              {actionType === \"delete\" && \"Eliminar Episodio\"}\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              {actionType === \"approve\" && (\n                <p>\n                  Â¿EstÃ¡s seguro de que deseas aprobar el episodio <strong>{selectedEpisode?.title}</strong>?\n                  SerÃ¡ visible para todos los usuarios.\n                </p>\n              )}\n              {actionType === \"reject\" && (\n                <p>\n                  Â¿EstÃ¡s seguro de que deseas rechazar el episodio <strong>{selectedEpisode?.title}</strong>?\n                  El creador podrÃ¡ verlo pero no serÃ¡ pÃºblico.\n                </p>\n              )}\n              {actionType === \"delete\" && (\n                <p className=\"text-red-600\">\n                  Â¿EstÃ¡s seguro de que deseas eliminar permanentemente el episodio <strong>{selectedEpisode?.title}</strong>?\n                  Esta acciÃ³n no se puede deshacer.\n                </p>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={updateStatusMutation.isPending || deleteEpisodeMutation.isPending}\n              data-testid=\"button-cancel-action\"\n            >\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmAction}\n              disabled={updateStatusMutation.isPending || deleteEpisodeMutation.isPending}\n              className={actionType === \"delete\" ? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\" : \"\"}\n              data-testid=\"button-confirm-action\"\n            >\n              {updateStatusMutation.isPending || deleteEpisodeMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Confirmar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Bulk Actions Confirmation Dialog */}\n      <AlertDialog \n        open={!!bulkAction} \n        onOpenChange={(open) => {\n          if (!bulkDeleteMutation.isPending && !bulkUpdateStatusMutation.isPending) {\n            if (!open) setBulkAction(null);\n          }\n        }}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {bulkAction === \"delete\" && \"Eliminar Episodios\"}\n              {bulkAction === \"approve\" && \"Aprobar Episodios\"}\n              {bulkAction === \"reject\" && \"Rechazar Episodios\"}\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              {bulkAction === \"delete\" && (\n                <p className=\"text-red-600\">\n                  Â¿EstÃ¡s seguro de que deseas eliminar <strong>{selectedIds.length}</strong> episodio(s)? \n                  Esta acciÃ³n no se puede deshacer.\n                </p>\n              )}\n              {bulkAction === \"approve\" && (\n                <p>\n                  Â¿Deseas aprobar <strong>{selectedIds.length}</strong> episodio(s)?\n                  SerÃ¡n visibles para todos los usuarios.\n                </p>\n              )}\n              {bulkAction === \"reject\" && (\n                <p>\n                  Â¿Deseas rechazar <strong>{selectedIds.length}</strong> episodio(s)?\n                  Los creadores podrÃ¡n verlos pero no serÃ¡n pÃºblicos.\n                </p>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={bulkDeleteMutation.isPending || bulkUpdateStatusMutation.isPending}\n              data-testid=\"button-cancel-bulk-action\"\n            >\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmBulkAction}\n              disabled={bulkDeleteMutation.isPending || bulkUpdateStatusMutation.isPending}\n              className={bulkAction === \"delete\" ? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\" : \"\"}\n              data-testid=\"button-confirm-bulk-action\"\n            >\n              {bulkDeleteMutation.isPending || bulkUpdateStatusMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Confirmar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":25167,"size_tokens":null},"client/src/pages/admin-podcasts.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, CheckCircle, XCircle, Trash2, Search } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Podcast, User } from \"@shared/schema\";\n\ninterface PodcastWithOwner extends Podcast {\n  owner: User;\n}\n\ntype StatusFilter = \"all\" | \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\";\n\nexport default function AdminPodcasts() {\n  const { toast } = useToast();\n  const [statusFilter, setStatusFilter] = useState<StatusFilter>(\"all\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedPodcast, setSelectedPodcast] = useState<PodcastWithOwner | null>(null);\n  const [actionType, setActionType] = useState<\"approve\" | \"reject\" | \"delete\" | null>(null);\n  \n  // Bulk operations state\n  const [selectedIds, setSelectedIds] = useState<string[]>([]);\n  const [bulkAction, setBulkAction] = useState<\"delete\" | \"approve\" | \"reject\" | null>(null);\n\n  const { data: allPodcasts, isLoading } = useQuery<PodcastWithOwner[]>({\n    queryKey: [\"/api/admin/podcasts\"],\n  });\n\n  // Reset selection when dataset changes (to avoid stale selections)\n  useEffect(() => {\n    if (allPodcasts) {\n      setSelectedIds(prev => prev.filter(id => allPodcasts.some(p => p.id === id)));\n    }\n  }, [allPodcasts]);\n\n  // Reset selection when filters change\n  useEffect(() => {\n    setSelectedIds([]);\n  }, [statusFilter, searchQuery]);\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ podcastId, status }: { podcastId: string; status: string }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/podcasts/${podcastId}/status`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      toast({\n        title: \"Estado actualizado\",\n        description: \"El estado del podcast ha sido actualizado correctamente.\",\n      });\n      setSelectedPodcast(null);\n      setActionType(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el estado del podcast.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deletePodcastMutation = useMutation({\n    mutationFn: async (podcastId: string) => {\n      return await apiRequest(\"DELETE\", `/api/admin/podcasts/${podcastId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      toast({\n        title: \"Podcast eliminado\",\n        description: \"El podcast ha sido eliminado correctamente.\",\n      });\n      setSelectedPodcast(null);\n      setActionType(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo eliminar el podcast.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Bulk operations mutations\n  const bulkDeleteMutation = useMutation({\n    mutationFn: async (ids: string[]) => {\n      return await apiRequest(\"POST\", \"/api/admin/podcasts/bulk-delete\", { ids });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      \n      toast({\n        title: \"OperaciÃ³n completada\",\n        description: data.message || `Se eliminaron ${data.successIds?.length || 0} podcast(s)`,\n      });\n      \n      if (data.failed && data.failed.length > 0) {\n        const failedPodcasts = allPodcasts?.filter(p => data.failed.some((f: any) => f.id === p.id)) || [];\n        const failedTitles = failedPodcasts.map(p => p.title).join(\", \");\n        toast({\n          title: \"Algunos elementos fallaron\",\n          description: `Los siguientes podcasts no pudieron ser eliminados: ${failedTitles}`,\n          variant: \"destructive\",\n        });\n      }\n      \n      setSelectedIds(prev => prev.filter(id => !data.successIds?.includes(id)));\n      setBulkAction(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudieron eliminar los podcasts.\",\n        variant: \"destructive\",\n      });\n      setBulkAction(null);\n    },\n  });\n\n  const bulkUpdateStatusMutation = useMutation({\n    mutationFn: async ({ ids, status }: { ids: string[]; status: string }) => {\n      return await apiRequest(\"POST\", \"/api/admin/podcasts/bulk-update-status\", { ids, status });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      \n      toast({\n        title: \"OperaciÃ³n completada\",\n        description: data.message || `Se actualizaron ${data.successIds?.length || 0} podcast(s)`,\n      });\n      \n      if (data.failed && data.failed.length > 0) {\n        const failedPodcasts = allPodcasts?.filter(p => data.failed.some((f: any) => f.id === p.id)) || [];\n        const failedTitles = failedPodcasts.map(p => p.title).join(\", \");\n        toast({\n          title: \"Algunos elementos fallaron\",\n          description: `Los siguientes podcasts no pudieron ser actualizados: ${failedTitles}`,\n          variant: \"destructive\",\n        });\n      }\n      \n      setSelectedIds(prev => prev.filter(id => !data.successIds?.includes(id)));\n      setBulkAction(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudieron actualizar los podcasts.\",\n        variant: \"destructive\",\n      });\n      setBulkAction(null);\n    },\n  });\n\n  const handleApprove = (podcast: PodcastWithOwner) => {\n    setSelectedPodcast(podcast);\n    setActionType(\"approve\");\n  };\n\n  const handleReject = (podcast: PodcastWithOwner) => {\n    setSelectedPodcast(podcast);\n    setActionType(\"reject\");\n  };\n\n  const handleDelete = (podcast: PodcastWithOwner) => {\n    setSelectedPodcast(podcast);\n    setActionType(\"delete\");\n  };\n\n  const confirmAction = () => {\n    if (!selectedPodcast) return;\n\n    if (actionType === \"approve\") {\n      updateStatusMutation.mutate({ podcastId: selectedPodcast.id, status: \"APPROVED\" });\n    } else if (actionType === \"reject\") {\n      updateStatusMutation.mutate({ podcastId: selectedPodcast.id, status: \"REJECTED\" });\n    } else if (actionType === \"delete\") {\n      deletePodcastMutation.mutate(selectedPodcast.id);\n    }\n  };\n\n  // Bulk operation handlers\n  const handleToggleSelection = (id: string) => {\n    setSelectedIds(prev => \n      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]\n    );\n  };\n\n  const handleToggleAll = () => {\n    if (selectedIds.length === filteredPodcasts.length) {\n      setSelectedIds([]);\n    } else {\n      setSelectedIds(filteredPodcasts.map(p => p.id));\n    }\n  };\n\n  const handleBulkDelete = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"delete\");\n  };\n\n  const handleBulkApprove = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"approve\");\n  };\n\n  const handleBulkReject = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"reject\");\n  };\n\n  const confirmBulkAction = () => {\n    if (selectedIds.length === 0) return;\n\n    if (bulkAction === \"delete\") {\n      bulkDeleteMutation.mutate(selectedIds);\n    } else if (bulkAction === \"approve\") {\n      bulkUpdateStatusMutation.mutate({ ids: selectedIds, status: \"APPROVED\" });\n    } else if (bulkAction === \"reject\") {\n      bulkUpdateStatusMutation.mutate({ ids: selectedIds, status: \"REJECTED\" });\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"APPROVED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-green-500/10 text-green-600 border-green-500/20\" data-testid={`badge-status-approved`}>\n            <CheckCircle className=\"w-3 h-3 mr-1\" />\n            Aprobado\n          </Badge>\n        );\n      case \"PENDING_APPROVAL\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-yellow-500/10 text-yellow-600 border-yellow-500/20\" data-testid={`badge-status-pending`}>\n            Pendiente\n          </Badge>\n        );\n      case \"REJECTED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-red-500/10 text-red-600 border-red-500/20\" data-testid={`badge-status-rejected`}>\n            <XCircle className=\"w-3 h-3 mr-1\" />\n            Rechazado\n          </Badge>\n        );\n      case \"DRAFT\":\n        return <Badge variant=\"outline\" data-testid={`badge-status-draft`}>Borrador</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  // Filter podcasts\n  const filteredPodcasts = allPodcasts?.filter((podcast) => {\n    const matchesStatus = statusFilter === \"all\" || podcast.status === statusFilter;\n    const matchesSearch = searchQuery === \"\" ||\n      podcast.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      podcast.description?.toLowerCase().includes(searchQuery.toLowerCase());\n    return matchesStatus && matchesSearch;\n  }) || [];\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 md:px-6 py-8 flex justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 md:px-6 py-8 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold font-[Outfit]\">ModeraciÃ³n de Podcasts</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Revisa y gestiona los podcasts de la plataforma\n        </p>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filtros</CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex flex-wrap gap-4\">\n          <div className=\"flex-1 min-w-[200px]\">\n            <label className=\"text-sm font-medium mb-2 block\">Buscar</label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Buscar por tÃ­tulo o descripciÃ³n...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-podcasts\"\n              />\n            </div>\n          </div>\n          <div className=\"w-[200px]\">\n            <label className=\"text-sm font-medium mb-2 block\">Estado</label>\n            <Select value={statusFilter} onValueChange={(value: any) => setStatusFilter(value)}>\n              <SelectTrigger data-testid=\"select-status-filter\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Todos</SelectItem>\n                <SelectItem value=\"PENDING_APPROVAL\">Pendientes</SelectItem>\n                <SelectItem value=\"APPROVED\">Aprobados</SelectItem>\n                <SelectItem value=\"REJECTED\">Rechazados</SelectItem>\n                <SelectItem value=\"DRAFT\">Borradores</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Results */}\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            Podcasts ({filteredPodcasts.length})\n          </CardTitle>\n          <CardDescription>\n            {statusFilter === \"all\" ? \"Todos los podcasts\" : `Podcasts con estado: ${statusFilter}`}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {selectedIds.length > 0 && (\n            <div className=\"mb-4 flex items-center gap-2 flex-wrap\">\n              <span className=\"text-sm text-muted-foreground\">\n                {selectedIds.length} podcast(s) seleccionado(s)\n              </span>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={handleBulkApprove}\n                disabled={bulkUpdateStatusMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-approve\"\n              >\n                {bulkUpdateStatusMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <CheckCircle className=\"w-3 h-3 mr-1\" />\n                )}\n                Aprobar Seleccionados\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={handleBulkReject}\n                disabled={bulkUpdateStatusMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-reject\"\n              >\n                {bulkUpdateStatusMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <XCircle className=\"w-3 h-3 mr-1\" />\n                )}\n                Rechazar Seleccionados\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"destructive\"\n                onClick={handleBulkDelete}\n                disabled={bulkUpdateStatusMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-delete\"\n              >\n                {bulkDeleteMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <Trash2 className=\"w-3 h-3 mr-1\" />\n                )}\n                Eliminar Seleccionados\n              </Button>\n            </div>\n          )}\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead className=\"w-[50px]\">\n                  <Checkbox\n                    checked={filteredPodcasts && filteredPodcasts.length > 0 && selectedIds.length === filteredPodcasts.length}\n                    onCheckedChange={handleToggleAll}\n                    data-testid=\"checkbox-select-all\"\n                  />\n                </TableHead>\n                <TableHead>TÃ­tulo</TableHead>\n                <TableHead>Creador</TableHead>\n                <TableHead>Estado</TableHead>\n                <TableHead>Fecha CreaciÃ³n</TableHead>\n                <TableHead className=\"text-right\">Acciones</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {filteredPodcasts.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={6} className=\"text-center text-muted-foreground\">\n                    No se encontraron podcasts\n                  </TableCell>\n                </TableRow>\n              ) : (\n                filteredPodcasts.map((podcast) => (\n                  <TableRow key={podcast.id} data-testid={`row-podcast-${podcast.id}`}>\n                    <TableCell>\n                      <Checkbox\n                        checked={selectedIds.includes(podcast.id)}\n                        onCheckedChange={() => handleToggleSelection(podcast.id)}\n                        data-testid={`checkbox-podcast-${podcast.id}`}\n                      />\n                    </TableCell>\n                    <TableCell className=\"font-medium max-w-xs\" data-testid={`text-title-${podcast.id}`}>\n                      <div className=\"truncate\">{podcast.title}</div>\n                      {podcast.description && (\n                        <div className=\"text-xs text-muted-foreground truncate mt-1\">\n                          {podcast.description}\n                        </div>\n                      )}\n                    </TableCell>\n                    <TableCell data-testid={`text-owner-${podcast.id}`}>\n                      {podcast.owner?.username || \"Desconocido\"}\n                    </TableCell>\n                    <TableCell>{getStatusBadge(podcast.status)}</TableCell>\n                    <TableCell>\n                      {format(new Date(podcast.createdAt || Date.now()), \"dd/MM/yyyy\")}\n                    </TableCell>\n                    <TableCell className=\"text-right space-x-2\">\n                      {podcast.status !== \"APPROVED\" && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleApprove(podcast)}\n                          className=\"text-green-600 hover:text-green-700\"\n                          data-testid={`button-approve-${podcast.id}`}\n                        >\n                          <CheckCircle className=\"w-3 h-3 mr-1\" />\n                          Aprobar\n                        </Button>\n                      )}\n                      {podcast.status !== \"REJECTED\" && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleReject(podcast)}\n                          className=\"text-red-600 hover:text-red-700\"\n                          data-testid={`button-reject-${podcast.id}`}\n                        >\n                          <XCircle className=\"w-3 h-3 mr-1\" />\n                          Rechazar\n                        </Button>\n                      )}\n                      <Button\n                        size=\"sm\"\n                        variant=\"destructive\"\n                        onClick={() => handleDelete(podcast)}\n                        data-testid={`button-delete-${podcast.id}`}\n                      >\n                        <Trash2 className=\"w-3 h-3 mr-1\" />\n                        Eliminar\n                      </Button>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      {/* Confirmation Dialog */}\n      <AlertDialog \n        open={!!selectedPodcast && !!actionType} \n        onOpenChange={(open) => {\n          if (!updateStatusMutation.isPending && !deletePodcastMutation.isPending) {\n            if (!open) {\n              setSelectedPodcast(null);\n              setActionType(null);\n            }\n          }\n        }}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {actionType === \"approve\" && \"Aprobar Podcast\"}\n              {actionType === \"reject\" && \"Rechazar Podcast\"}\n              {actionType === \"delete\" && \"Eliminar Podcast\"}\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              {actionType === \"approve\" && (\n                <p>\n                  Â¿EstÃ¡s seguro de que deseas aprobar el podcast <strong>{selectedPodcast?.title}</strong>?\n                  SerÃ¡ visible para todos los usuarios.\n                </p>\n              )}\n              {actionType === \"reject\" && (\n                <p>\n                  Â¿EstÃ¡s seguro de que deseas rechazar el podcast <strong>{selectedPodcast?.title}</strong>?\n                  El creador podrÃ¡ verlo pero no serÃ¡ pÃºblico.\n                </p>\n              )}\n              {actionType === \"delete\" && (\n                <p className=\"text-red-600\">\n                  Â¿EstÃ¡s seguro de que deseas eliminar permanentemente el podcast <strong>{selectedPodcast?.title}</strong>?\n                  Esta acciÃ³n no se puede deshacer y tambiÃ©n eliminarÃ¡ todos sus episodios.\n                </p>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={updateStatusMutation.isPending || deletePodcastMutation.isPending}\n              data-testid=\"button-cancel-action\"\n            >\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmAction}\n              disabled={updateStatusMutation.isPending || deletePodcastMutation.isPending}\n              className={actionType === \"delete\" ? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\" : \"\"}\n              data-testid=\"button-confirm-action\"\n            >\n              {updateStatusMutation.isPending || deletePodcastMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Confirmar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Bulk Actions Confirmation Dialog */}\n      <AlertDialog \n        open={!!bulkAction} \n        onOpenChange={(open) => {\n          if (!bulkDeleteMutation.isPending && !bulkUpdateStatusMutation.isPending) {\n            if (!open) setBulkAction(null);\n          }\n        }}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {bulkAction === \"delete\" && \"Eliminar Podcasts\"}\n              {bulkAction === \"approve\" && \"Aprobar Podcasts\"}\n              {bulkAction === \"reject\" && \"Rechazar Podcasts\"}\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              {bulkAction === \"delete\" && (\n                <p className=\"text-red-600\">\n                  Â¿EstÃ¡s seguro de que deseas eliminar <strong>{selectedIds.length}</strong> podcast(s)? \n                  Esta acciÃ³n no se puede deshacer y tambiÃ©n eliminarÃ¡ todos sus episodios.\n                </p>\n              )}\n              {bulkAction === \"approve\" && (\n                <p>\n                  Â¿Deseas aprobar <strong>{selectedIds.length}</strong> podcast(s)?\n                  SerÃ¡n visibles para todos los usuarios.\n                </p>\n              )}\n              {bulkAction === \"reject\" && (\n                <p>\n                  Â¿Deseas rechazar <strong>{selectedIds.length}</strong> podcast(s)?\n                  Los creadores podrÃ¡n verlos pero no serÃ¡n pÃºblicos.\n                </p>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={bulkDeleteMutation.isPending || bulkUpdateStatusMutation.isPending}\n              data-testid=\"button-cancel-bulk-action\"\n            >\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmBulkAction}\n              disabled={bulkDeleteMutation.isPending || bulkUpdateStatusMutation.isPending}\n              className={bulkAction === \"delete\" ? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\" : \"\"}\n              data-testid=\"button-confirm-bulk-action\"\n            >\n              {bulkDeleteMutation.isPending || bulkUpdateStatusMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Confirmar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":23829,"size_tokens":null},"client/src/pages/admin-users.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, ShieldCheck, ShieldAlert, User, UserCheck, UserX, Trash2 } from \"lucide-react\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport type { User as UserType } from \"@shared/schema\";\n\nexport default function AdminUsers() {\n  const { toast } = useToast();\n  const [selectedUser, setSelectedUser] = useState<UserType | null>(null);\n  const [actionType, setActionType] = useState<\"role\" | \"approval\" | \"active\" | null>(null);\n  const [newRole, setNewRole] = useState<\"LISTENER\" | \"CREATOR\" | \"ADMIN\">(\"LISTENER\");\n  \n  // Bulk operations state\n  const [selectedIds, setSelectedIds] = useState<string[]>([]);\n  const [bulkAction, setBulkAction] = useState<\"delete\" | \"activate\" | \"deactivate\" | null>(null);\n\n  const { data: users, isLoading } = useQuery<UserType[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  // Reset selection when dataset changes (to avoid stale selections)\n  useEffect(() => {\n    if (users) {\n      setSelectedIds(prev => prev.filter(id => users.some(u => u.id === id)));\n    }\n  }, [users]);\n\n  const updateRoleMutation = useMutation({\n    mutationFn: async ({ userId, role }: { userId: string; role: string }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/users/${userId}/role`, { role });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      toast({\n        title: \"Rol actualizado\",\n        description: \"El rol del usuario ha sido actualizado correctamente.\",\n      });\n      setSelectedUser(null);\n      setActionType(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el rol del usuario.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleApprovalMutation = useMutation({\n    mutationFn: async ({ userId, requiresApproval }: { userId: string; requiresApproval: boolean }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/users/${userId}/requires-approval`, { requiresApproval });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      toast({\n        title: \"ConfiguraciÃ³n actualizada\",\n        description: \"La configuraciÃ³n de aprobaciÃ³n ha sido actualizada.\",\n      });\n      setSelectedUser(null);\n      setActionType(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar la configuraciÃ³n.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleActiveMutation = useMutation({\n    mutationFn: async ({ userId, isActive }: { userId: string; isActive: boolean }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/users/${userId}/active`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      toast({\n        title: \"Estado actualizado\",\n        description: \"El estado del usuario ha sido actualizado.\",\n      });\n      setSelectedUser(null);\n      setActionType(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el estado del usuario.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Bulk operations mutations\n  const bulkDeleteMutation = useMutation({\n    mutationFn: async (ids: string[]) => {\n      return await apiRequest(\"POST\", \"/api/admin/users/bulk-delete\", { ids });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      \n      // Show success message\n      toast({\n        title: \"OperaciÃ³n completada\",\n        description: data.message || `Se eliminaron ${data.successIds?.length || 0} usuario(s)`,\n      });\n      \n      // Show errors if any failures occurred\n      if (data.failed && data.failed.length > 0) {\n        const failedUsers = users?.filter(u => data.failed.some((f: any) => f.id === u.id)) || [];\n        const failedNames = failedUsers.map(u => u.username).join(\", \");\n        toast({\n          title: \"Algunos elementos fallaron\",\n          description: `Los siguientes usuarios no pudieron ser eliminados: ${failedNames}`,\n          variant: \"destructive\",\n        });\n      }\n      \n      // Only remove successful IDs from selection, keep failed ones for retry\n      setSelectedIds(prev => prev.filter(id => \n        !data.successIds?.includes(id)\n      ));\n      setBulkAction(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudieron eliminar los usuarios.\",\n        variant: \"destructive\",\n      });\n      setBulkAction(null);\n    },\n  });\n\n  const bulkUpdateActiveMutation = useMutation({\n    mutationFn: async ({ ids, isActive }: { ids: string[]; isActive: boolean }) => {\n      return await apiRequest(\"POST\", \"/api/admin/users/bulk-update-active\", { ids, isActive });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      \n      // Show success message\n      toast({\n        title: \"OperaciÃ³n completada\",\n        description: data.message || `Se actualizaron ${data.successIds?.length || 0} usuario(s)`,\n      });\n      \n      // Show errors if any failures occurred\n      if (data.failed && data.failed.length > 0) {\n        const failedUsers = users?.filter(u => data.failed.some((f: any) => f.id === u.id)) || [];\n        const failedNames = failedUsers.map(u => u.username).join(\", \");\n        toast({\n          title: \"Algunos elementos fallaron\",\n          description: `Los siguientes usuarios no pudieron ser actualizados: ${failedNames}`,\n          variant: \"destructive\",\n        });\n      }\n      \n      // Only remove successful IDs from selection, keep failed ones for retry\n      setSelectedIds(prev => prev.filter(id => \n        !data.successIds?.includes(id)\n      ));\n      setBulkAction(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudieron actualizar los estados.\",\n        variant: \"destructive\",\n      });\n      setBulkAction(null);\n    },\n  });\n\n  const handleRoleChange = (user: UserType) => {\n    setSelectedUser(user);\n    setNewRole(user.role);\n    setActionType(\"role\");\n  };\n\n  const handleToggleApproval = (user: UserType) => {\n    setSelectedUser(user);\n    setActionType(\"approval\");\n  };\n\n  const handleToggleActive = (user: UserType) => {\n    setSelectedUser(user);\n    setActionType(\"active\");\n  };\n\n  const confirmAction = () => {\n    if (!selectedUser) return;\n\n    if (actionType === \"role\") {\n      updateRoleMutation.mutate({ userId: selectedUser.id, role: newRole });\n    } else if (actionType === \"approval\") {\n      toggleApprovalMutation.mutate({\n        userId: selectedUser.id,\n        requiresApproval: !selectedUser.requiresApproval,\n      });\n    } else if (actionType === \"active\") {\n      toggleActiveMutation.mutate({\n        userId: selectedUser.id,\n        isActive: !selectedUser.isActive,\n      });\n    }\n  };\n\n  // Bulk action handlers\n  const handleToggleSelection = (userId: string) => {\n    setSelectedIds(prev => \n      prev.includes(userId) ? prev.filter(id => id !== userId) : [...prev, userId]\n    );\n  };\n\n  const handleToggleAll = () => {\n    if (!users) return;\n    if (selectedIds.length === users.length) {\n      setSelectedIds([]);\n    } else {\n      setSelectedIds(users.map(u => u.id));\n    }\n  };\n\n  const handleBulkDelete = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"delete\");\n  };\n\n  const handleBulkActivate = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"activate\");\n  };\n\n  const handleBulkDeactivate = () => {\n    if (selectedIds.length === 0) return;\n    setBulkAction(\"deactivate\");\n  };\n\n  const confirmBulkAction = () => {\n    if (selectedIds.length === 0) return;\n\n    if (bulkAction === \"delete\") {\n      bulkDeleteMutation.mutate(selectedIds);\n    } else if (bulkAction === \"activate\") {\n      bulkUpdateActiveMutation.mutate({ ids: selectedIds, isActive: true });\n    } else if (bulkAction === \"deactivate\") {\n      bulkUpdateActiveMutation.mutate({ ids: selectedIds, isActive: false });\n    }\n  };\n\n  const getRoleBadge = (role: string) => {\n    switch (role) {\n      case \"ADMIN\":\n        return <Badge variant=\"destructive\" data-testid={`badge-role-admin`}>Admin</Badge>;\n      case \"CREATOR\":\n        return <Badge variant=\"default\" data-testid={`badge-role-creator`}>Creador</Badge>;\n      case \"LISTENER\":\n        return <Badge variant=\"secondary\" data-testid={`badge-role-listener`}>Oyente</Badge>;\n      default:\n        return <Badge variant=\"outline\">{role}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6 flex justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 md:px-6 py-8 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold font-[Outfit]\">GestiÃ³n de Usuarios</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Administra roles, permisos y estado de los usuarios\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Todos los Usuarios ({users?.length || 0})</CardTitle>\n          <CardDescription>\n            Gestiona los roles y permisos de cada usuario\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {selectedIds.length > 0 && (\n            <div className=\"mb-4 flex items-center gap-2 flex-wrap\">\n              <span className=\"text-sm text-muted-foreground\">\n                {selectedIds.length} usuario(s) seleccionado(s)\n              </span>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={handleBulkActivate}\n                disabled={bulkUpdateActiveMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-activate\"\n              >\n                {bulkUpdateActiveMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <UserCheck className=\"w-3 h-3 mr-1\" />\n                )}\n                Activar Seleccionados\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={handleBulkDeactivate}\n                disabled={bulkUpdateActiveMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-deactivate\"\n              >\n                {bulkUpdateActiveMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <UserX className=\"w-3 h-3 mr-1\" />\n                )}\n                Desactivar Seleccionados\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"destructive\"\n                onClick={handleBulkDelete}\n                disabled={bulkUpdateActiveMutation.isPending || bulkDeleteMutation.isPending}\n                data-testid=\"button-bulk-delete\"\n              >\n                {bulkDeleteMutation.isPending ? (\n                  <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                ) : (\n                  <Trash2 className=\"w-3 h-3 mr-1\" />\n                )}\n                Eliminar Seleccionados\n              </Button>\n            </div>\n          )}\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead className=\"w-[50px]\">\n                  <Checkbox\n                    checked={users && users.length > 0 && selectedIds.length === users.length}\n                    onCheckedChange={handleToggleAll}\n                    data-testid=\"checkbox-select-all\"\n                  />\n                </TableHead>\n                <TableHead>Usuario</TableHead>\n                <TableHead>Email</TableHead>\n                <TableHead>Rol</TableHead>\n                <TableHead>Estado</TableHead>\n                <TableHead>Requiere AprobaciÃ³n</TableHead>\n                <TableHead className=\"text-right\">Acciones</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {users?.map((user) => (\n                <TableRow key={user.id} data-testid={`row-user-${user.id}`}>\n                  <TableCell>\n                    <Checkbox\n                      checked={selectedIds.includes(user.id)}\n                      onCheckedChange={() => handleToggleSelection(user.id)}\n                      data-testid={`checkbox-user-${user.id}`}\n                    />\n                  </TableCell>\n                  <TableCell className=\"font-medium\" data-testid={`text-username-${user.id}`}>\n                    {user.username}\n                  </TableCell>\n                  <TableCell data-testid={`text-email-${user.id}`}>{user.email}</TableCell>\n                  <TableCell>{getRoleBadge(user.role)}</TableCell>\n                  <TableCell>\n                    {user.isActive ? (\n                      <Badge variant=\"outline\" className=\"bg-green-500/10 text-green-600 border-green-500/20\" data-testid={`badge-active-${user.id}`}>\n                        <UserCheck className=\"w-3 h-3 mr-1\" />\n                        Activo\n                      </Badge>\n                    ) : (\n                      <Badge variant=\"outline\" className=\"bg-red-500/10 text-red-600 border-red-500/20\" data-testid={`badge-inactive-${user.id}`}>\n                        <UserX className=\"w-3 h-3 mr-1\" />\n                        Inactivo\n                      </Badge>\n                    )}\n                  </TableCell>\n                  <TableCell>\n                    {user.requiresApproval ? (\n                      <Badge variant=\"outline\" className=\"bg-yellow-500/10 text-yellow-600 border-yellow-500/20\" data-testid={`badge-requires-approval-${user.id}`}>\n                        <ShieldAlert className=\"w-3 h-3 mr-1\" />\n                        SÃ­\n                      </Badge>\n                    ) : (\n                      <Badge variant=\"outline\" className=\"bg-blue-500/10 text-blue-600 border-blue-500/20\" data-testid={`badge-auto-approve-${user.id}`}>\n                        <ShieldCheck className=\"w-3 h-3 mr-1\" />\n                        No\n                      </Badge>\n                    )}\n                  </TableCell>\n                  <TableCell className=\"text-right space-x-2\">\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => handleRoleChange(user)}\n                      data-testid={`button-change-role-${user.id}`}\n                    >\n                      <User className=\"w-3 h-3 mr-1\" />\n                      Cambiar Rol\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => handleToggleApproval(user)}\n                      data-testid={`button-toggle-approval-${user.id}`}\n                    >\n                      {user.requiresApproval ? <ShieldCheck className=\"w-3 h-3 mr-1\" /> : <ShieldAlert className=\"w-3 h-3 mr-1\" />}\n                      {user.requiresApproval ? \"Auto-aprobar\" : \"Requerir AprobaciÃ³n\"}\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant={user.isActive ? \"destructive\" : \"default\"}\n                      onClick={() => handleToggleActive(user)}\n                      data-testid={`button-toggle-active-${user.id}`}\n                    >\n                      {user.isActive ? <UserX className=\"w-3 h-3 mr-1\" /> : <UserCheck className=\"w-3 h-3 mr-1\" />}\n                      {user.isActive ? \"Desactivar\" : \"Activar\"}\n                    </Button>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      {/* Confirmation Dialog */}\n      <AlertDialog \n        open={!!selectedUser && !!actionType} \n        onOpenChange={(open) => {\n          // Prevent closing dialog during pending operations\n          if (!updateRoleMutation.isPending && !toggleApprovalMutation.isPending && !toggleActiveMutation.isPending) {\n            if (!open) {\n              setSelectedUser(null);\n              setActionType(null);\n            }\n          }\n        }}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {actionType === \"role\" && \"Cambiar Rol de Usuario\"}\n              {actionType === \"approval\" && \"Cambiar ConfiguraciÃ³n de AprobaciÃ³n\"}\n              {actionType === \"active\" && (selectedUser?.isActive ? \"Desactivar Usuario\" : \"Activar Usuario\")}\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              {actionType === \"role\" && (\n                <div className=\"space-y-4\">\n                  <p>\n                    EstÃ¡s a punto de cambiar el rol de <strong>{selectedUser?.username}</strong>.\n                  </p>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Nuevo Rol:</label>\n                    <Select value={newRole} onValueChange={(value: any) => setNewRole(value)}>\n                      <SelectTrigger data-testid=\"select-new-role\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"LISTENER\">Oyente</SelectItem>\n                        <SelectItem value=\"CREATOR\">Creador</SelectItem>\n                        <SelectItem value=\"ADMIN\">Administrador</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n              )}\n              {actionType === \"approval\" && (\n                <p>\n                  {selectedUser?.requiresApproval ? (\n                    <>\n                      El contenido de <strong>{selectedUser?.username}</strong> actualmente requiere aprobaciÃ³n manual.\n                      Â¿Deseas que su contenido se apruebe automÃ¡ticamente?\n                    </>\n                  ) : (\n                    <>\n                      El contenido de <strong>{selectedUser?.username}</strong> actualmente se aprueba automÃ¡ticamente.\n                      Â¿Deseas que su contenido requiera aprobaciÃ³n manual?\n                    </>\n                  )}\n                </p>\n              )}\n              {actionType === \"active\" && (\n                <p>\n                  {selectedUser?.isActive ? (\n                    <>\n                      Â¿EstÃ¡s seguro de que deseas desactivar a <strong>{selectedUser?.username}</strong>?\n                      No podrÃ¡n iniciar sesiÃ³n hasta que los reactives.\n                    </>\n                  ) : (\n                    <>\n                      Â¿Deseas reactivar la cuenta de <strong>{selectedUser?.username}</strong>?\n                    </>\n                  )}\n                </p>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={updateRoleMutation.isPending || toggleApprovalMutation.isPending || toggleActiveMutation.isPending}\n              data-testid=\"button-cancel-action\"\n            >\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmAction}\n              disabled={updateRoleMutation.isPending || toggleApprovalMutation.isPending || toggleActiveMutation.isPending}\n              data-testid=\"button-confirm-action\"\n            >\n              {updateRoleMutation.isPending || toggleApprovalMutation.isPending || toggleActiveMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Confirmar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Bulk Actions Confirmation Dialog */}\n      <AlertDialog \n        open={!!bulkAction} \n        onOpenChange={(open) => {\n          // Prevent closing dialog during pending operations\n          if (!bulkDeleteMutation.isPending && !bulkUpdateActiveMutation.isPending) {\n            if (!open) setBulkAction(null);\n          }\n        }}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {bulkAction === \"delete\" && \"Eliminar Usuarios\"}\n              {bulkAction === \"activate\" && \"Activar Usuarios\"}\n              {bulkAction === \"deactivate\" && \"Desactivar Usuarios\"}\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              {bulkAction === \"delete\" && (\n                <p>\n                  Â¿EstÃ¡s seguro de que deseas eliminar <strong>{selectedIds.length}</strong> usuario(s)? \n                  Esta acciÃ³n no se puede deshacer.\n                </p>\n              )}\n              {bulkAction === \"activate\" && (\n                <p>\n                  Â¿Deseas activar <strong>{selectedIds.length}</strong> usuario(s)?\n                </p>\n              )}\n              {bulkAction === \"deactivate\" && (\n                <p>\n                  Â¿Deseas desactivar <strong>{selectedIds.length}</strong> usuario(s)?\n                  No podrÃ¡n iniciar sesiÃ³n hasta que los reactives.\n                </p>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={bulkDeleteMutation.isPending || bulkUpdateActiveMutation.isPending}\n              data-testid=\"button-cancel-bulk-action\"\n            >\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmBulkAction}\n              disabled={bulkDeleteMutation.isPending || bulkUpdateActiveMutation.isPending}\n              data-testid=\"button-confirm-bulk-action\"\n            >\n              {bulkDeleteMutation.isPending || bulkUpdateActiveMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Confirmar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":23415,"size_tokens":null},"client/src/pages/admin-dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Users, BookOpen, Play, CheckCircle, Clock, XCircle, FileText } from \"lucide-react\";\nimport type { User, Audiobook, Chapter } from \"@shared/schema\";\n\nexport default function AdminDashboard() {\n  const { data: users, isLoading: loadingUsers } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  const { data: audiobooks, isLoading: loadingAudiobooks } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/admin/audiobooks\"],\n  });\n\n  const { data: chapters, isLoading: loadingChapters } = useQuery<Chapter[]>({\n    queryKey: [\"/api/admin/chapters\"],\n  });\n\n  const isLoading = loadingUsers || loadingAudiobooks || loadingChapters;\n\n  // Calculate statistics\n  const stats = {\n    totalUsers: users?.length || 0,\n    activeUsers: users?.filter(u => u.isActive).length || 0,\n    admins: users?.filter(u => u.role === \"ADMIN\").length || 0,\n    creators: users?.filter(u => u.role === \"CREATOR\").length || 0,\n    listeners: users?.filter(u => u.role === \"LISTENER\").length || 0,\n    totalAudiobooks: audiobooks?.length || 0,\n    publishedAudiobooks: audiobooks?.filter(a => a.isPublished).length || 0,\n    freeAudiobooks: audiobooks?.filter(a => a.isFree).length || 0,\n    totalChapters: chapters?.length || 0,\n    sampleChapters: chapters?.filter(c => c.isSample).length || 0,\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 md:px-6 py-8 space-y-6\">\n      <div>\n        <h1 className=\"font-serif text-3xl font-bold\">Panel de AdministraciÃ³n</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Vista general de Audivia y gestiÃ³n de contenido\n        </p>\n      </div>\n\n      {/* User Statistics */}\n      <div>\n        <h2 className=\"text-xl font-semibold mb-4\">Usuarios</h2>\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Usuarios</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <Skeleton className=\"h-8 w-20\" />\n              ) : (\n                <div className=\"text-2xl font-bold\">{stats.totalUsers}</div>\n              )}\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {stats.activeUsers} activos\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Administradores</CardTitle>\n              <Badge variant=\"destructive\" className=\"h-5 px-2\">ADMIN</Badge>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <Skeleton className=\"h-8 w-20\" />\n              ) : (\n                <div className=\"text-2xl font-bold\">{stats.admins}</div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Creadores</CardTitle>\n              <Badge className=\"h-5 px-2\">CREATOR</Badge>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <Skeleton className=\"h-8 w-20\" />\n              ) : (\n                <div className=\"text-2xl font-bold\">{stats.creators}</div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Oyentes</CardTitle>\n              <Badge variant=\"outline\" className=\"h-5 px-2\">USER</Badge>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <Skeleton className=\"h-8 w-20\" />\n              ) : (\n                <div className=\"text-2xl font-bold\">{stats.listeners}</div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Audiobook Statistics */}\n      <div>\n        <h2 className=\"text-xl font-semibold mb-4\">Audiolibros</h2>\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Audiolibros</CardTitle>\n              <BookOpen className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <Skeleton className=\"h-8 w-20\" />\n              ) : (\n                <div className=\"text-2xl font-bold\">{stats.totalAudiobooks}</div>\n              )}\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {stats.publishedAudiobooks} publicados\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Gratuitos</CardTitle>\n              <Badge className=\"bg-accent text-accent-foreground h-5 px-2\">FREE</Badge>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <Skeleton className=\"h-8 w-20\" />\n              ) : (\n                <div className=\"text-2xl font-bold\">{stats.freeAudiobooks}</div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Capitulos</CardTitle>\n              <Play className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <Skeleton className=\"h-8 w-20\" />\n              ) : (\n                <div className=\"text-2xl font-bold\">{stats.totalChapters}</div>\n              )}\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {stats.sampleChapters} muestras\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Estado</CardTitle>\n              <CheckCircle className=\"h-4 w-4 text-green-600\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-green-600\">Activo</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Plataforma funcionando correctamente\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7196,"size_tokens":null},"client/src/pages/profile.tsx":{"content":"import { useAuth } from \"@/components/auth-provider\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { User as UserIcon, Lock, Mail, Globe, UserCircle, Loader2, FileText, Download, Receipt } from \"lucide-react\";\nimport { Separator } from \"@/components/ui/separator\";\nimport type { User, Invoice } from \"@shared/schema\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\n\nconst profileSchema = z.object({\n  username: z.string().min(3, \"Username must be at least 3 characters\").max(50),\n  email: z.string().email(\"Invalid email address\"),\n  bio: z.string().max(500, \"Bio must be 500 characters or less\").optional(),\n  avatarUrl: z.string().url(\"Invalid URL\").optional().or(z.literal(\"\")),\n  website: z.string().url(\"Invalid URL\").optional().or(z.literal(\"\")),\n});\n\nconst passwordSchema = z.object({\n  currentPassword: z.string().min(1, \"Current password is required\"),\n  newPassword: z.string().min(8, \"New password must be at least 8 characters\"),\n  confirmPassword: z.string().min(1, \"Please confirm your new password\"),\n}).refine((data) => data.newPassword === data.confirmPassword, {\n  message: \"Passwords don't match\",\n  path: [\"confirmPassword\"],\n});\n\ntype ProfileFormData = z.infer<typeof profileSchema>;\ntype PasswordFormData = z.infer<typeof passwordSchema>;\n\nexport default function Profile() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: profile, isLoading } = useQuery<User>({\n    queryKey: [\"/api/profile\"],\n    enabled: !!user,\n  });\n\n  const { data: invoices = [], isLoading: isLoadingInvoices } = useQuery<Invoice[]>({\n    queryKey: [\"/api/my-invoices\"],\n    enabled: !!user,\n  });\n\n  const profileForm = useForm<ProfileFormData>({\n    resolver: zodResolver(profileSchema),\n    defaultValues: {\n      username: profile?.username || \"\",\n      email: profile?.email || \"\",\n      bio: profile?.bio || \"\",\n      avatarUrl: profile?.avatarUrl || \"\",\n      website: profile?.website || \"\",\n    },\n    values: profile ? {\n      username: profile.username,\n      email: profile.email,\n      bio: profile.bio || \"\",\n      avatarUrl: profile.avatarUrl || \"\",\n      website: profile.website || \"\",\n    } : undefined,\n  });\n\n  const passwordForm = useForm<PasswordFormData>({\n    resolver: zodResolver(passwordSchema),\n    defaultValues: {\n      currentPassword: \"\",\n      newPassword: \"\",\n      confirmPassword: \"\",\n    },\n  });\n\n  const updateProfileMutation = useMutation({\n    mutationFn: async (data: ProfileFormData) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/profile\"] });\n      toast({\n        title: \"Perfil actualizado\",\n        description: \"Tu perfil ha sido actualizado correctamente\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el perfil\",\n      });\n    },\n  });\n\n  const updatePasswordMutation = useMutation({\n    mutationFn: async (data: PasswordFormData) => {\n      return await apiRequest(\"POST\", \"/api/change-password\", {\n        currentPassword: data.currentPassword,\n        newPassword: data.newPassword,\n      });\n    },\n    onSuccess: () => {\n      passwordForm.reset();\n      toast({\n        title: \"ContraseÃ±a actualizada\",\n        description: \"Tu contraseÃ±a ha sido cambiada correctamente\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"No se pudo cambiar la contraseÃ±a\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return <div className=\"container mx-auto px-6 py-12\">Cargando...</div>;\n  }\n\n  return (\n    <div className=\"container mx-auto px-6 py-8 max-w-3xl\">\n      <h1 className=\"font-serif text-4xl font-bold mb-8\" data-testid=\"text-page-title\">\n        Mi Perfil\n      </h1>\n\n      {/* Profile Card */}\n      <Card className=\"mb-8\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <UserIcon className=\"w-5 h-5\" />\n            Informacion Personal\n          </CardTitle>\n          <CardDescription>\n            Actualiza tu informacion de perfil en Audivia\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...profileForm}>\n            <form onSubmit={profileForm.handleSubmit((data) => updateProfileMutation.mutate(data))} className=\"space-y-6\">\n              <FormField\n                control={profileForm.control}\n                name=\"username\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nombre de Usuario</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"Tu nombre de usuario\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={profileForm.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"flex items-center gap-2\">\n                      <Mail className=\"w-4 h-4\" />\n                      Email\n                    </FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"email\" placeholder=\"tu@email.com\" disabled />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={profileForm.control}\n                name=\"bio\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>BiografÃ­a</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} placeholder=\"CuÃ©ntanos sobre ti...\" rows={4} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={profileForm.control}\n                name=\"website\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"flex items-center gap-2\">\n                      <Globe className=\"w-4 h-4\" />\n                      Sitio Web\n                    </FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"url\" placeholder=\"https://ejemplo.com\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={profileForm.control}\n                name=\"avatarUrl\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>URL Avatar</FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"url\" placeholder=\"https://ejemplo.com/avatar.jpg\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                disabled={updateProfileMutation.isPending}\n                data-testid=\"button-save-profile\"\n              >\n                {updateProfileMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Guardando...\n                  </>\n                ) : (\n                  \"Guardar Cambios\"\n                )}\n              </Button>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n\n      <Separator className=\"my-8\" />\n\n      {/* Password Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Lock className=\"w-5 h-5\" />\n            Cambiar ContraseÃ±a\n          </CardTitle>\n          <CardDescription>\n            Actualiza tu contraseÃ±a para mantener tu cuenta segura\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...passwordForm}>\n            <form onSubmit={passwordForm.handleSubmit((data) => updatePasswordMutation.mutate(data))} className=\"space-y-6\">\n              <FormField\n                control={passwordForm.control}\n                name=\"currentPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>ContraseÃ±a Actual</FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"password\" placeholder=\"Tu contraseÃ±a actual\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={passwordForm.control}\n                name=\"newPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nueva ContraseÃ±a</FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"password\" placeholder=\"Nueva contraseÃ±a (mÃ­n. 8 caracteres)\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={passwordForm.control}\n                name=\"confirmPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Confirmar ContraseÃ±a</FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"password\" placeholder=\"Confirma tu nueva contraseÃ±a\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                variant=\"destructive\"\n                disabled={updatePasswordMutation.isPending}\n                data-testid=\"button-change-password\"\n              >\n                {updatePasswordMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Cambiando...\n                  </>\n                ) : (\n                  \"Cambiar ContraseÃ±a\"\n                )}\n              </Button>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n\n      <Separator className=\"my-8\" />\n\n      {/* Invoices Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Receipt className=\"w-5 h-5\" />\n            Mis Facturas\n          </CardTitle>\n          <CardDescription>\n            Historial de facturas de tus compras en Audivia\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoadingInvoices ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"w-6 h-6 animate-spin\" />\n            </div>\n          ) : invoices.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <FileText className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>No tienes facturas aun</p>\n              <p className=\"text-sm\">Las facturas apareceran aqui cuando realices compras</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Numero</TableHead>\n                    <TableHead>Fecha</TableHead>\n                    <TableHead>Total</TableHead>\n                    <TableHead>Estado</TableHead>\n                    <TableHead className=\"text-right\">Acciones</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {invoices.map((invoice) => (\n                    <TableRow key={invoice.id} data-testid={`row-invoice-${invoice.id}`}>\n                      <TableCell className=\"font-medium\">{invoice.invoiceNumber}</TableCell>\n                      <TableCell>\n                        {invoice.issueDate \n                          ? new Date(invoice.issueDate).toLocaleDateString(\"es-ES\")\n                          : \"-\"\n                        }\n                      </TableCell>\n                      <TableCell>\n                        {(invoice.totalCents / 100).toFixed(2)} {invoice.currency}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={invoice.status === \"paid\" ? \"default\" : \"secondary\"}>\n                          {invoice.status === \"paid\" ? \"Pagada\" : invoice.status === \"pending\" ? \"Pendiente\" : invoice.status}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        {invoice.pdfPath && (\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => window.open(`/api/invoices/${invoice.id}/download`, \"_blank\")}\n                            data-testid={`button-download-invoice-${invoice.id}`}\n                          >\n                            <Download className=\"w-4 h-4 mr-1\" />\n                            PDF\n                          </Button>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":14418,"size_tokens":null},"server/email.ts":{"content":"import nodemailer, { Transporter } from \"nodemailer\";\nimport type { EmailConfig, Invoice } from \"@shared/schema\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\n\nexport interface EmailService {\n  sendWelcomeEmail(to: string, username: string): Promise<void>;\n  sendPasswordResetEmail(to: string, username: string, resetUrl: string): Promise<void>;\n  sendEmailVerification(to: string, username: string, verificationUrl: string): Promise<void>;\n  sendContentApprovedEmail(to: string, username: string, contentType: string, contentTitle: string): Promise<void>;\n  sendContentRejectedEmail(to: string, username: string, contentType: string, contentTitle: string): Promise<void>;\n  sendSubscriptionNotification(to: string, username: string, podcastTitle: string): Promise<void>;\n  sendNewEpisodeNotification(to: string, username: string, podcastTitle: string, episodeTitle: string, episodeUrl: string): Promise<void>;\n  sendInvoiceEmail(to: string, username: string, invoice: Invoice, pdfPath: string | null): Promise<void>;\n  sendPurchaseConfirmation(to: string, username: string, audiobookTitle: string, invoiceNumber: string): Promise<void>;\n}\n\nconst BRAND_COLOR = \"#7C3AED\";\nconst BRAND_COLOR_LIGHT = \"#A78BFA\";\nconst BRAND_GOLD = \"#EAB308\";\nconst BRAND_NAME = \"Audivia\";\nconst LOGO_PATH = path.join(process.cwd(), \"attached_assets\", \"audivia-logo.png\");\n\nfunction getEmailTemplate(content: string, showFooterLinks: boolean = true): string {\n  return `\n<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${BRAND_NAME}</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #1a1a2e; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n  <table role=\"presentation\" style=\"width: 100%; border-collapse: collapse;\">\n    <tr>\n      <td style=\"padding: 40px 20px;\">\n        <table role=\"presentation\" style=\"max-width: 600px; margin: 0 auto; background-color: #16162a; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 24px rgba(124, 58, 237, 0.15);\">\n          <!-- Header with Logo -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg, ${BRAND_COLOR} 0%, #5B21B6 100%); padding: 30px 40px; text-align: center;\">\n              <img src=\"cid:audivia-logo\" alt=\"${BRAND_NAME}\" style=\"max-width: 180px; height: auto;\" />\n            </td>\n          </tr>\n          \n          <!-- Content -->\n          <tr>\n            <td style=\"padding: 40px; color: #e5e5e5;\">\n              ${content}\n            </td>\n          </tr>\n          \n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #0f0f1a; padding: 30px 40px; text-align: center; border-top: 1px solid #2a2a4a;\">\n              ${showFooterLinks ? `\n              <p style=\"margin: 0 0 15px 0;\">\n                <a href=\"/explore\" style=\"color: ${BRAND_COLOR_LIGHT}; text-decoration: none; margin: 0 10px;\">Explorar</a>\n                <span style=\"color: #4a4a6a;\">|</span>\n                <a href=\"/library\" style=\"color: ${BRAND_COLOR_LIGHT}; text-decoration: none; margin: 0 10px;\">Mi Biblioteca</a>\n                <span style=\"color: #4a4a6a;\">|</span>\n                <a href=\"/account\" style=\"color: ${BRAND_COLOR_LIGHT}; text-decoration: none; margin: 0 10px;\">Mi Cuenta</a>\n              </p>\n              ` : ''}\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0;\">\n                &copy; ${new Date().getFullYear()} ${BRAND_NAME}. Todos los derechos reservados.\n              </p>\n              <p style=\"color: #4b5563; font-size: 11px; margin: 10px 0 0 0;\">\n                Este es un correo automÃ¡tico, por favor no respondas directamente.\n              </p>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>\n  `;\n}\n\nfunction getButton(text: string, url: string): string {\n  return `\n    <a href=\"${url}\" style=\"display: inline-block; background: linear-gradient(135deg, ${BRAND_COLOR} 0%, #5B21B6 100%); color: white; padding: 14px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 14px rgba(124, 58, 237, 0.4); transition: all 0.3s ease;\">\n      ${text}\n    </a>\n  `;\n}\n\nfunction getSecondaryButton(text: string, url: string): string {\n  return `\n    <a href=\"${url}\" style=\"display: inline-block; background: transparent; color: ${BRAND_COLOR_LIGHT}; padding: 12px 28px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; border: 2px solid ${BRAND_COLOR};\">\n      ${text}\n    </a>\n  `;\n}\n\nfunction getInfoBox(content: string): string {\n  return `\n    <div style=\"background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(91, 33, 182, 0.1) 100%); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 12px; padding: 24px; margin: 24px 0;\">\n      ${content}\n    </div>\n  `;\n}\n\nfunction getGoldAccentBox(content: string): string {\n  return `\n    <div style=\"background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(202, 138, 4, 0.1) 100%); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 24px; margin: 24px 0; border-left: 4px solid ${BRAND_GOLD};\">\n      ${content}\n    </div>\n  `;\n}\n\nexport class NodemailerEmailService implements EmailService {\n  private transporter: Transporter | null = null;\n  private config: EmailConfig | null = null;\n\n  constructor(config?: EmailConfig) {\n    if (config) {\n      this.updateConfig(config);\n    }\n  }\n\n  updateConfig(config: EmailConfig): void {\n    this.config = config;\n    \n    this.transporter = nodemailer.createTransport({\n      host: config.smtpHost,\n      port: config.smtpPort,\n      secure: config.smtpSecure,\n      auth: {\n        user: config.smtpUser,\n        pass: config.smtpPassword,\n      },\n      connectionTimeout: 30000,\n      greetingTimeout: 30000,\n      socketTimeout: 60000,\n      tls: {\n        rejectUnauthorized: false,\n        minVersion: 'TLSv1.2',\n      },\n      debug: true,\n      logger: true,\n    });\n  }\n\n  private getLogoAttachment(): { filename: string; path: string; cid: string } | null {\n    if (fs.existsSync(LOGO_PATH)) {\n      return {\n        filename: \"audivia-logo.png\",\n        path: LOGO_PATH,\n        cid: \"audivia-logo\",\n      };\n    }\n    return null;\n  }\n\n  private async sendEmail(\n    to: string, \n    subject: string, \n    html: string, \n    additionalAttachments?: Array<{filename: string, path: string}>\n  ): Promise<void> {\n    if (!this.transporter || !this.config) {\n      throw new Error(\"Email service not configured. Please configure SMTP settings in admin panel.\");\n    }\n\n    if (!this.config.isActive) {\n      throw new Error(\"Email service is not active. Please activate it in admin panel.\");\n    }\n\n    const logoAttachment = this.getLogoAttachment();\n    const attachments = [\n      ...(logoAttachment ? [logoAttachment] : []),\n      ...(additionalAttachments || []),\n    ];\n\n    try {\n      await this.transporter.sendMail({\n        from: `\"${this.config.fromName}\" <${this.config.fromEmail}>`,\n        to,\n        subject,\n        html,\n        attachments,\n      });\n    } catch (error) {\n      console.error(\"Error sending email:\", error);\n      throw new Error(\"Failed to send email. Please check SMTP configuration.\");\n    }\n  }\n\n  async sendWelcomeEmail(to: string, username: string): Promise<void> {\n    const subject = `Â¡Bienvenido a ${BRAND_NAME}! Tu aventura sonora comienza`;\n    const content = `\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n        Â¡Hola, <span style=\"color: ${BRAND_GOLD};\">${username}</span>!\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Bienvenido a <strong style=\"color: ${BRAND_COLOR_LIGHT};\">${BRAND_NAME}</strong>, tu nueva plataforma de audiolibros premium. \n        Estamos encantados de tenerte con nosotros.\n      </p>\n      \n      ${getInfoBox(`\n        <h3 style=\"color: white; margin: 0 0 15px 0; font-size: 18px;\">Ahora puedes:</h3>\n        <ul style=\"margin: 0; padding-left: 20px; color: #d1d5db;\">\n          <li style=\"margin-bottom: 10px;\">Explorar nuestra colecciÃ³n exclusiva de audiolibros</li>\n          <li style=\"margin-bottom: 10px;\">Crear tu biblioteca personal de favoritos</li>\n          <li style=\"margin-bottom: 10px;\">Escuchar en cualquier momento y lugar</li>\n          <li style=\"margin-bottom: 0;\">Sincronizar tu progreso entre todos tus dispositivos</li>\n        </ul>\n      `)}\n      \n      <p style=\"text-align: center; margin: 32px 0;\">\n        ${getButton(\"Explorar Audiolibros\", \"/explore\")}\n      </p>\n      \n      <p style=\"font-size: 14px; color: #9ca3af; text-align: center;\">\n        Â¿Tienes alguna pregunta? Estamos aquÃ­ para ayudarte.\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content));\n  }\n\n  async sendPasswordResetEmail(to: string, username: string, resetUrl: string): Promise<void> {\n    const subject = `Recupera tu acceso a ${BRAND_NAME}`;\n    const content = `\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n        RecuperaciÃ³n de contraseÃ±a\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Recibimos una solicitud para restablecer la contraseÃ±a de tu cuenta en ${BRAND_NAME}.\n      </p>\n      \n      <p style=\"text-align: center; margin: 32px 0;\">\n        ${getButton(\"Restablecer ContraseÃ±a\", resetUrl)}\n      </p>\n      \n      ${getInfoBox(`\n        <p style=\"margin: 0; color: #d1d5db; font-size: 14px;\">\n          <strong style=\"color: ${BRAND_GOLD};\">Importante:</strong> Este enlace expirarÃ¡ en <strong>1 hora</strong>.\n        </p>\n      `)}\n      \n      <p style=\"font-size: 14px; color: #9ca3af;\">\n        Si no solicitaste este cambio, puedes ignorar este correo de forma segura. \n        Tu contraseÃ±a actual seguirÃ¡ siendo vÃ¡lida.\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content, false));\n  }\n\n  async sendEmailVerification(to: string, username: string, verificationUrl: string): Promise<void> {\n    const subject = `Verifica tu cuenta en ${BRAND_NAME}`;\n    const content = `\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n        Verifica tu email\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Gracias por registrarte en <strong style=\"color: ${BRAND_COLOR_LIGHT};\">${BRAND_NAME}</strong>. \n        Para completar tu registro y acceder a todos los beneficios, necesitamos verificar tu direcciÃ³n de email.\n      </p>\n      \n      <p style=\"text-align: center; margin: 32px 0;\">\n        ${getButton(\"Verificar mi Email\", verificationUrl)}\n      </p>\n      \n      ${getInfoBox(`\n        <p style=\"margin: 0; color: #d1d5db; font-size: 14px;\">\n          Este enlace expirarÃ¡ en <strong style=\"color: ${BRAND_GOLD};\">24 horas</strong>.\n        </p>\n      `)}\n      \n      <p style=\"font-size: 14px; color: #9ca3af;\">\n        Si no creaste esta cuenta, puedes ignorar este correo.\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content, false));\n  }\n\n  async sendContentApprovedEmail(to: string, username: string, contentType: string, contentTitle: string): Promise<void> {\n    const subject = `Â¡Tu ${contentType} ha sido aprobado! - ${BRAND_NAME}`;\n    const content = `\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <span style=\"font-size: 48px;\">&#127881;</span>\n      </div>\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n        Â¡Contenido Aprobado!\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      \n      ${getGoldAccentBox(`\n        <p style=\"margin: 0; color: #d1d5db;\">\n          Tu ${contentType} <strong style=\"color: white;\">\"${contentTitle}\"</strong> ha sido aprobado \n          y ahora estÃ¡ disponible para todos los usuarios de ${BRAND_NAME}.\n        </p>\n      `)}\n      \n      <p style=\"font-size: 16px; line-height: 1.6;\">\n        Â¡Felicitaciones por tu excelente trabajo!\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content));\n  }\n\n  async sendContentRejectedEmail(to: string, username: string, contentType: string, contentTitle: string): Promise<void> {\n    const subject = `ActualizaciÃ³n sobre tu ${contentType} - ${BRAND_NAME}`;\n    const content = `\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n        ActualizaciÃ³n de Contenido\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      \n      ${getInfoBox(`\n        <p style=\"margin: 0; color: #d1d5db;\">\n          Tu ${contentType} <strong style=\"color: white;\">\"${contentTitle}\"</strong> no ha podido ser aprobado en esta ocasiÃ³n.\n        </p>\n      `)}\n      \n      <p style=\"font-size: 16px; line-height: 1.6;\">\n        Por favor, revisa que cumpla con nuestras polÃ­ticas de contenido y vuelve a intentarlo. \n        Si tienes alguna duda, no dudes en contactar con nuestro equipo de soporte.\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content));\n  }\n\n  async sendSubscriptionNotification(to: string, username: string, podcastTitle: string): Promise<void> {\n    const subject = `Â¡Nueva suscripciÃ³n activada! - ${BRAND_NAME}`;\n    const content = `\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <span style=\"font-size: 48px;\">&#127911;</span>\n      </div>\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n        Â¡Nueva SuscripciÃ³n!\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      \n      ${getGoldAccentBox(`\n        <p style=\"margin: 0; color: #d1d5db;\">\n          Te has suscrito exitosamente a <strong style=\"color: white;\">\"${podcastTitle}\"</strong>.\n        </p>\n      `)}\n      \n      <p style=\"font-size: 16px; line-height: 1.6;\">\n        RecibirÃ¡s notificaciones cuando haya nuevo contenido disponible.\n      </p>\n      \n      <p style=\"text-align: center; margin: 32px 0;\">\n        ${getButton(\"Ver Contenido\", \"/library\")}\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content));\n  }\n\n  async sendNewEpisodeNotification(to: string, username: string, podcastTitle: string, episodeTitle: string, episodeUrl: string): Promise<void> {\n    const subject = `Nuevo capÃ­tulo: ${episodeTitle} - ${BRAND_NAME}`;\n    const content = `\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <span style=\"font-size: 48px;\">&#127926;</span>\n      </div>\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n        Â¡Nuevo CapÃ­tulo Disponible!\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hay un nuevo capÃ­tulo disponible en uno de tus audiolibros:\n      </p>\n      \n      ${getGoldAccentBox(`\n        <h3 style=\"color: white; margin: 0 0 8px 0; font-size: 18px;\">${podcastTitle}</h3>\n        <p style=\"color: ${BRAND_COLOR_LIGHT}; margin: 0; font-size: 16px; font-weight: 600;\">${episodeTitle}</p>\n      `)}\n      \n      <p style=\"text-align: center; margin: 32px 0;\">\n        ${getButton(\"Escuchar Ahora\", episodeUrl)}\n      </p>\n      \n      <p style=\"font-size: 14px; color: #9ca3af; text-align: center;\">\n        Â¡Disfruta del nuevo contenido!\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content));\n  }\n\n  async sendInvoiceEmail(to: string, username: string, invoice: Invoice, pdfPath: string | null): Promise<void> {\n    const subject = `Factura ${invoice.invoiceNumber} - ${BRAND_NAME}`;\n    const formattedTotal = new Intl.NumberFormat(\"es-ES\", {\n      style: \"currency\",\n      currency: invoice.currency,\n    }).format(invoice.totalCents / 100);\n\n    const additionalAttachments = pdfPath && fs.existsSync(pdfPath) ? [{\n      filename: `factura-${invoice.invoiceNumber}.pdf`,\n      path: pdfPath,\n    }] : [];\n\n    const content = `\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n        Factura ${invoice.invoiceNumber}\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Adjuntamos la factura correspondiente a tu ${invoice.type === 'PURCHASE' ? 'compra' : 'suscripciÃ³n'}.\n      </p>\n      \n      ${getInfoBox(`\n        <table style=\"width: 100%; border-collapse: collapse;\">\n          <tr>\n            <td style=\"padding: 12px 0; color: #9ca3af; font-size: 14px;\">NÃºmero de factura:</td>\n            <td style=\"padding: 12px 0; text-align: right; color: white; font-weight: 600;\">${invoice.invoiceNumber}</td>\n          </tr>\n          <tr>\n            <td style=\"padding: 12px 0; color: #9ca3af; font-size: 14px; border-top: 1px solid rgba(124, 58, 237, 0.2);\">Fecha de emisiÃ³n:</td>\n            <td style=\"padding: 12px 0; text-align: right; color: #d1d5db; border-top: 1px solid rgba(124, 58, 237, 0.2);\">${new Date(invoice.issueDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</td>\n          </tr>\n          <tr>\n            <td style=\"padding: 12px 0; color: #9ca3af; font-size: 14px; border-top: 1px solid rgba(124, 58, 237, 0.2);\">Total:</td>\n            <td style=\"padding: 12px 0; text-align: right; color: ${BRAND_GOLD}; font-weight: 700; font-size: 24px; border-top: 1px solid rgba(124, 58, 237, 0.2);\">${formattedTotal}</td>\n          </tr>\n        </table>\n      `)}\n\n      ${additionalAttachments.length > 0 \n        ? `<p style=\"font-size: 16px; line-height: 1.6; text-align: center; color: #d1d5db;\">\n            EncontrarÃ¡s el PDF de la factura adjunto a este correo.\n          </p>` \n        : `<p style=\"text-align: center; margin: 24px 0;\">\n            ${getSecondaryButton(\"Descargar Factura\", \"/account/invoices\")}\n          </p>`\n      }\n      \n      <p style=\"font-size: 14px; color: #9ca3af; margin-top: 32px;\">\n        Gracias por tu confianza en <strong style=\"color: ${BRAND_COLOR_LIGHT};\">${BRAND_NAME}</strong>.\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content), additionalAttachments);\n  }\n\n  async sendPurchaseConfirmation(to: string, username: string, audiobookTitle: string, invoiceNumber: string): Promise<void> {\n    const subject = `Â¡Compra confirmada! ${audiobookTitle} - ${BRAND_NAME}`;\n    const content = `\n      <div style=\"text-align: center; margin-bottom: 24px;\">\n        <span style=\"font-size: 48px;\">&#128214;</span>\n      </div>\n      <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n        Â¡Compra Confirmada!\n      </h1>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Hola <strong style=\"color: ${BRAND_GOLD};\">${username}</strong>,\n      </p>\n      <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n        Tu compra se ha realizado con Ã©xito. Ya puedes disfrutar de tu nuevo audiolibro.\n      </p>\n      \n      ${getGoldAccentBox(`\n        <h3 style=\"color: white; margin: 0 0 8px 0; font-size: 20px;\">${audiobookTitle}</h3>\n        <p style=\"color: #9ca3af; margin: 0; font-size: 14px;\">Referencia: ${invoiceNumber}</p>\n      `)}\n      \n      <p style=\"text-align: center; margin: 32px 0;\">\n        ${getButton(\"Ir a Mi Biblioteca\", \"/library\")}\n      </p>\n      \n      <p style=\"font-size: 14px; color: #9ca3af; text-align: center;\">\n        ${invoiceNumber.startsWith('AUD-') \n          ? 'RecibirÃ¡s la factura en un correo separado.' \n          : 'Si deseas factura, configura tu perfil de facturaciÃ³n en tu cuenta.'\n        }\n      </p>\n    `;\n    await this.sendEmail(to, subject, getEmailTemplate(content));\n  }\n}\n\nexport class MockEmailService implements EmailService {\n  async sendWelcomeEmail(to: string, username: string): Promise<void> {\n    console.log(`[MOCK EMAIL] Welcome email to ${to} (${username})`);\n  }\n\n  async sendPasswordResetEmail(to: string, username: string, resetUrl: string): Promise<void> {\n    console.log(`[MOCK EMAIL] Password reset to ${to} (${username}): ${resetUrl}`);\n  }\n\n  async sendEmailVerification(to: string, username: string, verificationUrl: string): Promise<void> {\n    console.log(`[MOCK EMAIL] Email verification to ${to} (${username}): ${verificationUrl}`);\n  }\n\n  async sendContentApprovedEmail(to: string, username: string, contentType: string, contentTitle: string): Promise<void> {\n    console.log(`[MOCK EMAIL] Content approved to ${to} (${username}): ${contentType} \"${contentTitle}\"`);\n  }\n\n  async sendContentRejectedEmail(to: string, username: string, contentType: string, contentTitle: string): Promise<void> {\n    console.log(`[MOCK EMAIL] Content rejected to ${to} (${username}): ${contentType} \"${contentTitle}\"`);\n  }\n\n  async sendSubscriptionNotification(to: string, username: string, podcastTitle: string): Promise<void> {\n    console.log(`[MOCK EMAIL] Subscription notification to ${to} (${username}): \"${podcastTitle}\"`);\n  }\n\n  async sendNewEpisodeNotification(to: string, username: string, podcastTitle: string, episodeTitle: string, episodeUrl: string): Promise<void> {\n    console.log(`[MOCK EMAIL] New episode notification to ${to} (${username}): \"${episodeTitle}\" from \"${podcastTitle}\" - ${episodeUrl}`);\n  }\n\n  async sendInvoiceEmail(to: string, username: string, invoice: Invoice, pdfPath: string | null): Promise<void> {\n    console.log(`[MOCK EMAIL] Invoice ${invoice.invoiceNumber} to ${to} (${username}), PDF: ${pdfPath}`);\n  }\n\n  async sendPurchaseConfirmation(to: string, username: string, audiobookTitle: string, invoiceNumber: string): Promise<void> {\n    console.log(`[MOCK EMAIL] Purchase confirmation to ${to} (${username}): \"${audiobookTitle}\" - Invoice: ${invoiceNumber}`);\n  }\n}\n\n// Helper function to get the appropriate email service\nimport type { IStorage } from \"./storage\";\n\nexport async function getEmailService(storage: IStorage): Promise<EmailService> {\n  const config = await storage.getActiveEmailConfig();\n  \n  if (config && config.isActive) {\n    return new NodemailerEmailService(config);\n  }\n  \n  // Fallback to mock service if no config or inactive\n  return new MockEmailService();\n}\n","path":null,"size_bytes":23176,"size_tokens":null},"client/src/pages/admin-email-config.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Mail, Server, Lock, CheckCircle, AlertCircle, ExternalLink, Eye, FileText, X } from \"lucide-react\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport type { EmailConfig } from \"@shared/schema\";\n\ninterface TemplatePreview {\n  id: string;\n  name: string;\n  description: string;\n  html: string;\n}\n\nconst emailConfigSchema = z.object({\n  smtpHost: z.string().min(1, \"SMTP host es requerido\"),\n  smtpPort: z.number().int().min(1).max(65535, \"Puerto debe estar entre 1 y 65535\"),\n  smtpUser: z.string().min(1, \"Usuario SMTP es requerido\"),\n  smtpPassword: z.string().optional(),\n  smtpSecure: z.boolean(),\n  fromEmail: z.string().email(\"Email invÃ¡lido\"),\n  fromName: z.string().min(1, \"Nombre del remitente es requerido\"),\n});\n\ntype EmailConfigFormData = z.infer<typeof emailConfigSchema>;\n\nexport default function AdminEmailConfig() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [selectedTemplate, setSelectedTemplate] = useState<TemplatePreview | null>(null);\n\n  const { data: config, isLoading } = useQuery<EmailConfig[], Error, EmailConfig | null>({\n    queryKey: [\"/api/admin/email-config\"],\n    select: (data) => data && data.length > 0 ? data[0] : null,\n  });\n\n  const { data: templates, isLoading: templatesLoading } = useQuery<TemplatePreview[]>({\n    queryKey: [\"/api/admin/email-templates\"],\n  });\n\n  const form = useForm<EmailConfigFormData>({\n    resolver: zodResolver(emailConfigSchema),\n    defaultValues: {\n      smtpHost: \"\",\n      smtpPort: 587,\n      smtpUser: \"\",\n      smtpPassword: \"\",\n      smtpSecure: false,\n      fromEmail: \"\",\n      fromName: \"Audivia\",\n    },\n  });\n\n  useEffect(() => {\n    if (config) {\n      form.reset({\n        smtpHost: config.smtpHost,\n        smtpPort: config.smtpPort,\n        smtpUser: config.smtpUser,\n        smtpPassword: \"\",\n        smtpSecure: config.smtpSecure,\n        fromEmail: config.fromEmail,\n        fromName: config.fromName,\n      });\n    }\n  }, [config]);\n\n  const updateConfigMutation = useMutation({\n    mutationFn: async (data: EmailConfigFormData) => {\n      // Remove password from request if it's empty (when editing)\n      const payload = { ...data };\n      if (config && (!payload.smtpPassword || payload.smtpPassword === \"\")) {\n        delete payload.smtpPassword;\n      }\n      \n      // Validate password is present when creating\n      if (!config && !payload.smtpPassword) {\n        throw new Error(\"ContraseÃ±a SMTP es requerida al crear una nueva configuraciÃ³n\");\n      }\n\n      if (config) {\n        // Update existing config\n        return await apiRequest(\"PATCH\", \"/api/admin/email-config\", payload);\n      } else {\n        // Create new config\n        return await apiRequest(\"POST\", \"/api/admin/email-config\", payload);\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/email-config\"] });\n      toast({\n        title: \"ConfiguraciÃ³n guardada\",\n        description: \"La configuraciÃ³n de email ha sido actualizada exitosamente.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"No se pudo guardar la configuraciÃ³n\",\n      });\n    },\n  });\n\n  const testEmailMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/admin/email-config/test\", {});\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Email de prueba enviado\",\n        description: \"Verifica tu bandeja de entrada.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error al enviar email de prueba\",\n        description: error.message || \"No se pudo enviar el email de prueba\",\n      });\n    },\n  });\n\n  const onSubmit = (data: EmailConfigFormData) => {\n    updateConfigMutation.mutate(data);\n  };\n\n  const handleTestEmail = () => {\n    testEmailMutation.mutate();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container max-w-4xl mx-auto px-4 md:px-6 py-8\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 w-64 bg-muted rounded\"></div>\n          <div className=\"h-96 bg-muted rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container max-w-4xl mx-auto px-4 md:px-6 py-8\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n          <Mail className=\"h-8 w-8\" />\n          ConfiguraciÃ³n de Email\n        </h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Configura el servidor SMTP para el envÃ­o de emails de notificaciÃ³n\n        </p>\n      </div>\n\n      {!config && (\n        <Alert className=\"mb-6\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>No hay configuraciÃ³n</AlertTitle>\n          <AlertDescription>\n            No se ha configurado un servidor SMTP. Completa el formulario para habilitar el envÃ­o de emails.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      {config && (\n        <Alert className=\"mb-6\">\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>ConfiguraciÃ³n activa</AlertTitle>\n          <AlertDescription>\n            El servidor SMTP estÃ¡ configurado. Puedes enviar un email de prueba para verificar la configuraciÃ³n.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Server className=\"h-5 w-5\" />\n            ConfiguraciÃ³n del Servidor SMTP\n          </CardTitle>\n          <CardDescription>\n            Ingresa los datos de tu servidor SMTP para enviar emails de notificaciÃ³n\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <FormField\n                  control={form.control}\n                  name=\"smtpHost\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Servidor SMTP</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          placeholder=\"smtp.buzondecorreo.com\"\n                          data-testid=\"input-smtp-host\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"smtpPort\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Puerto</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          placeholder=\"465\"\n                          value={field.value || \"\"}\n                          onChange={(e) => {\n                            const val = e.target.value;\n                            field.onChange(val === \"\" ? 587 : parseInt(val, 10) || 587);\n                          }}\n                          onBlur={field.onBlur}\n                          name={field.name}\n                          ref={field.ref}\n                          data-testid=\"input-smtp-port\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"smtpUser\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Usuario SMTP</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        placeholder=\"tu@email.com\"\n                        data-testid=\"input-smtp-user\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"smtpPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>ContraseÃ±a SMTP</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Lock className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\n                        <Input\n                          {...field}\n                          type=\"password\"\n                          className=\"pl-10\"\n                          placeholder={config ? \"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\" : \"ContraseÃ±a SMTP\"}\n                          data-testid=\"input-smtp-password\"\n                        />\n                      </div>\n                    </FormControl>\n                    <FormDescription>\n                      {config && \"Deja en blanco para mantener la contraseÃ±a actual\"}\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"smtpSecure\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">SSL/TLS</FormLabel>\n                      <FormDescription>\n                        Usar conexiÃ³n segura (recomendado para puerto 465)\n                      </FormDescription>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-smtp-secure\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <FormField\n                  control={form.control}\n                  name=\"fromEmail\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email del Remitente</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          type=\"email\"\n                          placeholder=\"noreply@audivia.com\"\n                          data-testid=\"input-from-email\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"fromName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nombre del Remitente</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          placeholder=\"Audivia\"\n                          data-testid=\"input-from-name\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"flex justify-between gap-4 pt-4\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={handleTestEmail}\n                  disabled={!config || testEmailMutation.isPending}\n                  data-testid=\"button-test-email\"\n                >\n                  {testEmailMutation.isPending ? \"Enviando...\" : \"Enviar Email de Prueba\"}\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={updateConfigMutation.isPending}\n                  data-testid=\"button-save-config\"\n                >\n                  {updateConfigMutation.isPending ? \"Guardando...\" : \"Guardar ConfiguraciÃ³n\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mt-6\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <ExternalLink className=\"h-5 w-5\" />\n            Acceso al Webmail\n          </CardTitle>\n          <CardDescription>\n            Accede directamente a tu bandeja de entrada\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Button\n            variant=\"outline\"\n            className=\"w-full\"\n            onClick={() => window.open(\"https://correo.piensasolutions.com/?_task=mail&_mbox=INBOX\", \"_blank\")}\n            data-testid=\"button-open-webmail\"\n          >\n            <Mail className=\"mr-2 h-4 w-4\" />\n            Abrir Webmail\n          </Button>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mt-6\">\n        <CardHeader>\n          <CardTitle>ConfiguraciÃ³n Recomendada</CardTitle>\n          <CardDescription>\n            Datos de configuraciÃ³n para tu servidor de correo\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <div className=\"grid gap-2 p-4 border rounded-lg bg-primary/5\">\n              <h3 className=\"font-semibold\">BuzÃ³n de Correo (Recomendado)</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Servidor SMTP: smtp.buzondecorreo.com | Puerto: 465 | SSL/TLS: SÃ­\n              </p>\n              <p className=\"text-sm text-muted-foreground\">\n                Servidor IMAP: imap.buzondecorreo.com | Puerto: 993 | SSL/TLS: SÃ­\n              </p>\n              <p className=\"text-xs text-muted-foreground\">\n                El nombre de usuario es tu direcciÃ³n de correo electrÃ³nico completa\n              </p>\n            </div>\n            <div className=\"grid gap-2 p-4 border rounded-lg\">\n              <h3 className=\"font-semibold\">Gmail</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Servidor: smtp.gmail.com | Puerto: 587 | SSL/TLS: No\n              </p>\n              <p className=\"text-xs text-muted-foreground\">\n                Nota: Debes generar una contraseÃ±a de aplicaciÃ³n en tu cuenta de Google\n              </p>\n            </div>\n            <div className=\"grid gap-2 p-4 border rounded-lg\">\n              <h3 className=\"font-semibold\">Office 365 / Outlook</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Servidor: smtp.office365.com | Puerto: 587 | SSL/TLS: No\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mt-6\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5\" />\n            Plantillas de Email\n          </CardTitle>\n          <CardDescription>\n            Previsualiza las plantillas de email que se envÃ­an a los usuarios\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {templatesLoading ? (\n            <div className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-3\">\n              {[1, 2, 3, 4, 5, 6].map((i) => (\n                <div key={i} className=\"h-24 bg-muted rounded-lg animate-pulse\" />\n              ))}\n            </div>\n          ) : (\n            <div className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-3\">\n              {templates?.map((template) => (\n                <button\n                  key={template.id}\n                  onClick={() => setSelectedTemplate(template)}\n                  className=\"text-left p-4 border rounded-lg hover-elevate transition-all\"\n                  data-testid={`button-template-${template.id}`}\n                >\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Mail className=\"h-4 w-4 text-primary\" />\n                    <span className=\"font-medium\">{template.name}</span>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                    {template.description}\n                  </p>\n                  <div className=\"flex items-center gap-1 mt-2 text-xs text-primary\">\n                    <Eye className=\"h-3 w-3\" />\n                    <span>Ver plantilla</span>\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!selectedTemplate} onOpenChange={() => setSelectedTemplate(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] p-0 overflow-hidden\">\n          <DialogHeader className=\"p-6 pb-0\">\n            <div className=\"flex items-center justify-between\">\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Mail className=\"h-5 w-5\" />\n                {selectedTemplate?.name}\n              </DialogTitle>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">{selectedTemplate?.description}</p>\n          </DialogHeader>\n          <ScrollArea className=\"h-[70vh] p-6 pt-4\">\n            {selectedTemplate && (\n              <div \n                className=\"border rounded-lg overflow-hidden\"\n                style={{ backgroundColor: \"#1a1a2e\" }}\n              >\n                <iframe\n                  srcDoc={selectedTemplate.html}\n                  className=\"w-full h-[600px] border-0\"\n                  title={`Preview: ${selectedTemplate.name}`}\n                  data-testid=\"iframe-template-preview\"\n                />\n              </div>\n            )}\n          </ScrollArea>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":18825,"size_tokens":null},"server/storage-service.ts":{"content":"import { MediaAsset, InsertMediaAsset } from \"@shared/schema\";\nimport path from \"path\";\nimport crypto from \"crypto\";\nimport fs from \"fs/promises\";\nimport { drive_v3, google } from \"googleapis\";\nimport type { Readable } from \"stream\";\nimport { Readable as ReadableStream } from \"stream\";\n\n// Lightweight upload metadata (no id/createdAt - those are generated by DB)\nexport interface UploadMetadata {\n  ownerId: string;\n  podcastId: string | null;\n  episodeId: string | null;\n  type: \"COVER_ART\" | \"EPISODE_AUDIO\";\n  storageProvider: \"LOCAL\" | \"GOOGLE_DRIVE\";\n  storageKey: string;\n  publicUrl: string | null;\n  mimeType: string;\n  sizeBytes: number;\n  checksum: string | null;\n  visibility: string;\n  status: \"DRAFT\" | \"PENDING_APPROVAL\" | \"APPROVED\" | \"REJECTED\";\n}\n\n// Storage adapter interface\nexport interface StorageAdapter {\n  saveCoverArt(file: Express.Multer.File, ownerId: string, podcastId?: string): Promise<UploadMetadata>;\n  saveEpisodeAudio(file: Express.Multer.File, ownerId: string, episodeId?: string, podcastId?: string): Promise<UploadMetadata>;\n  getPublicUrl(asset: MediaAsset): string;\n  getSignedUrl(asset: MediaAsset, expiresInSeconds?: number): Promise<string>;\n  deleteAssetByKey(storageKey: string): Promise<void>;\n  streamAsset(asset: MediaAsset): Promise<Readable>;\n}\n\n// Local storage adapter - stores files in uploads/ directory organized by audiobook title\nexport class LocalStorageAdapter implements StorageAdapter {\n  private uploadsDir = path.join(process.cwd(), \"uploads\");\n  private audiobookTitle?: string;\n\n  constructor(audiobookTitle?: string) {\n    this.audiobookTitle = audiobookTitle;\n  }\n\n  // Sanitize title to create safe folder name\n  private sanitizeFolderName(title: string): string {\n    return title\n      .toLowerCase()\n      .normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\") // Remove accents\n      .replace(/[^a-z0-9\\s-]/g, \"\") // Remove special chars\n      .replace(/\\s+/g, \"-\") // Replace spaces with hyphens\n      .replace(/-+/g, \"-\") // Remove multiple hyphens\n      .substring(0, 50) // Limit length\n      .replace(/^-|-$/g, \"\"); // Remove leading/trailing hyphens\n  }\n\n  private getBasePath(): string {\n    if (this.audiobookTitle) {\n      const folderName = this.sanitizeFolderName(this.audiobookTitle);\n      return `audiobooks/${folderName}`;\n    }\n    return \"uploads\";\n  }\n\n  async saveCoverArt(file: Express.Multer.File, ownerId: string, podcastId?: string): Promise<UploadMetadata> {\n    const basePath = this.getBasePath();\n    const ext = path.extname(file.originalname).toLowerCase() || \".jpg\";\n    const timestamp = Date.now();\n    const uniqueId = crypto.randomBytes(4).toString(\"hex\");\n    const filename = `cover-${timestamp}-${uniqueId}${ext}`;\n    const storagePath = `${basePath}/${filename}`;\n    const fullPath = path.join(this.uploadsDir, storagePath);\n\n    // Ensure directory exists\n    await fs.mkdir(path.dirname(fullPath), { recursive: true });\n\n    // Move file to destination\n    await fs.writeFile(fullPath, file.buffer);\n\n    // Calculate checksum\n    const checksum = crypto.createHash(\"md5\").update(file.buffer).digest(\"hex\");\n\n    return {\n      ownerId,\n      podcastId: podcastId || null,\n      episodeId: null,\n      type: \"COVER_ART\",\n      storageProvider: \"LOCAL\",\n      storageKey: storagePath,\n      publicUrl: `/media/${storagePath}`,\n      mimeType: file.mimetype,\n      sizeBytes: file.size,\n      checksum,\n      visibility: \"public\",\n      status: \"APPROVED\",\n    };\n  }\n\n  async saveEpisodeAudio(file: Express.Multer.File, ownerId: string, episodeId?: string, podcastId?: string): Promise<UploadMetadata> {\n    const basePath = this.getBasePath();\n    const filename = this.generateFilename(file.originalname);\n    const storagePath = `${basePath}/audio/${filename}`;\n    const fullPath = path.join(this.uploadsDir, storagePath);\n\n    // Ensure directory exists\n    await fs.mkdir(path.dirname(fullPath), { recursive: true });\n\n    // Move file to destination\n    await fs.writeFile(fullPath, file.buffer);\n\n    // Calculate checksum\n    const checksum = crypto.createHash(\"md5\").update(file.buffer).digest(\"hex\");\n\n    return {\n      ownerId,\n      podcastId: podcastId || null,\n      episodeId: episodeId || null,\n      type: \"EPISODE_AUDIO\",\n      storageProvider: \"LOCAL\",\n      storageKey: storagePath,\n      publicUrl: `/media/${storagePath}`,\n      mimeType: file.mimetype,\n      sizeBytes: file.size,\n      checksum,\n      visibility: \"public\",\n      status: \"APPROVED\",\n    };\n  }\n\n  getPublicUrl(asset: MediaAsset): string {\n    return asset.publicUrl || `/media/${asset.storageKey}`;\n  }\n\n  async getSignedUrl(asset: MediaAsset, expiresInSeconds: number = 3600): Promise<string> {\n    // For local storage, we don't need signed URLs\n    // Return the public URL instead\n    return this.getPublicUrl(asset);\n  }\n\n  async deleteAssetByKey(storageKey: string): Promise<void> {\n    const fullPath = path.join(this.uploadsDir, storageKey);\n    try {\n      await fs.unlink(fullPath);\n    } catch (error) {\n      console.error(`Error deleting file ${fullPath}:`, error);\n      // Don't throw - file might already be deleted\n    }\n  }\n\n  async streamAsset(asset: MediaAsset): Promise<Readable> {\n    const fullPath = path.join(this.uploadsDir, asset.storageKey);\n    \n    try {\n      await fs.access(fullPath);\n    } catch (error) {\n      throw new Error(`File not found: ${asset.storageKey}`);\n    }\n    \n    const { createReadStream } = await import(\"fs\");\n    return createReadStream(fullPath);\n  }\n\n  private generateFilename(originalName: string): string {\n    const ext = path.extname(originalName);\n    const timestamp = Date.now();\n    const random = crypto.randomBytes(8).toString(\"hex\");\n    return `${timestamp}-${random}${ext}`;\n  }\n}\n\n// Google Drive storage adapter\nexport class DriveStorageAdapter implements StorageAdapter {\n  private drive: drive_v3.Drive | null = null;\n  private serviceAccountEmail: string;\n  private serviceAccountKey: string;\n  private folderIdImages: string;\n  private folderIdAudio: string;\n\n  constructor(config: {\n    serviceAccountEmail: string;\n    serviceAccountKey: string;\n    folderIdImages: string;\n    folderIdAudio: string;\n  }) {\n    this.serviceAccountEmail = config.serviceAccountEmail;\n    this.serviceAccountKey = config.serviceAccountKey;\n    this.folderIdImages = config.folderIdImages;\n    this.folderIdAudio = config.folderIdAudio;\n  }\n\n  private async getDrive(): Promise<drive_v3.Drive> {\n    if (this.drive) {\n      return this.drive;\n    }\n\n    const auth = new google.auth.GoogleAuth({\n      credentials: JSON.parse(this.serviceAccountKey),\n      scopes: [\"https://www.googleapis.com/auth/drive\"],\n    });\n\n    this.drive = google.drive({ version: \"v3\", auth });\n    return this.drive;\n  }\n\n  async saveCoverArt(file: Express.Multer.File, ownerId: string, podcastId?: string): Promise<UploadMetadata> {\n    const drive = await this.getDrive();\n    const filename = this.generateFilename(file.originalname);\n\n    // Convert buffer to stream\n    const bufferStream = ReadableStream.from(file.buffer);\n\n    // Upload to Google Drive\n    const response = await drive.files.create({\n      requestBody: {\n        name: filename,\n        parents: [this.folderIdImages],\n      },\n      media: {\n        mimeType: file.mimetype,\n        body: bufferStream,\n      },\n      fields: \"id, webViewLink, webContentLink\",\n    });\n\n    const fileId = response.data.id!;\n    const checksum = crypto.createHash(\"md5\").update(file.buffer).digest(\"hex\");\n\n    // Make file publicly accessible\n    await drive.permissions.create({\n      fileId,\n      requestBody: {\n        role: \"reader\",\n        type: \"anyone\",\n      },\n    });\n\n    return {\n      ownerId,\n      podcastId: podcastId || null,\n      episodeId: null,\n      type: \"COVER_ART\",\n      storageProvider: \"GOOGLE_DRIVE\",\n      storageKey: fileId,\n      publicUrl: `https://drive.google.com/uc?id=${fileId}&export=download`,\n      mimeType: file.mimetype,\n      sizeBytes: file.size,\n      checksum,\n      visibility: \"public\",\n      status: \"APPROVED\",\n    };\n  }\n\n  async saveEpisodeAudio(file: Express.Multer.File, ownerId: string, episodeId?: string, podcastId?: string): Promise<UploadMetadata> {\n    const drive = await this.getDrive();\n    const filename = this.generateFilename(file.originalname);\n\n    // Convert buffer to stream\n    const bufferStream = ReadableStream.from(file.buffer);\n\n    // Upload to Google Drive\n    const response = await drive.files.create({\n      requestBody: {\n        name: filename,\n        parents: [this.folderIdAudio],\n      },\n      media: {\n        mimeType: file.mimetype,\n        body: bufferStream,\n      },\n      fields: \"id, webViewLink, webContentLink\",\n    });\n\n    const fileId = response.data.id!;\n    const checksum = crypto.createHash(\"md5\").update(file.buffer).digest(\"hex\");\n\n    // Make file publicly accessible\n    await drive.permissions.create({\n      fileId,\n      requestBody: {\n        role: \"reader\",\n        type: \"anyone\",\n      },\n    });\n\n    return {\n      ownerId,\n      podcastId: podcastId || null,\n      episodeId: episodeId || null,\n      type: \"EPISODE_AUDIO\",\n      storageProvider: \"GOOGLE_DRIVE\",\n      storageKey: fileId,\n      publicUrl: `https://drive.google.com/uc?id=${fileId}&export=download`,\n      mimeType: file.mimetype,\n      sizeBytes: file.size,\n      checksum,\n      visibility: \"public\",\n      status: \"APPROVED\",\n    };\n  }\n\n  getPublicUrl(asset: MediaAsset): string {\n    return asset.publicUrl || `https://drive.google.com/uc?id=${asset.storageKey}&export=download`;\n  }\n\n  async getSignedUrl(asset: MediaAsset, expiresInSeconds: number = 3600): Promise<string> {\n    // Google Drive public links don't expire\n    return this.getPublicUrl(asset);\n  }\n\n  async deleteAssetByKey(storageKey: string): Promise<void> {\n    const drive = await this.getDrive();\n    try {\n      await drive.files.delete({\n        fileId: storageKey,\n      });\n    } catch (error) {\n      console.error(`Error deleting Google Drive file ${storageKey}:`, error);\n      // Don't throw - file might already be deleted\n    }\n  }\n\n  async streamAsset(asset: MediaAsset): Promise<Readable> {\n    const drive = await this.getDrive();\n    const response = await drive.files.get(\n      {\n        fileId: asset.storageKey,\n        alt: \"media\",\n      },\n      { responseType: \"stream\" }\n    );\n\n    return response.data as unknown as Readable;\n  }\n\n  private generateFilename(originalName: string): string {\n    const ext = path.extname(originalName);\n    const timestamp = Date.now();\n    const random = crypto.randomBytes(8).toString(\"hex\");\n    return `${timestamp}-${random}${ext}`;\n  }\n}\n\n// Storage service factory\nexport class StorageService {\n  private adapter: StorageAdapter;\n\n  constructor(adapter?: StorageAdapter) {\n    // Default to local storage if no adapter provided\n    this.adapter = adapter || new LocalStorageAdapter();\n  }\n\n  // Create storage service with local storage, optionally organized by audiobook title\n  static createLocal(audiobookTitle?: string): StorageService {\n    return new StorageService(new LocalStorageAdapter(audiobookTitle));\n  }\n\n  static async createFromConfig(driveConfig?: {\n    serviceAccountEmail: string;\n    serviceAccountKey: string;\n    folderIdImages: string;\n    folderIdAudio: string;\n    isActive: boolean;\n  }, audiobookTitle?: string): Promise<StorageService> {\n    // Always use local storage - Google Drive disabled\n    return new StorageService(new LocalStorageAdapter(audiobookTitle));\n  }\n\n  async saveCoverArt(file: Express.Multer.File, ownerId: string, podcastId?: string): Promise<UploadMetadata> {\n    return this.adapter.saveCoverArt(file, ownerId, podcastId);\n  }\n\n  async saveEpisodeAudio(file: Express.Multer.File, ownerId: string, episodeId?: string, podcastId?: string): Promise<UploadMetadata> {\n    return this.adapter.saveEpisodeAudio(file, ownerId, episodeId, podcastId);\n  }\n\n  getPublicUrl(asset: MediaAsset): string {\n    return this.adapter.getPublicUrl(asset);\n  }\n\n  async getSignedUrl(asset: MediaAsset, expiresInSeconds?: number): Promise<string> {\n    return this.adapter.getSignedUrl(asset, expiresInSeconds);\n  }\n\n  async deleteAsset(asset: MediaAsset | UploadMetadata): Promise<void> {\n    // Route to the correct adapter based on the asset's storage provider\n    if (asset.storageProvider === \"GOOGLE_DRIVE\") {\n      try {\n        // Get drive config and create Drive adapter\n        const driveConfig = await import(\"./storage\").then(m => m.storage.getActiveDriveConfig());\n        const config = await driveConfig;\n        if (!config) {\n          console.warn(`Cannot delete Google Drive asset ${asset.storageKey}: no active Drive configuration. Asset may be orphaned.`);\n          return; // Gracefully handle missing config\n        }\n        const driveAdapter = new DriveStorageAdapter(config);\n        await driveAdapter.deleteAssetByKey(asset.storageKey);\n      } catch (error) {\n        console.error(`Failed to delete Google Drive asset ${asset.storageKey}:`, error);\n        // Don't throw - log error but don't block cleanup\n      }\n    } else {\n      // Use local adapter\n      try {\n        const localAdapter = new LocalStorageAdapter();\n        await localAdapter.deleteAssetByKey(asset.storageKey);\n      } catch (error) {\n        console.error(`Failed to delete local asset ${asset.storageKey}:`, error);\n        // Don't throw - log error but don't block cleanup\n      }\n    }\n  }\n\n  async streamAsset(asset: MediaAsset): Promise<Readable> {\n    return this.adapter.streamAsset(asset);\n  }\n}\n\n// ===================================================\n// API Service Functions - Episode & Podcast Enrichment\n// ===================================================\n\nimport { storage } from \"./storage\";\nimport { enrichEpisodeWithArtwork, resolveEpisodeArtwork, resolveEpisodeAudioUrl } from \"./serializers/episode\";\nimport type { Episode, Podcast } from \"@shared/schema\";\n\n/**\n * Fetches a single episode with enriched cover art and subscription status.\n * Returns episode with effectiveCoverArtUrl/AssetId fields.\n */\nexport async function fetchEpisodeForApi(episodeId: string, viewerId?: string) {\n  const episode = await storage.getEpisodeWithPodcast(episodeId);\n  if (!episode) return undefined;\n  \n  const podcast = await storage.getPodcast(episode.podcastId);\n  if (!podcast) return undefined;\n  \n  const enriched = enrichEpisodeWithArtwork(episode, podcast);\n  const isSubscribed = viewerId ? await storage.isSubscribed(viewerId, episode.podcastId) : false;\n  \n  return { ...enriched, isSubscribed };\n}\n\n/**\n * Fetches a podcast with its episodes, enriching each episode with effective cover art.\n */\nexport async function fetchPodcastWithEpisodesForApi(podcastId: string, viewerId?: string) {\n  const podcast = await storage.getPodcast(podcastId);\n  if (!podcast) return undefined;\n  \n  const episodes = await storage.getEpisodesByPodcast(podcastId);\n  \n  // Enrich each episode with effective cover art and audio URL\n  const enrichedEpisodes = await Promise.all(\n    episodes.map(async (episode) => {\n      // Resolve cover art\n      const { coverArtUrl, coverArtAssetId } = resolveEpisodeArtwork(episode, podcast);\n      \n      // Resolve audio URL from asset if needed\n      let audioAsset = null;\n      if (episode.audioAssetId && !episode.audioUrl) {\n        audioAsset = await storage.getMediaAsset(episode.audioAssetId);\n      }\n      const audioUrl = resolveEpisodeAudioUrl(episode, audioAsset);\n      \n      return {\n        ...episode,\n        audioUrl,\n        effectiveCoverArtUrl: coverArtUrl,\n        effectiveCoverArtAssetId: coverArtAssetId,\n      };\n    })\n  );\n  \n  const isSubscribed = viewerId ? await storage.isSubscribed(viewerId, podcastId) : false;\n  \n  return {\n    ...podcast,\n    episodes: enrichedEpisodes,\n    isSubscribed,\n  };\n}\n\n/**\n * Comprehensive helper for episode API responses.\n * Fetches episode with podcast, performs access control, enriches with cover art,\n * and generates canonical URLs/embed code.\n * \n * @returns null if not found, or { episode, podcast, hasAccess } with enriched data\n */\nexport async function getEpisodeForResponse(\n  episodeId: string,\n  viewerId?: string,\n  userRole?: string\n): Promise<{\n  episode: Episode & {\n    effectiveCoverArtUrl: string | null;\n    effectiveCoverArtAssetId: string | null;\n    isSubscribed: boolean;\n  };\n  podcast: Podcast | null;\n  hasAccess: boolean;\n} | null> {\n  // Fetch episode with podcast\n  const episode = await storage.getEpisodeWithPodcast(episodeId);\n  if (!episode) return null;\n  \n  // Try to fetch podcast (may be missing in edge cases)\n  const podcast = await storage.getPodcast(episode.podcastId);\n  \n  // Determine access - check both visibility/invitations and moderation status\n  // Check visibility access (PRIVATE/UNLISTED/PUBLIC + invitations)\n  const hasVisibilityAccess = await storage.checkUserHasAccessToEpisode(viewerId, episodeId);\n  \n  // Check moderation access (APPROVED status or owner/admin)\n  let hasModerationAccess = episode.status === \"APPROVED\";\n  if (viewerId && userRole) {\n    const isAdmin = userRole === \"ADMIN\";\n    // Admin can always access, even if podcast is missing\n    if (isAdmin) {\n      hasModerationAccess = true;\n    } else if (podcast) {\n      // Owner can access if podcast exists and they own it\n      const isOwner = podcast.ownerId === viewerId;\n      hasModerationAccess = hasModerationAccess || isOwner;\n    }\n  }\n  \n  // Final access requires BOTH visibility and moderation access\n  const hasAccess = hasVisibilityAccess && hasModerationAccess;\n  \n  // Fetch audio asset if episode has audioAssetId but no audioUrl\n  let audioAsset = null;\n  if (episode.audioAssetId && !episode.audioUrl) {\n    audioAsset = await storage.getMediaAsset(episode.audioAssetId);\n  }\n  \n  // Resolve audio URL from asset if needed\n  const audioUrl = resolveEpisodeAudioUrl(episode, audioAsset);\n  \n  // Enrich episode with effective cover art (use podcast if available)\n  let enriched;\n  if (podcast) {\n    enriched = enrichEpisodeWithArtwork(episode, podcast);\n  } else {\n    // No podcast available - use episode's own cover art only\n    enriched = {\n      ...episode,\n      effectiveCoverArtUrl: episode.coverArtUrl,\n      effectiveCoverArtAssetId: episode.coverArtAssetId,\n    };\n  }\n  \n  // Get subscription status\n  const isSubscribed = viewerId ? await storage.isSubscribed(viewerId, episode.podcastId) : false;\n  \n  return {\n    episode: { ...enriched, audioUrl, isSubscribed },\n    podcast: podcast || null,\n    hasAccess,\n  };\n}\n","path":null,"size_bytes":18563,"size_tokens":null},"server/media-orchestrator.ts":{"content":"import { StorageService, UploadMetadata } from \"./storage-service\";\nimport { storage } from \"./storage\";\nimport { MediaAsset } from \"@shared/schema\";\n\nexport class MediaOrchestrator {\n  private storageService: StorageService | null = null;\n  private lastConfigCheck: number = 0;\n  private configCheckInterval: number = 5000; // Re-check config every 5 seconds\n\n  private async getStorageService(): Promise<StorageService> {\n    const now = Date.now();\n    \n    // Re-check config periodically to detect admin changes\n    if (this.storageService && (now - this.lastConfigCheck) < this.configCheckInterval) {\n      return this.storageService;\n    }\n\n    this.lastConfigCheck = now;\n    const driveConfig = await storage.getActiveDriveConfig();\n    this.storageService = await StorageService.createFromConfig(driveConfig || undefined);\n    return this.storageService;\n  }\n\n  async saveCoverArt(file: Express.Multer.File, ownerId: string, podcastId?: string): Promise<MediaAsset> {\n    const storageService = await this.getStorageService();\n    \n    // 1. Upload file using storage adapter - returns lightweight metadata\n    const uploadMetadata: UploadMetadata = await storageService.saveCoverArt(file, ownerId, podcastId);\n\n    try {\n      // 2. Persist exact metadata in database - DB generates id and createdAt\n      const savedAsset = await storage.createMediaAsset(uploadMetadata);\n\n      return savedAsset;\n    } catch (dbError) {\n      // If database operation fails, compensate by deleting the uploaded file\n      console.error(\"Database operation failed, cleaning up uploaded file:\", dbError);\n\n      // Delete the file that was successfully uploaded before the DB failure\n      try {\n        await storageService.deleteAsset(uploadMetadata);\n      } catch (cleanupError) {\n        console.error(\"Cleanup also failed:\", cleanupError);\n      }\n\n      throw dbError;\n    }\n  }\n\n  async saveEpisodeAudio(file: Express.Multer.File, ownerId: string, episodeId?: string, podcastId?: string): Promise<MediaAsset> {\n    const storageService = await this.getStorageService();\n    \n    // 1. Upload file using storage adapter - returns lightweight metadata\n    const uploadMetadata: UploadMetadata = await storageService.saveEpisodeAudio(file, ownerId, episodeId, podcastId);\n\n    try {\n      // 2. Persist exact metadata in database - DB generates id and createdAt\n      const savedAsset = await storage.createMediaAsset(uploadMetadata);\n\n      return savedAsset;\n    } catch (dbError) {\n      // If database operation fails, compensate by deleting the uploaded file\n      console.error(\"Database operation failed, cleaning up uploaded file:\", dbError);\n\n      // Delete the file that was successfully uploaded before the DB failure\n      try {\n        await storageService.deleteAsset(uploadMetadata);\n      } catch (cleanupError) {\n        console.error(\"Cleanup also failed:\", cleanupError);\n      }\n\n      throw dbError;\n    }\n  }\n\n  async getMediaAsset(assetId: string): Promise<MediaAsset | undefined> {\n    return await storage.getMediaAsset(assetId);\n  }\n\n  async streamMedia(assetId: string): Promise<{ asset: MediaAsset; stream: NodeJS.ReadableStream }> {\n    const asset = await storage.getMediaAsset(assetId);\n    if (!asset) {\n      throw new Error(\"Asset not found\");\n    }\n\n    const storageService = await this.getStorageService();\n    const stream = await storageService.streamAsset(asset);\n\n    return { asset, stream };\n  }\n\n  async deleteMediaAsset(assetId: string): Promise<void> {\n    const asset = await storage.getMediaAsset(assetId);\n    if (!asset) {\n      return; // Asset doesn't exist, nothing to delete\n    }\n\n    try {\n      // 1. Delete from storage provider\n      const storageService = await this.getStorageService();\n      await storageService.deleteAsset(asset);\n    } catch (storageError) {\n      console.error(\"Failed to delete file from storage:\", storageError);\n      // Continue with DB deletion even if storage deletion fails\n    }\n\n    // 2. Delete metadata from database\n    await storage.deleteMediaAsset(assetId);\n  }\n\n  // Clear the cached storage service (useful when drive config changes)\n  clearCache(): void {\n    this.storageService = null;\n  }\n}\n\nexport const mediaOrchestrator = new MediaOrchestrator();\n","path":null,"size_bytes":4255,"size_tokens":null},"server/serializers/episode.ts":{"content":"import type { Episode, Podcast, MediaAsset } from \"@shared/schema\";\n\n/**\n * Resolves the effective cover art for an episode.\n * Falls back to podcast cover art if episode doesn't have its own.\n */\nexport function resolveEpisodeArtwork(\n  episode: Episode,\n  podcast: Podcast\n): { coverArtUrl: string | null; coverArtAssetId: string | null } {\n  return {\n    coverArtUrl: episode.coverArtUrl || podcast.coverArtUrl,\n    coverArtAssetId: episode.coverArtAssetId || podcast.coverArtAssetId,\n  };\n}\n\n/**\n * Resolves the audio URL for an episode.\n * If episode has audioAssetId but no audioUrl, generates URL from the asset.\n */\nexport function resolveEpisodeAudioUrl(\n  episode: Episode,\n  audioAsset?: MediaAsset | null\n): string | null {\n  // If episode already has audioUrl, use it\n  if (episode.audioUrl) {\n    return episode.audioUrl;\n  }\n  \n  // If episode has audioAssetId and we have the asset, use its publicUrl\n  if (episode.audioAssetId && audioAsset) {\n    return audioAsset.publicUrl;\n  }\n  \n  return null;\n}\n\n/**\n * Enriches an episode with effective cover art from its podcast.\n * Useful for API responses where clients need the resolved artwork.\n */\nexport function enrichEpisodeWithArtwork<T extends Episode>(\n  episode: T,\n  podcast: Podcast\n): T & { effectiveCoverArtUrl: string | null; effectiveCoverArtAssetId: string | null } {\n  const { coverArtUrl, coverArtAssetId } = resolveEpisodeArtwork(episode, podcast);\n  return {\n    ...episode,\n    effectiveCoverArtUrl: coverArtUrl,\n    effectiveCoverArtAssetId: coverArtAssetId,\n  };\n}\n\n/**\n * Resolves the cover art URL for a podcast.\n * If podcast has coverArtAssetId but no coverArtUrl, generates URL from the asset.\n */\nexport function resolvePodcastCoverArtUrl(\n  podcast: Podcast,\n  coverArtAsset?: MediaAsset | null\n): string | null {\n  // If podcast already has coverArtUrl, use it\n  if (podcast.coverArtUrl) {\n    return podcast.coverArtUrl;\n  }\n  \n  // If podcast has coverArtAssetId and we have the asset, use its publicUrl\n  if (podcast.coverArtAssetId && coverArtAsset) {\n    return coverArtAsset.publicUrl;\n  }\n  \n  return null;\n}\n","path":null,"size_bytes":2109,"size_tokens":null},"client/src/components/footer.tsx":{"content":"import logoAsd from \"@assets/ASD Logo_1763072119185.png\";\n\nexport function Footer() {\n  const currentYear = new Date().getFullYear();\n  \n  return (\n    <footer className=\"border-t bg-background mt-auto\">\n      <div className=\"container mx-auto px-4 md:px-6 py-4\">\n        <div className=\"flex items-center justify-center gap-3\">\n          <img \n            src={logoAsd} \n            alt=\"Atreyu Servicios Digitales\" \n            className=\"h-6 w-auto\"\n          />\n          <p className=\"text-sm text-muted-foreground\">\n            Â© {currentYear} Atreyu Servicios Digitales. Todos los derechos reservados.\n          </p>\n        </div>\n      </div>\n    </footer>\n  );\n}\n","path":null,"size_bytes":674,"size_tokens":null},"client/src/components/file-upload.tsx":{"content":"import { useState, useRef, useCallback } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Card } from \"@/components/ui/card\";\nimport { Upload, X, File, Image as ImageIcon, Music, Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface FileUploadProps {\n  mode: \"cover\" | \"audio\";\n  onUploadComplete?: (data: {\n    assetId: string;\n    publicUrl: string;\n    sizeBytes: number;\n    mimeType: string;\n    duration?: number;\n  }) => void;\n  onRemove?: () => void;\n  currentUrl?: string;\n  disabled?: boolean;\n  \"data-testid\"?: string;\n}\n\nexport function FileUpload({\n  mode,\n  onUploadComplete,\n  onRemove,\n  currentUrl,\n  disabled = false,\n  \"data-testid\": testId,\n}: FileUploadProps) {\n  const [uploading, setUploading] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [uploadedFile, setUploadedFile] = useState<{\n    name: string;\n    url: string;\n    assetId: string;\n  } | null>(currentUrl ? { name: \"Archivo actual\", url: currentUrl, assetId: \"\" } : null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n\n  const config = {\n    cover: {\n      accept: \"image/jpeg,image/png,image/webp\",\n      maxSize: 2 * 1024 * 1024, // 2MB\n      endpoint: \"/api/uploads/cover\",\n      label: \"Subir Imagen\",\n      icon: ImageIcon,\n    },\n    audio: {\n      accept: \"audio/mpeg,audio/mp4,audio/wav,audio/x-m4a\",\n      maxSize: 500 * 1024 * 1024, // 500MB\n      endpoint: \"/api/uploads/audio\",\n      label: \"Subir Audio\",\n      icon: Music,\n    },\n  }[mode];\n\n  const extractAudioDuration = useCallback(\n    (file: File): Promise<number> => {\n      return new Promise((resolve, reject) => {\n        const audio = new Audio();\n        const objectUrl = URL.createObjectURL(file);\n\n        audio.addEventListener(\"loadedmetadata\", () => {\n          URL.revokeObjectURL(objectUrl);\n          resolve(Math.round(audio.duration));\n        });\n\n        audio.addEventListener(\"error\", () => {\n          URL.revokeObjectURL(objectUrl);\n          reject(new Error(\"No se pudo leer la duraciÃ³n del audio\"));\n        });\n\n        audio.src = objectUrl;\n      });\n    },\n    []\n  );\n\n  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    // Validate file size\n    if (file.size > config.maxSize) {\n      toast({\n        variant: \"destructive\",\n        title: \"Archivo muy grande\",\n        description: `El archivo debe ser menor a ${config.maxSize / (1024 * 1024)}MB`,\n      });\n      return;\n    }\n\n    // Validate file type\n    if (!config.accept.split(\",\").includes(file.type)) {\n      toast({\n        variant: \"destructive\",\n        title: \"Tipo de archivo no vÃ¡lido\",\n        description: \"Por favor selecciona un archivo compatible\",\n      });\n      return;\n    }\n\n    setUploading(true);\n    setProgress(0);\n\n    try {\n      // Extract duration for audio files\n      let duration: number | undefined;\n      if (mode === \"audio\") {\n        try {\n          duration = await extractAudioDuration(file);\n        } catch (error) {\n          console.warn(\"Could not extract audio duration:\", error);\n        }\n      }\n\n      // Prepare form data\n      const formData = new FormData();\n      formData.append(\"file\", file);\n\n      // Upload file with progress tracking\n      const xhr = new XMLHttpRequest();\n\n      xhr.upload.addEventListener(\"progress\", (e) => {\n        if (e.lengthComputable) {\n          const percentComplete = (e.loaded / e.total) * 100;\n          setProgress(Math.round(percentComplete));\n        }\n      });\n\n      const uploadPromise = new Promise<{\n        assetId: string;\n        publicUrl: string;\n        sizeBytes: number;\n        mimeType: string;\n      }>((resolve, reject) => {\n        xhr.addEventListener(\"load\", () => {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            const response = JSON.parse(xhr.responseText);\n            resolve(response);\n          } else {\n            reject(new Error(xhr.statusText || \"Error al subir archivo\"));\n          }\n        });\n\n        xhr.addEventListener(\"error\", () => {\n          reject(new Error(\"Error de red al subir archivo\"));\n        });\n\n        xhr.addEventListener(\"abort\", () => {\n          reject(new Error(\"Subida cancelada\"));\n        });\n\n        xhr.open(\"POST\", config.endpoint);\n        xhr.send(formData);\n      });\n\n      const result = await uploadPromise;\n\n      setUploadedFile({\n        name: file.name,\n        url: result.publicUrl,\n        assetId: result.assetId,\n      });\n\n      toast({\n        title: \"Archivo subido\",\n        description: `${file.name} se subiÃ³ correctamente`,\n      });\n\n      // Call completion callback\n      if (onUploadComplete) {\n        onUploadComplete({\n          ...result,\n          duration,\n        });\n      }\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error al subir\",\n        description: error.message || \"No se pudo subir el archivo\",\n      });\n    } finally {\n      setUploading(false);\n      setProgress(0);\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    }\n  };\n\n  const handleRemove = () => {\n    setUploadedFile(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n    if (onRemove) {\n      onRemove();\n    }\n  };\n\n  const Icon = config.icon;\n\n  return (\n    <div className=\"space-y-3\">\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept={config.accept}\n        onChange={handleFileSelect}\n        className=\"hidden\"\n        disabled={disabled || uploading}\n        data-testid={testId ? `${testId}-input` : undefined}\n      />\n\n      {!uploadedFile && !uploading && (\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          onClick={() => fileInputRef.current?.click()}\n          disabled={disabled}\n          className=\"w-full\"\n          data-testid={testId}\n        >\n          <Upload className=\"mr-2 h-4 w-4\" />\n          {config.label}\n        </Button>\n      )}\n\n      {uploading && (\n        <Card className=\"p-4\">\n          <div className=\"flex items-center gap-3 mb-2\">\n            <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n            <span className=\"text-sm font-medium\">Subiendo...</span>\n          </div>\n          <Progress value={progress} className=\"h-2\" data-testid={testId ? `${testId}-progress` : undefined} />\n          <p className=\"text-xs text-muted-foreground mt-2\">{progress}%</p>\n        </Card>\n      )}\n\n      {uploadedFile && !uploading && (\n        <Card className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            {mode === \"cover\" && uploadedFile.url ? (\n              <img\n                src={uploadedFile.url}\n                alt=\"Preview\"\n                className=\"w-16 h-16 rounded object-cover flex-shrink-0\"\n                data-testid={testId ? `${testId}-preview` : undefined}\n              />\n            ) : (\n              <div className=\"w-16 h-16 rounded bg-muted flex items-center justify-center flex-shrink-0\">\n                <Icon className=\"h-8 w-8 text-muted-foreground\" />\n              </div>\n            )}\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium truncate\" data-testid={testId ? `${testId}-filename` : undefined}>\n                {uploadedFile.name}\n              </p>\n              <p className=\"text-xs text-muted-foreground\">Archivo subido</p>\n            </div>\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={handleRemove}\n              disabled={disabled}\n              data-testid={testId ? `${testId}-remove` : undefined}\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":7971,"size_tokens":null},"client/src/pages/add-episode.tsx":{"content":"import { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation, useRoute, Link } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { insertEpisodeSchema } from \"@shared/schema\";\nimport { Loader2, ArrowLeft, Lock, Users, Globe } from \"lucide-react\";\nimport { FileUpload } from \"@/components/file-upload\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport type { Podcast } from \"@shared/schema\";\n\nconst episodeFormSchema = insertEpisodeSchema.extend({\n  audioAssetId: z.string().min(1, \"Debes subir un archivo de audio\"),\n  audioUrl: z.string().min(1),\n  duration: z.number().min(1, \"La duraciÃ³n debe ser mayor a 0\"),\n  coverAssetId: z.string().optional(),\n  coverUrl: z.string().optional(),\n}).omit({ podcastId: true });\n\ntype EpisodeFormValues = z.infer<typeof episodeFormSchema>;\n\nexport default function AddEpisode() {\n  const [, params] = useRoute(\"/podcast/:podcastId/add-episode\");\n  const podcastId = params?.podcastId;\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const { data: podcast, isLoading } = useQuery<Podcast>({\n    queryKey: [\"/api/podcasts\", podcastId],\n    enabled: !!podcastId,\n  });\n\n  const form = useForm<EpisodeFormValues>({\n    resolver: zodResolver(episodeFormSchema),\n    defaultValues: {\n      title: \"\",\n      notes: \"\",\n      audioUrl: \"\",\n      audioAssetId: \"\",\n      duration: 0,\n      coverUrl: undefined,\n      coverAssetId: undefined,\n      visibility: \"PUBLIC\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: EpisodeFormValues) => {\n      if (!podcastId) throw new Error(\"ID de podcast no encontrado\");\n\n      await apiRequest(\"POST\", \"/api/episodes\", {\n        title: data.title,\n        notes: data.notes,\n        audioUrl: data.audioUrl,\n        audioAssetId: data.audioAssetId,\n        duration: data.duration,\n        coverArtUrl: data.coverUrl || undefined,\n        coverArtAssetId: data.coverAssetId || undefined,\n        podcastId: podcastId,\n        visibility: data.visibility,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\", podcastId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      toast({\n        title: \"Episodio creado\",\n        description: \"Tu episodio ha sido creado exitosamente.\",\n      });\n      setLocation(`/podcast/${podcastId}`);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo crear el episodio. Por favor intenta de nuevo.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: EpisodeFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen pb-32\">\n        <div className=\"max-w-3xl mx-auto px-6 py-8\">\n          <Skeleton className=\"h-10 w-64 mb-8\" />\n          <div className=\"space-y-4\">\n            <Skeleton className=\"h-32 rounded-lg\" />\n            <Skeleton className=\"h-32 rounded-lg\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!podcast) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <h2 className=\"text-2xl font-bold mb-2\">Podcast no encontrado</h2>\n          <Link href=\"/\">\n            <Button variant=\"default\">Volver al inicio</Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      <div className=\"max-w-3xl mx-auto px-6 py-8\">\n        <Link href={`/podcast/${podcastId}`}>\n          <Button variant=\"ghost\" className=\"mb-6\" data-testid=\"button-back\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Volver al podcast\n          </Button>\n        </Link>\n\n        <h1 className=\"text-4xl font-bold font-[Outfit] mb-2\" data-testid=\"text-page-title\">\n          AÃ±adir Episodio\n        </h1>\n        <p className=\"text-muted-foreground mb-2\">\n          AÃ±adiendo episodio a: <span className=\"font-semibold\">{podcast.title}</span>\n        </p>\n        <p className=\"text-muted-foreground mb-8\">\n          Completa la informaciÃ³n de tu nuevo episodio.\n        </p>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>InformaciÃ³n del Episodio</CardTitle>\n                <CardDescription>\n                  Detalles sobre el nuevo episodio\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>TÃ­tulo del Episodio</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Episodio: IntroducciÃ³n\"\n                          data-testid=\"input-episode-title\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Notas del Episodio (opcional)</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"En este episodio hablamos sobre...\"\n                          className=\"min-h-32 resize-none\"\n                          data-testid=\"input-episode-notes\"\n                          {...field}\n                          value={field.value || \"\"}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"visibility\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Privacidad del Episodio</FormLabel>\n                      <Select\n                        onValueChange={field.onChange}\n                        defaultValue={field.value}\n                        value={field.value}\n                        data-testid=\"select-episode-visibility\"\n                      >\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Selecciona la privacidad\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"PUBLIC\" data-testid=\"option-episode-visibility-public\">\n                            <div className=\"flex items-center gap-2\">\n                              <Globe className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">PÃºblico</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Visible para todos\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"UNLISTED\" data-testid=\"option-episode-visibility-unlisted\">\n                            <div className=\"flex items-center gap-2\">\n                              <Users className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">Solo invitados</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Solo usuarios invitados\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"PRIVATE\" data-testid=\"option-episode-visibility-private\">\n                            <div className=\"flex items-center gap-2\">\n                              <Lock className=\"w-4 h-4\" />\n                              <div>\n                                <div className=\"font-medium\">Privado</div>\n                                <div className=\"text-xs text-muted-foreground\">\n                                  Solo tÃº\n                                </div>\n                              </div>\n                            </div>\n                          </SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormItem>\n                  <FormLabel>Portada del Episodio (opcional)</FormLabel>\n                  <FormControl>\n                    <FileUpload\n                      mode=\"cover\"\n                      data-testid=\"upload-episode-cover\"\n                      currentUrl={form.watch(\"coverUrl\") || undefined}\n                      onUploadComplete={(data) => {\n                        form.setValue(\"coverUrl\", data.publicUrl, { shouldValidate: true });\n                        form.setValue(\"coverAssetId\", data.assetId, { shouldValidate: true });\n                      }}\n                      onRemove={() => {\n                        form.setValue(\"coverUrl\", undefined);\n                        form.setValue(\"coverAssetId\", undefined);\n                      }}\n                    />\n                  </FormControl>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Si no subes una portada, se usarÃ¡ la del podcast\n                  </p>\n                  <FormMessage />\n                </FormItem>\n\n                <FormItem>\n                  <FormLabel>Archivo de Audio *</FormLabel>\n                  <FormControl>\n                    <FileUpload\n                      mode=\"audio\"\n                      data-testid=\"upload-episode-audio\"\n                      currentUrl={form.watch(\"audioUrl\") || undefined}\n                      onUploadComplete={(data) => {\n                        form.setValue(\"audioUrl\", data.publicUrl, { shouldValidate: true });\n                        form.setValue(\"audioAssetId\", data.assetId, { shouldValidate: true });\n                        if (data.duration) {\n                          form.setValue(\"duration\", data.duration, { shouldValidate: true });\n                        }\n                      }}\n                      onRemove={() => {\n                        form.setValue(\"audioUrl\", \"\");\n                        form.setValue(\"audioAssetId\", \"\");\n                        form.setValue(\"duration\", 0);\n                      }}\n                    />\n                  </FormControl>\n                  {form.watch(\"duration\") > 0 && (\n                    <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"text-episode-duration\">\n                      DuraciÃ³n: {Math.floor(form.watch(\"duration\") / 60)} min {form.watch(\"duration\") % 60} seg\n                    </p>\n                  )}\n                  <FormMessage />\n                </FormItem>\n              </CardContent>\n            </Card>\n\n            <Button\n              type=\"submit\"\n              size=\"lg\"\n              className=\"w-full\"\n              disabled={createMutation.isPending}\n              data-testid=\"button-submit\"\n            >\n              {createMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Creando...\n                </>\n              ) : (\n                \"Crear Episodio\"\n              )}\n            </Button>\n          </form>\n        </Form>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12628,"size_tokens":null},"client/src/pages/my-podcasts.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Plus, Radio, Music, Rss, FolderOpen } from \"lucide-react\";\nimport { useAuth } from \"@/components/auth-provider\";\nimport type { Podcast } from \"@shared/schema\";\n\ntype PodcastWithCount = Podcast & { episodeCount: number };\n\nexport default function MyPodcasts() {\n  const { user } = useAuth();\n  const { data: podcasts, isLoading } = useQuery<PodcastWithCount[]>({\n    queryKey: [\"/api/my-podcasts\"],\n  });\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"APPROVED\":\n        return \"default\";\n      case \"PENDING_APPROVAL\":\n        return \"secondary\";\n      case \"REJECTED\":\n        return \"destructive\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  const getStatusLabel = (status: string) => {\n    switch (status) {\n      case \"APPROVED\":\n        return \"Aprobado\";\n      case \"PENDING_APPROVAL\":\n        return \"Pendiente\";\n      case \"REJECTED\":\n        return \"Rechazado\";\n      case \"DRAFT\":\n        return \"Borrador\";\n      default:\n        return status;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen pb-32\">\n        <div className=\"max-w-7xl mx-auto px-6 py-8\">\n          <div className=\"flex items-center justify-between mb-8\">\n            <Skeleton className=\"h-10 w-64\" />\n            <Skeleton className=\"h-10 w-40\" />\n          </div>\n          <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n            {Array.from({ length: 6 }).map((_, i) => (\n              <Skeleton key={i} className=\"h-64 rounded-lg\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      <div className=\"max-w-7xl mx-auto px-6 py-8\">\n        <div className=\"flex items-center justify-between mb-8\">\n          <div>\n            <h1 className=\"text-4xl font-bold font-[Outfit] mb-2\" data-testid=\"text-page-title\">\n              Mis Podcasts\n            </h1>\n            <p className=\"text-muted-foreground\">\n              Gestiona todos tus podcasts y episodios\n            </p>\n          </div>\n          <div className=\"flex gap-3\">\n            <Link href=\"/import-rss\">\n              <Button variant=\"outline\" data-testid=\"button-import-rss\">\n                <Rss className=\"h-4 w-4 mr-2\" />\n                Importar RSS\n              </Button>\n            </Link>\n            {user?.role === \"ADMIN\" && (\n              <Link href=\"/import-local\">\n                <Button variant=\"outline\" data-testid=\"button-import-local\">\n                  <FolderOpen className=\"h-4 w-4 mr-2\" />\n                  Importar Carpeta Local\n                </Button>\n              </Link>\n            )}\n            <Link href=\"/create\">\n              <Button data-testid=\"button-create-podcast\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Crear Podcast\n              </Button>\n            </Link>\n          </div>\n        </div>\n\n        {!podcasts || podcasts.length === 0 ? (\n          <Card>\n            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n              <div className=\"rounded-full bg-primary/10 p-6 mb-4\">\n                <Radio className=\"h-12 w-12 text-primary\" />\n              </div>\n              <h3 className=\"text-xl font-semibold mb-2\">No tienes podcasts</h3>\n              <p className=\"text-muted-foreground mb-6 text-center max-w-md\">\n                Comienza a compartir tu contenido creando tu primer podcast\n              </p>\n              <Link href=\"/create\">\n                <Button data-testid=\"button-create-first-podcast\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Crear Mi Primer Podcast\n                </Button>\n              </Link>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n            {podcasts.map((podcast) => (\n              <Card key={podcast.id} className=\"hover-elevate\" data-testid={`card-podcast-${podcast.id}`}>\n                <CardHeader className=\"pb-3\">\n                  {podcast.coverArtUrl ? (\n                    <img\n                      src={podcast.coverArtUrl}\n                      alt={podcast.title}\n                      className=\"w-full aspect-square object-cover rounded-lg mb-4\"\n                      data-testid={`img-podcast-cover-${podcast.id}`}\n                    />\n                  ) : (\n                    <div className=\"w-full aspect-square rounded-lg bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center mb-4\">\n                      <Radio className=\"h-20 w-20 text-primary/40\" />\n                    </div>\n                  )}\n                  <div className=\"flex items-start justify-between gap-2\">\n                    <CardTitle className=\"text-lg line-clamp-2\" data-testid={`text-podcast-title-${podcast.id}`}>\n                      {podcast.title}\n                    </CardTitle>\n                    <Badge variant={getStatusVariant(podcast.status)} data-testid={`badge-status-${podcast.id}`}>\n                      {getStatusLabel(podcast.status)}\n                    </Badge>\n                  </div>\n                  <CardDescription className=\"line-clamp-2 mt-2\">\n                    {podcast.description}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <Music className=\"h-4 w-4\" />\n                    <span data-testid={`text-episode-count-${podcast.id}`}>\n                      {podcast.episodeCount} {podcast.episodeCount === 1 ? \"episodio\" : \"episodios\"}\n                    </span>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Link href={`/podcast/${podcast.id}`} className=\"flex-1\">\n                      <Button variant=\"outline\" className=\"w-full\" size=\"sm\" data-testid={`button-view-${podcast.id}`}>\n                        Ver Detalles\n                      </Button>\n                    </Link>\n                    <Link href={`/podcast/${podcast.id}/add-episode`} className=\"flex-1\">\n                      <Button variant=\"default\" className=\"w-full\" size=\"sm\" data-testid={`button-add-episode-${podcast.id}`}>\n                        <Plus className=\"h-4 w-4 mr-1\" />\n                        Episodio\n                      </Button>\n                    </Link>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6926,"size_tokens":null},"client/src/pages/edit-episode.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation, useRoute } from \"wouter\";\nimport { Loader2, ArrowLeft, Lock, Users, Globe, Upload, Music } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { z } from \"zod\";\nimport { FileUpload } from \"@/components/file-upload\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Episode } from \"@shared/schema\";\n\nconst updateEpisodeSchema = z.object({\n  title: z.string().min(1, \"El tÃ­tulo es requerido\"),\n  notes: z.string().optional(),\n  coverArtUrl: z.string().optional().nullable(),\n  coverArtAssetId: z.string().optional().nullable(),\n  visibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]),\n});\n\ntype UpdateEpisodeFormValues = z.infer<typeof updateEpisodeSchema>;\n\nexport default function EditEpisode() {\n  const [, params] = useRoute(\"/edit-episode/:id\");\n  const episodeId = params?.id;\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [audioFile, setAudioFile] = useState<File | null>(null);\n  const [isUploadingAudio, setIsUploadingAudio] = useState(false);\n\n  const { data: episodeData, isLoading: isLoadingEpisode } = useQuery<Episode & { podcastId: string }>({\n    queryKey: [\"/api/episodes\", episodeId],\n    enabled: !!episodeId,\n  });\n\n  const form = useForm<UpdateEpisodeFormValues>({\n    resolver: zodResolver(updateEpisodeSchema),\n    values: episodeData ? {\n      title: episodeData.title,\n      notes: episodeData.notes || \"\",\n      coverArtUrl: episodeData.coverArtUrl,\n      coverArtAssetId: episodeData.coverArtAssetId,\n      visibility: episodeData.visibility || \"PUBLIC\",\n    } : undefined,\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: UpdateEpisodeFormValues) => {\n      if (!episodeId) throw new Error(\"ID de episodio no encontrado\");\n      return await apiRequest<Episode>(\"PATCH\", `/api/episodes/${episodeId}`, data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Episodio actualizado\",\n        description: \"Los cambios se han guardado correctamente\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\", episodeId] });\n      setLocation(`/episode/${episodeId}`);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el episodio\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleAudioUpload = async () => {\n    if (!audioFile || !episodeId) return;\n    \n    setIsUploadingAudio(true);\n    try {\n      const formData = new FormData();\n      formData.append(\"audioFile\", audioFile);\n      \n      const response = await fetch(`/api/episodes/${episodeId}/audio`, {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Error al subir el archivo de audio\");\n      }\n      \n      toast({\n        title: \"Audio actualizado\",\n        description: \"El archivo de audio se ha subido correctamente\",\n      });\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/episodes\", episodeId] });\n      setAudioFile(null);\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsUploadingAudio(false);\n    }\n  };\n\n  const onSubmit = (data: UpdateEpisodeFormValues) => {\n    updateMutation.mutate(data);\n  };\n\n  if (isLoadingEpisode) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" data-testid=\"loader-episode\" />\n      </div>\n    );\n  }\n\n  if (!episodeData) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <h2 className=\"text-2xl font-bold mb-2\">Episodio no encontrado</h2>\n          <Button onClick={() => setLocation(\"/my-podcasts\")} data-testid=\"button-back\">\n            Volver a Mis Podcasts\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation(`/episode/${episodeId}`)}\n            className=\"mb-4\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Volver\n          </Button>\n          <h1 className=\"text-4xl font-bold\" data-testid=\"text-page-title\">Editar Episodio</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Actualiza la informaciÃ³n de tu episodio\n          </p>\n        </div>\n      </div>\n\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>TÃ­tulo del Episodio *</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        placeholder=\"TÃ­tulo del episodio\"\n                        data-testid=\"input-episode-title\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"notes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Notas / DescripciÃ³n</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        {...field}\n                        value={field.value || \"\"}\n                        placeholder=\"DescripciÃ³n del episodio, enlaces, etc.\"\n                        rows={8}\n                        data-testid=\"input-episode-notes\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"visibility\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Privacidad del Episodio</FormLabel>\n                    <Select\n                      onValueChange={field.onChange}\n                      defaultValue={field.value}\n                      value={field.value}\n                      data-testid=\"select-episode-visibility\"\n                    >\n                      <FormControl>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Selecciona la privacidad\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"PUBLIC\" data-testid=\"option-episode-visibility-public\">\n                          <div className=\"flex items-center gap-2\">\n                            <Globe className=\"w-4 h-4\" />\n                            <div>\n                              <div className=\"font-medium\">PÃºblico</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                Visible para todos\n                              </div>\n                            </div>\n                          </div>\n                        </SelectItem>\n                        <SelectItem value=\"UNLISTED\" data-testid=\"option-episode-visibility-unlisted\">\n                          <div className=\"flex items-center gap-2\">\n                            <Users className=\"w-4 h-4\" />\n                            <div>\n                              <div className=\"font-medium\">Solo invitados</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                Solo usuarios invitados\n                              </div>\n                            </div>\n                          </div>\n                        </SelectItem>\n                        <SelectItem value=\"PRIVATE\" data-testid=\"option-episode-visibility-private\">\n                          <div className=\"flex items-center gap-2\">\n                            <Lock className=\"w-4 h-4\" />\n                            <div>\n                              <div className=\"font-medium\">Privado</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                Solo tÃº\n                              </div>\n                            </div>\n                          </div>\n                        </SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div>\n                <FormLabel>Portada del Episodio (opcional)</FormLabel>\n                <FileUpload\n                  mode=\"cover\"\n                  data-testid=\"upload-episode-cover\"\n                  currentUrl={form.watch(\"coverArtUrl\") || undefined}\n                  onUploadComplete={(data) => {\n                    form.setValue(\"coverArtUrl\", data.publicUrl, { shouldValidate: true });\n                    form.setValue(\"coverArtAssetId\", data.assetId, { shouldValidate: true });\n                  }}\n                  onRemove={() => {\n                    form.setValue(\"coverArtUrl\", undefined);\n                    form.setValue(\"coverArtAssetId\", undefined);\n                  }}\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Si no subes una portada, se usarÃ¡ la del podcast\n                </p>\n              </div>\n\n              <div className=\"space-y-2\">\n                <FormLabel>Cambiar Archivo de Audio (opcional)</FormLabel>\n                <div className=\"border-2 border-dashed rounded-md p-6 hover-elevate active-elevate-2 transition-all\">\n                  <input\n                    type=\"file\"\n                    accept=\"audio/mp3,audio/mpeg,.mp3\"\n                    onChange={(e) => {\n                      const file = e.target.files?.[0];\n                      if (file) {\n                        if (!file.type.includes('audio/mpeg') && !file.name.endsWith('.mp3')) {\n                          toast({\n                            title: \"Archivo no vÃ¡lido\",\n                            description: \"Solo se aceptan archivos MP3\",\n                            variant: \"destructive\",\n                          });\n                          return;\n                        }\n                        setAudioFile(file);\n                      }\n                    }}\n                    className=\"hidden\"\n                    id=\"audio-upload\"\n                    data-testid=\"input-audio-file\"\n                  />\n                  {audioFile ? (\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <Music className=\"h-5 w-5 text-primary\" />\n                        <span className=\"text-sm font-medium\">{audioFile.name}</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          ({(audioFile.size / 1024 / 1024).toFixed(2)} MB)\n                        </span>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          type=\"button\"\n                          onClick={handleAudioUpload}\n                          disabled={isUploadingAudio}\n                          size=\"sm\"\n                          data-testid=\"button-upload-audio\"\n                        >\n                          {isUploadingAudio ? (\n                            <>\n                              <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                              Subiendo...\n                            </>\n                          ) : (\n                            <>\n                              <Upload className=\"h-4 w-4 mr-2\" />\n                              Subir Audio\n                            </>\n                          )}\n                        </Button>\n                        <Button\n                          type=\"button\"\n                          variant=\"outline\"\n                          onClick={() => setAudioFile(null)}\n                          size=\"sm\"\n                          data-testid=\"button-remove-audio\"\n                        >\n                          Cancelar\n                        </Button>\n                      </div>\n                    </div>\n                  ) : (\n                    <label\n                      htmlFor=\"audio-upload\"\n                      className=\"flex flex-col items-center cursor-pointer\"\n                    >\n                      <Upload className=\"h-8 w-8 text-muted-foreground mb-2\" />\n                      <p className=\"text-sm font-medium mb-1\">\n                        Click para reemplazar el archivo de audio\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Solo archivos MP3 (mÃ¡x. 500 MB)\n                      </p>\n                    </label>\n                  )}\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Subir un nuevo archivo reemplazarÃ¡ el audio actual del episodio\n                </p>\n              </div>\n\n              <div className=\"flex gap-4\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setLocation(`/episode/${episodeId}`)}\n                  disabled={updateMutation.isPending}\n                  data-testid=\"button-cancel\"\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={updateMutation.isPending}\n                  data-testid=\"button-save\"\n                >\n                  {updateMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Guardando...\n                    </>\n                  ) : (\n                    \"Guardar Cambios\"\n                  )}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15361,"size_tokens":null},"client/src/pages/edit-podcast.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation, useRoute } from \"wouter\";\nimport { Loader2, ArrowLeft, Lock, Users, Globe } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { z } from \"zod\";\nimport { FileUpload } from \"@/components/file-upload\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Podcast } from \"@shared/schema\";\n\nconst updatePodcastSchema = z.object({\n  title: z.string().min(1, \"El tÃ­tulo es requerido\"),\n  description: z.string().min(1, \"La descripciÃ³n es requerida\"),\n  coverArtUrl: z.string().optional().nullable(),\n  coverArtAssetId: z.string().optional().nullable(),\n  category: z.string().min(1, \"La categorÃ­a es requerida\"),\n  language: z.string().min(1, \"El idioma es requerido\"),\n  visibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]),\n});\n\ntype UpdatePodcastFormValues = z.infer<typeof updatePodcastSchema>;\n\nexport default function EditPodcast() {\n  const [, params] = useRoute(\"/edit-podcast/:id\");\n  const podcastId = params?.id;\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const { data: podcast, isLoading: isLoadingPodcast } = useQuery<Podcast>({\n    queryKey: [\"/api/podcasts\", podcastId],\n    enabled: !!podcastId,\n  });\n\n  const form = useForm<UpdatePodcastFormValues>({\n    resolver: zodResolver(updatePodcastSchema),\n    values: podcast ? {\n      title: podcast.title,\n      description: podcast.description,\n      coverArtUrl: podcast.coverArtUrl,\n      coverArtAssetId: podcast.coverArtAssetId,\n      category: podcast.category,\n      language: podcast.language,\n      visibility: podcast.visibility || \"PUBLIC\",\n    } : undefined,\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: UpdatePodcastFormValues) => {\n      if (!podcastId) throw new Error(\"ID de podcast no encontrado\");\n      return await apiRequest<Podcast>(\"PATCH\", `/api/podcasts/${podcastId}`, data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Podcast actualizado\",\n        description: \"Los cambios se han guardado correctamente\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\", podcastId] });\n      setLocation(`/podcast/${podcastId}`);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el podcast\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: UpdatePodcastFormValues) => {\n    updateMutation.mutate(data);\n  };\n\n  if (isLoadingPodcast) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" data-testid=\"loader-podcast\" />\n      </div>\n    );\n  }\n\n  if (!podcast) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <h2 className=\"text-2xl font-bold mb-2\">Podcast no encontrado</h2>\n          <Button onClick={() => setLocation(\"/my-podcasts\")} data-testid=\"button-back\">\n            Volver a Mis Podcasts\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation(`/podcast/${podcastId}`)}\n            className=\"mb-4\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Volver\n          </Button>\n          <h1 className=\"text-4xl font-bold\" data-testid=\"text-page-title\">Editar Podcast</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Actualiza la informaciÃ³n de tu podcast\n          </p>\n        </div>\n      </div>\n\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>TÃ­tulo del Podcast *</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        placeholder=\"Nombre de tu podcast\"\n                        data-testid=\"input-podcast-title\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>DescripciÃ³n *</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        {...field}\n                        placeholder=\"Describe de quÃ© trata tu podcast\"\n                        rows={5}\n                        data-testid=\"input-podcast-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"visibility\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Privacidad</FormLabel>\n                    <Select\n                      onValueChange={field.onChange}\n                      defaultValue={field.value}\n                      value={field.value}\n                      data-testid=\"select-podcast-visibility\"\n                    >\n                      <FormControl>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Selecciona la privacidad\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"PUBLIC\" data-testid=\"option-visibility-public\">\n                          <div className=\"flex items-center gap-2\">\n                            <Globe className=\"w-4 h-4\" />\n                            <div>\n                              <div className=\"font-medium\">PÃºblico</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                Visible para todos\n                              </div>\n                            </div>\n                          </div>\n                        </SelectItem>\n                        <SelectItem value=\"UNLISTED\" data-testid=\"option-visibility-unlisted\">\n                          <div className=\"flex items-center gap-2\">\n                            <Users className=\"w-4 h-4\" />\n                            <div>\n                              <div className=\"font-medium\">Solo invitados</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                Solo usuarios invitados\n                              </div>\n                            </div>\n                          </div>\n                        </SelectItem>\n                        <SelectItem value=\"PRIVATE\" data-testid=\"option-visibility-private\">\n                          <div className=\"flex items-center gap-2\">\n                            <Lock className=\"w-4 h-4\" />\n                            <div>\n                              <div className=\"font-medium\">Privado</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                Solo tÃº\n                              </div>\n                            </div>\n                          </div>\n                        </SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"category\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>CategorÃ­a *</FormLabel>\n                    <Select\n                      onValueChange={field.onChange}\n                      defaultValue={field.value}\n                      value={field.value}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-podcast-category\">\n                          <SelectValue placeholder=\"Selecciona una categorÃ­a\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"Technology\">TecnologÃ­a</SelectItem>\n                        <SelectItem value=\"Business\">Negocios</SelectItem>\n                        <SelectItem value=\"Education\">EducaciÃ³n</SelectItem>\n                        <SelectItem value=\"Comedy\">Comedia</SelectItem>\n                        <SelectItem value=\"News\">Noticias</SelectItem>\n                        <SelectItem value=\"Health\">Salud</SelectItem>\n                        <SelectItem value=\"Sports\">Deportes</SelectItem>\n                        <SelectItem value=\"Music\">MÃºsica</SelectItem>\n                        <SelectItem value=\"Arts\">Artes</SelectItem>\n                        <SelectItem value=\"Society\">Sociedad</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"language\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Idioma *</FormLabel>\n                    <Select\n                      onValueChange={field.onChange}\n                      defaultValue={field.value}\n                      value={field.value}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-podcast-language\">\n                          <SelectValue placeholder=\"Selecciona un idioma\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"es\">EspaÃ±ol</SelectItem>\n                        <SelectItem value=\"en\">English</SelectItem>\n                        <SelectItem value=\"fr\">FranÃ§ais</SelectItem>\n                        <SelectItem value=\"de\">Deutsch</SelectItem>\n                        <SelectItem value=\"it\">Italiano</SelectItem>\n                        <SelectItem value=\"pt\">PortuguÃªs</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div>\n                <FormLabel>Portada del Podcast *</FormLabel>\n                <FileUpload\n                  mode=\"cover\"\n                  data-testid=\"upload-podcast-cover\"\n                  currentUrl={form.watch(\"coverArtUrl\") || undefined}\n                  onUploadComplete={(data) => {\n                    form.setValue(\"coverArtUrl\", data.publicUrl, { shouldValidate: true });\n                    form.setValue(\"coverArtAssetId\", data.assetId, { shouldValidate: true });\n                  }}\n                  onRemove={() => {\n                    form.setValue(\"coverArtUrl\", undefined);\n                    form.setValue(\"coverArtAssetId\", undefined);\n                  }}\n                />\n              </div>\n\n              <div className=\"flex gap-4\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setLocation(`/podcast/${podcastId}`)}\n                  disabled={updateMutation.isPending}\n                  data-testid=\"button-cancel\"\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={updateMutation.isPending}\n                  data-testid=\"button-save\"\n                >\n                  {updateMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Guardando...\n                    </>\n                  ) : (\n                    \"Guardar Cambios\"\n                  )}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":13252,"size_tokens":null},"client/src/pages/reset-password.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { KeyRound, Loader2, CheckCircle } from \"lucide-react\";\nimport logoImage from \"@assets/AUDIVIA_1766261612511.png\";\n\nexport default function ResetPassword() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [token, setToken] = useState<string | null>(null);\n  const [isSuccess, setIsSuccess] = useState(false);\n\n  useEffect(() => {\n    // Get token from URL query params\n    const params = new URLSearchParams(window.location.search);\n    const tokenParam = params.get(\"token\");\n    \n    if (!tokenParam) {\n      toast({\n        variant: \"destructive\",\n        title: \"Token invÃ¡lido\",\n        description: \"El enlace de recuperaciÃ³n es invÃ¡lido o ha expirado\",\n      });\n    } else {\n      setToken(tokenParam);\n    }\n  }, [toast]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (password !== confirmPassword) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Las contraseÃ±as no coinciden\",\n      });\n      return;\n    }\n\n    if (password.length < 8) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"La contraseÃ±a debe tener al menos 8 caracteres\",\n      });\n      return;\n    }\n\n    if (!token) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"Token no encontrado\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/reset-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ token, newPassword: password }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Error al restablecer la contraseÃ±a\");\n      }\n\n      setIsSuccess(true);\n      toast({\n        title: \"Â¡ContraseÃ±a actualizada!\",\n        description: \"Tu contraseÃ±a ha sido restablecida exitosamente\",\n      });\n\n      // Redirect to login after 3 seconds\n      setTimeout(() => {\n        setLocation(\"/login\");\n      }, 3000);\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"No se pudo restablecer la contraseÃ±a\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (!token) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-6\">\n        <div className=\"w-full max-w-md space-y-4\">\n          <div className=\"flex items-center justify-center gap-3\">\n            <img \n              src={logoImage} \n              alt=\"Audivia Logo\" \n              className=\"w-12 h-12\"\n              data-testid=\"img-logo\"\n            />\n            <div>\n              <h1 className=\"font-serif text-xl font-bold\">Audivia</h1>\n            </div>\n          </div>\n          <Card className=\"w-full\">\n            <CardHeader>\n              <CardTitle>Token InvÃ¡lido</CardTitle>\n              <CardDescription>\n                El enlace de recuperaciÃ³n es invÃ¡lido o ha expirado\n              </CardDescription>\n            </CardHeader>\n            <CardFooter>\n              <Link href=\"/forgot-password\" className=\"w-full\">\n                <Button className=\"w-full\" data-testid=\"button-request-new\">\n                  Solicitar nuevo enlace\n                </Button>\n              </Link>\n            </CardFooter>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-6\">\n      <div className=\"w-full max-w-md space-y-8\">\n        {/* Logo */}\n        <div className=\"flex items-center justify-center gap-3\">\n          <img \n            src={logoImage} \n            alt=\"Audivia Logo\" \n            className=\"w-12 h-12\"\n            data-testid=\"img-logo\"\n          />\n          <div>\n            <h1 className=\"font-serif text-xl font-bold\">Audivia</h1>\n            <p className=\"text-xs text-muted-foreground\">Restablecer contraseÃ±a</p>\n          </div>\n        </div>\n\n        {/* Reset Password Card */}\n        <Card className=\"w-full\">\n          <CardHeader className=\"space-y-2\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-3 rounded-full bg-primary/10\">\n                {isSuccess ? (\n                  <CheckCircle className=\"w-6 h-6 text-primary\" />\n                ) : (\n                  <KeyRound className=\"w-6 h-6 text-primary\" />\n                )}\n              </div>\n              <div>\n                <CardTitle className=\"text-2xl\">\n                  {isSuccess ? \"Â¡Listo!\" : \"Nueva ContraseÃ±a\"}\n                </CardTitle>\n                <CardDescription>\n                  {isSuccess \n                    ? \"Tu contraseÃ±a ha sido actualizada\" \n                    : \"Ingresa tu nueva contraseÃ±a\"\n                  }\n                </CardDescription>\n              </div>\n            </div>\n          </CardHeader>\n\n          {!isSuccess ? (\n            <form onSubmit={handleSubmit}>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"password\">Nueva ContraseÃ±a</Label>\n                  <Input\n                    id=\"password\"\n                    type=\"password\"\n                    placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    required\n                    minLength={8}\n                    data-testid=\"input-password\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    MÃ­nimo 8 caracteres\n                  </p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"confirmPassword\">Confirmar ContraseÃ±a</Label>\n                  <Input\n                    id=\"confirmPassword\"\n                    type=\"password\"\n                    placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                    value={confirmPassword}\n                    onChange={(e) => setConfirmPassword(e.target.value)}\n                    required\n                    minLength={8}\n                    data-testid=\"input-confirm-password\"\n                  />\n                </div>\n              </CardContent>\n              <CardFooter>\n                <Button \n                  type=\"submit\" \n                  className=\"w-full\" \n                  disabled={isLoading}\n                  data-testid=\"button-submit\"\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Restableciendo...\n                    </>\n                  ) : (\n                    \"Restablecer ContraseÃ±a\"\n                  )}\n                </Button>\n              </CardFooter>\n            </form>\n          ) : (\n            <>\n              <CardContent className=\"space-y-4\">\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    Tu contraseÃ±a ha sido restablecida exitosamente.\n                  </p>\n                  <p className=\"text-sm text-muted-foreground mt-2\">\n                    SerÃ¡s redirigido a la pÃ¡gina de inicio de sesiÃ³n en unos segundos...\n                  </p>\n                </div>\n              </CardContent>\n              <CardFooter>\n                <Link href=\"/login\" className=\"w-full\">\n                  <Button \n                    type=\"button\" \n                    className=\"w-full\"\n                    data-testid=\"button-go-to-login\"\n                  >\n                    Ir a Iniciar SesiÃ³n\n                  </Button>\n                </Link>\n              </CardFooter>\n            </>\n          )}\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8492,"size_tokens":null},"client/src/pages/forgot-password.tsx":{"content":"import { useState } from \"react\";\nimport { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Mail, Loader2, ArrowLeft } from \"lucide-react\";\nimport logoImage from \"@assets/AUDIVIA_1766261612511.png\";\n\nexport default function ForgotPassword() {\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [email, setEmail] = useState(\"\");\n  const [emailSent, setEmailSent] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/forgot-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email }),\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Error al enviar el email\");\n      }\n\n      setEmailSent(true);\n      toast({\n        title: \"Email enviado\",\n        description: \"Si el email existe, recibirÃ¡s instrucciones para recuperar tu contraseÃ±a\",\n      });\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"No se pudo enviar el email de recuperaciÃ³n\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-6\">\n      <div className=\"w-full max-w-md space-y-8\">\n        {/* Logo */}\n        <div className=\"flex items-center justify-center gap-3\">\n          <img \n            src={logoImage} \n            alt=\"Audivia Logo\" \n            className=\"w-12 h-12\"\n            data-testid=\"img-logo\"\n          />\n          <div>\n            <h1 className=\"font-serif text-xl font-bold\">Audivia</h1>\n            <p className=\"text-xs text-muted-foreground\">Recupera tu contraseÃ±a</p>\n          </div>\n        </div>\n\n        {/* Forgot Password Card */}\n        <Card className=\"w-full\">\n          <CardHeader className=\"space-y-2\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-3 rounded-full bg-primary/10\">\n                <Mail className=\"w-6 h-6 text-primary\" />\n              </div>\n              <div>\n                <CardTitle className=\"text-2xl\">Â¿Olvidaste tu contraseÃ±a?</CardTitle>\n                <CardDescription>\n                  {emailSent \n                    ? \"Revisa tu bandeja de entrada\" \n                    : \"Te enviaremos un enlace para recuperarla\"\n                  }\n                </CardDescription>\n              </div>\n            </div>\n          </CardHeader>\n\n          {!emailSent ? (\n            <form onSubmit={handleSubmit}>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    placeholder=\"tu@email.com\"\n                    value={email}\n                    onChange={(e) => setEmail(e.target.value)}\n                    required\n                    data-testid=\"input-email\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Ingresa el email asociado a tu cuenta y te enviaremos las instrucciones para recuperar tu contraseÃ±a.\n                  </p>\n                </div>\n              </CardContent>\n              <CardFooter className=\"flex flex-col gap-4\">\n                <Button \n                  type=\"submit\" \n                  className=\"w-full\" \n                  disabled={isLoading}\n                  data-testid=\"button-submit\"\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Enviando...\n                    </>\n                  ) : (\n                    \"Enviar enlace de recuperaciÃ³n\"\n                  )}\n                </Button>\n                <Link href=\"/login\" className=\"w-full\">\n                  <Button \n                    type=\"button\" \n                    variant=\"ghost\" \n                    className=\"w-full\"\n                    data-testid=\"button-back-to-login\"\n                  >\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a Iniciar SesiÃ³n\n                  </Button>\n                </Link>\n              </CardFooter>\n            </form>\n          ) : (\n            <>\n              <CardContent className=\"space-y-4\">\n                <div className=\"p-4 bg-muted rounded-lg\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    Si existe una cuenta asociada a <strong>{email}</strong>, recibirÃ¡s un email con las instrucciones para recuperar tu contraseÃ±a.\n                  </p>\n                  <p className=\"text-sm text-muted-foreground mt-2\">\n                    Por favor, revisa tu bandeja de entrada y tambiÃ©n la carpeta de spam.\n                  </p>\n                </div>\n              </CardContent>\n              <CardFooter>\n                <Link href=\"/login\" className=\"w-full\">\n                  <Button \n                    type=\"button\" \n                    variant=\"outline\" \n                    className=\"w-full\"\n                    data-testid=\"button-back-to-login\"\n                  >\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a Iniciar SesiÃ³n\n                  </Button>\n                </Link>\n              </CardFooter>\n            </>\n          )}\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5859,"size_tokens":null},"client/src/pages/verify-email.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Mail, Loader2, CheckCircle, XCircle } from \"lucide-react\";\nimport logoImage from \"@assets/favicon_1763064849361.png\";\n\nexport default function VerifyEmail() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSuccess, setIsSuccess] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [token, setToken] = useState<string | null>(null);\n\n  useEffect(() => {\n    // Get token from URL query params\n    const params = new URLSearchParams(window.location.search);\n    const tokenParam = params.get(\"token\");\n    \n    if (!tokenParam) {\n      setError(\"Token de verificaciÃ³n no encontrado\");\n      setIsLoading(false);\n      return;\n    }\n\n    setToken(tokenParam);\n    verifyEmail(tokenParam);\n  }, []);\n\n  const verifyEmail = async (verificationToken: string) => {\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      const response = await fetch(\"/api/auth/verify-email\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ token: verificationToken }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || \"Error al verificar el email\");\n      }\n\n      setIsSuccess(true);\n      toast({\n        title: \"Â¡Email verificado!\",\n        description: \"Tu email ha sido verificado exitosamente\",\n      });\n\n      // Redirect to home after 3 seconds\n      setTimeout(() => {\n        setLocation(\"/\");\n      }, 3000);\n    } catch (error: any) {\n      setError(error.message);\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"No se pudo verificar el email\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleResendEmail = async () => {\n    try {\n      const response = await fetch(\"/api/auth/resend-verification\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Error al reenviar el email\");\n      }\n\n      toast({\n        title: \"Email enviado\",\n        description: \"Hemos enviado un nuevo email de verificaciÃ³n\",\n      });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo reenviar el email de verificaciÃ³n\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-6\">\n      <div className=\"w-full max-w-md space-y-8\">\n        {/* Logo */}\n        <div className=\"flex flex-col items-center gap-4\">\n          <img \n            src={logoImage} \n            alt=\"PodcastHub Logo\" \n            className=\"w-20 h-20\"\n            data-testid=\"img-logo\"\n          />\n          <div className=\"text-center\">\n            <h1 className=\"text-3xl font-bold\">PodcastHub</h1>\n            <p className=\"text-muted-foreground\">VerificaciÃ³n de email</p>\n          </div>\n        </div>\n\n        {/* Verification Card */}\n        <Card className=\"w-full\">\n          <CardHeader className=\"space-y-2\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-3 rounded-full bg-primary/10\">\n                {isLoading && <Loader2 className=\"w-6 h-6 text-primary animate-spin\" />}\n                {!isLoading && isSuccess && <CheckCircle className=\"w-6 h-6 text-green-500\" />}\n                {!isLoading && error && <XCircle className=\"w-6 h-6 text-destructive\" />}\n                {!isLoading && !isSuccess && !error && <Mail className=\"w-6 h-6 text-primary\" />}\n              </div>\n              <div>\n                <CardTitle className=\"text-2xl\">\n                  {isLoading && \"Verificando...\"}\n                  {!isLoading && isSuccess && \"Â¡Verificado!\"}\n                  {!isLoading && error && \"Error\"}\n                  {!isLoading && !isSuccess && !error && \"Verifica tu email\"}\n                </CardTitle>\n                <CardDescription>\n                  {isLoading && \"Estamos verificando tu email\"}\n                  {!isLoading && isSuccess && \"Tu email ha sido verificado exitosamente\"}\n                  {!isLoading && error && \"Hubo un problema al verificar tu email\"}\n                </CardDescription>\n              </div>\n            </div>\n          </CardHeader>\n\n          <CardContent className=\"space-y-4\">\n            {isLoading && (\n              <div className=\"p-4 bg-muted rounded-lg text-center\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Por favor espera mientras verificamos tu direcciÃ³n de email...\n                </p>\n              </div>\n            )}\n\n            {!isLoading && isSuccess && (\n              <div className=\"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg text-center\">\n                <p className=\"text-sm text-green-900 dark:text-green-100\">\n                  Â¡Excelente! Tu email ha sido verificado correctamente.\n                </p>\n                <p className=\"text-sm text-green-700 dark:text-green-200 mt-2\">\n                  SerÃ¡s redirigido al inicio en unos segundos...\n                </p>\n              </div>\n            )}\n\n            {!isLoading && error && (\n              <div className=\"p-4 bg-destructive/10 rounded-lg\">\n                <p className=\"text-sm text-destructive\">\n                  {error}\n                </p>\n                {error.includes(\"expirado\") && (\n                  <p className=\"text-sm text-muted-foreground mt-2\">\n                    El enlace de verificaciÃ³n ha expirado. Puedes solicitar uno nuevo.\n                  </p>\n                )}\n              </div>\n            )}\n          </CardContent>\n\n          <CardFooter className=\"flex flex-col gap-2\">\n            {!isLoading && isSuccess && (\n              <Link href=\"/\" className=\"w-full\">\n                <Button \n                  className=\"w-full\"\n                  data-testid=\"button-go-home\"\n                >\n                  Ir al Inicio\n                </Button>\n              </Link>\n            )}\n\n            {!isLoading && error && (\n              <>\n                <Button \n                  className=\"w-full\" \n                  onClick={handleResendEmail}\n                  data-testid=\"button-resend\"\n                >\n                  Reenviar email de verificaciÃ³n\n                </Button>\n                <Link href=\"/\" className=\"w-full\">\n                  <Button \n                    variant=\"outline\" \n                    className=\"w-full\"\n                    data-testid=\"button-go-home\"\n                  >\n                    Volver al Inicio\n                  </Button>\n                </Link>\n              </>\n            )}\n          </CardFooter>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7126,"size_tokens":null},"client/src/pages/emergency-reset.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { CheckCircle, AlertCircle, Loader2, ShieldAlert } from \"lucide-react\";\n\nexport default function EmergencyReset() {\n  const [loading, setLoading] = useState(false);\n  const [result, setResult] = useState<{ success: boolean; message: string } | null>(null);\n\n  const handleReset = async () => {\n    setLoading(true);\n    setResult(null);\n\n    try {\n      const response = await fetch(\"/api/emergency/reset-admin-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        setResult({\n          success: true,\n          message: `âœ… ContraseÃ±a restablecida exitosamente. Email: ${data.email}`,\n        });\n      } else {\n        setResult({\n          success: false,\n          message: `âŒ Error: ${data.error}`,\n        });\n      }\n    } catch (error: any) {\n      setResult({\n        success: false,\n        message: `âŒ Error de conexiÃ³n: ${error.message}`,\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-orange-50 to-red-50 dark:from-gray-900 dark:to-gray-800\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"p-3 rounded-full bg-destructive/10\">\n              <ShieldAlert className=\"w-8 h-8 text-destructive\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl\">Reset de Emergencia</CardTitle>\n          <CardDescription>\n            Restablecer contraseÃ±a del administrador\n          </CardDescription>\n        </CardHeader>\n\n        <CardContent className=\"space-y-4\">\n          <Alert>\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription>\n              Este endpoint restablecerÃ¡ la contraseÃ±a del administrador usando el valor configurado en <code className=\"bg-muted px-1 rounded\">ADMIN_PASSWORD</code>.\n            </AlertDescription>\n          </Alert>\n\n          <Button\n            onClick={handleReset}\n            disabled={loading}\n            className=\"w-full\"\n            variant=\"destructive\"\n            data-testid=\"button-reset-password\"\n          >\n            {loading ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Restableciendo...\n              </>\n            ) : (\n              \"Restablecer ContraseÃ±a Admin\"\n            )}\n          </Button>\n\n          {result && (\n            <Alert variant={result.success ? \"default\" : \"destructive\"}>\n              {result.success ? (\n                <CheckCircle className=\"h-4 w-4\" />\n              ) : (\n                <AlertCircle className=\"h-4 w-4\" />\n              )}\n              <AlertDescription className=\"whitespace-pre-wrap\">\n                {result.message}\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {result?.success && (\n            <div className=\"pt-4 border-t\">\n              <p className=\"text-sm text-muted-foreground mb-3\">\n                Ahora puedes iniciar sesiÃ³n con:\n              </p>\n              <div className=\"bg-muted p-3 rounded-md space-y-1 text-sm\">\n                <div>\n                  <span className=\"font-semibold\">Email:</span> admin@audivia.local\n                </div>\n                <div>\n                  <span className=\"font-semibold\">Password:</span> Admin123! (o el que configuraste)\n                </div>\n              </div>\n              <Button\n                onClick={() => window.location.href = \"/login\"}\n                className=\"w-full mt-4\"\n                data-testid=\"button-go-login\"\n              >\n                Ir a Iniciar SesiÃ³n\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":4162,"size_tokens":null},"client/src/pages/import-rss.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, ApiError } from \"@/lib/queryClient\";\nimport { Loader2, Rss, CheckCircle, AlertCircle, ArrowLeft, Info } from \"lucide-react\";\n\nconst importRSSSchema = z.object({\n  rssUrl: z.string().url(\"Ingresa una URL vÃ¡lida\"),\n});\n\ntype ImportRSSFormData = z.infer<typeof importRSSSchema>;\n\ntype ImportResult = {\n  podcast: { id: string };\n  imported: number;\n  skipped: number;\n  totalInFeed: number;\n  message: string;\n  errors?: string[];\n};\n\nexport default function ImportRSS() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [result, setResult] = useState<{\n    success: boolean;\n    data?: ImportResult;\n    error?: string;\n    details?: any;\n  } | null>(null);\n\n  const form = useForm<ImportRSSFormData>({\n    resolver: zodResolver(importRSSSchema),\n    defaultValues: {\n      rssUrl: \"\",\n    },\n  });\n\n  const importMutation = useMutation({\n    mutationFn: async (data: ImportRSSFormData) => {\n      // apiRequest parses JSON and throws ApiError on non-OK responses\n      return await apiRequest<ImportResult>(\"POST\", \"/api/podcasts/import-rss\", data);\n    },\n    onSuccess: (data) => {\n      setResult({\n        success: true,\n        data,\n      });\n      \n      toast({\n        title: \"Â¡Podcast importado!\",\n        description: `Se importaron ${data.imported} episodio${data.imported !== 1 ? 's' : ''} exitosamente`,\n      });\n      \n      // Invalidate podcasts cache\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      \n      // Reset form\n      form.reset();\n    },\n    onError: (error: Error) => {\n      // apiRequest throws ApiError extending Error with status, details, etc.\n      const errorMessage = error.message || \"Error al importar el podcast\";\n      const errorDetails = error instanceof ApiError ? error.details : undefined;\n      \n      setResult({\n        success: false,\n        error: errorMessage,\n        details: errorDetails,\n      });\n      \n      toast({\n        variant: \"destructive\",\n        title: \"Error al importar\",\n        description: errorMessage,\n      });\n    },\n  });\n\n  const onSubmit = (data: ImportRSSFormData) => {\n    setResult(null);\n    importMutation.mutate(data);\n  };\n\n  const handleViewPodcast = () => {\n    if (result?.data?.podcast?.id) {\n      setLocation(`/podcast/${result.data.podcast.id}`);\n    }\n  };\n\n  const handleImportAnother = () => {\n    setResult(null);\n    form.reset();\n  };\n\n  return (\n    <div className=\"container max-w-4xl mx-auto p-6 space-y-6\" data-testid=\"page-import-rss\">\n      {/* Header */}\n      <div className=\"flex items-center gap-4\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setLocation(\"/my-podcasts\")}\n          data-testid=\"button-back\"\n        >\n          <ArrowLeft className=\"h-5 w-5\" />\n        </Button>\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Importar Podcast desde RSS</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Importa podcasts desde plataformas como Spotify, Apple Podcasts, iVoox, etc.\n          </p>\n        </div>\n      </div>\n\n      {/* Info Card */}\n      <Alert>\n        <Info className=\"h-4 w-4\" />\n        <AlertDescription>\n          <strong>Â¿CÃ³mo funciona?</strong> Pega la URL del feed RSS de cualquier podcast y automÃ¡ticamente importaremos\n          toda la informaciÃ³n del podcast y hasta 50 de sus episodios mÃ¡s recientes.\n        </AlertDescription>\n      </Alert>\n\n      {/* Import Form */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Rss className=\"h-5 w-5\" />\n            Feed RSS\n          </CardTitle>\n          <CardDescription>\n            Pega la URL del feed RSS del podcast que deseas importar\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"rssUrl\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>URL del Feed RSS</FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"https://ejemplo.com/feed.xml\"\n                        {...field}\n                        disabled={importMutation.isPending}\n                        data-testid=\"input-rss-url\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Ejemplo: https://feeds.simplecast.com/podcast-id\n                    </FormDescription>\n                    <FormMessage data-testid=\"error-rss-url\" />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                disabled={importMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-import\"\n              >\n                {importMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Importando podcast...\n                  </>\n                ) : (\n                  <>\n                    <Rss className=\"mr-2 h-4 w-4\" />\n                    Importar Podcast\n                  </>\n                )}\n              </Button>\n            </form>\n          </Form>\n\n          {/* Result */}\n          {result && (\n            <div className=\"mt-6\">\n              {result.success && result.data ? (\n                <Alert className=\"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800\">\n                  <CheckCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                  <AlertDescription className=\"text-green-900 dark:text-green-100\">\n                    <div className=\"space-y-2\">\n                      <p className=\"font-semibold\" data-testid=\"text-success-message\">{result.data.message}</p>\n                      <div className=\"text-sm space-y-1\">\n                        <p data-testid=\"text-imported-count\">â€¢ Episodios importados: {result.data.imported}</p>\n                        {result.data.skipped > 0 && (\n                          <p data-testid=\"text-skipped-count\">â€¢ Episodios omitidos: {result.data.skipped}</p>\n                        )}\n                        <p data-testid=\"text-total-count\">â€¢ Total en el feed: {result.data.totalInFeed}</p>\n                      </div>\n                      {result.data.errors && result.data.errors.length > 0 && (\n                        <div className=\"mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-sm\">\n                          <p className=\"font-semibold mb-1\">Advertencias:</p>\n                          <ul className=\"list-disc list-inside space-y-1\">\n                            {result.data.errors.map((err, idx) => (\n                              <li key={idx} className=\"text-yellow-900 dark:text-yellow-100\">{err}</li>\n                            ))}\n                          </ul>\n                        </div>\n                      )}\n                      {result.data.totalInFeed > 50 && (\n                        <p className=\"text-sm text-muted-foreground italic\" data-testid=\"text-limit-notice\">\n                          Solo se importan los primeros 50 episodios\n                        </p>\n                      )}\n                      <div className=\"flex gap-2 mt-4\">\n                        <Button onClick={handleViewPodcast} data-testid=\"button-view-podcast\">\n                          Ver Podcast\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          onClick={handleImportAnother}\n                          data-testid=\"button-import-another\"\n                        >\n                          Importar Otro\n                        </Button>\n                      </div>\n                    </div>\n                  </AlertDescription>\n                </Alert>\n              ) : (\n                <Alert variant=\"destructive\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    <p className=\"font-semibold\" data-testid=\"text-error-message\">Error al importar</p>\n                    <p className=\"text-sm mt-1\" data-testid=\"text-error-detail\">{result.error}</p>\n                    {result.details && (\n                      <pre className=\"mt-2 text-xs bg-destructive/10 p-2 rounded overflow-auto\">\n                        {JSON.stringify(result.details, null, 2)}\n                      </pre>\n                    )}\n                  </AlertDescription>\n                </Alert>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Examples Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Ejemplos de URLs de RSS</CardTitle>\n          <CardDescription>\n            AquÃ­ hay algunos ejemplos de cÃ³mo encontrar el feed RSS en diferentes plataformas\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-3 text-sm\">\n          <div>\n            <p className=\"font-semibold\">Spotify:</p>\n            <p className=\"text-muted-foreground\">\n              Busca en Google \"nombre del podcast RSS feed\" o usa servicios como podcasts.apple.com para encontrar el feed\n            </p>\n          </div>\n          <div>\n            <p className=\"font-semibold\">Apple Podcasts:</p>\n            <p className=\"text-muted-foreground\">\n              La URL del feed RSS suele estar disponible en la pÃ¡gina del podcast\n            </p>\n          </div>\n          <div>\n            <p className=\"font-semibold\">iVoox:</p>\n            <p className=\"text-muted-foreground\">\n              Busca el Ã­cono RSS en la pÃ¡gina del podcast\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":10771,"size_tokens":null},"client/src/pages/manage-invitations.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation, useRoute } from \"wouter\";\nimport { Loader2, ArrowLeft, Mail, X, Lock, Users } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { ContentInvitation, Podcast, Episode } from \"@shared/schema\";\nimport { useState } from \"react\";\n\nconst inviteFormSchema = z.object({\n  email: z.string().email(\"Email invÃ¡lido\"),\n});\n\ntype InviteFormValues = z.infer<typeof inviteFormSchema>;\n\nexport default function ManageInvitations() {\n  const [, params] = useRoute(\"/manage-invitations/:contentType/:id\");\n  const contentType = params?.contentType as \"podcast\" | \"episode\";\n  const contentId = params?.id;\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [invitationToDelete, setInvitationToDelete] = useState<string | null>(null);\n\n  // Fetch content details (podcast or episode)\n  const { data: content, isLoading: isLoadingContent } = useQuery<Podcast | Episode>({\n    queryKey: contentType === \"podcast\" ? [\"/api/podcasts\", contentId] : [\"/api/episodes\", contentId],\n    enabled: !!contentId && !!contentType,\n  });\n\n  // Fetch invitations\n  const { data: invitations = [], isLoading: isLoadingInvitations } = useQuery<ContentInvitation[]>({\n    queryKey: contentType === \"podcast\" \n      ? [\"/api/podcasts\", contentId, \"invitations\"]\n      : [\"/api/episodes\", contentId, \"invitations\"],\n    enabled: !!contentId && !!contentType,\n  });\n\n  const form = useForm<InviteFormValues>({\n    resolver: zodResolver(inviteFormSchema),\n    defaultValues: {\n      email: \"\",\n    },\n  });\n\n  const createInvitationMutation = useMutation({\n    mutationFn: async (data: InviteFormValues) => {\n      const body = contentType === \"podcast\" \n        ? { email: data.email, podcastId: contentId }\n        : { email: data.email, episodeId: contentId };\n      \n      return await apiRequest(\"POST\", \"/api/invitations\", body);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"InvitaciÃ³n enviada\",\n        description: \"Se ha enviado la invitaciÃ³n exitosamente\",\n      });\n      const queryKey = contentType === \"podcast\"\n        ? [\"/api/podcasts\", contentId, \"invitations\"]\n        : [\"/api/episodes\", contentId, \"invitations\"];\n      queryClient.invalidateQueries({ queryKey });\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo enviar la invitaciÃ³n\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteInvitationMutation = useMutation({\n    mutationFn: async (invitationId: string) => {\n      return await apiRequest(\"DELETE\", `/api/invitations/${invitationId}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"InvitaciÃ³n eliminada\",\n        description: \"La invitaciÃ³n ha sido eliminada\",\n      });\n      const queryKey = contentType === \"podcast\"\n        ? [\"/api/podcasts\", contentId, \"invitations\"]\n        : [\"/api/episodes\", contentId, \"invitations\"];\n      queryClient.invalidateQueries({ queryKey });\n      setInvitationToDelete(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo eliminar la invitaciÃ³n\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: InviteFormValues) => {\n    createInvitationMutation.mutate(data);\n  };\n\n  if (isLoadingContent || isLoadingInvitations) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" data-testid=\"loader-invitations\" />\n      </div>\n    );\n  }\n\n  if (!content) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <h2 className=\"text-2xl font-bold mb-2\">Contenido no encontrado</h2>\n          <Button onClick={() => setLocation(\"/my-podcasts\")} data-testid=\"button-back\">\n            Volver a Mis Podcasts\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  const backUrl = contentType === \"podcast\" ? `/podcast/${contentId}` : `/episode/${contentId}`;\n  const contentTitle = content.title;\n  const visibility = content.visibility || \"PUBLIC\";\n\n  return (\n    <div className=\"min-h-screen pb-32\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation(backUrl)}\n            className=\"mb-4\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Volver\n          </Button>\n          <h1 className=\"text-4xl font-bold font-[Outfit] mb-2\" data-testid=\"text-page-title\">\n            Gestionar Invitaciones\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {contentType === \"podcast\" ? \"Podcast\" : \"Episodio\"}: {contentTitle}\n          </p>\n          <div className=\"mt-4 flex items-center gap-2\">\n            <Badge variant=\"secondary\" data-testid=\"badge-visibility\">\n              {visibility === \"PRIVATE\" && (\n                <>\n                  <Lock className=\"w-3 h-3 mr-1\" />\n                  Privado\n                </>\n              )}\n              {visibility === \"UNLISTED\" && (\n                <>\n                  <Users className=\"w-3 h-3 mr-1\" />\n                  Solo invitados\n                </>\n              )}\n            </Badge>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"max-w-3xl mx-auto space-y-8\">\n          {/* Add Invitation Form */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Invitar Usuario</CardTitle>\n              <CardDescription>\n                EnvÃ­a una invitaciÃ³n por email para dar acceso a este contenido\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email del usuario</FormLabel>\n                        <FormControl>\n                          <Input\n                            {...field}\n                            type=\"email\"\n                            placeholder=\"usuario@example.com\"\n                            data-testid=\"input-invite-email\"\n                          />\n                        </FormControl>\n                        <FormDescription>\n                          El usuario recibirÃ¡ acceso a este contenido una vez registrado con este email\n                        </FormDescription>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <Button\n                    type=\"submit\"\n                    disabled={createInvitationMutation.isPending}\n                    data-testid=\"button-send-invitation\"\n                  >\n                    {createInvitationMutation.isPending && (\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    )}\n                    <Mail className=\"mr-2 h-4 w-4\" />\n                    Enviar InvitaciÃ³n\n                  </Button>\n                </form>\n              </Form>\n            </CardContent>\n          </Card>\n\n          {/* Invitations List */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Invitaciones Activas</CardTitle>\n              <CardDescription>\n                {invitations.length === 0 \n                  ? \"No hay invitaciones activas\" \n                  : `${invitations.length} ${invitations.length === 1 ? \"invitaciÃ³n\" : \"invitaciones\"}`\n                }\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {invitations.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Mail className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>AÃºn no has invitado a nadie</p>\n                  <p className=\"text-sm mt-2\">\n                    Usa el formulario de arriba para enviar invitaciones\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  {invitations.map((invitation) => (\n                    <div\n                      key={invitation.id}\n                      className=\"flex items-center justify-between p-4 border rounded-lg hover-elevate\"\n                      data-testid={`invitation-item-${invitation.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"p-2 bg-primary/10 rounded-full\">\n                          <Mail className=\"h-4 w-4 text-primary\" />\n                        </div>\n                        <div>\n                          <p className=\"font-medium\" data-testid={`invitation-email-${invitation.id}`}>\n                            {invitation.email}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            Invitado el {new Date(invitation.createdAt).toLocaleDateString(\"es-ES\")}\n                          </p>\n                        </div>\n                      </div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => setInvitationToDelete(invitation.id)}\n                        data-testid={`button-delete-invitation-${invitation.id}`}\n                        disabled={deleteInvitationMutation.isPending}\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog \n        open={!!invitationToDelete} \n        onOpenChange={(open) => !open && setInvitationToDelete(null)}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Â¿Eliminar invitaciÃ³n?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Esta acciÃ³n no se puede deshacer. El usuario perderÃ¡ acceso a este contenido.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={deleteInvitationMutation.isPending}\n              data-testid=\"button-cancel-delete\"\n            >\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => invitationToDelete && deleteInvitationMutation.mutate(invitationToDelete)}\n              disabled={deleteInvitationMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteInvitationMutation.isPending && (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              )}\n              Eliminar\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":12234,"size_tokens":null},"server/youtube-import.ts":{"content":"import { google } from 'googleapis';\nimport { exec } from 'child_process';\nimport { promisify } from 'util';\nimport path from 'path';\nimport fs from 'fs/promises';\nimport { mediaOrchestrator } from './media-orchestrator';\n\nconst execAsync = promisify(exec);\n\nconst youtube = google.youtube({\n  version: 'v3',\n  auth: process.env.YOUTUBE_API_KEY || '',\n});\n\nexport interface PlaylistMetadata {\n  playlistId: string;\n  title: string;\n  description: string;\n  channelTitle: string;\n  thumbnailUrl?: string;\n  videoCount: number;\n}\n\nexport interface VideoMetadata {\n  videoId: string;\n  title: string;\n  description: string;\n  duration: number;\n  thumbnailUrl?: string;\n  publishedAt: Date;\n}\n\nexport async function getPlaylistMetadata(playlistUrl: string): Promise<PlaylistMetadata> {\n  const playlistId = extractPlaylistId(playlistUrl);\n  \n  if (!playlistId) {\n    throw new Error('URL de playlist de YouTube invÃ¡lida');\n  }\n\n  if (!process.env.YOUTUBE_API_KEY) {\n    throw new Error('YOUTUBE_API_KEY no configurada. Por favor configura esta variable de entorno.');\n  }\n\n  try {\n    const response = await youtube.playlists.list({\n      part: ['snippet', 'contentDetails'],\n      id: [playlistId],\n    });\n\n    const playlist = response.data.items?.[0];\n    if (!playlist) {\n      throw new Error('Playlist no encontrada');\n    }\n\n    return {\n      playlistId,\n      title: playlist.snippet?.title || 'Playlist sin tÃ­tulo',\n      description: playlist.snippet?.description || '',\n      channelTitle: playlist.snippet?.channelTitle || 'Canal desconocido',\n      thumbnailUrl: playlist.snippet?.thumbnails?.high?.url || playlist.snippet?.thumbnails?.default?.url || undefined,\n      videoCount: playlist.contentDetails?.itemCount || 0,\n    };\n  } catch (error: any) {\n    if (error.code === 403 || error.code === 400) {\n      throw new Error('API Key de YouTube invÃ¡lida o sin permisos. Verifica tu configuraciÃ³n.');\n    }\n    throw new Error(`Error al obtener metadatos de la playlist: ${error.message}`);\n  }\n}\n\nexport async function getPlaylistVideos(playlistId: string, maxResults: number = 50): Promise<VideoMetadata[]> {\n  if (!process.env.YOUTUBE_API_KEY) {\n    throw new Error('YOUTUBE_API_KEY no configurada');\n  }\n\n  const videos: VideoMetadata[] = [];\n  let nextPageToken: string | undefined;\n\n  try {\n    do {\n      const response = await youtube.playlistItems.list({\n        part: ['snippet', 'contentDetails'],\n        playlistId,\n        maxResults: Math.min(50, maxResults - videos.length),\n        pageToken: nextPageToken,\n      });\n\n      const items = response.data.items || [];\n      \n      for (const item of items) {\n        const videoId = item.contentDetails?.videoId;\n        if (!videoId) continue;\n\n        videos.push({\n          videoId,\n          title: item.snippet?.title || 'Video sin tÃ­tulo',\n          description: item.snippet?.description || '',\n          duration: 0, // Will be filled with actual duration\n          thumbnailUrl: item.snippet?.thumbnails?.high?.url || item.snippet?.thumbnails?.default?.url || undefined,\n          publishedAt: item.snippet?.publishedAt ? new Date(item.snippet.publishedAt) : new Date(),\n        });\n      }\n\n      nextPageToken = response.data.nextPageToken || undefined;\n    } while (nextPageToken && videos.length < maxResults);\n\n    // Get actual durations for all videos\n    if (videos.length > 0) {\n      const videoIds = videos.map(v => v.videoId);\n      const detailsResponse = await youtube.videos.list({\n        part: ['contentDetails'],\n        id: videoIds,\n      });\n\n      const durations = new Map<string, number>();\n      for (const video of detailsResponse.data.items || []) {\n        if (video.id && video.contentDetails?.duration) {\n          durations.set(video.id, parseDuration(video.contentDetails.duration));\n        }\n      }\n\n      videos.forEach(video => {\n        video.duration = durations.get(video.videoId) || 0;\n      });\n    }\n\n    return videos;\n  } catch (error: any) {\n    throw new Error(`Error al obtener videos de la playlist: ${error.message}`);\n  }\n}\n\nexport async function downloadAudioFromVideo(\n  videoId: string,\n  outputDir: string\n): Promise<{ audioPath: string; filename: string }> {\n  await fs.mkdir(outputDir, { recursive: true });\n\n  const safeFilename = `${videoId}_%(title)s.%(ext)s`;\n  const outputTemplate = path.join(outputDir, safeFilename);\n\n  // Enhanced yt-dlp command following 2024-2025 best practices\n  const commandParts = [\n    'yt-dlp',\n    // Extract audio only\n    '--extract-audio',\n    '--audio-format mp3',\n    '--audio-quality 0',\n    '--no-playlist',\n    // Format selection - use simpler formats less prone to 403\n    '-f \"bestaudio/best\"',\n    // Anti-blocking measures\n    '--user-agent \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36\"',\n    '--referer \"https://www.youtube.com/\"',\n    '--add-header \"Accept-Language:en-US,en;q=0.9\"',\n    // Force IPv4 (IPv6 can cause issues)\n    '-4',\n    // Retry and timeout settings\n    '--retries 5',\n    '--fragment-retries 5',\n    '--retry-sleep 3',\n    // Delays to avoid rate limiting\n    '--sleep-interval 2',\n    '--max-sleep-interval 5',\n    // Cache management\n    '--rm-cache-dir',\n    // Output\n    `-o \"${outputTemplate}\"`,\n    `\"https://www.youtube.com/watch?v=${videoId}\"`,\n  ];\n\n  const command = commandParts.join(' ');\n\n  try {\n    const { stdout, stderr } = await execAsync(command, { \n      maxBuffer: 10 * 1024 * 1024, // 10MB buffer\n      timeout: 600000, // 10 minutes timeout\n    });\n\n    // Find the downloaded file\n    const files = await fs.readdir(outputDir);\n    const audioFile = files.find(f => f.startsWith(videoId) && f.endsWith('.mp3'));\n\n    if (!audioFile) {\n      throw new Error('No se pudo encontrar el archivo de audio descargado');\n    }\n\n    return {\n      audioPath: path.join(outputDir, audioFile),\n      filename: audioFile,\n    };\n  } catch (error: any) {\n    // Check if it's a 403 error\n    if (error.message?.includes('HTTP Error 403')) {\n      throw new Error('YouTube bloqueÃ³ la descarga (Error 403). Esto puede ocurrir debido a:\\n' +\n        '1. Restricciones geogrÃ¡ficas del video\\n' +\n        '2. YouTube detectando descargas automatizadas\\n' +\n        '3. El video requiere autenticaciÃ³n\\n\\n' +\n        'Intenta importar menos videos a la vez o espera unos minutos antes de reintentar.');\n    }\n    throw new Error(`Error al descargar audio: ${error.message}`);\n  }\n}\n\nexport async function downloadThumbnail(\n  thumbnailUrl: string,\n  outputDir: string,\n  filename: string\n): Promise<string> {\n  await fs.mkdir(outputDir, { recursive: true });\n  \n  const outputPath = path.join(outputDir, filename);\n\n  try {\n    const response = await fetch(thumbnailUrl);\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n\n    const buffer = await response.arrayBuffer();\n    await fs.writeFile(outputPath, Buffer.from(buffer));\n\n    return outputPath;\n  } catch (error: any) {\n    throw new Error(`Error al descargar thumbnail: ${error.message}`);\n  }\n}\n\nexport async function uploadAudioToStorage(\n  audioPath: string,\n  filename: string,\n  ownerId: string,\n  episodeId?: string,\n  podcastId?: string\n): Promise<string> {\n  const buffer = await fs.readFile(audioPath);\n  \n  // Create a Multer-like file object\n  const file: Express.Multer.File = {\n    fieldname: 'audio',\n    originalname: filename,\n    encoding: '7bit',\n    mimetype: 'audio/mpeg',\n    buffer,\n    size: buffer.length,\n    stream: null as any,\n    destination: '',\n    filename: '',\n    path: '',\n  };\n\n  const asset = await mediaOrchestrator.saveEpisodeAudio(file, ownerId, episodeId, podcastId);\n  return asset.id;\n}\n\nexport async function uploadImageToStorage(\n  imagePath: string,\n  filename: string,\n  ownerId: string,\n  podcastId?: string\n): Promise<string> {\n  const buffer = await fs.readFile(imagePath);\n  \n  // Detect mime type from extension\n  const ext = path.extname(filename).toLowerCase();\n  const mimeTypes: Record<string, string> = {\n    '.jpg': 'image/jpeg',\n    '.jpeg': 'image/jpeg',\n    '.png': 'image/png',\n    '.webp': 'image/webp',\n  };\n  \n  // Create a Multer-like file object\n  const file: Express.Multer.File = {\n    fieldname: 'coverArt',\n    originalname: filename,\n    encoding: '7bit',\n    mimetype: mimeTypes[ext] || 'image/jpeg',\n    buffer,\n    size: buffer.length,\n    stream: null as any,\n    destination: '',\n    filename: '',\n    path: '',\n  };\n\n  const asset = await mediaOrchestrator.saveCoverArt(file, ownerId, podcastId);\n  return asset.id;\n}\n\nexport async function cleanupTempFiles(filePaths: string[]): Promise<void> {\n  for (const filePath of filePaths) {\n    try {\n      await fs.unlink(filePath);\n    } catch (error) {\n      console.error(`Error deleting temp file ${filePath}:`, error);\n    }\n  }\n}\n\nfunction extractPlaylistId(url: string): string | null {\n  const patterns = [\n    /[?&]list=([a-zA-Z0-9_-]+)/,\n    /youtube\\.com\\/playlist\\?list=([a-zA-Z0-9_-]+)/,\n  ];\n\n  for (const pattern of patterns) {\n    const match = url.match(pattern);\n    if (match) {\n      return match[1];\n    }\n  }\n\n  return null;\n}\n\nfunction parseDuration(duration: string): number {\n  // Parse ISO 8601 duration format (PT1H2M3S)\n  const match = duration.match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/);\n  if (!match) return 0;\n\n  const hours = parseInt(match[1] || '0', 10);\n  const minutes = parseInt(match[2] || '0', 10);\n  const seconds = parseInt(match[3] || '0', 10);\n\n  return hours * 3600 + minutes * 60 + seconds;\n}\n","path":null,"size_bytes":9549,"size_tokens":null},"client/src/pages/import-youtube.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, ApiError } from \"@/lib/queryClient\";\nimport { Loader2, Youtube, CheckCircle, AlertCircle, ArrowLeft, Info, AlertTriangle, Clock } from \"lucide-react\";\n\nconst previewSchema = z.object({\n  playlistUrl: z.string().url(\"Ingresa una URL vÃ¡lida\").refine(\n    (url) => url.includes('youtube.com') || url.includes('youtu.be'),\n    { message: \"Debe ser una URL de YouTube\" }\n  ),\n  maxVideos: z.coerce.number().int().min(1, \"MÃ­nimo 1 video\").max(50, \"MÃ¡ximo 50 videos\").default(10),\n});\n\nconst importSchema = z.object({\n  playlistUrl: z.string(),\n  selectedVideoIds: z.array(z.string()).min(1, \"Debes seleccionar al menos un video\"),\n  podcastTitle: z.string().optional(),\n  podcastDescription: z.string().optional(),\n  visibility: z.enum([\"PRIVATE\", \"UNLISTED\", \"PUBLIC\"]).default(\"PUBLIC\"),\n});\n\ntype PreviewData = {\n  playlist: {\n    title: string;\n    description: string;\n    channelTitle: string;\n    thumbnailUrl: string;\n  };\n  videos: Array<{\n    videoId: string;\n    title: string;\n    description: string;\n    thumbnailUrl: string;\n    duration: number;\n    publishedAt: string;\n  }>;\n  totalVideos: number;\n};\n\ntype ImportResult = {\n  podcast: { id: string };\n  imported: number;\n  skipped: number;\n  message: string;\n  errors?: string[];\n};\n\nexport default function ImportYouTube() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [step, setStep] = useState<\"config\" | \"select\" | \"success\">(\"config\");\n  const [previewData, setPreviewData] = useState<PreviewData | null>(null);\n  const [selectedVideoIds, setSelectedVideoIds] = useState<string[]>([]);\n  const [podcastConfig, setPodcastConfig] = useState<{\n    playlistUrl: string;\n    title?: string;\n    description?: string;\n    visibility: \"PRIVATE\" | \"UNLISTED\" | \"PUBLIC\";\n  } | null>(null);\n  const [importResult, setImportResult] = useState<ImportResult | null>(null);\n\n  const previewForm = useForm({\n    resolver: zodResolver(previewSchema),\n    defaultValues: {\n      playlistUrl: \"\",\n      maxVideos: 10,\n    },\n  });\n\n  const previewMutation = useMutation({\n    mutationFn: async (data: z.infer<typeof previewSchema>) => {\n      const params = new URLSearchParams({\n        playlistUrl: data.playlistUrl,\n        maxVideos: data.maxVideos.toString(),\n      });\n      return await apiRequest<PreviewData>(\"GET\", `/api/import-youtube/preview?${params}`);\n    },\n    onSuccess: (data) => {\n      setPreviewData(data);\n      setSelectedVideoIds(data.videos.map(v => v.videoId)); // Select all by default\n      setStep(\"select\");\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error al obtener playlist\",\n        description: error.message,\n      });\n    },\n  });\n\n  const importMutation = useMutation({\n    mutationFn: async () => {\n      if (!podcastConfig || !previewData) throw new Error(\"ConfiguraciÃ³n no disponible\");\n      \n      return await apiRequest<ImportResult>(\"POST\", \"/api/import-youtube\", {\n        playlistUrl: podcastConfig.playlistUrl,\n        selectedVideoIds,\n        podcastTitle: podcastConfig.title || undefined,\n        podcastDescription: podcastConfig.description || undefined,\n        visibility: podcastConfig.visibility,\n        maxVideos: Math.min(previewData.videos.length, 50),\n      });\n    },\n    onSuccess: (data) => {\n      setImportResult(data);\n      setStep(\"success\");\n      \n      toast({\n        title: \"Â¡ImportaciÃ³n completada!\",\n        description: `Se importaron ${data.imported} episodio${data.imported !== 1 ? 's' : ''}`,\n      });\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/my-podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error al importar\",\n        description: error.message,\n      });\n    },\n  });\n\n  const handlePreview = (data: z.infer<typeof previewSchema>) => {\n    setPodcastConfig({\n      playlistUrl: data.playlistUrl,\n      visibility: \"PUBLIC\",\n    });\n    previewMutation.mutate(data);\n  };\n\n  const toggleVideo = (videoId: string) => {\n    setSelectedVideoIds(prev => \n      prev.includes(videoId) \n        ? prev.filter(id => id !== videoId)\n        : [...prev, videoId]\n    );\n  };\n\n  const toggleAll = () => {\n    if (!previewData) return;\n    if (selectedVideoIds.length === previewData.videos.length) {\n      setSelectedVideoIds([]);\n    } else {\n      setSelectedVideoIds(previewData.videos.map(v => v.videoId));\n    }\n  };\n\n  const handleBack = () => {\n    if (step === \"select\") {\n      setStep(\"config\");\n      setPreviewData(null);\n      setSelectedVideoIds([]);\n    } else if (step === \"success\") {\n      setStep(\"config\");\n      setPreviewData(null);\n      setSelectedVideoIds([]);\n      setImportResult(null);\n      setPodcastConfig(null);\n      previewForm.reset();\n    }\n  };\n\n  const handleViewPodcast = () => {\n    if (importResult?.podcast?.id) {\n      setLocation(`/podcast/${importResult.podcast.id}`);\n    }\n  };\n\n  const formatDuration = (seconds: number) => {\n    const hrs = Math.floor(seconds / 3600);\n    const mins = Math.floor((seconds % 3600) / 60);\n    const secs = seconds % 60;\n    if (hrs > 0) return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  return (\n    <div className=\"container max-w-6xl mx-auto p-6 space-y-6\" data-testid=\"page-import-youtube\">\n      {/* Header */}\n      <div className=\"flex items-center gap-4\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => step === \"config\" ? setLocation(\"/my-podcasts\") : handleBack()}\n          data-testid=\"button-back\"\n        >\n          <ArrowLeft className=\"h-5 w-5\" />\n        </Button>\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">\n            Importar desde YouTube\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            {step === \"config\" && \"Paso 1: ConfiguraciÃ³n de la playlist\"}\n            {step === \"select\" && `Paso 2: Selecciona los videos a importar (${selectedVideoIds.length} de ${previewData?.videos.length || 0})`}\n            {step === \"success\" && \"ImportaciÃ³n completada\"}\n          </p>\n        </div>\n      </div>\n\n      {/* Warning Card */}\n      <Alert className=\"border-yellow-500 dark:border-yellow-700 bg-yellow-50 dark:bg-yellow-900/20\">\n        <AlertTriangle className=\"h-4 w-4 text-yellow-600 dark:text-yellow-400\" />\n        <AlertDescription className=\"text-yellow-900 dark:text-yellow-100\">\n          <strong>Aviso Legal:</strong> Esta funcionalidad descarga audio de YouTube. Ãšsala solo con contenido del cual tengas\n          derechos o permiso explÃ­cito del creador. El uso indebido puede violar los TÃ©rminos de Servicio de YouTube.\n        </AlertDescription>\n      </Alert>\n\n      {/* Step 1: Configuration */}\n      {step === \"config\" && (\n        <>\n          <Alert>\n            <Info className=\"h-4 w-4\" />\n            <AlertDescription>\n              <strong>Â¿CÃ³mo funciona?</strong> Ingresa la URL de una lista de reproducciÃ³n pÃºblica de YouTube.\n              PodrÃ¡s ver todos los videos y seleccionar cuÃ¡les importar antes de procesar.\n            </AlertDescription>\n          </Alert>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Youtube className=\"h-5 w-5\" />\n                ConfiguraciÃ³n de ImportaciÃ³n\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <Form {...previewForm}>\n                <form onSubmit={previewForm.handleSubmit(handlePreview)} className=\"space-y-4\">\n                  <FormField\n                    control={previewForm.control}\n                    name=\"playlistUrl\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>URL de la Playlist</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"https://www.youtube.com/playlist?list=PLxxxxxx\"\n                            {...field}\n                            disabled={previewMutation.isPending}\n                            data-testid=\"input-playlist-url\"\n                          />\n                        </FormControl>\n                        <FormDescription>\n                          Debe ser una playlist pÃºblica de YouTube\n                        </FormDescription>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={previewForm.control}\n                    name=\"maxVideos\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>NÃºmero MÃ¡ximo de Videos</FormLabel>\n                        <FormControl>\n                          <Input\n                            type=\"number\"\n                            min={1}\n                            max={50}\n                            value={field.value}\n                            onChange={(e) => {\n                              const value = e.target.value === '' ? '' : Number(e.target.value);\n                              field.onChange(value);\n                            }}\n                            onBlur={field.onBlur}\n                            name={field.name}\n                            disabled={previewMutation.isPending}\n                            data-testid=\"input-max-videos\"\n                          />\n                        </FormControl>\n                        <FormDescription>\n                          MÃ¡ximo de videos a mostrar para selecciÃ³n (1-50)\n                        </FormDescription>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <Button\n                    type=\"submit\"\n                    disabled={previewMutation.isPending}\n                    className=\"w-full\"\n                    data-testid=\"button-preview\"\n                  >\n                    {previewMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                        Obteniendo informaciÃ³n...\n                      </>\n                    ) : (\n                      <>\n                        <Youtube className=\"mr-2 h-4 w-4\" />\n                        Ver Playlist y Seleccionar Videos\n                      </>\n                    )}\n                  </Button>\n                </form>\n              </Form>\n            </CardContent>\n          </Card>\n        </>\n      )}\n\n      {/* Step 2: Video Selection */}\n      {step === \"select\" && previewData && (\n        <>\n          <Card>\n            <CardHeader>\n              <CardTitle>InformaciÃ³n de la Playlist</CardTitle>\n              <CardDescription>{previewData.playlist.channelTitle}</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex gap-4\">\n                {previewData.playlist.thumbnailUrl && (\n                  <img \n                    src={previewData.playlist.thumbnailUrl} \n                    alt={previewData.playlist.title}\n                    className=\"w-32 h-32 object-cover rounded\"\n                  />\n                )}\n                <div className=\"flex-1\">\n                  <h3 className=\"font-semibold text-lg\">{previewData.playlist.title}</h3>\n                  <p className=\"text-sm text-muted-foreground mt-1\">{previewData.playlist.description}</p>\n                </div>\n              </div>\n\n              <div className=\"space-y-3\">\n                <Label>TÃ­tulo del Podcast (Opcional)</Label>\n                <Input\n                  placeholder={previewData.playlist.title}\n                  value={podcastConfig?.title || \"\"}\n                  onChange={(e) => setPodcastConfig(prev => ({ ...prev!, title: e.target.value }))}\n                  data-testid=\"input-podcast-title\"\n                />\n                \n                <Label>DescripciÃ³n (Opcional)</Label>\n                <Textarea\n                  placeholder={previewData.playlist.description}\n                  value={podcastConfig?.description || \"\"}\n                  onChange={(e) => setPodcastConfig(prev => ({ ...prev!, description: e.target.value }))}\n                  rows={3}\n                  data-testid=\"input-podcast-description\"\n                />\n\n                <div>\n                  <Label>Visibilidad</Label>\n                  <Select \n                    value={podcastConfig?.visibility}\n                    onValueChange={(value: any) => setPodcastConfig(prev => ({ ...prev!, visibility: value }))}\n                  >\n                    <SelectTrigger data-testid=\"select-visibility\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"PUBLIC\">PÃºblico - Visible para todos</SelectItem>\n                      <SelectItem value=\"UNLISTED\">No listado - Solo con enlace</SelectItem>\n                      <SelectItem value=\"PRIVATE\">Privado - Solo tÃº</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0\">\n              <div>\n                <CardTitle>Selecciona Videos ({selectedVideoIds.length}/{previewData.videos.length})</CardTitle>\n                <CardDescription>Marca los videos que deseas importar como episodios</CardDescription>\n              </div>\n              <Button variant=\"outline\" onClick={toggleAll} size=\"sm\">\n                {selectedVideoIds.length === previewData.videos.length ? \"Deseleccionar Todos\" : \"Seleccionar Todos\"}\n              </Button>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3 max-h-[500px] overflow-y-auto\">\n                {previewData.videos.map((video) => (\n                  <div\n                    key={video.videoId}\n                    className=\"flex items-start gap-3 p-3 border rounded hover-elevate\"\n                    data-testid={`video-item-${video.videoId}`}\n                  >\n                    <Checkbox\n                      checked={selectedVideoIds.includes(video.videoId)}\n                      onCheckedChange={() => toggleVideo(video.videoId)}\n                      data-testid={`checkbox-${video.videoId}`}\n                    />\n                    <img \n                      src={video.thumbnailUrl} \n                      alt={video.title}\n                      className=\"w-24 h-16 object-cover rounded flex-shrink-0\"\n                    />\n                    <div className=\"flex-1 min-w-0\">\n                      <h4 className=\"font-medium text-sm line-clamp-2\">{video.title}</h4>\n                      <p className=\"text-xs text-muted-foreground line-clamp-1 mt-1\">{video.description}</p>\n                      <div className=\"flex items-center gap-3 mt-2 text-xs text-muted-foreground\">\n                        <span className=\"flex items-center gap-1\">\n                          <Clock className=\"h-3 w-3\" />\n                          {formatDuration(video.duration)}\n                        </span>\n                        <span>{new Date(video.publishedAt).toLocaleDateString()}</span>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n\n              <div className=\"mt-6 space-y-3\">\n                <Alert>\n                  <Info className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    La importaciÃ³n puede tardar varios minutos. Se descargarÃ¡ el audio de cada video seleccionado\n                    y se crearÃ¡ un episodio de podcast. El proceso es: {selectedVideoIds.length} video{selectedVideoIds.length !== 1 ? 's' : ''} Ã— ~30 segundos/video = ~{Math.ceil(selectedVideoIds.length * 0.5)} minuto{Math.ceil(selectedVideoIds.length * 0.5) !== 1 ? 's' : ''}.\n                  </AlertDescription>\n                </Alert>\n\n                <Button\n                  onClick={() => importMutation.mutate()}\n                  disabled={importMutation.isPending || selectedVideoIds.length === 0}\n                  className=\"w-full\"\n                  data-testid=\"button-import\"\n                >\n                  {importMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Importando {selectedVideoIds.length} video{selectedVideoIds.length !== 1 ? 's' : ''}... Esto tomarÃ¡ varios minutos\n                    </>\n                  ) : (\n                    <>\n                      <Youtube className=\"mr-2 h-4 w-4\" />\n                      Importar {selectedVideoIds.length} Video{selectedVideoIds.length !== 1 ? 's' : ''} Seleccionado{selectedVideoIds.length !== 1 ? 's' : ''}\n                    </>\n                  )}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </>\n      )}\n\n      {/* Step 3: Success */}\n      {step === \"success\" && importResult && (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <Alert className=\"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800\">\n              <CheckCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n              <AlertDescription className=\"text-green-900 dark:text-green-100\">\n                <div className=\"space-y-2\">\n                  <p className=\"font-semibold\" data-testid=\"text-success-message\">{importResult.message}</p>\n                  <div className=\"text-sm space-y-1\">\n                    <p>â€¢ Episodios importados: {importResult.imported}</p>\n                    {importResult.skipped > 0 && (\n                      <p>â€¢ Videos omitidos: {importResult.skipped}</p>\n                    )}\n                  </div>\n                  {importResult.errors && importResult.errors.length > 0 && (\n                    <div className=\"mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-sm\">\n                      <p className=\"font-semibold mb-1\">Advertencias:</p>\n                      <ul className=\"list-disc list-inside space-y-1\">\n                        {importResult.errors.map((err, idx) => (\n                          <li key={idx}>{err}</li>\n                        ))}\n                      </ul>\n                    </div>\n                  )}\n                  <div className=\"flex gap-2 mt-4\">\n                    <Button onClick={handleViewPodcast} data-testid=\"button-view-podcast\">\n                      Ver Podcast\n                    </Button>\n                    <Button variant=\"outline\" onClick={handleBack} data-testid=\"button-import-another\">\n                      Importar Otra Playlist\n                    </Button>\n                  </div>\n                </div>\n              </AlertDescription>\n            </Alert>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":20308,"size_tokens":null},"client/src/pages/user-guide.tsx":{"content":"import { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { BookOpen, Shield, Mic, Headphones } from \"lucide-react\";\n\nexport default function UserGuide() {\n  return (\n    <div className=\"min-h-screen pb-8\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background border-b\">\n        <div className=\"max-w-5xl mx-auto px-6 py-12\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <BookOpen className=\"h-10 w-10 text-primary\" />\n            <h1 className=\"text-4xl font-bold font-[Outfit]\">Manual de Uso</h1>\n          </div>\n          <p className=\"text-muted-foreground text-lg\">\n            GuÃ­a completa para aprovechar al mÃ¡ximo PodcastHub segÃºn tu rol\n          </p>\n        </div>\n      </div>\n\n      <div className=\"max-w-5xl mx-auto px-6 py-8\">\n        <Tabs defaultValue=\"listener\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-3 mb-8\">\n            <TabsTrigger value=\"listener\" className=\"gap-2\" data-testid=\"tab-listener\">\n              <Headphones className=\"h-4 w-4\" />\n              Oyentes\n            </TabsTrigger>\n            <TabsTrigger value=\"creator\" className=\"gap-2\" data-testid=\"tab-creator\">\n              <Mic className=\"h-4 w-4\" />\n              Creadores\n            </TabsTrigger>\n            <TabsTrigger value=\"admin\" className=\"gap-2\" data-testid=\"tab-admin\">\n              <Shield className=\"h-4 w-4\" />\n              Administradores\n            </TabsTrigger>\n          </TabsList>\n\n          {/* OYENTES */}\n          <TabsContent value=\"listener\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Headphones className=\"h-5 w-5 text-primary\" />\n                  GuÃ­a para Oyentes\n                </CardTitle>\n                <CardDescription>\n                  Aprende a descubrir, escuchar y organizar tus podcasts favoritos\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  <AccordionItem value=\"item-1\">\n                    <AccordionTrigger>Explorar Podcasts</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Descubrir contenido:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Ve a <strong>\"Explorar\"</strong> en el menÃº lateral para ver todos los podcasts pÃºblicos disponibles</li>\n                          <li>Usa el campo de bÃºsqueda para encontrar podcasts por tÃ­tulo o descripciÃ³n</li>\n                          <li>Haz clic en cualquier podcast para ver sus episodios y detalles</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-2\">\n                    <AccordionTrigger>Suscribirse a Podcasts</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Gestionar tus suscripciones:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>En la pÃ¡gina de cualquier podcast, haz clic en el botÃ³n <strong>\"Suscribirse\"</strong> (icono de corazÃ³n)</li>\n                          <li>Los podcasts suscritos aparecerÃ¡n en <strong>\"Mi Biblioteca\"</strong> en el menÃº lateral</li>\n                          <li>Para desuscribirte, vuelve al podcast y haz clic en <strong>\"Desuscribirse\"</strong></li>\n                          <li>Tu biblioteca te permite acceder rÃ¡pidamente a tus podcasts favoritos</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-3\">\n                    <AccordionTrigger>Buscar y Filtrar Episodios</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Encontrar episodios especÃ­ficos:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Dentro de cada podcast, usa el <strong>campo de bÃºsqueda</strong> para filtrar episodios por tÃ­tulo o contenido</li>\n                          <li>Usa el <strong>selector de ordenamiento</strong> para organizar episodios por:\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>MÃ¡s recientes primero / MÃ¡s antiguos primero</li>\n                              <li>Orden alfabÃ©tico (A-Z / Z-A)</li>\n                              <li>No escuchados primero</li>\n                            </ul>\n                          </li>\n                          <li>Los episodios se marcan automÃ¡ticamente como \"escuchados\" cuando completas el 80% de reproducciÃ³n</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-4\">\n                    <AccordionTrigger>Reproducir Episodios</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Controles del reproductor:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Haz clic en el botÃ³n <strong>\"Play\"</strong> de cualquier episodio para reproducirlo</li>\n                          <li>El reproductor aparece en la parte inferior de la pantalla</li>\n                          <li>Controles disponibles: play/pausa, barra de progreso, control de volumen</li>\n                          <li>Puedes navegar por el sitio mientras el audio continÃºa reproduciÃ©ndose</li>\n                          <li>La barra de progreso te permite adelantar o retroceder en el episodio</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-5\">\n                    <AccordionTrigger>Compartir y RSS</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Compartir contenido:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Usa el botÃ³n <strong>\"Compartir\"</strong> para obtener enlaces y cÃ³digos de embed</li>\n                          <li>Comparte episodios individuales o podcasts completos en redes sociales</li>\n                          <li>Copia el cÃ³digo embed para incrustar episodios en tu sitio web</li>\n                          <li>Accede al <strong>Feed RSS</strong> desde el icono RSS en cada podcast para agregarlo a tu lector favorito</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-6\">\n                    <AccordionTrigger>Gestionar tu Perfil</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Personalizar tu cuenta:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Haz clic en tu <strong>avatar</strong> (esquina superior derecha) y selecciona <strong>\"Mi Perfil\"</strong></li>\n                          <li>Actualiza tu nombre de usuario y correo electrÃ³nico</li>\n                          <li>Cambia tu contraseÃ±a desde la opciÃ³n <strong>\"Cambiar ContraseÃ±a\"</strong></li>\n                          <li>Verifica tu correo electrÃ³nico si aÃºn no lo has hecho</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n                </Accordion>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* CREADORES */}\n          <TabsContent value=\"creator\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Mic className=\"h-5 w-5 text-primary\" />\n                  GuÃ­a para Creadores\n                </CardTitle>\n                <CardDescription>\n                  Aprende a crear, gestionar y distribuir tus podcasts\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  <AccordionItem value=\"item-1\">\n                    <AccordionTrigger>Crear tu Primer Podcast</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Paso a paso:</strong></p>\n                        <ol className=\"list-decimal pl-6 space-y-2\">\n                          <li>Ve a <strong>\"Mis Podcasts\"</strong> en el menÃº lateral</li>\n                          <li>Haz clic en <strong>\"Crear Podcast\"</strong></li>\n                          <li>Completa la informaciÃ³n requerida:\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li><strong>TÃ­tulo:</strong> Nombre de tu podcast</li>\n                              <li><strong>DescripciÃ³n:</strong> Resume de quÃ© trata tu contenido</li>\n                              <li><strong>Cover Art:</strong> Sube una imagen cuadrada (recomendado 1400x1400px, mÃ¡x 2MB)</li>\n                              <li><strong>CategorÃ­a:</strong> Selecciona la mÃ¡s apropiada</li>\n                              <li><strong>Idioma:</strong> Idioma principal del contenido</li>\n                            </ul>\n                          </li>\n                          <li>Configura la <strong>privacidad</strong>:\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li><strong>PÃºblico:</strong> Visible para todos</li>\n                              <li><strong>No listado:</strong> Solo accesible con el enlace + invitaciones por email</li>\n                              <li><strong>Privado:</strong> Solo tÃº puedes verlo + invitaciones por email</li>\n                            </ul>\n                          </li>\n                          <li>Opcionalmente, agrega el primer episodio en el mismo formulario</li>\n                          <li>Haz clic en <strong>\"Crear Podcast\"</strong></li>\n                        </ol>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-1-5\">\n                    <AccordionTrigger>Importar Podcasts desde RSS o Carpeta Local</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-4 text-sm\">\n                        <div>\n                          <p className=\"font-semibold mb-2\">ðŸ“¡ OpciÃ³n 1: Importar desde Feed RSS (Creadores y Administradores)</p>\n                          <ol className=\"list-decimal pl-6 space-y-2\">\n                            <li>Ve a <strong>\"Mis Podcasts\"</strong> y haz clic en <strong>\"Importar RSS\"</strong></li>\n                            <li>Pega la URL del feed RSS del podcast:\n                              <ul className=\"list-circle pl-6 mt-1\">\n                                <li><strong>Spotify:</strong> Busca \"nombre del podcast RSS feed\" en Google</li>\n                                <li><strong>Apple Podcasts:</strong> La URL RSS suele estar en la pÃ¡gina del podcast</li>\n                                <li><strong>iVoox:</strong> Busca el Ã­cono RSS en la pÃ¡gina del podcast</li>\n                                <li><strong>Otros servicios:</strong> La mayorÃ­a tienen un enlace RSS visible</li>\n                              </ul>\n                            </li>\n                            <li>Configura las opciones:\n                              <ul className=\"list-circle pl-6 mt-1\">\n                                <li><strong>Cantidad mÃ¡xima de episodios:</strong> Hasta 50 episodios (por defecto 10)</li>\n                                <li><strong>Visibilidad:</strong> PÃºblico, No listado o Privado</li>\n                              </ul>\n                            </li>\n                            <li>Haz clic en <strong>\"Importar Podcast\"</strong></li>\n                            <li>El sistema importarÃ¡ automÃ¡ticamente:\n                              <ul className=\"list-circle pl-6 mt-1\">\n                                <li>InformaciÃ³n del podcast (tÃ­tulo, descripciÃ³n, cover art)</li>\n                                <li>Los episodios mÃ¡s recientes (segÃºn la cantidad configurada)</li>\n                                <li>Metadatos completos de cada episodio</li>\n                                <li>Enlaces a los archivos de audio originales</li>\n                              </ul>\n                            </li>\n                            <li><strong>Nota:</strong> La importaciÃ³n RSS toma los episodios tal como estÃ¡n en el feed original. No se descargan los archivos de audio localmente.</li>\n                            <li>El contenido queda <strong>pendiente de aprobaciÃ³n</strong> por un administrador</li>\n                          </ol>\n                        </div>\n                        <div className=\"border-t pt-4\">\n                          <p className=\"font-semibold mb-2\">ðŸ“ OpciÃ³n 2: Importar desde Carpeta Local (Solo Administradores)</p>\n                          <p className=\"text-muted-foreground mb-3 text-xs italic\">\n                            Sube mÃºltiples archivos MP3 desde tu ordenador para crear un podcast completo\n                          </p>\n                          \n                          <div className=\"space-y-3\">\n                            <div>\n                              <p className=\"font-medium text-primary\">CÃ³mo funciona:</p>\n                              <ol className=\"list-decimal pl-6 space-y-1 mt-1\">\n                                <li>Ve a <strong>\"Mis Podcasts\"</strong> (el botÃ³n solo aparece para administradores)</li>\n                                <li>Haz clic en <strong>\"Importar Carpeta Local\"</strong></li>\n                                <li>Selecciona mÃºltiples archivos MP3 de tu ordenador (mÃ¡ximo 50 archivos)</li>\n                                <li>Opcionalmente, sube una imagen de cover art para el podcast</li>\n                                <li>Completa la informaciÃ³n del podcast:\n                                  <ul className=\"list-circle pl-6 mt-1\">\n                                    <li><strong>TÃ­tulo del Podcast:</strong> Nombre del podcast que se crearÃ¡</li>\n                                    <li><strong>DescripciÃ³n:</strong> Describe de quÃ© trata tu contenido</li>\n                                    <li><strong>CategorÃ­a:</strong> Clasifica tu podcast</li>\n                                    <li><strong>Idioma:</strong> Idioma del contenido</li>\n                                    <li><strong>Visibilidad:</strong> PÃºblico, No listado o Privado</li>\n                                  </ul>\n                                </li>\n                                <li>Haz clic en <strong>\"Importar Podcast\"</strong></li>\n                              </ol>\n                            </div>\n\n                            <div>\n                              <p className=\"font-medium text-primary\">QuÃ© sucede durante la importaciÃ³n:</p>\n                              <ul className=\"list-disc pl-6 space-y-1\">\n                                <li>Se crea automÃ¡ticamente un nuevo podcast con la informaciÃ³n proporcionada</li>\n                                <li>Cada archivo MP3 se convierte en un episodio individual:\n                                  <ul className=\"list-circle pl-6 mt-1\">\n                                    <li><strong>TÃ­tulo del episodio:</strong> Se extrae del nombre del archivo</li>\n                                    <li><strong>Audio:</strong> Se sube a tu sistema de almacenamiento (local o Google Drive)</li>\n                                    <li><strong>Cover Art:</strong> Hereda la imagen del podcast (si la proporcionaste)</li>\n                                  </ul>\n                                </li>\n                                <li>VerÃ¡s una <strong>barra de progreso</strong> durante el proceso de subida</li>\n                                <li>Al finalizar, se muestra un resumen con el nÃºmero de episodios importados</li>\n                              </ul>\n                            </div>\n                          </div>\n\n                          <div className=\"mt-4 space-y-2\">\n                            <div className=\"p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-xs\">\n                              <strong>ðŸ’¡ Ventajas de la importaciÃ³n local:</strong>\n                              <ul className=\"list-disc pl-4 mt-1 space-y-0.5\">\n                                <li>Ideal para migrar contenido desde otras plataformas</li>\n                                <li>Perfecto para subir grabaciones masivas de conferencias o cursos</li>\n                                <li>Todos los archivos se suben a la vez, ahorrando tiempo</li>\n                                <li>Control total sobre la calidad del audio (sin conversiones adicionales)</li>\n                              </ul>\n                            </div>\n                            <div className=\"p-2 bg-gray-50 dark:bg-gray-900/20 rounded text-xs\">\n                              <strong>ðŸ“Š LÃ­mites tÃ©cnicos:</strong>\n                              <ul className=\"list-disc pl-4 mt-1 space-y-0.5\">\n                                <li>MÃ¡ximo 50 archivos MP3 por importaciÃ³n</li>\n                                <li>TamaÃ±o mÃ¡ximo por archivo: 500MB</li>\n                                <li>Solo archivos de audio en formato MP3</li>\n                                <li>Los tÃ­tulos de episodios se pueden editar despuÃ©s de la importaciÃ³n</li>\n                              </ul>\n                            </div>\n                            <div className=\"p-2 bg-green-50 dark:bg-green-900/20 rounded text-xs\">\n                              <strong>âœ… Consejos para mejores resultados:</strong>\n                              <ul className=\"list-disc pl-4 mt-1 space-y-0.5\">\n                                <li>Nombra tus archivos de forma descriptiva (ej: \"01 - IntroducciÃ³n.mp3\")</li>\n                                <li>AsegÃºrate de que todos los archivos estÃ©n en formato MP3</li>\n                                <li>Prepara una imagen cuadrada de cover art (1400x1400px recomendado)</li>\n                                <li>Revisa los episodios despuÃ©s de importar para ajustar tÃ­tulos y descripciones</li>\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-2\">\n                    <AccordionTrigger>AÃ±adir Episodios</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Publicar nuevo episodio:</strong></p>\n                        <ol className=\"list-decimal pl-6 space-y-2\">\n                          <li>Entra a tu podcast desde <strong>\"Mis Podcasts\"</strong></li>\n                          <li>Haz clic en <strong>\"AÃ±adir Episodio\"</strong></li>\n                          <li>Completa la informaciÃ³n:\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li><strong>TÃ­tulo:</strong> Nombre del episodio</li>\n                              <li><strong>DescripciÃ³n/Notas:</strong> Detalles del episodio, temas tratados, timestamps, etc.</li>\n                              <li><strong>Cover Art (opcional):</strong> Imagen especÃ­fica para este episodio</li>\n                              <li><strong>Archivo de Audio (obligatorio):</strong> Sube tu archivo MP3/M4A (mÃ¡x 500MB)</li>\n                              <li><strong>DuraciÃ³n:</strong> Se detecta automÃ¡ticamente o ingrÃ©sala manualmente</li>\n                            </ul>\n                          </li>\n                          <li>Configura la privacidad del episodio (puede ser diferente a la del podcast)</li>\n                          <li>Haz clic en <strong>\"Crear Episodio\"</strong></li>\n                          <li>El episodio queda pendiente de aprobaciÃ³n por un administrador</li>\n                        </ol>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-3\">\n                    <AccordionTrigger>Gestionar Privacidad e Invitaciones</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Control de acceso:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li><strong>Cambiar privacidad:</strong> Edita tu podcast o episodio y cambia la configuraciÃ³n de visibilidad</li>\n                          <li><strong>Gestionar invitaciones:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Para contenido <strong>No listado</strong> o <strong>Privado</strong>, aparece el botÃ³n <strong>\"Gestionar Invitaciones\"</strong></li>\n                              <li>Ingresa correos electrÃ³nicos de personas que quieres invitar</li>\n                              <li>Cada persona invitada puede acceder al contenido aunque sea privado</li>\n                              <li>Puedes eliminar invitaciones en cualquier momento</li>\n                            </ul>\n                          </li>\n                          <li>Las invitaciones funcionan tanto a nivel de podcast como de episodio individual</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-4\">\n                    <AccordionTrigger>Editar Podcasts y Episodios</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Actualizar tu contenido:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Desde <strong>\"Mis Podcasts\"</strong>, haz clic en el podcast que quieres editar</li>\n                          <li>Usa el botÃ³n <strong>\"Editar\"</strong> para modificar informaciÃ³n del podcast</li>\n                          <li>Para editar un episodio:\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Haz clic en el episodio para ver sus detalles</li>\n                              <li>Haz clic en <strong>\"Editar\"</strong></li>\n                              <li>Puedes cambiar tÃ­tulo, descripciÃ³n, cover art y privacidad</li>\n                              <li>No puedes cambiar el archivo de audio de un episodio ya publicado</li>\n                            </ul>\n                          </li>\n                          <li>Los cambios en podcasts pueden requerir aprobaciÃ³n del administrador</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-5\">\n                    <AccordionTrigger>Distribuir con RSS</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Alcance mÃ¡s allÃ¡ de la plataforma:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Cada podcast tiene un <strong>Feed RSS automÃ¡tico</strong> compatible con iTunes/Apple Podcasts</li>\n                          <li>Accede al feed desde el icono RSS en la pÃ¡gina de tu podcast</li>\n                          <li>Copia la URL del RSS para enviarlo a:\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Apple Podcasts</li>\n                              <li>Spotify</li>\n                              <li>Google Podcasts</li>\n                              <li>Cualquier app de podcasts que soporte RSS</li>\n                            </ul>\n                          </li>\n                          <li>El feed se actualiza automÃ¡ticamente cuando publicas nuevos episodios</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-6\">\n                    <AccordionTrigger>Estados de ModeraciÃ³n</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Proceso de aprobaciÃ³n:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li><strong>Borrador:</strong> Contenido guardado pero no enviado para revisiÃ³n</li>\n                          <li><strong>Pendiente de AprobaciÃ³n:</strong> Enviado a los administradores para revisiÃ³n</li>\n                          <li><strong>Aprobado:</strong> Contenido publicado y visible segÃºn configuraciÃ³n de privacidad</li>\n                          <li><strong>Rechazado:</strong> El administrador rechazÃ³ el contenido (recibirÃ¡s notificaciÃ³n)</li>\n                          <li>VerÃ¡s indicadores de estado en tus podcasts y episodios</li>\n                          <li>Solo el contenido aprobado es visible pÃºblicamente</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-7\">\n                    <AccordionTrigger>Buenas PrÃ¡cticas</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Recomendaciones:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li><strong>Cover Art:</strong> Usa imÃ¡genes de alta calidad, cuadradas, con texto legible incluso en tamaÃ±o pequeÃ±o</li>\n                          <li><strong>Audio:</strong> Exporta en formato MP3 o M4A, bitrate de 128-192 kbps es suficiente</li>\n                          <li><strong>TÃ­tulos:</strong> SÃ© descriptivo pero conciso, evita clickbait</li>\n                          <li><strong>Descripciones:</strong> Incluye timestamps, menciona temas importantes, enlaces relevantes</li>\n                          <li><strong>Consistencia:</strong> MantÃ©n un horario regular de publicaciÃ³n</li>\n                          <li><strong>SEO:</strong> Usa palabras clave relevantes en tÃ­tulos y descripciones</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n                </Accordion>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* ADMINISTRADORES */}\n          <TabsContent value=\"admin\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Shield className=\"h-5 w-5 text-primary\" />\n                  GuÃ­a para Administradores\n                </CardTitle>\n                <CardDescription>\n                  GestiÃ³n completa de usuarios, contenido y configuraciÃ³n de la plataforma\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  <AccordionItem value=\"item-1\">\n                    <AccordionTrigger>Panel de AdministraciÃ³n</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Acceso al panel:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Como administrador, verÃ¡s la secciÃ³n <strong>\"AdministraciÃ³n\"</strong> en el menÃº lateral</li>\n                          <li>Opciones disponibles:\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li><strong>Dashboard:</strong> Vista general de estadÃ­sticas</li>\n                              <li><strong>Usuarios:</strong> GestiÃ³n de cuentas de usuarios</li>\n                              <li><strong>Podcasts:</strong> ModeraciÃ³n de podcasts</li>\n                              <li><strong>Episodios:</strong> ModeraciÃ³n de episodios</li>\n                              <li><strong>Email Config:</strong> ConfiguraciÃ³n de correo electrÃ³nico</li>\n                              <li><strong>Google Drive:</strong> ConfiguraciÃ³n de almacenamiento</li>\n                            </ul>\n                          </li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-2\">\n                    <AccordionTrigger>GestiÃ³n de Usuarios</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Administrar cuentas:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li><strong>Ver todos los usuarios:</strong> Accede a la lista completa desde \"Usuarios\"</li>\n                          <li><strong>Cambiar roles:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li><strong>LISTENER:</strong> Solo puede escuchar podcasts</li>\n                              <li><strong>CREATOR:</strong> Puede crear y gestionar podcasts</li>\n                              <li><strong>ADMIN:</strong> Acceso total a la plataforma</li>\n                            </ul>\n                          </li>\n                          <li><strong>Activar/Desactivar usuarios:</strong> Bloquea o reactiva cuentas individualmente</li>\n                          <li><strong>Operaciones masivas:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Selecciona mÃºltiples usuarios con checkboxes</li>\n                              <li>Activa o desactiva hasta 50 usuarios a la vez</li>\n                              <li>Elimina cuentas en lote si es necesario</li>\n                            </ul>\n                          </li>\n                          <li><strong>BÃºsqueda y filtros:</strong> Encuentra usuarios por nombre o email</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-3\">\n                    <AccordionTrigger>ModeraciÃ³n de Podcasts</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Revisar y aprobar podcasts:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Ve a <strong>\"Podcasts\"</strong> en el panel de administraciÃ³n</li>\n                          <li><strong>Filtrar por estado:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Pendientes de aprobaciÃ³n</li>\n                              <li>Aprobados</li>\n                              <li>Rechazados</li>\n                              <li>Todos</li>\n                            </ul>\n                          </li>\n                          <li><strong>Revisar contenido:</strong> Haz clic en un podcast para ver todos sus detalles</li>\n                          <li><strong>Aprobar o rechazar:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Selecciona podcasts individuales o mÃºltiples</li>\n                              <li>Usa los botones de acciÃ³n para aprobar o rechazar</li>\n                              <li>Los creadores reciben notificaciones del cambio de estado</li>\n                            </ul>\n                          </li>\n                          <li><strong>Editar contenido:</strong> Puedes editar cualquier podcast si es necesario</li>\n                          <li><strong>Eliminar podcasts:</strong> Elimina contenido inapropiado (acciÃ³n irreversible)</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-4\">\n                    <AccordionTrigger>ModeraciÃ³n de Episodios</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>GestiÃ³n de episodios:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Accede a <strong>\"Episodios\"</strong> para ver todos los episodios de la plataforma</li>\n                          <li><strong>Filtros disponibles:</strong> Por estado de moderaciÃ³n, bÃºsqueda por tÃ­tulo</li>\n                          <li><strong>Proceso de aprobaciÃ³n:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Revisa episodios pendientes</li>\n                              <li>Escucha el audio si es necesario</li>\n                              <li>Aprueba episodios que cumplan las polÃ­ticas</li>\n                              <li>Rechaza contenido inapropiado con notificaciÃ³n al creador</li>\n                            </ul>\n                          </li>\n                          <li><strong>Operaciones masivas:</strong> Aprueba o rechaza mÃºltiples episodios a la vez (mÃ¡x 50)</li>\n                          <li><strong>Editar episodios:</strong> Modifica metadata si encuentras errores</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-5\">\n                    <AccordionTrigger>ConfiguraciÃ³n de Email</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>SMTP y notificaciones:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Ve a <strong>\"Email Config\"</strong> para configurar el servidor de correo</li>\n                          <li><strong>ConfiguraciÃ³n SMTP:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Host: Servidor SMTP (ej: smtp.gmail.com)</li>\n                              <li>Puerto: Generalmente 587 (TLS) o 465 (SSL)</li>\n                              <li>Usuario: Tu cuenta de correo</li>\n                              <li>ContraseÃ±a: ContraseÃ±a de aplicaciÃ³n</li>\n                              <li>Nombre del remitente: Ej: \"PodcastHub Notificaciones\"</li>\n                            </ul>\n                          </li>\n                          <li><strong>Probar configuraciÃ³n:</strong> EnvÃ­a un email de prueba antes de activar</li>\n                          <li><strong>Tipos de emails automÃ¡ticos:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Bienvenida a nuevos usuarios</li>\n                              <li>VerificaciÃ³n de correo electrÃ³nico</li>\n                              <li>RecuperaciÃ³n de contraseÃ±a</li>\n                              <li>Notificaciones de moderaciÃ³n (aprobaciones/rechazos)</li>\n                            </ul>\n                          </li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-6\">\n                    <AccordionTrigger>ConfiguraciÃ³n de Google Drive</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>Almacenamiento en la nube:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li>Accede a <strong>\"Google Drive\"</strong> para configurar almacenamiento externo</li>\n                          <li><strong>ConfiguraciÃ³n:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Crea un proyecto en Google Cloud Console</li>\n                              <li>Habilita Google Drive API</li>\n                              <li>Genera credenciales de cuenta de servicio</li>\n                              <li>Descarga el archivo JSON de credenciales</li>\n                              <li>Copia el contenido en la configuraciÃ³n de la plataforma</li>\n                            </ul>\n                          </li>\n                          <li><strong>Beneficios:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Almacenamiento ilimitado (segÃºn plan de Google)</li>\n                              <li>Los archivos de audio se guardan en Drive automÃ¡ticamente</li>\n                              <li>Reduce costos de almacenamiento del servidor</li>\n                            </ul>\n                          </li>\n                          <li>Sin configurar Google Drive, los archivos se guardan localmente en el servidor</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-7\">\n                    <AccordionTrigger>Operaciones Masivas</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>GestiÃ³n eficiente:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li><strong>SelecciÃ³n mÃºltiple:</strong> Usa checkboxes para seleccionar hasta 50 elementos</li>\n                          <li><strong>Seleccionar todo:</strong> Checkbox en el encabezado selecciona todos los visibles</li>\n                          <li><strong>Acciones disponibles:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Aprobar/Rechazar contenido en lote</li>\n                              <li>Activar/Desactivar usuarios mÃºltiples</li>\n                              <li>Eliminar elementos seleccionados</li>\n                            </ul>\n                          </li>\n                          <li><strong>GestiÃ³n de errores:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>VerÃ¡s notificaciones separadas de Ã©xitos y fallos</li>\n                              <li>Los elementos fallidos permanecen seleccionados para reintentar</li>\n                              <li>Los exitosos se deseleccionan automÃ¡ticamente</li>\n                            </ul>\n                          </li>\n                          <li><strong>ProtecciÃ³n:</strong> Las operaciones destructivas requieren confirmaciÃ³n en diÃ¡logos</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"item-8\">\n                    <AccordionTrigger>Mejores PrÃ¡cticas de ModeraciÃ³n</AccordionTrigger>\n                    <AccordionContent>\n                      <div className=\"space-y-3 text-sm\">\n                        <p><strong>GuÃ­as para administradores:</strong></p>\n                        <ul className=\"list-disc pl-6 space-y-2\">\n                          <li><strong>Criterios de aprobaciÃ³n:</strong>\n                            <ul className=\"list-circle pl-6 mt-1\">\n                              <li>Contenido apropiado para la audiencia</li>\n                              <li>Sin infracciÃ³n de derechos de autor</li>\n                              <li>Metadata correcta y descriptiva</li>\n                              <li>Audio de calidad aceptable</li>\n                            </ul>\n                          </li>\n                          <li><strong>ComunicaciÃ³n:</strong> Al rechazar, considera enviar feedback al creador</li>\n                          <li><strong>Consistencia:</strong> Aplica los mismos estÃ¡ndares a todo el contenido</li>\n                          <li><strong>Privacidad:</strong> Respeta la configuraciÃ³n de privacidad de los creadores</li>\n                          <li><strong>Respaldo:</strong> MantÃ©n registro de decisiones importantes de moderaciÃ³n</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n                </Accordion>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":42085,"size_tokens":null},"client/src/pages/import-local.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { AlertCircle, Upload, FileAudio, Image, FolderOpen, CheckCircle2, XCircle } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nexport default function ImportLocal() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const [podcastTitle, setPodcastTitle] = useState(\"\");\n  const [podcastDescription, setPodcastDescription] = useState(\"\");\n  const [category, setCategory] = useState(\"Technology\");\n  const [language, setLanguage] = useState(\"es\");\n  const [visibility, setVisibility] = useState<\"PRIVATE\" | \"UNLISTED\" | \"PUBLIC\">(\"PUBLIC\");\n  const [audioFiles, setAudioFiles] = useState<File[]>([]);\n  const [coverArt, setCoverArt] = useState<File | null>(null);\n  const [importProgress, setImportProgress] = useState(0);\n\n  const importMutation = useMutation({\n    mutationFn: async (formData: FormData) => {\n      const response = await fetch(\"/api/import-local\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Error al importar archivos\");\n      }\n\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-podcasts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/podcasts\"] });\n      \n      toast({\n        title: \"Â¡ImportaciÃ³n Exitosa!\",\n        description: data.message,\n      });\n\n      // Show detailed results\n      if (data.errors && data.errors.length > 0) {\n        toast({\n          title: \"Algunos archivos no se pudieron importar\",\n          description: `${data.skipped} de ${data.totalFiles} archivos fallaron`,\n          variant: \"destructive\",\n        });\n      }\n\n      // Navigate to the podcast\n      setLocation(`/podcast/${data.podcast.id}`);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al importar\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setImportProgress(0);\n    },\n  });\n\n  const handleAudioFilesChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files) {\n      const files = Array.from(e.target.files);\n      const mp3Files = files.filter(file => \n        file.type === \"audio/mpeg\" || \n        file.type === \"audio/mp3\" ||\n        file.name.toLowerCase().endsWith('.mp3')\n      );\n\n      if (mp3Files.length !== files.length) {\n        toast({\n          title: \"Algunos archivos fueron omitidos\",\n          description: \"Solo se aceptan archivos MP3\",\n          variant: \"destructive\",\n        });\n      }\n\n      setAudioFiles(mp3Files);\n    }\n  };\n\n  const handleCoverArtChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n      setCoverArt(e.target.files[0]);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (audioFiles.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Debes seleccionar al menos un archivo de audio\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!podcastTitle.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"El tÃ­tulo del podcast es obligatorio\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!podcastDescription.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"La descripciÃ³n del podcast es obligatoria\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append(\"podcastTitle\", podcastTitle);\n    formData.append(\"podcastDescription\", podcastDescription);\n    formData.append(\"category\", category);\n    formData.append(\"language\", language);\n    formData.append(\"visibility\", visibility);\n\n    // Add all audio files\n    audioFiles.forEach(file => {\n      formData.append(\"audioFiles\", file);\n    });\n\n    // Add cover art if provided\n    if (coverArt) {\n      formData.append(\"coverArt\", coverArt);\n    }\n\n    setImportProgress(10);\n    importMutation.mutate(formData);\n  };\n\n  const removeAudioFile = (index: number) => {\n    setAudioFiles(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];\n  };\n\n  return (\n    <div className=\"container max-w-4xl mx-auto py-8 px-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FolderOpen className=\"h-6 w-6\" />\n            Importar Podcast desde Carpeta Local\n          </CardTitle>\n          <CardDescription>\n            Sube mÃºltiples archivos MP3 de tu ordenador para crear un podcast completo\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Alert className=\"mb-6\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription>\n              Esta funciÃ³n te permite crear un podcast importando mÃºltiples archivos de audio MP3 \n              desde tu ordenador. Cada archivo se convertirÃ¡ en un episodio individual del podcast.\n            </AlertDescription>\n          </Alert>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            {/* Audio Files Selection */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"audio-files\" className=\"flex items-center gap-2\">\n                <FileAudio className=\"h-4 w-4\" />\n                Archivos de Audio (MP3) *\n              </Label>\n              <Input\n                id=\"audio-files\"\n                type=\"file\"\n                accept=\"audio/mp3,audio/mpeg,.mp3\"\n                multiple\n                onChange={handleAudioFilesChange}\n                disabled={importMutation.isPending}\n                data-testid=\"input-audio-files\"\n              />\n              <p className=\"text-sm text-muted-foreground\">\n                Selecciona mÃºltiples archivos MP3 (mÃ¡ximo 50 archivos)\n              </p>\n            </div>\n\n            {/* Selected Files List */}\n            {audioFiles.length > 0 && (\n              <div className=\"space-y-2\">\n                <Label>Archivos Seleccionados ({audioFiles.length})</Label>\n                <div className=\"border rounded-md p-4 max-h-64 overflow-y-auto space-y-2\">\n                  {audioFiles.map((file, index) => (\n                    <div\n                      key={index}\n                      className=\"flex items-center justify-between p-2 bg-muted rounded hover-elevate\"\n                    >\n                      <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                        <FileAudio className=\"h-4 w-4 flex-shrink-0\" />\n                        <span className=\"text-sm truncate\">{file.name}</span>\n                        <span className=\"text-xs text-muted-foreground flex-shrink-0\">\n                          {formatFileSize(file.size)}\n                        </span>\n                      </div>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => removeAudioFile(index)}\n                        disabled={importMutation.isPending}\n                        data-testid={`button-remove-${index}`}\n                      >\n                        <XCircle className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Cover Art */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"cover-art\" className=\"flex items-center gap-2\">\n                <Image className=\"h-4 w-4\" />\n                Cover Art (Opcional)\n              </Label>\n              <Input\n                id=\"cover-art\"\n                type=\"file\"\n                accept=\"image/*\"\n                onChange={handleCoverArtChange}\n                disabled={importMutation.isPending}\n                data-testid=\"input-cover-art\"\n              />\n              {coverArt && (\n                <p className=\"text-sm text-muted-foreground\">\n                  Seleccionado: {coverArt.name}\n                </p>\n              )}\n            </div>\n\n            {/* Podcast Metadata */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"title\">TÃ­tulo del Podcast *</Label>\n              <Input\n                id=\"title\"\n                value={podcastTitle}\n                onChange={(e) => setPodcastTitle(e.target.value)}\n                placeholder=\"Ej: Mi Podcast Importado\"\n                required\n                disabled={importMutation.isPending}\n                data-testid=\"input-title\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">DescripciÃ³n del Podcast *</Label>\n              <Textarea\n                id=\"description\"\n                value={podcastDescription}\n                onChange={(e) => setPodcastDescription(e.target.value)}\n                placeholder=\"Describe de quÃ© trata tu podcast...\"\n                rows={4}\n                required\n                disabled={importMutation.isPending}\n                data-testid=\"input-description\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"category\">CategorÃ­a</Label>\n                <Input\n                  id=\"category\"\n                  value={category}\n                  onChange={(e) => setCategory(e.target.value)}\n                  placeholder=\"Technology\"\n                  disabled={importMutation.isPending}\n                  data-testid=\"input-category\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"language\">Idioma</Label>\n                <Input\n                  id=\"language\"\n                  value={language}\n                  onChange={(e) => setLanguage(e.target.value)}\n                  placeholder=\"es\"\n                  disabled={importMutation.isPending}\n                  data-testid=\"input-language\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"visibility\">Visibilidad</Label>\n              <Select\n                value={visibility}\n                onValueChange={(value) => setVisibility(value as \"PRIVATE\" | \"UNLISTED\" | \"PUBLIC\")}\n                disabled={importMutation.isPending}\n              >\n                <SelectTrigger data-testid=\"select-visibility\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"PUBLIC\">PÃºblico</SelectItem>\n                  <SelectItem value=\"UNLISTED\">No listado</SelectItem>\n                  <SelectItem value=\"PRIVATE\">Privado</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Progress Bar */}\n            {importMutation.isPending && (\n              <div className=\"space-y-2\">\n                <Label>Importando archivos...</Label>\n                <Progress value={importProgress} className=\"w-full\" />\n                <p className=\"text-sm text-muted-foreground text-center\">\n                  Por favor espera mientras se suben y procesan los archivos\n                </p>\n              </div>\n            )}\n\n            {/* Submit Button */}\n            <div className=\"flex gap-4\">\n              <Button\n                type=\"submit\"\n                className=\"flex-1\"\n                disabled={importMutation.isPending || audioFiles.length === 0}\n                data-testid=\"button-import\"\n              >\n                {importMutation.isPending ? (\n                  <>Importando...</>\n                ) : (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Importar Podcast ({audioFiles.length} archivo{audioFiles.length !== 1 ? 's' : ''})\n                  </>\n                )}\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setLocation(\"/my-podcasts\")}\n                disabled={importMutation.isPending}\n                data-testid=\"button-cancel\"\n              >\n                Cancelar\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":13399,"size_tokens":null},"client/src/components/add-to-playlist-button.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/components/auth-provider\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ListPlus, Check, Plus } from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport type { Playlist } from \"@shared/schema\";\n\ninterface AddToPlaylistButtonProps {\n  episodeId: string;\n  variant?: \"default\" | \"outline\" | \"ghost\";\n  size?: \"default\" | \"sm\" | \"lg\" | \"icon\";\n}\n\nexport function AddToPlaylistButton({ episodeId, variant = \"outline\", size = \"sm\" }: AddToPlaylistButtonProps) {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [isOpen, setIsOpen] = useState(false);\n  const [newPlaylistName, setNewPlaylistName] = useState(\"\");\n  const [showCreateForm, setShowCreateForm] = useState(false);\n\n  const { data: playlists = [], isLoading } = useQuery<Playlist[]>({\n    queryKey: [\"/api/playlists\"],\n    enabled: !!user && isOpen,\n  });\n\n  const addToPlaylistMutation = useMutation({\n    mutationFn: async ({ playlistId }: { playlistId: string }) => {\n      return await apiRequest(\"POST\", `/api/playlists/${playlistId}/episodes`, { episodeId });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/playlists\"] });\n      toast({\n        title: \"Episodio aÃ±adido\",\n        description: \"El episodio se ha aÃ±adido a la playlist\",\n      });\n      setIsOpen(false);\n    },\n    onError: (error: any) => {\n      if (error.message?.includes(\"already in playlist\")) {\n        toast({\n          title: \"Ya existe\",\n          description: \"Este episodio ya estÃ¡ en la playlist\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Error\",\n          description: \"No se pudo aÃ±adir el episodio a la playlist\",\n          variant: \"destructive\",\n        });\n      }\n    },\n  });\n\n  const createPlaylistMutation = useMutation({\n    mutationFn: async (name: string): Promise<Playlist> => {\n      return await apiRequest<Playlist>(\"POST\", \"/api/playlists\", {\n        name,\n        description: \"\",\n        isPublic: false,\n      });\n    },\n    onSuccess: async (newPlaylist: Playlist) => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/playlists\"] });\n      setNewPlaylistName(\"\");\n      setShowCreateForm(false);\n      addToPlaylistMutation.mutate({ playlistId: newPlaylist.id });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo crear la playlist\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const checkInPlaylist = async (playlistId: string): Promise<boolean> => {\n    try {\n      const playlist = await queryClient.fetchQuery<Playlist & { episodes: { id: string }[] }>({\n        queryKey: [\"/api/playlists\", playlistId],\n      });\n      return playlist.episodes?.some((ep) => ep.id === episodeId) || false;\n    } catch {\n      return false;\n    }\n  };\n\n  if (!user) {\n    return null;\n  }\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button variant={variant} size={size} data-testid=\"button-add-to-playlist\">\n          <ListPlus className=\"w-4 h-4 mr-2\" />\n          AÃ±adir a Playlist\n        </Button>\n      </DialogTrigger>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>AÃ±adir a Playlist</DialogTitle>\n          <DialogDescription>Selecciona una playlist o crea una nueva</DialogDescription>\n        </DialogHeader>\n\n        {isLoading ? (\n          <div className=\"space-y-2\">\n            {[1, 2].map((i) => (\n              <div key={i} className=\"h-16 bg-muted rounded animate-pulse\" />\n            ))}\n          </div>\n        ) : playlists.length === 0 && !showCreateForm ? (\n          <div className=\"text-center py-6\">\n            <p className=\"text-muted-foreground mb-4\">No tienes playlists aÃºn</p>\n            <Button onClick={() => setShowCreateForm(true)} data-testid=\"button-create-first-playlist\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Crear mi primera playlist\n            </Button>\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            {!showCreateForm && playlists.length > 0 && (\n              <div className=\"max-h-64 overflow-y-auto space-y-2\">\n                {playlists.map((playlist) => {\n                  const [inPlaylist, setInPlaylist] = useState(false);\n\n                  checkInPlaylist(playlist.id).then(setInPlaylist);\n\n                  return (\n                    <Card\n                      key={playlist.id}\n                      className={`cursor-pointer hover-elevate ${inPlaylist ? \"opacity-50\" : \"\"}`}\n                      onClick={() => {\n                        if (!inPlaylist && !addToPlaylistMutation.isPending) {\n                          addToPlaylistMutation.mutate({ playlistId: playlist.id });\n                        }\n                      }}\n                      data-testid={`playlist-option-${playlist.id}`}\n                    >\n                      <CardContent className=\"p-3 flex items-center justify-between gap-2\">\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-medium truncate\">{playlist.name}</p>\n                          {playlist.description && (\n                            <p className=\"text-xs text-muted-foreground truncate\">\n                              {playlist.description}\n                            </p>\n                          )}\n                        </div>\n                        {inPlaylist && <Check className=\"w-4 h-4 text-primary shrink-0\" />}\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n              </div>\n            )}\n\n            {showCreateForm ? (\n              <div className=\"space-y-3\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"new-playlist-name\">Nombre de la playlist</Label>\n                  <Input\n                    id=\"new-playlist-name\"\n                    value={newPlaylistName}\n                    onChange={(e) => setNewPlaylistName(e.target.value)}\n                    placeholder=\"Mi Nueva Playlist\"\n                    data-testid=\"input-new-playlist-name\"\n                  />\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button\n                    onClick={() => {\n                      setShowCreateForm(false);\n                      setNewPlaylistName(\"\");\n                    }}\n                    variant=\"outline\"\n                    className=\"flex-1\"\n                    data-testid=\"button-cancel-create\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button\n                    onClick={() => {\n                      if (newPlaylistName.trim()) {\n                        createPlaylistMutation.mutate(newPlaylistName);\n                      }\n                    }}\n                    disabled={!newPlaylistName.trim() || createPlaylistMutation.isPending}\n                    className=\"flex-1\"\n                    data-testid=\"button-submit-create\"\n                  >\n                    {createPlaylistMutation.isPending ? \"Creando...\" : \"Crear y aÃ±adir\"}\n                  </Button>\n                </div>\n              </div>\n            ) : playlists.length > 0 ? (\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowCreateForm(true)}\n                className=\"w-full\"\n                data-testid=\"button-show-create-form\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Nueva Playlist\n              </Button>\n            ) : null}\n          </div>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":8169,"size_tokens":null},"client/src/pages/playlist-detail.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/components/auth-provider\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ArrowLeft, Music, Trash2, Globe, Lock, Share2, Copy } from \"lucide-react\";\nimport { Link, useParams, useLocation } from \"wouter\";\nimport { AudioPlayer } from \"@/components/audio-player\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { es } from \"date-fns/locale\";\nimport type { Playlist, Episode } from \"@shared/schema\";\n\ninterface PlaylistWithEpisodes extends Playlist {\n  episodes: Episode[];\n}\n\nexport default function PlaylistDetail() {\n  const params = useParams();\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const playlistId = params.id as string;\n\n  const { data: playlist, isLoading } = useQuery<PlaylistWithEpisodes>({\n    queryKey: [\"/api/playlists\", playlistId],\n    enabled: !!playlistId,\n  });\n\n  const removeEpisodeMutation = useMutation({\n    mutationFn: async (episodeId: string) => {\n      return await apiRequest(\"DELETE\", `/api/playlists/${playlistId}/episodes/${episodeId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/playlists\", playlistId] });\n      toast({\n        title: \"Episodio eliminado\",\n        description: \"El episodio se ha eliminado de la playlist\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo eliminar el episodio\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleShare = () => {\n    const shareUrl = `${window.location.origin}/playlists/${playlistId}`;\n    navigator.clipboard.writeText(shareUrl);\n    toast({\n      title: \"Enlace copiado\",\n      description: \"El enlace de la playlist se ha copiado al portapapeles\",\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-muted rounded w-1/3\" />\n          <div className=\"h-20 bg-muted rounded\" />\n          <div className=\"space-y-2\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"h-24 bg-muted rounded\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!playlist) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Playlist no encontrada</CardTitle>\n            <CardDescription>La playlist que buscas no existe o es privada</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button asChild data-testid=\"button-back\">\n              <Link href=\"/my-playlists\">\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Volver a Mis Playlists\n              </Link>\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const isOwner = user?.id === playlist.userId;\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"mb-6\">\n        <Button variant=\"ghost\" asChild className=\"mb-4\" data-testid=\"button-back\">\n          <Link href=\"/my-playlists\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Volver\n          </Link>\n        </Button>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <CardTitle className=\"text-2xl\" data-testid=\"text-playlist-name\">\n                    {playlist.name}\n                  </CardTitle>\n                  <Badge variant=\"secondary\">\n                    {playlist.isPublic ? (\n                      <>\n                        <Globe className=\"w-3 h-3 mr-1\" />\n                        PÃºblica\n                      </>\n                    ) : (\n                      <>\n                        <Lock className=\"w-3 h-3 mr-1\" />\n                        Privada\n                      </>\n                    )}\n                  </Badge>\n                </div>\n                {playlist.description && (\n                  <CardDescription className=\"text-base\" data-testid=\"text-playlist-description\">\n                    {playlist.description}\n                  </CardDescription>\n                )}\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {playlist.episodes.length} {playlist.episodes.length === 1 ? \"episodio\" : \"episodios\"}\n                </p>\n              </div>\n              {playlist.isPublic && (\n                <Button variant=\"outline\" onClick={handleShare} data-testid=\"button-share\">\n                  <Share2 className=\"w-4 h-4 mr-2\" />\n                  Compartir\n                </Button>\n              )}\n            </div>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {playlist.episodes.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Music className=\"w-12 h-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Playlist vacÃ­a</h3>\n            <p className=\"text-muted-foreground\">\n              {isOwner\n                ? \"AÃºn no has aÃ±adido episodios a esta playlist. Explora podcasts y aÃ±ade episodios desde los detalles de cada episodio.\"\n                : \"Esta playlist no tiene episodios todavÃ­a\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-3\">\n          {playlist.episodes.map((episode) => (\n            <Card key={episode.id} className=\"hover-elevate\">\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n                  <div className=\"flex-1 min-w-0\">\n                    <CardTitle className=\"text-lg\" data-testid={`text-episode-title-${episode.id}`}>\n                      {episode.title}\n                    </CardTitle>\n                    <CardDescription className=\"mt-1\">\n                      {episode.publishedAt && (\n                        <span>\n                          {formatDistanceToNow(new Date(episode.publishedAt), {\n                            addSuffix: true,\n                            locale: es,\n                          })}\n                        </span>\n                      )}\n                      {episode.duration && (\n                        <>\n                          {\" â€¢ \"}\n                          {Math.floor(episode.duration / 60)} min\n                        </>\n                      )}\n                    </CardDescription>\n                  </div>\n                  {isOwner && (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => {\n                        if (confirm(\"Â¿Eliminar este episodio de la playlist?\")) {\n                          removeEpisodeMutation.mutate(episode.id);\n                        }\n                      }}\n                      disabled={removeEpisodeMutation.isPending}\n                      data-testid={`button-remove-${episode.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  )}\n                </div>\n              </CardHeader>\n              <CardContent>\n                {episode.notes && (\n                  <p className=\"text-sm text-muted-foreground mb-3 line-clamp-2\">\n                    {episode.notes}\n                  </p>\n                )}\n                <AudioPlayer episode={episode} />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":7999,"size_tokens":null},"client/src/pages/my-playlists.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/components/auth-provider\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Music, Trash2, Edit, ExternalLink, Lock, Globe } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport type { Playlist } from \"@shared/schema\";\n\nexport default function MyPlaylists() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingPlaylist, setEditingPlaylist] = useState<Playlist | null>(null);\n\n  const { data: playlists = [], isLoading } = useQuery<Playlist[]>({\n    queryKey: [\"/api/playlists\"],\n    enabled: !!user,\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { name: string; description: string; isPublic: boolean }) => {\n      return await apiRequest(\"POST\", \"/api/playlists\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/playlists\"] });\n      setIsCreateDialogOpen(false);\n      toast({\n        title: \"Playlist creada\",\n        description: \"Tu playlist se ha creado correctamente\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo crear la playlist\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Pick<Playlist, \"name\" | \"description\" | \"isPublic\">> }) => {\n      return await apiRequest(\"PATCH\", `/api/playlists/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/playlists\"] });\n      setEditingPlaylist(null);\n      toast({\n        title: \"Playlist actualizada\",\n        description: \"Los cambios se han guardado correctamente\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo actualizar la playlist\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/playlists/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/playlists\"] });\n      toast({\n        title: \"Playlist eliminada\",\n        description: \"La playlist se ha eliminado correctamente\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo eliminar la playlist\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    createMutation.mutate({\n      name: formData.get(\"name\") as string,\n      description: formData.get(\"description\") as string,\n      isPublic: formData.get(\"isPublic\") === \"on\",\n    });\n  };\n\n  const handleUpdateSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    if (!editingPlaylist) return;\n    \n    const formData = new FormData(e.currentTarget);\n    updateMutation.mutate({\n      id: editingPlaylist.id,\n      data: {\n        name: formData.get(\"name\") as string,\n        description: formData.get(\"description\") as string,\n        isPublic: formData.get(\"isPublic\") === \"on\",\n      },\n    });\n  };\n\n  if (!user) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Acceso restringido</CardTitle>\n            <CardDescription>Debes iniciar sesiÃ³n para ver tus playlists</CardDescription>\n          </CardHeader>\n          <CardFooter>\n            <Button asChild data-testid=\"button-login\">\n              <Link href=\"/login\">Iniciar sesiÃ³n</Link>\n            </Button>\n          </CardFooter>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"flex items-center justify-between mb-6 gap-2 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Mis Playlists</h1>\n          <p className=\"text-muted-foreground mt-1\">Organiza tus episodios favoritos</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-playlist\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nueva Playlist\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <form onSubmit={handleCreateSubmit}>\n              <DialogHeader>\n                <DialogTitle>Crear Playlist</DialogTitle>\n                <DialogDescription>\n                  Crea una nueva playlist para organizar tus episodios\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"create-name\">Nombre*</Label>\n                  <Input\n                    id=\"create-name\"\n                    name=\"name\"\n                    placeholder=\"Mi Playlist Favorita\"\n                    required\n                    data-testid=\"input-playlist-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"create-description\">DescripciÃ³n</Label>\n                  <Textarea\n                    id=\"create-description\"\n                    name=\"description\"\n                    placeholder=\"Describe tu playlist...\"\n                    rows={3}\n                    data-testid=\"input-playlist-description\"\n                  />\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"create-isPublic\">Playlist pÃºblica</Label>\n                  <Switch\n                    id=\"create-isPublic\"\n                    name=\"isPublic\"\n                    data-testid=\"switch-playlist-public\"\n                  />\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Las playlists pÃºblicas pueden ser vistas por cualquier usuario\n                </p>\n              </div>\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsCreateDialogOpen(false)}\n                  data-testid=\"button-cancel-create\"\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createMutation.isPending}\n                  data-testid=\"button-submit-create\"\n                >\n                  {createMutation.isPending ? \"Creando...\" : \"Crear\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader>\n                <div className=\"h-6 bg-muted rounded\" />\n                <div className=\"h-4 bg-muted rounded w-2/3\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-20 bg-muted rounded\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : playlists.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Music className=\"w-12 h-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">No tienes playlists</h3>\n            <p className=\"text-muted-foreground mb-4\">\n              Crea tu primera playlist para empezar a organizar episodios\n            </p>\n            <Button onClick={() => setIsCreateDialogOpen(true)} data-testid=\"button-create-first\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Crear Playlist\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {playlists.map((playlist) => (\n            <Card key={playlist.id} className=\"hover-elevate\">\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex-1 min-w-0\">\n                    <CardTitle className=\"truncate\" data-testid={`text-playlist-name-${playlist.id}`}>\n                      {playlist.name}\n                    </CardTitle>\n                    <CardDescription className=\"flex items-center gap-1 mt-1\">\n                      {playlist.isPublic ? (\n                        <>\n                          <Globe className=\"w-3 h-3\" />\n                          PÃºblica\n                        </>\n                      ) : (\n                        <>\n                          <Lock className=\"w-3 h-3\" />\n                          Privada\n                        </>\n                      )}\n                    </CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-sm text-muted-foreground line-clamp-3\">\n                  {playlist.description || \"Sin descripciÃ³n\"}\n                </p>\n              </CardContent>\n              <CardFooter className=\"flex justify-between gap-2 flex-wrap\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setLocation(`/playlists/${playlist.id}`)}\n                  data-testid={`button-view-${playlist.id}`}\n                >\n                  <ExternalLink className=\"w-4 h-4 mr-2\" />\n                  Ver\n                </Button>\n                <div className=\"flex gap-2\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setEditingPlaylist(playlist)}\n                    data-testid={`button-edit-${playlist.id}`}\n                  >\n                    <Edit className=\"w-4 h-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => {\n                      if (confirm(\"Â¿EstÃ¡s seguro de que quieres eliminar esta playlist?\")) {\n                        deleteMutation.mutate(playlist.id);\n                      }\n                    }}\n                    data-testid={`button-delete-${playlist.id}`}\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </CardFooter>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={!!editingPlaylist} onOpenChange={(open) => !open && setEditingPlaylist(null)}>\n        <DialogContent>\n          <form onSubmit={handleUpdateSubmit}>\n            <DialogHeader>\n              <DialogTitle>Editar Playlist</DialogTitle>\n              <DialogDescription>\n                Actualiza la informaciÃ³n de tu playlist\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-name\">Nombre*</Label>\n                <Input\n                  id=\"edit-name\"\n                  name=\"name\"\n                  defaultValue={editingPlaylist?.name}\n                  required\n                  data-testid=\"input-edit-name\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-description\">DescripciÃ³n</Label>\n                <Textarea\n                  id=\"edit-description\"\n                  name=\"description\"\n                  defaultValue={editingPlaylist?.description || \"\"}\n                  rows={3}\n                  data-testid=\"input-edit-description\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"edit-isPublic\">Playlist pÃºblica</Label>\n                <Switch\n                  id=\"edit-isPublic\"\n                  name=\"isPublic\"\n                  defaultChecked={editingPlaylist?.isPublic}\n                  data-testid=\"switch-edit-public\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setEditingPlaylist(null)}\n                data-testid=\"button-cancel-edit\"\n              >\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={updateMutation.isPending}\n                data-testid=\"button-submit-edit\"\n              >\n                {updateMutation.isPending ? \"Guardando...\" : \"Guardar cambios\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13689,"size_tokens":null},"scripts/create-new-repo.ts":{"content":"import { Octokit } from '@octokit/rest';\n\nlet connectionSettings: any;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=github',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('GitHub not connected');\n  }\n  return accessToken;\n}\n\nasync function createRepository(repoName: string, description: string) {\n  try {\n    const octokit = new Octokit({ auth: await getAccessToken() });\n    \n    console.log('ðŸ” Verificando usuario...');\n    const { data: user } = await octokit.rest.users.getAuthenticated();\n    console.log(`âœ… Usuario: ${user.login}\\n`);\n    \n    // Intentar eliminar el repositorio existente si existe\n    try {\n      console.log(`ðŸ—‘ï¸  Eliminando repositorio anterior si existe...`);\n      await octokit.rest.repos.delete({\n        owner: user.login,\n        repo: repoName,\n      });\n      console.log(`âœ… Repositorio anterior eliminado\\n`);\n      // Esperar un poco para que GitHub procese la eliminaciÃ³n\n      await new Promise(resolve => setTimeout(resolve, 2000));\n    } catch (error: any) {\n      if (error.status !== 404) {\n        console.log(`â„¹ï¸  No se encontrÃ³ repositorio anterior (normal si es la primera vez)\\n`);\n      }\n    }\n    \n    console.log(`ðŸ“ Creando nuevo repositorio: ${repoName}...`);\n    const { data: repo } = await octokit.rest.repos.createForAuthenticatedUser({\n      name: repoName,\n      description: description,\n      private: false,\n      auto_init: true,  // IMPORTANTE: Inicializar con README\n      gitignore_template: 'Node',\n    });\n    \n    console.log(`âœ… Repositorio creado con inicializaciÃ³n automÃ¡tica`);\n    console.log(`ðŸ”— URL: ${repo.html_url}`);\n    console.log(`ðŸ“¡ Clone: ${repo.clone_url}\\n`);\n    \n    return {\n      success: true,\n      url: repo.html_url,\n      cloneUrl: repo.clone_url,\n      owner: user.login,\n      name: repoName,\n    };\n  } catch (error: any) {\n    console.error('âŒ Error:', error.message);\n    if (error.response) {\n      console.error('Detalles:', error.response.data);\n    }\n    return { success: false, error: error.message };\n  }\n}\n\n// Ejecutar\nconst repoName = 'podcast-platform';\nconst description = 'ðŸŽ™ï¸ Plataforma Multitenant de Podcasts - Desarrollado por Atreyu Servicios Digitales';\n\ncreateRepository(repoName, description)\n  .then(result => {\n    if (result.success) {\n      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n      console.log('âœ… Â¡REPOSITORIO LISTO!');\n      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n      console.log(`Ahora ejecuta: npx tsx scripts/push-final.ts`);\n      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n      process.exit(0);\n    } else {\n      console.error('\\nâŒ FallÃ³ la creaciÃ³n del repositorio');\n      process.exit(1);\n    }\n  })\n  .catch(err => {\n    console.error('âŒ Error inesperado:', err);\n    process.exit(1);\n  });\n","path":null,"size_bytes":4022,"size_tokens":null},"scripts/push-to-github-simple.ts":{"content":"import { Octokit } from '@octokit/rest';\nimport { createRequire } from 'module';\nimport fs from 'fs/promises';\nimport path from 'path';\n\nconst require = createRequire(import.meta.url);\n\nlet Octokit_: typeof Octokit;\nlet connectionSettings: any;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=github',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('GitHub not connected');\n  }\n  return accessToken;\n}\n\nasync function getGitHubClient() {\n  const accessToken = await getAccessToken();\n  if (!Octokit_) {\n    const plugin = require('octokit-commit-multiple-files');\n    Octokit_ = Octokit.plugin(plugin);\n  }\n  return new Octokit_({ auth: accessToken });\n}\n\nconst IGNORE_PATTERNS = [\n  'node_modules',\n  'dist',\n  '.DS_Store',\n  'server/public',\n  '.env',\n  '.env.local',\n  '.env.production',\n  '*.sql',\n  '*.dump',\n  'logs',\n  '*.log',\n  'tmp',\n  'temp',\n  '.vscode',\n  '.idea',\n  '.git',\n  '.cache',\n  'scripts/upload-to-github.ts',\n  'scripts/create-github-repo.ts',\n  'scripts/push-to-github-simple.ts'\n];\n\nfunction shouldIgnore(filePath: string): boolean {\n  return IGNORE_PATTERNS.some(pattern => {\n    if (pattern.includes('*')) {\n      const regex = new RegExp(pattern.replace('*', '.*'));\n      return regex.test(filePath);\n    }\n    return filePath.includes(pattern);\n  });\n}\n\nasync function getAllFiles(dir: string, baseDir: string = dir): Promise<string[]> {\n  const files: string[] = [];\n  const entries = await fs.readdir(dir, { withFileTypes: true });\n\n  for (const entry of entries) {\n    const fullPath = path.join(dir, entry.name);\n    const relativePath = path.relative(baseDir, fullPath);\n\n    if (shouldIgnore(relativePath) || shouldIgnore(entry.name)) {\n      continue;\n    }\n\n    if (entry.isDirectory()) {\n      files.push(...await getAllFiles(fullPath, baseDir));\n    } else if (entry.isFile()) {\n      files.push(relativePath);\n    }\n  }\n\n  return files;\n}\n\nasync function pushToGitHub(owner: string, repo: string, branch: string = 'main') {\n  try {\n    console.log('ðŸ“‚ Escaneando archivos...');\n    const filePaths = await getAllFiles(process.cwd());\n    \n    // Asegurar que se incluyen los .gitkeep\n    const gitkeepFiles = [\n      'uploads/.gitkeep',\n      'uploads/images/.gitkeep',\n      'uploads/audio/.gitkeep'\n    ];\n    \n    for (const gitkeep of gitkeepFiles) {\n      if (!filePaths.includes(gitkeep)) {\n        try {\n          await fs.access(gitkeep);\n          filePaths.push(gitkeep);\n        } catch {\n          await fs.mkdir(path.dirname(gitkeep), { recursive: true });\n          await fs.writeFile(gitkeep, '');\n          filePaths.push(gitkeep);\n        }\n      }\n    }\n    \n    console.log(`âœ… Encontrados ${filePaths.length} archivos para subir`);\n    \n    // Preparar archivos\n    console.log('\\nðŸ“¤ Preparando archivos...');\n    const files: Record<string, string | { contents: string; mode: '100644' | '100755' }> = {};\n    \n    let processed = 0;\n    for (const filePath of filePaths) {\n      try {\n        const stats = await fs.stat(filePath);\n        if (!stats.isFile()) continue;\n        \n        const content = await fs.readFile(filePath, 'utf-8');\n        \n        // Determinar si es ejecutable\n        if (filePath.endsWith('.sh')) {\n          files[filePath] = {\n            contents: content,\n            mode: '100755'\n          };\n        } else {\n          files[filePath] = content;\n        }\n        \n        processed++;\n        if (processed % 100 === 0) {\n          console.log(`  ðŸ“¦ ${processed}/${filePaths.length} archivos procesados...`);\n        }\n      } catch (error: any) {\n        console.warn(`  âš ï¸  Error al leer ${filePath}:`, error.message);\n      }\n    }\n    \n    console.log(`  âœ… ${processed} archivos listos`);\n    \n    // Subir a GitHub\n    console.log('\\nðŸš€ Subiendo a GitHub...');\n    const octokit = await getGitHubClient();\n    \n    await (octokit.repos as any).createOrUpdateFiles({\n      owner,\n      repo,\n      branch,\n      createBranch: true,\n      forkFromBaseBranch: false,\n      changes: [\n        {\n          message: 'Initial commit - Podcast Platform con instalaciÃ³n automatizada\\n\\n- Instalador automÃ¡tico para Ubuntu\\n- DocumentaciÃ³n completa en README.md\\n- ConfiguraciÃ³n de almacenamiento local\\n- Scripts de backup y deployment',\n          files\n        }\n      ]\n    });\n    \n    console.log('\\nâœ… Â¡CÃ³digo subido exitosamente!');\n    console.log(`ðŸ”— https://github.com/${owner}/${repo}`);\n    console.log(`ðŸ“¦ ${processed} archivos subidos`);\n    console.log(`ðŸŒ¿ Branch: ${branch}`);\n    \n    return true;\n  } catch (error: any) {\n    console.error('\\nâŒ Error:', error.message);\n    if (error.response) {\n      console.error('Detalles:', JSON.stringify(error.response.data, null, 2));\n    }\n    return false;\n  }\n}\n\n// Ejecutar\nconst owner = 'innovafpiesmmg';\nconst repo = 'podcast-platform';\nconst branch = 'main';\n\npushToGitHub(owner, repo, branch)\n  .then(success => process.exit(success ? 0 : 1))\n  .catch(err => {\n    console.error('âŒ Error inesperado:', err);\n    process.exit(1);\n  });\n","path":null,"size_bytes":5993,"size_tokens":null},"scripts/upload-to-github.ts":{"content":"import { Octokit } from '@octokit/rest';\nimport fs from 'fs/promises';\nimport path from 'path';\n\nlet connectionSettings: any;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=github',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('GitHub not connected');\n  }\n  return accessToken;\n}\n\nasync function getGitHubClient() {\n  const accessToken = await getAccessToken();\n  return new Octokit({ auth: accessToken });\n}\n\n// Lista de archivos/directorios a ignorar (segÃºn .gitignore)\nconst IGNORE_PATTERNS = [\n  'node_modules',\n  'dist',\n  '.DS_Store',\n  'server/public',\n  '.env',\n  '.env.local',\n  '.env.production',\n  'uploads',\n  '*.sql',\n  '*.dump',\n  'logs',\n  '*.log',\n  'tmp',\n  'temp',\n  '.vscode',\n  '.idea',\n  '.git',\n  'scripts/upload-to-github.ts', // No subir este script\n  'scripts/create-github-repo.ts'\n];\n\nfunction shouldIgnore(filePath: string): boolean {\n  return IGNORE_PATTERNS.some(pattern => {\n    if (pattern.includes('*')) {\n      const regex = new RegExp(pattern.replace('*', '.*'));\n      return regex.test(filePath);\n    }\n    return filePath.includes(pattern);\n  });\n}\n\nasync function getAllFiles(dir: string, baseDir: string = dir): Promise<string[]> {\n  const files: string[] = [];\n  const entries = await fs.readdir(dir, { withFileTypes: true });\n\n  for (const entry of entries) {\n    const fullPath = path.join(dir, entry.name);\n    const relativePath = path.relative(baseDir, fullPath);\n\n    // Ignorar el directorio completo si coincide con el patrÃ³n\n    if (shouldIgnore(relativePath) || shouldIgnore(entry.name)) {\n      continue;\n    }\n\n    if (entry.isDirectory()) {\n      files.push(...await getAllFiles(fullPath, baseDir));\n    } else if (entry.isFile()) {\n      files.push(relativePath);\n    }\n  }\n\n  return files;\n}\n\nasync function uploadToGitHub(owner: string, repo: string, branch: string = 'main') {\n  const octokit = await getGitHubClient();\n  \n  console.log('ðŸ“‚ Escaneando archivos...');\n  const files = await getAllFiles(process.cwd());\n  console.log(`âœ… Encontrados ${files.length} archivos para subir`);\n\n  // Asegurar que se incluyen los .gitkeep\n  const gitkeepFiles = [\n    'uploads/.gitkeep',\n    'uploads/images/.gitkeep',\n    'uploads/audio/.gitkeep'\n  ];\n  \n  for (const gitkeep of gitkeepFiles) {\n    if (!files.includes(gitkeep)) {\n      try {\n        await fs.access(gitkeep);\n        files.push(gitkeep);\n        console.log(`ðŸ“Œ Agregado: ${gitkeep}`);\n      } catch {\n        // Crear el archivo si no existe\n        await fs.mkdir(path.dirname(gitkeep), { recursive: true });\n        await fs.writeFile(gitkeep, '');\n        files.push(gitkeep);\n        console.log(`ðŸ“Œ Creado y agregado: ${gitkeep}`);\n      }\n    }\n  }\n\n  try {\n    // Verificar si el repositorio estÃ¡ vacÃ­o\n    console.log(`\\nðŸ” Verificando repositorio...`);\n    let isEmptyRepo = false;\n    let currentCommitSha: string | undefined;\n    \n    try {\n      const ref = await octokit.rest.git.getRef({\n        owner,\n        repo,\n        ref: `heads/${branch}`\n      });\n      currentCommitSha = ref.data.object.sha;\n      console.log(`âœ… Branch ${branch} encontrado`);\n    } catch (error: any) {\n      if (error.status === 404 || error.status === 409) {\n        console.log(`ðŸ“ Repositorio vacÃ­o, creando primer commit...`);\n        isEmptyRepo = true;\n      } else {\n        throw error;\n      }\n    }\n\n    // Crear blobs para todos los archivos\n    console.log('\\nðŸ“¤ Subiendo archivos...');\n    const blobs: any[] = [];\n    let uploaded = 0;\n    \n    for (const file of files) {\n      try {\n        const stats = await fs.stat(file);\n        \n        // Solo procesar archivos, no directorios\n        if (!stats.isFile()) {\n          continue;\n        }\n        \n        const content = await fs.readFile(file);\n        const { data } = await octokit.rest.git.createBlob({\n          owner,\n          repo,\n          content: content.toString('base64'),\n          encoding: 'base64'\n        });\n        \n        // Determinar permisos\n        let mode: '100644' | '100755' = '100644';\n        if (file.endsWith('.sh')) {\n          mode = '100755'; // Ejecutable\n        }\n        \n        blobs.push({\n          path: file,\n          mode,\n          type: 'blob' as const,\n          sha: data.sha\n        });\n        \n        uploaded++;\n        if (uploaded % 50 === 0) {\n          console.log(`  ðŸ“¦ ${uploaded}/${files.length} archivos procesados...`);\n        }\n      } catch (error: any) {\n        if (error.code !== 'EISDIR') {\n          console.warn(`  âš ï¸  Error al procesar ${file}:`, error.message);\n        }\n      }\n    }\n    \n    console.log(`  âœ… ${uploaded} archivos listos para subir`);\n\n    // Crear nuevo Ã¡rbol\n    console.log('\\nðŸŒ³ Creando Ã¡rbol de archivos...');\n    const treeOptions: any = {\n      owner,\n      repo,\n      tree: blobs\n    };\n    \n    // Si no es un repositorio vacÃ­o, usar el Ã¡rbol base\n    if (!isEmptyRepo && currentCommitSha) {\n      const currentCommit = await octokit.rest.git.getCommit({\n        owner,\n        repo,\n        commit_sha: currentCommitSha\n      });\n      treeOptions.base_tree = currentCommit.data.tree.sha;\n    }\n    \n    const { data: newTree } = await octokit.rest.git.createTree(treeOptions);\n\n    // Crear nuevo commit\n    console.log('ðŸ’¾ Creando commit...');\n    const commitOptions: any = {\n      owner,\n      repo,\n      message: 'Initial commit - Podcast Platform con instalaciÃ³n automatizada\\n\\n- Instalador automÃ¡tico para Ubuntu\\n- DocumentaciÃ³n completa en README.md\\n- ConfiguraciÃ³n de almacenamiento local\\n- Scripts de backup y deployment',\n      tree: newTree.sha\n    };\n    \n    // Solo agregar parent si no es repositorio vacÃ­o\n    if (!isEmptyRepo && currentCommitSha) {\n      commitOptions.parents = [currentCommitSha];\n    }\n    \n    const { data: newCommit } = await octokit.rest.git.createCommit(commitOptions);\n\n    // Crear o actualizar referencia\n    if (isEmptyRepo) {\n      console.log('ðŸš€ Creando branch...');\n      await octokit.rest.git.createRef({\n        owner,\n        repo,\n        ref: `refs/heads/${branch}`,\n        sha: newCommit.sha\n      });\n    } else {\n      console.log('ðŸš€ Actualizando branch...');\n      await octokit.rest.git.updateRef({\n        owner,\n        repo,\n        ref: `heads/${branch}`,\n        sha: newCommit.sha\n      });\n    }\n\n    console.log('\\nâœ… Â¡CÃ³digo subido exitosamente!');\n    console.log(`ðŸ”— https://github.com/${owner}/${repo}`);\n    console.log(`ðŸ“¦ ${files.length} archivos subidos`);\n    console.log(`ðŸ“ Commit: ${newCommit.sha.substring(0, 7)}`);\n    \n    return true;\n  } catch (error: any) {\n    console.error('\\nâŒ Error al subir archivos:', error.message);\n    if (error.response) {\n      console.error('Detalles:', error.response.data);\n    }\n    return false;\n  }\n}\n\n// Ejecutar\nconst owner = 'innovafpiesmmg';\nconst repo = 'podcast-platform';\nconst branch = 'main';\n\nuploadToGitHub(owner, repo, branch)\n  .then(success => {\n    process.exit(success ? 0 : 1);\n  })\n  .catch(err => {\n    console.error('âŒ Error inesperado:', err);\n    process.exit(1);\n  });\n","path":null,"size_bytes":8039,"size_tokens":null},"scripts/push-final.ts":{"content":"import { Octokit } from '@octokit/rest';\nimport fs from 'fs/promises';\nimport path from 'path';\n\nlet connectionSettings: any;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=github',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('GitHub not connected');\n  }\n  return accessToken;\n}\n\nasync function getGitHubClient() {\n  const accessToken = await getAccessToken();\n  return new Octokit({ auth: accessToken });\n}\n\nconst IGNORE_PATTERNS = [\n  'node_modules',\n  'dist',\n  '.DS_Store',\n  'server/public',\n  '.env',\n  '.env.local',\n  '.env.production',\n  '*.sql',\n  '*.dump',\n  'logs',\n  '*.log',\n  'tmp',\n  'temp',\n  '.vscode',\n  '.idea',\n  '.git',\n  '.cache',\n  '.local',\n  'uploads/images',\n  'uploads/audio',\n  'scripts/upload-to-github.ts',\n  'scripts/create-github-repo.ts',\n  'scripts/push-to-github-simple.ts',\n  'scripts/push-final.ts',\n  'scripts/create-new-repo.ts'\n];\n\nfunction shouldIgnore(filePath: string): boolean {\n  return IGNORE_PATTERNS.some(pattern => {\n    if (pattern.includes('*')) {\n      const regex = new RegExp(pattern.replace('*', '.*'));\n      return regex.test(filePath);\n    }\n    return filePath.includes(pattern);\n  });\n}\n\nasync function getAllFiles(dir: string, baseDir: string = dir): Promise<string[]> {\n  const files: string[] = [];\n  const entries = await fs.readdir(dir, { withFileTypes: true });\n\n  for (const entry of entries) {\n    const fullPath = path.join(dir, entry.name);\n    const relativePath = path.relative(baseDir, fullPath);\n\n    if (shouldIgnore(relativePath) || shouldIgnore(entry.name)) {\n      continue;\n    }\n\n    if (entry.isDirectory()) {\n      files.push(...await getAllFiles(fullPath, baseDir));\n    } else if (entry.isFile()) {\n      files.push(relativePath);\n    }\n  }\n\n  return files;\n}\n\nasync function pushToGitHub(owner: string, repo: string, branch: string = 'main') {\n  try {\n    const octokit = await getGitHubClient();\n    \n    console.log('ðŸ“‚ Escaneando archivos...');\n    const filePaths = await getAllFiles(process.cwd());\n    \n    // Asegurar .gitkeep\n    const gitkeepFiles = ['uploads/.gitkeep', 'uploads/images/.gitkeep', 'uploads/audio/.gitkeep'];\n    for (const gitkeep of gitkeepFiles) {\n      if (!filePaths.includes(gitkeep)) {\n        try {\n          await fs.mkdir(path.dirname(gitkeep), { recursive: true });\n          await fs.writeFile(gitkeep, '');\n          filePaths.push(gitkeep);\n        } catch {}\n      }\n    }\n    \n    console.log(`âœ… ${filePaths.length} archivos encontrados\\n`);\n    \n    // Step 1: Create blobs\n    console.log('ðŸ“¤ Creando blobs...');\n    const blobs: any[] = [];\n    let processed = 0;\n    \n    for (const filePath of filePaths) {\n      try {\n        const stats = await fs.stat(filePath);\n        if (!stats.isFile()) continue;\n        \n        const content = await fs.readFile(filePath);\n        const { data } = await octokit.rest.git.createBlob({\n          owner,\n          repo,\n          content: content.toString('base64'),\n          encoding: 'base64'\n        });\n        \n        blobs.push({\n          path: filePath,\n          mode: filePath.endsWith('.sh') ? '100755' as const : '100644' as const,\n          type: 'blob' as const,\n          sha: data.sha\n        });\n        \n        processed++;\n        if (processed % 50 === 0) {\n          console.log(`  ðŸ“¦ ${processed}/${filePaths.length}...`);\n        }\n      } catch (error: any) {\n        console.warn(`  âš ï¸  Saltando ${filePath}`);\n      }\n    }\n    \n    console.log(`  âœ… ${processed} blobs creados\\n`);\n    \n    // Step 2: Get current commit (repo is now initialized)\n    console.log('ðŸ” Obteniendo commit actual...');\n    const { data: ref } = await octokit.rest.git.getRef({\n      owner,\n      repo,\n      ref: `heads/${branch}`\n    });\n    \n    const currentCommit = await octokit.rest.git.getCommit({\n      owner,\n      repo,\n      commit_sha: ref.object.sha\n    });\n    \n    console.log(`  âœ… Commit base: ${currentCommit.data.sha.substring(0, 7)}\\n`);\n    \n    // Step 3: Create tree (with base_tree since repo is not empty)\n    console.log('ðŸŒ³ Creando Ã¡rbol...');\n    const { data: tree } = await octokit.rest.git.createTree({\n      owner,\n      repo,\n      tree: blobs,\n      base_tree: currentCommit.data.tree.sha  // Use base tree\n    });\n    \n    console.log(`  âœ… Ãrbol creado: ${tree.sha}\\n`);\n    \n    // Step 4: Create commit (with parent)\n    console.log('ðŸ’¾ Creando commit...');\n    const { data: commit } = await octokit.rest.git.createCommit({\n      owner,\n      repo,\n      message: 'CÃ³digo completo - Podcast Platform\\n\\nâœ¨ Plataforma completa de podcasting multitenant\\n\\nðŸ“¦ Incluye:\\n- Instalador automÃ¡tico para Ubuntu (scripts/install.sh)\\n- DocumentaciÃ³n completa (README.md)\\n- Sistema de almacenamiento local persistente\\n- Panel de administraciÃ³n\\n- Sistema de roles (Admin/Creator/Listener)\\n- Feeds RSS automÃ¡ticos\\n- Reproductores embebibles\\n- Sistema de playlists\\n- Control de privacidad\\n- Invitaciones por email\\n\\nðŸš€ Desarrollado por Atreyu Servicios Digitales',\n      tree: tree.sha,\n      parents: [currentCommit.data.sha]  // Add parent!\n    });\n    \n    console.log(`  âœ… Commit creado: ${commit.sha.substring(0, 7)}\\n`);\n    \n    // Step 5: Update branch reference\n    console.log('ðŸŒ¿ Actualizando branch...');\n    await octokit.rest.git.updateRef({\n      owner,\n      repo,\n      ref: `heads/${branch}`,\n      sha: commit.sha\n    });\n    \n    console.log(`  âœ… Branch ${branch} actualizado\\n`);\n    \n    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n    console.log('âœ… Â¡CÃ“DIGO SUBIDO EXITOSAMENTE!');\n    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n    console.log(`ðŸ”— Repositorio: https://github.com/${owner}/${repo}`);\n    console.log(`ðŸ“¦ Archivos: ${processed}`);\n    console.log(`ðŸ“ Commit: ${commit.sha.substring(0, 7)}`);\n    console.log(`ðŸŒ¿ Branch: ${branch}`);\n    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n    \n    return true;\n  } catch (error: any) {\n    console.error('\\nâŒ Error:', error.message);\n    if (error.response) {\n      console.error('Detalles:', JSON.stringify(error.response.data, null, 2));\n    }\n    return false;\n  }\n}\n\n// Ejecutar\npushToGitHub('innovafpiesmmg', 'podcast-saas', 'main')\n  .then(success => process.exit(success ? 0 : 1))\n  .catch(err => {\n    console.error('âŒ Error inesperado:', err);\n    process.exit(1);\n  });\n","path":null,"size_bytes":7569,"size_tokens":null},"scripts/install.sh":{"content":"#!/bin/bash\n\n###############################################################################\n# Podcast Platform - Ubuntu Installation Script\n# \n# This script automates the installation and setup of the podcast platform\n# on Ubuntu Server (20.04+)\n#\n# Usage: sudo bash scripts/install.sh\n###############################################################################\n\nset -e  # Exit on error\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Check if running as root\nif [ \"$EUID\" -ne 0 ]; then \n  echo -e \"${RED}Error: This script must be run as root or with sudo${NC}\"\n  echo \"Usage: sudo bash scripts/install.sh\"\n  exit 1\nfi\n\n# Get the actual user who invoked sudo\nACTUAL_USER=${SUDO_USER:-$USER}\n\necho -e \"${BLUE}========================================${NC}\"\necho -e \"${BLUE}Podcast Platform Installation${NC}\"\necho -e \"${BLUE}========================================${NC}\"\necho\n\n# Function to print status messages\nprint_status() {\n  echo -e \"${BLUE}[*]${NC} $1\"\n}\n\nprint_success() {\n  echo -e \"${GREEN}[âœ“]${NC} $1\"\n}\n\nprint_error() {\n  echo -e \"${RED}[âœ—]${NC} $1\"\n}\n\nprint_warning() {\n  echo -e \"${YELLOW}[!]${NC} $1\"\n}\n\n# Get installation directory (current directory)\nINSTALL_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")/..\" && pwd)\"\ncd \"$INSTALL_DIR\"\n\nprint_status \"Installation directory: $INSTALL_DIR\"\necho\n\n###############################################################################\n# 1. Install system dependencies\n###############################################################################\n\nprint_status \"Installing system dependencies...\"\n\napt-get update\napt-get install -y curl git build-essential postgresql postgresql-contrib\n\nprint_success \"System dependencies installed\"\necho\n\n###############################################################################\n# 2. Install Node.js (if not already installed)\n###############################################################################\n\nif ! command -v node &> /dev/null; then\n  print_status \"Installing Node.js 20...\"\n  \n  curl -fsSL https://deb.nodesource.com/setup_20.x | bash -\n  apt-get install -y nodejs\n  \n  print_success \"Node.js installed: $(node --version)\"\nelse\n  print_success \"Node.js already installed: $(node --version)\"\nfi\n\necho\n\n###############################################################################\n# 3. Install npm/pnpm (if needed)\n###############################################################################\n\nif ! command -v npm &> /dev/null; then\n  print_error \"npm not found. Please install npm manually.\"\n  exit 1\nfi\n\nprint_success \"npm installed: $(npm --version)\"\necho\n\n###############################################################################\n# 4. PostgreSQL setup\n###############################################################################\n\nprint_status \"Configuring PostgreSQL...\"\n\n# Start PostgreSQL service\nsystemctl start postgresql\nsystemctl enable postgresql\n\n# Generate random database password\nDB_PASSWORD=$(openssl rand -base64 32)\nDB_NAME=\"podcast_platform\"\nDB_USER=\"podcast_user\"\n\n# Create database and user\nsudo -u postgres psql <<EOF\n-- Drop database if exists (for clean reinstall)\nDROP DATABASE IF EXISTS $DB_NAME;\nDROP USER IF EXISTS $DB_USER;\n\n-- Create new user and database\nCREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';\nCREATE DATABASE $DB_NAME OWNER $DB_USER;\nGRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;\n\n-- Connect to database and grant schema privileges\n\\c $DB_NAME\nGRANT ALL ON SCHEMA public TO $DB_USER;\nALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $DB_USER;\nALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO $DB_USER;\nEOF\n\nprint_success \"PostgreSQL database created\"\nprint_success \"Database: $DB_NAME\"\nprint_success \"User: $DB_USER\"\necho\n\n###############################################################################\n# 5. Create uploads directories\n###############################################################################\n\nprint_status \"Creating uploads directories...\"\n\nmkdir -p \"$INSTALL_DIR/uploads/images\"\nmkdir -p \"$INSTALL_DIR/uploads/audio\"\n\n# Set proper permissions\nchown -R \"$ACTUAL_USER:$ACTUAL_USER\" \"$INSTALL_DIR/uploads\"\nchmod -R 755 \"$INSTALL_DIR/uploads\"\n\nprint_success \"Uploads directories created\"\necho\n\n###############################################################################\n# 6. Generate .env.production file\n###############################################################################\n\nprint_status \"Generating .env.production file...\"\n\n# Generate random session secret\nSESSION_SECRET=$(openssl rand -base64 48)\n\n# Generate random admin password\nADMIN_PASSWORD=$(openssl rand -base64 16)\n\ncat > \"$INSTALL_DIR/.env.production\" <<EOF\n# Database Configuration\nDATABASE_URL=postgresql://$DB_USER:$DB_PASSWORD@localhost:5432/$DB_NAME\nPGHOST=localhost\nPGPORT=5432\nPGDATABASE=$DB_NAME\nPGUSER=$DB_USER\nPGPASSWORD=$DB_PASSWORD\n\n# Server Configuration\nNODE_ENV=production\nPORT=5000\nSESSION_SECRET=$SESSION_SECRET\n\n# Admin User (created on first run)\nADMIN_EMAIL=admin@localhost\nADMIN_PASSWORD=$ADMIN_PASSWORD\n\n# Storage Configuration\nSTORAGE_PROVIDER=LOCAL\nUPLOADS_ROOT=$INSTALL_DIR/uploads\n\n# Public URL (CHANGE THIS TO YOUR DOMAIN)\nPUBLIC_URL=http://localhost:5000\n\n# Email Configuration (Optional - configure if needed)\n# SMTP_HOST=smtp.gmail.com\n# SMTP_PORT=587\n# SMTP_SECURE=false\n# SMTP_USER=\n# SMTP_PASS=\nEOF\n\nchown \"$ACTUAL_USER:$ACTUAL_USER\" \"$INSTALL_DIR/.env.production\"\nchmod 600 \"$INSTALL_DIR/.env.production\"\n\nprint_success \".env.production created\"\necho\n\n###############################################################################\n# 7. Install Node.js dependencies\n###############################################################################\n\nprint_status \"Installing Node.js dependencies...\"\n\n# Run npm install as the actual user (not root)\nsudo -u \"$ACTUAL_USER\" npm ci --production=false\n\nprint_success \"Node.js dependencies installed\"\necho\n\n###############################################################################\n# 8. Run database migrations\n###############################################################################\n\nprint_status \"Running database migrations...\"\n\n# Run migrations as the actual user\nsudo -u \"$ACTUAL_USER\" sh -c \"export NODE_ENV=production && npm run db:push\"\n\nprint_success \"Database migrations completed\"\necho\n\n###############################################################################\n# 9. Build the application\n###############################################################################\n\nprint_status \"Building the application...\"\n\nsudo -u \"$ACTUAL_USER\" npm run build\n\nprint_success \"Application built successfully\"\necho\n\n###############################################################################\n# 10. Create systemd service (optional)\n###############################################################################\n\nread -p \"Do you want to create a systemd service to run the app automatically? (y/n) \" -n 1 -r\necho\nif [[ $REPLY =~ ^[Yy]$ ]]; then\n  print_status \"Creating systemd service...\"\n  \n  cat > /etc/systemd/system/podcast-platform.service <<EOF\n[Unit]\nDescription=Podcast Platform\nAfter=network.target postgresql.service\nWants=postgresql.service\n\n[Service]\nType=simple\nUser=$ACTUAL_USER\nWorkingDirectory=$INSTALL_DIR\nEnvironment=NODE_ENV=production\nEnvironmentFile=$INSTALL_DIR/.env.production\nExecStart=$(which node) $INSTALL_DIR/dist/index.js\nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n  systemctl daemon-reload\n  systemctl enable podcast-platform\n  systemctl start podcast-platform\n  \n  print_success \"Systemd service created and started\"\n  print_status \"Service status: systemctl status podcast-platform\"\n  print_status \"View logs: journalctl -u podcast-platform -f\"\nelse\n  print_warning \"Systemd service not created\"\n  print_status \"To run manually: cd $INSTALL_DIR && npm start\"\nfi\n\necho\n\n###############################################################################\n# Installation Complete\n###############################################################################\n\necho -e \"${GREEN}========================================${NC}\"\necho -e \"${GREEN}Installation Complete!${NC}\"\necho -e \"${GREEN}========================================${NC}\"\necho\necho -e \"${BLUE}Important Information:${NC}\"\necho\necho -e \"1. Admin Login Credentials:\"\necho -e \"   Email: ${GREEN}admin@localhost${NC}\"\necho -e \"   Password: ${GREEN}$ADMIN_PASSWORD${NC}\"\necho\necho -e \"2. Database:\"\necho -e \"   Name: ${GREEN}$DB_NAME${NC}\"\necho -e \"   User: ${GREEN}$DB_USER${NC}\"\necho -e \"   Password: ${GREEN}$DB_PASSWORD${NC}\"\necho\necho -e \"3. Application:\"\necho -e \"   Location: ${GREEN}$INSTALL_DIR${NC}\"\necho -e \"   Uploads: ${GREEN}$INSTALL_DIR/uploads${NC}\"\necho\necho -e \"4. Configuration:\"\necho -e \"   Environment file: ${GREEN}$INSTALL_DIR/.env.production${NC}\"\necho\necho -e \"${YELLOW}Next Steps:${NC}\"\necho\necho \"1. Edit .env.production and update PUBLIC_URL with your domain\"\necho \"2. Configure email settings in .env.production (optional)\"\necho \"3. Access the application at: http://localhost:5000\"\necho \"4. Login with the admin credentials shown above\"\necho \"5. IMPORTANT: Save the admin password somewhere safe!\"\necho\necho -e \"${YELLOW}Security Recommendations:${NC}\"\necho\necho \"1. Change the admin password after first login\"\necho \"2. Configure a firewall (ufw enable)\"\necho \"3. Set up HTTPS with Let's Encrypt/Nginx\"\necho \"4. Regular backups of database and uploads directory\"\necho\nprint_success \"Installation script completed successfully!\"\n","path":null,"size_bytes":9561,"size_tokens":null},"README.md":{"content":"# ðŸŽ™ï¸ Plataforma Multitenant de Podcasts\n\nPlataforma completa de podcasting multitenant desarrollada con Node.js, TypeScript, Express, PostgreSQL y Drizzle ORM. Permite a los creadores publicar, gestionar y distribuir podcasts mientras ofrece a los oyentes una experiencia de escucha simplificada.\n\n**Desarrollado por:** Atreyu Servicios Digitales\n\n---\n\n## âœ¨ CaracterÃ­sticas\n\n### Para Oyentes\n- ðŸ” ExploraciÃ³n y bÃºsqueda de podcasts\n- â­ Sistema de suscripciones\n- ðŸŽµ Reproductor de audio integrado\n- ðŸ“± DiseÃ±o responsive y modo oscuro\n- ðŸ“‹ Listas de reproducciÃ³n personalizadas\n- ðŸ”— Compartir episodios y podcasts\n\n### Para Creadores\n- ðŸ“ GestiÃ³n completa de podcasts y episodios\n- ðŸ”’ Control de privacidad (PRIVADO/NO LISTADO/PÃšBLICO)\n- ðŸ“§ Sistema de invitaciones por email\n- ðŸ“Š Panel de control intuitivo\n- ðŸŽ¨ Carga de portadas personalizadas\n- ðŸ“¡ Feeds RSS automÃ¡ticos con extensiones iTunes\n- ðŸ”— Reproductores embebibles\n\n### Para Administradores\n- ðŸ‘¥ GestiÃ³n de usuarios y roles\n- âœ… ModeraciÃ³n de contenido\n- ðŸ“§ ConfiguraciÃ³n de email SMTP\n- ðŸ—‚ï¸ Operaciones masivas\n- ðŸ“ˆ Panel de administraciÃ³n completo\n\n---\n\n## ðŸš€ InstalaciÃ³n RÃ¡pida (Ubuntu Server)\n\n### Requisitos Previos\n\n- Ubuntu Server 20.04+ (LTS recomendado)\n- Acceso root o sudo\n- ConexiÃ³n a Internet\n\n### InstalaciÃ³n Automatizada\n\n```bash\n# 1. Clonar el repositorio\ngit clone https://github.com/innovafpiesmmg/podcast-platform.git\ncd podcast-platform\n\n# 2. Ejecutar el script de instalaciÃ³n\nsudo bash scripts/install.sh\n```\n\nEl script de instalaciÃ³n automÃ¡ticamente:\n- âœ… Instala Node.js 20 y dependencias del sistema\n- âœ… Configura PostgreSQL\n- âœ… Crea la base de datos y usuario\n- âœ… Genera las carpetas de uploads\n- âœ… Crea el archivo .env.production con configuraciÃ³n segura\n- âœ… Instala dependencias de Node.js\n- âœ… Ejecuta las migraciones de base de datos\n- âœ… Construye la aplicaciÃ³n\n- âœ… (Opcional) Crea un servicio systemd\n\n### DespuÃ©s de la InstalaciÃ³n\n\n1. **Actualizar la URL pÃºblica:**\n   ```bash\n   nano .env.production\n   # Cambiar PUBLIC_URL=http://localhost:5000 por tu dominio\n   ```\n\n2. **Configurar email (opcional):**\n   ```bash\n   nano .env.production\n   # Descomentar y configurar las variables SMTP_*\n   ```\n\n3. **Iniciar la aplicaciÃ³n:**\n\n   Si creaste el servicio systemd:\n   ```bash\n   sudo systemctl start podcast-platform\n   sudo systemctl status podcast-platform\n   ```\n\n   O ejecutar manualmente:\n   ```bash\n   npm start\n   ```\n\n4. **Acceder a la aplicaciÃ³n:**\n   - URL: `http://tu-servidor:5000`\n   - Email admin: `admin@localhost`\n   - ContraseÃ±a: (mostrada al final de la instalaciÃ³n)\n\n---\n\n## ðŸ”§ InstalaciÃ³n Manual\n\n### 1. Instalar Dependencias del Sistema\n\n```bash\nsudo apt update\nsudo apt install -y curl git build-essential postgresql postgresql-contrib\n```\n\n### 2. Instalar Node.js 20\n\n```bash\ncurl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -\nsudo apt install -y nodejs\n```\n\n### 3. Configurar PostgreSQL\n\n```bash\nsudo -u postgres psql <<EOF\nCREATE USER podcast_user WITH PASSWORD 'tu_contraseÃ±a_segura';\nCREATE DATABASE podcast_platform OWNER podcast_user;\nGRANT ALL PRIVILEGES ON DATABASE podcast_platform TO podcast_user;\n\\c podcast_platform\nGRANT ALL ON SCHEMA public TO podcast_user;\nALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO podcast_user;\nALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO podcast_user;\nEOF\n```\n\n### 4. Configurar la AplicaciÃ³n\n\n```bash\n# Crear carpetas de uploads\nmkdir -p uploads/images uploads/audio\n\n# Copiar y configurar variables de entorno\ncp .env.example .env.production\nnano .env.production  # Editar segÃºn tus necesidades\n```\n\n### 5. Instalar y Construir\n\n```bash\nnpm ci\nnpm run db:push\nnpm run build\n```\n\n### 6. Iniciar la AplicaciÃ³n\n\n```bash\nNODE_ENV=production npm start\n```\n\n---\n\n## ðŸ” ConfiguraciÃ³n de Seguridad\n\n### 1. Configurar Firewall\n\n```bash\nsudo ufw allow 22/tcp    # SSH\nsudo ufw allow 5000/tcp  # AplicaciÃ³n (o tu puerto)\nsudo ufw enable\n```\n\n### 2. Configurar HTTPS con Nginx + Let's Encrypt\n\n```bash\n# Instalar Nginx\nsudo apt install -y nginx certbot python3-certbot-nginx\n\n# Configurar Nginx\nsudo nano /etc/nginx/sites-available/podcast-platform\n```\n\nContenido del archivo:\n```nginx\nserver {\n    listen 80;\n    server_name tu-dominio.com;\n\n    location / {\n        proxy_pass http://localhost:5000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n\n    client_max_body_size 200M;\n}\n```\n\n```bash\n# Habilitar el sitio\nsudo ln -s /etc/nginx/sites-available/podcast-platform /etc/nginx/sites-enabled/\nsudo nginx -t\nsudo systemctl reload nginx\n\n# Obtener certificado SSL\nsudo certbot --nginx -d tu-dominio.com\n```\n\n### 3. Cambiar ContraseÃ±a de Admin\n\nDespuÃ©s del primer login:\n1. Ir a Perfil â†’ Cambiar ContraseÃ±a\n2. Actualizar con una contraseÃ±a segura\n\n---\n\n## ðŸ“ Estructura del Proyecto\n\n```\npodcast-platform/\nâ”œâ”€â”€ client/              # Frontend (React + TypeScript)\nâ”‚   â”œâ”€â”€ src/\nâ”‚   â”‚   â”œâ”€â”€ components/  # Componentes reutilizables\nâ”‚   â”‚   â”œâ”€â”€ pages/       # PÃ¡ginas de la aplicaciÃ³n\nâ”‚   â”‚   â””â”€â”€ lib/         # Utilidades y configuraciÃ³n\nâ”œâ”€â”€ server/              # Backend (Express + TypeScript)\nâ”‚   â”œâ”€â”€ routes.ts        # Rutas API\nâ”‚   â”œâ”€â”€ storage.ts       # Capa de acceso a datos\nâ”‚   â””â”€â”€ index.ts         # Punto de entrada del servidor\nâ”œâ”€â”€ shared/              # CÃ³digo compartido\nâ”‚   â””â”€â”€ schema.ts        # Esquemas de base de datos (Drizzle)\nâ”œâ”€â”€ uploads/             # Almacenamiento de archivos\nâ”‚   â”œâ”€â”€ images/          # Portadas de podcasts/episodios\nâ”‚   â””â”€â”€ audio/           # Archivos de audio\nâ”œâ”€â”€ scripts/             # Scripts de utilidad\nâ”‚   â””â”€â”€ install.sh       # Script de instalaciÃ³n automatizada\nâ”œâ”€â”€ .env.example         # Ejemplo de variables de entorno\nâ””â”€â”€ README.md            # Este archivo\n```\n\n---\n\n## ðŸ”„ GestiÃ³n del Servicio Systemd\n\nSi configuraste systemd durante la instalaciÃ³n:\n\n```bash\n# Ver estado\nsudo systemctl status podcast-platform\n\n# Iniciar\nsudo systemctl start podcast-platform\n\n# Detener\nsudo systemctl stop podcast-platform\n\n# Reiniciar\nsudo systemctl restart podcast-platform\n\n# Ver logs\nsudo journalctl -u podcast-platform -f\n\n# Deshabilitar inicio automÃ¡tico\nsudo systemctl disable podcast-platform\n```\n\n---\n\n## ðŸ’¾ Backups\n\n### Backup Manual de Base de Datos\n\n```bash\n# Crear backup\nsudo -u postgres pg_dump podcast_platform > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restaurar backup\nsudo -u postgres psql podcast_platform < backup_YYYYMMDD_HHMMSS.sql\n```\n\n### Backup de Archivos\n\n```bash\n# Crear backup de uploads\ntar -czf uploads_backup_$(date +%Y%m%d_%H%M%S).tar.gz uploads/\n```\n\n### Script de Backup AutomÃ¡tico\n\nCrear `/usr/local/bin/podcast-backup.sh`:\n\n```bash\n#!/bin/bash\nBACKUP_DIR=\"/var/backups/podcast-platform\"\nDATE=$(date +%Y%m%d_%H%M%S)\n\nmkdir -p $BACKUP_DIR\n\n# Backup de base de datos\nsudo -u postgres pg_dump podcast_platform | gzip > \"$BACKUP_DIR/db_$DATE.sql.gz\"\n\n# Backup de uploads\ntar -czf \"$BACKUP_DIR/uploads_$DATE.tar.gz\" /var/www/podcast-platform/uploads\n\n# Eliminar backups antiguos (mÃ¡s de 30 dÃ­as)\nfind $BACKUP_DIR -type f -mtime +30 -delete\n```\n\nConfigurar cron para backups diarios:\n```bash\nsudo crontab -e\n# Agregar lÃ­nea:\n0 2 * * * /usr/local/bin/podcast-backup.sh\n```\n\n---\n\n## ðŸ› ï¸ Comandos de Desarrollo\n\n```bash\n# Instalar dependencias\nnpm install\n\n# Desarrollo con hot-reload\nnpm run dev\n\n# Construir para producciÃ³n\nnpm run build\n\n# Ejecutar migraciones de BD\nnpm run db:push\n\n# Ver estado de BD con Drizzle Studio\nnpm run db:studio\n\n# Linting\nnpm run lint\n```\n\n---\n\n## ðŸ“Š Variables de Entorno\n\nVer `.env.example` para la lista completa. Las mÃ¡s importantes:\n\n| Variable | DescripciÃ³n | Ejemplo |\n|----------|-------------|---------|\n| `DATABASE_URL` | URL de conexiÃ³n a PostgreSQL | `postgresql://user:pass@localhost:5432/dbname` |\n| `SESSION_SECRET` | Secreto para sesiones (aleatorio) | `your-random-secret-key` |\n| `STORAGE_PROVIDER` | Proveedor de almacenamiento | `LOCAL` |\n| `UPLOADS_ROOT` | Ruta de uploads | `/var/www/podcast-platform/uploads` |\n| `PUBLIC_URL` | URL pÃºblica de la aplicaciÃ³n | `https://tu-dominio.com` |\n| `ADMIN_EMAIL` | Email del administrador | `admin@tu-dominio.com` |\n| `ADMIN_PASSWORD` | ContraseÃ±a inicial del admin | `tu-contraseÃ±a-segura` |\n\n---\n\n## ðŸ› SoluciÃ³n de Problemas\n\n### La aplicaciÃ³n no inicia\n\n```bash\n# Verificar logs\nsudo journalctl -u podcast-platform -n 50\n\n# Verificar que el puerto estÃ© disponible\nsudo netstat -tlnp | grep 5000\n\n# Verificar permisos de uploads\nls -la uploads/\n```\n\n### Error de conexiÃ³n a base de datos\n\n```bash\n# Verificar que PostgreSQL estÃ© corriendo\nsudo systemctl status postgresql\n\n# Verificar credenciales en .env.production\ncat .env.production | grep DATABASE_URL\n\n# Probar conexiÃ³n manual\npsql -U podcast_user -d podcast_platform -h localhost\n```\n\n### Error de permisos en uploads\n\n```bash\n# Corregir permisos\nsudo chown -R $USER:$USER uploads/\nchmod -R 755 uploads/\n```\n\n---\n\n## ðŸ“ Licencia\n\nTodos los derechos reservados - Atreyu Servicios Digitales\n\n---\n\n## ðŸ†˜ Soporte\n\nPara problemas o preguntas, contactar a Atreyu Servicios Digitales.\n\n---\n\n## ðŸ”„ Actualizaciones\n\nPara actualizar la aplicaciÃ³n a una nueva versiÃ³n:\n\n```bash\n# 1. Hacer backup\nsudo systemctl stop podcast-platform\nsudo -u postgres pg_dump podcast_platform > backup_pre_update.sql\ntar -czf uploads_backup.tar.gz uploads/\n\n# 2. Actualizar cÃ³digo\ngit pull origin main\n\n# 3. Instalar nuevas dependencias\nnpm ci\n\n# 4. Ejecutar migraciones\nnpm run db:push\n\n# 5. Reconstruir\nnpm run build\n\n# 6. Reiniciar servicio\nsudo systemctl start podcast-platform\n```\n\n---\n\n**Â¡Gracias por usar nuestra plataforma de podcasting!** ðŸŽ‰\n","path":null,"size_bytes":10169,"size_tokens":null},"scripts/create-github-repo.ts":{"content":"import { Octokit } from '@octokit/rest';\n\nlet connectionSettings: any;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=github',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('GitHub not connected');\n  }\n  return accessToken;\n}\n\nasync function getGitHubClient() {\n  const accessToken = await getAccessToken();\n  return new Octokit({ auth: accessToken });\n}\n\nasync function createRepository(repoName: string, description: string, isPrivate: boolean = false) {\n  try {\n    const octokit = await getGitHubClient();\n    \n    console.log('ðŸ” Verificando usuario de GitHub...');\n    const { data: user } = await octokit.rest.users.getAuthenticated();\n    console.log(`âœ… Conectado como: ${user.login}`);\n    \n    console.log(`\\nðŸ“ Creando repositorio: ${repoName}...`);\n    const { data: repo } = await octokit.rest.repos.createForAuthenticatedUser({\n      name: repoName,\n      description: description,\n      private: isPrivate,\n      auto_init: false, // No crear README automÃ¡tico\n    });\n    \n    console.log(`âœ… Repositorio creado: ${repo.html_url}`);\n    console.log(`ðŸ“¡ URL de clonaciÃ³n: ${repo.clone_url}`);\n    \n    return {\n      success: true,\n      url: repo.html_url,\n      cloneUrl: repo.clone_url,\n      owner: user.login,\n      name: repoName,\n    };\n  } catch (error: any) {\n    if (error.status === 422) {\n      console.error('âŒ Error: El repositorio ya existe');\n      // Intentar obtener el repositorio existente\n      try {\n        const octokit = await getGitHubClient();\n        const { data: user } = await octokit.rest.users.getAuthenticated();\n        const { data: repo } = await octokit.rest.repos.get({\n          owner: user.login,\n          repo: repoName,\n        });\n        console.log(`â„¹ï¸  Usando repositorio existente: ${repo.html_url}`);\n        return {\n          success: true,\n          url: repo.html_url,\n          cloneUrl: repo.clone_url,\n          owner: user.login,\n          name: repoName,\n          existing: true,\n        };\n      } catch (e) {\n        console.error('âŒ Error al obtener repositorio existente:', e);\n        return { success: false, error: 'Repository exists but could not be accessed' };\n      }\n    }\n    console.error('âŒ Error al crear repositorio:', error.message);\n    return { success: false, error: error.message };\n  }\n}\n\n// Ejecutar\nconst repoName = process.argv[2] || 'podcast-platform';\nconst description = process.argv[3] || 'Plataforma Multitenant de Podcasts - Desarrollado por Atreyu Servicios Digitales';\nconst isPrivate = process.argv[4] === 'true';\n\ncreateRepository(repoName, description, isPrivate)\n  .then(result => {\n    if (result.success) {\n      console.log('\\nâœ¨ Repositorio listo para usar!');\n      process.exit(0);\n    } else {\n      console.error('\\nâŒ Error:', result.error);\n      process.exit(1);\n    }\n  })\n  .catch(err => {\n    console.error('âŒ Error inesperado:', err);\n    process.exit(1);\n  });\n","path":null,"size_bytes":3892,"size_tokens":null},"client/src/pages/audiobook-detail.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Link } from \"wouter\";\nimport { Play, Clock, BookOpen, Heart, ShoppingCart, User, Headphones, ChevronLeft, ExternalLink, Check, FileText } from \"lucide-react\";\nimport { SiAmazon } from \"react-icons/si\";\nimport { PayPalButton } from \"@/components/paypal-button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { AudiobookWithChapters, Chapter, BillingProfile } from \"@shared/schema\";\n\nfunction formatDuration(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  if (hours > 0) {\n    return `${hours}h ${minutes}m`;\n  }\n  return `${minutes}m`;\n}\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\nfunction ChapterItem({ chapter, index }: { chapter: Chapter; index: number }) {\n  return (\n    <Link href={`/chapter/${chapter.id}`}>\n      <div \n        className=\"flex items-center gap-4 p-4 rounded-lg hover-elevate cursor-pointer border border-transparent hover:border-border transition-colors\"\n        data-testid={`chapter-item-${chapter.id}`}\n      >\n        <div className=\"flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-semibold\">\n          {chapter.chapterNumber || index + 1}\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <h4 className=\"font-medium truncate\">{chapter.title}</h4>\n          {chapter.description && (\n            <p className=\"text-sm text-muted-foreground line-clamp-1\">{chapter.description}</p>\n          )}\n        </div>\n        <div className=\"flex items-center gap-4\">\n          <span className=\"text-sm text-muted-foreground\">\n            {formatDuration(chapter.duration)}\n          </span>\n          {chapter.isSample && (\n            <Badge variant=\"outline\" className=\"text-xs\">\n              Muestra\n            </Badge>\n          )}\n          <Button size=\"icon\" variant=\"ghost\">\n            <Play className=\"w-4 h-4\" />\n          </Button>\n        </div>\n      </div>\n    </Link>\n  );\n}\n\nexport default function AudiobookDetail() {\n  const [, params] = useRoute(\"/audiobook/:id\");\n  const [, setLocation] = useLocation();\n  const audiobookId = params?.id;\n  const [showPurchaseDialog, setShowPurchaseDialog] = useState(false);\n  const { toast } = useToast();\n\n  const { data: audiobook, isLoading, error } = useQuery<AudiobookWithChapters>({\n    queryKey: [`/api/audiobooks/${audiobookId}`],\n    enabled: !!audiobookId,\n  });\n\n  const { data: userPurchases } = useQuery<Array<{ audiobookId: string }>>({\n    queryKey: [\"/api/user/purchases\"],\n  });\n\n  const { data: userSubscription } = useQuery<{ subscription: { status: string } | null }>({\n    queryKey: [\"/api/user/subscription\"],\n  });\n\n  const { data: userFavorites } = useQuery<Array<{ id: string }>>({\n    queryKey: [\"/api/library/favorites\"],\n  });\n\n  const { data: cartStatus } = useQuery<{ isInCart: boolean }>({\n    queryKey: [\"/api/cart/check\", audiobookId],\n    enabled: !!audiobookId,\n  });\n\n  const { data: billingProfile } = useQuery<BillingProfile>({\n    queryKey: [\"/api/billing-profile\"],\n  });\n\n  const isBillingComplete = useMemo(() => {\n    if (!billingProfile) return false;\n    return !!(\n      billingProfile.fullName &&\n      billingProfile.email &&\n      billingProfile.address &&\n      billingProfile.city &&\n      billingProfile.postalCode &&\n      billingProfile.country\n    );\n  }, [billingProfile]);\n\n  const isFavorite = userFavorites?.some(f => f.id === audiobookId);\n  const isPurchased = userPurchases?.some(p => p.audiobookId === audiobookId);\n  const hasActiveSubscription = userSubscription?.subscription?.status === \"ACTIVE\";\n  const hasAccess = isPurchased || hasActiveSubscription || audiobook?.isFree || audiobook?.priceCents === 0;\n  const isInCart = cartStatus?.isInCart || false;\n\n  const handleToggleFavorite = async () => {\n    if (!audiobookId) return;\n    try {\n      if (isFavorite) {\n        await apiRequest(\"DELETE\", `/api/audiobooks/${audiobookId}/favorite`);\n        toast({\n          title: \"Eliminado de favoritos\",\n          description: \"El audiolibro se ha eliminado de tus favoritos\",\n        });\n      } else {\n        await apiRequest(\"POST\", `/api/audiobooks/${audiobookId}/favorite`);\n        toast({\n          title: \"Agregado a favoritos\",\n          description: \"El audiolibro se ha agregado a tus favoritos\",\n        });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/library/favorites\"] });\n    } catch (error: any) {\n      if (error.message?.includes(\"401\")) {\n        toast({\n          variant: \"destructive\",\n          title: \"No autenticado\",\n          description: \"Debes iniciar sesion para gestionar favoritos\",\n        });\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Error\",\n          description: \"No se pudo actualizar favoritos\",\n        });\n      }\n    }\n  };\n\n  const handleToggleCart = async () => {\n    if (!audiobookId) return;\n    try {\n      if (isInCart) {\n        await apiRequest(\"DELETE\", `/api/cart/${audiobookId}`);\n        toast({\n          title: \"Eliminado del carrito\",\n          description: \"El audiolibro se ha eliminado del carrito\",\n        });\n      } else {\n        await apiRequest(\"POST\", `/api/cart/${audiobookId}`);\n        toast({\n          title: \"Agregado al carrito\",\n          description: \"El audiolibro se ha agregado a tu carrito\",\n        });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart/check\", audiobookId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n    } catch (error: any) {\n      if (error.message?.includes(\"401\")) {\n        toast({\n          variant: \"destructive\",\n          title: \"No autenticado\",\n          description: \"Debes iniciar sesion para gestionar el carrito\",\n        });\n      } else if (error.message?.includes(\"Already purchased\")) {\n        toast({\n          variant: \"destructive\",\n          title: \"Ya comprado\",\n          description: \"Ya has comprado este audiolibro\",\n        });\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Error\",\n          description: \"No se pudo actualizar el carrito\",\n        });\n      }\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"flex flex-col lg:flex-row gap-8\">\n          <div className=\"lg:w-1/3\">\n            <Skeleton className=\"aspect-square rounded-xl\" />\n          </div>\n          <div className=\"lg:w-2/3 space-y-4\">\n            <Skeleton className=\"h-10 w-3/4\" />\n            <Skeleton className=\"h-6 w-1/2\" />\n            <Skeleton className=\"h-32 w-full\" />\n            <Skeleton className=\"h-12 w-48\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !audiobook) {\n    return (\n      <div className=\"container mx-auto px-4 py-16 text-center\">\n        <BookOpen className=\"w-16 h-16 mx-auto text-muted-foreground/50 mb-4\" />\n        <h2 className=\"text-2xl font-bold mb-2\">Audiolibro no encontrado</h2>\n        <p className=\"text-muted-foreground mb-6\">El audiolibro que buscas no existe o ha sido eliminado.</p>\n        <Link href=\"/\">\n          <Button>\n            <ChevronLeft className=\"w-4 h-4 mr-2\" />\n            Volver al inicio\n          </Button>\n        </Link>\n      </div>\n    );\n  }\n\n  const sortedChapters = [...(audiobook.chapters || [])].sort((a, b) => \n    (a.chapterNumber || 0) - (b.chapterNumber || 0)\n  );\n\n  return (\n    <div className=\"min-h-screen pb-16\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <Link href=\"/\">\n            <Button variant=\"ghost\" size=\"sm\" className=\"mb-6\">\n              <ChevronLeft className=\"w-4 h-4 mr-1\" />\n              Volver\n            </Button>\n          </Link>\n\n          <div className=\"flex flex-col lg:flex-row gap-8\">\n            <div className=\"lg:w-1/3 flex-shrink-0\">\n              <div className=\"aspect-square rounded-xl overflow-hidden shadow-xl sticky top-8\">\n                {audiobook.coverArtUrl ? (\n                  <img\n                    src={audiobook.coverArtUrl}\n                    alt={audiobook.title}\n                    className=\"w-full h-full object-cover\"\n                  />\n                ) : (\n                  <div className=\"w-full h-full bg-gradient-to-br from-primary/30 to-primary/60 flex items-center justify-center\">\n                    <BookOpen className=\"w-24 h-24 text-primary-foreground/60\" />\n                  </div>\n                )}\n              </div>\n            </div>\n\n            <div className=\"lg:w-2/3 space-y-6\">\n              <div>\n                <Badge variant=\"outline\" className=\"mb-3\">\n                  {audiobook.category}\n                </Badge>\n                <h1 className=\"font-serif text-4xl md:text-5xl font-bold mb-3\" data-testid=\"text-audiobook-title\">\n                  {audiobook.title}\n                </h1>\n                <div className=\"flex flex-wrap items-center gap-4 text-muted-foreground\">\n                  <span className=\"flex items-center gap-2\">\n                    <User className=\"w-4 h-4\" />\n                    {audiobook.author}\n                  </span>\n                  {audiobook.narrator && (\n                    <span className=\"flex items-center gap-2\">\n                      <Headphones className=\"w-4 h-4\" />\n                      {audiobook.narrator}\n                    </span>\n                  )}\n                  <span className=\"flex items-center gap-2\">\n                    <Clock className=\"w-4 h-4\" />\n                    {formatDuration(audiobook.totalDuration)}\n                  </span>\n                </div>\n              </div>\n\n              <p className=\"text-lg leading-relaxed text-muted-foreground\">\n                {audiobook.description}\n              </p>\n\n              <div className=\"flex flex-wrap gap-4\">\n                {audiobook.isFree || audiobook.priceCents === 0 ? (\n                  <Link href={sortedChapters[0] ? `/chapter/${sortedChapters[0].id}` : \"#\"}>\n                    <Button size=\"lg\" className=\"gap-2\" data-testid=\"button-listen-free\">\n                      <Play className=\"w-5 h-5\" />\n                      Escuchar gratis\n                    </Button>\n                  </Link>\n                ) : hasAccess ? (\n                  <Link href={sortedChapters[0] ? `/chapter/${sortedChapters[0].id}` : \"#\"}>\n                    <Button size=\"lg\" className=\"gap-2\" data-testid=\"button-listen\">\n                      <Play className=\"w-5 h-5\" />\n                      Escuchar ahora\n                    </Button>\n                  </Link>\n                ) : (\n                  <>\n                    {isBillingComplete ? (\n                      <Button \n                        size=\"lg\" \n                        className=\"gap-2\" \n                        onClick={() => setShowPurchaseDialog(true)}\n                        data-testid=\"button-buy\"\n                      >\n                        <ShoppingCart className=\"w-5 h-5\" />\n                        Comprar por {formatPrice(audiobook.priceCents, audiobook.currency)}\n                      </Button>\n                    ) : (\n                      <Link href=\"/checkout\">\n                        <Button \n                          size=\"lg\" \n                          className=\"gap-2\" \n                          data-testid=\"button-complete-billing\"\n                        >\n                          <FileText className=\"w-5 h-5\" />\n                          Completar datos para comprar\n                        </Button>\n                      </Link>\n                    )}\n                    <Button \n                      size=\"lg\" \n                      variant={isInCart ? \"secondary\" : \"outline\"}\n                      className=\"gap-2\" \n                      data-testid=\"button-add-to-cart\"\n                      onClick={handleToggleCart}\n                    >\n                      <ShoppingCart className={`w-5 h-5 ${isInCart ? \"fill-current\" : \"\"}`} />\n                      {isInCart ? \"En el carrito\" : \"Agregar al carrito\"}\n                    </Button>\n                    <Button \n                      size=\"lg\" \n                      variant={isFavorite ? \"default\" : \"outline\"}\n                      className=\"gap-2\" \n                      data-testid=\"button-favorite\"\n                      onClick={handleToggleFavorite}\n                    >\n                      <Heart className={`w-5 h-5 ${isFavorite ? \"fill-current\" : \"\"}`} />\n                      {isFavorite ? \"En favoritos\" : \"Agregar a favoritos\"}\n                    </Button>\n                  </>\n                )}\n                {(isPurchased || hasActiveSubscription) && (\n                  <Badge variant=\"secondary\" className=\"flex items-center gap-1 px-3 py-2\">\n                    <Check className=\"w-4 h-4\" />\n                    {hasActiveSubscription ? \"Suscriptor\" : \"Comprado\"}\n                  </Badge>\n                )}\n              </div>\n              \n              {(audiobook.amazonEbookUrl || audiobook.amazonPrintUrl) && (\n                <div className=\"flex flex-wrap gap-3\">\n                  {audiobook.amazonEbookUrl && (\n                    <a \n                      href={audiobook.amazonEbookUrl} \n                      target=\"_blank\" \n                      rel=\"noopener noreferrer\"\n                      data-testid=\"link-amazon-ebook\"\n                    >\n                      <Button variant=\"outline\" className=\"gap-2\">\n                        <SiAmazon className=\"w-4 h-4\" />\n                        Ebook en Amazon\n                        <ExternalLink className=\"w-3 h-3\" />\n                      </Button>\n                    </a>\n                  )}\n                  {audiobook.amazonPrintUrl && (\n                    <a \n                      href={audiobook.amazonPrintUrl} \n                      target=\"_blank\" \n                      rel=\"noopener noreferrer\"\n                      data-testid=\"link-amazon-print\"\n                    >\n                      <Button variant=\"outline\" className=\"gap-2\">\n                        <SiAmazon className=\"w-4 h-4\" />\n                        Impreso en Amazon\n                        <ExternalLink className=\"w-3 h-3\" />\n                      </Button>\n                    </a>\n                  )}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <h2 className=\"font-serif text-2xl font-bold mb-6\">\n              Capitulos ({sortedChapters.length})\n            </h2>\n            <div className=\"space-y-2\">\n              {sortedChapters.map((chapter, index) => (\n                <ChapterItem \n                  key={chapter.id} \n                  chapter={chapter} \n                  index={index} \n                />\n              ))}\n              {sortedChapters.length === 0 && (\n                <p className=\"text-center text-muted-foreground py-8\">\n                  Este audiolibro aun no tiene capitulos.\n                </p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={showPurchaseDialog} onOpenChange={setShowPurchaseDialog}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"font-serif text-2xl\">Comprar audiolibro</DialogTitle>\n            <DialogDescription>\n              Completa tu compra de \"{audiobook.title}\" con PayPal\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-6 py-4\">\n            <div className=\"flex items-center gap-4\">\n              {audiobook.coverArtUrl && (\n                <img \n                  src={audiobook.coverArtUrl} \n                  alt={audiobook.title}\n                  className=\"w-20 h-20 rounded-lg object-cover\"\n                />\n              )}\n              <div>\n                <h3 className=\"font-semibold\">{audiobook.title}</h3>\n                <p className=\"text-sm text-muted-foreground\">{audiobook.author}</p>\n                <p className=\"text-lg font-bold text-primary mt-1\">\n                  {formatPrice(audiobook.priceCents, audiobook.currency)}\n                </p>\n              </div>\n            </div>\n            <PayPalButton\n              audiobookId={audiobookId || \"\"}\n              priceCents={audiobook.priceCents}\n              currency={audiobook.currency}\n              onSuccess={() => {\n                setShowPurchaseDialog(false);\n                window.location.reload();\n              }}\n            />\n            <p className=\"text-xs text-center text-muted-foreground\">\n              Despues de la compra tendras acceso permanente a este audiolibro\n            </p>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":17581,"size_tokens":null},"client/src/pages/admin-audiobooks.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Trash2, Search, BookOpen, Eye, Plus, Upload, X, Pencil, Globe, GlobeLock } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport type { Audiobook } from \"@shared/schema\";\n\nasync function uploadCoverImage(file: File): Promise<string> {\n  const formData = new FormData();\n  formData.append(\"file\", file);\n  \n  const response = await fetch(\"/api/uploads/cover\", {\n    method: \"POST\",\n    body: formData,\n    credentials: \"include\",\n  });\n  \n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error || \"Error al subir la imagen\");\n  }\n  \n  const data = await response.json();\n  return data.publicUrl;\n}\n\nconst CATEGORIES = [\n  \"Fiction\",\n  \"Non-Fiction\",\n  \"Mystery\",\n  \"Romance\",\n  \"Science Fiction\",\n  \"Fantasy\",\n  \"Biography\",\n  \"Self-Help\",\n  \"Business\",\n  \"History\",\n  \"Children\",\n  \"Young Adult\",\n];\n\nexport default function AdminAudiobooks() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedAudiobook, setSelectedAudiobook] = useState<Audiobook | null>(null);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [editingAudiobook, setEditingAudiobook] = useState<Audiobook | null>(null);\n  const [coverFile, setCoverFile] = useState<File | null>(null);\n  const [coverPreview, setCoverPreview] = useState<string | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  \n  // Form state\n  const [formData, setFormData] = useState({\n    title: \"\",\n    author: \"\",\n    narrator: \"\",\n    description: \"\",\n    coverArtUrl: \"\",\n    category: \"Fiction\",\n    language: \"es\",\n    priceCents: 0,\n    currency: \"EUR\",\n    isFree: true,\n    amazonEbookUrl: \"\",\n    amazonPrintUrl: \"\",\n  });\n\n  const { data: audiobooks = [], isLoading } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/admin/audiobooks\"],\n  });\n\n  const deleteAudiobookMutation = useMutation({\n    mutationFn: async (audiobookId: string) => {\n      return await apiRequest(\"DELETE\", `/api/admin/audiobooks/${audiobookId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audiobooks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audiobooks\"] });\n      toast({\n        title: \"Audiolibro eliminado\",\n        description: \"El audiolibro ha sido eliminado correctamente.\",\n      });\n      setSelectedAudiobook(null);\n      setShowDeleteDialog(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo eliminar el audiolibro.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createAudiobookMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return await apiRequest(\"POST\", \"/api/admin/audiobooks\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audiobooks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audiobooks\"] });\n      toast({\n        title: \"Audiolibro creado\",\n        description: \"El audiolibro ha sido creado correctamente.\",\n      });\n      setShowCreateDialog(false);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo crear el audiolibro.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateAudiobookMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof formData }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/audiobooks/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audiobooks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audiobooks\"] });\n      toast({\n        title: \"Audiolibro actualizado\",\n        description: \"El audiolibro ha sido actualizado correctamente.\",\n      });\n      setShowEditDialog(false);\n      setEditingAudiobook(null);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el audiolibro.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const publishAudiobookMutation = useMutation({\n    mutationFn: async (audiobookId: string) => {\n      return await apiRequest(\"POST\", `/api/admin/audiobooks/${audiobookId}/publish`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audiobooks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audiobooks\"] });\n      toast({\n        title: \"Audiolibro publicado\",\n        description: \"El audiolibro ahora es visible para los usuarios.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo publicar el audiolibro.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unpublishAudiobookMutation = useMutation({\n    mutationFn: async (audiobookId: string) => {\n      return await apiRequest(\"POST\", `/api/admin/audiobooks/${audiobookId}/unpublish`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audiobooks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audiobooks\"] });\n      toast({\n        title: \"Audiolibro despublicado\",\n        description: \"El audiolibro ya no es visible para los usuarios.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo despublicar el audiolibro.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      title: \"\",\n      author: \"\",\n      narrator: \"\",\n      description: \"\",\n      coverArtUrl: \"\",\n      category: \"Fiction\",\n      language: \"es\",\n      priceCents: 0,\n      currency: \"EUR\",\n      isFree: true,\n      amazonEbookUrl: \"\",\n      amazonPrintUrl: \"\",\n    });\n    setCoverFile(null);\n    setCoverPreview(null);\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (!file.type.startsWith(\"image/\")) {\n        toast({\n          title: \"Error\",\n          description: \"Solo se permiten archivos de imagen\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      if (file.size > 2 * 1024 * 1024) {\n        toast({\n          title: \"Error\",\n          description: \"La imagen debe ser menor a 2MB\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setCoverFile(file);\n      setCoverPreview(URL.createObjectURL(file));\n      setFormData({ ...formData, coverArtUrl: \"\" });\n    }\n  };\n\n  const removeCoverFile = () => {\n    setCoverFile(null);\n    if (coverPreview) {\n      URL.revokeObjectURL(coverPreview);\n      setCoverPreview(null);\n    }\n  };\n\n  const filteredAudiobooks = audiobooks.filter((audiobook) => {\n    const query = searchQuery.toLowerCase();\n    return (\n      audiobook.title.toLowerCase().includes(query) ||\n      audiobook.author.toLowerCase().includes(query) ||\n      audiobook.category.toLowerCase().includes(query)\n    );\n  });\n\n  const handleDeleteClick = (audiobook: Audiobook) => {\n    setSelectedAudiobook(audiobook);\n    setShowDeleteDialog(true);\n  };\n\n  const handleEditClick = (audiobook: Audiobook) => {\n    setEditingAudiobook(audiobook);\n    setFormData({\n      title: audiobook.title,\n      author: audiobook.author,\n      narrator: audiobook.narrator || \"\",\n      description: audiobook.description,\n      coverArtUrl: audiobook.coverArtUrl || \"\",\n      category: audiobook.category,\n      language: audiobook.language || \"es\",\n      priceCents: audiobook.priceCents,\n      currency: audiobook.currency,\n      isFree: audiobook.isFree,\n      amazonEbookUrl: audiobook.amazonEbookUrl || \"\",\n      amazonPrintUrl: audiobook.amazonPrintUrl || \"\",\n    });\n    setCoverPreview(audiobook.coverArtUrl || null);\n    setShowEditDialog(true);\n  };\n\n  const handleEditSubmit = async () => {\n    if (!editingAudiobook) return;\n    \n    if (!formData.title || !formData.author || !formData.description) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor completa los campos obligatorios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let coverArtUrl = formData.coverArtUrl;\n\n    if (coverFile) {\n      try {\n        setIsUploading(true);\n        coverArtUrl = await uploadCoverImage(coverFile);\n      } catch (error: any) {\n        toast({\n          title: \"Error al subir portada\",\n          description: error.message || \"No se pudo subir la imagen de portada.\",\n          variant: \"destructive\",\n        });\n        setIsUploading(false);\n        return;\n      } finally {\n        setIsUploading(false);\n      }\n    }\n\n    updateAudiobookMutation.mutate({ \n      id: editingAudiobook.id, \n      data: { ...formData, coverArtUrl } \n    });\n  };\n\n  const confirmDelete = () => {\n    if (selectedAudiobook) {\n      deleteAudiobookMutation.mutate(selectedAudiobook.id);\n    }\n  };\n\n  const handleCreateSubmit = async () => {\n    if (!formData.title || !formData.author || !formData.description) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor completa los campos obligatorios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let coverArtUrl = formData.coverArtUrl;\n\n    // Si hay un archivo de portada, subirlo primero\n    if (coverFile) {\n      try {\n        setIsUploading(true);\n        coverArtUrl = await uploadCoverImage(coverFile);\n      } catch (error: any) {\n        toast({\n          title: \"Error al subir portada\",\n          description: error.message || \"No se pudo subir la imagen de portada.\",\n          variant: \"destructive\",\n        });\n        setIsUploading(false);\n        return;\n      } finally {\n        setIsUploading(false);\n      }\n    }\n\n    createAudiobookMutation.mutate({ ...formData, coverArtUrl });\n  };\n\n  const formatPrice = (cents: number, currency: string = \"EUR\") => {\n    return new Intl.NumberFormat(\"es-ES\", {\n      style: \"currency\",\n      currency: currency,\n    }).format(cents / 100);\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <CardTitle className=\"font-serif text-2xl flex items-center gap-2\">\n                <BookOpen className=\"w-6 h-6\" />\n                Gestion de Audiolibros\n              </CardTitle>\n              <CardDescription>\n                Administra todos los audiolibros del catalogo\n              </CardDescription>\n            </div>\n            <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-add-audiobook\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              AÃ±adir Audiolibro\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center gap-4 mb-6\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n              <Input\n                placeholder=\"Buscar audiolibros...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-audiobooks\"\n              />\n            </div>\n          </div>\n\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"w-8 h-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredAudiobooks.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <BookOpen className=\"w-12 h-12 mx-auto text-muted-foreground/50 mb-4\" />\n              <p className=\"text-muted-foreground\">No se encontraron audiolibros</p>\n            </div>\n          ) : (\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Titulo</TableHead>\n                    <TableHead>Autor</TableHead>\n                    <TableHead>Categoria</TableHead>\n                    <TableHead>Precio</TableHead>\n                    <TableHead>Estado</TableHead>\n                    <TableHead>Publicado</TableHead>\n                    <TableHead className=\"text-right\">Acciones</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredAudiobooks.map((audiobook) => (\n                    <TableRow key={audiobook.id} data-testid={`row-audiobook-${audiobook.id}`}>\n                      <TableCell>\n                        <div className=\"flex items-center gap-3\">\n                          {audiobook.coverArtUrl ? (\n                            <img\n                              src={audiobook.coverArtUrl}\n                              alt={audiobook.title}\n                              className=\"w-10 h-10 object-cover rounded\"\n                            />\n                          ) : (\n                            <div className=\"w-10 h-10 bg-primary/10 rounded flex items-center justify-center\">\n                              <BookOpen className=\"w-4 h-4 text-muted-foreground\" />\n                            </div>\n                          )}\n                          <span className=\"font-medium\">{audiobook.title}</span>\n                        </div>\n                      </TableCell>\n                      <TableCell>{audiobook.author}</TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">{audiobook.category}</Badge>\n                      </TableCell>\n                      <TableCell>\n                        {audiobook.isFree ? (\n                          <Badge className=\"bg-accent text-accent-foreground\">Gratis</Badge>\n                        ) : (\n                          formatPrice(audiobook.priceCents, audiobook.currency)\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={audiobook.status === \"APPROVED\" ? \"default\" : audiobook.status === \"REJECTED\" ? \"destructive\" : \"secondary\"}>\n                          {audiobook.status}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        {audiobook.publishedAt ? (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => unpublishAudiobookMutation.mutate(audiobook.id)}\n                            disabled={unpublishAudiobookMutation.isPending}\n                            className=\"gap-1 text-green-600 hover:text-green-700\"\n                            data-testid={`button-unpublish-audiobook-${audiobook.id}`}\n                          >\n                            <Globe className=\"w-4 h-4\" />\n                            Publicado\n                          </Button>\n                        ) : (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => publishAudiobookMutation.mutate(audiobook.id)}\n                            disabled={publishAudiobookMutation.isPending}\n                            className=\"gap-1 text-muted-foreground\"\n                            data-testid={`button-publish-audiobook-${audiobook.id}`}\n                          >\n                            <GlobeLock className=\"w-4 h-4\" />\n                            No publicado\n                          </Button>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end gap-2\">\n                          <Link href={`/audiobook/${audiobook.id}`}>\n                            <Button variant=\"ghost\" size=\"icon\">\n                              <Eye className=\"w-4 h-4\" />\n                            </Button>\n                          </Link>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleEditClick(audiobook)}\n                            data-testid={`button-edit-audiobook-${audiobook.id}`}\n                          >\n                            <Pencil className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleDeleteClick(audiobook)}\n                            data-testid={`button-delete-audiobook-${audiobook.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Create Dialog */}\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"font-serif\">AÃ±adir Nuevo Audiolibro</DialogTitle>\n            <DialogDescription>\n              Completa los datos del nuevo audiolibro\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"title\">Titulo *</Label>\n              <Input\n                id=\"title\"\n                value={formData.title}\n                onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                placeholder=\"El titulo del audiolibro\"\n                data-testid=\"input-audiobook-title\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"author\">Autor *</Label>\n                <Input\n                  id=\"author\"\n                  value={formData.author}\n                  onChange={(e) => setFormData({ ...formData, author: e.target.value })}\n                  placeholder=\"Nombre del autor\"\n                  data-testid=\"input-audiobook-author\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"narrator\">Narrador</Label>\n                <Input\n                  id=\"narrator\"\n                  value={formData.narrator}\n                  onChange={(e) => setFormData({ ...formData, narrator: e.target.value })}\n                  placeholder=\"Nombre del narrador\"\n                  data-testid=\"input-audiobook-narrator\"\n                />\n              </div>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"description\">Descripcion *</Label>\n              <Textarea\n                id=\"description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Describe el audiolibro...\"\n                rows={4}\n                data-testid=\"input-audiobook-description\"\n              />\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label>Portada del audiolibro</Label>\n              \n              {/* Preview de imagen (cuadrada 1:1) */}\n              {(coverPreview || formData.coverArtUrl) && (\n                <div className=\"relative w-32 h-32 mx-auto\">\n                  <img\n                    src={coverPreview || formData.coverArtUrl}\n                    alt=\"Preview portada\"\n                    className=\"w-full h-full object-contain rounded-md border bg-muted\"\n                  />\n                  {coverPreview && (\n                    <Button\n                      type=\"button\"\n                      variant=\"destructive\"\n                      size=\"icon\"\n                      className=\"absolute -top-2 -right-2 h-6 w-6\"\n                      onClick={removeCoverFile}\n                      data-testid=\"button-remove-cover\"\n                    >\n                      <X className=\"w-3 h-3\" />\n                    </Button>\n                  )}\n                </div>\n              )}\n\n              {/* Subida de archivo */}\n              {!coverFile && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-center w-full\">\n                    <label\n                      htmlFor=\"coverFile\"\n                      className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer hover-elevate\"\n                      data-testid=\"label-upload-cover\"\n                    >\n                      <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                        <Upload className=\"w-8 h-8 mb-2 text-muted-foreground\" />\n                        <p className=\"text-sm text-muted-foreground\">\n                          <span className=\"font-semibold\">Haz clic</span> o arrastra una imagen\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">PNG, JPG (max. 2MB)</p>\n                      </div>\n                      <input\n                        id=\"coverFile\"\n                        type=\"file\"\n                        className=\"hidden\"\n                        accept=\"image/*\"\n                        onChange={handleFileChange}\n                        data-testid=\"input-cover-file\"\n                      />\n                    </label>\n                  </div>\n                  \n                  <div className=\"relative\">\n                    <div className=\"absolute inset-0 flex items-center\">\n                      <span className=\"w-full border-t\" />\n                    </div>\n                    <div className=\"relative flex justify-center text-xs uppercase\">\n                      <span className=\"bg-background px-2 text-muted-foreground\">O usa una URL</span>\n                    </div>\n                  </div>\n                  \n                  <Input\n                    id=\"coverArtUrl\"\n                    value={formData.coverArtUrl}\n                    onChange={(e) => setFormData({ ...formData, coverArtUrl: e.target.value })}\n                    placeholder=\"https://ejemplo.com/portada.jpg\"\n                    data-testid=\"input-audiobook-cover-url\"\n                  />\n                </div>\n              )}\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"category\">Categoria</Label>\n                <Select\n                  value={formData.category}\n                  onValueChange={(value) => setFormData({ ...formData, category: value })}\n                >\n                  <SelectTrigger data-testid=\"select-audiobook-category\">\n                    <SelectValue placeholder=\"Selecciona una categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {CATEGORIES.map((cat) => (\n                      <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"language\">Idioma</Label>\n                <Select\n                  value={formData.language}\n                  onValueChange={(value) => setFormData({ ...formData, language: value })}\n                >\n                  <SelectTrigger data-testid=\"select-audiobook-language\">\n                    <SelectValue placeholder=\"Selecciona idioma\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"es\">EspaÃ±ol</SelectItem>\n                    <SelectItem value=\"en\">English</SelectItem>\n                    <SelectItem value=\"fr\">FranÃ§ais</SelectItem>\n                    <SelectItem value=\"de\">Deutsch</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center justify-between border rounded-lg p-4\">\n              <div className=\"space-y-0.5\">\n                <Label htmlFor=\"isFree\">Audiolibro gratuito</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Activar si el audiolibro es de acceso gratuito\n                </p>\n              </div>\n              <Switch\n                id=\"isFree\"\n                checked={formData.isFree}\n                onCheckedChange={(checked) => setFormData({ ...formData, isFree: checked, priceCents: checked ? 0 : formData.priceCents })}\n                data-testid=\"switch-audiobook-free\"\n              />\n            </div>\n            \n            {!formData.isFree && (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"price\">Precio (en centimos)</Label>\n                  <Input\n                    id=\"price\"\n                    type=\"number\"\n                    min={0}\n                    value={formData.priceCents}\n                    onChange={(e) => setFormData({ ...formData, priceCents: parseInt(e.target.value) || 0 })}\n                    placeholder=\"999\"\n                    data-testid=\"input-audiobook-price\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    {formatPrice(formData.priceCents, formData.currency)}\n                  </p>\n                </div>\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"currency\">Moneda</Label>\n                  <Select\n                    value={formData.currency}\n                    onValueChange={(value) => setFormData({ ...formData, currency: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-audiobook-currency\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"EUR\">EUR</SelectItem>\n                      <SelectItem value=\"USD\">USD</SelectItem>\n                      <SelectItem value=\"GBP\">GBP</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            )}\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"amazonEbookUrl\">URL Amazon Ebook</Label>\n              <Input\n                id=\"amazonEbookUrl\"\n                value={formData.amazonEbookUrl}\n                onChange={(e) => setFormData({ ...formData, amazonEbookUrl: e.target.value })}\n                placeholder=\"https://amazon.com/dp/...\"\n                data-testid=\"input-audiobook-amazon-ebook\"\n              />\n              <p className=\"text-xs text-muted-foreground\">Enlace a la version ebook en Amazon</p>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"amazonPrintUrl\">URL Amazon Impreso</Label>\n              <Input\n                id=\"amazonPrintUrl\"\n                value={formData.amazonPrintUrl}\n                onChange={(e) => setFormData({ ...formData, amazonPrintUrl: e.target.value })}\n                placeholder=\"https://amazon.com/dp/...\"\n                data-testid=\"input-audiobook-amazon-print\"\n              />\n              <p className=\"text-xs text-muted-foreground\">Enlace a la version impresa en Amazon</p>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowCreateDialog(false); resetForm(); }}>\n              Cancelar\n            </Button>\n            <Button onClick={handleCreateSubmit} disabled={createAudiobookMutation.isPending || isUploading} data-testid=\"button-submit-audiobook\">\n              {(createAudiobookMutation.isPending || isUploading) ? (\n                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <Plus className=\"w-4 h-4 mr-2\" />\n              )}\n              {isUploading ? \"Subiendo imagen...\" : \"Crear Audiolibro\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Dialog */}\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Eliminar audiolibro</AlertDialogTitle>\n            <AlertDialogDescription>\n              Esta accion no se puede deshacer. Se eliminara permanentemente el audiolibro\n              \"{selectedAudiobook?.title}\" y todos sus capitulos.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              {deleteAudiobookMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Eliminar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Edit Dialog */}\n      <Dialog open={showEditDialog} onOpenChange={(open) => { setShowEditDialog(open); if (!open) { resetForm(); setEditingAudiobook(null); } }}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"font-serif\">Editar Audiolibro</DialogTitle>\n            <DialogDescription>\n              Modifica los datos del audiolibro\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-title\">Titulo *</Label>\n              <Input\n                id=\"edit-title\"\n                value={formData.title}\n                onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                placeholder=\"El titulo del audiolibro\"\n                data-testid=\"input-edit-audiobook-title\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-author\">Autor *</Label>\n                <Input\n                  id=\"edit-author\"\n                  value={formData.author}\n                  onChange={(e) => setFormData({ ...formData, author: e.target.value })}\n                  placeholder=\"Nombre del autor\"\n                  data-testid=\"input-edit-audiobook-author\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-narrator\">Narrador</Label>\n                <Input\n                  id=\"edit-narrator\"\n                  value={formData.narrator}\n                  onChange={(e) => setFormData({ ...formData, narrator: e.target.value })}\n                  placeholder=\"Nombre del narrador\"\n                  data-testid=\"input-edit-audiobook-narrator\"\n                />\n              </div>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-description\">Descripcion *</Label>\n              <Textarea\n                id=\"edit-description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Describe el audiolibro...\"\n                rows={4}\n                data-testid=\"input-edit-audiobook-description\"\n              />\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label>Portada del audiolibro</Label>\n              \n              {(coverPreview || formData.coverArtUrl) && (\n                <div className=\"relative w-32 h-32 mx-auto\">\n                  <img\n                    src={coverPreview || formData.coverArtUrl}\n                    alt=\"Preview portada\"\n                    className=\"w-full h-full object-contain rounded-md border bg-muted\"\n                  />\n                  <Button\n                    type=\"button\"\n                    variant=\"destructive\"\n                    size=\"icon\"\n                    className=\"absolute -top-2 -right-2 h-6 w-6\"\n                    onClick={() => {\n                      removeCoverFile();\n                      setFormData({ ...formData, coverArtUrl: \"\" });\n                      setCoverPreview(null);\n                    }}\n                    data-testid=\"button-edit-remove-cover\"\n                  >\n                    <X className=\"w-3 h-3\" />\n                  </Button>\n                </div>\n              )}\n\n              {!coverFile && !coverPreview && !formData.coverArtUrl && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-center w-full\">\n                    <label\n                      htmlFor=\"editCoverFile\"\n                      className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer hover-elevate\"\n                      data-testid=\"label-edit-upload-cover\"\n                    >\n                      <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                        <Upload className=\"w-8 h-8 mb-2 text-muted-foreground\" />\n                        <p className=\"text-sm text-muted-foreground\">\n                          Subir imagen de portada\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">PNG, JPG (max. 2MB)</p>\n                      </div>\n                      <input\n                        id=\"editCoverFile\"\n                        type=\"file\"\n                        className=\"hidden\"\n                        accept=\"image/*\"\n                        onChange={handleFileChange}\n                        data-testid=\"input-edit-upload-cover\"\n                      />\n                    </label>\n                  </div>\n                  \n                  <div className=\"relative\">\n                    <div className=\"absolute inset-0 flex items-center\">\n                      <span className=\"w-full border-t\" />\n                    </div>\n                    <div className=\"relative flex justify-center text-xs uppercase\">\n                      <span className=\"bg-background px-2 text-muted-foreground\">O usa una URL</span>\n                    </div>\n                  </div>\n                  \n                  <Input\n                    id=\"editCoverArtUrl\"\n                    value={formData.coverArtUrl}\n                    onChange={(e) => setFormData({ ...formData, coverArtUrl: e.target.value })}\n                    placeholder=\"https://ejemplo.com/portada.jpg\"\n                    data-testid=\"input-edit-audiobook-cover-url\"\n                  />\n                </div>\n              )}\n\n              {!coverFile && (coverPreview || formData.coverArtUrl) && (\n                <div className=\"mt-2\">\n                  <label\n                    htmlFor=\"editCoverFileReplace\"\n                    className=\"text-sm text-primary cursor-pointer hover:underline\"\n                    data-testid=\"label-edit-replace-cover\"\n                  >\n                    Cambiar imagen\n                  </label>\n                  <input\n                    id=\"editCoverFileReplace\"\n                    type=\"file\"\n                    className=\"hidden\"\n                    accept=\"image/*\"\n                    onChange={handleFileChange}\n                    data-testid=\"input-edit-replace-cover\"\n                  />\n                </div>\n              )}\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-category\">Categoria</Label>\n                <Select\n                  value={formData.category}\n                  onValueChange={(value) => setFormData({ ...formData, category: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-audiobook-category\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {CATEGORIES.map((cat) => (\n                      <SelectItem key={cat} value={cat}>\n                        {cat}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-language\">Idioma</Label>\n                <Select\n                  value={formData.language}\n                  onValueChange={(value) => setFormData({ ...formData, language: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-audiobook-language\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"es\">EspaÃ±ol</SelectItem>\n                    <SelectItem value=\"en\">English</SelectItem>\n                    <SelectItem value=\"fr\">FranÃ§ais</SelectItem>\n                    <SelectItem value=\"de\">Deutsch</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center space-x-2\">\n              <Switch\n                id=\"edit-isFree\"\n                checked={formData.isFree}\n                onCheckedChange={(checked) => setFormData({ ...formData, isFree: checked })}\n                data-testid=\"switch-edit-audiobook-free\"\n              />\n              <Label htmlFor=\"edit-isFree\">Audiolibro gratuito</Label>\n            </div>\n            \n            {!formData.isFree && (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"edit-price\">Precio (centimos)</Label>\n                  <Input\n                    id=\"edit-price\"\n                    type=\"number\"\n                    min=\"0\"\n                    step=\"1\"\n                    value={formData.priceCents}\n                    onChange={(e) => setFormData({ ...formData, priceCents: parseInt(e.target.value) || 0 })}\n                    placeholder=\"999\"\n                    data-testid=\"input-edit-audiobook-price\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    {formatPrice(formData.priceCents, formData.currency)}\n                  </p>\n                </div>\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"edit-currency\">Moneda</Label>\n                  <Select\n                    value={formData.currency}\n                    onValueChange={(value) => setFormData({ ...formData, currency: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-edit-audiobook-currency\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"EUR\">EUR</SelectItem>\n                      <SelectItem value=\"USD\">USD</SelectItem>\n                      <SelectItem value=\"GBP\">GBP</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            )}\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-amazonEbookUrl\">URL Amazon Ebook</Label>\n              <Input\n                id=\"edit-amazonEbookUrl\"\n                value={formData.amazonEbookUrl}\n                onChange={(e) => setFormData({ ...formData, amazonEbookUrl: e.target.value })}\n                placeholder=\"https://amazon.com/dp/...\"\n                data-testid=\"input-edit-audiobook-amazon-ebook\"\n              />\n              <p className=\"text-xs text-muted-foreground\">Enlace a la version ebook en Amazon</p>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-amazonPrintUrl\">URL Amazon Impreso</Label>\n              <Input\n                id=\"edit-amazonPrintUrl\"\n                value={formData.amazonPrintUrl}\n                onChange={(e) => setFormData({ ...formData, amazonPrintUrl: e.target.value })}\n                placeholder=\"https://amazon.com/dp/...\"\n                data-testid=\"input-edit-audiobook-amazon-print\"\n              />\n              <p className=\"text-xs text-muted-foreground\">Enlace a la version impresa en Amazon</p>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowEditDialog(false); resetForm(); setEditingAudiobook(null); }}>\n              Cancelar\n            </Button>\n            <Button onClick={handleEditSubmit} disabled={updateAudiobookMutation.isPending || isUploading} data-testid=\"button-submit-edit-audiobook\">\n              {(updateAudiobookMutation.isPending || isUploading) ? (\n                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <Pencil className=\"w-4 h-4 mr-2\" />\n              )}\n              {isUploading ? \"Subiendo imagen...\" : \"Guardar Cambios\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":43268,"size_tokens":null},"client/src/pages/admin-chapters.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Trash2, Search, Play, Plus, Upload, X, Music, Pencil } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport type { Chapter, Audiobook } from \"@shared/schema\";\n\nasync function uploadAudioFile(file: File): Promise<{ url: string; duration: number }> {\n  const formData = new FormData();\n  formData.append(\"file\", file);\n  \n  const response = await fetch(\"/api/uploads/audio\", {\n    method: \"POST\",\n    body: formData,\n    credentials: \"include\",\n  });\n  \n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error || \"Error al subir el audio\");\n  }\n  \n  const data = await response.json();\n  return { url: data.publicUrl, duration: data.duration || 0 };\n}\n\ninterface ChapterWithAudiobook extends Chapter {\n  audiobook: Audiobook;\n}\n\nfunction formatDuration(seconds: number): string {\n  const hours = Math.floor(seconds / 3600);\n  const minutes = Math.floor((seconds % 3600) / 60);\n  const secs = seconds % 60;\n  if (hours > 0) {\n    return `${hours}:${minutes.toString().padStart(2, \"0\")}:${secs.toString().padStart(2, \"0\")}`;\n  }\n  return `${minutes}:${secs.toString().padStart(2, \"0\")}`;\n}\n\nexport default function AdminChapters() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedAudiobookFilter, setSelectedAudiobookFilter] = useState<string>(\"all\");\n  const [selectedChapter, setSelectedChapter] = useState<ChapterWithAudiobook | null>(null);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [editingChapter, setEditingChapter] = useState<ChapterWithAudiobook | null>(null);\n  const [audioFile, setAudioFile] = useState<File | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  \n  // Form state\n  const [formData, setFormData] = useState({\n    title: \"\",\n    chapterNumber: 1,\n    description: \"\",\n    audioUrl: \"\",\n    duration: 0,\n    isSample: false,\n    audiobookId: \"\",\n  });\n\n  const { data: chapters = [], isLoading } = useQuery<ChapterWithAudiobook[]>({\n    queryKey: [\"/api/admin/chapters\"],\n  });\n\n  const { data: audiobooks = [] } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/admin/audiobooks\"],\n  });\n\n  const deleteChapterMutation = useMutation({\n    mutationFn: async (chapterId: string) => {\n      return await apiRequest(\"DELETE\", `/api/admin/chapters/${chapterId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/chapters\"] });\n      toast({\n        title: \"Capitulo eliminado\",\n        description: \"El capitulo ha sido eliminado correctamente.\",\n      });\n      setSelectedChapter(null);\n      setShowDeleteDialog(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo eliminar el capitulo.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createChapterMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return await apiRequest(\"POST\", \"/api/admin/chapters\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/chapters\"] });\n      toast({\n        title: \"Capitulo creado\",\n        description: \"El capitulo ha sido creado correctamente.\",\n      });\n      setShowCreateDialog(false);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo crear el capitulo.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateChapterMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof formData }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/chapters/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/chapters\"] });\n      toast({\n        title: \"Capitulo actualizado\",\n        description: \"El capitulo ha sido actualizado correctamente.\",\n      });\n      setShowEditDialog(false);\n      setEditingChapter(null);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el capitulo.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      title: \"\",\n      chapterNumber: 1,\n      description: \"\",\n      audioUrl: \"\",\n      duration: 0,\n      isSample: false,\n      audiobookId: \"\",\n    });\n    setAudioFile(null);\n  };\n\n  const handleAudioFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (!file.type.startsWith(\"audio/\")) {\n        toast({\n          title: \"Error\",\n          description: \"Solo se permiten archivos de audio\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      if (file.size > 500 * 1024 * 1024) {\n        toast({\n          title: \"Error\",\n          description: \"El archivo debe ser menor a 500MB\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setAudioFile(file);\n      setFormData({ ...formData, audioUrl: \"\" });\n    }\n  };\n\n  const removeAudioFile = () => {\n    setAudioFile(null);\n  };\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes < 1024) return bytes + \" B\";\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + \" KB\";\n    return (bytes / (1024 * 1024)).toFixed(1) + \" MB\";\n  };\n\n  const filteredChapters = chapters.filter((chapter) => {\n    const query = searchQuery.toLowerCase();\n    const matchesSearch = (\n      chapter.title.toLowerCase().includes(query) ||\n      chapter.audiobook?.title.toLowerCase().includes(query)\n    );\n    const matchesAudiobook = selectedAudiobookFilter === \"all\" || chapter.audiobookId === selectedAudiobookFilter;\n    return matchesSearch && matchesAudiobook;\n  });\n\n  const handleDeleteClick = (chapter: ChapterWithAudiobook) => {\n    setSelectedChapter(chapter);\n    setShowDeleteDialog(true);\n  };\n\n  const handleEditClick = (chapter: ChapterWithAudiobook) => {\n    setEditingChapter(chapter);\n    setFormData({\n      title: chapter.title,\n      chapterNumber: chapter.chapterNumber,\n      description: chapter.description || \"\",\n      audioUrl: chapter.audioUrl || \"\",\n      duration: chapter.duration || 0,\n      isSample: chapter.isSample || false,\n      audiobookId: chapter.audiobookId,\n    });\n    setShowEditDialog(true);\n  };\n\n  const handleEditSubmit = async () => {\n    if (!editingChapter) return;\n    \n    if (!formData.title) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor completa los campos obligatorios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let audioUrl = formData.audioUrl;\n    let duration = formData.duration;\n\n    if (audioFile) {\n      try {\n        setIsUploading(true);\n        const result = await uploadAudioFile(audioFile);\n        audioUrl = result.url;\n        if (result.duration > 0) {\n          duration = result.duration;\n        }\n      } catch (error: any) {\n        toast({\n          title: \"Error al subir audio\",\n          description: error.message || \"No se pudo subir el archivo de audio.\",\n          variant: \"destructive\",\n        });\n        setIsUploading(false);\n        return;\n      } finally {\n        setIsUploading(false);\n      }\n    }\n\n    updateChapterMutation.mutate({ \n      id: editingChapter.id, \n      data: { ...formData, audioUrl, duration } \n    });\n  };\n\n  const confirmDelete = () => {\n    if (selectedChapter) {\n      deleteChapterMutation.mutate(selectedChapter.id);\n    }\n  };\n\n  const handleCreateSubmit = async () => {\n    if (!formData.title || !formData.audiobookId) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor completa los campos obligatorios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let audioUrl = formData.audioUrl;\n    let duration = formData.duration;\n\n    // Si hay un archivo de audio, subirlo primero\n    if (audioFile) {\n      try {\n        setIsUploading(true);\n        const result = await uploadAudioFile(audioFile);\n        audioUrl = result.url;\n        if (result.duration > 0) {\n          duration = result.duration;\n        }\n      } catch (error: any) {\n        toast({\n          title: \"Error al subir audio\",\n          description: error.message || \"No se pudo subir el archivo de audio.\",\n          variant: \"destructive\",\n        });\n        setIsUploading(false);\n        return;\n      } finally {\n        setIsUploading(false);\n      }\n    }\n\n    createChapterMutation.mutate({ ...formData, audioUrl, duration });\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <CardTitle className=\"font-serif text-2xl flex items-center gap-2\">\n                <Play className=\"w-6 h-6\" />\n                Gestion de Capitulos\n              </CardTitle>\n              <CardDescription>\n                Administra todos los capitulos de los audiolibros\n              </CardDescription>\n            </div>\n            <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-add-chapter\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              AÃ±adir Capitulo\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center gap-4 mb-6 flex-wrap\">\n            <div className=\"relative flex-1 min-w-[200px]\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n              <Input\n                placeholder=\"Buscar capitulos...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-chapters\"\n              />\n            </div>\n            <Select\n              value={selectedAudiobookFilter}\n              onValueChange={setSelectedAudiobookFilter}\n            >\n              <SelectTrigger className=\"w-[250px]\" data-testid=\"select-audiobook-filter\">\n                <SelectValue placeholder=\"Filtrar por audiolibro\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Todos los audiolibros</SelectItem>\n                {audiobooks.map((book) => (\n                  <SelectItem key={book.id} value={book.id}>{book.title}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"w-8 h-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredChapters.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Play className=\"w-12 h-12 mx-auto text-muted-foreground/50 mb-4\" />\n              <p className=\"text-muted-foreground\">No se encontraron capitulos</p>\n            </div>\n          ) : (\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Capitulo</TableHead>\n                    <TableHead>Audiolibro</TableHead>\n                    <TableHead>Duracion</TableHead>\n                    <TableHead>Tipo</TableHead>\n                    <TableHead className=\"text-right\">Acciones</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredChapters.map((chapter) => (\n                    <TableRow key={chapter.id} data-testid={`row-chapter-${chapter.id}`}>\n                      <TableCell>\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium\">\n                            {chapter.chapterNumber || \"-\"}\n                          </div>\n                          <span className=\"font-medium\">{chapter.title}</span>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Link href={`/audiobook/${chapter.audiobook?.id}`}>\n                          <span className=\"text-primary hover:underline\">\n                            {chapter.audiobook?.title || \"Desconocido\"}\n                          </span>\n                        </Link>\n                      </TableCell>\n                      <TableCell>{formatDuration(chapter.duration)}</TableCell>\n                      <TableCell>\n                        {chapter.isSample ? (\n                          <Badge variant=\"outline\">Muestra</Badge>\n                        ) : (\n                          <Badge variant=\"secondary\">Completo</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end gap-2\">\n                          <Link href={`/chapter/${chapter.id}`}>\n                            <Button variant=\"ghost\" size=\"icon\">\n                              <Play className=\"w-4 h-4\" />\n                            </Button>\n                          </Link>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleEditClick(chapter)}\n                            data-testid={`button-edit-chapter-${chapter.id}`}\n                          >\n                            <Pencil className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleDeleteClick(chapter)}\n                            data-testid={`button-delete-chapter-${chapter.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Create Dialog */}\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"max-w-xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"font-serif\">AÃ±adir Nuevo Capitulo</DialogTitle>\n            <DialogDescription>\n              Completa los datos del nuevo capitulo\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"audiobookId\">Audiolibro *</Label>\n              <Select\n                value={formData.audiobookId}\n                onValueChange={(value) => setFormData({ ...formData, audiobookId: value })}\n              >\n                <SelectTrigger data-testid=\"select-chapter-audiobook\">\n                  <SelectValue placeholder=\"Selecciona un audiolibro\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {audiobooks.map((book) => (\n                    <SelectItem key={book.id} value={book.id}>{book.title}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"title\">Titulo *</Label>\n                <Input\n                  id=\"title\"\n                  value={formData.title}\n                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                  placeholder=\"Capitulo 1: Introduccion\"\n                  data-testid=\"input-chapter-title\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"chapterNumber\">Numero de capitulo</Label>\n                <Input\n                  id=\"chapterNumber\"\n                  type=\"number\"\n                  min={1}\n                  value={formData.chapterNumber}\n                  onChange={(e) => setFormData({ ...formData, chapterNumber: parseInt(e.target.value) || 1 })}\n                  data-testid=\"input-chapter-number\"\n                />\n              </div>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"description\">Descripcion</Label>\n              <Textarea\n                id=\"description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Describe el contenido del capitulo...\"\n                rows={3}\n                data-testid=\"input-chapter-description\"\n              />\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label>Archivo de audio</Label>\n              \n              {/* Audio file selected */}\n              {audioFile && (\n                <div className=\"flex items-center gap-3 p-3 border rounded-lg bg-muted/50\">\n                  <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                    <Music className=\"w-5 h-5 text-primary\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium truncate\">{audioFile.name}</p>\n                    <p className=\"text-sm text-muted-foreground\">{formatFileSize(audioFile.size)}</p>\n                  </div>\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={removeAudioFile}\n                    data-testid=\"button-remove-audio\"\n                  >\n                    <X className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              )}\n\n              {/* Audio upload */}\n              {!audioFile && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-center w-full\">\n                    <label\n                      htmlFor=\"audioFile\"\n                      className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer hover-elevate\"\n                      data-testid=\"label-upload-audio\"\n                    >\n                      <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                        <Upload className=\"w-8 h-8 mb-2 text-muted-foreground\" />\n                        <p className=\"text-sm text-muted-foreground\">\n                          <span className=\"font-semibold\">Haz clic</span> o arrastra un archivo de audio\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">MP3, M4A, WAV (max. 500MB)</p>\n                      </div>\n                      <input\n                        id=\"audioFile\"\n                        type=\"file\"\n                        className=\"hidden\"\n                        accept=\"audio/*\"\n                        onChange={handleAudioFileChange}\n                        data-testid=\"input-audio-file\"\n                      />\n                    </label>\n                  </div>\n                  \n                  <div className=\"relative\">\n                    <div className=\"absolute inset-0 flex items-center\">\n                      <span className=\"w-full border-t\" />\n                    </div>\n                    <div className=\"relative flex justify-center text-xs uppercase\">\n                      <span className=\"bg-background px-2 text-muted-foreground\">O usa una URL</span>\n                    </div>\n                  </div>\n                  \n                  <Input\n                    id=\"audioUrl\"\n                    value={formData.audioUrl}\n                    onChange={(e) => setFormData({ ...formData, audioUrl: e.target.value })}\n                    placeholder=\"https://ejemplo.com/audio.mp3\"\n                    data-testid=\"input-chapter-audio-url\"\n                  />\n                </div>\n              )}\n            </div>\n            \n            {!audioFile && (\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"duration\">Duracion (segundos)</Label>\n                <Input\n                  id=\"duration\"\n                  type=\"number\"\n                  min={0}\n                  value={formData.duration}\n                  onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) || 0 })}\n                  placeholder=\"3600\"\n                  data-testid=\"input-chapter-duration\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  {formatDuration(formData.duration)} {audioFile && \"(se detectara automaticamente)\"}\n                </p>\n              </div>\n            )}\n            \n            <div className=\"flex items-center justify-between border rounded-lg p-4\">\n              <div className=\"space-y-0.5\">\n                <Label htmlFor=\"isSample\">Capitulo de muestra</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Activar si es un capitulo gratuito de muestra\n                </p>\n              </div>\n              <Switch\n                id=\"isSample\"\n                checked={formData.isSample}\n                onCheckedChange={(checked) => setFormData({ ...formData, isSample: checked })}\n                data-testid=\"switch-chapter-sample\"\n              />\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowCreateDialog(false); resetForm(); }}>\n              Cancelar\n            </Button>\n            <Button onClick={handleCreateSubmit} disabled={createChapterMutation.isPending || isUploading} data-testid=\"button-submit-chapter\">\n              {(createChapterMutation.isPending || isUploading) ? (\n                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <Plus className=\"w-4 h-4 mr-2\" />\n              )}\n              {isUploading ? \"Subiendo audio...\" : \"Crear Capitulo\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Dialog */}\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Eliminar capitulo</AlertDialogTitle>\n            <AlertDialogDescription>\n              Esta accion no se puede deshacer. Se eliminara permanentemente el capitulo\n              \"{selectedChapter?.title}\".\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              {deleteChapterMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Eliminar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Edit Dialog */}\n      <Dialog open={showEditDialog} onOpenChange={(open) => { setShowEditDialog(open); if (!open) { resetForm(); setEditingChapter(null); } }}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"font-serif\">Editar Capitulo</DialogTitle>\n            <DialogDescription>\n              Modifica los datos del capitulo\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-chapter-title\">Titulo *</Label>\n              <Input\n                id=\"edit-chapter-title\"\n                value={formData.title}\n                onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                placeholder=\"El titulo del capitulo\"\n                data-testid=\"input-edit-chapter-title\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-chapterNumber\">Numero de capitulo</Label>\n                <Input\n                  id=\"edit-chapterNumber\"\n                  type=\"number\"\n                  min={1}\n                  value={formData.chapterNumber}\n                  onChange={(e) => setFormData({ ...formData, chapterNumber: parseInt(e.target.value) || 1 })}\n                  data-testid=\"input-edit-chapter-number\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-duration\">Duracion (segundos)</Label>\n                <Input\n                  id=\"edit-duration\"\n                  type=\"number\"\n                  min={0}\n                  value={formData.duration}\n                  onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) || 0 })}\n                  data-testid=\"input-edit-chapter-duration\"\n                />\n                <p className=\"text-xs text-muted-foreground\">{formatDuration(formData.duration)}</p>\n              </div>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-chapter-description\">Descripcion</Label>\n              <Textarea\n                id=\"edit-chapter-description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Describe el capitulo...\"\n                rows={3}\n                data-testid=\"input-edit-chapter-description\"\n              />\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label>Audio del capitulo</Label>\n              \n              {formData.audioUrl && !audioFile && (\n                <div className=\"flex items-center gap-2 p-3 border rounded-lg bg-muted/50\">\n                  <Music className=\"w-5 h-5 text-muted-foreground\" />\n                  <span className=\"text-sm text-muted-foreground flex-1 truncate\">Audio actual configurado</span>\n                </div>\n              )}\n              \n              {audioFile ? (\n                <div className=\"flex items-center gap-2 p-3 border rounded-lg bg-muted/50\">\n                  <Music className=\"w-5 h-5 text-muted-foreground\" />\n                  <span className=\"text-sm flex-1 truncate\">{audioFile.name}</span>\n                  <span className=\"text-xs text-muted-foreground\">{formatFileSize(audioFile.size)}</span>\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-6 w-6\"\n                    onClick={removeAudioFile}\n                    data-testid=\"button-edit-remove-audio\"\n                  >\n                    <X className=\"w-3 h-3\" />\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-center w-full\">\n                    <label\n                      htmlFor=\"editAudioFile\"\n                      className=\"flex flex-col items-center justify-center w-full h-24 border-2 border-dashed rounded-lg cursor-pointer hover-elevate\"\n                      data-testid=\"label-edit-upload-audio\"\n                    >\n                      <div className=\"flex flex-col items-center justify-center pt-3 pb-3\">\n                        <Upload className=\"w-6 h-6 mb-2 text-muted-foreground\" />\n                        <p className=\"text-sm text-muted-foreground\">\n                          Cambiar archivo de audio\n                        </p>\n                      </div>\n                      <input\n                        id=\"editAudioFile\"\n                        type=\"file\"\n                        className=\"hidden\"\n                        accept=\"audio/*\"\n                        onChange={handleAudioFileChange}\n                        data-testid=\"input-edit-audio-file\"\n                      />\n                    </label>\n                  </div>\n                </div>\n              )}\n            </div>\n            \n            <div className=\"flex items-center justify-between border rounded-lg p-4\">\n              <div className=\"space-y-0.5\">\n                <Label htmlFor=\"edit-isSample\">Capitulo de muestra</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Activar si es un capitulo gratuito de muestra\n                </p>\n              </div>\n              <Switch\n                id=\"edit-isSample\"\n                checked={formData.isSample}\n                onCheckedChange={(checked) => setFormData({ ...formData, isSample: checked })}\n                data-testid=\"switch-edit-chapter-sample\"\n              />\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowEditDialog(false); resetForm(); setEditingChapter(null); }}>\n              Cancelar\n            </Button>\n            <Button onClick={handleEditSubmit} disabled={updateChapterMutation.isPending || isUploading} data-testid=\"button-submit-edit-chapter\">\n              {(updateChapterMutation.isPending || isUploading) ? (\n                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <Pencil className=\"w-4 h-4 mr-2\" />\n              )}\n              {isUploading ? \"Subiendo audio...\" : \"Guardar Cambios\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":31505,"size_tokens":null},"client/src/pages/chapter-player.tsx":{"content":"import { useState, useRef, useEffect, useCallback, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\nimport { \n  Play, \n  Pause, \n  SkipBack, \n  SkipForward, \n  Volume2, \n  VolumeX,\n  ChevronLeft,\n  BookOpen,\n  RotateCcw,\n  RotateCw,\n  List,\n  Gauge,\n  Moon,\n  Clock,\n  Settings,\n  X\n} from \"lucide-react\";\nimport type { ChapterWithAudiobook, Chapter } from \"@shared/schema\";\n\nfunction formatTime(seconds: number): string {\n  if (!seconds || isNaN(seconds)) return \"0:00\";\n  const h = Math.floor(seconds / 3600);\n  const m = Math.floor((seconds % 3600) / 60);\n  const s = Math.floor(seconds % 60);\n  if (h > 0) {\n    return `${h}:${m.toString().padStart(2, \"0\")}:${s.toString().padStart(2, \"0\")}`;\n  }\n  return `${m}:${s.toString().padStart(2, \"0\")}`;\n}\n\nfunction formatTimeRemaining(seconds: number): string {\n  if (!seconds || isNaN(seconds)) return \"-0:00\";\n  return `-${formatTime(seconds)}`;\n}\n\nconst PLAYBACK_SPEEDS = [0.5, 0.75, 0.8, 1, 1.1, 1.25, 1.5, 1.75, 2, 2.5, 3];\nconst SKIP_AMOUNTS = [10, 15, 30];\nconst SLEEP_TIMER_OPTIONS = [\n  { label: \"5 min\", value: 5 * 60 },\n  { label: \"10 min\", value: 10 * 60 },\n  { label: \"15 min\", value: 15 * 60 },\n  { label: \"30 min\", value: 30 * 60 },\n  { label: \"45 min\", value: 45 * 60 },\n  { label: \"1 hora\", value: 60 * 60 },\n  { label: \"Final del capÃ­tulo\", value: -1 },\n];\n\nexport default function ChapterPlayer() {\n  const [, params] = useRoute(\"/chapter/:id\");\n  const chapterId = params?.id;\n  const [, setLocation] = useLocation();\n\n  const audioRef = useRef<HTMLAudioElement>(null);\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [currentTime, setCurrentTime] = useState(0);\n  const [duration, setDuration] = useState(0);\n  const [volume, setVolume] = useState(1);\n  const [isMuted, setIsMuted] = useState(false);\n  const [playbackRate, setPlaybackRate] = useState(1);\n  const [skipAmount, setSkipAmount] = useState(15);\n  const [showTimeRemaining, setShowTimeRemaining] = useState(false);\n  const [sleepTimer, setSleepTimer] = useState<number | null>(null);\n  const [sleepTimerRemaining, setSleepTimerRemaining] = useState<number | null>(null);\n  const [jumpDialogOpen, setJumpDialogOpen] = useState(false);\n  const [jumpMinutes, setJumpMinutes] = useState(\"\");\n  const [jumpSeconds, setJumpSeconds] = useState(\"\");\n  const [mobileSettingsOpen, setMobileSettingsOpen] = useState(false);\n  const sleepTimerInterval = useRef<NodeJS.Timeout | null>(null);\n\n  const { data: chapter, isLoading, error } = useQuery<ChapterWithAudiobook>({\n    queryKey: [`/api/chapters/${chapterId}`],\n    enabled: !!chapterId,\n  });\n\n  const { data: audiobookData } = useQuery<{ chapters: Chapter[] }>({\n    queryKey: [`/api/audiobooks/${chapter?.audiobook.id}`],\n    enabled: !!chapter?.audiobook.id,\n  });\n  \n  const allChapters = audiobookData?.chapters || [];\n\n  const { previousChapter, nextChapter } = useMemo(() => {\n    if (!chapter || allChapters.length === 0) {\n      return { previousChapter: null, nextChapter: null };\n    }\n    const sortedChapters = [...allChapters].sort((a, b) => a.chapterNumber - b.chapterNumber);\n    const currentIndex = sortedChapters.findIndex(c => c.id === chapter.id);\n    \n    return {\n      previousChapter: currentIndex > 0 ? sortedChapters[currentIndex - 1] : null,\n      nextChapter: currentIndex < sortedChapters.length - 1 ? sortedChapters[currentIndex + 1] : null,\n    };\n  }, [chapter, allChapters]);\n\n  const goToPreviousChapter = () => {\n    if (previousChapter) {\n      setLocation(`/chapter/${previousChapter.id}`);\n    }\n  };\n\n  const goToNextChapter = () => {\n    if (nextChapter) {\n      setLocation(`/chapter/${nextChapter.id}`);\n    }\n  };\n\n  useEffect(() => {\n    const audio = audioRef.current;\n    if (!audio) return;\n\n    const updateTime = () => setCurrentTime(audio.currentTime);\n    const updateDuration = () => setDuration(audio.duration || 0);\n    const handleEnded = () => {\n      setIsPlaying(false);\n      if (sleepTimer === -1) {\n        cancelSleepTimer();\n      }\n    };\n\n    audio.addEventListener(\"timeupdate\", updateTime);\n    audio.addEventListener(\"loadedmetadata\", updateDuration);\n    audio.addEventListener(\"ended\", handleEnded);\n\n    return () => {\n      audio.removeEventListener(\"timeupdate\", updateTime);\n      audio.removeEventListener(\"loadedmetadata\", updateDuration);\n      audio.removeEventListener(\"ended\", handleEnded);\n    };\n  }, [chapter, sleepTimer]);\n\n  // Sleep timer logic\n  useEffect(() => {\n    if (sleepTimerRemaining !== null && sleepTimerRemaining > 0 && isPlaying) {\n      sleepTimerInterval.current = setInterval(() => {\n        setSleepTimerRemaining(prev => {\n          if (prev === null || prev <= 1) {\n            if (audioRef.current) {\n              audioRef.current.pause();\n              setIsPlaying(false);\n            }\n            cancelSleepTimer();\n            return null;\n          }\n          return prev - 1;\n        });\n      }, 1000);\n    }\n\n    return () => {\n      if (sleepTimerInterval.current) {\n        clearInterval(sleepTimerInterval.current);\n      }\n    };\n  }, [sleepTimerRemaining, isPlaying]);\n\n  const cancelSleepTimer = useCallback(() => {\n    setSleepTimer(null);\n    setSleepTimerRemaining(null);\n    if (sleepTimerInterval.current) {\n      clearInterval(sleepTimerInterval.current);\n    }\n  }, []);\n\n  const startSleepTimer = useCallback((seconds: number) => {\n    if (seconds === -1) {\n      setSleepTimer(-1);\n      setSleepTimerRemaining(null);\n    } else {\n      setSleepTimer(seconds);\n      setSleepTimerRemaining(seconds);\n    }\n  }, []);\n\n  const togglePlay = () => {\n    const audio = audioRef.current;\n    if (!audio) return;\n\n    if (isPlaying) {\n      audio.pause();\n    } else {\n      audio.play();\n    }\n    setIsPlaying(!isPlaying);\n  };\n\n  const seek = (value: number[]) => {\n    const audio = audioRef.current;\n    if (!audio) return;\n    audio.currentTime = value[0];\n    setCurrentTime(value[0]);\n  };\n\n  const skipForward = () => {\n    const audio = audioRef.current;\n    if (!audio) return;\n    audio.currentTime = Math.min(duration, audio.currentTime + skipAmount);\n  };\n\n  const skipBackward = () => {\n    const audio = audioRef.current;\n    if (!audio) return;\n    audio.currentTime = Math.max(0, audio.currentTime - skipAmount);\n  };\n\n  const toggleMute = () => {\n    const audio = audioRef.current;\n    if (!audio) return;\n    audio.muted = !isMuted;\n    setIsMuted(!isMuted);\n  };\n\n  const changeVolume = (value: number[]) => {\n    const audio = audioRef.current;\n    if (!audio) return;\n    audio.volume = value[0];\n    setVolume(value[0]);\n    if (value[0] > 0 && isMuted) {\n      setIsMuted(false);\n      audio.muted = false;\n    }\n  };\n\n  const changePlaybackRate = (rate: number) => {\n    setPlaybackRate(rate);\n    if (audioRef.current) {\n      audioRef.current.playbackRate = rate;\n    }\n  };\n\n  const handleJumpToTime = () => {\n    const mins = parseInt(jumpMinutes) || 0;\n    const secs = parseInt(jumpSeconds) || 0;\n    const totalSeconds = (mins * 60) + secs;\n    \n    if (audioRef.current && totalSeconds >= 0 && totalSeconds <= duration) {\n      audioRef.current.currentTime = totalSeconds;\n      setCurrentTime(totalSeconds);\n      setJumpDialogOpen(false);\n      setJumpMinutes(\"\");\n      setJumpSeconds(\"\");\n    }\n  };\n\n  const timeRemaining = duration - currentTime;\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-2xl\">\n          <CardContent className=\"p-8 space-y-6\">\n            <Skeleton className=\"h-64 w-64 mx-auto rounded-xl\" />\n            <div className=\"space-y-2 text-center\">\n              <Skeleton className=\"h-8 w-3/4 mx-auto\" />\n              <Skeleton className=\"h-6 w-1/2 mx-auto\" />\n            </div>\n            <Skeleton className=\"h-2 w-full\" />\n            <div className=\"flex justify-center gap-4\">\n              <Skeleton className=\"h-12 w-12 rounded-full\" />\n              <Skeleton className=\"h-16 w-16 rounded-full\" />\n              <Skeleton className=\"h-12 w-12 rounded-full\" />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (error || !chapter) {\n    return (\n      <div className=\"container mx-auto px-4 py-16 text-center\">\n        <BookOpen className=\"w-16 h-16 mx-auto text-muted-foreground/50 mb-4\" />\n        <h2 className=\"text-2xl font-bold mb-2\">Capitulo no encontrado</h2>\n        <p className=\"text-muted-foreground mb-6\">El capitulo que buscas no existe.</p>\n        <Link href=\"/\">\n          <Button>\n            <ChevronLeft className=\"w-4 h-4 mr-2\" />\n            Volver al inicio\n          </Button>\n        </Link>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-primary/5 to-background flex flex-col\">\n      <div className=\"container mx-auto px-4 py-4\">\n        <Link href={`/audiobook/${chapter.audiobook.id}`}>\n          <Button variant=\"ghost\" size=\"sm\">\n            <ChevronLeft className=\"w-4 h-4 mr-1\" />\n            Volver al audiolibro\n          </Button>\n        </Link>\n      </div>\n\n      <div className=\"flex-1 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-2xl shadow-xl\">\n          <CardContent className=\"p-8\">\n            <div className=\"aspect-square max-w-xs mx-auto mb-8 rounded-xl overflow-hidden shadow-lg\">\n              {chapter.audiobook.coverArtUrl ? (\n                <img\n                  src={chapter.audiobook.coverArtUrl}\n                  alt={chapter.audiobook.title}\n                  className=\"w-full h-full object-cover\"\n                />\n              ) : (\n                <div className=\"w-full h-full bg-gradient-to-br from-primary/30 to-primary/60 flex items-center justify-center\">\n                  <BookOpen className=\"w-24 h-24 text-primary-foreground/60\" />\n                </div>\n              )}\n            </div>\n\n            <div className=\"text-center mb-6\">\n              <h1 className=\"font-serif text-2xl font-bold mb-2\" data-testid=\"text-chapter-title\">\n                {chapter.title}\n              </h1>\n              <Link href={`/audiobook/${chapter.audiobook.id}`}>\n                <p className=\"text-muted-foreground hover:text-primary transition-colors\">\n                  {chapter.audiobook.title} - {chapter.audiobook.author}\n                </p>\n              </Link>\n              {sleepTimer !== null && (\n                <p className=\"text-xs text-primary flex items-center justify-center gap-1 mt-2\">\n                  <Moon className=\"h-3 w-3\" />\n                  {sleepTimer === -1 \n                    ? \"Apagar al final del capÃ­tulo\" \n                    : sleepTimerRemaining \n                      ? `Apagar en ${formatTime(sleepTimerRemaining)}`\n                      : null\n                  }\n                </p>\n              )}\n            </div>\n\n            {chapter.audioUrl && (\n              <audio ref={audioRef} src={chapter.audioUrl} preload=\"metadata\" />\n            )}\n\n            {/* Progress Bar */}\n            <div className=\"space-y-2 mb-6\">\n              <Slider\n                value={[currentTime]}\n                max={duration || 100}\n                step={1}\n                onValueChange={seek}\n                className=\"w-full\"\n                data-testid=\"slider-progress\"\n              />\n              <div className=\"flex justify-between text-sm text-muted-foreground\">\n                <span data-testid=\"text-current-time\">{formatTime(currentTime)}</span>\n                <button \n                  onClick={() => setShowTimeRemaining(!showTimeRemaining)}\n                  className=\"hover:text-foreground transition-colors\"\n                  data-testid=\"button-toggle-time\"\n                >\n                  {showTimeRemaining \n                    ? formatTimeRemaining(timeRemaining)\n                    : formatTime(duration)\n                  }\n                </button>\n              </div>\n            </div>\n\n            {/* Main Playback Controls */}\n            <div className=\"flex items-center justify-center gap-4 mb-6\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={skipBackward}\n                className=\"relative\"\n                data-testid=\"button-skip-back\"\n                title={`Retroceder ${skipAmount}s`}\n              >\n                <RotateCcw className=\"w-6 h-6\" />\n                <span className=\"absolute text-[10px] font-bold\">{skipAmount}</span>\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={goToPreviousChapter}\n                disabled={!previousChapter}\n                data-testid=\"button-previous\"\n                title={previousChapter ? `Ir a: ${previousChapter.title}` : \"No hay capitulo anterior\"}\n              >\n                <SkipBack className=\"w-6 h-6\" />\n              </Button>\n              <Button\n                size=\"lg\"\n                className=\"w-16 h-16 rounded-full\"\n                onClick={togglePlay}\n                data-testid=\"button-play-pause\"\n              >\n                {isPlaying ? (\n                  <Pause className=\"w-8 h-8\" />\n                ) : (\n                  <Play className=\"w-8 h-8 ml-1\" />\n                )}\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={goToNextChapter}\n                disabled={!nextChapter}\n                data-testid=\"button-next\"\n                title={nextChapter ? `Ir a: ${nextChapter.title}` : \"No hay capitulo siguiente\"}\n              >\n                <SkipForward className=\"w-6 h-6\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={skipForward}\n                className=\"relative\"\n                data-testid=\"button-skip-forward\"\n                title={`Avanzar ${skipAmount}s`}\n              >\n                <RotateCw className=\"w-6 h-6\" />\n                <span className=\"absolute text-[10px] font-bold\">{skipAmount}</span>\n              </Button>\n            </div>\n\n            {/* Advanced Controls Row */}\n            <div className=\"flex items-center justify-between flex-wrap gap-4\">\n              {/* Volume */}\n              <div className=\"flex items-center gap-2\">\n                <Button variant=\"ghost\" size=\"icon\" onClick={toggleMute} data-testid=\"button-mute\">\n                  {isMuted || volume === 0 ? (\n                    <VolumeX className=\"w-5 h-5\" />\n                  ) : (\n                    <Volume2 className=\"w-5 h-5\" />\n                  )}\n                </Button>\n                <Slider\n                  value={[isMuted ? 0 : volume]}\n                  max={1}\n                  step={0.01}\n                  onValueChange={changeVolume}\n                  className=\"w-20\"\n                  data-testid=\"slider-volume\"\n                />\n              </div>\n\n              {/* Desktop Advanced Controls */}\n              <div className=\"hidden md:flex items-center gap-2\">\n                {/* Playback Speed */}\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button variant=\"outline\" size=\"sm\" className=\"gap-1\" data-testid=\"button-speed\">\n                      <Gauge className=\"h-4 w-4\" />\n                      {playbackRate}x\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent className=\"max-h-64 overflow-y-auto\">\n                    {PLAYBACK_SPEEDS.map(speed => (\n                      <DropdownMenuItem \n                        key={speed}\n                        onClick={() => changePlaybackRate(speed)}\n                        className={playbackRate === speed ? \"bg-accent\" : \"\"}\n                        data-testid={`menu-speed-${speed}`}\n                      >\n                        {speed === 1 ? \"Normal (1x)\" : `${speed}x`}\n                      </DropdownMenuItem>\n                    ))}\n                  </DropdownMenuContent>\n                </DropdownMenu>\n\n                {/* Skip Amount */}\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button variant=\"outline\" size=\"sm\" className=\"gap-1\" data-testid=\"button-skip-amount\">\n                      <SkipForward className=\"h-4 w-4\" />\n                      {skipAmount}s\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent>\n                    {SKIP_AMOUNTS.map(amount => (\n                      <DropdownMenuItem \n                        key={amount}\n                        onClick={() => setSkipAmount(amount)}\n                        className={skipAmount === amount ? \"bg-accent\" : \"\"}\n                        data-testid={`menu-skip-${amount}`}\n                      >\n                        {amount} segundos\n                      </DropdownMenuItem>\n                    ))}\n                  </DropdownMenuContent>\n                </DropdownMenu>\n\n                {/* Sleep Timer */}\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button \n                      variant=\"outline\" \n                      size=\"icon\"\n                      className={sleepTimer !== null ? \"text-primary border-primary\" : \"\"}\n                      data-testid=\"button-sleep-timer\"\n                      title=\"Temporizador de sueÃ±o\"\n                    >\n                      <Moon className=\"h-4 w-4\" />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent>\n                    {sleepTimer !== null && (\n                      <>\n                        <DropdownMenuItem onClick={cancelSleepTimer} className=\"text-destructive\" data-testid=\"menu-cancel-sleep\">\n                          <X className=\"h-4 w-4 mr-2\" />\n                          Cancelar temporizador\n                        </DropdownMenuItem>\n                        <DropdownMenuSeparator />\n                      </>\n                    )}\n                    {SLEEP_TIMER_OPTIONS.map(option => (\n                      <DropdownMenuItem \n                        key={option.value}\n                        onClick={() => startSleepTimer(option.value)}\n                        data-testid={`menu-sleep-${option.value}`}\n                      >\n                        {option.label}\n                      </DropdownMenuItem>\n                    ))}\n                  </DropdownMenuContent>\n                </DropdownMenu>\n\n                {/* Jump to Time */}\n                <Dialog open={jumpDialogOpen} onOpenChange={setJumpDialogOpen}>\n                  <DialogTrigger asChild>\n                    <Button variant=\"outline\" size=\"icon\" data-testid=\"button-jump\" title=\"Ir a tiempo\">\n                      <Clock className=\"h-4 w-4\" />\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"sm:max-w-md\">\n                    <DialogHeader>\n                      <DialogTitle>Ir a Tiempo EspecÃ­fico</DialogTitle>\n                      <DialogDescription>\n                        Introduce el tiempo al que deseas saltar\n                      </DialogDescription>\n                    </DialogHeader>\n                    <div className=\"flex gap-4 py-4\">\n                      <div className=\"flex-1\">\n                        <Label htmlFor=\"jump-minutes\" className=\"text-sm mb-2 block\">Minutos</Label>\n                        <Input\n                          id=\"jump-minutes\"\n                          type=\"number\"\n                          min=\"0\"\n                          value={jumpMinutes}\n                          onChange={(e) => setJumpMinutes(e.target.value)}\n                          placeholder=\"0\"\n                          data-testid=\"input-jump-minutes\"\n                        />\n                      </div>\n                      <div className=\"flex-1\">\n                        <Label htmlFor=\"jump-seconds\" className=\"text-sm mb-2 block\">Segundos</Label>\n                        <Input\n                          id=\"jump-seconds\"\n                          type=\"number\"\n                          min=\"0\"\n                          max=\"59\"\n                          value={jumpSeconds}\n                          onChange={(e) => setJumpSeconds(e.target.value)}\n                          placeholder=\"0\"\n                          data-testid=\"input-jump-seconds\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"flex justify-end gap-2\">\n                      <Button variant=\"outline\" onClick={() => setJumpDialogOpen(false)}>Cancelar</Button>\n                      <Button onClick={handleJumpToTime}>Ir</Button>\n                    </div>\n                  </DialogContent>\n                </Dialog>\n              </div>\n\n              {/* Mobile Settings Button */}\n              <Sheet open={mobileSettingsOpen} onOpenChange={setMobileSettingsOpen}>\n                <SheetTrigger asChild>\n                  <Button variant=\"outline\" size=\"icon\" className=\"md:hidden\" data-testid=\"button-mobile-settings\">\n                    <Settings className=\"h-4 w-4\" />\n                  </Button>\n                </SheetTrigger>\n                <SheetContent side=\"bottom\" className=\"h-auto max-h-[80vh] overflow-y-auto\">\n                  <SheetHeader>\n                    <SheetTitle>Opciones de ReproducciÃ³n</SheetTitle>\n                  </SheetHeader>\n                  <div className=\"space-y-6 py-4\">\n                    {/* Playback Speed - Mobile */}\n                    <div>\n                      <Label className=\"text-sm font-medium mb-3 block\">Velocidad</Label>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {PLAYBACK_SPEEDS.map(speed => (\n                          <Button\n                            key={speed}\n                            variant={playbackRate === speed ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            onClick={() => changePlaybackRate(speed)}\n                            data-testid={`mobile-speed-${speed}`}\n                          >\n                            {speed}x\n                          </Button>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* Skip Amount - Mobile */}\n                    <div>\n                      <Label className=\"text-sm font-medium mb-3 block\">Salto de tiempo</Label>\n                      <div className=\"flex gap-2\">\n                        {SKIP_AMOUNTS.map(amount => (\n                          <Button\n                            key={amount}\n                            variant={skipAmount === amount ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            onClick={() => setSkipAmount(amount)}\n                            data-testid={`mobile-skip-${amount}`}\n                          >\n                            {amount}s\n                          </Button>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* Sleep Timer - Mobile */}\n                    <div>\n                      <Label className=\"text-sm font-medium mb-3 block\">Temporizador de sueÃ±o</Label>\n                      {sleepTimer !== null && (\n                        <Button\n                          variant=\"destructive\"\n                          size=\"sm\"\n                          onClick={cancelSleepTimer}\n                          className=\"mb-2 w-full\"\n                          data-testid=\"mobile-cancel-sleep\"\n                        >\n                          <X className=\"h-4 w-4 mr-2\" />\n                          Cancelar ({sleepTimer === -1 ? \"Final\" : formatTime(sleepTimerRemaining || 0)})\n                        </Button>\n                      )}\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {SLEEP_TIMER_OPTIONS.map(option => (\n                          <Button\n                            key={option.value}\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              startSleepTimer(option.value);\n                              setMobileSettingsOpen(false);\n                            }}\n                            data-testid={`mobile-sleep-${option.value}`}\n                          >\n                            {option.label}\n                          </Button>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* Jump to Time - Mobile */}\n                    <div>\n                      <Label className=\"text-sm font-medium mb-3 block\">Ir a tiempo especÃ­fico</Label>\n                      <div className=\"flex gap-2 items-end\">\n                        <div className=\"flex-1\">\n                          <Label htmlFor=\"mobile-jump-minutes\" className=\"text-xs mb-1 block text-muted-foreground\">Min</Label>\n                          <Input\n                            id=\"mobile-jump-minutes\"\n                            type=\"number\"\n                            min=\"0\"\n                            value={jumpMinutes}\n                            onChange={(e) => setJumpMinutes(e.target.value)}\n                            placeholder=\"0\"\n                            data-testid=\"mobile-input-minutes\"\n                          />\n                        </div>\n                        <div className=\"flex-1\">\n                          <Label htmlFor=\"mobile-jump-seconds\" className=\"text-xs mb-1 block text-muted-foreground\">Seg</Label>\n                          <Input\n                            id=\"mobile-jump-seconds\"\n                            type=\"number\"\n                            min=\"0\"\n                            max=\"59\"\n                            value={jumpSeconds}\n                            onChange={(e) => setJumpSeconds(e.target.value)}\n                            placeholder=\"0\"\n                            data-testid=\"mobile-input-seconds\"\n                          />\n                        </div>\n                        <Button \n                          onClick={() => {\n                            handleJumpToTime();\n                            setMobileSettingsOpen(false);\n                          }}\n                          data-testid=\"mobile-button-jump\"\n                        >\n                          Ir\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                </SheetContent>\n              </Sheet>\n\n              {/* Chapter List Link */}\n              <Link href={`/audiobook/${chapter.audiobook.id}`}>\n                <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-chapter-list\">\n                  <List className=\"w-5 h-5\" />\n                </Button>\n              </Link>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":27926,"size_tokens":null},"client/src/pages/admin-subscriptions.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Trash2, Crown, Plus, CreditCard, Pencil } from \"lucide-react\";\nimport type { SubscriptionPlan } from \"@shared/schema\";\n\nexport default function AdminSubscriptions() {\n  const { toast } = useToast();\n  const [selectedPlan, setSelectedPlan] = useState<SubscriptionPlan | null>(null);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [editingPlan, setEditingPlan] = useState<SubscriptionPlan | null>(null);\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    priceCents: 999,\n    currency: \"EUR\",\n    intervalMonths: 1,\n    trialDays: 0,\n  });\n\n  const { data: plans = [], isLoading } = useQuery<SubscriptionPlan[]>({\n    queryKey: [\"/api/admin/subscription-plans\"],\n  });\n\n  const deletePlanMutation = useMutation({\n    mutationFn: async (planId: string) => {\n      return await apiRequest(\"DELETE\", `/api/admin/subscription-plans/${planId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/subscription-plans\"] });\n      toast({\n        title: \"Plan eliminado\",\n        description: \"El plan de suscripcion ha sido eliminado correctamente.\",\n      });\n      setSelectedPlan(null);\n      setShowDeleteDialog(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo eliminar el plan.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createPlanMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return await apiRequest(\"POST\", \"/api/admin/subscription-plans\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/subscription-plans\"] });\n      toast({\n        title: \"Plan creado\",\n        description: \"El plan de suscripcion ha sido creado correctamente.\",\n      });\n      setShowCreateDialog(false);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo crear el plan.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updatePlanMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof formData & { isActive?: boolean } }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/subscription-plans/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/subscription-plans\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/subscription-plans\"] });\n      toast({\n        title: \"Plan actualizado\",\n        description: \"El plan de suscripcion ha sido actualizado correctamente.\",\n      });\n      setShowEditDialog(false);\n      setEditingPlan(null);\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el plan.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      description: \"\",\n      priceCents: 999,\n      currency: \"EUR\",\n      intervalMonths: 1,\n      trialDays: 0,\n    });\n  };\n\n  const handleDeleteClick = (plan: SubscriptionPlan) => {\n    setSelectedPlan(plan);\n    setShowDeleteDialog(true);\n  };\n\n  const handleEditClick = (plan: SubscriptionPlan) => {\n    setEditingPlan(plan);\n    setFormData({\n      name: plan.name,\n      description: plan.description || \"\",\n      priceCents: plan.priceCents,\n      currency: plan.currency,\n      intervalMonths: plan.intervalMonths,\n      trialDays: plan.trialDays || 0,\n    });\n    setShowEditDialog(true);\n  };\n\n  const handleEditSubmit = () => {\n    if (!editingPlan) return;\n    if (!formData.name) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa el nombre del plan.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    updatePlanMutation.mutate({ \n      id: editingPlan.id, \n      data: { ...formData, isActive: editingPlan.isActive } \n    });\n  };\n\n  const togglePlanActive = (plan: SubscriptionPlan) => {\n    updatePlanMutation.mutate({\n      id: plan.id,\n      data: {\n        name: plan.name,\n        description: plan.description || \"\",\n        priceCents: plan.priceCents,\n        currency: plan.currency,\n        intervalMonths: plan.intervalMonths,\n        isActive: !plan.isActive,\n      },\n    });\n  };\n\n  const confirmDelete = () => {\n    if (selectedPlan) {\n      deletePlanMutation.mutate(selectedPlan.id);\n    }\n  };\n\n  const handleCreateSubmit = () => {\n    if (!formData.name) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa el nombre del plan.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createPlanMutation.mutate(formData);\n  };\n\n  const formatPrice = (cents: number, currency: string = \"EUR\") => {\n    return new Intl.NumberFormat(\"es-ES\", {\n      style: \"currency\",\n      currency: currency,\n    }).format(cents / 100);\n  };\n\n  const getIntervalLabel = (months: number) => {\n    if (months === 1) return \"Mensual\";\n    if (months === 3) return \"Trimestral\";\n    if (months === 6) return \"Semestral\";\n    if (months === 12) return \"Anual\";\n    return `${months} meses`;\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <CardTitle className=\"font-serif text-2xl flex items-center gap-2\">\n                <Crown className=\"w-6 h-6\" />\n                Gestion de Suscripciones\n              </CardTitle>\n              <CardDescription>\n                Administra los planes de suscripcion disponibles\n              </CardDescription>\n            </div>\n            <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-add-plan\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              AÃ±adir Plan\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"w-8 h-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : plans.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <CreditCard className=\"w-12 h-12 mx-auto text-muted-foreground/50 mb-4\" />\n              <p className=\"text-muted-foreground\">No hay planes de suscripcion</p>\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                Crea tu primer plan para que los usuarios puedan suscribirse\n              </p>\n            </div>\n          ) : (\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Plan</TableHead>\n                    <TableHead>Precio</TableHead>\n                    <TableHead>Intervalo</TableHead>\n                    <TableHead>Prueba</TableHead>\n                    <TableHead>Estado</TableHead>\n                    <TableHead className=\"text-right\">Acciones</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {plans.map((plan) => (\n                    <TableRow key={plan.id} data-testid={`row-plan-${plan.id}`}>\n                      <TableCell>\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center\">\n                            <Crown className=\"w-5 h-5 text-accent\" />\n                          </div>\n                          <div>\n                            <span className=\"font-medium\">{plan.name}</span>\n                            {plan.description && (\n                              <p className=\"text-sm text-muted-foreground line-clamp-1\">\n                                {plan.description}\n                              </p>\n                            )}\n                          </div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-semibold\">\n                          {formatPrice(plan.priceCents, plan.currency)}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">{getIntervalLabel(plan.intervalMonths)}</Badge>\n                      </TableCell>\n                      <TableCell>\n                        {plan.trialDays > 0 ? (\n                          <Badge variant=\"secondary\">{plan.trialDays} dias</Badge>\n                        ) : (\n                          <span className=\"text-muted-foreground text-sm\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => togglePlanActive(plan)}\n                          data-testid={`button-toggle-plan-${plan.id}`}\n                        >\n                          <Badge variant={plan.isActive ? \"default\" : \"secondary\"}>\n                            {plan.isActive ? \"Activo\" : \"Inactivo\"}\n                          </Badge>\n                        </Button>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end gap-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleEditClick(plan)}\n                            data-testid={`button-edit-plan-${plan.id}`}\n                          >\n                            <Pencil className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleDeleteClick(plan)}\n                            data-testid={`button-delete-plan-${plan.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"font-serif\">AÃ±adir Plan de Suscripcion</DialogTitle>\n            <DialogDescription>\n              Crea un nuevo plan de suscripcion para los usuarios\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"name\">Nombre del plan *</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"Premium, Pro, etc.\"\n                data-testid=\"input-plan-name\"\n              />\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"description\">Descripcion</Label>\n              <Textarea\n                id=\"description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Describe los beneficios del plan...\"\n                rows={3}\n                data-testid=\"input-plan-description\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"price\">Precio (centimos)</Label>\n                <Input\n                  id=\"price\"\n                  type=\"number\"\n                  min={0}\n                  value={formData.priceCents}\n                  onChange={(e) => setFormData({ ...formData, priceCents: parseInt(e.target.value) || 0 })}\n                  placeholder=\"999\"\n                  data-testid=\"input-plan-price\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  {formatPrice(formData.priceCents, formData.currency)}\n                </p>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"currency\">Moneda</Label>\n                <Select\n                  value={formData.currency}\n                  onValueChange={(value) => setFormData({ ...formData, currency: value })}\n                >\n                  <SelectTrigger data-testid=\"select-plan-currency\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"EUR\">EUR</SelectItem>\n                    <SelectItem value=\"USD\">USD</SelectItem>\n                    <SelectItem value=\"GBP\">GBP</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"interval\">Intervalo de facturacion</Label>\n              <Select\n                value={formData.intervalMonths.toString()}\n                onValueChange={(value) => setFormData({ ...formData, intervalMonths: parseInt(value) })}\n              >\n                <SelectTrigger data-testid=\"select-plan-interval\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"1\">Mensual (cada mes)</SelectItem>\n                  <SelectItem value=\"3\">Trimestral (cada 3 meses)</SelectItem>\n                  <SelectItem value=\"6\">Semestral (cada 6 meses)</SelectItem>\n                  <SelectItem value=\"12\">Anual (cada 12 meses)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"trial\">Periodo de prueba (dias)</Label>\n              <Input\n                id=\"trial\"\n                type=\"number\"\n                min={0}\n                max={90}\n                value={formData.trialDays}\n                onChange={(e) => setFormData({ ...formData, trialDays: parseInt(e.target.value) || 0 })}\n                placeholder=\"0\"\n                data-testid=\"input-plan-trial\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                {formData.trialDays > 0 ? `${formData.trialDays} dias de prueba gratis` : \"Sin periodo de prueba\"}\n              </p>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowCreateDialog(false); resetForm(); }}>\n              Cancelar\n            </Button>\n            <Button onClick={handleCreateSubmit} disabled={createPlanMutation.isPending} data-testid=\"button-submit-plan\">\n              {createPlanMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <Plus className=\"w-4 h-4 mr-2\" />\n              )}\n              Crear Plan\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Dialog */}\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"font-serif\">Editar Plan de Suscripcion</DialogTitle>\n            <DialogDescription>\n              Modifica los datos del plan de suscripcion\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-name\">Nombre del plan *</Label>\n              <Input\n                id=\"edit-name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"Premium, Pro, etc.\"\n                data-testid=\"input-edit-plan-name\"\n              />\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-description\">Descripcion</Label>\n              <Textarea\n                id=\"edit-description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Describe los beneficios del plan...\"\n                rows={3}\n                data-testid=\"input-edit-plan-description\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-price\">Precio (centimos)</Label>\n                <Input\n                  id=\"edit-price\"\n                  type=\"number\"\n                  min={0}\n                  value={formData.priceCents}\n                  onChange={(e) => setFormData({ ...formData, priceCents: parseInt(e.target.value) || 0 })}\n                  placeholder=\"999\"\n                  data-testid=\"input-edit-plan-price\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  {formatPrice(formData.priceCents, formData.currency)}\n                </p>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-currency\">Moneda</Label>\n                <Select\n                  value={formData.currency}\n                  onValueChange={(value) => setFormData({ ...formData, currency: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-plan-currency\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"EUR\">EUR</SelectItem>\n                    <SelectItem value=\"USD\">USD</SelectItem>\n                    <SelectItem value=\"GBP\">GBP</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-interval\">Intervalo de facturacion</Label>\n              <Select\n                value={formData.intervalMonths.toString()}\n                onValueChange={(value) => setFormData({ ...formData, intervalMonths: parseInt(value) })}\n              >\n                <SelectTrigger data-testid=\"select-edit-plan-interval\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"1\">Mensual (cada mes)</SelectItem>\n                  <SelectItem value=\"3\">Trimestral (cada 3 meses)</SelectItem>\n                  <SelectItem value=\"6\">Semestral (cada 6 meses)</SelectItem>\n                  <SelectItem value=\"12\">Anual (cada 12 meses)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-trial\">Periodo de prueba (dias)</Label>\n              <Input\n                id=\"edit-trial\"\n                type=\"number\"\n                min={0}\n                max={90}\n                value={formData.trialDays}\n                onChange={(e) => setFormData({ ...formData, trialDays: parseInt(e.target.value) || 0 })}\n                placeholder=\"0\"\n                data-testid=\"input-edit-plan-trial\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                {formData.trialDays > 0 ? `${formData.trialDays} dias de prueba gratis` : \"Sin periodo de prueba\"}\n              </p>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowEditDialog(false); setEditingPlan(null); resetForm(); }}>\n              Cancelar\n            </Button>\n            <Button onClick={handleEditSubmit} disabled={updatePlanMutation.isPending} data-testid=\"button-update-plan\">\n              {updatePlanMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <Pencil className=\"w-4 h-4 mr-2\" />\n              )}\n              Guardar Cambios\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Eliminar plan</AlertDialogTitle>\n            <AlertDialogDescription>\n              Esta accion no se puede deshacer. Se eliminara permanentemente el plan\n              \"{selectedPlan?.name}\". Los usuarios con este plan mantendran su suscripcion hasta\n              que expire.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              {deletePlanMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Eliminar\"\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":23096,"size_tokens":null},"client/src/pages/admin-import.tsx":{"content":"import { useState, useCallback } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Upload, FileArchive, CheckCircle, AlertCircle, Download, BookOpen } from \"lucide-react\";\nimport { Link } from \"wouter\";\n\ninterface ImportResult {\n  success: boolean;\n  audiobook?: {\n    id: string;\n    title: string;\n  };\n  chaptersCreated?: number;\n  message?: string;\n  error?: string;\n}\n\nexport default function AdminImport() {\n  const { toast } = useToast();\n  const [dragActive, setDragActive] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [result, setResult] = useState<ImportResult | null>(null);\n\n  const importMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"zipFile\", file);\n      \n      const response = await fetch(\"/api/admin/import/zip\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n      \n      const data = await response.json();\n      \n      if (!response.ok) {\n        throw new Error(data.error || data.message || \"Error al importar\");\n      }\n      \n      return data as ImportResult;\n    },\n    onSuccess: (data) => {\n      setResult(data);\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audiobooks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audiobooks\"] });\n      toast({\n        title: \"Importacion completada\",\n        description: data.message,\n      });\n    },\n    onError: (error: Error) => {\n      setResult({ success: false, error: error.message });\n      toast({\n        title: \"Error en la importacion\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDrag = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (e.type === \"dragenter\" || e.type === \"dragover\") {\n      setDragActive(true);\n    } else if (e.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  }, []);\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setDragActive(false);\n    \n    const file = e.dataTransfer.files?.[0];\n    if (file && file.name.toLowerCase().endsWith('.zip')) {\n      setSelectedFile(file);\n      setResult(null);\n    } else {\n      toast({\n        title: \"Archivo no valido\",\n        description: \"Solo se permiten archivos ZIP\",\n        variant: \"destructive\",\n      });\n    }\n  }, [toast]);\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setSelectedFile(file);\n      setResult(null);\n    }\n  };\n\n  const handleImport = () => {\n    if (selectedFile) {\n      importMutation.mutate(selectedFile);\n    }\n  };\n\n  const resetForm = () => {\n    setSelectedFile(null);\n    setResult(null);\n  };\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes < 1024) return bytes + \" B\";\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + \" KB\";\n    return (bytes / (1024 * 1024)).toFixed(1) + \" MB\";\n  };\n\n  const metadataExample = {\n    title: \"Nombre del Audiolibro\",\n    author: \"Nombre del Autor\",\n    narrator: \"Nombre del Narrador\",\n    description: \"Descripcion del audiolibro...\",\n    category: \"Fiction\",\n    language: \"es\",\n    isFree: false,\n    priceCents: 999,\n    currency: \"EUR\",\n    chapters: [\n      {\n        title: \"Capitulo 1: Introduccion\",\n        chapterNumber: 1,\n        audioFile: \"capitulo01.mp3\",\n        duration: 1800,\n        isSample: true,\n        description: \"Descripcion del capitulo\"\n      },\n      {\n        title: \"Capitulo 2\",\n        chapterNumber: 2,\n        audioFile: \"capitulo02.mp3\",\n        duration: 2400,\n        isSample: false\n      }\n    ]\n  };\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"max-w-3xl mx-auto space-y-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"font-serif text-2xl flex items-center gap-2\">\n              <FileArchive className=\"w-6 h-6\" />\n              Importar Audiolibro desde ZIP\n            </CardTitle>\n            <CardDescription>\n              Sube un archivo ZIP con el audiolibro completo, incluyendo los archivos de audio y metadatos\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {/* Drag and drop zone */}\n            {!selectedFile && !result?.success && (\n              <div\n                className={`relative border-2 border-dashed rounded-lg p-8 text-center transition-colors ${\n                  dragActive ? \"border-primary bg-primary/5\" : \"border-muted-foreground/25\"\n                }`}\n                onDragEnter={handleDrag}\n                onDragLeave={handleDrag}\n                onDragOver={handleDrag}\n                onDrop={handleDrop}\n                data-testid=\"dropzone-zip\"\n              >\n                <input\n                  type=\"file\"\n                  accept=\".zip,application/zip\"\n                  onChange={handleFileChange}\n                  className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\n                  data-testid=\"input-zip-file\"\n                />\n                <Upload className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n                <p className=\"text-lg font-medium mb-2\">\n                  Arrastra tu archivo ZIP aqui\n                </p>\n                <p className=\"text-sm text-muted-foreground mb-4\">\n                  o haz clic para seleccionar\n                </p>\n                <p className=\"text-xs text-muted-foreground\">\n                  Maximo 1GB\n                </p>\n              </div>\n            )}\n\n            {/* Selected file */}\n            {selectedFile && !result?.success && (\n              <div className=\"border rounded-lg p-4 space-y-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center\">\n                    <FileArchive className=\"w-6 h-6 text-primary\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium truncate\">{selectedFile.name}</p>\n                    <p className=\"text-sm text-muted-foreground\">{formatFileSize(selectedFile.size)}</p>\n                  </div>\n                </div>\n                \n                <div className=\"flex gap-2\">\n                  <Button\n                    onClick={handleImport}\n                    disabled={importMutation.isPending}\n                    className=\"flex-1\"\n                    data-testid=\"button-import-zip\"\n                  >\n                    {importMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n                        Importando...\n                      </>\n                    ) : (\n                      <>\n                        <Upload className=\"w-4 h-4 mr-2\" />\n                        Importar Audiolibro\n                      </>\n                    )}\n                  </Button>\n                  <Button variant=\"outline\" onClick={resetForm} disabled={importMutation.isPending} data-testid=\"button-cancel-import\">\n                    Cancelar\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            {/* Result */}\n            {result && (\n              <div className={`border rounded-lg p-4 ${result.success ? \"border-green-500/50 bg-green-50 dark:bg-green-950/20\" : \"border-destructive/50 bg-destructive/5\"}`}>\n                <div className=\"flex items-start gap-3\">\n                  {result.success ? (\n                    <CheckCircle className=\"w-6 h-6 text-green-600 dark:text-green-400 flex-shrink-0\" />\n                  ) : (\n                    <AlertCircle className=\"w-6 h-6 text-destructive flex-shrink-0\" />\n                  )}\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium\">\n                      {result.success ? \"Importacion exitosa\" : \"Error en la importacion\"}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      {result.message || result.error}\n                    </p>\n                    {result.success && result.audiobook && (\n                      <div className=\"mt-3 flex gap-2\">\n                        <Link href={`/audiobook/${result.audiobook.id}`}>\n                          <Button size=\"sm\" variant=\"outline\">\n                            <BookOpen className=\"w-4 h-4 mr-2\" />\n                            Ver audiolibro\n                          </Button>\n                        </Link>\n                        <Button size=\"sm\" variant=\"ghost\" onClick={resetForm}>\n                          Importar otro\n                        </Button>\n                      </div>\n                    )}\n                    {!result.success && (\n                      <Button size=\"sm\" variant=\"outline\" onClick={resetForm} className=\"mt-3\" data-testid=\"button-retry-import\">\n                        Intentar de nuevo\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Instructions */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Estructura del archivo ZIP</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              El archivo ZIP debe contener:\n            </p>\n            <ul className=\"text-sm space-y-2 list-disc list-inside text-muted-foreground\">\n              <li><strong className=\"text-foreground\">metadata.json</strong> - Archivo con la informacion del audiolibro y capitulos</li>\n              <li><strong className=\"text-foreground\">cover.jpg</strong> o <strong className=\"text-foreground\">cover.png</strong> - Imagen de portada (opcional)</li>\n              <li><strong className=\"text-foreground\">Archivos de audio</strong> - MP3 o M4A referenciados en los capitulos</li>\n            </ul>\n            \n            <div className=\"mt-4\">\n              <p className=\"text-sm font-medium mb-2\">Ejemplo de metadata.json:</p>\n              <pre className=\"text-xs bg-muted p-4 rounded-lg overflow-x-auto\">\n                {JSON.stringify(metadataExample, null, 2)}\n              </pre>\n            </div>\n            \n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"mt-4\"\n              onClick={() => {\n                const blob = new Blob([JSON.stringify(metadataExample, null, 2)], { type: 'application/json' });\n                const url = URL.createObjectURL(blob);\n                const a = document.createElement('a');\n                a.href = url;\n                a.download = 'metadata-ejemplo.json';\n                a.click();\n                URL.revokeObjectURL(url);\n              }}\n              data-testid=\"button-download-example\"\n            >\n              <Download className=\"w-4 h-4 mr-2\" />\n              Descargar ejemplo de metadata.json\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11610,"size_tokens":null},"client/src/pages/admin-paypal-config.tsx":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { CreditCard, Key, Globe, CheckCircle, AlertCircle, ExternalLink, Lock } from \"lucide-react\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport type { PaypalConfig } from \"@shared/schema\";\n\nconst paypalConfigSchema = z.object({\n  clientId: z.string().min(1, \"Client ID es requerido\"),\n  webhookId: z.string().optional(),\n  environment: z.enum([\"sandbox\", \"production\"]),\n});\n\ntype PayPalConfigFormData = z.infer<typeof paypalConfigSchema>;\n\nexport default function AdminPayPalConfig() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: config, isLoading } = useQuery<PaypalConfig | null>({\n    queryKey: [\"/api/admin/paypal/config\"],\n  });\n\n  const form = useForm<PayPalConfigFormData>({\n    resolver: zodResolver(paypalConfigSchema),\n    defaultValues: {\n      clientId: \"\",\n      webhookId: \"\",\n      environment: \"sandbox\",\n    },\n    values: config ? {\n      clientId: config.clientId,\n      webhookId: config.webhookId || \"\",\n      environment: config.environment as \"sandbox\" | \"production\",\n    } : undefined,\n  });\n\n  const saveConfigMutation = useMutation({\n    mutationFn: async (data: PayPalConfigFormData) => {\n      return await apiRequest(\"POST\", \"/api/admin/paypal/config\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/paypal/config\"] });\n      toast({\n        title: \"Configuracion guardada\",\n        description: \"La configuracion de PayPal ha sido actualizada exitosamente.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"No se pudo guardar la configuracion\",\n      });\n    },\n  });\n\n  const onSubmit = (data: PayPalConfigFormData) => {\n    saveConfigMutation.mutate(data);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container max-w-4xl mx-auto px-4 md:px-6 py-8\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 w-64 bg-muted rounded\"></div>\n          <div className=\"h-96 bg-muted rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container max-w-4xl mx-auto px-4 md:px-6 py-8\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n          <CreditCard className=\"h-8 w-8\" />\n          Configuracion de PayPal\n        </h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Configura las credenciales de PayPal para procesar pagos\n        </p>\n      </div>\n\n      {!config && (\n        <Alert className=\"mb-6\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>No hay configuracion</AlertTitle>\n          <AlertDescription>\n            No se ha configurado PayPal. Completa el formulario para habilitar los pagos.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      {config && (\n        <Alert className=\"mb-6\">\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Configuracion activa ({config.environment})</AlertTitle>\n          <AlertDescription>\n            PayPal esta configurado en modo {config.environment === \"sandbox\" ? \"pruebas\" : \"produccion\"}.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Key className=\"h-5 w-5\" />\n            Credenciales de PayPal\n          </CardTitle>\n          <CardDescription>\n            Ingresa las credenciales de tu aplicacion de PayPal Developer\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"environment\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Entorno</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-environment\">\n                          <SelectValue placeholder=\"Selecciona el entorno\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"sandbox\">Sandbox (Pruebas)</SelectItem>\n                        <SelectItem value=\"production\">Produccion (Real)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormDescription>\n                      Usa Sandbox para pruebas y Produccion para pagos reales\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"clientId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Client ID</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        placeholder=\"AxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxN\"\n                        data-testid=\"input-client-id\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      El Client ID de tu aplicacion PayPal\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"webhookId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Webhook ID (Opcional)</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        placeholder=\"WH-xxxxxxxxxxxxxxxxxxxx\"\n                        data-testid=\"input-webhook-id\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      ID del webhook para recibir notificaciones de PayPal\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex justify-end gap-4 pt-4\">\n                <Button\n                  type=\"submit\"\n                  disabled={saveConfigMutation.isPending}\n                  data-testid=\"button-save-config\"\n                >\n                  {saveConfigMutation.isPending ? \"Guardando...\" : \"Guardar Configuracion\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mt-6\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Lock className=\"h-5 w-5\" />\n            Client Secret\n          </CardTitle>\n          <CardDescription>\n            El Client Secret debe configurarse como variable de entorno\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Alert>\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertTitle>Variable de entorno requerida</AlertTitle>\n            <AlertDescription className=\"space-y-2\">\n              <p>\n                Por seguridad, el Client Secret de PayPal debe configurarse como una variable de entorno \n                llamada <code className=\"bg-muted px-1 rounded\">PAYPAL_CLIENT_SECRET</code>.\n              </p>\n              <p className=\"text-sm text-muted-foreground\">\n                Ve a la seccion de Secrets en Replit y agrega tu Client Secret ahi.\n              </p>\n            </AlertDescription>\n          </Alert>\n        </CardContent>\n      </Card>\n\n      <Card className=\"mt-6\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Globe className=\"h-5 w-5\" />\n            Como obtener las credenciales\n          </CardTitle>\n          <CardDescription>\n            Sigue estos pasos para configurar PayPal\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <div className=\"grid gap-2 p-4 border rounded-lg\">\n              <h3 className=\"font-semibold\">1. Crea una cuenta de desarrollador</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Ve a developer.paypal.com e inicia sesion con tu cuenta de PayPal\n              </p>\n              <a \n                href=\"https://developer.paypal.com\" \n                target=\"_blank\" \n                rel=\"noopener noreferrer\"\n                className=\"text-sm text-primary flex items-center gap-1 hover:underline\"\n              >\n                Ir a PayPal Developer <ExternalLink className=\"h-3 w-3\" />\n              </a>\n            </div>\n            \n            <div className=\"grid gap-2 p-4 border rounded-lg\">\n              <h3 className=\"font-semibold\">2. Crea una aplicacion</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                En el Dashboard, ve a \"Apps & Credentials\" y crea una nueva app REST API\n              </p>\n            </div>\n            \n            <div className=\"grid gap-2 p-4 border rounded-lg\">\n              <h3 className=\"font-semibold\">3. Copia las credenciales</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Copia el Client ID aqui y el Secret en las variables de entorno de Replit\n              </p>\n            </div>\n\n            <div className=\"grid gap-2 p-4 border rounded-lg\">\n              <h3 className=\"font-semibold\">4. Configura Webhooks (Opcional)</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Para recibir notificaciones de pagos y suscripciones, configura un webhook \n                apuntando a tu dominio + /api/webhooks/paypal\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":10817,"size_tokens":null},"client/src/components/billing-profile-form.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2 } from \"lucide-react\";\nimport type { BillingProfile } from \"@shared/schema\";\n\nconst billingProfileFormSchema = z.object({\n  legalName: z.string().min(2, \"El nombre es requerido\"),\n  companyName: z.string().optional(),\n  taxId: z.string().optional(),\n  addressLine1: z.string().min(5, \"La direccion es requerida\"),\n  addressLine2: z.string().optional(),\n  city: z.string().min(2, \"La ciudad es requerida\"),\n  state: z.string().optional(),\n  postalCode: z.string().min(3, \"El codigo postal es requerido\"),\n  country: z.string().min(2, \"El pais es requerido\"),\n  phone: z.string().optional(),\n});\n\ntype BillingProfileFormData = z.infer<typeof billingProfileFormSchema>;\n\nexport function BillingProfileForm() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: profileData, isLoading } = useQuery<{ profile: BillingProfile | null }>({\n    queryKey: [\"/api/user/billing-profile\"],\n  });\n\n  const form = useForm<BillingProfileFormData>({\n    resolver: zodResolver(billingProfileFormSchema),\n    defaultValues: {\n      legalName: \"\",\n      companyName: \"\",\n      taxId: \"\",\n      addressLine1: \"\",\n      addressLine2: \"\",\n      city: \"\",\n      state: \"\",\n      postalCode: \"\",\n      country: \"\",\n      phone: \"\",\n    },\n    values: profileData?.profile ? {\n      legalName: profileData.profile.legalName || \"\",\n      companyName: profileData.profile.companyName || \"\",\n      taxId: profileData.profile.taxId || \"\",\n      addressLine1: profileData.profile.addressLine1 || \"\",\n      addressLine2: profileData.profile.addressLine2 || \"\",\n      city: profileData.profile.city || \"\",\n      state: profileData.profile.state || \"\",\n      postalCode: profileData.profile.postalCode || \"\",\n      country: profileData.profile.country || \"\",\n      phone: profileData.profile.phone || \"\",\n    } : undefined,\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: BillingProfileFormData) => {\n      return apiRequest(\"POST\", \"/api/user/billing-profile\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/billing-profile\"] });\n      toast({\n        title: \"Perfil guardado\",\n        description: \"Tu informacion de facturacion ha sido actualizada.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo guardar el perfil de facturacion.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: BillingProfileFormData) => {\n    saveMutation.mutate(data);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-8\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <FormField\n            control={form.control}\n            name=\"legalName\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Nombre completo *</FormLabel>\n                <FormControl>\n                  <Input data-testid=\"input-legal-name\" placeholder=\"Tu nombre legal\" {...field} />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"companyName\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Nombre de empresa</FormLabel>\n                <FormControl>\n                  <Input data-testid=\"input-company-name\" placeholder=\"Opcional\" {...field} />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        <FormField\n          control={form.control}\n          name=\"taxId\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>NIF/CIF</FormLabel>\n              <FormControl>\n                <Input data-testid=\"input-tax-id\" placeholder=\"Tu numero de identificacion fiscal\" {...field} />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        <FormField\n          control={form.control}\n          name=\"addressLine1\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Direccion *</FormLabel>\n              <FormControl>\n                <Input data-testid=\"input-address-1\" placeholder=\"Calle, numero, piso...\" {...field} />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        <FormField\n          control={form.control}\n          name=\"addressLine2\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Direccion (linea 2)</FormLabel>\n              <FormControl>\n                <Input data-testid=\"input-address-2\" placeholder=\"Apartamento, suite, etc.\" {...field} />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <FormField\n            control={form.control}\n            name=\"city\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Ciudad *</FormLabel>\n                <FormControl>\n                  <Input data-testid=\"input-city\" placeholder=\"Ciudad\" {...field} />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"state\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Provincia</FormLabel>\n                <FormControl>\n                  <Input data-testid=\"input-state\" placeholder=\"Provincia\" {...field} />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"postalCode\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Codigo postal *</FormLabel>\n                <FormControl>\n                  <Input data-testid=\"input-postal-code\" placeholder=\"12345\" {...field} />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <FormField\n            control={form.control}\n            name=\"country\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Pais *</FormLabel>\n                <FormControl>\n                  <Input data-testid=\"input-country\" placeholder=\"Espana\" {...field} />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"phone\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Telefono</FormLabel>\n                <FormControl>\n                  <Input data-testid=\"input-phone\" placeholder=\"+34 600 000 000\" {...field} />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        <Button\n          type=\"submit\"\n          disabled={saveMutation.isPending}\n          data-testid=\"button-save-billing\"\n        >\n          {saveMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n          Guardar datos de facturacion\n        </Button>\n      </form>\n    </Form>\n  );\n}\n","path":null,"size_bytes":8261,"size_tokens":null},"client/src/pages/subscriptions.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Link } from \"wouter\";\nimport { Check, Crown, Library, ChevronLeft, Loader2 } from \"lucide-react\";\nimport { PayPalSubscriptionButton } from \"@/components/paypal-button\";\nimport type { SubscriptionPlan, UserSubscription } from \"@shared/schema\";\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\ninterface PlanCardProps {\n  plan: SubscriptionPlan;\n  isCurrentPlan: boolean;\n  hasActiveSubscription: boolean;\n}\n\nfunction PlanCard({ plan, isCurrentPlan, hasActiveSubscription }: PlanCardProps) {\n  const intervalLabel = plan.intervalMonths === 1 ? \"mes\" : plan.intervalMonths === 12 ? \"ano\" : `${plan.intervalMonths} meses`;\n  \n  const defaultFeatures = [\n    \"Acceso a todo el catalogo\",\n    \"Escucha sin limites\",\n    \"Sin anuncios\",\n    ...(plan.trialDays > 0 ? [`${plan.trialDays} dias de prueba gratis`] : []),\n    \"Renovacion automatica (cancela cuando quieras)\",\n  ];\n  \n  return (\n    <Card \n      className={`relative flex flex-col ${isCurrentPlan ? 'ring-2 ring-primary' : ''}`}\n      data-testid={`card-plan-${plan.id}`}\n    >\n      {isCurrentPlan && (\n        <div className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\n          <Badge className=\"bg-primary text-primary-foreground\">\n            <Crown className=\"w-3 h-3 mr-1\" />\n            Tu plan actual\n          </Badge>\n        </div>\n      )}\n      <CardHeader className=\"text-center\">\n        <CardTitle className=\"font-serif text-2xl\">{plan.name}</CardTitle>\n        <CardDescription>{plan.description}</CardDescription>\n        <div className=\"mt-4\">\n          <span className=\"text-4xl font-bold\">{formatPrice(plan.priceCents, plan.currency)}</span>\n          <span className=\"text-muted-foreground\">/{intervalLabel}</span>\n        </div>\n      </CardHeader>\n      <CardContent className=\"flex-1\">\n        <ul className=\"space-y-3\">\n          {defaultFeatures.map((feature, index) => (\n            <li key={index} className=\"flex items-start gap-2\">\n              <Check className=\"w-5 h-5 text-primary flex-shrink-0 mt-0.5\" />\n              <span>{feature}</span>\n            </li>\n          ))}\n        </ul>\n      </CardContent>\n      <CardFooter className=\"flex flex-col gap-3\">\n        {isCurrentPlan ? (\n          <Button variant=\"outline\" className=\"w-full\" disabled>\n            Plan actual\n          </Button>\n        ) : hasActiveSubscription ? (\n          <Button variant=\"outline\" className=\"w-full\" disabled>\n            Ya tienes una suscripcion activa\n          </Button>\n        ) : plan.paypalPlanId ? (\n          <PayPalSubscriptionButton \n            planId={plan.id}\n            paypalPlanId={plan.paypalPlanId}\n          />\n        ) : (\n          <div className=\"text-sm text-muted-foreground text-center\">\n            Este plan no esta disponible actualmente\n          </div>\n        )}\n      </CardFooter>\n    </Card>\n  );\n}\n\nexport default function Subscriptions() {\n  const { data: plans, isLoading: plansLoading } = useQuery<SubscriptionPlan[]>({\n    queryKey: [\"/api/subscription-plans\"],\n  });\n\n  const { data: userSubscriptionData, isLoading: subscriptionLoading } = useQuery<{\n    subscription: UserSubscription | null;\n    plan: SubscriptionPlan | null;\n  }>({\n    queryKey: [\"/api/user/subscription\"],\n  });\n\n  const activeSubscription = userSubscriptionData?.subscription;\n  const currentPlan = userSubscriptionData?.plan;\n\n  if (plansLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"text-center mb-12\">\n          <Skeleton className=\"h-12 w-64 mx-auto mb-4\" />\n          <Skeleton className=\"h-6 w-96 mx-auto\" />\n        </div>\n        <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3 max-w-5xl mx-auto\">\n          {[1, 2, 3].map(i => (\n            <Skeleton key={i} className=\"h-96\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  const activePlans = (plans || []).filter(p => p.isActive);\n\n  return (\n    <div className=\"min-h-screen pb-16\">\n      <div className=\"bg-gradient-to-b from-primary/10 to-background\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <Link href=\"/\">\n            <Button variant=\"ghost\" size=\"sm\" className=\"mb-6\">\n              <ChevronLeft className=\"w-4 h-4 mr-1\" />\n              Volver\n            </Button>\n          </Link>\n\n          <div className=\"text-center mb-12\">\n            <Crown className=\"w-16 h-16 mx-auto text-primary mb-4\" />\n            <h1 className=\"font-serif text-4xl md:text-5xl font-bold mb-4\">\n              Suscribete a Audivia\n            </h1>\n            <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto\">\n              Accede a todo nuestro catalogo de audiolibros con una suscripcion mensual\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"container mx-auto px-4 py-8\">\n        {activeSubscription && activeSubscription.status === \"ACTIVE\" && (\n          <Card className=\"mb-8 border-primary\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"flex-shrink-0\">\n                  <div className=\"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center\">\n                    <Check className=\"w-6 h-6 text-primary\" />\n                  </div>\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"font-semibold text-lg\">Suscripcion activa</h3>\n                  <p className=\"text-muted-foreground\">\n                    {currentPlan ? (\n                      <>Estas suscrito al plan <strong>{currentPlan.name}</strong></>\n                    ) : (\n                      \"Tienes acceso a todo el catalogo de audiolibros\"\n                    )}\n                  </p>\n                </div>\n                <Link href=\"/library\">\n                  <Button className=\"gap-2\">\n                    <Library className=\"w-4 h-4\" />\n                    Ir a mi biblioteca\n                  </Button>\n                </Link>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3 max-w-5xl mx-auto\">\n          {activePlans.map(plan => (\n            <PlanCard\n              key={plan.id}\n              plan={plan}\n              isCurrentPlan={currentPlan?.id === plan.id}\n              hasActiveSubscription={activeSubscription?.status === \"ACTIVE\"}\n            />\n          ))}\n        </div>\n\n        {activePlans.length === 0 && (\n          <div className=\"text-center py-16\">\n            <Crown className=\"w-16 h-16 mx-auto text-muted-foreground/50 mb-4\" />\n            <h2 className=\"text-2xl font-bold mb-2\">No hay planes disponibles</h2>\n            <p className=\"text-muted-foreground\">\n              Los planes de suscripcion estaran disponibles pronto\n            </p>\n          </div>\n        )}\n\n        <div className=\"mt-12 max-w-2xl mx-auto text-center\">\n          <h2 className=\"font-serif text-2xl font-bold mb-4\">Beneficios de la suscripcion</h2>\n          <div className=\"grid gap-4 md:grid-cols-3 text-left\">\n            <div className=\"p-4 rounded-lg bg-card border\">\n              <Library className=\"w-8 h-8 text-primary mb-2\" />\n              <h3 className=\"font-semibold mb-1\">Catalogo completo</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Acceso a todos los audiolibros sin limites\n              </p>\n            </div>\n            <div className=\"p-4 rounded-lg bg-card border\">\n              <Check className=\"w-8 h-8 text-primary mb-2\" />\n              <h3 className=\"font-semibold mb-1\">Sin compromiso</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Cancela cuando quieras sin penalizacion\n              </p>\n            </div>\n            <div className=\"p-4 rounded-lg bg-card border\">\n              <Crown className=\"w-8 h-8 text-primary mb-2\" />\n              <h3 className=\"font-semibold mb-1\">Contenido exclusivo</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Acceso anticipado a nuevos titulos\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8612,"size_tokens":null},"server/invoice-service.ts":{"content":"import PDFDocument from \"pdfkit\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport { storage } from \"./storage\";\nimport type { Invoice, InvoiceLineItem, BillingProfile, Audiobook, SubscriptionPlan } from \"@shared/schema\";\n\nconst INVOICES_DIR = path.join(process.cwd(), \"invoices\");\n\nif (!fs.existsSync(INVOICES_DIR)) {\n  fs.mkdirSync(INVOICES_DIR, { recursive: true });\n}\n\ninterface SellerInfo {\n  name: string;\n  taxId: string;\n  address: string;\n  email: string;\n}\n\nconst SELLER_INFO: SellerInfo = {\n  name: \"Audivia S.L.\",\n  taxId: \"B12345678\",\n  address: \"Calle Principal 123, 28001 Madrid, Spain\",\n  email: \"billing@audivia.com\"\n};\n\nexport class InvoiceService {\n  async createPurchaseInvoice(\n    userId: string,\n    purchaseId: string,\n    audiobook: Audiobook,\n    pricePaidCents: number,\n    currency: string\n  ): Promise<Invoice> {\n    const billingProfile = await storage.getBillingProfile(userId);\n    const invoiceNumber = await storage.getNextInvoiceNumber();\n    \n    const taxRate = 21;\n    const subtotalCents = Math.round(pricePaidCents / (1 + taxRate / 100));\n    const taxCents = pricePaidCents - subtotalCents;\n    \n    const billingSnapshot = billingProfile ? JSON.stringify({\n      legalName: billingProfile.legalName,\n      companyName: billingProfile.companyName,\n      taxId: billingProfile.taxId,\n      address: `${billingProfile.addressLine1}${billingProfile.addressLine2 ? ', ' + billingProfile.addressLine2 : ''}, ${billingProfile.postalCode} ${billingProfile.city}, ${billingProfile.country}`\n    }) : null;\n\n    const invoice = await storage.createInvoice({\n      invoiceNumber,\n      userId,\n      purchaseId,\n      subscriptionId: null,\n      type: \"PURCHASE\",\n      status: \"PAID\",\n      issueDate: new Date(),\n      dueDate: new Date(),\n      subtotalCents,\n      taxCents,\n      taxRate,\n      totalCents: pricePaidCents,\n      currency,\n      billingSnapshot,\n      sellerInfo: JSON.stringify(SELLER_INFO),\n      paymentMethod: \"paypal\",\n      pdfPath: null,\n      pdfStatus: \"PENDING\"\n    });\n\n    await storage.createInvoiceLineItem({\n      invoiceId: invoice.id,\n      description: `Audiolibro: ${audiobook.title}`,\n      quantity: 1,\n      unitPriceCents: subtotalCents,\n      taxRate,\n      totalCents: pricePaidCents\n    });\n\n    const pdfPath = await this.generatePDF(invoice.id);\n    await storage.updateInvoicePdfPath(invoice.id, pdfPath);\n\n    return invoice;\n  }\n\n  async createSubscriptionInvoice(\n    userId: string,\n    subscriptionId: string,\n    plan: SubscriptionPlan,\n    currency: string\n  ): Promise<Invoice> {\n    const billingProfile = await storage.getBillingProfile(userId);\n    const invoiceNumber = await storage.getNextInvoiceNumber();\n    \n    const taxRate = 21;\n    const subtotalCents = Math.round(plan.priceCents / (1 + taxRate / 100));\n    const taxCents = plan.priceCents - subtotalCents;\n    \n    const billingSnapshot = billingProfile ? JSON.stringify({\n      legalName: billingProfile.legalName,\n      companyName: billingProfile.companyName,\n      taxId: billingProfile.taxId,\n      address: `${billingProfile.addressLine1}${billingProfile.addressLine2 ? ', ' + billingProfile.addressLine2 : ''}, ${billingProfile.postalCode} ${billingProfile.city}, ${billingProfile.country}`\n    }) : null;\n\n    const invoice = await storage.createInvoice({\n      invoiceNumber,\n      userId,\n      purchaseId: null,\n      subscriptionId,\n      type: \"SUBSCRIPTION\",\n      status: \"PAID\",\n      issueDate: new Date(),\n      dueDate: new Date(),\n      subtotalCents,\n      taxCents,\n      taxRate,\n      totalCents: plan.priceCents,\n      currency,\n      billingSnapshot,\n      sellerInfo: JSON.stringify(SELLER_INFO),\n      paymentMethod: \"paypal\",\n      pdfPath: null,\n      pdfStatus: \"PENDING\"\n    });\n\n    const intervalText = plan.intervalMonths === 1 ? \"mensual\" : `${plan.intervalMonths} meses`;\n    await storage.createInvoiceLineItem({\n      invoiceId: invoice.id,\n      description: `Suscripcion ${plan.name} (${intervalText})`,\n      quantity: 1,\n      unitPriceCents: subtotalCents,\n      taxRate,\n      totalCents: plan.priceCents\n    });\n\n    const pdfPath = await this.generatePDF(invoice.id);\n    await storage.updateInvoicePdfPath(invoice.id, pdfPath);\n\n    return invoice;\n  }\n\n  async generatePDF(invoiceId: string): Promise<string> {\n    const invoice = await storage.getInvoice(invoiceId);\n    if (!invoice) {\n      throw new Error(\"Invoice not found\");\n    }\n\n    const lineItems = await storage.getInvoiceLineItems(invoiceId);\n    const billingInfo = invoice.billingSnapshot ? JSON.parse(invoice.billingSnapshot) : null;\n    const sellerInfo = invoice.sellerInfo ? JSON.parse(invoice.sellerInfo) : SELLER_INFO;\n\n    const fileName = `${invoice.invoiceNumber}.pdf`;\n    const filePath = path.join(INVOICES_DIR, fileName);\n\n    return new Promise((resolve, reject) => {\n      const doc = new PDFDocument({ margin: 50 });\n      const stream = fs.createWriteStream(filePath);\n      \n      doc.pipe(stream);\n\n      doc.fontSize(24).fillColor('#7C3AED').text('AUDIVIA', 50, 50);\n      doc.fontSize(10).fillColor('#666').text('Premium Audiobooks', 50, 80);\n\n      doc.fontSize(20).fillColor('#333').text('FACTURA', 400, 50, { align: 'right' });\n      doc.fontSize(10).fillColor('#666').text(invoice.invoiceNumber, 400, 75, { align: 'right' });\n\n      doc.moveTo(50, 110).lineTo(550, 110).stroke('#ddd');\n\n      doc.fontSize(10).fillColor('#333');\n      doc.text('Vendedor:', 50, 130);\n      doc.fillColor('#666');\n      doc.text(sellerInfo.name, 50, 145);\n      doc.text(`NIF: ${sellerInfo.taxId}`, 50, 160);\n      doc.text(sellerInfo.address, 50, 175);\n      doc.text(sellerInfo.email, 50, 190);\n\n      doc.fillColor('#333').text('Cliente:', 300, 130);\n      doc.fillColor('#666');\n      if (billingInfo) {\n        doc.text(billingInfo.legalName, 300, 145);\n        if (billingInfo.companyName) {\n          doc.text(billingInfo.companyName, 300, 160);\n        }\n        if (billingInfo.taxId) {\n          doc.text(`NIF/CIF: ${billingInfo.taxId}`, 300, billingInfo.companyName ? 175 : 160);\n        }\n        doc.text(billingInfo.address, 300, billingInfo.taxId ? 190 : 175);\n      } else {\n        doc.text('Consumidor final', 300, 145);\n      }\n\n      doc.fillColor('#333').text('Fecha de emision:', 50, 230);\n      doc.fillColor('#666').text(new Date(invoice.issueDate).toLocaleDateString('es-ES'), 150, 230);\n      \n      doc.fillColor('#333').text('Metodo de pago:', 300, 230);\n      doc.fillColor('#666').text('PayPal', 400, 230);\n\n      const tableTop = 280;\n      doc.fillColor('#7C3AED').rect(50, tableTop, 500, 25).fill();\n      doc.fillColor('#fff').fontSize(10);\n      doc.text('Descripcion', 60, tableTop + 8);\n      doc.text('Cant.', 350, tableTop + 8);\n      doc.text('Precio', 400, tableTop + 8);\n      doc.text('Total', 480, tableTop + 8);\n\n      let yPos = tableTop + 35;\n      doc.fillColor('#333');\n      \n      for (const item of lineItems) {\n        doc.text(item.description, 60, yPos, { width: 280 });\n        doc.text(String(item.quantity), 350, yPos);\n        doc.text(this.formatCurrency(item.unitPriceCents, invoice.currency), 400, yPos);\n        doc.text(this.formatCurrency(item.totalCents, invoice.currency), 480, yPos);\n        yPos += 25;\n      }\n\n      doc.moveTo(50, yPos + 10).lineTo(550, yPos + 10).stroke('#ddd');\n\n      yPos += 30;\n      doc.fillColor('#666').text('Subtotal:', 380, yPos);\n      doc.text(this.formatCurrency(invoice.subtotalCents, invoice.currency), 480, yPos);\n      \n      yPos += 20;\n      doc.text(`IVA (${invoice.taxRate}%):`, 380, yPos);\n      doc.text(this.formatCurrency(invoice.taxCents, invoice.currency), 480, yPos);\n      \n      yPos += 25;\n      doc.fillColor('#7C3AED').fontSize(12).text('TOTAL:', 380, yPos);\n      doc.text(this.formatCurrency(invoice.totalCents, invoice.currency), 480, yPos);\n\n      doc.fontSize(8).fillColor('#999');\n      doc.text('Gracias por su compra. Esta factura ha sido generada automaticamente.', 50, 700, { align: 'center' });\n      doc.text('Para cualquier consulta, contacte con billing@audivia.com', 50, 715, { align: 'center' });\n\n      doc.end();\n\n      stream.on('finish', () => {\n        resolve(filePath);\n      });\n\n      stream.on('error', reject);\n    });\n  }\n\n  private formatCurrency(cents: number, currency: string): string {\n    const amount = cents / 100;\n    const symbol = currency === 'EUR' ? 'EUR' : currency === 'USD' ? '$' : currency;\n    return `${amount.toFixed(2)} ${symbol}`;\n  }\n\n  getInvoicePath(invoiceNumber: string): string {\n    return path.join(INVOICES_DIR, `${invoiceNumber}.pdf`);\n  }\n\n  invoiceExists(invoiceNumber: string): boolean {\n    return fs.existsSync(this.getInvoicePath(invoiceNumber));\n  }\n}\n\nexport const invoiceService = new InvoiceService();\n","path":null,"size_bytes":8784,"size_tokens":null},"server/paypal-service.ts":{"content":"import { db } from \"./db\";\nimport { paypalConfig, audiobookPurchases, userSubscriptions, subscriptionPlans, users, audiobooks } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { invoiceService } from \"./invoice-service\";\n\nconst PAYPAL_API_BASE = {\n  sandbox: \"https://api-m.sandbox.paypal.com\",\n  production: \"https://api-m.paypal.com\",\n};\n\ninterface PayPalAccessToken {\n  access_token: string;\n  expires_in: number;\n  expiresAt: number;\n}\n\nlet cachedToken: PayPalAccessToken | null = null;\n\nasync function getPayPalConfig() {\n  const [config] = await db.select().from(paypalConfig).where(eq(paypalConfig.isActive, true)).limit(1);\n  return config;\n}\n\nasync function getAccessToken(): Promise<string> {\n  const config = await getPayPalConfig();\n  if (!config) {\n    throw new Error(\"PayPal no estÃ¡ configurado\");\n  }\n\n  const clientSecret = process.env.PAYPAL_CLIENT_SECRET;\n  if (!clientSecret) {\n    throw new Error(\"PAYPAL_CLIENT_SECRET no estÃ¡ configurado\");\n  }\n\n  if (cachedToken && cachedToken.expiresAt > Date.now()) {\n    return cachedToken.access_token;\n  }\n\n  const baseUrl = PAYPAL_API_BASE[config.environment as keyof typeof PAYPAL_API_BASE] || PAYPAL_API_BASE.sandbox;\n  const auth = Buffer.from(`${config.clientId}:${clientSecret}`).toString(\"base64\");\n\n  const response = await fetch(`${baseUrl}/v1/oauth2/token`, {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Basic ${auth}`,\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    body: \"grant_type=client_credentials\",\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Error obteniendo token de PayPal: ${error}`);\n  }\n\n  const data = await response.json();\n  cachedToken = {\n    access_token: data.access_token,\n    expires_in: data.expires_in,\n    expiresAt: Date.now() + (data.expires_in - 60) * 1000,\n  };\n\n  return cachedToken.access_token;\n}\n\nasync function paypalRequest(endpoint: string, options: RequestInit = {}) {\n  const config = await getPayPalConfig();\n  if (!config) {\n    throw new Error(\"PayPal no estÃ¡ configurado\");\n  }\n\n  const baseUrl = PAYPAL_API_BASE[config.environment as keyof typeof PAYPAL_API_BASE] || PAYPAL_API_BASE.sandbox;\n  const accessToken = await getAccessToken();\n\n  const response = await fetch(`${baseUrl}${endpoint}`, {\n    ...options,\n    headers: {\n      \"Authorization\": `Bearer ${accessToken}`,\n      \"Content-Type\": \"application/json\",\n      ...options.headers,\n    },\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Error en peticiÃ³n PayPal: ${response.status} - ${error}`);\n  }\n\n  return response.json();\n}\n\nexport async function createOrder(audiobookId: string, userId: string, priceCents: number, currency: string) {\n  const priceValue = (priceCents / 100).toFixed(2);\n\n  const order = await paypalRequest(\"/v2/checkout/orders\", {\n    method: \"POST\",\n    body: JSON.stringify({\n      intent: \"CAPTURE\",\n      purchase_units: [\n        {\n          reference_id: audiobookId,\n          custom_id: userId,\n          amount: {\n            currency_code: currency,\n            value: priceValue,\n          },\n        },\n      ],\n      application_context: {\n        return_url: `${process.env.REPLIT_DEV_DOMAIN ? `https://${process.env.REPLIT_DEV_DOMAIN}` : \"http://localhost:5000\"}/library?purchase=success`,\n        cancel_url: `${process.env.REPLIT_DEV_DOMAIN ? `https://${process.env.REPLIT_DEV_DOMAIN}` : \"http://localhost:5000\"}/library?purchase=cancelled`,\n        brand_name: \"Audivia\",\n        user_action: \"PAY_NOW\",\n      },\n    }),\n  });\n\n  const [purchase] = await db.insert(audiobookPurchases).values({\n    userId,\n    audiobookId,\n    pricePaidCents: priceCents,\n    currency,\n    status: \"PENDING\",\n    paypalOrderId: order.id,\n  }).returning();\n\n  return {\n    orderId: order.id,\n    approvalUrl: order.links.find((l: any) => l.rel === \"approve\")?.href,\n    purchaseId: purchase.id,\n  };\n}\n\nexport async function captureOrder(orderId: string) {\n  const capture = await paypalRequest(`/v2/checkout/orders/${orderId}/capture`, {\n    method: \"POST\",\n  });\n\n  if (capture.status === \"COMPLETED\") {\n    const purchaseUnit = capture.purchase_units[0];\n    const captureId = purchaseUnit.payments.captures[0].id;\n    const payerEmail = capture.payer?.email_address;\n    const payerId = capture.payer?.payer_id;\n\n    const [purchase] = await db.update(audiobookPurchases)\n      .set({\n        status: \"COMPLETED\",\n        paypalCaptureId: captureId,\n        paypalPayerEmail: payerEmail,\n        purchasedAt: new Date(),\n      })\n      .where(eq(audiobookPurchases.paypalOrderId, orderId))\n      .returning();\n\n    if (payerId && purchase) {\n      await db.update(users)\n        .set({ paypalPayerId: payerId })\n        .where(eq(users.id, purchase.userId));\n    }\n\n    if (purchase) {\n      try {\n        const [audiobook] = await db.select().from(audiobooks).where(eq(audiobooks.id, purchase.audiobookId)).limit(1);\n        if (audiobook) {\n          await invoiceService.createPurchaseInvoice(\n            purchase.userId,\n            purchase.id,\n            audiobook,\n            purchase.pricePaidCents,\n            purchase.currency\n          );\n          console.log(`Invoice created for purchase ${purchase.id}`);\n        }\n      } catch (invoiceError) {\n        console.error(\"Error creating invoice:\", invoiceError);\n      }\n    }\n\n    return { success: true, purchase };\n  }\n\n  return { success: false, status: capture.status };\n}\n\nexport async function getOrderStatus(orderId: string) {\n  return paypalRequest(`/v2/checkout/orders/${orderId}`);\n}\n\nexport async function createSubscription(planId: string, userId: string) {\n  const [plan] = await db.select().from(subscriptionPlans).where(eq(subscriptionPlans.id, planId)).limit(1);\n  \n  if (!plan || !plan.paypalPlanId) {\n    throw new Error(\"Plan no encontrado o no tiene PayPal configurado\");\n  }\n\n  const subscription = await paypalRequest(\"/v1/billing/subscriptions\", {\n    method: \"POST\",\n    body: JSON.stringify({\n      plan_id: plan.paypalPlanId,\n      custom_id: userId,\n      application_context: {\n        return_url: `${process.env.REPLIT_DEV_DOMAIN ? `https://${process.env.REPLIT_DEV_DOMAIN}` : \"http://localhost:5000\"}/library?subscription=success`,\n        cancel_url: `${process.env.REPLIT_DEV_DOMAIN ? `https://${process.env.REPLIT_DEV_DOMAIN}` : \"http://localhost:5000\"}/subscriptions?subscription=cancelled`,\n        brand_name: \"Audivia\",\n        user_action: \"SUBSCRIBE_NOW\",\n      },\n    }),\n  });\n\n  return {\n    subscriptionId: subscription.id,\n    approvalUrl: subscription.links.find((l: any) => l.rel === \"approve\")?.href,\n  };\n}\n\nexport async function activateSubscription(paypalSubscriptionId: string, planId: string, userId: string) {\n  const subscription = await paypalRequest(`/v1/billing/subscriptions/${paypalSubscriptionId}`);\n\n  if (subscription.status === \"ACTIVE\") {\n    const startTime = new Date(subscription.start_time);\n    const billingInfo = subscription.billing_info;\n    const nextBillingTime = billingInfo?.next_billing_time ? new Date(billingInfo.next_billing_time) : new Date(startTime.getTime() + 30 * 24 * 60 * 60 * 1000);\n\n    const [userSub] = await db.insert(userSubscriptions).values({\n      userId,\n      planId,\n      status: \"ACTIVE\",\n      paypalSubscriptionId,\n      currentPeriodStart: startTime,\n      currentPeriodEnd: nextBillingTime,\n    }).returning();\n\n    const payerId = subscription.subscriber?.payer_id;\n    if (payerId) {\n      await db.update(users)\n        .set({ paypalPayerId: payerId })\n        .where(eq(users.id, userId));\n    }\n\n    try {\n      const [plan] = await db.select().from(subscriptionPlans).where(eq(subscriptionPlans.id, planId)).limit(1);\n      if (plan) {\n        await invoiceService.createSubscriptionInvoice(\n          userId,\n          userSub.id,\n          plan,\n          plan.currency\n        );\n        console.log(`Invoice created for subscription ${userSub.id}`);\n      }\n    } catch (invoiceError) {\n      console.error(\"Error creating subscription invoice:\", invoiceError);\n    }\n\n    return { success: true, subscription: userSub };\n  }\n\n  return { success: false, status: subscription.status };\n}\n\nexport async function cancelSubscription(subscriptionId: string, reason?: string) {\n  await paypalRequest(`/v1/billing/subscriptions/${subscriptionId}/cancel`, {\n    method: \"POST\",\n    body: JSON.stringify({ reason: reason || \"Usuario cancelÃ³ la suscripciÃ³n\" }),\n  });\n\n  await db.update(userSubscriptions)\n    .set({\n      status: \"CANCELED\",\n      canceledAt: new Date(),\n    })\n    .where(eq(userSubscriptions.paypalSubscriptionId, subscriptionId));\n\n  return { success: true };\n}\n\nexport async function getSubscriptionStatus(subscriptionId: string) {\n  return paypalRequest(`/v1/billing/subscriptions/${subscriptionId}`);\n}\n\nexport async function createPayPalProduct(name: string, description: string) {\n  return paypalRequest(\"/v1/catalogs/products\", {\n    method: \"POST\",\n    body: JSON.stringify({\n      name,\n      description,\n      type: \"SERVICE\",\n      category: \"DIGITAL_MEDIA_BOOKS_MOVIES_MUSIC\",\n    }),\n  });\n}\n\nexport async function createPayPalPlan(productId: string, name: string, description: string, priceCents: number, currency: string, intervalMonths: number, trialDays: number = 0) {\n  const priceValue = (priceCents / 100).toFixed(2);\n\n  const billingCycles: any[] = [];\n  let sequence = 1;\n\n  if (trialDays > 0) {\n    billingCycles.push({\n      frequency: {\n        interval_unit: \"DAY\",\n        interval_count: trialDays,\n      },\n      tenure_type: \"TRIAL\",\n      sequence: sequence++,\n      total_cycles: 1,\n      pricing_scheme: {\n        fixed_price: {\n          value: \"0.00\",\n          currency_code: currency,\n        },\n      },\n    });\n  }\n\n  billingCycles.push({\n    frequency: {\n      interval_unit: \"MONTH\",\n      interval_count: intervalMonths,\n    },\n    tenure_type: \"REGULAR\",\n    sequence: sequence,\n    total_cycles: 0,\n    pricing_scheme: {\n      fixed_price: {\n        value: priceValue,\n        currency_code: currency,\n      },\n    },\n  });\n\n  return paypalRequest(\"/v1/billing/plans\", {\n    method: \"POST\",\n    body: JSON.stringify({\n      product_id: productId,\n      name,\n      description,\n      billing_cycles: billingCycles,\n      payment_preferences: {\n        auto_bill_outstanding: true,\n        payment_failure_threshold: 3,\n      },\n    }),\n  });\n}\n\nexport async function verifyWebhookSignature(headers: Record<string, string>, body: string) {\n  const config = await getPayPalConfig();\n  if (!config || !config.webhookId) {\n    throw new Error(\"Webhook de PayPal no configurado\");\n  }\n\n  const verifyData = {\n    auth_algo: headers[\"paypal-auth-algo\"],\n    cert_url: headers[\"paypal-cert-url\"],\n    transmission_id: headers[\"paypal-transmission-id\"],\n    transmission_sig: headers[\"paypal-transmission-sig\"],\n    transmission_time: headers[\"paypal-transmission-time\"],\n    webhook_id: config.webhookId,\n    webhook_event: JSON.parse(body),\n  };\n\n  const result = await paypalRequest(\"/v1/notifications/verify-webhook-signature\", {\n    method: \"POST\",\n    body: JSON.stringify(verifyData),\n  });\n\n  return result.verification_status === \"SUCCESS\";\n}\n\nexport async function getPayPalClientId() {\n  const config = await getPayPalConfig();\n  if (!config) {\n    return null;\n  }\n  return {\n    clientId: config.clientId,\n    environment: config.environment,\n  };\n}\n\nexport async function isPayPalConfigured() {\n  const config = await getPayPalConfig();\n  return !!config && !!process.env.PAYPAL_CLIENT_SECRET;\n}\n","path":null,"size_bytes":11595,"size_tokens":null},"client/src/components/paypal-button.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2 } from \"lucide-react\";\n\ndeclare global {\n  interface Window {\n    paypal?: any;\n  }\n}\n\ninterface PayPalButtonProps {\n  audiobookId: string;\n  priceCents: number;\n  currency: string;\n  onSuccess?: () => void;\n  onError?: (error: Error) => void;\n}\n\nexport function PayPalButton({ audiobookId, priceCents, currency, onSuccess, onError }: PayPalButtonProps) {\n  const { toast } = useToast();\n  const paypalRef = useRef<HTMLDivElement>(null);\n  const mountedRef = useRef(true);\n  const buttonsInstanceRef = useRef<any>(null);\n  const renderAttemptedRef = useRef(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [sdkReady, setSdkReady] = useState(false);\n\n  const audiobookIdRef = useRef(audiobookId);\n  audiobookIdRef.current = audiobookId;\n\n  const onSuccessRef = useRef(onSuccess);\n  onSuccessRef.current = onSuccess;\n\n  const onErrorRef = useRef(onError);\n  onErrorRef.current = onError;\n\n  const { data: paypalConfig } = useQuery<{ clientId: string; environment: string }>({\n    queryKey: [\"/api/paypal/config\"],\n    retry: false,\n  });\n\n  useEffect(() => {\n    if (!paypalConfig?.clientId) return;\n\n    const existingScript = document.querySelector('script[src*=\"paypal.com/sdk/js\"]');\n    if (existingScript) {\n      if (window.paypal) {\n        setSdkReady(true);\n        setIsLoading(false);\n      }\n      return;\n    }\n\n    const script = document.createElement(\"script\");\n    script.src = `https://www.paypal.com/sdk/js?client-id=${paypalConfig.clientId}&currency=${currency}`;\n    script.async = true;\n    script.onload = () => {\n      setSdkReady(true);\n      setIsLoading(false);\n    };\n    script.onerror = () => {\n      setIsLoading(false);\n      toast({\n        title: \"Error\",\n        description: \"No se pudo cargar PayPal\",\n        variant: \"destructive\",\n      });\n    };\n    document.body.appendChild(script);\n\n    return () => {\n      if (script.parentNode) {\n        script.parentNode.removeChild(script);\n      }\n    };\n  }, [paypalConfig, currency, toast]);\n\n  useEffect(() => {\n    mountedRef.current = true;\n    return () => {\n      mountedRef.current = false;\n      if (buttonsInstanceRef.current?.close) {\n        try {\n          buttonsInstanceRef.current.close();\n        } catch (e) {\n          // Ignore cleanup errors\n        }\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!sdkReady || !window.paypal || !paypalRef.current || !mountedRef.current) return;\n    if (renderAttemptedRef.current) return;\n    renderAttemptedRef.current = true;\n\n    paypalRef.current.innerHTML = \"\";\n\n    const buttons = window.paypal.Buttons({\n      style: {\n        color: \"gold\",\n        shape: \"rect\",\n        label: \"pay\",\n        height: 40,\n      },\n      createOrder: async () => {\n        if (!mountedRef.current) throw new Error(\"Component unmounted\");\n        try {\n          const result = await apiRequest(\"POST\", \"/api/paypal/orders\", { audiobookId: audiobookIdRef.current });\n          return result.orderId;\n        } catch (error: any) {\n          toast({\n            title: \"Error\",\n            description: error.message || \"Error creando orden\",\n            variant: \"destructive\",\n          });\n          throw error;\n        }\n      },\n      onApprove: async (data: { orderID: string }) => {\n        if (!mountedRef.current) return;\n        try {\n          await apiRequest(\"POST\", `/api/paypal/orders/${data.orderID}/capture`);\n          queryClient.invalidateQueries({ queryKey: [\"/api/user/purchases\"] });\n          queryClient.invalidateQueries({ queryKey: [\"/api/audiobooks\", audiobookIdRef.current] });\n          toast({\n            title: \"Compra exitosa\",\n            description: \"El audiolibro ha sido agregado a tu biblioteca.\",\n          });\n          onSuccessRef.current?.();\n        } catch (error: any) {\n          console.error(\"Error capturing order:\", error);\n          toast({\n            title: \"Error en la compra\",\n            description: error.message,\n            variant: \"destructive\",\n          });\n          onErrorRef.current?.(error);\n        }\n      },\n      onError: (error: any) => {\n        if (!mountedRef.current) return;\n        console.error(\"PayPal error:\", error);\n        toast({\n          title: \"Error de PayPal\",\n          description: \"Hubo un problema con el pago\",\n          variant: \"destructive\",\n        });\n      },\n      onCancel: () => {\n        if (!mountedRef.current) return;\n        toast({\n          title: \"Pago cancelado\",\n          description: \"Has cancelado el proceso de pago\",\n        });\n      },\n    });\n\n    buttonsInstanceRef.current = buttons;\n\n    if (paypalRef.current && mountedRef.current) {\n      buttons.render(paypalRef.current).catch((err: any) => {\n        if (mountedRef.current) {\n          console.error(\"PayPal render error:\", err);\n        }\n      });\n    }\n  }, [sdkReady, toast]);\n\n  if (!paypalConfig) {\n    return (\n      <div className=\"text-sm text-muted-foreground p-4 text-center\">\n        PayPal no estÃ¡ configurado\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-4\">\n        <Loader2 className=\"w-6 h-6 animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div \n      ref={paypalRef} \n      data-testid=\"paypal-button-container\"\n      className=\"min-h-[50px]\"\n    />\n  );\n}\n\ninterface PayPalSubscriptionButtonProps {\n  planId: string;\n  paypalPlanId: string;\n  onSuccess?: () => void;\n  onError?: (error: Error) => void;\n}\n\nexport function PayPalSubscriptionButton({ planId, paypalPlanId, onSuccess, onError }: PayPalSubscriptionButtonProps) {\n  const { toast } = useToast();\n  const paypalRef = useRef<HTMLDivElement>(null);\n  const mountedRef = useRef(true);\n  const buttonsInstanceRef = useRef<any>(null);\n  const renderAttemptedRef = useRef(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [sdkReady, setSdkReady] = useState(false);\n\n  const planIdRef = useRef(planId);\n  planIdRef.current = planId;\n\n  const paypalPlanIdRef = useRef(paypalPlanId);\n  paypalPlanIdRef.current = paypalPlanId;\n\n  const onSuccessRef = useRef(onSuccess);\n  onSuccessRef.current = onSuccess;\n\n  const onErrorRef = useRef(onError);\n  onErrorRef.current = onError;\n\n  const { data: paypalConfig } = useQuery<{ clientId: string; environment: string }>({\n    queryKey: [\"/api/paypal/config\"],\n    retry: false,\n  });\n\n  useEffect(() => {\n    if (!paypalConfig?.clientId) return;\n\n    const existingScript = document.querySelector('script[src*=\"paypal.com/sdk/js\"]');\n    if (existingScript) {\n      if (window.paypal) {\n        setSdkReady(true);\n        setIsLoading(false);\n      }\n      return;\n    }\n\n    const script = document.createElement(\"script\");\n    script.src = `https://www.paypal.com/sdk/js?client-id=${paypalConfig.clientId}&vault=true&intent=subscription`;\n    script.async = true;\n    script.onload = () => {\n      setSdkReady(true);\n      setIsLoading(false);\n    };\n    script.onerror = () => {\n      setIsLoading(false);\n      toast({\n        title: \"Error\",\n        description: \"No se pudo cargar PayPal\",\n        variant: \"destructive\",\n      });\n    };\n    document.body.appendChild(script);\n  }, [paypalConfig, toast]);\n\n  useEffect(() => {\n    mountedRef.current = true;\n    return () => {\n      mountedRef.current = false;\n      if (buttonsInstanceRef.current?.close) {\n        try {\n          buttonsInstanceRef.current.close();\n        } catch (e) {\n          // Ignore cleanup errors\n        }\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!sdkReady || !window.paypal || !paypalRef.current || !paypalPlanIdRef.current || !mountedRef.current) return;\n    if (renderAttemptedRef.current) return;\n    renderAttemptedRef.current = true;\n\n    paypalRef.current.innerHTML = \"\";\n\n    const buttons = window.paypal.Buttons({\n      style: {\n        color: \"gold\",\n        shape: \"rect\",\n        label: \"subscribe\",\n        height: 40,\n      },\n      createSubscription: async (data: any, actions: any) => {\n        if (!mountedRef.current) throw new Error(\"Component unmounted\");\n        return actions.subscription.create({\n          plan_id: paypalPlanIdRef.current,\n        });\n      },\n      onApprove: async (data: { subscriptionID: string }) => {\n        if (!mountedRef.current) return;\n        try {\n          await apiRequest(\"POST\", `/api/paypal/subscriptions/${data.subscriptionID}/activate`, { planId: planIdRef.current });\n          queryClient.invalidateQueries({ queryKey: [\"/api/user/subscription\"] });\n          toast({\n            title: \"SuscripciÃ³n activada\",\n            description: \"Ahora tienes acceso a todo el catÃ¡logo.\",\n          });\n          onSuccessRef.current?.();\n        } catch (error: any) {\n          console.error(\"Error activating subscription:\", error);\n          toast({\n            title: \"Error\",\n            description: error.message,\n            variant: \"destructive\",\n          });\n          onErrorRef.current?.(error);\n        }\n      },\n      onError: (error: any) => {\n        if (!mountedRef.current) return;\n        console.error(\"PayPal subscription error:\", error);\n        toast({\n          title: \"Error de PayPal\",\n          description: \"Hubo un problema con la suscripciÃ³n\",\n          variant: \"destructive\",\n        });\n      },\n      onCancel: () => {\n        if (!mountedRef.current) return;\n        toast({\n          title: \"SuscripciÃ³n cancelada\",\n          description: \"Has cancelado el proceso de suscripciÃ³n\",\n        });\n      },\n    });\n\n    buttonsInstanceRef.current = buttons;\n\n    if (paypalRef.current && mountedRef.current) {\n      buttons.render(paypalRef.current).catch((err: any) => {\n        if (mountedRef.current) {\n          console.error(\"PayPal subscription render error:\", err);\n        }\n      });\n    }\n  }, [sdkReady, toast]);\n\n  if (!paypalConfig) {\n    return (\n      <div className=\"text-sm text-muted-foreground p-4 text-center\">\n        PayPal no estÃ¡ configurado\n      </div>\n    );\n  }\n\n  if (!paypalPlanId) {\n    return (\n      <div className=\"text-sm text-muted-foreground p-4 text-center\">\n        Este plan no tiene PayPal configurado\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-4\">\n        <Loader2 className=\"w-6 h-6 animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div \n      ref={paypalRef} \n      data-testid=\"paypal-subscription-button-container\"\n      className=\"min-h-[50px]\"\n    />\n  );\n}\n","path":null,"size_bytes":10663,"size_tokens":null},"client/src/pages/admin-sales-dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, LineChart, Line } from \"recharts\";\nimport { DollarSign, ShoppingCart, Users, TrendingUp, BookOpen, Calendar, CreditCard, Repeat } from \"lucide-react\";\nimport type { Audiobook } from \"@shared/schema\";\n\ntype SalesSummary = {\n  totalRevenueCents: number;\n  purchaseCount: number;\n  subscriptionCount: number;\n  purchaseRevenueCents: number;\n  subscriptionRevenueCents: number;\n  averageOrderValueCents: number;\n};\n\ntype RevenueTrendItem = {\n  date: string;\n  purchaseRevenueCents: number;\n  subscriptionRevenueCents: number;\n  totalRevenueCents: number;\n};\n\ntype TopAudiobook = {\n  audiobook: Audiobook;\n  salesCount: number;\n  revenueCents: number;\n};\n\ntype Transaction = {\n  id: string;\n  type: 'purchase' | 'subscription';\n  amount: number;\n  currency: string;\n  userName: string;\n  userEmail: string;\n  itemName: string;\n  date: string;\n  status: string;\n};\n\nconst formatCurrency = (cents: number, currency = \"EUR\") => {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency,\n  }).format(cents / 100);\n};\n\nconst formatDate = (dateStr: string) => {\n  return new Date(dateStr).toLocaleDateString(\"es-ES\", {\n    day: \"2-digit\",\n    month: \"short\",\n  });\n};\n\nconst getDateRange = (range: string) => {\n  const now = new Date();\n  const to = now.toISOString();\n  let from: Date;\n\n  switch (range) {\n    case \"7d\":\n      from = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n      break;\n    case \"30d\":\n      from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n      break;\n    case \"90d\":\n      from = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\n      break;\n    case \"1y\":\n      from = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);\n      break;\n    default:\n      from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n  }\n\n  return { from: from.toISOString(), to };\n};\n\nexport default function AdminSalesDashboard() {\n  const [dateRange, setDateRange] = useState(\"30d\");\n  const [chartInterval, setChartInterval] = useState<\"day\" | \"week\" | \"month\">(\"day\");\n\n  const { from, to } = getDateRange(dateRange);\n\n  const { data: summary, isLoading: summaryLoading } = useQuery<SalesSummary>({\n    queryKey: [\"/api/admin/sales/summary\", { from, to }],\n  });\n\n  const { data: revenueTrend, isLoading: trendLoading } = useQuery<RevenueTrendItem[]>({\n    queryKey: [\"/api/admin/sales/revenue-trend\", { from, to, interval: chartInterval }],\n  });\n\n  const { data: topAudiobooks, isLoading: topLoading } = useQuery<TopAudiobook[]>({\n    queryKey: [\"/api/admin/sales/top-audiobooks\", { from, to, limit: \"10\" }],\n  });\n\n  const { data: transactions, isLoading: transactionsLoading } = useQuery<Transaction[]>({\n    queryKey: [\"/api/admin/sales/recent-transactions\", { limit: \"20\" }],\n  });\n\n  const chartData = revenueTrend?.map(item => ({\n    date: formatDate(item.date),\n    Compras: item.purchaseRevenueCents / 100,\n    Suscripciones: item.subscriptionRevenueCents / 100,\n    Total: item.totalRevenueCents / 100,\n  })) || [];\n\n  return (\n    <div className=\"container mx-auto px-4 md:px-6 py-8\">\n      <div className=\"flex flex-col gap-6\">\n        <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n              <TrendingUp className=\"h-8 w-8\" />\n              Dashboard de Ventas\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Resumen de ingresos, compras y suscripciones\n            </p>\n          </div>\n          <div className=\"flex gap-2\">\n            <Select value={dateRange} onValueChange={setDateRange}>\n              <SelectTrigger className=\"w-[140px]\" data-testid=\"select-date-range\">\n                <Calendar className=\"h-4 w-4 mr-2\" />\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"7d\">Ultimos 7 dias</SelectItem>\n                <SelectItem value=\"30d\">Ultimos 30 dias</SelectItem>\n                <SelectItem value=\"90d\">Ultimos 90 dias</SelectItem>\n                <SelectItem value=\"1y\">Ultimo ano</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Ingresos Totales</CardTitle>\n              <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              {summaryLoading ? (\n                <div className=\"h-8 w-24 bg-muted animate-pulse rounded\" />\n              ) : (\n                <>\n                  <div className=\"text-2xl font-bold\" data-testid=\"text-total-revenue\">\n                    {formatCurrency(summary?.totalRevenueCents || 0)}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Compras + Suscripciones\n                  </p>\n                </>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Compras</CardTitle>\n              <ShoppingCart className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              {summaryLoading ? (\n                <div className=\"h-8 w-16 bg-muted animate-pulse rounded\" />\n              ) : (\n                <>\n                  <div className=\"text-2xl font-bold\" data-testid=\"text-purchase-count\">\n                    {summary?.purchaseCount || 0}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {formatCurrency(summary?.purchaseRevenueCents || 0)}\n                  </p>\n                </>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Suscripciones</CardTitle>\n              <Repeat className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              {summaryLoading ? (\n                <div className=\"h-8 w-16 bg-muted animate-pulse rounded\" />\n              ) : (\n                <>\n                  <div className=\"text-2xl font-bold\" data-testid=\"text-subscription-count\">\n                    {summary?.subscriptionCount || 0}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {formatCurrency(summary?.subscriptionRevenueCents || 0)}\n                  </p>\n                </>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Ticket Promedio</CardTitle>\n              <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              {summaryLoading ? (\n                <div className=\"h-8 w-20 bg-muted animate-pulse rounded\" />\n              ) : (\n                <>\n                  <div className=\"text-2xl font-bold\" data-testid=\"text-aov\">\n                    {formatCurrency(summary?.averageOrderValueCents || 0)}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Por transaccion\n                  </p>\n                </>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid gap-4 lg:grid-cols-7\">\n          <Card className=\"lg:col-span-4\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n                <div>\n                  <CardTitle>Tendencia de Ingresos</CardTitle>\n                  <CardDescription>Evolucion de ventas en el periodo seleccionado</CardDescription>\n                </div>\n                <Select value={chartInterval} onValueChange={(v) => setChartInterval(v as any)}>\n                  <SelectTrigger className=\"w-[120px]\" data-testid=\"select-chart-interval\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"day\">Diario</SelectItem>\n                    <SelectItem value=\"week\">Semanal</SelectItem>\n                    <SelectItem value=\"month\">Mensual</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {trendLoading ? (\n                <div className=\"h-[300px] bg-muted animate-pulse rounded\" />\n              ) : chartData.length === 0 ? (\n                <div className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\n                  No hay datos para el periodo seleccionado\n                </div>\n              ) : (\n                <ResponsiveContainer width=\"100%\" height={300}>\n                  <BarChart data={chartData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n                    <XAxis dataKey=\"date\" className=\"text-xs\" />\n                    <YAxis className=\"text-xs\" tickFormatter={(v) => `${v}â‚¬`} />\n                    <Tooltip \n                      formatter={(value: number) => [`${value.toFixed(2)}â‚¬`, \"\"]}\n                      contentStyle={{ \n                        backgroundColor: 'hsl(var(--popover))', \n                        border: '1px solid hsl(var(--border))',\n                        borderRadius: '8px'\n                      }}\n                    />\n                    <Legend />\n                    <Bar dataKey=\"Compras\" fill=\"hsl(var(--primary))\" radius={[4, 4, 0, 0]} />\n                    <Bar dataKey=\"Suscripciones\" fill=\"hsl(45, 90%, 55%)\" radius={[4, 4, 0, 0]} />\n                  </BarChart>\n                </ResponsiveContainer>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card className=\"lg:col-span-3\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <BookOpen className=\"h-5 w-5\" />\n                Top Audiolibros\n              </CardTitle>\n              <CardDescription>Los mas vendidos en el periodo</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {topLoading ? (\n                <div className=\"space-y-3\">\n                  {[1, 2, 3, 4, 5].map(i => (\n                    <div key={i} className=\"h-12 bg-muted animate-pulse rounded\" />\n                  ))}\n                </div>\n              ) : (topAudiobooks?.length || 0) === 0 ? (\n                <div className=\"h-[200px] flex items-center justify-center text-muted-foreground\">\n                  No hay ventas en el periodo\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {topAudiobooks?.slice(0, 5).map((item, idx) => (\n                    <div key={item.audiobook.id} className=\"flex items-center gap-3\" data-testid={`row-top-audiobook-${idx}`}>\n                      <div className=\"flex-shrink-0 w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-sm font-semibold\">\n                        {idx + 1}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-sm font-medium truncate\">{item.audiobook.title}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {item.salesCount} ventas\n                        </p>\n                      </div>\n                      <div className=\"text-sm font-semibold text-right\">\n                        {formatCurrency(item.revenueCents)}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <CreditCard className=\"h-5 w-5\" />\n              Transacciones Recientes\n            </CardTitle>\n            <CardDescription>Ultimas compras y suscripciones</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {transactionsLoading ? (\n              <div className=\"space-y-2\">\n                {[1, 2, 3, 4, 5].map(i => (\n                  <div key={i} className=\"h-12 bg-muted animate-pulse rounded\" />\n                ))}\n              </div>\n            ) : (transactions?.length || 0) === 0 ? (\n              <div className=\"h-[200px] flex items-center justify-center text-muted-foreground\">\n                No hay transacciones recientes\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Tipo</TableHead>\n                      <TableHead>Usuario</TableHead>\n                      <TableHead>Item</TableHead>\n                      <TableHead>Monto</TableHead>\n                      <TableHead>Fecha</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {transactions?.map((tx) => (\n                      <TableRow key={tx.id} data-testid={`row-transaction-${tx.id}`}>\n                        <TableCell>\n                          <Badge variant={tx.type === \"purchase\" ? \"default\" : \"secondary\"}>\n                            {tx.type === \"purchase\" ? \"Compra\" : \"Suscripcion\"}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          <div>\n                            <p className=\"font-medium\">{tx.userName}</p>\n                            <p className=\"text-xs text-muted-foreground\">{tx.userEmail}</p>\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"max-w-[200px] truncate\">{tx.itemName}</TableCell>\n                        <TableCell className=\"font-semibold\">\n                          {formatCurrency(tx.amount, tx.currency)}\n                        </TableCell>\n                        <TableCell className=\"text-muted-foreground\">\n                          {new Date(tx.date).toLocaleDateString(\"es-ES\", {\n                            day: \"2-digit\",\n                            month: \"short\",\n                            year: \"numeric\",\n                          })}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15655,"size_tokens":null},"client/src/pages/cart.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ShoppingCart, Trash2, BookOpen, ChevronLeft, CreditCard } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Audiobook } from \"@shared/schema\";\n\ninterface CartItemWithAudiobook {\n  id: string;\n  userId: string;\n  audiobookId: string;\n  createdAt: Date;\n  audiobook: Audiobook;\n}\n\ninterface CartData {\n  items: CartItemWithAudiobook[];\n  totalCents: number;\n  itemCount: number;\n  currency: string;\n}\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\nfunction CartItemRow({ item, onRemove }: { item: CartItemWithAudiobook; onRemove: () => void }) {\n  const { audiobook } = item;\n  \n  return (\n    <div className=\"flex items-center gap-4 p-4\" data-testid={`cart-item-${audiobook.id}`}>\n      <Link href={`/audiobook/${audiobook.id}`}>\n        <div className=\"w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 cursor-pointer hover-elevate\">\n          {audiobook.coverArtUrl ? (\n            <img\n              src={audiobook.coverArtUrl}\n              alt={audiobook.title}\n              className=\"w-full h-full object-cover\"\n            />\n          ) : (\n            <div className=\"w-full h-full bg-gradient-to-br from-primary/30 to-primary/60 flex items-center justify-center\">\n              <BookOpen className=\"w-8 h-8 text-primary-foreground/60\" />\n            </div>\n          )}\n        </div>\n      </Link>\n      <div className=\"flex-1 min-w-0\">\n        <Link href={`/audiobook/${audiobook.id}`}>\n          <h3 className=\"font-semibold truncate hover:text-primary cursor-pointer\" data-testid={`text-title-${audiobook.id}`}>\n            {audiobook.title}\n          </h3>\n        </Link>\n        <p className=\"text-sm text-muted-foreground truncate\">{audiobook.author}</p>\n      </div>\n      <div className=\"text-right flex items-center gap-4\">\n        <span className=\"font-bold text-lg\" data-testid={`text-price-${audiobook.id}`}>\n          {formatPrice(audiobook.priceCents, audiobook.currency)}\n        </span>\n        <Button \n          size=\"icon\" \n          variant=\"ghost\" \n          onClick={onRemove}\n          data-testid={`button-remove-${audiobook.id}`}\n        >\n          <Trash2 className=\"w-4 h-4 text-destructive\" />\n        </Button>\n      </div>\n    </div>\n  );\n}\n\nexport default function CartPage() {\n  const { toast } = useToast();\n\n  const { data: cart, isLoading } = useQuery<CartData>({\n    queryKey: [\"/api/cart\"],\n  });\n\n  const removeItemMutation = useMutation({\n    mutationFn: async (audiobookId: string) => {\n      await apiRequest(\"DELETE\", `/api/cart/${audiobookId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n      toast({\n        title: \"Eliminado del carrito\",\n        description: \"El audiolibro se ha eliminado del carrito\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo eliminar del carrito\",\n      });\n    },\n  });\n\n  const clearCartMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", \"/api/cart\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n      toast({\n        title: \"Carrito vaciado\",\n        description: \"Se han eliminado todos los audiolibros del carrito\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo vaciar el carrito\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Skeleton className=\"h-10 w-48 mb-6\" />\n        <div className=\"grid gap-6 lg:grid-cols-3\">\n          <div className=\"lg:col-span-2\">\n            <Card>\n              <CardContent className=\"p-6 space-y-4\">\n                <Skeleton className=\"h-24 w-full\" />\n                <Skeleton className=\"h-24 w-full\" />\n                <Skeleton className=\"h-24 w-full\" />\n              </CardContent>\n            </Card>\n          </div>\n          <div>\n            <Card>\n              <CardContent className=\"p-6 space-y-4\">\n                <Skeleton className=\"h-6 w-full\" />\n                <Skeleton className=\"h-8 w-32\" />\n                <Skeleton className=\"h-12 w-full\" />\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const isEmpty = !cart || cart.items.length === 0;\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <Link href=\"/\">\n        <Button variant=\"ghost\" size=\"sm\" className=\"mb-6\">\n          <ChevronLeft className=\"w-4 h-4 mr-1\" />\n          Seguir comprando\n        </Button>\n      </Link>\n\n      <h1 className=\"font-serif text-3xl md:text-4xl font-bold mb-8 flex items-center gap-3\">\n        <ShoppingCart className=\"w-8 h-8\" />\n        Tu carrito\n      </h1>\n\n      {isEmpty ? (\n        <Card className=\"text-center py-16\">\n          <CardContent>\n            <ShoppingCart className=\"w-16 h-16 mx-auto text-muted-foreground/50 mb-4\" />\n            <h2 className=\"text-xl font-semibold mb-2\">Tu carrito esta vacio</h2>\n            <p className=\"text-muted-foreground mb-6\">\n              Explora nuestra coleccion y agrega audiolibros a tu carrito\n            </p>\n            <Link href=\"/\">\n              <Button data-testid=\"button-explore\">\n                Explorar audiolibros\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-6 lg:grid-cols-3\">\n          <div className=\"lg:col-span-2\">\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n                <CardTitle className=\"font-serif\">\n                  Audiolibros ({cart.itemCount})\n                </CardTitle>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  onClick={() => clearCartMutation.mutate()}\n                  disabled={clearCartMutation.isPending}\n                  data-testid=\"button-clear-cart\"\n                >\n                  <Trash2 className=\"w-4 h-4 mr-2\" />\n                  Vaciar carrito\n                </Button>\n              </CardHeader>\n              <CardContent className=\"p-0\">\n                <div className=\"divide-y\">\n                  {cart.items.map((item) => (\n                    <CartItemRow\n                      key={item.id}\n                      item={item}\n                      onRemove={() => removeItemMutation.mutate(item.audiobookId)}\n                    />\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <div className=\"lg:col-span-1\">\n            <Card className=\"sticky top-8\">\n              <CardHeader>\n                <CardTitle className=\"font-serif\">Resumen del pedido</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  {cart.items.map((item) => (\n                    <div key={item.id} className=\"flex justify-between text-sm\">\n                      <span className=\"truncate flex-1 mr-2\">{item.audiobook.title}</span>\n                      <span>{formatPrice(item.audiobook.priceCents, item.audiobook.currency)}</span>\n                    </div>\n                  ))}\n                </div>\n                \n                <Separator />\n                \n                <div className=\"flex justify-between font-bold text-lg\">\n                  <span>Total</span>\n                  <span data-testid=\"text-cart-total\">{formatPrice(cart.totalCents, cart.currency)}</span>\n                </div>\n\n                <Link href=\"/checkout\">\n                  <Button className=\"w-full gap-2\" size=\"lg\" data-testid=\"button-checkout\">\n                    <CreditCard className=\"w-5 h-5\" />\n                    Proceder al pago\n                  </Button>\n                </Link>\n\n                <p className=\"text-xs text-center text-muted-foreground\">\n                  Pago seguro con PayPal\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":8712,"size_tokens":null},"client/src/pages/admin-discount-codes.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Pencil, Trash2, Tag, Loader2, Percent, Euro } from \"lucide-react\";\nimport type { DiscountCode } from \"@shared/schema\";\n\nexport default function AdminDiscountCodes() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [editingCode, setEditingCode] = useState<DiscountCode | null>(null);\n  const [formData, setFormData] = useState({\n    code: \"\",\n    description: \"\",\n    type: \"PERCENTAGE\" as \"PERCENTAGE\" | \"FIXED_AMOUNT\",\n    value: 0,\n    minPurchaseCents: 0,\n    maxUsesTotal: \"\",\n    maxUsesPerUser: 1,\n    validFrom: \"\",\n    validUntil: \"\",\n    isActive: true,\n    appliesToSubscriptions: false,\n    appliesToPurchases: true,\n  });\n\n  const { data: discountCodes = [], isLoading } = useQuery<DiscountCode[]>({\n    queryKey: [\"/api/admin/discount-codes\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"POST\", \"/api/admin/discount-codes\", {\n        ...data,\n        value: data.type === \"FIXED_AMOUNT\" ? data.value * 100 : data.value,\n        minPurchaseCents: data.minPurchaseCents * 100,\n        maxUsesTotal: data.maxUsesTotal ? parseInt(data.maxUsesTotal) : null,\n        validFrom: data.validFrom || null,\n        validUntil: data.validUntil || null,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/discount-codes\"] });\n      setIsCreateOpen(false);\n      resetForm();\n      toast({ title: \"Codigo creado\", description: \"El codigo de descuento ha sido creado correctamente\" });\n    },\n    onError: (error: any) => {\n      toast({ variant: \"destructive\", title: \"Error\", description: error.message || \"Error creando codigo\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof formData }) => {\n      return apiRequest(\"PATCH\", `/api/admin/discount-codes/${id}`, {\n        ...data,\n        value: data.type === \"FIXED_AMOUNT\" ? data.value * 100 : data.value,\n        minPurchaseCents: data.minPurchaseCents * 100,\n        maxUsesTotal: data.maxUsesTotal ? parseInt(data.maxUsesTotal) : null,\n        validFrom: data.validFrom || null,\n        validUntil: data.validUntil || null,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/discount-codes\"] });\n      setEditingCode(null);\n      resetForm();\n      toast({ title: \"Codigo actualizado\", description: \"El codigo de descuento ha sido actualizado correctamente\" });\n    },\n    onError: (error: any) => {\n      toast({ variant: \"destructive\", title: \"Error\", description: error.message || \"Error actualizando codigo\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/admin/discount-codes/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/discount-codes\"] });\n      toast({ title: \"Codigo eliminado\", description: \"El codigo de descuento ha sido eliminado\" });\n    },\n    onError: (error: any) => {\n      toast({ variant: \"destructive\", title: \"Error\", description: error.message || \"Error eliminando codigo\" });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      code: \"\",\n      description: \"\",\n      type: \"PERCENTAGE\",\n      value: 0,\n      minPurchaseCents: 0,\n      maxUsesTotal: \"\",\n      maxUsesPerUser: 1,\n      validFrom: \"\",\n      validUntil: \"\",\n      isActive: true,\n      appliesToSubscriptions: false,\n      appliesToPurchases: true,\n    });\n  };\n\n  const openEditDialog = (code: DiscountCode) => {\n    setEditingCode(code);\n    setFormData({\n      code: code.code,\n      description: code.description || \"\",\n      type: code.type,\n      value: code.type === \"FIXED_AMOUNT\" ? code.value / 100 : code.value,\n      minPurchaseCents: (code.minPurchaseCents || 0) / 100,\n      maxUsesTotal: code.maxUsesTotal?.toString() || \"\",\n      maxUsesPerUser: code.maxUsesPerUser || 1,\n      validFrom: code.validFrom ? new Date(code.validFrom).toISOString().split(\"T\")[0] : \"\",\n      validUntil: code.validUntil ? new Date(code.validUntil).toISOString().split(\"T\")[0] : \"\",\n      isActive: code.isActive,\n      appliesToSubscriptions: code.appliesToSubscriptions,\n      appliesToPurchases: code.appliesToPurchases,\n    });\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingCode) {\n      updateMutation.mutate({ id: editingCode.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const formatValue = (code: DiscountCode) => {\n    if (code.type === \"PERCENTAGE\") {\n      return `${code.value}%`;\n    }\n    return `${(code.value / 100).toFixed(2)} EUR`;\n  };\n\n  const isCodeValid = (code: DiscountCode) => {\n    if (!code.isActive) return false;\n    const now = new Date();\n    if (code.validFrom && now < new Date(code.validFrom)) return false;\n    if (code.validUntil && now > new Date(code.validUntil)) return false;\n    if (code.maxUsesTotal && code.usedCount >= code.maxUsesTotal) return false;\n    return true;\n  };\n\n  const FormContent = () => (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"code\">Codigo</Label>\n          <Input\n            id=\"code\"\n            value={formData.code}\n            onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}\n            placeholder=\"DESCUENTO20\"\n            required\n            data-testid=\"input-discount-code\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"type\">Tipo</Label>\n          <Select value={formData.type} onValueChange={(v) => setFormData({ ...formData, type: v as typeof formData.type })}>\n            <SelectTrigger data-testid=\"select-discount-type\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"PERCENTAGE\">Porcentaje</SelectItem>\n              <SelectItem value=\"FIXED_AMOUNT\">Monto Fijo</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"description\">Descripcion</Label>\n        <Input\n          id=\"description\"\n          value={formData.description}\n          onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n          placeholder=\"Descripcion del descuento\"\n          data-testid=\"input-discount-description\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"value\">\n            Valor {formData.type === \"PERCENTAGE\" ? \"(%)\" : \"(EUR)\"}\n          </Label>\n          <Input\n            id=\"value\"\n            type=\"number\"\n            min=\"0\"\n            max={formData.type === \"PERCENTAGE\" ? 100 : undefined}\n            step={formData.type === \"PERCENTAGE\" ? 1 : 0.01}\n            value={formData.value}\n            onChange={(e) => setFormData({ ...formData, value: parseFloat(e.target.value) || 0 })}\n            required\n            data-testid=\"input-discount-value\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"minPurchase\">Compra Minima (EUR)</Label>\n          <Input\n            id=\"minPurchase\"\n            type=\"number\"\n            min=\"0\"\n            step=\"0.01\"\n            value={formData.minPurchaseCents}\n            onChange={(e) => setFormData({ ...formData, minPurchaseCents: parseFloat(e.target.value) || 0 })}\n            data-testid=\"input-discount-min-purchase\"\n          />\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"maxUsesTotal\">Usos Totales (vacio = ilimitado)</Label>\n          <Input\n            id=\"maxUsesTotal\"\n            type=\"number\"\n            min=\"1\"\n            value={formData.maxUsesTotal}\n            onChange={(e) => setFormData({ ...formData, maxUsesTotal: e.target.value })}\n            placeholder=\"Ilimitado\"\n            data-testid=\"input-discount-max-uses\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"maxUsesPerUser\">Usos por Usuario</Label>\n          <Input\n            id=\"maxUsesPerUser\"\n            type=\"number\"\n            min=\"1\"\n            value={formData.maxUsesPerUser}\n            onChange={(e) => setFormData({ ...formData, maxUsesPerUser: parseInt(e.target.value) || 1 })}\n            data-testid=\"input-discount-max-per-user\"\n          />\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"validFrom\">Valido Desde</Label>\n          <Input\n            id=\"validFrom\"\n            type=\"date\"\n            value={formData.validFrom}\n            onChange={(e) => setFormData({ ...formData, validFrom: e.target.value })}\n            data-testid=\"input-discount-valid-from\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"validUntil\">Valido Hasta</Label>\n          <Input\n            id=\"validUntil\"\n            type=\"date\"\n            value={formData.validUntil}\n            onChange={(e) => setFormData({ ...formData, validUntil: e.target.value })}\n            data-testid=\"input-discount-valid-until\"\n          />\n        </div>\n      </div>\n\n      <div className=\"space-y-4 pt-4 border-t\">\n        <div className=\"flex items-center justify-between\">\n          <Label htmlFor=\"isActive\">Activo</Label>\n          <Switch\n            id=\"isActive\"\n            checked={formData.isActive}\n            onCheckedChange={(checked) => setFormData({ ...formData, isActive: checked })}\n            data-testid=\"switch-discount-active\"\n          />\n        </div>\n        <div className=\"flex items-center justify-between\">\n          <Label htmlFor=\"appliesToPurchases\">Aplica a Compras</Label>\n          <Switch\n            id=\"appliesToPurchases\"\n            checked={formData.appliesToPurchases}\n            onCheckedChange={(checked) => setFormData({ ...formData, appliesToPurchases: checked })}\n            data-testid=\"switch-discount-purchases\"\n          />\n        </div>\n        <div className=\"flex items-center justify-between\">\n          <Label htmlFor=\"appliesToSubscriptions\">Aplica a Suscripciones</Label>\n          <Switch\n            id=\"appliesToSubscriptions\"\n            checked={formData.appliesToSubscriptions}\n            onCheckedChange={(checked) => setFormData({ ...formData, appliesToSubscriptions: checked })}\n            data-testid=\"switch-discount-subscriptions\"\n          />\n        </div>\n      </div>\n\n      <DialogFooter>\n        <Button type=\"submit\" disabled={createMutation.isPending || updateMutation.isPending} data-testid=\"button-save-discount\">\n          {(createMutation.isPending || updateMutation.isPending) && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n          {editingCode ? \"Guardar Cambios\" : \"Crear Codigo\"}\n        </Button>\n      </DialogFooter>\n    </form>\n  );\n\n  return (\n    <div className=\"container mx-auto px-6 py-8\">\n      <div className=\"flex items-center justify-between mb-8\">\n        <div>\n          <h1 className=\"font-serif text-4xl font-bold\" data-testid=\"text-page-title\">\n            Codigos de Descuento\n          </h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Gestiona los codigos de descuento para compras y suscripciones\n          </p>\n        </div>\n        <Dialog open={isCreateOpen} onOpenChange={(open) => { setIsCreateOpen(open); if (!open) resetForm(); }}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-discount\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nuevo Codigo\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-lg\">\n            <DialogHeader>\n              <DialogTitle>Crear Codigo de Descuento</DialogTitle>\n              <DialogDescription>\n                Crea un nuevo codigo de descuento para tus clientes\n              </DialogDescription>\n            </DialogHeader>\n            <FormContent />\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Tag className=\"w-5 h-5\" />\n            Codigos Disponibles\n          </CardTitle>\n          <CardDescription>\n            Lista de todos los codigos de descuento\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"w-6 h-6 animate-spin\" />\n            </div>\n          ) : discountCodes.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Tag className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>No hay codigos de descuento</p>\n              <p className=\"text-sm\">Crea tu primer codigo con el boton de arriba</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Codigo</TableHead>\n                    <TableHead>Tipo</TableHead>\n                    <TableHead>Valor</TableHead>\n                    <TableHead>Usos</TableHead>\n                    <TableHead>Validez</TableHead>\n                    <TableHead>Estado</TableHead>\n                    <TableHead className=\"text-right\">Acciones</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {discountCodes.map((code) => (\n                    <TableRow key={code.id} data-testid={`row-discount-${code.id}`}>\n                      <TableCell className=\"font-mono font-bold\">{code.code}</TableCell>\n                      <TableCell>\n                        {code.type === \"PERCENTAGE\" ? (\n                          <Badge variant=\"outline\"><Percent className=\"w-3 h-3 mr-1\" />Porcentaje</Badge>\n                        ) : (\n                          <Badge variant=\"outline\"><Euro className=\"w-3 h-3 mr-1\" />Monto Fijo</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"font-semibold\">{formatValue(code)}</TableCell>\n                      <TableCell>\n                        {code.usedCount}{code.maxUsesTotal ? `/${code.maxUsesTotal}` : \"\"}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {code.validFrom || code.validUntil ? (\n                          <>\n                            {code.validFrom && <div>Desde: {new Date(code.validFrom).toLocaleDateString(\"es-ES\")}</div>}\n                            {code.validUntil && <div>Hasta: {new Date(code.validUntil).toLocaleDateString(\"es-ES\")}</div>}\n                          </>\n                        ) : (\n                          <span className=\"text-muted-foreground\">Sin limite</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {isCodeValid(code) ? (\n                          <Badge variant=\"default\">Activo</Badge>\n                        ) : (\n                          <Badge variant=\"secondary\">Inactivo</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex items-center justify-end gap-2\">\n                          <Dialog open={editingCode?.id === code.id} onOpenChange={(open) => { if (!open) { setEditingCode(null); resetForm(); } }}>\n                            <DialogTrigger asChild>\n                              <Button size=\"icon\" variant=\"ghost\" onClick={() => openEditDialog(code)} data-testid={`button-edit-discount-${code.id}`}>\n                                <Pencil className=\"w-4 h-4\" />\n                              </Button>\n                            </DialogTrigger>\n                            <DialogContent className=\"max-w-lg\">\n                              <DialogHeader>\n                                <DialogTitle>Editar Codigo de Descuento</DialogTitle>\n                                <DialogDescription>\n                                  Modifica los detalles del codigo {code.code}\n                                </DialogDescription>\n                              </DialogHeader>\n                              <FormContent />\n                            </DialogContent>\n                          </Dialog>\n                          <Button\n                            size=\"icon\"\n                            variant=\"ghost\"\n                            onClick={() => {\n                              if (confirm(`Â¿Eliminar el codigo ${code.code}?`)) {\n                                deleteMutation.mutate(code.id);\n                              }\n                            }}\n                            data-testid={`button-delete-discount-${code.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":18464,"size_tokens":null},"server/id3-utils.ts":{"content":"import NodeID3 from 'node-id3';\nimport * as fs from 'fs/promises';\nimport * as path from 'path';\n\nexport interface AudiobookMetadata {\n  title: string;\n  author: string;\n  album: string;\n  trackNumber: number;\n  totalTracks?: number;\n  year?: number;\n  genre?: string;\n  narrator?: string;\n  coverArtPath?: string;\n}\n\nexport async function updateMP3Metadata(\n  filePath: string,\n  metadata: AudiobookMetadata\n): Promise<void> {\n  const tags: NodeID3.Tags = {\n    title: metadata.title,\n    artist: metadata.author,\n    album: metadata.album,\n    trackNumber: String(metadata.trackNumber),\n    year: metadata.year ? String(metadata.year) : String(new Date().getFullYear()),\n    genre: metadata.genre || 'Audiobook',\n    composer: metadata.narrator || undefined,\n  };\n\n  if (metadata.coverArtPath) {\n    try {\n      const coverBuffer = await fs.readFile(metadata.coverArtPath);\n      const ext = path.extname(metadata.coverArtPath).toLowerCase();\n      const mimeType = ext === '.png' ? 'image/png' : 'image/jpeg';\n      \n      tags.image = {\n        mime: mimeType,\n        type: {\n          id: 3,\n          name: 'front cover',\n        },\n        description: 'Cover',\n        imageBuffer: coverBuffer,\n      };\n    } catch (error) {\n      console.warn('Could not read cover art for ID3 tags:', error);\n    }\n  }\n\n  const success = NodeID3.update(tags, filePath);\n  \n  if (!success) {\n    console.warn(`Failed to update ID3 tags for ${filePath}`);\n  }\n}\n\nexport async function updateMP3MetadataBuffer(\n  buffer: Buffer,\n  metadata: AudiobookMetadata,\n  coverBuffer?: Buffer\n): Promise<Buffer> {\n  const tags: NodeID3.Tags = {\n    title: metadata.title,\n    artist: metadata.author,\n    album: metadata.album,\n    trackNumber: String(metadata.trackNumber),\n    year: metadata.year ? String(metadata.year) : String(new Date().getFullYear()),\n    genre: metadata.genre || 'Audiobook',\n    composer: metadata.narrator || undefined,\n  };\n\n  if (coverBuffer) {\n    tags.image = {\n      mime: 'image/jpeg',\n      type: {\n        id: 3,\n        name: 'front cover',\n      },\n      description: 'Cover',\n      imageBuffer: coverBuffer,\n    };\n  }\n\n  const updatedBuffer = NodeID3.update(tags, buffer);\n  \n  if (!updatedBuffer) {\n    console.warn('Failed to update ID3 tags in buffer, returning original');\n    return buffer;\n  }\n  \n  return updatedBuffer as Buffer;\n}\n\nexport async function readMP3Metadata(filePath: string): Promise<NodeID3.Tags | null> {\n  try {\n    const tags = NodeID3.read(filePath);\n    return tags;\n  } catch (error) {\n    console.error('Error reading ID3 tags:', error);\n    return null;\n  }\n}\n","path":null,"size_bytes":2611,"size_tokens":null},"client/src/pages/admin-customers.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  Users, Search, Mail, User, CreditCard, FileText, Download, \n  Calendar, ShoppingBag, MapPin, Phone, Building, ChevronLeft,\n  DollarSign, Receipt, Filter, X, Trash2, RefreshCw, AlertCircle, FileSpreadsheet\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { User as UserType, BillingProfile, AudiobookPurchase, Audiobook, Invoice, UserSubscription } from \"@shared/schema\";\n\ninterface CustomerWithStats {\n  user: UserType;\n  billingProfile: BillingProfile | null;\n  totalPurchases: number;\n  totalSpentCents: number;\n  lastPurchaseAt: string | null;\n}\n\ninterface CustomerDetail {\n  user: UserType;\n  billingProfile: BillingProfile | null;\n  purchases: Array<AudiobookPurchase & { audiobook: Audiobook }>;\n  invoices: Invoice[];\n  subscription: UserSubscription | null;\n  stats: { totalPurchases: number; totalSpentCents: number; lastPurchaseAt: string | null };\n}\n\ninterface InvoiceWithUser extends Invoice {\n  user: UserType;\n}\n\ninterface PurchaseWithDetails extends AudiobookPurchase {\n  user: UserType;\n  audiobook: Audiobook;\n}\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\nfunction formatDate(date: string | Date | null): string {\n  if (!date) return \"-\";\n  return new Date(date).toLocaleDateString(\"es-ES\", {\n    year: \"numeric\",\n    month: \"short\",\n    day: \"numeric\",\n  });\n}\n\nfunction CustomerRow({ customer, onClick }: { customer: CustomerWithStats; onClick: () => void }) {\n  return (\n    <div \n      className=\"flex items-center gap-4 p-4 border-b hover-elevate cursor-pointer\"\n      onClick={onClick}\n      data-testid={`customer-row-${customer.user.id}`}\n    >\n      <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n        <User className=\"w-5 h-5 text-primary\" />\n      </div>\n      <div className=\"flex-1 min-w-0\">\n        <p className=\"font-medium truncate\">{customer.user.username}</p>\n        <p className=\"text-sm text-muted-foreground truncate\">{customer.user.email}</p>\n      </div>\n      <div className=\"hidden md:flex items-center gap-6\">\n        <div className=\"text-right\">\n          <p className=\"text-sm font-medium\">{customer.totalPurchases}</p>\n          <p className=\"text-xs text-muted-foreground\">Compras</p>\n        </div>\n        <div className=\"text-right\">\n          <p className=\"text-sm font-medium\">{formatPrice(customer.totalSpentCents)}</p>\n          <p className=\"text-xs text-muted-foreground\">Total</p>\n        </div>\n        <div className=\"text-right\">\n          <p className=\"text-sm font-medium\">{formatDate(customer.lastPurchaseAt)}</p>\n          <p className=\"text-xs text-muted-foreground\">Ultima compra</p>\n        </div>\n      </div>\n      <Badge variant={customer.billingProfile ? \"default\" : \"outline\"}>\n        {customer.billingProfile ? \"Perfil completo\" : \"Sin perfil\"}\n      </Badge>\n      <Badge variant=\"secondary\">{customer.user.role}</Badge>\n    </div>\n  );\n}\n\nfunction CustomerDetailView({ customerId, onClose }: { customerId: string; onClose: () => void }) {\n  const { data: customer, isLoading } = useQuery<CustomerDetail>({\n    queryKey: [\"/api/admin/customers\", customerId],\n  });\n\n  const handleDownloadInvoice = (invoiceId: string) => {\n    window.open(`/api/admin/invoices/${invoiceId}/download`, \"_blank\");\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <Skeleton className=\"h-32 w-full\" />\n        <Skeleton className=\"h-48 w-full\" />\n      </div>\n    );\n  }\n\n  if (!customer) {\n    return (\n      <div className=\"text-center py-8\">\n        <p className=\"text-muted-foreground\">Cliente no encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-4\">\n        <Button variant=\"ghost\" size=\"icon\" onClick={onClose}>\n          <ChevronLeft className=\"w-5 h-5\" />\n        </Button>\n        <div>\n          <h2 className=\"text-2xl font-serif font-bold\">{customer.user.username}</h2>\n          <p className=\"text-muted-foreground\">{customer.user.email}</p>\n        </div>\n        <div className=\"ml-auto flex items-center gap-2\">\n          <Badge variant=\"secondary\">{customer.user.role}</Badge>\n          {customer.subscription?.status === \"ACTIVE\" && (\n            <Badge variant=\"default\">Suscriptor</Badge>\n          )}\n        </div>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <ShoppingBag className=\"w-8 h-8 text-primary\" />\n              <div>\n                <p className=\"text-2xl font-bold\">{customer.stats.totalPurchases}</p>\n                <p className=\"text-sm text-muted-foreground\">Compras</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <DollarSign className=\"w-8 h-8 text-green-500\" />\n              <div>\n                <p className=\"text-2xl font-bold\">{formatPrice(customer.stats.totalSpentCents)}</p>\n                <p className=\"text-sm text-muted-foreground\">Total gastado</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <Receipt className=\"w-8 h-8 text-blue-500\" />\n              <div>\n                <p className=\"text-2xl font-bold\">{customer.invoices.length}</p>\n                <p className=\"text-sm text-muted-foreground\">Facturas</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <Calendar className=\"w-8 h-8 text-orange-500\" />\n              <div>\n                <p className=\"text-2xl font-bold\">{formatDate(customer.stats.lastPurchaseAt)}</p>\n                <p className=\"text-sm text-muted-foreground\">Ultima compra</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {customer.billingProfile && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Building className=\"w-5 h-5\" />\n              Datos de facturacion\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <User className=\"w-4 h-4 text-muted-foreground\" />\n                  <span className=\"font-medium\">Nombre:</span>\n                  <span>{customer.billingProfile.legalName}</span>\n                </div>\n                {customer.billingProfile.companyName && (\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Building className=\"w-4 h-4 text-muted-foreground\" />\n                    <span className=\"font-medium\">Empresa:</span>\n                    <span>{customer.billingProfile.companyName}</span>\n                  </div>\n                )}\n                {customer.billingProfile.taxId && (\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <FileText className=\"w-4 h-4 text-muted-foreground\" />\n                    <span className=\"font-medium\">NIF/CIF:</span>\n                    <span>{customer.billingProfile.taxId}</span>\n                  </div>\n                )}\n                {customer.billingProfile.phone && (\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Phone className=\"w-4 h-4 text-muted-foreground\" />\n                    <span className=\"font-medium\">Telefono:</span>\n                    <span>{customer.billingProfile.phone}</span>\n                  </div>\n                )}\n              </div>\n              <div className=\"space-y-2\">\n                <div className=\"flex items-start gap-2 text-sm\">\n                  <MapPin className=\"w-4 h-4 text-muted-foreground mt-0.5\" />\n                  <div>\n                    <span className=\"font-medium\">Direccion:</span>\n                    <p>{customer.billingProfile.addressLine1}</p>\n                    {customer.billingProfile.addressLine2 && <p>{customer.billingProfile.addressLine2}</p>}\n                    <p>{customer.billingProfile.postalCode} {customer.billingProfile.city}</p>\n                    {customer.billingProfile.state && <p>{customer.billingProfile.state}</p>}\n                    <p>{customer.billingProfile.country}</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <Tabs defaultValue=\"purchases\">\n        <TabsList>\n          <TabsTrigger value=\"purchases\" data-testid=\"tab-purchases\">\n            Compras ({customer.purchases.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"invoices\" data-testid=\"tab-invoices\">\n            Facturas ({customer.invoices.length})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"purchases\" className=\"mt-4\">\n          <Card>\n            <CardContent className=\"p-0\">\n              {customer.purchases.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No hay compras registradas\n                </div>\n              ) : (\n                <div className=\"divide-y\">\n                  {customer.purchases.map((purchase) => (\n                    <div key={purchase.id} className=\"flex items-center gap-4 p-4\">\n                      <div className=\"w-12 h-12 rounded-lg overflow-hidden flex-shrink-0\">\n                        {purchase.audiobook.coverArtUrl ? (\n                          <img\n                            src={purchase.audiobook.coverArtUrl}\n                            alt={purchase.audiobook.title}\n                            className=\"w-full h-full object-cover\"\n                          />\n                        ) : (\n                          <div className=\"w-full h-full bg-primary/20 flex items-center justify-center\">\n                            <CreditCard className=\"w-5 h-5 text-primary\" />\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-medium truncate\">{purchase.audiobook.title}</p>\n                        <p className=\"text-sm text-muted-foreground\">{purchase.audiobook.author}</p>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"font-medium\">{formatPrice(purchase.pricePaidCents, purchase.currency)}</p>\n                        <p className=\"text-sm text-muted-foreground\">{formatDate(purchase.purchasedAt)}</p>\n                      </div>\n                      <Badge variant={purchase.status === \"COMPLETED\" ? \"default\" : \"secondary\"}>\n                        {purchase.status}\n                      </Badge>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"invoices\" className=\"mt-4\">\n          <Card>\n            <CardContent className=\"p-0\">\n              {customer.invoices.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No hay facturas registradas\n                </div>\n              ) : (\n                <div className=\"divide-y\">\n                  {customer.invoices.map((invoice) => (\n                    <div key={invoice.id} className=\"flex items-center gap-4 p-4\">\n                      <div className=\"w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                        <FileText className=\"w-5 h-5 text-blue-500\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-medium\">{invoice.invoiceNumber}</p>\n                        <p className=\"text-sm text-muted-foreground\">{formatDate(invoice.issueDate)}</p>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"font-medium\">{formatPrice(invoice.totalCents, invoice.currency)}</p>\n                      </div>\n                      <Badge variant={invoice.status === \"PAID\" ? \"default\" : \"secondary\"}>\n                        {invoice.status}\n                      </Badge>\n                      {invoice.pdfPath && (\n                        <Button \n                          variant=\"ghost\" \n                          size=\"icon\"\n                          onClick={() => handleDownloadInvoice(invoice.id)}\n                          data-testid={`download-invoice-${invoice.id}`}\n                        >\n                          <Download className=\"w-4 h-4\" />\n                        </Button>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nfunction PurchasesTab({ customers }: { customers: CustomerWithStats[] | undefined }) {\n  const [search, setSearch] = useState(\"\");\n  const [status, setStatus] = useState<string>(\"all\");\n  const [userId, setUserId] = useState<string>(\"all\");\n  const { toast } = useToast();\n\n  const statusFilter = status === \"all\" ? undefined : status;\n  const userFilter = userId === \"all\" ? undefined : userId;\n  \n  const { data: purchases, isLoading, refetch } = useQuery<PurchaseWithDetails[]>({\n    queryKey: [\"/api/admin/purchases\", { status: statusFilter, userId: userFilter }],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (statusFilter) params.append(\"status\", statusFilter);\n      if (userFilter) params.append(\"userId\", userFilter);\n      const url = `/api/admin/purchases${params.toString() ? `?${params.toString()}` : \"\"}`;\n      const res = await fetch(url, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Error cargando compras\");\n      return res.json();\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (purchaseId: string) => {\n      await apiRequest(\"DELETE\", `/api/admin/purchases/${purchaseId}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Compra eliminada\", description: \"La compra pendiente ha sido eliminada\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/purchases\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/customers\"] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"No se pudo eliminar la compra\", variant: \"destructive\" });\n    },\n  });\n\n  const cleanupMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/admin/cleanup-pending\");\n      return res.json();\n    },\n    onSuccess: (data: any) => {\n      toast({ title: \"Limpieza completada\", description: data.message });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/purchases\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/customers\"] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Error\", description: error.message || \"Error en la limpieza\", variant: \"destructive\" });\n    },\n  });\n\n  const filteredPurchases = purchases?.filter(p => {\n    if (search) {\n      const searchLower = search.toLowerCase();\n      if (!p.user.username.toLowerCase().includes(searchLower) &&\n          !p.user.email.toLowerCase().includes(searchLower) &&\n          !p.audiobook.title.toLowerCase().includes(searchLower)) {\n        return false;\n      }\n    }\n    return true;\n  }) || [];\n\n  const pendingCount = purchases?.filter(p => p.status === \"PENDING\").length || 0;\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex flex-wrap gap-4 items-center\">\n        <div className=\"relative flex-1 min-w-[200px]\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar por cliente o audiobook...\"\n            value={search}\n            onChange={(e) => setSearch(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-purchases\"\n          />\n        </div>\n        <Select value={status} onValueChange={setStatus}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"select-purchase-status\">\n            <SelectValue placeholder=\"Estado\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Todos</SelectItem>\n            <SelectItem value=\"PENDING\">Pendiente</SelectItem>\n            <SelectItem value=\"COMPLETED\">Completado</SelectItem>\n            <SelectItem value=\"CANCELLED\">Cancelado</SelectItem>\n            <SelectItem value=\"REFUNDED\">Reembolsado</SelectItem>\n          </SelectContent>\n        </Select>\n        <Select value={userId} onValueChange={setUserId}>\n          <SelectTrigger className=\"w-[200px]\" data-testid=\"select-purchase-user\">\n            <SelectValue placeholder=\"Cliente\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Todos los clientes</SelectItem>\n            {customers?.map((c) => (\n              <SelectItem key={c.user.id} value={c.user.id}>\n                {c.user.username}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        {pendingCount > 0 && (\n          <Button \n            variant=\"outline\" \n            onClick={() => cleanupMutation.mutate()}\n            disabled={cleanupMutation.isPending}\n            data-testid=\"button-cleanup-pending\"\n          >\n            <RefreshCw className={`w-4 h-4 mr-2 ${cleanupMutation.isPending ? \"animate-spin\" : \"\"}`} />\n            Limpiar pendientes ({pendingCount})\n          </Button>\n        )}\n      </div>\n\n      {pendingCount > 0 && (\n        <div className=\"flex items-center gap-2 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-md\">\n          <AlertCircle className=\"w-4 h-4 text-yellow-500\" />\n          <span className=\"text-sm\">\n            Hay {pendingCount} compra(s) en estado pendiente. Las compras pendientes se eliminan automaticamente despues de 24 horas.\n          </span>\n        </div>\n      )}\n\n      <Card>\n        <CardContent className=\"p-0\">\n          {isLoading ? (\n            <div className=\"space-y-4 p-4\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : filteredPurchases.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              No se encontraron compras\n            </div>\n          ) : (\n            <div className=\"divide-y\">\n              {filteredPurchases.map((purchase) => (\n                <div key={purchase.id} className=\"flex items-center gap-4 p-4\">\n                  <div className=\"w-12 h-12 rounded-lg overflow-hidden flex-shrink-0\">\n                    {purchase.audiobook.coverArtUrl ? (\n                      <img\n                        src={purchase.audiobook.coverArtUrl}\n                        alt={purchase.audiobook.title}\n                        className=\"w-full h-full object-cover\"\n                      />\n                    ) : (\n                      <div className=\"w-full h-full bg-primary/20 flex items-center justify-center\">\n                        <CreditCard className=\"w-5 h-5 text-primary\" />\n                      </div>\n                    )}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium truncate\">{purchase.audiobook.title}</p>\n                    <p className=\"text-sm text-muted-foreground truncate\">\n                      {purchase.user.username} - {purchase.user.email}\n                    </p>\n                  </div>\n                  <div className=\"hidden md:block text-right\">\n                    <p className=\"text-sm\">{formatDate(purchase.createdAt)}</p>\n                    {purchase.purchasedAt && (\n                      <p className=\"text-xs text-muted-foreground\">Completado: {formatDate(purchase.purchasedAt)}</p>\n                    )}\n                  </div>\n                  <div className=\"text-right\">\n                    <p className=\"font-medium\">{formatPrice(purchase.pricePaidCents, purchase.currency)}</p>\n                  </div>\n                  <Badge \n                    variant={\n                      purchase.status === \"COMPLETED\" ? \"default\" : \n                      purchase.status === \"PENDING\" ? \"secondary\" : \n                      \"outline\"\n                    }\n                  >\n                    {purchase.status === \"PENDING\" && \"Pendiente\"}\n                    {purchase.status === \"COMPLETED\" && \"Completado\"}\n                    {purchase.status === \"CANCELLED\" && \"Cancelado\"}\n                    {purchase.status === \"REFUNDED\" && \"Reembolsado\"}\n                  </Badge>\n                  {purchase.status === \"PENDING\" && (\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      onClick={() => deleteMutation.mutate(purchase.id)}\n                      disabled={deleteMutation.isPending}\n                      data-testid={`delete-purchase-${purchase.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4 text-destructive\" />\n                    </Button>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction InvoicesTab() {\n  const [search, setSearch] = useState(\"\");\n  const [status, setStatus] = useState<string>(\"all\");\n\n  const { data: invoices, isLoading } = useQuery<InvoiceWithUser[]>({\n    queryKey: [\"/api/admin/invoices\", { search, status: status === \"all\" ? undefined : status }],\n  });\n\n  const handleDownload = (invoiceId: string) => {\n    window.open(`/api/admin/invoices/${invoiceId}/download`, \"_blank\");\n  };\n\n  const filteredInvoices = invoices?.filter(inv => {\n    if (search) {\n      const searchLower = search.toLowerCase();\n      if (!inv.invoiceNumber.toLowerCase().includes(searchLower) &&\n          !inv.user.username.toLowerCase().includes(searchLower) &&\n          !inv.user.email.toLowerCase().includes(searchLower)) {\n        return false;\n      }\n    }\n    if (status !== \"all\" && inv.status !== status) {\n      return false;\n    }\n    return true;\n  }) || [];\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex flex-wrap gap-4\">\n        <div className=\"relative flex-1 min-w-[200px]\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar por numero, cliente...\"\n            value={search}\n            onChange={(e) => setSearch(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-invoices\"\n          />\n        </div>\n        <Select value={status} onValueChange={setStatus}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"select-invoice-status\">\n            <SelectValue placeholder=\"Estado\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Todos</SelectItem>\n            <SelectItem value=\"DRAFT\">Borrador</SelectItem>\n            <SelectItem value=\"ISSUED\">Emitida</SelectItem>\n            <SelectItem value=\"PAID\">Pagada</SelectItem>\n            <SelectItem value=\"CANCELLED\">Cancelada</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <Card>\n        <CardContent className=\"p-0\">\n          {isLoading ? (\n            <div className=\"space-y-4 p-4\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : filteredInvoices.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              No se encontraron facturas\n            </div>\n          ) : (\n            <div className=\"divide-y\">\n              {filteredInvoices.map((invoice) => (\n                <div key={invoice.id} className=\"flex items-center gap-4 p-4\">\n                  <div className=\"w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                    <FileText className=\"w-5 h-5 text-blue-500\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium\">{invoice.invoiceNumber}</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {invoice.user.username} - {invoice.user.email}\n                    </p>\n                  </div>\n                  <div className=\"hidden md:block text-right\">\n                    <p className=\"text-sm\">{formatDate(invoice.issueDate)}</p>\n                  </div>\n                  <div className=\"text-right\">\n                    <p className=\"font-medium\">{formatPrice(invoice.totalCents, invoice.currency)}</p>\n                  </div>\n                  <Badge variant={invoice.status === \"PAID\" ? \"default\" : \"secondary\"}>\n                    {invoice.status}\n                  </Badge>\n                  {invoice.pdfPath && (\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      onClick={() => handleDownload(invoice.id)}\n                      data-testid={`download-invoice-${invoice.id}`}\n                    >\n                      <Download className=\"w-4 h-4\" />\n                    </Button>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default function AdminCustomersPage() {\n  const [search, setSearch] = useState(\"\");\n  const [roleFilter, setRoleFilter] = useState<string>(\"all\");\n  const [profileFilter, setProfileFilter] = useState<string>(\"all\");\n  const [selectedCustomerId, setSelectedCustomerId] = useState<string | null>(null);\n  const [activeTab, setActiveTab] = useState(\"customers\");\n\n  const { data: customers, isLoading } = useQuery<CustomerWithStats[]>({\n    queryKey: [\"/api/admin/customers\"],\n  });\n\n  const filteredCustomers = customers?.filter(c => {\n    if (search) {\n      const searchLower = search.toLowerCase();\n      if (!c.user.username.toLowerCase().includes(searchLower) &&\n          !c.user.email.toLowerCase().includes(searchLower)) {\n        return false;\n      }\n    }\n    if (roleFilter !== \"all\" && c.user.role !== roleFilter) {\n      return false;\n    }\n    if (profileFilter === \"with\" && !c.billingProfile) {\n      return false;\n    }\n    if (profileFilter === \"without\" && c.billingProfile) {\n      return false;\n    }\n    return true;\n  }) || [];\n\n  const totalCustomers = customers?.length || 0;\n  const customersWithProfile = customers?.filter(c => c.billingProfile).length || 0;\n  const totalRevenue = customers?.reduce((sum, c) => sum + c.totalSpentCents, 0) || 0;\n\n  const clearFilters = () => {\n    setSearch(\"\");\n    setRoleFilter(\"all\");\n    setProfileFilter(\"all\");\n  };\n\n  const hasActiveFilters = search || roleFilter !== \"all\" || profileFilter !== \"all\";\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"flex items-center justify-between mb-8 flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-serif font-bold\">Gestion Comercial</h1>\n          <p className=\"text-muted-foreground\">Clientes, compras y facturas en un solo lugar</p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <Button\n            variant=\"outline\"\n            onClick={async () => {\n              try {\n                const response = await fetch(\"/api/admin/reports/customers\", { credentials: \"include\" });\n                if (!response.ok) throw new Error(\"Error al exportar\");\n                const blob = await response.blob();\n                const url = window.URL.createObjectURL(blob);\n                const a = document.createElement(\"a\");\n                a.href = url;\n                a.download = `clientes_${new Date().toISOString().split(\"T\")[0]}.xlsx`;\n                document.body.appendChild(a);\n                a.click();\n                window.URL.revokeObjectURL(url);\n                document.body.removeChild(a);\n              } catch (e) {\n                console.error(\"Export error:\", e);\n              }\n            }}\n            data-testid=\"button-export-customers\"\n          >\n            <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n            Exportar Clientes\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={async () => {\n              try {\n                const response = await fetch(\"/api/admin/reports/purchases\", { credentials: \"include\" });\n                if (!response.ok) throw new Error(\"Error al exportar\");\n                const blob = await response.blob();\n                const url = window.URL.createObjectURL(blob);\n                const a = document.createElement(\"a\");\n                a.href = url;\n                a.download = `compras_${new Date().toISOString().split(\"T\")[0]}.xlsx`;\n                document.body.appendChild(a);\n                a.click();\n                window.URL.revokeObjectURL(url);\n                document.body.removeChild(a);\n              } catch (e) {\n                console.error(\"Export error:\", e);\n              }\n            }}\n            data-testid=\"button-export-purchases\"\n          >\n            <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n            Exportar Compras\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={async () => {\n              try {\n                const response = await fetch(\"/api/admin/reports/invoices\", { credentials: \"include\" });\n                if (!response.ok) throw new Error(\"Error al exportar\");\n                const blob = await response.blob();\n                const url = window.URL.createObjectURL(blob);\n                const a = document.createElement(\"a\");\n                a.href = url;\n                a.download = `facturas_${new Date().toISOString().split(\"T\")[0]}.xlsx`;\n                document.body.appendChild(a);\n                a.click();\n                window.URL.revokeObjectURL(url);\n                document.body.removeChild(a);\n              } catch (e) {\n                console.error(\"Export error:\", e);\n              }\n            }}\n            data-testid=\"button-export-invoices\"\n          >\n            <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n            Exportar Facturas\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3 mb-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <Users className=\"w-8 h-8 text-primary\" />\n              <div>\n                <p className=\"text-2xl font-bold\">{totalCustomers}</p>\n                <p className=\"text-sm text-muted-foreground\">Total clientes</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <FileText className=\"w-8 h-8 text-blue-500\" />\n              <div>\n                <p className=\"text-2xl font-bold\">{customersWithProfile}</p>\n                <p className=\"text-sm text-muted-foreground\">Con perfil completo</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <DollarSign className=\"w-8 h-8 text-green-500\" />\n              <div>\n                <p className=\"text-2xl font-bold\">{formatPrice(totalRevenue)}</p>\n                <p className=\"text-sm text-muted-foreground\">Ingresos totales</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"mb-6\">\n          <TabsTrigger value=\"customers\" data-testid=\"tab-customers-main\">\n            <Users className=\"w-4 h-4 mr-2\" />\n            Clientes\n          </TabsTrigger>\n          <TabsTrigger value=\"purchases\" data-testid=\"tab-purchases-main\">\n            <ShoppingBag className=\"w-4 h-4 mr-2\" />\n            Compras\n          </TabsTrigger>\n          <TabsTrigger value=\"invoices\" data-testid=\"tab-invoices-main\">\n            <FileText className=\"w-4 h-4 mr-2\" />\n            Facturas\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"customers\">\n          {selectedCustomerId ? (\n            <CustomerDetailView \n              customerId={selectedCustomerId} \n              onClose={() => setSelectedCustomerId(null)} \n            />\n          ) : (\n            <div className=\"space-y-4\">\n              <div className=\"flex flex-wrap gap-4\">\n                <div className=\"relative flex-1 min-w-[200px]\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Buscar por nombre o email...\"\n                    value={search}\n                    onChange={(e) => setSearch(e.target.value)}\n                    className=\"pl-10\"\n                    data-testid=\"input-search-customers\"\n                  />\n                </div>\n                <Select value={roleFilter} onValueChange={setRoleFilter}>\n                  <SelectTrigger className=\"w-[150px]\" data-testid=\"select-role-filter\">\n                    <SelectValue placeholder=\"Rol\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos los roles</SelectItem>\n                    <SelectItem value=\"LISTENER\">Oyente</SelectItem>\n                    <SelectItem value=\"CREATOR\">Creador</SelectItem>\n                    <SelectItem value=\"ADMIN\">Admin</SelectItem>\n                  </SelectContent>\n                </Select>\n                <Select value={profileFilter} onValueChange={setProfileFilter}>\n                  <SelectTrigger className=\"w-[180px]\" data-testid=\"select-profile-filter\">\n                    <SelectValue placeholder=\"Perfil\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos</SelectItem>\n                    <SelectItem value=\"with\">Con perfil</SelectItem>\n                    <SelectItem value=\"without\">Sin perfil</SelectItem>\n                  </SelectContent>\n                </Select>\n                {hasActiveFilters && (\n                  <Button variant=\"ghost\" onClick={clearFilters} data-testid=\"button-clear-filters\">\n                    <X className=\"w-4 h-4 mr-2\" />\n                    Limpiar filtros\n                  </Button>\n                )}\n              </div>\n\n              <Card>\n                <CardContent className=\"p-0\">\n                  {isLoading ? (\n                    <div className=\"space-y-4 p-4\">\n                      {[1, 2, 3, 4, 5].map((i) => (\n                        <Skeleton key={i} className=\"h-16 w-full\" />\n                      ))}\n                    </div>\n                  ) : filteredCustomers.length === 0 ? (\n                    <div className=\"text-center py-12 text-muted-foreground\">\n                      No se encontraron clientes\n                    </div>\n                  ) : (\n                    <div>\n                      {filteredCustomers.map((customer) => (\n                        <CustomerRow\n                          key={customer.user.id}\n                          customer={customer}\n                          onClick={() => setSelectedCustomerId(customer.user.id)}\n                        />\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"purchases\">\n          <PurchasesTab customers={customers} />\n        </TabsContent>\n\n        <TabsContent value=\"invoices\">\n          <InvoicesTab />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":37496,"size_tokens":null},"client/src/pages/mobile.tsx":{"content":"import { useState, useRef, useEffect, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  Headphones, \n  Library, \n  ShoppingCart, \n  User, \n  Play,\n  Pause,\n  SkipBack,\n  SkipForward,\n  BookOpen,\n  Crown,\n  Home,\n  Search,\n  Heart,\n  Trash2,\n  Plus,\n  Minus,\n  Check,\n  ChevronLeft,\n  ChevronRight,\n  X,\n  Volume2,\n  Copy,\n  ExternalLink,\n  Rss,\n  Download,\n  ChevronDown,\n  ChevronUp,\n  LogOut,\n  Settings,\n  Mail,\n  CreditCard,\n  Tag,\n  Loader2\n} from \"lucide-react\";\nimport type { Audiobook, CartItem, UserSubscription, SubscriptionPlan, Chapter, BillingProfile } from \"@shared/schema\";\nimport logoImage from \"@assets/audivia_horizonta_1766267902382.png\";\n\ntype TabType = \"home\" | \"explore\" | \"library\" | \"cart\";\n\ninterface CartWithItems {\n  items: (CartItem & { audiobook: Audiobook })[];\n  total: number;\n}\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\nfunction formatDuration(seconds: number): string {\n  const mins = Math.floor(seconds / 60);\n  const secs = Math.floor(seconds % 60);\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}\n\nfunction AudiobookCard({ audiobook, onView, onAddToCart, inCart, purchased }: { \n  audiobook: Audiobook; \n  onView: () => void;\n  onAddToCart?: () => void;\n  inCart?: boolean;\n  purchased?: boolean;\n}) {\n  return (\n    <Card className=\"overflow-hidden hover-elevate cursor-pointer\" onClick={onView}>\n      <div className=\"aspect-square relative\">\n        {audiobook.coverArtUrl ? (\n          <img\n            src={audiobook.coverArtUrl}\n            alt={audiobook.title}\n            className=\"w-full h-full object-cover\"\n          />\n        ) : (\n          <div className=\"w-full h-full bg-gradient-to-br from-primary/40 to-primary/80 flex items-center justify-center\">\n            <BookOpen className=\"w-8 h-8 text-primary-foreground/60\" />\n          </div>\n        )}\n        {purchased && (\n          <Badge className=\"absolute top-2 right-2 bg-green-600\">\n            <Check className=\"w-3 h-3 mr-1\" />\n            Tuyo\n          </Badge>\n        )}\n        {audiobook.priceCents === 0 && !purchased && (\n          <Badge className=\"absolute top-2 right-2 bg-accent text-accent-foreground\">Gratis</Badge>\n        )}\n      </div>\n      <CardContent className=\"p-2\">\n        <h3 className=\"font-medium text-sm line-clamp-1\">{audiobook.title}</h3>\n        <p className=\"text-xs text-muted-foreground line-clamp-1\">{audiobook.author}</p>\n        <div className=\"flex items-center justify-between mt-2 gap-1\">\n          {audiobook.priceCents > 0 && !purchased ? (\n            <span className=\"text-sm font-bold text-primary\">\n              {formatPrice(audiobook.priceCents, audiobook.currency)}\n            </span>\n          ) : (\n            <span></span>\n          )}\n          {!purchased && audiobook.priceCents > 0 && (\n            <Button \n              size=\"icon\" \n              variant={inCart ? \"secondary\" : \"default\"}\n              className=\"h-7 w-7\"\n              onClick={(e) => {\n                e.stopPropagation();\n                onAddToCart?.();\n              }}\n              data-testid={`button-add-cart-${audiobook.id}`}\n            >\n              {inCart ? <Check className=\"w-3 h-3\" /> : <Plus className=\"w-3 h-3\" />}\n            </Button>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction AudioPlayer({ \n  chapter, \n  audiobook,\n  onClose,\n  onNext,\n  onPrev,\n  hasNext,\n  hasPrev\n}: { \n  chapter: Chapter;\n  audiobook: Audiobook;\n  onClose: () => void;\n  onNext?: () => void;\n  onPrev?: () => void;\n  hasNext?: boolean;\n  hasPrev?: boolean;\n}) {\n  const audioRef = useRef<HTMLAudioElement>(null);\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [currentTime, setCurrentTime] = useState(0);\n  const [duration, setDuration] = useState(0);\n\n  useEffect(() => {\n    const audio = audioRef.current;\n    if (!audio) return;\n\n    const handleTimeUpdate = () => setCurrentTime(audio.currentTime);\n    const handleLoadedMetadata = () => setDuration(audio.duration);\n    const handleEnded = () => {\n      setIsPlaying(false);\n      if (hasNext && onNext) onNext();\n    };\n\n    audio.addEventListener('timeupdate', handleTimeUpdate);\n    audio.addEventListener('loadedmetadata', handleLoadedMetadata);\n    audio.addEventListener('ended', handleEnded);\n\n    return () => {\n      audio.removeEventListener('timeupdate', handleTimeUpdate);\n      audio.removeEventListener('loadedmetadata', handleLoadedMetadata);\n      audio.removeEventListener('ended', handleEnded);\n    };\n  }, [hasNext, onNext]);\n\n  const togglePlay = () => {\n    const audio = audioRef.current;\n    if (!audio) return;\n\n    if (isPlaying) {\n      audio.pause();\n    } else {\n      audio.play();\n    }\n    setIsPlaying(!isPlaying);\n  };\n\n  const handleSeek = (value: number[]) => {\n    const audio = audioRef.current;\n    if (!audio) return;\n    audio.currentTime = value[0];\n    setCurrentTime(value[0]);\n  };\n\n  const skip = (seconds: number) => {\n    const audio = audioRef.current;\n    if (!audio) return;\n    audio.currentTime = Math.max(0, Math.min(duration, audio.currentTime + seconds));\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-background z-50 flex flex-col\">\n      <audio ref={audioRef} src={chapter.audioUrl || undefined} preload=\"metadata\" />\n      \n      <header className=\"flex items-center justify-between px-4 py-3 border-b shrink-0\">\n        <Button variant=\"ghost\" size=\"icon\" onClick={onClose} data-testid=\"button-close-player\">\n          <X className=\"w-5 h-5\" />\n        </Button>\n        <span className=\"text-sm font-medium\">Reproduciendo</span>\n        <div className=\"w-9\" />\n      </header>\n\n      <div className=\"flex-1 flex flex-col items-center justify-center p-6 gap-6\">\n        <div className=\"w-48 aspect-square rounded-lg overflow-hidden shadow-xl\">\n          {audiobook.coverArtUrl ? (\n            <img src={audiobook.coverArtUrl} alt={audiobook.title} className=\"w-full h-full object-cover\" />\n          ) : (\n            <div className=\"w-full h-full bg-gradient-to-br from-primary/40 to-primary/80 flex items-center justify-center\">\n              <BookOpen className=\"w-16 h-16 text-primary-foreground/60\" />\n            </div>\n          )}\n        </div>\n\n        <div className=\"text-center w-full\">\n          <h2 className=\"font-serif text-xl font-bold line-clamp-2\">{chapter.title}</h2>\n          <p className=\"text-muted-foreground\">{audiobook.title}</p>\n          <p className=\"text-sm text-muted-foreground\">{audiobook.author}</p>\n        </div>\n      </div>\n\n      <div className=\"p-6 space-y-4 shrink-0\">\n        <div className=\"space-y-2\">\n          <Slider\n            value={[currentTime]}\n            max={duration || 100}\n            step={1}\n            onValueChange={handleSeek}\n            className=\"w-full\"\n          />\n          <div className=\"flex justify-between text-xs text-muted-foreground\">\n            <span>{formatDuration(currentTime)}</span>\n            <span>{formatDuration(duration)}</span>\n          </div>\n        </div>\n\n        <div className=\"flex items-center justify-center gap-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={onPrev}\n            disabled={!hasPrev}\n            data-testid=\"button-prev-chapter\"\n          >\n            <SkipBack className=\"w-6 h-6\" />\n          </Button>\n          \n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => skip(-15)}\n            data-testid=\"button-rewind\"\n          >\n            <ChevronLeft className=\"w-5 h-5\" />\n            <span className=\"text-xs absolute bottom-1\">15</span>\n          </Button>\n          \n          <Button \n            size=\"icon\" \n            className=\"h-16 w-16 rounded-full\"\n            onClick={togglePlay}\n            data-testid=\"button-play-pause\"\n          >\n            {isPlaying ? <Pause className=\"w-8 h-8\" /> : <Play className=\"w-8 h-8 ml-1\" />}\n          </Button>\n          \n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => skip(15)}\n            data-testid=\"button-forward\"\n          >\n            <ChevronRight className=\"w-5 h-5\" />\n            <span className=\"text-xs absolute bottom-1\">15</span>\n          </Button>\n          \n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={onNext}\n            disabled={!hasNext}\n            data-testid=\"button-next-chapter\"\n          >\n            <SkipForward className=\"w-6 h-6\" />\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction HomeTab({ \n  audiobooks, \n  isLoading, \n  onViewAudiobook,\n  cartItems,\n  purchasedIds,\n  onAddToCart,\n  onShowSubscriptions\n}: { \n  audiobooks: Audiobook[];\n  isLoading: boolean;\n  onViewAudiobook: (audiobook: Audiobook) => void;\n  cartItems: string[];\n  purchasedIds: string[];\n  onAddToCart: (id: string) => void;\n  onShowSubscriptions: () => void;\n}) {\n  const { data: user } = useQuery<{ id: string } | null>({\n    queryKey: [\"/api/auth/me\"],\n  });\n\n  const { data: subscription } = useQuery<UserSubscription & { plan: SubscriptionPlan }>({\n    queryKey: [\"/api/subscriptions/active\"],\n    enabled: !!user,\n  });\n\n  const categories = [...new Set(audiobooks.map(b => b.category).filter(Boolean))];\n  const freeBooks = audiobooks.filter(b => b.priceCents === 0).slice(0, 4);\n  const popularBooks = audiobooks.filter(b => b.priceCents > 0).slice(0, 6);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 p-4 space-y-6 overflow-auto\">\n        <Skeleton className=\"h-24 rounded-lg\" />\n        <div className=\"grid grid-cols-2 gap-3\">\n          {[1, 2, 3, 4].map(i => (\n            <Skeleton key={i} className=\"aspect-square rounded-lg\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 overflow-auto\">\n      <div className=\"p-4 space-y-6\">\n        <section className=\"text-center py-4\">\n          <h1 className=\"font-serif text-2xl font-bold\" data-testid=\"text-welcome\">\n            Bienvenido a Audivia\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Tu biblioteca de audiolibros en espaÃ±ol\n          </p>\n        </section>\n\n        {subscription && (\n          <Card className=\"border-accent bg-accent/10\">\n            <CardContent className=\"p-4 flex items-center gap-3\">\n              <Crown className=\"w-10 h-10 text-accent\" />\n              <div>\n                <p className=\"font-semibold\">SuscripciÃ³n {subscription.plan?.name}</p>\n                <p className=\"text-sm text-muted-foreground\">Acceso ilimitado a todo el catÃ¡logo</p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {!subscription && !user && (\n          <Card className=\"bg-primary/10 border-primary/30\">\n            <CardContent className=\"p-4 text-center\">\n              <Headphones className=\"w-10 h-10 mx-auto text-primary mb-2\" />\n              <p className=\"font-medium\">Descubre audiolibros increÃ­bles</p>\n              <p className=\"text-sm text-muted-foreground mb-3\">Inicia sesiÃ³n para comprar y guardar favoritos</p>\n              <Link href=\"/login?from=mobile\">\n                <Button size=\"sm\" data-testid=\"button-login-cta\">Iniciar sesiÃ³n</Button>\n              </Link>\n            </CardContent>\n          </Card>\n        )}\n\n        {user && !subscription && (\n          <Card className=\"bg-gradient-to-br from-accent/20 to-primary/20 border-accent/30\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3 mb-3\">\n                <Crown className=\"w-10 h-10 text-accent\" />\n                <div>\n                  <p className=\"font-semibold\">Hazte Premium</p>\n                  <p className=\"text-sm text-muted-foreground\">Acceso ilimitado a todo el catÃ¡logo</p>\n                </div>\n              </div>\n              <Button className=\"w-full\" onClick={onShowSubscriptions} data-testid=\"button-show-subscriptions\">\n                Ver planes de suscripciÃ³n\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        {freeBooks.length > 0 && (\n          <section>\n            <h2 className=\"font-semibold text-lg mb-3 flex items-center gap-2\">\n              <BookOpen className=\"w-5 h-5 text-primary\" />\n              Audiolibros gratuitos\n            </h2>\n            <div className=\"flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-4 px-4\">\n              {freeBooks.map(book => (\n                <div key={book.id} className=\"w-36 shrink-0\">\n                  <AudiobookCard\n                    audiobook={book}\n                    onView={() => onViewAudiobook(book)}\n                    purchased={purchasedIds.includes(book.id)}\n                  />\n                </div>\n              ))}\n            </div>\n          </section>\n        )}\n\n        {popularBooks.length > 0 && (\n          <section>\n            <h2 className=\"font-semibold text-lg mb-3 flex items-center gap-2\">\n              <Headphones className=\"w-5 h-5 text-primary\" />\n              CatÃ¡logo completo\n            </h2>\n            <div className=\"flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-4 px-4\">\n              {popularBooks.map(book => (\n                <div key={book.id} className=\"w-36 shrink-0\">\n                  <AudiobookCard\n                    audiobook={book}\n                    onView={() => onViewAudiobook(book)}\n                    onAddToCart={() => onAddToCart(book.id)}\n                    inCart={cartItems.includes(book.id)}\n                    purchased={purchasedIds.includes(book.id)}\n                  />\n                </div>\n              ))}\n            </div>\n          </section>\n        )}\n\n        {categories.length > 0 && (\n          <section>\n            <h2 className=\"font-semibold text-lg mb-3\">CategorÃ­as</h2>\n            <div className=\"flex gap-2 overflow-x-auto scrollbar-hide pb-2 -mx-4 px-4\">\n              {categories.map(cat => (\n                <Badge key={cat} variant=\"secondary\" className=\"px-3 py-1 shrink-0\">\n                  {cat}\n                </Badge>\n              ))}\n            </div>\n          </section>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction ExploreTab({ \n  audiobooks, \n  isLoading,\n  cartItems, \n  purchasedIds,\n  onAddToCart, \n  onViewAudiobook \n}: { \n  audiobooks: Audiobook[];\n  isLoading: boolean;\n  cartItems: string[];\n  purchasedIds: string[];\n  onAddToCart: (id: string) => void;\n  onViewAudiobook: (audiobook: Audiobook) => void;\n}) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const filteredAudiobooks = audiobooks.filter(book => \n    book.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    book.author.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    book.category?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 p-4 grid grid-cols-2 gap-3\">\n        {[1, 2, 3, 4].map(i => (\n          <Skeleton key={i} className=\"aspect-square rounded-lg\" />\n        ))}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 flex flex-col overflow-hidden\">\n      <div className=\"p-4 pb-2 shrink-0\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar por tÃ­tulo, autor o categorÃ­a...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search\"\n          />\n        </div>\n      </div>\n\n      <div className=\"flex-1 overflow-auto p-4 pt-2\">\n        {filteredAudiobooks.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center h-full gap-2\">\n            <Search className=\"w-12 h-12 text-muted-foreground/30\" />\n            <p className=\"text-muted-foreground\">No se encontraron audiolibros</p>\n          </div>\n        ) : (\n          <div className=\"grid grid-cols-2 gap-3\">\n            {filteredAudiobooks.map(book => (\n              <AudiobookCard\n                key={book.id}\n                audiobook={book}\n                onView={() => onViewAudiobook(book)}\n                onAddToCart={() => onAddToCart(book.id)}\n                inCart={cartItems.includes(book.id)}\n                purchased={purchasedIds.includes(book.id)}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction LibraryTab({ onViewAudiobook }: { \n  onViewAudiobook: (audiobook: Audiobook) => void;\n}) {\n  const { toast } = useToast();\n  const [activeSection, setActiveSection] = useState<\"purchases\" | \"favorites\">(\"purchases\");\n\n  const { data: user } = useQuery<{ id: string } | null>({\n    queryKey: [\"/api/auth/me\"],\n  });\n\n  const { data: purchases, isLoading: loadingPurchases } = useQuery<{ audiobook: Audiobook }[]>({\n    queryKey: [\"/api/library/purchases\"],\n    enabled: !!user,\n  });\n\n  const { data: favorites, isLoading: loadingFavorites } = useQuery<{ audiobook: Audiobook }[]>({\n    queryKey: [\"/api/library/favorites\"],\n    enabled: !!user,\n  });\n\n  const removeFavoriteMutation = useMutation({\n    mutationFn: (audiobookId: string) => apiRequest(\"DELETE\", `/api/library/favorites/${audiobookId}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/library/favorites\"] });\n      toast({ title: \"Eliminado de favoritos\" });\n    },\n  });\n\n  if (!user) {\n    return (\n      <div className=\"flex-1 flex flex-col items-center justify-center gap-4 p-4\">\n        <Library className=\"w-16 h-16 text-muted-foreground/30\" />\n        <p className=\"text-muted-foreground text-center\">Inicia sesiÃ³n para ver tu biblioteca</p>\n        <Link href=\"/login?from=mobile\">\n          <Button data-testid=\"button-login\">Iniciar sesiÃ³n</Button>\n        </Link>\n      </div>\n    );\n  }\n\n  const isLoading = loadingPurchases || loadingFavorites;\n  const items = activeSection === \"purchases\" ? purchases : favorites;\n\n  return (\n    <div className=\"flex-1 flex flex-col overflow-hidden\">\n      <div className=\"p-4 pb-2 shrink-0\">\n        <div className=\"flex gap-2\">\n          <Button\n            variant={activeSection === \"purchases\" ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setActiveSection(\"purchases\")}\n            className=\"flex-1\"\n            data-testid=\"button-purchases\"\n          >\n            <BookOpen className=\"w-4 h-4 mr-1\" />\n            Mis audiolibros\n          </Button>\n          <Button\n            variant={activeSection === \"favorites\" ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setActiveSection(\"favorites\")}\n            className=\"flex-1\"\n            data-testid=\"button-favorites\"\n          >\n            <Heart className=\"w-4 h-4 mr-1\" />\n            Favoritos\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"flex-1 overflow-auto p-4 pt-2\">\n        {isLoading ? (\n          <div className=\"grid grid-cols-2 gap-3\">\n            {[1, 2, 3, 4].map(i => (\n              <Skeleton key={i} className=\"aspect-square rounded-lg\" />\n            ))}\n          </div>\n        ) : !items || items.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center h-full gap-2\">\n            {activeSection === \"purchases\" ? (\n              <>\n                <BookOpen className=\"w-12 h-12 text-muted-foreground/30\" />\n                <p className=\"text-muted-foreground\">No tienes audiolibros comprados</p>\n                <p className=\"text-sm text-muted-foreground\">Explora nuestro catÃ¡logo</p>\n              </>\n            ) : (\n              <>\n                <Heart className=\"w-12 h-12 text-muted-foreground/30\" />\n                <p className=\"text-muted-foreground\">No tienes favoritos</p>\n              </>\n            )}\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {items.map(({ audiobook }) => (\n              <Card \n                key={audiobook.id} \n                className=\"overflow-hidden cursor-pointer hover-elevate\" \n                onClick={() => onViewAudiobook(audiobook)}\n              >\n                <div className=\"flex gap-3 p-3\">\n                  <div className=\"w-16 h-16 rounded overflow-hidden shrink-0\">\n                    {audiobook.coverArtUrl ? (\n                      <img src={audiobook.coverArtUrl} alt={audiobook.title} className=\"w-full h-full object-cover\" />\n                    ) : (\n                      <div className=\"w-full h-full bg-gradient-to-br from-primary/40 to-primary/80 flex items-center justify-center\">\n                        <BookOpen className=\"w-6 h-6 text-primary-foreground/60\" />\n                      </div>\n                    )}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <h3 className=\"font-medium text-sm line-clamp-2\">{audiobook.title}</h3>\n                    <p className=\"text-xs text-muted-foreground\">{audiobook.author}</p>\n                    <div className=\"flex gap-2 mt-2\">\n                      <Button \n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          onViewAudiobook(audiobook);\n                        }}\n                        data-testid={`button-listen-${audiobook.id}`}\n                      >\n                        <Play className=\"w-3 h-3 mr-1\" />\n                        Escuchar\n                      </Button>\n                      {activeSection === \"favorites\" && (\n                        <Button \n                          size=\"icon\" \n                          variant=\"ghost\"\n                          className=\"h-8 w-8 text-destructive\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            removeFavoriteMutation.mutate(audiobook.id);\n                          }}\n                          data-testid={`button-remove-favorite-${audiobook.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nconst billingFormSchema = z.object({\n  fullName: z.string().min(2, \"Nombre completo es requerido\"),\n  email: z.string().email(\"Email invalido\"),\n  taxId: z.string().optional(),\n  address: z.string().min(5, \"Direccion es requerida\"),\n  city: z.string().min(2, \"Ciudad es requerida\"),\n  postalCode: z.string().min(3, \"Codigo postal es requerido\"),\n  country: z.string().min(2, \"Pais es requerido\"),\n});\n\ntype BillingFormData = z.infer<typeof billingFormSchema>;\n\ninterface AppliedDiscount {\n  id: string;\n  code: string;\n  type: \"PERCENTAGE\" | \"FIXED_AMOUNT\";\n  value: number;\n  discountAmountCents: number;\n  finalAmountCents: number;\n}\n\ninterface MobileCartData {\n  items: (CartItem & { audiobook: Audiobook })[];\n  totalCents: number;\n  total: number;\n  itemCount: number;\n  currency: string;\n}\n\nfunction MobilePayPalButton({ \n  totalCents, \n  currency, \n  discountCode,\n  onSuccess \n}: { \n  totalCents: number; \n  currency: string;\n  discountCode?: string;\n  onSuccess: () => void;\n}) {\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [scriptLoaded, setScriptLoaded] = useState(false);\n  const containerIdRef = useRef(`paypal-mobile-btn-${Date.now()}`);\n  const discountCodeRef = useRef(discountCode);\n  const onSuccessRef = useRef(onSuccess);\n\n  discountCodeRef.current = discountCode;\n  onSuccessRef.current = onSuccess;\n\n  const { data: paypalConfig } = useQuery<{ clientId: string }>({\n    queryKey: [\"/api/paypal/client-id\"],\n  });\n\n  useEffect(() => {\n    if (!paypalConfig?.clientId) return;\n    \n    if ((window as any).paypal) {\n      setScriptLoaded(true);\n      setIsLoading(false);\n      return;\n    }\n\n    const existingScript = document.querySelector('script[src*=\"paypal.com/sdk\"]');\n    if (existingScript) {\n      const checkPaypal = setInterval(() => {\n        if ((window as any).paypal) {\n          clearInterval(checkPaypal);\n          setScriptLoaded(true);\n          setIsLoading(false);\n        }\n      }, 100);\n      return () => clearInterval(checkPaypal);\n    }\n\n    const script = document.createElement(\"script\");\n    script.src = `https://www.paypal.com/sdk/js?client-id=${paypalConfig.clientId}&currency=${currency}`;\n    script.async = true;\n    script.onload = () => {\n      setScriptLoaded(true);\n      setIsLoading(false);\n    };\n    script.onerror = () => {\n      setError(\"Error al cargar PayPal\");\n      setIsLoading(false);\n    };\n    document.body.appendChild(script);\n  }, [paypalConfig?.clientId, currency]);\n\n  useEffect(() => {\n    if (!scriptLoaded || !(window as any).paypal) return;\n\n    const container = document.getElementById(containerIdRef.current);\n    if (!container) return;\n    \n    container.innerHTML = \"\";\n\n    (window as any).paypal.Buttons({\n      style: {\n        layout: \"vertical\",\n        color: \"gold\",\n        shape: \"rect\",\n        label: \"pay\",\n      },\n      createOrder: async () => {\n        try {\n          const response = await fetch(\"/api/paypal/create-cart-order\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify({ discountCode: discountCodeRef.current }),\n          });\n          \n          if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(errorData.error || \"Error creating order\");\n          }\n          \n          const data = await response.json();\n          return data.orderId;\n        } catch (err: any) {\n          toast({\n            variant: \"destructive\",\n            title: \"Error\",\n            description: err.message || \"No se pudo crear la orden\",\n          });\n          throw err;\n        }\n      },\n      onApprove: async (data: { orderID: string }) => {\n        try {\n          const response = await fetch(\"/api/paypal/capture-cart-order\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify({ orderId: data.orderID }),\n          });\n          \n          if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(errorData.error || \"Error capturing order\");\n          }\n          \n          onSuccessRef.current();\n        } catch (err: any) {\n          toast({\n            variant: \"destructive\",\n            title: \"Error\",\n            description: err.message || \"No se pudo completar el pago\",\n          });\n        }\n      },\n      onError: (err: any) => {\n        console.error(\"PayPal error:\", err);\n        toast({\n          variant: \"destructive\",\n          title: \"Error de PayPal\",\n          description: \"Hubo un problema con el pago\",\n        });\n      },\n    }).render(`#${containerIdRef.current}`);\n  }, [scriptLoaded, toast]);\n\n  if (error) {\n    return (\n      <div className=\"text-center py-4\">\n        <p className=\"text-destructive text-sm\">{error}</p>\n        <Button \n          variant=\"outline\" \n          size=\"sm\"\n          className=\"mt-2\" \n          onClick={() => {\n            setError(null);\n            setIsLoading(true);\n            setScriptLoaded(false);\n          }}\n        >\n          Reintentar\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-3\">\n      {isLoading && (\n        <div className=\"flex items-center justify-center py-6\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-primary\" />\n        </div>\n      )}\n      <div id={containerIdRef.current} data-testid=\"paypal-mobile-button\"></div>\n      <p className=\"text-xs text-center text-muted-foreground\">\n        Pago seguro procesado por PayPal\n      </p>\n    </div>\n  );\n}\n\nfunction MobileCheckoutView({ \n  cart, \n  onBack, \n  onSuccess \n}: { \n  cart: MobileCartData;\n  onBack: () => void;\n  onSuccess: () => void;\n}) {\n  const { toast } = useToast();\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [showPayPal, setShowPayPal] = useState(false);\n  const [discountCode, setDiscountCode] = useState(\"\");\n  const [appliedDiscount, setAppliedDiscount] = useState<AppliedDiscount | null>(null);\n  const [isValidatingCode, setIsValidatingCode] = useState(false);\n\n  const { data: billingProfile } = useQuery<BillingProfile>({\n    queryKey: [\"/api/billing-profile\"],\n  });\n\n  const { data: user } = useQuery<{ id: string; email: string; displayName?: string }>({\n    queryKey: [\"/api/user\"],\n  });\n\n  const form = useForm<BillingFormData>({\n    resolver: zodResolver(billingFormSchema),\n    defaultValues: {\n      fullName: \"\",\n      email: \"\",\n      taxId: \"\",\n      address: \"\",\n      city: \"\",\n      postalCode: \"\",\n      country: \"Espana\",\n    },\n  });\n\n  const isProfileComplete = useMemo(() => {\n    if (!billingProfile) return false;\n    return !!(\n      billingProfile.fullName &&\n      billingProfile.email &&\n      billingProfile.address &&\n      billingProfile.city &&\n      billingProfile.postalCode &&\n      billingProfile.country\n    );\n  }, [billingProfile]);\n\n  useEffect(() => {\n    if (billingProfile || user) {\n      form.reset({\n        fullName: billingProfile?.fullName || user?.displayName || \"\",\n        email: billingProfile?.email || user?.email || \"\",\n        taxId: billingProfile?.taxId || \"\",\n        address: billingProfile?.address || \"\",\n        city: billingProfile?.city || \"\",\n        postalCode: billingProfile?.postalCode || \"\",\n        country: billingProfile?.country || \"Espana\",\n      });\n    }\n  }, [billingProfile, user, form]);\n\n  useEffect(() => {\n    if (isProfileComplete) {\n      setShowPayPal(true);\n    }\n  }, [isProfileComplete]);\n\n  const onSubmit = async (data: BillingFormData) => {\n    setIsProcessing(true);\n    try {\n      await apiRequest(\"POST\", \"/api/billing-profile\", data);\n      queryClient.invalidateQueries({ queryKey: [\"/api/billing-profile\"] });\n      setShowPayPal(true);\n      toast({\n        title: \"Datos guardados\",\n        description: \"Tus datos de facturacion se han guardado\",\n      });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudieron guardar los datos\",\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const validateDiscountCode = async () => {\n    if (!discountCode.trim()) return;\n    \n    setIsValidatingCode(true);\n    try {\n      const response = await apiRequest(\"POST\", \"/api/discount-codes/validate\", {\n        code: discountCode.trim().toUpperCase(),\n        totalCents: cart.totalCents || cart.total * 100,\n        forSubscription: false,\n      });\n      \n      const data = await response.json();\n      \n      if (data.valid) {\n        setAppliedDiscount({\n          id: data.discountCode.id,\n          code: data.discountCode.code,\n          type: data.discountCode.type,\n          value: data.discountCode.value,\n          discountAmountCents: data.discountAmountCents,\n          finalAmountCents: data.finalAmountCents,\n        });\n        toast({\n          title: \"Codigo aplicado\",\n          description: `Descuento de ${formatPrice(data.discountAmountCents, cart.currency || \"EUR\")} aplicado`,\n        });\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Codigo invalido\",\n          description: data.error || \"El codigo de descuento no es valido\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo validar el codigo\",\n      });\n    } finally {\n      setIsValidatingCode(false);\n    }\n  };\n\n  const removeDiscount = () => {\n    setAppliedDiscount(null);\n    setDiscountCode(\"\");\n  };\n\n  const totalCents = cart.totalCents || cart.total * 100;\n  const finalTotal = appliedDiscount ? appliedDiscount.finalAmountCents : totalCents;\n\n  return (\n    <div className=\"flex-1 flex flex-col overflow-hidden\">\n      <div className=\"p-4 border-b shrink-0 flex items-center gap-3\">\n        <Button variant=\"ghost\" size=\"icon\" onClick={onBack} data-testid=\"button-back-checkout\">\n          <ChevronLeft className=\"w-5 h-5\" />\n        </Button>\n        <div className=\"flex items-center gap-2\">\n          <CreditCard className=\"w-5 h-5\" />\n          <h1 className=\"font-serif text-xl font-bold\">Finalizar compra</h1>\n        </div>\n      </div>\n      \n      <div className=\"flex-1 overflow-auto p-4 space-y-4\">\n        <Card>\n          <CardContent className=\"p-4 space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"font-medium\">Resumen</span>\n              <span className=\"text-sm text-muted-foreground\">{cart.items?.length || cart.itemCount} audiolibros</span>\n            </div>\n            <div className=\"flex gap-2 overflow-x-auto scrollbar-hide pb-2\">\n              {cart.items?.map((item) => (\n                <div key={item.id} className=\"w-12 h-12 rounded overflow-hidden shrink-0\">\n                  {item.audiobook.coverArtUrl ? (\n                    <img src={item.audiobook.coverArtUrl} alt={item.audiobook.title} className=\"w-full h-full object-cover\" />\n                  ) : (\n                    <div className=\"w-full h-full bg-gradient-to-br from-primary/40 to-primary/80 flex items-center justify-center\">\n                      <BookOpen className=\"w-4 h-4 text-primary-foreground/60\" />\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4 space-y-3\">\n            <div className=\"flex items-center gap-2 text-sm font-medium\">\n              <Tag className=\"w-4 h-4\" />\n              Codigo de descuento\n            </div>\n            {appliedDiscount ? (\n              <div className=\"flex items-center justify-between bg-green-500/10 p-3 rounded-lg border border-green-500/20\">\n                <div>\n                  <span className=\"font-mono font-bold text-green-600 dark:text-green-400\">{appliedDiscount.code}</span>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {appliedDiscount.type === \"PERCENTAGE\" \n                      ? `${appliedDiscount.value}% de descuento`\n                      : `${formatPrice(appliedDiscount.value * 100, cart.currency || \"EUR\")} de descuento`\n                    }\n                  </p>\n                </div>\n                <Button size=\"icon\" variant=\"ghost\" onClick={removeDiscount} data-testid=\"button-remove-discount-mobile\">\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            ) : (\n              <div className=\"flex gap-2\">\n                <Input\n                  placeholder=\"Tu codigo\"\n                  value={discountCode}\n                  onChange={(e) => setDiscountCode(e.target.value.toUpperCase())}\n                  onKeyDown={(e) => e.key === \"Enter\" && (e.preventDefault(), validateDiscountCode())}\n                  className=\"flex-1 font-mono\"\n                  data-testid=\"input-discount-code-mobile\"\n                />\n                <Button \n                  variant=\"outline\" \n                  onClick={validateDiscountCode}\n                  disabled={isValidatingCode || !discountCode.trim()}\n                  data-testid=\"button-apply-discount-mobile\"\n                >\n                  {isValidatingCode ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : \"Aplicar\"}\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              {showPayPal && <Check className=\"w-4 h-4 text-green-500\" />}\n              <span className=\"font-medium text-sm\">Datos de facturacion</span>\n            </div>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-3\">\n                <FormField\n                  control={form.control}\n                  name=\"fullName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-xs\">Nombre completo</FormLabel>\n                      <FormControl>\n                        <Input {...field} disabled={showPayPal} className=\"h-9\" data-testid=\"input-fullname-mobile\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-xs\">Email</FormLabel>\n                      <FormControl>\n                        <Input type=\"email\" {...field} disabled={showPayPal} className=\"h-9\" data-testid=\"input-email-mobile\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"address\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-xs\">Direccion</FormLabel>\n                      <FormControl>\n                        <Input {...field} disabled={showPayPal} className=\"h-9\" data-testid=\"input-address-mobile\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <FormField\n                    control={form.control}\n                    name=\"city\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-xs\">Ciudad</FormLabel>\n                        <FormControl>\n                          <Input {...field} disabled={showPayPal} className=\"h-9\" data-testid=\"input-city-mobile\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"postalCode\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-xs\">C.P.</FormLabel>\n                        <FormControl>\n                          <Input {...field} disabled={showPayPal} className=\"h-9\" data-testid=\"input-postalcode-mobile\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={form.control}\n                  name=\"country\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-xs\">Pais</FormLabel>\n                      <FormControl>\n                        <Input {...field} disabled={showPayPal} className=\"h-9\" data-testid=\"input-country-mobile\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {!showPayPal && (\n                  <Button type=\"submit\" className=\"w-full\" disabled={isProcessing} data-testid=\"button-continue-payment-mobile\">\n                    {isProcessing ? <Loader2 className=\"w-4 h-4 animate-spin mr-2\" /> : null}\n                    {isProcessing ? \"Guardando...\" : \"Continuar al pago\"}\n                  </Button>\n                )}\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n\n        {showPayPal && (\n          <Card>\n            <CardContent className=\"p-4\">\n              <p className=\"font-medium text-sm mb-3\">Pago con PayPal</p>\n              <MobilePayPalButton \n                totalCents={finalTotal}\n                currency={cart.currency || \"EUR\"}\n                discountCode={appliedDiscount?.code}\n                onSuccess={onSuccess}\n              />\n            </CardContent>\n          </Card>\n        )}\n\n        <Separator />\n\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between text-sm\">\n            <span>Subtotal</span>\n            <span>{formatPrice(totalCents, cart.currency || \"EUR\")}</span>\n          </div>\n          {appliedDiscount && (\n            <div className=\"flex justify-between text-sm text-green-600 dark:text-green-400\">\n              <span>Descuento</span>\n              <span>-{formatPrice(appliedDiscount.discountAmountCents, cart.currency || \"EUR\")}</span>\n            </div>\n          )}\n          <div className=\"flex justify-between font-bold text-lg pt-2\">\n            <span>Total</span>\n            <span data-testid=\"text-checkout-total-mobile\">{formatPrice(finalTotal, cart.currency || \"EUR\")}</span>\n          </div>\n        </div>\n\n        <p className=\"text-xs text-center text-muted-foreground pb-4\">\n          Al completar la compra, aceptas nuestros terminos y condiciones.\n        </p>\n      </div>\n    </div>\n  );\n}\n\nfunction CartTab({ onGoToExplore, onCheckout }: { onGoToExplore: () => void; onCheckout: (cart: MobileCartData) => void }) {\n  const { toast } = useToast();\n\n  const { data: user } = useQuery<{ id: string } | null>({\n    queryKey: [\"/api/auth/me\"],\n  });\n\n  const { data: cart, isLoading } = useQuery<CartWithItems>({\n    queryKey: [\"/api/cart\"],\n    enabled: !!user,\n  });\n\n  const removeItemMutation = useMutation({\n    mutationFn: (itemId: string) => apiRequest(\"DELETE\", `/api/cart/items/${itemId}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n      toast({ title: \"Eliminado del carrito\" });\n    },\n  });\n\n  if (!user) {\n    return (\n      <div className=\"flex-1 flex flex-col items-center justify-center gap-4 p-4\">\n        <ShoppingCart className=\"w-16 h-16 text-muted-foreground/30\" />\n        <p className=\"text-muted-foreground text-center\">Inicia sesiÃ³n para ver tu carrito</p>\n        <Link href=\"/login?from=mobile\">\n          <Button data-testid=\"button-login\">Iniciar sesiÃ³n</Button>\n        </Link>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 p-4 space-y-3\">\n        {[1, 2, 3].map(i => (\n          <Skeleton key={i} className=\"h-20 rounded-lg\" />\n        ))}\n      </div>\n    );\n  }\n\n  if (!cart?.items || cart.items.length === 0) {\n    return (\n      <div className=\"flex-1 flex flex-col items-center justify-center gap-4 p-4\">\n        <ShoppingCart className=\"w-16 h-16 text-muted-foreground/30\" />\n        <p className=\"text-muted-foreground\">Tu carrito estÃ¡ vacÃ­o</p>\n        <Button variant=\"outline\" onClick={onGoToExplore} data-testid=\"button-explore\">\n          Explorar audiolibros\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 flex flex-col overflow-hidden\">\n      <div className=\"flex-1 overflow-auto p-4\">\n        <div className=\"space-y-3\">\n          {cart.items.map((item) => (\n            <Card key={item.id} className=\"overflow-hidden\">\n              <div className=\"flex gap-3 p-3\">\n                <div className=\"w-14 h-14 rounded overflow-hidden shrink-0\">\n                  {item.audiobook.coverArtUrl ? (\n                    <img src={item.audiobook.coverArtUrl} alt={item.audiobook.title} className=\"w-full h-full object-cover\" />\n                  ) : (\n                    <div className=\"w-full h-full bg-gradient-to-br from-primary/40 to-primary/80 flex items-center justify-center\">\n                      <BookOpen className=\"w-5 h-5 text-primary-foreground/60\" />\n                    </div>\n                  )}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <h3 className=\"font-medium text-sm line-clamp-1\">{item.audiobook.title}</h3>\n                  <p className=\"text-xs text-muted-foreground\">{item.audiobook.author}</p>\n                  <p className=\"text-sm font-bold text-primary mt-1\">\n                    {formatPrice(item.audiobook.priceCents, item.audiobook.currency)}\n                  </p>\n                </div>\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  className=\"text-destructive shrink-0\"\n                  onClick={() => removeItemMutation.mutate(item.id)}\n                  data-testid={`button-remove-${item.id}`}\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </Card>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"p-4 border-t bg-muted/30 shrink-0\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-muted-foreground\">Total:</span>\n          <span className=\"text-xl font-bold\">{formatPrice(cart.total)}</span>\n        </div>\n        <Button \n          className=\"w-full\" \n          size=\"lg\" \n          onClick={() => onCheckout({\n            items: cart.items,\n            totalCents: cart.total * 100,\n            total: cart.total,\n            itemCount: cart.items.length,\n            currency: cart.items[0]?.audiobook.currency || \"EUR\"\n          })}\n          data-testid=\"button-checkout\"\n        >\n          Pagar ahora\n        </Button>\n      </div>\n    </div>\n  );\n}\n\ninterface AudiobookWithAccess extends Audiobook {\n  chapters: Chapter[];\n  hasAccess: boolean;\n  isPurchased: boolean;\n  isSubscriber: boolean;\n  isFree: boolean;\n}\n\nfunction AudiobookDetailView({ \n  audiobook, \n  onBack, \n  onAddToCart, \n  inCart, \n  purchased,\n  onPlayChapter\n}: {\n  audiobook: Audiobook;\n  onBack: () => void;\n  onAddToCart: () => void;\n  inCart: boolean;\n  purchased: boolean;\n  onPlayChapter: (chapter: Chapter) => void;\n}) {\n  const { toast } = useToast();\n  const [showAntennaPod, setShowAntennaPod] = useState(false);\n  \n  const { data: audiobookData, isLoading } = useQuery<AudiobookWithAccess>({\n    queryKey: [\"/api/audiobooks\", audiobook.id],\n  });\n\n  const chapters = audiobookData?.chapters || [];\n  const canPlay = audiobookData?.hasAccess || audiobookData?.isFree || purchased || audiobook.priceCents === 0;\n  const rssUrl = `${window.location.origin}/api/podcasts/${audiobook.id}/rss`;\n\n  const copyRssUrl = async () => {\n    try {\n      await navigator.clipboard.writeText(rssUrl);\n      toast({ title: \"Enlace RSS copiado\" });\n    } catch {\n      toast({ title: \"No se pudo copiar. Copia manualmente el enlace.\", variant: \"destructive\" });\n    }\n  };\n\n  const openAntennaPod = () => {\n    const encodedUrl = encodeURIComponent(rssUrl);\n    window.location.href = `antennapod://subscribe?url=${encodedUrl}`;\n  };\n\n  const openPlayStore = () => {\n    window.open(\"https://play.google.com/store/apps/details?id=de.danoeh.antennapod\", \"_blank\");\n  };\n\n  return (\n    <div className=\"flex-1 flex flex-col overflow-hidden\">\n      <div className=\"p-4 border-b shrink-0\">\n        <Button variant=\"ghost\" size=\"sm\" onClick={onBack} data-testid=\"button-back\">\n          <ChevronLeft className=\"w-4 h-4 mr-1\" />\n          Volver\n        </Button>\n      </div>\n      \n      <div className=\"flex-1 overflow-auto\">\n        <div className=\"p-4 space-y-4\">\n          <div className=\"flex gap-4\">\n            <div className=\"w-32 aspect-square rounded-lg overflow-hidden shadow-lg shrink-0\">\n              {audiobook.coverArtUrl ? (\n                <img src={audiobook.coverArtUrl} alt={audiobook.title} className=\"w-full h-full object-cover\" />\n              ) : (\n                <div className=\"w-full h-full bg-gradient-to-br from-primary/40 to-primary/80 flex items-center justify-center\">\n                  <BookOpen className=\"w-10 h-10 text-primary-foreground/60\" />\n                </div>\n              )}\n            </div>\n            \n            <div className=\"flex-1 min-w-0\">\n              <h1 className=\"font-serif text-xl font-bold line-clamp-2\">{audiobook.title}</h1>\n              <p className=\"text-muted-foreground\">{audiobook.author}</p>\n              {audiobook.category && (\n                <Badge variant=\"secondary\" className=\"mt-2\">{audiobook.category}</Badge>\n              )}\n              {purchased && (\n                <Badge className=\"mt-2 bg-green-600\">\n                  <Check className=\"w-3 h-3 mr-1\" />\n                  Comprado\n                </Badge>\n              )}\n            </div>\n          </div>\n\n          {audiobook.description && (\n            <p className=\"text-sm text-muted-foreground\">{audiobook.description}</p>\n          )}\n\n          {!canPlay && (\n            <Card className=\"bg-primary/5 border-primary/20\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center justify-between mb-3\">\n                  <span className=\"text-muted-foreground\">Precio:</span>\n                  <span className=\"text-2xl font-bold text-primary\">\n                    {formatPrice(audiobook.priceCents, audiobook.currency)}\n                  </span>\n                </div>\n                <Button \n                  className=\"w-full\" \n                  onClick={onAddToCart}\n                  disabled={inCart}\n                  data-testid=\"button-add-cart\"\n                >\n                  {inCart ? (\n                    <>\n                      <Check className=\"w-4 h-4 mr-2\" />\n                      En el carrito\n                    </>\n                  ) : (\n                    <>\n                      <ShoppingCart className=\"w-4 h-4 mr-2\" />\n                      AÃ±adir al carrito\n                    </>\n                  )}\n                </Button>\n              </CardContent>\n            </Card>\n          )}\n\n          <section>\n            <h2 className=\"font-semibold text-lg mb-3 flex items-center gap-2\">\n              <Headphones className=\"w-5 h-5 text-primary\" />\n              CapÃ­tulos ({chapters.length})\n            </h2>\n            \n            {isLoading ? (\n              <div className=\"space-y-2\">\n                {[1, 2, 3].map(i => (\n                  <Skeleton key={i} className=\"h-16 rounded-lg\" />\n                ))}\n              </div>\n            ) : chapters.length === 0 ? (\n              <p className=\"text-muted-foreground text-sm\">No hay capÃ­tulos disponibles</p>\n            ) : (\n              <div className=\"space-y-2\">\n                {chapters.map((chapter, index) => (\n                  <Card \n                    key={chapter.id} \n                    className={`overflow-hidden ${canPlay ? 'cursor-pointer hover-elevate' : 'opacity-60'}`}\n                    onClick={() => canPlay && onPlayChapter(chapter)}\n                  >\n                    <div className=\"flex items-center gap-3 p-3\">\n                      <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${canPlay ? 'bg-primary text-primary-foreground' : 'bg-muted'}`}>\n                        {canPlay ? <Play className=\"w-4 h-4 ml-0.5\" /> : <span className=\"text-sm\">{index + 1}</span>}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-medium text-sm line-clamp-1\">{chapter.title}</h3>\n                        {chapter.duration && (\n                          <p className=\"text-xs text-muted-foreground\">{formatDuration(chapter.duration)}</p>\n                        )}\n                      </div>\n                      {!canPlay && (\n                        <Badge variant=\"outline\" className=\"shrink-0\">\n                          Comprar\n                        </Badge>\n                      )}\n                    </div>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </section>\n\n          {canPlay && (\n            <section>\n              <button\n                className=\"w-full flex items-center justify-between p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors\"\n                onClick={() => setShowAntennaPod(!showAntennaPod)}\n                data-testid=\"button-toggle-antennapod\"\n              >\n                <div className=\"flex items-center gap-2\">\n                  <Rss className=\"w-5 h-5 text-primary\" />\n                  <span className=\"font-medium\">Escuchar en AntennaPod</span>\n                </div>\n                {showAntennaPod ? <ChevronUp className=\"w-4 h-4\" /> : <ChevronDown className=\"w-4 h-4\" />}\n              </button>\n\n              {showAntennaPod && (\n                <Card className=\"mt-3 border-primary/20\">\n                  <CardContent className=\"p-4 space-y-4\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      AntennaPod es una app gratuita para escuchar podcasts y audiolibros con funciones avanzadas como descarga offline y velocidad de reproducciÃ³n.\n                    </p>\n\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-start gap-3\">\n                        <div className=\"w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-bold shrink-0\">1</div>\n                        <div>\n                          <p className=\"font-medium text-sm\">Descargar AntennaPod</p>\n                          <p className=\"text-xs text-muted-foreground mb-2\">Instala la app desde Google Play Store</p>\n                          <Button size=\"sm\" variant=\"outline\" onClick={openPlayStore} data-testid=\"button-play-store\">\n                            <Download className=\"w-4 h-4 mr-1\" />\n                            Google Play\n                            <ExternalLink className=\"w-3 h-3 ml-1\" />\n                          </Button>\n                        </div>\n                      </div>\n\n                      <div className=\"flex items-start gap-3\">\n                        <div className=\"w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-bold shrink-0\">2</div>\n                        <div className=\"flex-1\">\n                          <p className=\"font-medium text-sm\">AÃ±adir el feed RSS</p>\n                          <p className=\"text-xs text-muted-foreground mb-2\">Copia este enlace y pÃ©galo en AntennaPod</p>\n                          <div className=\"flex gap-2\">\n                            <Button size=\"sm\" variant=\"outline\" onClick={copyRssUrl} className=\"flex-1\" data-testid=\"button-copy-rss\">\n                              <Copy className=\"w-4 h-4 mr-1\" />\n                              Copiar enlace\n                            </Button>\n                            <Button size=\"sm\" onClick={openAntennaPod} className=\"flex-1\" data-testid=\"button-open-antennapod\">\n                              <Rss className=\"w-4 h-4 mr-1\" />\n                              Abrir app\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n\n                      <div className=\"flex items-start gap-3\">\n                        <div className=\"w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-bold shrink-0\">3</div>\n                        <div>\n                          <p className=\"font-medium text-sm\">Sincronizar y escuchar</p>\n                          <p className=\"text-xs text-muted-foreground\">Los capÃ­tulos se descargarÃ¡n automÃ¡ticamente. Disfruta de la escucha offline.</p>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"pt-2 border-t\">\n                      <p className=\"text-xs text-muted-foreground text-center\">\n                        Enlace RSS: <span className=\"font-mono break-all\">{rssUrl}</span>\n                      </p>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </section>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\ninterface UserProfile {\n  id: string;\n  username: string;\n  email: string;\n  displayName?: string;\n  role: string;\n}\n\nfunction ProfileView({ onBack, onShowSubscriptions }: { onBack: () => void; onShowSubscriptions: () => void }) {\n  const { toast } = useToast();\n\n  const { data: user, isLoading } = useQuery<UserProfile>({\n    queryKey: [\"/api/auth/me\"],\n  });\n\n  const { data: subscription } = useQuery<UserSubscription & { plan: SubscriptionPlan }>({\n    queryKey: [\"/api/subscriptions/active\"],\n    enabled: !!user,\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: () => apiRequest(\"POST\", \"/api/auth/logout\"),\n    onSuccess: () => {\n      queryClient.clear();\n      queryClient.invalidateQueries();\n      toast({ title: \"SesiÃ³n cerrada\" });\n      onBack();\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"h-[100dvh] w-full bg-background flex flex-col overflow-hidden\">\n        <header className=\"flex items-center justify-between px-4 py-3 border-b border-primary/20 shrink-0\" style={{ backgroundColor: \"#7C3AED\" }}>\n          <img src={logoImage} alt=\"Audivia\" className=\"h-8 w-auto brightness-0 invert\" />\n          <Button variant=\"ghost\" size=\"sm\" className=\"text-white\" onClick={onBack}>\n            <X className=\"w-4 h-4 mr-1\" />\n            Cerrar\n          </Button>\n        </header>\n        <div className=\"flex-1 p-4 space-y-4\">\n          <Skeleton className=\"h-20 rounded-lg\" />\n          <Skeleton className=\"h-32 rounded-lg\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return (\n      <div className=\"h-[100dvh] w-full bg-background flex flex-col overflow-hidden\">\n        <header className=\"flex items-center justify-between px-4 py-3 border-b border-primary/20 shrink-0\" style={{ backgroundColor: \"#7C3AED\" }}>\n          <img src={logoImage} alt=\"Audivia\" className=\"h-8 w-auto brightness-0 invert\" />\n          <Button variant=\"ghost\" size=\"sm\" className=\"text-white\" onClick={onBack}>\n            <X className=\"w-4 h-4 mr-1\" />\n            Cerrar\n          </Button>\n        </header>\n        <div className=\"flex-1 flex flex-col items-center justify-center p-4 gap-4\">\n          <User className=\"w-16 h-16 text-muted-foreground/30\" />\n          <p className=\"text-muted-foreground\">No has iniciado sesiÃ³n</p>\n          <Link href=\"/login?from=mobile\">\n            <Button data-testid=\"button-login\">Iniciar sesiÃ³n</Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-[100dvh] w-full bg-background flex flex-col overflow-hidden\">\n      <header className=\"flex items-center justify-between px-4 py-3 border-b border-primary/20 shrink-0\" style={{ backgroundColor: \"#7C3AED\" }}>\n        <img src={logoImage} alt=\"Audivia\" className=\"h-8 w-auto brightness-0 invert\" data-testid=\"img-logo\" />\n        <Button variant=\"ghost\" size=\"sm\" className=\"text-white\" onClick={onBack} data-testid=\"button-back-profile\">\n          <X className=\"w-4 h-4 mr-1\" />\n          Cerrar\n        </Button>\n      </header>\n\n      <div className=\"flex-1 overflow-auto p-4 space-y-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center\">\n                <User className=\"w-8 h-8 text-primary\" />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <h2 className=\"font-semibold text-lg\">{user.displayName || user.username}</h2>\n                <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                  <Mail className=\"w-3 h-3\" />\n                  {user.email}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {subscription ? (\n          <Card className=\"border-accent bg-accent/10\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <Crown className=\"w-10 h-10 text-accent\" />\n                <div>\n                  <p className=\"font-semibold\">SuscripciÃ³n {subscription.plan?.name}</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    VÃ¡lida hasta {new Date(subscription.currentPeriodEnd).toLocaleDateString('es-ES')}\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <Card className=\"bg-gradient-to-br from-accent/20 to-primary/20 border-accent/30\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3 mb-3\">\n                <Crown className=\"w-10 h-10 text-accent\" />\n                <div>\n                  <p className=\"font-semibold\">Hazte Premium</p>\n                  <p className=\"text-sm text-muted-foreground\">Acceso ilimitado a todo el catÃ¡logo</p>\n                </div>\n              </div>\n              <Button className=\"w-full\" onClick={onShowSubscriptions} data-testid=\"button-show-subscriptions-profile\">\n                Ver planes de suscripciÃ³n\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card>\n          <CardContent className=\"p-4 space-y-3\">\n            <h3 className=\"font-semibold flex items-center gap-2\">\n              <Settings className=\"w-4 h-4\" />\n              Cuenta\n            </h3>\n            <Button\n              variant=\"destructive\"\n              className=\"w-full\"\n              onClick={() => logoutMutation.mutate()}\n              disabled={logoutMutation.isPending}\n              data-testid=\"button-logout\"\n            >\n              <LogOut className=\"w-4 h-4 mr-2\" />\n              {logoutMutation.isPending ? \"Cerrando sesiÃ³n...\" : \"Cerrar sesiÃ³n\"}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nfunction SubscriptionsView({ onBack }: { onBack: () => void }) {\n  const { toast } = useToast();\n  const [processingPlanId, setProcessingPlanId] = useState<string | null>(null);\n\n  const { data: plans = [], isLoading } = useQuery<SubscriptionPlan[]>({\n    queryKey: [\"/api/subscription-plans\"],\n  });\n\n  const { data: subscription } = useQuery<UserSubscription & { plan: SubscriptionPlan }>({\n    queryKey: [\"/api/subscriptions/active\"],\n  });\n\n  const subscribeMutation = useMutation({\n    mutationFn: async (planId: string) => {\n      const response = await apiRequest(\"POST\", \"/api/paypal/subscriptions\", { planId });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      if (data.approvalUrl) {\n        window.location.href = data.approvalUrl;\n      } else {\n        toast({ title: \"Error al procesar la suscripciÃ³n\", variant: \"destructive\" });\n      }\n      setProcessingPlanId(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: error.message || \"Error al crear la suscripciÃ³n\", variant: \"destructive\" });\n      setProcessingPlanId(null);\n    },\n  });\n\n  const handleSubscribe = (planId: string) => {\n    setProcessingPlanId(planId);\n    subscribeMutation.mutate(planId);\n  };\n\n  const activePlans = plans.filter(p => p.isActive);\n\n  return (\n    <div className=\"h-[100dvh] w-full bg-background flex flex-col overflow-hidden\">\n      <header className=\"flex items-center justify-between px-4 py-3 border-b border-primary/20 shrink-0\" style={{ backgroundColor: \"#7C3AED\" }}>\n        <img src={logoImage} alt=\"Audivia\" className=\"h-8 w-auto brightness-0 invert\" data-testid=\"img-logo\" />\n        <Button variant=\"ghost\" size=\"sm\" className=\"text-white\" onClick={onBack} data-testid=\"button-back-subscriptions\">\n          <X className=\"w-4 h-4 mr-1\" />\n          Cerrar\n        </Button>\n      </header>\n\n      <div className=\"flex-1 overflow-auto p-4\">\n        <div className=\"text-center mb-6\">\n          <Crown className=\"w-16 h-16 mx-auto text-accent mb-3\" />\n          <h1 className=\"font-serif text-2xl font-bold\">Planes Premium</h1>\n          <p className=\"text-muted-foreground mt-1\">Acceso ilimitado a todo el catÃ¡logo</p>\n        </div>\n\n        {subscription && (\n          <Card className=\"border-accent bg-accent/10 mb-6\">\n            <CardContent className=\"p-4 text-center\">\n              <Check className=\"w-8 h-8 mx-auto text-green-600 mb-2\" />\n              <p className=\"font-semibold\">Ya tienes una suscripciÃ³n activa</p>\n              <p className=\"text-sm text-muted-foreground\">Plan: {subscription.plan?.name}</p>\n            </CardContent>\n          </Card>\n        )}\n\n        {isLoading ? (\n          <div className=\"space-y-4\">\n            {[1, 2].map(i => (\n              <Skeleton key={i} className=\"h-40 rounded-lg\" />\n            ))}\n          </div>\n        ) : activePlans.length === 0 ? (\n          <div className=\"text-center py-8\">\n            <p className=\"text-muted-foreground\">No hay planes disponibles en este momento</p>\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            {activePlans.map((plan) => (\n              <Card key={plan.id} className=\"overflow-hidden\">\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-start justify-between mb-3\">\n                    <div>\n                      <h3 className=\"font-semibold text-lg\">{plan.name}</h3>\n                      {plan.description && (\n                        <p className=\"text-sm text-muted-foreground\">{plan.description}</p>\n                      )}\n                    </div>\n                    <div className=\"text-right\">\n                      <span className=\"text-2xl font-bold text-primary\">\n                        {formatPrice(plan.priceCents, plan.currency)}\n                      </span>\n                      <p className=\"text-xs text-muted-foreground\">\n                        /{plan.intervalMonths === 1 ? \"mes\" : `${plan.intervalMonths} meses`}\n                      </p>\n                    </div>\n                  </div>\n                  \n                  {plan.trialDays > 0 && (\n                    <Badge className=\"mb-3 bg-accent text-accent-foreground\">\n                      {plan.trialDays} dÃ­as de prueba gratis\n                    </Badge>\n                  )}\n\n                  <ul className=\"text-sm space-y-2 mb-4\">\n                    <li className=\"flex items-center gap-2\">\n                      <Check className=\"w-4 h-4 text-green-600\" />\n                      Acceso ilimitado a audiolibros\n                    </li>\n                    <li className=\"flex items-center gap-2\">\n                      <Check className=\"w-4 h-4 text-green-600\" />\n                      Escucha sin conexiÃ³n\n                    </li>\n                    <li className=\"flex items-center gap-2\">\n                      <Check className=\"w-4 h-4 text-green-600\" />\n                      Nuevos tÃ­tulos cada semana\n                    </li>\n                  </ul>\n\n                  <Button\n                    className=\"w-full\"\n                    onClick={() => handleSubscribe(plan.id)}\n                    disabled={!!subscription || processingPlanId === plan.id || !plan.paypalPlanId}\n                    data-testid={`button-subscribe-${plan.id}`}\n                  >\n                    {processingPlanId === plan.id ? (\n                      \"Procesando...\"\n                    ) : subscription ? (\n                      \"Ya suscrito\"\n                    ) : !plan.paypalPlanId ? (\n                      \"No disponible\"\n                    ) : (\n                      \"Suscribirse con PayPal\"\n                    )}\n                  </Button>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n\n        <div className=\"mt-6 text-center text-xs text-muted-foreground\">\n          <p>Al suscribirte aceptas nuestros tÃ©rminos de servicio.</p>\n          <p>Puedes cancelar en cualquier momento.</p>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function MobilePage() {\n  const [activeTab, setActiveTab] = useState<TabType>(\"home\");\n  const [selectedAudiobook, setSelectedAudiobook] = useState<Audiobook | null>(null);\n  const [playingChapter, setPlayingChapter] = useState<{ chapter: Chapter; audiobook: Audiobook } | null>(null);\n  const [showSubscriptions, setShowSubscriptions] = useState(false);\n  const [showProfile, setShowProfile] = useState(false);\n  const [checkoutCart, setCheckoutCart] = useState<MobileCartData | null>(null);\n  const { toast } = useToast();\n\n  const { data: user } = useQuery<{ id: string } | null>({\n    queryKey: [\"/api/auth/me\"],\n  });\n\n  const { data: cart } = useQuery<CartWithItems>({\n    queryKey: [\"/api/cart\"],\n    enabled: !!user,\n  });\n\n  const { data: audiobooks = [], isLoading: loadingAudiobooks } = useQuery<Audiobook[]>({\n    queryKey: [\"/api/audiobooks\"],\n  });\n\n  const { data: purchases = [] } = useQuery<{ audiobookId: string }[]>({\n    queryKey: [\"/api/library/purchases\"],\n    enabled: !!user,\n  });\n\n  const { data: selectedAudiobookData } = useQuery<AudiobookWithAccess>({\n    queryKey: [\"/api/audiobooks\", selectedAudiobook?.id],\n    enabled: !!selectedAudiobook,\n  });\n\n  const chapters = selectedAudiobookData?.chapters || [];\n\n  const cartItems = cart?.items.map(i => i.audiobook.id) || [];\n  const cartCount = cart?.items.length || 0;\n  const purchasedIds = purchases?.map(p => p.audiobookId) || [];\n\n  const addToCartMutation = useMutation({\n    mutationFn: (audiobookId: string) => apiRequest(\"POST\", \"/api/cart/items\", { audiobookId, quantity: 1 }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n      toast({ title: \"AÃ±adido al carrito\" });\n    },\n    onError: () => {\n      toast({ title: \"Inicia sesiÃ³n para aÃ±adir al carrito\", variant: \"destructive\" });\n    },\n  });\n\n  const handleAddToCart = (audiobookId: string) => {\n    if (!user) {\n      toast({ title: \"Inicia sesiÃ³n para aÃ±adir al carrito\", variant: \"destructive\" });\n      return;\n    }\n    if (cartItems.includes(audiobookId)) {\n      toast({ title: \"Ya estÃ¡ en el carrito\" });\n      return;\n    }\n    addToCartMutation.mutate(audiobookId);\n  };\n\n  const handlePlayChapter = (chapter: Chapter) => {\n    if (selectedAudiobook) {\n      setPlayingChapter({ chapter, audiobook: selectedAudiobook });\n    }\n  };\n\n  const currentChapterIndex = chapters.findIndex(c => c.id === playingChapter?.chapter.id);\n  const hasNextChapter = currentChapterIndex >= 0 && currentChapterIndex < chapters.length - 1;\n  const hasPrevChapter = currentChapterIndex > 0;\n\n  const playNextChapter = () => {\n    if (hasNextChapter && selectedAudiobook) {\n      setPlayingChapter({ chapter: chapters[currentChapterIndex + 1], audiobook: selectedAudiobook });\n    }\n  };\n\n  const playPrevChapter = () => {\n    if (hasPrevChapter && selectedAudiobook) {\n      setPlayingChapter({ chapter: chapters[currentChapterIndex - 1], audiobook: selectedAudiobook });\n    }\n  };\n\n  const handleCheckoutSuccess = () => {\n    queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n    queryClient.invalidateQueries({ queryKey: [\"/api/library/purchases\"] });\n    setCheckoutCart(null);\n    setActiveTab(\"library\");\n    toast({\n      title: \"Compra completada\",\n      description: \"Tus audiolibros estÃ¡n listos para escuchar\",\n    });\n  };\n\n  if (checkoutCart) {\n    return (\n      <MobileCheckoutView \n        cart={checkoutCart}\n        onBack={() => setCheckoutCart(null)}\n        onSuccess={handleCheckoutSuccess}\n      />\n    );\n  }\n\n  if (showProfile) {\n    return (\n      <ProfileView \n        onBack={() => setShowProfile(false)} \n        onShowSubscriptions={() => {\n          setShowProfile(false);\n          setShowSubscriptions(true);\n        }}\n      />\n    );\n  }\n\n  if (showSubscriptions) {\n    return <SubscriptionsView onBack={() => setShowSubscriptions(false)} />;\n  }\n\n  if (playingChapter) {\n    return (\n      <AudioPlayer\n        chapter={playingChapter.chapter}\n        audiobook={playingChapter.audiobook}\n        onClose={() => setPlayingChapter(null)}\n        onNext={playNextChapter}\n        onPrev={playPrevChapter}\n        hasNext={hasNextChapter}\n        hasPrev={hasPrevChapter}\n      />\n    );\n  }\n\n  if (selectedAudiobook) {\n    return (\n      <div className=\"h-[100dvh] w-full bg-background flex flex-col overflow-hidden\">\n        <header className=\"flex items-center justify-between px-4 py-3 border-b border-primary/20 shrink-0\" style={{ backgroundColor: \"#7C3AED\" }}>\n          <img src={logoImage} alt=\"Audivia\" className=\"h-8 w-auto brightness-0 invert\" data-testid=\"img-logo\" />\n          <div className=\"flex items-center gap-2\">\n            {user ? (\n              <Button size=\"icon\" variant=\"ghost\" className=\"text-white hover:bg-white/10\" onClick={() => setShowProfile(true)} data-testid=\"button-profile\">\n                <User className=\"w-5 h-5\" />\n              </Button>\n            ) : (\n              <Link href=\"/login?from=mobile\">\n                <Button size=\"sm\" variant=\"outline\" className=\"text-white border-white/50 hover:bg-white/10\" data-testid=\"button-login\">\n                  Entrar\n                </Button>\n              </Link>\n            )}\n          </div>\n        </header>\n        <AudiobookDetailView\n          audiobook={selectedAudiobook}\n          onBack={() => setSelectedAudiobook(null)}\n          onAddToCart={() => handleAddToCart(selectedAudiobook.id)}\n          inCart={cartItems.includes(selectedAudiobook.id)}\n          purchased={purchasedIds.includes(selectedAudiobook.id)}\n          onPlayChapter={handlePlayChapter}\n        />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-[100dvh] w-full bg-background flex flex-col overflow-hidden\">\n      <header className=\"flex items-center justify-between px-4 py-3 border-b border-primary/20 shrink-0\" style={{ backgroundColor: \"#7C3AED\" }}>\n        <img src={logoImage} alt=\"Audivia\" className=\"h-8 w-auto brightness-0 invert\" data-testid=\"img-logo\" />\n        <div className=\"flex items-center gap-2\">\n          {user ? (\n            <Button size=\"icon\" variant=\"ghost\" className=\"text-white hover:bg-white/10\" onClick={() => setShowProfile(true)} data-testid=\"button-profile\">\n              <User className=\"w-5 h-5\" />\n            </Button>\n          ) : (\n            <Link href=\"/login?from=mobile\">\n              <Button size=\"sm\" variant=\"outline\" className=\"text-white border-white/50 hover:bg-white/10\" data-testid=\"button-login\">\n                Entrar\n              </Button>\n            </Link>\n          )}\n        </div>\n      </header>\n\n      {activeTab === \"home\" && (\n        <HomeTab \n          audiobooks={audiobooks}\n          isLoading={loadingAudiobooks}\n          onViewAudiobook={setSelectedAudiobook}\n          cartItems={cartItems}\n          purchasedIds={purchasedIds}\n          onAddToCart={handleAddToCart}\n          onShowSubscriptions={() => setShowSubscriptions(true)}\n        />\n      )}\n      {activeTab === \"explore\" && (\n        <ExploreTab \n          audiobooks={audiobooks}\n          isLoading={loadingAudiobooks}\n          cartItems={cartItems}\n          purchasedIds={purchasedIds}\n          onAddToCart={handleAddToCart}\n          onViewAudiobook={setSelectedAudiobook}\n        />\n      )}\n      {activeTab === \"library\" && (\n        <LibraryTab onViewAudiobook={setSelectedAudiobook} />\n      )}\n      {activeTab === \"cart\" && (\n        <CartTab \n          onGoToExplore={() => setActiveTab(\"explore\")} \n          onCheckout={(cart) => setCheckoutCart(cart)}\n        />\n      )}\n\n      <nav className=\"grid grid-cols-4 border-t bg-background shrink-0\" data-testid=\"nav-tabs\">\n        <button\n          className={`flex flex-col items-center justify-center py-3 gap-1 ${activeTab === \"home\" ? \"text-primary\" : \"text-muted-foreground\"}`}\n          onClick={() => setActiveTab(\"home\")}\n          data-testid=\"tab-home\"\n        >\n          <Home className=\"w-5 h-5\" />\n          <span className=\"text-xs\">Inicio</span>\n        </button>\n        <button\n          className={`flex flex-col items-center justify-center py-3 gap-1 ${activeTab === \"explore\" ? \"text-primary\" : \"text-muted-foreground\"}`}\n          onClick={() => setActiveTab(\"explore\")}\n          data-testid=\"tab-explore\"\n        >\n          <Search className=\"w-5 h-5\" />\n          <span className=\"text-xs\">Explorar</span>\n        </button>\n        <button\n          className={`flex flex-col items-center justify-center py-3 gap-1 ${activeTab === \"library\" ? \"text-primary\" : \"text-muted-foreground\"}`}\n          onClick={() => setActiveTab(\"library\")}\n          data-testid=\"tab-library\"\n        >\n          <Library className=\"w-5 h-5\" />\n          <span className=\"text-xs\">Biblioteca</span>\n        </button>\n        <button\n          className={`flex flex-col items-center justify-center py-3 gap-1 relative ${activeTab === \"cart\" ? \"text-primary\" : \"text-muted-foreground\"}`}\n          onClick={() => setActiveTab(\"cart\")}\n          data-testid=\"tab-cart\"\n        >\n          <ShoppingCart className=\"w-5 h-5\" />\n          <span className=\"text-xs\">Carrito</span>\n          {cartCount > 0 && (\n            <span className=\"absolute top-1 right-1/4 w-4 h-4 bg-primary text-primary-foreground text-[10px] rounded-full flex items-center justify-center\">\n              {cartCount > 9 ? \"9+\" : cartCount}\n            </span>\n          )}\n        </button>\n      </nav>\n    </div>\n  );\n}\n","path":null,"size_bytes":78642,"size_tokens":null},"client/src/pages/checkout.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link, useLocation } from \"wouter\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ShoppingCart, ChevronLeft, BookOpen, Check, CreditCard, Tag, X, Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Audiobook, BillingProfile } from \"@shared/schema\";\n\ninterface CartItemWithAudiobook {\n  id: string;\n  userId: string;\n  audiobookId: string;\n  createdAt: Date;\n  audiobook: Audiobook;\n}\n\ninterface CartData {\n  items: CartItemWithAudiobook[];\n  totalCents: number;\n  itemCount: number;\n  currency: string;\n}\n\nconst billingFormSchema = z.object({\n  fullName: z.string().min(2, \"Nombre completo es requerido\"),\n  email: z.string().email(\"Email invalido\"),\n  taxId: z.string().optional(),\n  address: z.string().min(5, \"Direccion es requerida\"),\n  city: z.string().min(2, \"Ciudad es requerida\"),\n  postalCode: z.string().min(3, \"Codigo postal es requerido\"),\n  country: z.string().min(2, \"Pais es requerido\"),\n});\n\ntype BillingFormData = z.infer<typeof billingFormSchema>;\n\nfunction formatPrice(cents: number, currency: string = \"EUR\"): string {\n  return new Intl.NumberFormat(\"es-ES\", {\n    style: \"currency\",\n    currency: currency,\n  }).format(cents / 100);\n}\n\ninterface AppliedDiscount {\n  id: string;\n  code: string;\n  type: \"PERCENTAGE\" | \"FIXED_AMOUNT\";\n  value: number;\n  discountAmountCents: number;\n  finalAmountCents: number;\n}\n\nexport default function CheckoutPage() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [showPayPal, setShowPayPal] = useState(false);\n  const [discountCode, setDiscountCode] = useState(\"\");\n  const [appliedDiscount, setAppliedDiscount] = useState<AppliedDiscount | null>(null);\n  const [isValidatingCode, setIsValidatingCode] = useState(false);\n\n  const { data: cart, isLoading: cartLoading } = useQuery<CartData>({\n    queryKey: [\"/api/cart\"],\n  });\n\n  const { data: billingProfile } = useQuery<BillingProfile>({\n    queryKey: [\"/api/billing-profile\"],\n  });\n\n  const { data: user } = useQuery<{ id: string; email: string; displayName?: string }>({\n    queryKey: [\"/api/user\"],\n  });\n\n  const form = useForm<BillingFormData>({\n    resolver: zodResolver(billingFormSchema),\n    defaultValues: {\n      fullName: \"\",\n      email: \"\",\n      taxId: \"\",\n      address: \"\",\n      city: \"\",\n      postalCode: \"\",\n      country: \"Espana\",\n    },\n  });\n\n  const isProfileComplete = useMemo(() => {\n    if (!billingProfile) return false;\n    return !!(\n      billingProfile.fullName &&\n      billingProfile.email &&\n      billingProfile.address &&\n      billingProfile.city &&\n      billingProfile.postalCode &&\n      billingProfile.country\n    );\n  }, [billingProfile]);\n\n  useEffect(() => {\n    if (billingProfile || user) {\n      form.reset({\n        fullName: billingProfile?.fullName || user?.displayName || \"\",\n        email: billingProfile?.email || user?.email || \"\",\n        taxId: billingProfile?.taxId || \"\",\n        address: billingProfile?.address || \"\",\n        city: billingProfile?.city || \"\",\n        postalCode: billingProfile?.postalCode || \"\",\n        country: billingProfile?.country || \"Espana\",\n      });\n    }\n  }, [billingProfile, user, form]);\n\n  useEffect(() => {\n    if (isProfileComplete) {\n      setShowPayPal(true);\n    }\n  }, [isProfileComplete]);\n\n  const onSubmit = async (data: BillingFormData) => {\n    setIsProcessing(true);\n    try {\n      await apiRequest(\"POST\", \"/api/billing-profile\", data);\n      queryClient.invalidateQueries({ queryKey: [\"/api/billing-profile\"] });\n      setShowPayPal(true);\n      toast({\n        title: \"Datos guardados\",\n        description: \"Tus datos de facturacion se han guardado correctamente\",\n      });\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudieron guardar los datos de facturacion\",\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const handlePayPalSuccess = async () => {\n    queryClient.invalidateQueries({ queryKey: [\"/api/cart\"] });\n    queryClient.invalidateQueries({ queryKey: [\"/api/user/purchases\"] });\n    queryClient.invalidateQueries({ queryKey: [\"/api/library/purchases\"] });\n    \n    toast({\n      title: \"Compra completada\",\n      description: \"Tus audiolibros estan listos para escuchar\",\n    });\n    \n    setLocation(\"/library\");\n  };\n\n  const validateDiscountCode = async () => {\n    if (!discountCode.trim()) return;\n    \n    setIsValidatingCode(true);\n    try {\n      const response = await apiRequest(\"POST\", \"/api/discount-codes/validate\", {\n        code: discountCode.trim().toUpperCase(),\n        totalCents: cart?.totalCents || 0,\n        forSubscription: false,\n      });\n      \n      const data = await response.json();\n      \n      if (data.valid) {\n        setAppliedDiscount({\n          id: data.discountCode.id,\n          code: data.discountCode.code,\n          type: data.discountCode.type,\n          value: data.discountCode.value,\n          discountAmountCents: data.discountAmountCents,\n          finalAmountCents: data.finalAmountCents,\n        });\n        toast({\n          title: \"Codigo aplicado\",\n          description: `Descuento de ${formatPrice(data.discountAmountCents, cart?.currency || \"EUR\")} aplicado`,\n        });\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Codigo invalido\",\n          description: data.error || \"El codigo de descuento no es valido\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: \"No se pudo validar el codigo\",\n      });\n    } finally {\n      setIsValidatingCode(false);\n    }\n  };\n\n  const removeDiscount = () => {\n    setAppliedDiscount(null);\n    setDiscountCode(\"\");\n  };\n\n  const finalTotal = appliedDiscount ? appliedDiscount.finalAmountCents : (cart?.totalCents || 0);\n\n  if (cartLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Skeleton className=\"h-10 w-48 mb-6\" />\n        <div className=\"grid gap-6 lg:grid-cols-2\">\n          <Card>\n            <CardContent className=\"p-6 space-y-4\">\n              <Skeleton className=\"h-10 w-full\" />\n              <Skeleton className=\"h-10 w-full\" />\n              <Skeleton className=\"h-10 w-full\" />\n              <Skeleton className=\"h-10 w-full\" />\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-6 space-y-4\">\n              <Skeleton className=\"h-6 w-full\" />\n              <Skeleton className=\"h-24 w-full\" />\n              <Skeleton className=\"h-12 w-full\" />\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  const isEmpty = !cart || cart.items.length === 0;\n\n  if (isEmpty) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card className=\"text-center py-16\">\n          <CardContent>\n            <ShoppingCart className=\"w-16 h-16 mx-auto text-muted-foreground/50 mb-4\" />\n            <h2 className=\"text-xl font-semibold mb-2\">Tu carrito esta vacio</h2>\n            <p className=\"text-muted-foreground mb-6\">\n              No tienes audiolibros para comprar\n            </p>\n            <Link href=\"/\">\n              <Button data-testid=\"button-explore\">\n                Explorar audiolibros\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <Link href=\"/cart\">\n        <Button variant=\"ghost\" size=\"sm\" className=\"mb-6\">\n          <ChevronLeft className=\"w-4 h-4 mr-1\" />\n          Volver al carrito\n        </Button>\n      </Link>\n\n      <h1 className=\"font-serif text-3xl md:text-4xl font-bold mb-8 flex items-center gap-3\">\n        <CreditCard className=\"w-8 h-8\" />\n        Finalizar compra\n      </h1>\n\n      <div className=\"grid gap-6 lg:grid-cols-2\">\n        <div className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"font-serif flex items-center gap-2\">\n                {showPayPal && <Check className=\"w-5 h-5 text-green-500\" />}\n                Datos de facturacion\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"fullName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Nombre completo</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Tu nombre completo\" \n                            {...field} \n                            disabled={showPayPal}\n                            data-testid=\"input-fullname\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email</FormLabel>\n                        <FormControl>\n                          <Input \n                            type=\"email\" \n                            placeholder=\"tu@email.com\" \n                            {...field} \n                            disabled={showPayPal}\n                            data-testid=\"input-email\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"taxId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>NIF/CIF (opcional)</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Tu NIF o CIF\" \n                            {...field} \n                            disabled={showPayPal}\n                            data-testid=\"input-taxid\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"address\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Direccion</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Tu direccion\" \n                            {...field} \n                            disabled={showPayPal}\n                            data-testid=\"input-address\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"city\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Ciudad</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"Ciudad\" \n                              {...field} \n                              disabled={showPayPal}\n                              data-testid=\"input-city\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"postalCode\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Codigo postal</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"Codigo postal\" \n                              {...field} \n                              disabled={showPayPal}\n                              data-testid=\"input-postalcode\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  <FormField\n                    control={form.control}\n                    name=\"country\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Pais</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Pais\" \n                            {...field} \n                            disabled={showPayPal}\n                            data-testid=\"input-country\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  {!showPayPal ? (\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full\" \n                      disabled={isProcessing}\n                      data-testid=\"button-continue-payment\"\n                    >\n                      {isProcessing ? \"Guardando...\" : \"Continuar al pago\"}\n                    </Button>\n                  ) : (\n                    <div className=\"flex gap-2\">\n                      <Button \n                        type=\"button\"\n                        variant=\"outline\"\n                        className=\"flex-1\"\n                        onClick={() => setShowPayPal(false)}\n                        data-testid=\"button-edit-billing\"\n                      >\n                        Editar datos\n                      </Button>\n                      <Button \n                        type=\"submit\" \n                        className=\"flex-1\" \n                        disabled={isProcessing}\n                        data-testid=\"button-update-billing\"\n                      >\n                        {isProcessing ? \"Guardando...\" : \"Actualizar\"}\n                      </Button>\n                    </div>\n                  )}\n                </form>\n              </Form>\n            </CardContent>\n          </Card>\n\n          {showPayPal && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"font-serif\">Pago con PayPal</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <CartPayPalButton \n                  totalCents={finalTotal}\n                  currency={cart.currency}\n                  itemCount={cart.itemCount}\n                  discountCode={appliedDiscount?.code}\n                  onSuccess={handlePayPalSuccess}\n                />\n              </CardContent>\n            </Card>\n          )}\n        </div>\n\n        <div>\n          <Card className=\"sticky top-8\">\n            <CardHeader>\n              <CardTitle className=\"font-serif\">Resumen del pedido</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-3\">\n                {cart.items.map((item) => (\n                  <div key={item.id} className=\"flex items-center gap-3\">\n                    <div className=\"w-12 h-12 rounded-lg overflow-hidden flex-shrink-0\">\n                      {item.audiobook.coverArtUrl ? (\n                        <img\n                          src={item.audiobook.coverArtUrl}\n                          alt={item.audiobook.title}\n                          className=\"w-full h-full object-cover\"\n                        />\n                      ) : (\n                        <div className=\"w-full h-full bg-gradient-to-br from-primary/30 to-primary/60 flex items-center justify-center\">\n                          <BookOpen className=\"w-5 h-5 text-primary-foreground/60\" />\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-medium text-sm truncate\">{item.audiobook.title}</p>\n                      <p className=\"text-xs text-muted-foreground truncate\">{item.audiobook.author}</p>\n                    </div>\n                    <span className=\"text-sm font-medium\">\n                      {formatPrice(item.audiobook.priceCents, item.audiobook.currency)}\n                    </span>\n                  </div>\n                ))}\n              </div>\n              \n              <Separator />\n\n              <div className=\"space-y-3\">\n                <p className=\"text-sm font-medium flex items-center gap-2\">\n                  <Tag className=\"w-4 h-4\" />\n                  Codigo de descuento\n                </p>\n                {appliedDiscount ? (\n                  <div className=\"flex items-center justify-between bg-green-500/10 p-3 rounded-lg border border-green-500/20\">\n                    <div>\n                      <span className=\"font-mono font-bold text-green-600 dark:text-green-400\">\n                        {appliedDiscount.code}\n                      </span>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        {appliedDiscount.type === \"PERCENTAGE\" \n                          ? `${appliedDiscount.value}% de descuento`\n                          : `${formatPrice(appliedDiscount.value * 100, cart.currency)} de descuento`\n                        }\n                      </p>\n                    </div>\n                    <Button size=\"icon\" variant=\"ghost\" onClick={removeDiscount} data-testid=\"button-remove-discount\">\n                      <X className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                ) : (\n                  <div className=\"flex gap-2\">\n                    <Input\n                      placeholder=\"Introduce tu codigo\"\n                      value={discountCode}\n                      onChange={(e) => setDiscountCode(e.target.value.toUpperCase())}\n                      onKeyDown={(e) => e.key === \"Enter\" && (e.preventDefault(), validateDiscountCode())}\n                      className=\"flex-1 font-mono\"\n                      data-testid=\"input-discount-code\"\n                    />\n                    <Button \n                      variant=\"outline\" \n                      onClick={validateDiscountCode}\n                      disabled={isValidatingCode || !discountCode.trim()}\n                      data-testid=\"button-apply-discount\"\n                    >\n                      {isValidatingCode ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : \"Aplicar\"}\n                    </Button>\n                  </div>\n                )}\n              </div>\n              \n              <Separator />\n              \n              <div className=\"space-y-2\">\n                <div className=\"flex justify-between text-sm\">\n                  <span>Subtotal ({cart.itemCount} audiolibros)</span>\n                  <span>{formatPrice(cart.totalCents, cart.currency)}</span>\n                </div>\n                {appliedDiscount && (\n                  <div className=\"flex justify-between text-sm text-green-600 dark:text-green-400\">\n                    <span>Descuento ({appliedDiscount.code})</span>\n                    <span>-{formatPrice(appliedDiscount.discountAmountCents, cart.currency)}</span>\n                  </div>\n                )}\n                <div className=\"flex justify-between text-sm text-muted-foreground\">\n                  <span>IVA incluido</span>\n                  <span>-</span>\n                </div>\n              </div>\n              \n              <Separator />\n              \n              <div className=\"flex justify-between font-bold text-lg\">\n                <span>Total</span>\n                <span data-testid=\"text-checkout-total\">{formatPrice(finalTotal, cart.currency)}</span>\n              </div>\n\n              <p className=\"text-xs text-center text-muted-foreground pt-4\">\n                Al completar la compra, aceptas nuestros terminos y condiciones.\n                Tendras acceso permanente a tus audiolibros.\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction CartPayPalButton({ \n  totalCents, \n  currency, \n  itemCount,\n  discountCode,\n  onSuccess \n}: { \n  totalCents: number; \n  currency: string;\n  itemCount: number;\n  discountCode?: string;\n  onSuccess: () => void;\n}) {\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const { data: paypalConfig } = useQuery<{ clientId: string }>({\n    queryKey: [\"/api/paypal/client-id\"],\n  });\n\n  const loadPayPalScript = () => {\n    if (!paypalConfig?.clientId) return;\n    \n    const existingScript = document.querySelector('script[src*=\"paypal.com/sdk\"]');\n    if (existingScript) {\n      existingScript.remove();\n    }\n\n    const script = document.createElement(\"script\");\n    script.src = `https://www.paypal.com/sdk/js?client-id=${paypalConfig.clientId}&currency=${currency}`;\n    script.async = true;\n    script.onload = () => {\n      setIsLoading(false);\n      renderPayPalButton();\n    };\n    script.onerror = () => {\n      setError(\"Error al cargar PayPal\");\n      setIsLoading(false);\n    };\n    document.body.appendChild(script);\n  };\n\n  const renderPayPalButton = () => {\n    const container = document.getElementById(\"paypal-cart-button-container\");\n    if (!container || !(window as any).paypal) return;\n    \n    container.innerHTML = \"\";\n\n    (window as any).paypal.Buttons({\n      style: {\n        layout: \"vertical\",\n        color: \"gold\",\n        shape: \"rect\",\n        label: \"pay\",\n      },\n      createOrder: async () => {\n        try {\n          const response = await fetch(\"/api/paypal/create-cart-order\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify({ discountCode }),\n          });\n          \n          if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(errorData.error || \"Error creating order\");\n          }\n          \n          const data = await response.json();\n          return data.orderId;\n        } catch (err: any) {\n          toast({\n            variant: \"destructive\",\n            title: \"Error\",\n            description: err.message || \"No se pudo crear la orden\",\n          });\n          throw err;\n        }\n      },\n      onApprove: async (data: { orderID: string }) => {\n        try {\n          const response = await fetch(\"/api/paypal/capture-cart-order\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify({ orderId: data.orderID }),\n          });\n          \n          if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(errorData.error || \"Error capturing order\");\n          }\n          \n          onSuccess();\n        } catch (err: any) {\n          toast({\n            variant: \"destructive\",\n            title: \"Error\",\n            description: err.message || \"No se pudo completar el pago\",\n          });\n        }\n      },\n      onError: (err: any) => {\n        console.error(\"PayPal error:\", err);\n        toast({\n          variant: \"destructive\",\n          title: \"Error de PayPal\",\n          description: \"Hubo un problema con el pago\",\n        });\n      },\n    }).render(\"#paypal-cart-button-container\");\n  };\n\n  if (!paypalConfig?.clientId) {\n    loadPayPalScript();\n  } else if (isLoading) {\n    loadPayPalScript();\n  }\n\n  if (error) {\n    return (\n      <div className=\"text-center py-4\">\n        <p className=\"text-destructive\">{error}</p>\n        <Button \n          variant=\"outline\" \n          className=\"mt-2\" \n          onClick={() => {\n            setError(null);\n            setIsLoading(true);\n            loadPayPalScript();\n          }}\n        >\n          Reintentar\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {isLoading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n        </div>\n      )}\n      <div id=\"paypal-cart-button-container\" data-testid=\"paypal-cart-button\"></div>\n      <p className=\"text-xs text-center text-muted-foreground\">\n        Pago seguro procesado por PayPal\n      </p>\n    </div>\n  );\n}\n","path":null,"size_bytes":25743,"size_tokens":null},"server/email-templates.ts":{"content":"const BRAND_COLOR = \"#7C3AED\";\nconst BRAND_COLOR_LIGHT = \"#A78BFA\";\nconst BRAND_GOLD = \"#EAB308\";\nconst BRAND_NAME = \"Audivia\";\n\nexport function getEmailTemplate(content: string, showFooterLinks: boolean = true, logoBase64?: string): string {\n  const logoSrc = logoBase64 ? `data:image/png;base64,${logoBase64}` : \"cid:audivia-logo\";\n  \n  return `\n<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${BRAND_NAME}</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #1a1a2e; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n  <table role=\"presentation\" style=\"width: 100%; border-collapse: collapse;\">\n    <tr>\n      <td style=\"padding: 40px 20px;\">\n        <table role=\"presentation\" style=\"max-width: 600px; margin: 0 auto; background-color: #16162a; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 24px rgba(124, 58, 237, 0.15);\">\n          <!-- Header with Logo -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg, ${BRAND_COLOR} 0%, #5B21B6 100%); padding: 30px 40px; text-align: center;\">\n              <img src=\"${logoSrc}\" alt=\"${BRAND_NAME}\" style=\"max-width: 180px; height: auto;\" />\n            </td>\n          </tr>\n          \n          <!-- Content -->\n          <tr>\n            <td style=\"padding: 40px; color: #e5e5e5;\">\n              ${content}\n            </td>\n          </tr>\n          \n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #0f0f1a; padding: 30px 40px; text-align: center; border-top: 1px solid #2a2a4a;\">\n              ${showFooterLinks ? `\n              <p style=\"margin: 0 0 15px 0;\">\n                <a href=\"/explore\" style=\"color: ${BRAND_COLOR_LIGHT}; text-decoration: none; margin: 0 10px;\">Explorar</a>\n                <span style=\"color: #4a4a6a;\">|</span>\n                <a href=\"/library\" style=\"color: ${BRAND_COLOR_LIGHT}; text-decoration: none; margin: 0 10px;\">Mi Biblioteca</a>\n                <span style=\"color: #4a4a6a;\">|</span>\n                <a href=\"/account\" style=\"color: ${BRAND_COLOR_LIGHT}; text-decoration: none; margin: 0 10px;\">Mi Cuenta</a>\n              </p>\n              ` : ''}\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0;\">\n                &copy; ${new Date().getFullYear()} ${BRAND_NAME}. Todos los derechos reservados.\n              </p>\n              <p style=\"color: #4b5563; font-size: 11px; margin: 10px 0 0 0;\">\n                Este es un correo automÃ¡tico, por favor no respondas directamente.\n              </p>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>\n  `;\n}\n\nfunction getButton(text: string, url: string): string {\n  return `\n    <a href=\"${url}\" style=\"display: inline-block; background: linear-gradient(135deg, ${BRAND_COLOR} 0%, #5B21B6 100%); color: white; padding: 14px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 14px rgba(124, 58, 237, 0.4); transition: all 0.3s ease;\">\n      ${text}\n    </a>\n  `;\n}\n\nfunction getSecondaryButton(text: string, url: string): string {\n  return `\n    <a href=\"${url}\" style=\"display: inline-block; background: transparent; color: ${BRAND_COLOR_LIGHT}; padding: 12px 28px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; border: 2px solid ${BRAND_COLOR};\">\n      ${text}\n    </a>\n  `;\n}\n\nfunction getInfoBox(content: string): string {\n  return `\n    <div style=\"background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(91, 33, 182, 0.1) 100%); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 12px; padding: 24px; margin: 24px 0;\">\n      ${content}\n    </div>\n  `;\n}\n\nfunction getGoldAccentBox(content: string): string {\n  return `\n    <div style=\"background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(202, 138, 4, 0.1) 100%); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 24px; margin: 24px 0; border-left: 4px solid ${BRAND_GOLD};\">\n      ${content}\n    </div>\n  `;\n}\n\nexport interface TemplatePreview {\n  id: string;\n  name: string;\n  description: string;\n  html: string;\n}\n\nexport function getTemplatePreview(templateId: string, logoBase64?: string): TemplatePreview | null {\n  const templates: Record<string, () => TemplatePreview> = {\n    welcome: () => ({\n      id: \"welcome\",\n      name: \"Bienvenida\",\n      description: \"Email enviado cuando un nuevo usuario se registra\",\n      html: getEmailTemplate(`\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n          Â¡Hola, <span style=\"color: ${BRAND_GOLD};\">Usuario Ejemplo</span>!\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Bienvenido a <strong style=\"color: ${BRAND_COLOR_LIGHT};\">${BRAND_NAME}</strong>, tu nueva plataforma de audiolibros premium. \n          Estamos encantados de tenerte con nosotros.\n        </p>\n        \n        ${getInfoBox(`\n          <h3 style=\"color: white; margin: 0 0 15px 0; font-size: 18px;\">Ahora puedes:</h3>\n          <ul style=\"margin: 0; padding-left: 20px; color: #d1d5db;\">\n            <li style=\"margin-bottom: 10px;\">Explorar nuestra colecciÃ³n exclusiva de audiolibros</li>\n            <li style=\"margin-bottom: 10px;\">Crear tu biblioteca personal de favoritos</li>\n            <li style=\"margin-bottom: 10px;\">Escuchar en cualquier momento y lugar</li>\n            <li style=\"margin-bottom: 0;\">Sincronizar tu progreso entre todos tus dispositivos</li>\n          </ul>\n        `)}\n        \n        <p style=\"text-align: center; margin: 32px 0;\">\n          ${getButton(\"Explorar Audiolibros\", \"/explore\")}\n        </p>\n        \n        <p style=\"font-size: 14px; color: #9ca3af; text-align: center;\">\n          Â¿Tienes alguna pregunta? Estamos aquÃ­ para ayudarte.\n        </p>\n      `, true, logoBase64),\n    }),\n\n    passwordReset: () => ({\n      id: \"passwordReset\",\n      name: \"Recuperar ContraseÃ±a\",\n      description: \"Email enviado para restablecer la contraseÃ±a\",\n      html: getEmailTemplate(`\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n          RecuperaciÃ³n de contraseÃ±a\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Hola <strong style=\"color: ${BRAND_GOLD};\">Usuario Ejemplo</strong>,\n        </p>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Recibimos una solicitud para restablecer la contraseÃ±a de tu cuenta en ${BRAND_NAME}.\n        </p>\n        \n        <p style=\"text-align: center; margin: 32px 0;\">\n          ${getButton(\"Restablecer ContraseÃ±a\", \"#\")}\n        </p>\n        \n        ${getInfoBox(`\n          <p style=\"margin: 0; color: #d1d5db; font-size: 14px;\">\n            <strong style=\"color: ${BRAND_GOLD};\">Importante:</strong> Este enlace expirarÃ¡ en <strong>1 hora</strong>.\n          </p>\n        `)}\n        \n        <p style=\"font-size: 14px; color: #9ca3af;\">\n          Si no solicitaste este cambio, puedes ignorar este correo de forma segura. \n          Tu contraseÃ±a actual seguirÃ¡ siendo vÃ¡lida.\n        </p>\n      `, false, logoBase64),\n    }),\n\n    emailVerification: () => ({\n      id: \"emailVerification\",\n      name: \"Verificar Email\",\n      description: \"Email enviado para verificar la direcciÃ³n de correo\",\n      html: getEmailTemplate(`\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n          Verifica tu email\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Hola <strong style=\"color: ${BRAND_GOLD};\">Usuario Ejemplo</strong>,\n        </p>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Gracias por registrarte en <strong style=\"color: ${BRAND_COLOR_LIGHT};\">${BRAND_NAME}</strong>. \n          Para completar tu registro y acceder a todos los beneficios, necesitamos verificar tu direcciÃ³n de email.\n        </p>\n        \n        <p style=\"text-align: center; margin: 32px 0;\">\n          ${getButton(\"Verificar mi Email\", \"#\")}\n        </p>\n        \n        ${getInfoBox(`\n          <p style=\"margin: 0; color: #d1d5db; font-size: 14px;\">\n            Este enlace expirarÃ¡ en <strong style=\"color: ${BRAND_GOLD};\">24 horas</strong>.\n          </p>\n        `)}\n        \n        <p style=\"font-size: 14px; color: #9ca3af;\">\n          Si no creaste esta cuenta, puedes ignorar este correo.\n        </p>\n      `, false, logoBase64),\n    }),\n\n    purchaseConfirmation: () => ({\n      id: \"purchaseConfirmation\",\n      name: \"ConfirmaciÃ³n de Compra\",\n      description: \"Email enviado cuando se completa una compra\",\n      html: getEmailTemplate(`\n        <div style=\"text-align: center; margin-bottom: 24px;\">\n          <span style=\"font-size: 48px;\">&#128214;</span>\n        </div>\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n          Â¡Compra Confirmada!\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Hola <strong style=\"color: ${BRAND_GOLD};\">Usuario Ejemplo</strong>,\n        </p>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Tu compra se ha realizado con Ã©xito. Ya puedes disfrutar de tu nuevo audiolibro.\n        </p>\n        \n        ${getGoldAccentBox(`\n          <h3 style=\"color: white; margin: 0 0 8px 0; font-size: 20px;\">El Arte de la Guerra</h3>\n          <p style=\"color: #9ca3af; margin: 0; font-size: 14px;\">Referencia: AUD-2024-0001</p>\n        `)}\n        \n        <p style=\"text-align: center; margin: 32px 0;\">\n          ${getButton(\"Ir a Mi Biblioteca\", \"/library\")}\n        </p>\n        \n        <p style=\"font-size: 14px; color: #9ca3af; text-align: center;\">\n          RecibirÃ¡s la factura en un correo separado.\n        </p>\n      `, true, logoBase64),\n    }),\n\n    invoice: () => ({\n      id: \"invoice\",\n      name: \"Factura\",\n      description: \"Email con la factura adjunta\",\n      html: getEmailTemplate(`\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600;\">\n          Factura AUD-2024-0001\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Hola <strong style=\"color: ${BRAND_GOLD};\">Usuario Ejemplo</strong>,\n        </p>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Adjuntamos la factura correspondiente a tu compra.\n        </p>\n        \n        ${getInfoBox(`\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr>\n              <td style=\"padding: 12px 0; color: #9ca3af; font-size: 14px;\">NÃºmero de factura:</td>\n              <td style=\"padding: 12px 0; text-align: right; color: white; font-weight: 600;\">AUD-2024-0001</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 12px 0; color: #9ca3af; font-size: 14px; border-top: 1px solid rgba(124, 58, 237, 0.2);\">Fecha de emisiÃ³n:</td>\n              <td style=\"padding: 12px 0; text-align: right; color: #d1d5db; border-top: 1px solid rgba(124, 58, 237, 0.2);\">21 de diciembre de 2024</td>\n            </tr>\n            <tr>\n              <td style=\"padding: 12px 0; color: #9ca3af; font-size: 14px; border-top: 1px solid rgba(124, 58, 237, 0.2);\">Total:</td>\n              <td style=\"padding: 12px 0; text-align: right; color: ${BRAND_GOLD}; font-weight: 700; font-size: 24px; border-top: 1px solid rgba(124, 58, 237, 0.2);\">9,99 â‚¬</td>\n            </tr>\n          </table>\n        `)}\n\n        <p style=\"font-size: 16px; line-height: 1.6; text-align: center; color: #d1d5db;\">\n          EncontrarÃ¡s el PDF de la factura adjunto a este correo.\n        </p>\n        \n        <p style=\"font-size: 14px; color: #9ca3af; margin-top: 32px;\">\n          Gracias por tu confianza en <strong style=\"color: ${BRAND_COLOR_LIGHT};\">${BRAND_NAME}</strong>.\n        </p>\n      `, true, logoBase64),\n    }),\n\n    newChapter: () => ({\n      id: \"newChapter\",\n      name: \"Nuevo CapÃ­tulo\",\n      description: \"Email enviado cuando hay un nuevo capÃ­tulo disponible\",\n      html: getEmailTemplate(`\n        <div style=\"text-align: center; margin-bottom: 24px;\">\n          <span style=\"font-size: 48px;\">&#127926;</span>\n        </div>\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n          Â¡Nuevo CapÃ­tulo Disponible!\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Hola <strong style=\"color: ${BRAND_GOLD};\">Usuario Ejemplo</strong>,\n        </p>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Hay un nuevo capÃ­tulo disponible en uno de tus audiolibros:\n        </p>\n        \n        ${getGoldAccentBox(`\n          <h3 style=\"color: white; margin: 0 0 8px 0; font-size: 18px;\">El Arte de la Guerra</h3>\n          <p style=\"color: ${BRAND_COLOR_LIGHT}; margin: 0; font-size: 16px; font-weight: 600;\">CapÃ­tulo 5: El EngaÃ±o EstratÃ©gico</p>\n        `)}\n        \n        <p style=\"text-align: center; margin: 32px 0;\">\n          ${getButton(\"Escuchar Ahora\", \"#\")}\n        </p>\n        \n        <p style=\"font-size: 14px; color: #9ca3af; text-align: center;\">\n          Â¡Disfruta del nuevo contenido!\n        </p>\n      `, true, logoBase64),\n    }),\n\n    contentApproved: () => ({\n      id: \"contentApproved\",\n      name: \"Contenido Aprobado\",\n      description: \"Email enviado cuando se aprueba contenido de un creador\",\n      html: getEmailTemplate(`\n        <div style=\"text-align: center; margin-bottom: 24px;\">\n          <span style=\"font-size: 48px;\">&#127881;</span>\n        </div>\n        <h1 style=\"color: white; font-size: 28px; margin: 0 0 20px 0; font-weight: 600; text-align: center;\">\n          Â¡Contenido Aprobado!\n        </h1>\n        <p style=\"font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\n          Hola <strong style=\"color: ${BRAND_GOLD};\">Creador Ejemplo</strong>,\n        </p>\n        \n        ${getGoldAccentBox(`\n          <p style=\"margin: 0; color: #d1d5db;\">\n            Tu audiolibro <strong style=\"color: white;\">\"El Arte de la Guerra\"</strong> ha sido aprobado \n            y ahora estÃ¡ disponible para todos los usuarios de ${BRAND_NAME}.\n          </p>\n        `)}\n        \n        <p style=\"font-size: 16px; line-height: 1.6;\">\n          Â¡Felicitaciones por tu excelente trabajo!\n        </p>\n      `, true, logoBase64),\n    }),\n  };\n\n  const templateFn = templates[templateId];\n  return templateFn ? templateFn() : null;\n}\n\nexport function getAllTemplates(logoBase64?: string): TemplatePreview[] {\n  const templateIds = [\"welcome\", \"emailVerification\", \"passwordReset\", \"purchaseConfirmation\", \"invoice\", \"newChapter\", \"contentApproved\"];\n  return templateIds.map(id => getTemplatePreview(id, logoBase64)).filter((t): t is TemplatePreview => t !== null);\n}\n","path":null,"size_bytes":15050,"size_tokens":null},"client/src/pages/admin-external-services.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { ExternalLink, Plus, Trash2, Edit, Server, Globe } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { ExternalService } from \"@shared/schema\";\n\nconst serviceSchema = z.object({\n  name: z.string().min(1, \"Nombre es requerido\"),\n  description: z.string().optional(),\n  url: z.string().url(\"URL invÃ¡lida\"),\n  iconName: z.string().optional(),\n  sortOrder: z.number().int().min(0).default(0),\n  isActive: z.boolean().default(true),\n});\n\ntype ServiceFormData = z.infer<typeof serviceSchema>;\n\nexport default function AdminExternalServices() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingService, setEditingService] = useState<ExternalService | null>(null);\n  const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null);\n\n  const { data: services, isLoading } = useQuery<ExternalService[]>({\n    queryKey: [\"/api/admin/external-services\"],\n  });\n\n  const form = useForm<ServiceFormData>({\n    resolver: zodResolver(serviceSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      url: \"\",\n      iconName: \"ExternalLink\",\n      sortOrder: 0,\n      isActive: true,\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: ServiceFormData) => {\n      return await apiRequest(\"POST\", \"/api/admin/external-services\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/external-services\"] });\n      toast({ title: \"Servicio creado\", description: \"El servicio externo ha sido agregado.\" });\n      setIsDialogOpen(false);\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({ variant: \"destructive\", title: \"Error\", description: error.message });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: ServiceFormData }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/external-services/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/external-services\"] });\n      toast({ title: \"Servicio actualizado\", description: \"Los cambios han sido guardados.\" });\n      setIsDialogOpen(false);\n      setEditingService(null);\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({ variant: \"destructive\", title: \"Error\", description: error.message });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(\"DELETE\", `/api/admin/external-services/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/external-services\"] });\n      toast({ title: \"Servicio eliminado\" });\n      setDeleteConfirmId(null);\n    },\n    onError: (error: any) => {\n      toast({ variant: \"destructive\", title: \"Error\", description: error.message });\n    },\n  });\n\n  const openAddDialog = () => {\n    setEditingService(null);\n    form.reset({\n      name: \"\",\n      description: \"\",\n      url: \"\",\n      iconName: \"ExternalLink\",\n      sortOrder: services?.length || 0,\n      isActive: true,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const openEditDialog = (service: ExternalService) => {\n    setEditingService(service);\n    form.reset({\n      name: service.name,\n      description: service.description || \"\",\n      url: service.url,\n      iconName: service.iconName || \"ExternalLink\",\n      sortOrder: service.sortOrder,\n      isActive: service.isActive,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const onSubmit = (data: ServiceFormData) => {\n    if (editingService) {\n      updateMutation.mutate({ id: editingService.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const openInNewWindow = (url: string) => {\n    window.open(url, \"_blank\", \"noopener,noreferrer\");\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container max-w-5xl mx-auto px-4 md:px-6 py-8\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 w-64 bg-muted rounded\"></div>\n          <div className=\"h-96 bg-muted rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container max-w-5xl mx-auto px-4 md:px-6 py-8\">\n      <div className=\"mb-8 flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n            <Server className=\"h-8 w-8\" />\n            Servicios Externos\n          </h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Gestiona enlaces rÃ¡pidos a tus servicios externos\n          </p>\n        </div>\n        <Button onClick={openAddDialog} data-testid=\"button-add-service\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Agregar Servicio\n        </Button>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Mis Servicios</CardTitle>\n          <CardDescription>\n            Haz clic en un servicio para abrirlo en una nueva ventana\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {services && services.length > 0 ? (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Nombre</TableHead>\n                  <TableHead>DescripciÃ³n</TableHead>\n                  <TableHead>URL</TableHead>\n                  <TableHead>Estado</TableHead>\n                  <TableHead className=\"text-right\">Acciones</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {services.map((service) => (\n                  <TableRow key={service.id} data-testid={`row-service-${service.id}`}>\n                    <TableCell className=\"font-medium\">\n                      <button\n                        onClick={() => openInNewWindow(service.url)}\n                        className=\"flex items-center gap-2 text-left hover:text-primary transition-colors\"\n                        data-testid={`button-open-service-${service.id}`}\n                      >\n                        <Globe className=\"h-4 w-4\" />\n                        {service.name}\n                        <ExternalLink className=\"h-3 w-3 text-muted-foreground\" />\n                      </button>\n                    </TableCell>\n                    <TableCell className=\"text-muted-foreground max-w-xs truncate\">\n                      {service.description || \"-\"}\n                    </TableCell>\n                    <TableCell className=\"max-w-xs truncate text-xs text-muted-foreground\">\n                      {service.url}\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={service.isActive ? \"default\" : \"secondary\"}>\n                        {service.isActive ? \"Activo\" : \"Inactivo\"}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => openEditDialog(service)}\n                          data-testid={`button-edit-service-${service.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => setDeleteConfirmId(service.id)}\n                          data-testid={`button-delete-service-${service.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          ) : (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Server className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p>No hay servicios externos configurados</p>\n              <p className=\"text-sm mt-1\">Agrega tus servicios para acceder rÃ¡pidamente desde aquÃ­</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>\n              {editingService ? \"Editar Servicio\" : \"Agregar Servicio\"}\n            </DialogTitle>\n            <DialogDescription>\n              {editingService \n                ? \"Modifica los datos del servicio externo\" \n                : \"Agrega un nuevo enlace a un servicio externo\"}\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nombre</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"Mi Servidor\" data-testid=\"input-service-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"url\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>URL</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"https://mi-servicio.com\" data-testid=\"input-service-url\" />\n                    </FormControl>\n                    <FormDescription>\n                      Incluye https:// o http://\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>DescripciÃ³n (opcional)</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"Panel de administraciÃ³n del servidor\" data-testid=\"input-service-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"sortOrder\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Orden</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        value={field.value}\n                        onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}\n                        data-testid=\"input-service-order\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      Los servicios se ordenan de menor a mayor\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex items-center justify-between rounded-lg border p-3\">\n                    <div>\n                      <FormLabel>Activo</FormLabel>\n                      <FormDescription>\n                        Solo los servicios activos se muestran en la lista\n                      </FormDescription>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-service-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsDialogOpen(false)}\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createMutation.isPending || updateMutation.isPending}\n                  data-testid=\"button-save-service\"\n                >\n                  {createMutation.isPending || updateMutation.isPending ? \"Guardando...\" : \"Guardar\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!deleteConfirmId} onOpenChange={() => setDeleteConfirmId(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Confirmar eliminaciÃ³n</DialogTitle>\n            <DialogDescription>\n              Â¿EstÃ¡s seguro de que deseas eliminar este servicio? Esta acciÃ³n no se puede deshacer.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteConfirmId(null)}>\n              Cancelar\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deleteConfirmId && deleteMutation.mutate(deleteConfirmId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Eliminando...\" : \"Eliminar\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":14794,"size_tokens":null}},"version":2}